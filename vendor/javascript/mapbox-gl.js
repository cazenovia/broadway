// mapbox-gl@3.18.1 downloaded from https://ga.jspm.io/npm:mapbox-gl@3.18.1/dist/mapbox-gl.js

var e=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var t={};(function(e,r){t=r()})(0,(function(){var t,r,o;function s(e,s){if(t)if(r){var l="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+t+")(sharedChunk); ("+r+")(sharedChunk); self.onerror = null;";var c={};t(c);o=s(c);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(o.workerUrl=window.URL.createObjectURL(new Blob([l],{type:"text/javascript"})))}else r=s;else t=s}s(["exports"],(function(t){var r=1e-6,o="undefined"!=typeof Float32Array?Float32Array:Array;function s(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=r*l-s*o;return c?(e[0]=l*(c=1/c),e[1]=-o*c,e[2]=-s*c,e[3]=r*c,e):null}function l(){var e=new o(9);return o!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function c(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=t[4],h=t[5],u=t[6],d=t[7],p=t[8];return e[0]=c*p-h*d,e[1]=s*d-o*p,e[2]=o*h-s*c,e[3]=h*u-l*p,e[4]=r*p-s*u,e[5]=s*l-r*h,e[6]=l*d-c*u,e[7]=o*u-r*d,e[8]=r*c-o*l,e}function h(e,t,r){var o=t[0],s=t[1],l=t[2],c=t[3],h=t[4],u=t[5],d=t[6],p=t[7],f=t[8],m=r[0],_=r[1],v=r[2],E=r[3],P=r[4],C=r[5],R=r[6],z=r[7],D=r[8];return e[0]=m*o+_*c+v*d,e[1]=m*s+_*h+v*p,e[2]=m*l+_*u+v*f,e[3]=E*o+P*c+C*d,e[4]=E*s+P*h+C*p,e[5]=E*l+P*u+C*f,e[6]=R*o+z*c+D*d,e[7]=R*s+z*h+D*p,e[8]=R*l+z*u+D*f,e}function u(){var e=new o(16);return o!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function d(e){var t=new o(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function p(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function f(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=t[4],h=t[5],u=t[6],d=t[7],p=t[8],f=t[9],m=t[10],_=t[11],v=t[12],E=t[13],P=t[14],C=t[15],R=r*h-o*c,z=r*u-s*c,D=r*d-l*c,O=o*u-s*h,F=o*d-l*h,B=s*d-l*u,k=p*E-f*v,V=p*P-m*v,N=p*C-_*v,U=f*P-m*E,j=f*C-_*E,$=m*C-_*P,q=R*$-z*j+D*U+O*N-F*V+B*k;return q?(e[0]=(h*$-u*j+d*U)*(q=1/q),e[1]=(s*j-o*$-l*U)*q,e[2]=(E*B-P*F+C*O)*q,e[3]=(m*F-f*B-_*O)*q,e[4]=(u*N-c*$-d*V)*q,e[5]=(r*$-s*N+l*V)*q,e[6]=(P*D-v*B-C*z)*q,e[7]=(p*B-m*D+_*z)*q,e[8]=(c*j-h*N+d*k)*q,e[9]=(o*N-r*j-l*k)*q,e[10]=(v*F-E*D+C*R)*q,e[11]=(f*D-p*F-_*R)*q,e[12]=(h*V-c*U-u*k)*q,e[13]=(r*U-o*V+s*k)*q,e[14]=(E*z-v*O-P*R)*q,e[15]=(p*O-f*z+m*R)*q,e):null}function m(e,t,r){var o=t[0],s=t[1],l=t[2],c=t[3],h=t[4],u=t[5],d=t[6],p=t[7],f=t[8],m=t[9],_=t[10],v=t[11],E=t[12],P=t[13],C=t[14],R=t[15],z=r[0],D=r[1],O=r[2],F=r[3];return e[0]=z*o+D*h+O*f+F*E,e[1]=z*s+D*u+O*m+F*P,e[2]=z*l+D*d+O*_+F*C,e[3]=z*c+D*p+O*v+F*R,e[4]=(z=r[4])*o+(D=r[5])*h+(O=r[6])*f+(F=r[7])*E,e[5]=z*s+D*u+O*m+F*P,e[6]=z*l+D*d+O*_+F*C,e[7]=z*c+D*p+O*v+F*R,e[8]=(z=r[8])*o+(D=r[9])*h+(O=r[10])*f+(F=r[11])*E,e[9]=z*s+D*u+O*m+F*P,e[10]=z*l+D*d+O*_+F*C,e[11]=z*c+D*p+O*v+F*R,e[12]=(z=r[12])*o+(D=r[13])*h+(O=r[14])*f+(F=r[15])*E,e[13]=z*s+D*u+O*m+F*P,e[14]=z*l+D*d+O*_+F*C,e[15]=z*c+D*p+O*v+F*R,e}function _(e,t,r){var o,s,l,c,h,u,d,p,f,m,_,v,E=r[0],P=r[1],C=r[2];return t===e?(e[12]=t[0]*E+t[4]*P+t[8]*C+t[12],e[13]=t[1]*E+t[5]*P+t[9]*C+t[13],e[14]=t[2]*E+t[6]*P+t[10]*C+t[14],e[15]=t[3]*E+t[7]*P+t[11]*C+t[15]):(s=t[1],l=t[2],c=t[3],h=t[4],u=t[5],d=t[6],p=t[7],f=t[8],m=t[9],_=t[10],v=t[11],e[0]=o=t[0],e[1]=s,e[2]=l,e[3]=c,e[4]=h,e[5]=u,e[6]=d,e[7]=p,e[8]=f,e[9]=m,e[10]=_,e[11]=v,e[12]=o*E+h*P+f*C+t[12],e[13]=s*E+u*P+m*C+t[13],e[14]=l*E+d*P+_*C+t[14],e[15]=c*E+p*P+v*C+t[15]),e}function v(e,t,r){var o=r[0],s=r[1],l=r[2];return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*l,e[9]=t[9]*l,e[10]=t[10]*l,e[11]=t[11]*l,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function E(e,t,r){var o=Math.sin(r),s=Math.cos(r),l=t[4],c=t[5],h=t[6],u=t[7],d=t[8],p=t[9],f=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=l*s+d*o,e[5]=c*s+p*o,e[6]=h*s+f*o,e[7]=u*s+m*o,e[8]=d*s-l*o,e[9]=p*s-c*o,e[10]=f*s-h*o,e[11]=m*s-u*o,e}function P(e,t,r){var o=Math.sin(r),s=Math.cos(r),l=t[0],c=t[1],h=t[2],u=t[3],d=t[8],p=t[9],f=t[10],m=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=l*s-d*o,e[1]=c*s-p*o,e[2]=h*s-f*o,e[3]=u*s-m*o,e[8]=l*o+d*s,e[9]=c*o+p*s,e[10]=h*o+f*s,e[11]=u*o+m*s,e}function C(e,t,r){var o=Math.sin(r),s=Math.cos(r),l=t[0],c=t[1],h=t[2],u=t[3],d=t[4],p=t[5],f=t[6],m=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=l*s+d*o,e[1]=c*s+p*o,e[2]=h*s+f*o,e[3]=u*s+m*o,e[4]=d*s-l*o,e[5]=p*s-c*o,e[6]=f*s-h*o,e[7]=m*s-u*o,e}function R(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function z(e,t,o){var s,l,c,h=o[0],u=o[1],d=o[2],p=Math.sqrt(h*h+u*u+d*d);return p<r?null:(h*=p=1/p,u*=p,d*=p,s=Math.sin(t),l=Math.cos(t),e[0]=h*h*(c=1-l)+l,e[1]=u*h*c+d*s,e[2]=d*h*c-u*s,e[3]=0,e[4]=h*u*c-d*s,e[5]=u*u*c+l,e[6]=d*u*c+h*s,e[7]=0,e[8]=h*d*c+u*s,e[9]=u*d*c-h*s,e[10]=d*d*c+l,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function D(e,t){var r=t[0],o=t[1],s=t[2],l=t[4],c=t[5],h=t[6],u=t[8],d=t[9],p=t[10];return e[0]=Math.sqrt(r*r+o*o+s*s),e[1]=Math.sqrt(l*l+c*c+h*h),e[2]=Math.sqrt(u*u+d*d+p*p),e}function O(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=r+r,h=o+o,u=s+s,d=r*c,p=o*c,f=o*h,m=s*c,_=s*h,v=s*u,E=l*c,P=l*h,C=l*u;return e[0]=1-f-v,e[1]=p+C,e[2]=m-P,e[3]=0,e[4]=p-C,e[5]=1-d-v,e[6]=_+E,e[7]=0,e[8]=m+P,e[9]=_-E,e[10]=1-d-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var F=m;function B(){var e=new o(3);return o!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function k(e){var t=new o(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function V(e){var t=e[0],r=e[1],o=e[2];return Math.sqrt(t*t+r*r+o*o)}function N(e,t,r){var s=new o(3);return s[0]=e,s[1]=t,s[2]=r,s}function U(e,t,r,o){return e[0]=t,e[1]=r,e[2]=o,e}function j(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function $(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function q(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function H(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}function Z(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}function Y(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function J(e,t,r,o){return e[0]=t[0]+r[0]*o,e[1]=t[1]+r[1]*o,e[2]=t[2]+r[2]*o,e}function Q(e,t){var r=t[0]-e[0],o=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(r*r+o*o+s*s)}function K(e,t){var r=t[0]-e[0],o=t[1]-e[1],s=t[2]-e[2];return r*r+o*o+s*s}function ee(e){var t=e[0],r=e[1],o=e[2];return t*t+r*r+o*o}function te(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function ie(e,t){var r=t[0],o=t[1],s=t[2],l=r*r+o*o+s*s;return l>0&&(l=1/Math.sqrt(l)),e[0]=t[0]*l,e[1]=t[1]*l,e[2]=t[2]*l,e}function re(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function ne(e,t,r){var o=t[0],s=t[1],l=t[2],c=r[0],h=r[1],u=r[2];return e[0]=s*u-l*h,e[1]=l*c-o*u,e[2]=o*h-s*c,e}function oe(e,t,r,o){var s=t[0],l=t[1],c=t[2];return e[0]=s+o*(r[0]-s),e[1]=l+o*(r[1]-l),e[2]=c+o*(r[2]-c),e}function se(e,t,r){var o=t[0],s=t[1],l=t[2],c=r[3]*o+r[7]*s+r[11]*l+r[15];return e[0]=(r[0]*o+r[4]*s+r[8]*l+r[12])/(c=c||1),e[1]=(r[1]*o+r[5]*s+r[9]*l+r[13])/c,e[2]=(r[2]*o+r[6]*s+r[10]*l+r[14])/c,e}function ae(e,t,r){var o=t[0],s=t[1],l=t[2];return e[0]=o*r[0]+s*r[3]+l*r[6],e[1]=o*r[1]+s*r[4]+l*r[7],e[2]=o*r[2]+s*r[5]+l*r[8],e}function le(e,t,r){var o=r[0],s=r[1],l=r[2],c=r[3],h=t[0],u=t[1],d=t[2],p=s*d-l*u,f=l*h-o*d,m=o*u-s*h;return e[0]=h+c*(p+=p)+s*(m+=m)-l*(f+=f),e[1]=u+c*f+l*p-o*m,e[2]=d+c*m+o*f-s*p,e}function ce(e){return e[0]=0,e[1]=0,e[2]=0,e}function he(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var ue=$,de=q,pe=V;function fe(){var e=new o(4);return o!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function me(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function ge(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=r*r+o*o+s*s+l*l;return c>0&&(c=1/Math.sqrt(c)),e[0]=r*c,e[1]=o*c,e[2]=s*c,e[3]=l*c,e}function ye(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function xe(e,t,r){var o=t[0],s=t[1],l=t[2],c=t[3];return e[0]=r[0]*o+r[4]*s+r[8]*l+r[12]*c,e[1]=r[1]*o+r[5]*s+r[9]*l+r[13]*c,e[2]=r[2]*o+r[6]*s+r[10]*l+r[14]*c,e[3]=r[3]*o+r[7]*s+r[11]*l+r[15]*c,e}function ve(){var e=new o(4);return o!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function be(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function we(e,t,r){r*=.5;var o=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(r),u=Math.cos(r);return e[0]=o*u+c*h,e[1]=s*u+l*h,e[2]=l*u-s*h,e[3]=c*u-o*h,e}function Ie(e,t,r){r*=.5;var o=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(r),u=Math.cos(r);return e[0]=o*u-l*h,e[1]=s*u+c*h,e[2]=l*u+o*h,e[3]=c*u-s*h,e}B(),fe();var Ee,Ae,Me,Pe=ge,Ce=(Ee=B(),Ae=N(1,0,0),Me=N(0,1,0),function(e,t,r){var o=re(t,r);return o<-.999999?(ne(Ee,Ae,t),pe(Ee)<1e-6&&ne(Ee,Me,t),ie(Ee,Ee),function(e,t,r){r*=.5;var o=Math.sin(r);e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=Math.cos(r)}(e,Ee,Math.PI),e):o>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(ne(Ee,t,r),e[0]=Ee[0],e[1]=Ee[1],e[2]=Ee[2],e[3]=1+o,Pe(e,e))});function ze(){var e=new o(2);return o!=Float32Array&&(e[0]=0,e[1]=0),e}function De(e,t){var r=new o(2);return r[0]=e,r[1]=t,r}function Oe(e,t,r){return e[0]=t,e[1]=r,e}function Fe(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e}function Be(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function Ve(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e}function Ue(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)}function je(e,t){var r=t[0],o=t[1],s=r*r+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e}function Ge(e,t){return e[0]*t[0]+e[1]*t[1]}ve(),ve(),l();var qe,He,We=Be;function Ze(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}ze();var Xe=function(){if(He)return qe;function t(t,r,o,s){(this||e).cx=3*t,(this||e).bx=3*(o-t)-(this||e).cx,(this||e).ax=1-(this||e).cx-(this||e).bx,(this||e).cy=3*r,(this||e).by=3*(s-r)-(this||e).cy,(this||e).ay=1-(this||e).cy-(this||e).by,(this||e).p1x=t,(this||e).p1y=r,(this||e).p2x=o,(this||e).p2y=s}return He=1,qe=t,t.prototype={sampleCurveX:function(t){return(((this||e).ax*t+(this||e).bx)*t+(this||e).cx)*t},sampleCurveY:function(t){return(((this||e).ay*t+(this||e).by)*t+(this||e).cy)*t},sampleCurveDerivativeX:function(t){return(3*(this||e).ax*t+2*(this||e).bx)*t+(this||e).cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var r=e,o=0;o<8;o++){var s=this.sampleCurveX(r)-e;if(Math.abs(s)<t)return r;var l=this.sampleCurveDerivativeX(r);if(Math.abs(l)<1e-6)break;r-=s/l}var c=0,h=1;for(r=e,o=0;o<20&&(s=this.sampleCurveX(r),!(Math.abs(s-e)<t));o++)e>s?c=r:h=r,r=.5*(h-c)+c;return r},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}},qe}(),Ye=Ze(Xe);function Je(t,r){(this||e).x=t,(this||e).y=r}function Qe(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!Qe(e[r],t[r]))return!1;return!0}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(!Qe(e[r],t[r]))return!1;return!0}return e===t}Je.prototype={clone(){return new Je((this||e).x,(this||e).y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt((this||e).x*(this||e).x+(this||e).y*(this||e).y)},equals(t){return(this||e).x===t.x&&(this||e).y===t.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(t){const r=t.x-(this||e).x,o=t.y-(this||e).y;return r*r+o*o},angle(){return Math.atan2((this||e).y,(this||e).x)},angleTo(t){return Math.atan2((this||e).y-t.y,(this||e).x-t.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(t,r){return Math.atan2((this||e).x*r-(this||e).y*t,(this||e).x*t+(this||e).y*r)},_matMult(t){const r=t[2]*(this||e).x+t[3]*(this||e).y;return(this||e).x=t[0]*(this||e).x+t[1]*(this||e).y,(this||e).y=r,this||e},_add(t){return(this||e).x+=t.x,(this||e).y+=t.y,this||e},_sub(t){return(this||e).x-=t.x,(this||e).y-=t.y,this||e},_mult(t){return(this||e).x*=t,(this||e).y*=t,this||e},_div(t){return(this||e).x/=t,(this||e).y/=t,this||e},_multByPoint(t){return(this||e).x*=t.x,(this||e).y*=t.y,this||e},_divByPoint(t){return(this||e).x/=t.x,(this||e).y/=t.y,this||e},_unit(){return this._div(this.mag()),this||e},_perp(){const t=(this||e).y;return(this||e).y=(this||e).x,(this||e).x=-t,this||e},_rotate(t){const r=Math.cos(t),o=Math.sin(t),s=o*(this||e).x+r*(this||e).y;return(this||e).x=r*(this||e).x-o*(this||e).y,(this||e).y=s,this||e},_rotateAround(t,r){const o=Math.cos(t),s=Math.sin(t),l=r.y+s*((this||e).x-r.x)+o*((this||e).y-r.y);return(this||e).x=r.x+o*((this||e).x-r.x)-s*((this||e).y-r.y),(this||e).y=l,this||e},_round(){return(this||e).x=Math.round((this||e).x),(this||e).y=Math.round((this||e).y),this||e},constructor:Je},Je.convert=function(e){if(e instanceof Je)return e;if(Array.isArray(e))return new Je(+e[0],+e[1]);if(void 0!==e.x&&void 0!==e.y)return new Je(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};const Ke=Math.PI/180,tt=180/Math.PI;function it(e){return e*Ke}function rt(e){return e*tt}const nt=[[0,0],[1,0],[1,1],[0,1]];function ot(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,r=t*e;return 4*(e<.5?r:3*(e-t)+r-.75)}function at(e,t,r,o){const s=new Ye(e,t,r,o);return function(e){return s.solve(e)}}const lt=at(.25,.1,.25,1);function ct(e,t,r){return Math.min(r,Math.max(t,e))}function ft(e,t,r){return(r=ct((r-e)/(t-e),0,1))*r*(3-2*r)}function mt(e,t,r){const o=r-t,s=((e-t)%o+o)%o+t;return s===t?r:s}function _t(e,t,r){if(!e.length)return r(null,[]);let o=e.length;const s=new Array(e.length);let l=null;e.forEach(((e,c)=>{t(e,((e,t)=>{e&&(l=e),s[c]=t,0===--o&&r(l,s)}))}))}let gt=1;function yt(){return gt++}function xt(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log2(e)))}function vt(e,t){e.forEach((e=>{t[e]&&(t[e]=t[e].bind(t))}))}function bt(t,r,o){const s={};for(const o in t)s[o]=r.call(this||e,t[o],o,t);return s}function wt(t,r,o){const s={};for(const o in t)r.call(this||e,t[o],o,t)&&(s[o]=t[o]);return s}function Tt(e){return Array.isArray(e)?e.map(Tt):"object"==typeof e&&e?bt(e,Tt):e}function St(e,t){for(let r=0;r<e.length;r++)if(t.indexOf(e[r])>=0)return!0;return!1}const It={};function Et(e){It[e]||("undefined"!=typeof console&&console.warn(e),It[e]=!0)}function At(e,t,r){return(r.y-e.y)*(t.x-e.x)>(t.y-e.y)*(r.x-e.x)}function Ct(e){let t=0;for(let r,o,s=0,l=e.length,c=l-1;s<l;c=s++)r=e[s],o=e[c],t+=(o.x-r.x)*(r.y+o.y);return t}function Rt([e,t,r]){const o=it(t+90),s=it(r);return{x:e*Math.cos(o)*Math.sin(s),y:e*Math.sin(o)*Math.sin(s),z:e*Math.cos(s),azimuthal:t,polar:r}}function Dt(e){return("undefined"!=typeof self||void 0!==e)&&"undefined"!=typeof WorkerGlobalScope&&(void 0!==e?e:self)instanceof WorkerGlobalScope}function Lt(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((e,r,o,s)=>{const l=o||s;return t[r]=!l||l.toLowerCase(),""})),t["max-age"]){const e=parseInt(t["max-age"],10);isNaN(e)?delete t["max-age"]:t["max-age"]=e}return t}let Bt=null;function kt(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function Vt(e,t,r,o){for(;t<r;){const s=t+r>>1;e[s]<o?t=s+1:r=s}return t}function Nt(e,t,r,o){for(;t<r;){const s=t+r>>1;e[s]<=o?t=s+1:r=s}return t}function jt(e){return e>0?1/(1.001-e):1+e}function Gt(e){return e>0?1-1/(1.001-e):-e}function $t(e,t,r){return(e-t.min)*(r.max-r.min)/(t.max-t.min)+r.min}const qt={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!qt.API_URL)return null;try{const e=new URL(qt.API_URL);return"api.mapbox.cn"===e.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===e.hostname?"https://events.mapbox.com/events/v2":null}catch(e){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.4.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Ht(e){return qt.API_URL_REGEX.test(e)}function Wt(e){return qt.API_SPRITE_REGEX.test(e)}let Zt,Xt,Yt,Jt,Qt,Kt;function ii(){return null==Zt&&(Zt=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Zt}const ri={now:()=>void 0!==Jt?Jt:performance.now(),setNow(e){Jt=e},restoreNow(){Jt=void 0},frame(e){const t=requestAnimationFrame(e);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:r,height:o}=e;Qt||(Qt=document.createElement("canvas"));const s=Qt.getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas 2d context");return(r>Qt.width||o>Qt.height)&&(Qt.width=r,Qt.height=o),s.clearRect(-t,-t,r+2*t,o+2*t),s.drawImage(e,0,0,r,o),s.getImageData(-t,-t,r+2*t,o+2*t)},resolveURL:e=>(Xt||(Xt=document.createElement("a")),Xt.href=e,Xt.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==Yt&&(Yt=window.matchMedia("(prefers-reduced-motion: reduce)")),Yt.matches)},hasCanvasFingerprintNoise(){if(void 0!==Kt)return Kt;if(!ii())return Kt=!1,!1;const e=new OffscreenCanvas(85,1),t=e.getContext("2d",{willReadFrequently:!0});let r=0;for(let o=0;o<e.width;++o)t.fillStyle=`rgba(${r++},${r++},${r++}, 255)`,t.fillRect(o,0,1,1);const o=t.getImageData(0,0,e.width,e.height);r=0;for(let e=0;e<o.data.length;++e)if(e%4!=3&&r++!==o.data[e])return Kt=!0,!0;return Kt=!1,!1}};function ni(e,t){const r=e.indexOf("?");if(r<0)return`${e}?${new URLSearchParams(t).toString()}`;const o=new URLSearchParams(e.slice(r));for(const e in t)o.set(e,t[e]);return`${e.slice(0,r)}?${o.toString()}`}function oi(e,t={persistentParams:[]}){const r=e.indexOf("?");if(r<0)return e;const o=new URLSearchParams,s=new URLSearchParams(e.slice(r));for(const e of t.persistentParams){const t=s.get(e);t&&o.set(e,t)}const l=o.toString();return`${e.slice(0,r)}${l.length>0?`?${l}`:""}`}const si="mapbox-tiles";let ai=500,li=50;const ci=["language","worldview","jobid"];let hi,ui;function di(){try{return caches}catch(e){}}function pi(){const e=di();e&&null==hi&&(hi=e.open(si))}let fi=1/0;const mi={supported:!1,testSupport:function(e){!vi&&gi&&(Pi?Di(e):_i=e)}};let _i,gi,vi=!1,Pi=!1;const Ci="undefined"!=typeof self?self:{};function Di(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,gi),e.isContextLost())return;mi.supported=!0}catch(e){}e.deleteTexture(t),vi=!0}Ci.document&&(gi=Ci.document.createElement("img"),gi.onload=function(){_i&&Di(_i),_i=null,Pi=!0},gi.onerror=function(){vi=!0,_i=null},gi.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Li={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(Li);class Re extends Error{constructor(e,t,r){401===t&&Ht(r)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=t,this.url=r}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Oi=Dt()?()=>self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const Fi=function(e,t){if(!(/^file:/.test(r=e.url)||/^file:/.test(Oi())&&!/^\w+:/.test(r))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(e,t){const r=new AbortController,o=new Request(e.url,{method:e.method||"GET",body:e.body,credentials:e.credentials,headers:e.headers,referrer:Oi(),referrerPolicy:e.referrerPolicy,signal:r.signal});let s=!1,l=!1;const c=(h=o.url).indexOf("sku=")>0&&Ht(h);var h;"json"===e.type&&o.headers.set("Accept","application/json");const u=(r,s,h)=>{if(l)return;if(r&&"SecurityError"!==r.message&&Et(r.toString()),s&&h)return d(s);const u=Date.now();fetch(o).then((r=>{if(r.ok){const e=c?r.clone():null;return d(r,e,u)}return t(new Re(r.statusText,r.status,e.url))})).catch((r=>{"AbortError"!==r.name&&t(new Error(`${r.message} ${e.url}`))}))},d=(r,c,h)=>{("arrayBuffer"===e.type?r.arrayBuffer():"json"===e.type?r.json():r.text()).then((e=>{l||(c&&h&&function(e,t,r){if(pi(),null==hi)return;const o=Lt(t.headers.get("Cache-Control")||"");if(o["no-store"])return;const s={status:t.status,statusText:t.statusText,headers:new Headers};t.headers.forEach(((e,t)=>s.headers.set(t,e))),o["max-age"]&&s.headers.set("Expires",new Date(r+1e3*o["max-age"]).toUTCString());const l=s.headers.get("Expires");if(!l)return;if(new Date(l).getTime()-r<42e4)return;let c=oi(e.url,{persistentParams:ci});if(206===t.status){const t=e.headers.get("Range");if(!t)return;s.status=200,c=ni(c,{range:t})}!function(e,t){if(void 0===ui)try{new Response(new ReadableStream),ui=!0}catch(e){ui=!1}ui?t(e.body):e.blob().then(t).catch((e=>Et(e.message)))}(t,(e=>{const r=new Response(200!==(o=t.status)&&404!==o&&[101,103,204,205,304].includes(o)?null:e,s);var o;pi(),null!=hi&&hi.then((e=>e.put(c,r))).catch((e=>Et(e.message)))}))}(o,c,h),s=!0,t(null,e,r.headers))})).catch((e=>{l||t(new Error(e.message))}))};return c?function(e,t){if(pi(),null==hi)return t(null);hi.then((r=>{let o=oi(e.url,{persistentParams:ci});const s=e.headers.get("Range");s&&(o=ni(o,{range:s})),r.match(o).then((e=>{const s=function(e){if(!e)return!1;const t=new Date(e.headers.get("Expires")||0),r=Lt(e.headers.get("Cache-Control")||"");return Number(t)>Date.now()&&!r["no-cache"]}(e);r.delete(o).catch(t),s&&r.put(o,e.clone()).catch(t),t(null,e,s)})).catch(t)})).catch(t)}(o,u):u(null,null),{cancel:()=>{l=!0,s||r.abort()}}}(e,t);if(Dt(self)&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var r;return function(e,t){const r=new XMLHttpRequest;r.open(e.method||"GET",e.url,!0),"arrayBuffer"===e.type&&(r.responseType="arraybuffer");for(const t in e.headers)r.setRequestHeader(t,e.headers[t]);return"json"===e.type&&(r.responseType="text",r.setRequestHeader("Accept","application/json")),r.withCredentials="include"===e.credentials,r.onerror=()=>{t(new Error(r.statusText))},r.onload=()=>{if((r.status>=200&&r.status<300||0===r.status)&&null!==r.response){let o=r.response;if("json"===e.type)try{o=JSON.parse(r.response)}catch(e){return t(e)}const s=new Headers;r.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((e=>{const t=e.split(": "),r=t.shift(),o=t.join(": ");s.append(r,o)})),t(null,o,s)}else t(new Re(r.statusText,r.status,e.url))},r.send(e.body),{cancel:()=>r.abort()}}(e,t)},Bi=function(e,t){return Fi(Object.assign(e,{type:"arrayBuffer"}),t)};function ki(e){const t=document.createElement("a");return t.href=e,t.protocol===location.protocol&&t.host===location.host}const ji="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Zi,Xi;Zi=[],Xi=0;const ar=function(t,r){if(mi.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),Xi>=qt.MAX_PARALLEL_IMAGE_REQUESTS){const o={requestParameters:t,callback:r,cancelled:!1,cancel(){(this||e).cancelled=!0}};return Zi.push(o),o}Xi++;let o=!1;const s=()=>{if(!o)for(o=!0,Xi--;Zi.length&&Xi<qt.MAX_PARALLEL_IMAGE_REQUESTS;){const e=Zi.shift(),{requestParameters:t,callback:r,cancelled:o}=e;o||(e.cancel=ar(t,r).cancel)}},l=Bi(t,((e,t,o)=>{s(),e?r(e):t&&(self.createImageBitmap?function(e,t){const r=new Blob([new Uint8Array(e)],{type:"image/png"});createImageBitmap(r).then((e=>{t(null,e)})).catch((e=>{t(new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(t,((e,t)=>r(e,t,o))):function(e,t){const r=new Image;r.onload=()=>{t(null,r),URL.revokeObjectURL(r.src),r.onload=null,requestAnimationFrame((()=>{r.src=ji}))},r.onerror=()=>t(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const o=new Blob([new Uint8Array(e)],{type:"image/png"});r.src=e.byteLength?URL.createObjectURL(o):ji}(t,((e,t)=>r(e,t,o))))}));return{cancel:()=>{l.cancel(),s()}}};var lr,dr,fr,mr={exports:{}},_r={exports:{}},xr={exports:{}},vr=function(){if(fr)return mr.exports;fr=1;var e=(lr||(lr=1,_r.exports=function(e,t){var r,o,s,l,c,h,u,d;for(o=e.length-(r=3&e.length),s=t,c=3432918353,h=461845907,d=0;d<o;)u=255&e.charCodeAt(d)|(255&e.charCodeAt(++d))<<8|(255&e.charCodeAt(++d))<<16|(255&e.charCodeAt(++d))<<24,++d,s=27492+(65535&(l=5*(65535&(s=(s^=u=(65535&(u=(u=(65535&u)*c+(((u>>>16)*c&65535)<<16)&4294967295)<<15|u>>>17))*h+(((u>>>16)*h&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(l>>>16)&65535)<<16);switch(u=0,r){case 3:u^=(255&e.charCodeAt(d+2))<<16;case 2:u^=(255&e.charCodeAt(d+1))<<8;case 1:s^=u=(65535&(u=(u=(65535&(u^=255&e.charCodeAt(d)))*c+(((u>>>16)*c&65535)<<16)&4294967295)<<15|u>>>17))*h+(((u>>>16)*h&65535)<<16)&4294967295}return s^=e.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}),_r.exports),t=(dr||(dr=1,xr.exports=function(e,t){for(var r,o=e.length,s=t^o,l=0;o>=4;)r=1540483477*(65535&(r=255&e.charCodeAt(l)|(255&e.charCodeAt(++l))<<8|(255&e.charCodeAt(++l))<<16|(255&e.charCodeAt(++l))<<24))+((1540483477*(r>>>16)&65535)<<16),s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++l;switch(o){case 3:s^=(255&e.charCodeAt(l+2))<<16;case 2:s^=(255&e.charCodeAt(l+1))<<8;case 1:s=1540483477*(65535&(s^=255&e.charCodeAt(l)))+((1540483477*(s>>>16)&65535)<<16)}return s=1540483477*(65535&(s^=s>>>13))+((1540483477*(s>>>16)&65535)<<16),(s^=s>>>15)>>>0}),xr.exports);return mr.exports=e,mr.exports.murmur3=e,mr.exports.murmur2=t,mr.exports}(),br=Ze(vr);class tr{constructor(e,...t){Object.assign(this,t[0]||{}),this.type=e}}class er extends tr{constructor(e,t={}){super("error",Object.assign({error:e},t))}}function wr(e,t,r){r[e]&&-1!==r[e].indexOf(t)||(r[e]=r[e]||[],r[e].push(t))}function Tr(e,t,r){if(r&&r[e]){const o=r[e].indexOf(t);-1!==o&&r[e].splice(o,1)}}class ir{on(e,t){return this._listeners=this._listeners||{},wr(e,t,this._listeners),this}off(e,t){return Tr(e,t,this._listeners),Tr(e,t,this._oneTimeListeners),this}once(e,t){return t?(this._oneTimeListeners=this._oneTimeListeners||{},wr(e,t,this._oneTimeListeners),this):new Promise((t=>{this.once(e,t)}))}fire(e,t){const r="string"==typeof e?new tr(e,t):e,o=r.type;if(this.listens(o)){r.target=this;const e=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const t of e)t.call(this,r);const t=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const e of t)Tr(o,e,this._oneTimeListeners),e.call(this,r);const s=this._eventedParent;if(s){const e="function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData;Object.assign(r,e),s.fire(r)}}else r instanceof er&&console.error(r.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,t){return this._eventedParent=e,this._eventedParentData=t,this}}class sr{constructor(e){"string"==typeof e?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new sr(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[t,r]=e.split("");return new sr({name:t,iconsetId:r})}static isEqual(e,t){return e.name===t.name&&e.iconsetId===t.iconsetId}toString(){return sr.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Sr,Ir={},Er=function(){if(Sr)return Ir;Sr=1;var e={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(e){return(e=Math.round(e))<0?0:e>255?255:e}function r(e){return t("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function o(e){return(t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function s(e,t,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?e+(t-e)*r*6:2*r<1?t:3*r<2?e+(t-e)*(2/3-r)*6:e}try{Ir.parseCSSColor=function(l){var c,h=l.replace(/ /g,"").toLowerCase();if(h in e)return e[h].slice();if("#"===h[0])return 4===h.length?(c=parseInt(h.substr(1),16))>=0&&c<=4095?[(3840&c)>>4|(3840&c)>>8,240&c|(240&c)>>4,15&c|(15&c)<<4,1]:null:7===h.length&&(c=parseInt(h.substr(1),16))>=0&&c<=16777215?[(16711680&c)>>16,(65280&c)>>8,255&c,1]:null;var u=h.indexOf("("),d=h.indexOf(")");if(-1!==u&&d+1===h.length){var p=h.substr(0,u),f=h.substr(u+1,d-(u+1)).split(","),m=1;switch(p){case"rgba":if(4!==f.length)return null;m=o(f.pop());case"rgb":return 3!==f.length?null:[r(f[0]),r(f[1]),r(f[2]),m];case"hsla":if(4!==f.length)return null;m=o(f.pop());case"hsl":if(3!==f.length)return null;var _=(parseFloat(f[0])%360+360)%360/360,v=o(f[1]),E=o(f[2]),P=E<=.5?E*(v+1):E+v-E*v,C=2*E-P;return[t(255*s(C,P,_+1/3)),t(255*s(C,P,_)),t(255*s(C,P,_-1/3)),m];default:return null}}return null}}catch(e){}return Ir}();class ur{constructor(e,t,r,o=1){this.r=e,this.g=t,this.b=r,this.a=o}static parse(e){if(!e)return;if(e instanceof ur)return e;if("string"!=typeof e)return;const t=Er.parseCSSColor(e);return t?new ur(t[0]/255,t[1]/255,t[2]/255,t[3]):void 0}toString(){const[e,t,r,o]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*t)},${Math.round(255*r)},${o})`}toNonPremultipliedRenderColor(e){const{r:t,g:r,b:o,a:s}=this;return new hr(e,t,r,o,s)}toPremultipliedRenderColor(e){const{r:t,g:r,b:o,a:s}=this;return new pr(e,t*s,r*s,o*s,s)}clone(){return new ur(this.r,this.g,this.b,this.a)}}class cr{constructor(e,t,r,o,s,l=!1){if(this.premultiplied=!1,this.premultiplied=l,e){const l=e.image.height,c=l*l;this.premultiplied?(t=0===s?0:t/s*(l-1),r=0===s?0:r/s*(l-1),o=0===s?0:o/s*(l-1)):(t*=l-1,r*=l-1,o*=l-1),t=Math.max(0,Math.min(l-1,t)),r=Math.max(0,Math.min(l-1,r)),o=Math.max(0,Math.min(l-1,o));const h=Math.floor(t),u=Math.floor(r),d=Math.floor(o),p=Math.ceil(t),f=Math.ceil(r),m=Math.ceil(o),_=t-h,v=r-u,E=o-d,P=e.image.data,C=4*(h+u*c+d*l),R=4*(h+u*c+m*l),z=4*(h+f*c+d*l),D=4*(h+f*c+m*l),O=4*(p+u*c+d*l),F=4*(p+u*c+m*l),B=4*(p+f*c+d*l),k=4*(p+f*c+m*l);this.r=Ar(Ar(Ar(P[C],P[R],E),Ar(P[z],P[D],E),v),Ar(Ar(P[O],P[F],E),Ar(P[B],P[k],E),v),_)/255*(this.premultiplied?s:1),this.g=Ar(Ar(Ar(P[C+1],P[R+1],E),Ar(P[z+1],P[D+1],E),v),Ar(Ar(P[O+1],P[F+1],E),Ar(P[B+1],P[k+1],E),v),_)/255*(this.premultiplied?s:1),this.b=Ar(Ar(Ar(P[C+2],P[R+2],E),Ar(P[z+2],P[D+2],E),v),Ar(Ar(P[O+2],P[F+2],E),Ar(P[B+2],P[k+2],E),v),_)/255*(this.premultiplied?s:1),this.a=s}else this.r=t,this.g=r,this.b=o,this.a=s}toArray(){const{r:e,g:t,b:r,a:o}=this;return[255*e,255*t,255*r,o]}toHslaArray(){let{r:e,g:t,b:r,a:o}=this;if(this.premultiplied){if(0===o)return[0,0,0,0];const s=1/o;e*=s,t*=s,r*=s}const s=Math.min(Math.max(e,0),1),l=Math.min(Math.max(t,0),1),c=Math.min(Math.max(r,0),1),h=Math.min(s,l,c),u=Math.max(s,l,c),d=u-h,p=.5*(h+u);if(0===d)return[0,0,100*p,o];const f=p>.5?d/(2-u-h):d/(u+h);let m;switch(u){case s:m=60*((l-c)/d+(l<c?6:0));break;case l:m=60*((c-s)/d+2);break;default:m=60*((s-l)/d+4)}return[m,100*f,100*p,o]}toArray01(){const{r:e,g:t,b:r,a:o}=this;return[e,t,r,o]}toArray01Scaled(e){const{r:t,g:r,b:o}=this;return[t*e,r*e,o*e]}toArray01Linear(){const{r:e,g:t,b:r,a:o}=this;return[Math.pow(e,2.2),Math.pow(t,2.2),Math.pow(r,2.2),o]}}class hr extends cr{constructor(e,t,r,o,s){super(e,t,r,o,s,!1)}}class pr extends cr{constructor(e,t,r,o,s){super(e,t,r,o,s,!0)}}function Ar(e,t,r){return e*(1-r)+t*r}function Mr(e,t,r){return e.map(((e,o)=>Ar(e,t[o],r)))}ur.black=new ur(0,0,0,1),ur.white=new ur(1,1,1,1),ur.transparent=new ur(0,0,0,0),ur.red=new ur(1,0,0,1),ur.blue=new ur(0,0,1,1);var Pr=Object.freeze({__proto__:null,array:Mr,color:function(e,t,r){return new ur(Ar(e.r,t.r,r),Ar(e.g,t.g,r),Ar(e.b,t.b,r),Ar(e.a,t.a,r))},number:Ar});class yr extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class gr{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,r]of t)this.bindings[e]=r}concat(e){return new gr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const zr={kind:"null"},Fr={kind:"number"},Br={kind:"string"},kr={kind:"boolean"},Vr={kind:"color"},Nr={kind:"object"},Ur={kind:"value"},jr={kind:"collator"},Gr={kind:"formatted"},Xr={kind:"resolvedImage"};function Qr(e,t){return{kind:"array",itemType:e,N:t}}function en(e){if("array"===e.kind){const t=en(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const tn=[zr,Fr,Br,kr,Vr,Gr,Nr,Qr(Ur),Xr];function nn(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!nn(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of tn)if(!nn(e,t))return null}return`Expected ${en(e)} but found ${en(t)} instead.`}function on(e,t){return t.some((t=>t.kind===e.kind))}function cn(e,t){return t.some((t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e))}function hn(e,t){return"array"===e.kind&&"array"===t.kind?e.N===t.N&&hn(e.itemType,t.itemType):e.kind===t.kind}class Dr{constructor(e,t,r){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Cr{constructor(e,t,r,o,s){this.text=e.normalize?e.normalize():e,this.image=t,this.scale=r,this.fontStack=o,this.textColor=s}}class Rr{constructor(e){this.sections=e}static fromString(e){return new Rr([new Cr(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((e=>0!==e.text.length||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof Rr?e:Rr.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const t of this.sections){if(t.image){const r=t.image.getPrimary().id.toString();e.push(["image",r]);continue}e.push(t.text);const r={};t.fontStack&&(r["text-font"]=["literal",t.fontStack.split(",")]),t.scale&&(r["font-scale"]=t.scale),t.textColor&&(r["text-color"]=["rgba"].concat(t.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(r)}return e}}class Lr{constructor(e,t={}){this.id=sr.from(e),this.params=t.params,this.sx=t.sx||1,this.sy=t.sy||1}toString(){return JSON.stringify(this)}static parse(e){let t,r,o,s;try{({id:t,params:r,sx:o,sy:s}=JSON.parse(e)||{})}catch(e){return null}return t?new Lr(t,{params:r,sx:o,sy:s}):null}scaleSelf(e,t=e){return this.sx*=e,this.sy*=t,this}}class Or{constructor(e,t,r,o,s=!1){this.primaryId=sr.from(e),this.primaryOptions=t,r&&(this.secondaryId=sr.from(r)),this.secondaryOptions=o,this.available=s}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Lr(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Lr(this.secondaryId,this.secondaryOptions):null}static from(e){return"string"==typeof e?Or.build({name:e}):e}static build(e,t,r,o){return!e||"object"==typeof e&&!("name"in e)?null:new Or(e,r,t,o)}}function dn(e,t,r,o){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof r&&r>=0&&r<=255?void 0===o||"number"==typeof o&&o>=0&&o<=1?null:`Invalid rgba value [${[e,t,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof o?[e,t,r,o]:[e,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function pn(e){if(null===e)return!0;if("string"==typeof e)return!0;if("boolean"==typeof e)return!0;if("number"==typeof e)return!0;if(e instanceof ur)return!0;if(e instanceof Dr)return!0;if(e instanceof Rr)return!0;if(e instanceof Or)return!0;if(Array.isArray(e)){for(const t of e)if(!pn(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!pn(e[t]))return!1;return!0}return!1}function fn(e){if(null===e)return zr;if("string"==typeof e)return Br;if("boolean"==typeof e)return kr;if("number"==typeof e)return Fr;if(e instanceof ur)return Vr;if(e instanceof Dr)return jr;if(e instanceof Rr)return Gr;if(e instanceof Or)return Xr;if(Array.isArray(e)){const t=e.length;let r;for(const t of e){const e=fn(t);if(r){if(r===e)continue;r=Ur;break}r=e}return Qr(r||Ur,t)}return Nr}function mn(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof Rr||e instanceof Or||e instanceof ur?e.toString():JSON.stringify(e)}class $r{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!pn(e[1]))return t.error("invalid value");const r=e[1];let o=fn(r);const s=t.expectedType;return"array"!==o.kind||0!==o.N||!s||"array"!==s.kind||"number"==typeof s.N&&0!==s.N||(o=s),new $r(o,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof ur?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Rr?this.value.serialize():this.value}}class qr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const _n={string:Br,number:Fr,boolean:kr,object:Nr};class Hr{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let r,o=1;const s=e[0];if("array"===s){let s,l;if(e.length>2){const r=e[1];if("string"!=typeof r||!(r in _n)||"object"===r)return t.error('The item type argument of "array" must be one of string, number, boolean',1);s=_n[r],o++}else s=Ur;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);l=e[2],o++}r=Qr(s,l)}else r=_n[s];const l=[];for(;o<e.length;o++){const r=t.parse(e[o],o,Ur);if(!r)return null;l.push(r)}return new Hr(r,l)}evaluate(e){for(let t=0;t<this.args.length;t++){const r=this.args[t].evaluate(e);if(!nn(this.type,fn(r)))return r;if(t===this.args.length-1)throw new qr(`The expression ${JSON.stringify(this.args[t].serialize())} evaluated to ${en(fn(r))} but was expected to be of type ${en(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,t=[e.kind];if("array"===e.kind){const r=e.itemType;if("string"===r.kind||"number"===r.kind||"boolean"===r.kind){t.push(r.kind);const o=e.N;("number"==typeof o||this.args.length>1)&&t.push(o)}}return t.concat(this.args.map((e=>e.serialize())))}}class Zr{constructor(e){this.type=Gr,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[1];if(!Array.isArray(r)&&"object"==typeof r)return t.error("First argument must be an image or text section.");const o=[];let s=!1;for(let r=1;r<=e.length-1;++r){const l=e[r];if(s&&"object"==typeof l&&!Array.isArray(l)){s=!1;let e=null;if(l["font-scale"]&&(e=t.parseObjectValue(l["font-scale"],r,"font-scale",Fr),!e))return null;let c=null;if(l["text-font"]&&(c=t.parseObjectValue(l["text-font"],r,"text-font",Qr(Br)),!c))return null;let h=null;if(l["text-color"]&&(h=t.parseObjectValue(l["text-color"],r,"text-color",Vr),!h))return null;const u=o[o.length-1];u.scale=e,u.font=c,u.textColor=h}else{const l=t.parse(e[r],r,Ur);if(!l)return null;const c=l.type.kind;if("string"!==c&&"value"!==c&&"null"!==c&&"resolvedImage"!==c)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,o.push({content:l,scale:null,font:null,textColor:null})}}return new Zr(o)}evaluate(e){return new Rr(this.sections.map((t=>{const r=t.content.evaluate(e);return hn(fn(r),Xr)?new Cr("",r,null,null,null):new Cr(mn(r),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null)})))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const t of this.sections){e.push(t.content.serialize());const r={};t.scale&&(r["font-scale"]=t.scale.serialize()),t.font&&(r["text-font"]=t.font.serialize()),t.textColor&&(r["text-color"]=t.textColor.serialize()),e.push(r)}return e}}class Wr{constructor(e,t,r,o){this._imageWarnHistory={},this.type=Xr,this.namePrimary=e,this.nameSecondary=t,r&&(this.paramsPrimary=r.params,this.iconsetIdPrimary=r.iconset?r.iconset.id:void 0),o&&(this.paramsSecondary=o.params,this.iconsetIdSecondary=o.iconset?o.iconset.id:void 0)}static parse(e,t){if(e.length<2)return t.error("Expected two or more arguments.");let r=1;const o=[];function s(){if(r<e.length){const s=t.parse(e[r],r++,Br);return s?(o.push({image:s,options:{}}),!0):(t.error(o.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function l(){if(r<e.length){const l=e[r];if(null===(s=l)||"object"!=typeof s||Array.isArray(s))return!0;const c=l.params,h=l.iconset,u=t.concat(r);if(!c&&!h)return r++,!0;if(c){if("object"!=typeof c||c.constructor!==Object)return u.error('Image options "params" should be an object'),!1;const e={},t=u.concat(void 0,"params");for(const r in c){if(!r)return t.error("Image parameter name should be non-empty"),!1;const o=t.concat(void 0,r).parse(c[r],void 0,Vr,void 0,{typeAnnotation:"coerce"});if(!o)return!1;e[r]=o}o[o.length-1].options.params=e}if(h){if("object"!=typeof h||h.constructor!==Object)return u.error('Image options "iconset" should be an object'),!1;if(!h.id)return u.error('Image options "iconset" should have an "id" property'),!1;o[o.length-1].options.iconset=h}return r++,!0}var s;return!0}for(let e=0;e<2;e++)if(!s()||!l())return;return new Wr(o[0].image,o[1]?o[1].image:void 0,o[0].options,o[1]?o[1].options:void 0)}evaluateParams(e,t){const r={};if(t){for(const o in t)if(t[o])try{r[o]=t[o].evaluate(e)}catch(e){continue}if(0!==Object.keys(r).length)return{params:r}}}evaluate(e){const t={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},r=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,o=Or.build(t,r,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(o&&e.availableImages){const t=o.getPrimary().id;if(o.available=e.availableImages.some((e=>sr.isEqual(e,t))),o.available){const t=o.getSecondary()?o.getSecondary().id:null;t&&(o.available=e.availableImages.some((e=>sr.isEqual(e,t))))}}return o}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const t in this.paramsPrimary)this.paramsPrimary[t]&&e(this.paramsPrimary[t]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const t in this.paramsSecondary)this.paramsSecondary[t]&&e(this.paramsSecondary[t])}outputDefined(){return!1}serializeOptions(e,t){const r={};if(t&&(r.iconset={id:t}),e){r.params={};for(const t in e)e[t]&&(r.params[t]=e[t].serialize())}return Object.keys(r).length>0?r:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const t=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);t&&e.push(t)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const t=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);t&&e.push(t)}return e}}function gn(e){return xn(e)?"string":vn(e)?"number":bn(e)?"boolean":Array.isArray(e)?"array":null===e?"null":yn(e)?"object":typeof e}function yn(e){return null!=e&&!Array.isArray(e)&&"function"!=typeof e&&!(e instanceof String||e instanceof Number||e instanceof Boolean)&&"object"==typeof e}function xn(e){return"string"==typeof e||e instanceof String}function vn(e){return"number"==typeof e||e instanceof Number}function bn(e){return"boolean"==typeof e||e instanceof Boolean}const wn={"to-boolean":kr,"to-color":Vr,"to-number":Fr,"to-string":Br};class rn{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const r=e[0],o=[];let s=zr;if("to-array"===r){if(!Array.isArray(e[1]))return null;const r=e[1].length;if(t.expectedType){if("array"!==t.expectedType.kind)return t.error(`Expected ${t.expectedType.kind} but found array.`);s=Qr(t.expectedType.itemType,r)}else{if(!(r>0&&pn(e[1][0])))return null;s=Qr(fn(e[1][0]),r)}for(let l=0;l<r;l++){const r=e[1][l];let c;if(Array.isArray(r))c=t.parse(r,void 0,s.itemType);else{const e=gn(r);if(e!==s.itemType.kind)return t.error(`Expected ${s.itemType.kind} but found ${e}.`);c=t.registry.literal.parse(["literal",void 0===r?null:r],t)}if(!c)return null;o.push(c)}}else{if(("to-boolean"===r||"to-string"===r)&&2!==e.length)return t.error("Expected one argument.");s=wn[r];for(let r=1;r<e.length;r++){const s=t.parse(e[r],r,Ur);if(!s)return null;o.push(s)}}return new rn(s,o)}evaluate(e){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(e));if("color"===this.type.kind){let t,r;for(const o of this.args){if(t=o.evaluate(e),r=null,t instanceof ur)return t;if("string"==typeof t){const r=e.parseColor(t);if(r)return r}else if(Array.isArray(t)&&(r=t.length<3||t.length>4?`Invalid rbga value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:dn(t[0],t[1],t[2],t[3]),!r))return new ur(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new qr(r||`Could not parse color from value '${"string"==typeof t?t:String(JSON.stringify(t))}'`)}if("number"===this.type.kind){let t=null;for(const r of this.args){if(t=r.evaluate(e),null===t)return 0;const o=Number(t);if(!isNaN(o))return o}throw new qr(`Could not convert ${JSON.stringify(t)} to number.`)}return"formatted"===this.type.kind?Rr.fromString(mn(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?Or.build(mn(this.args[0].evaluate(e))):"array"===this.type.kind?this.args.map((t=>t.evaluate(e))):mn(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Zr([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Wr(this.args[0]).serialize();const e="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((t=>{e.push(t.serialize())})),e}}const Tn=["Unknown","Point","LineString","Polygon"];class sn{constructor(e,t,r){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=t,this.iconImageUseTheme=r}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Tn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:r,y:o}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(r*t-e[0])+this.featureDistanceData.bearing[1]*(o*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=ur.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}}class an{constructor(e,t,r,o,s){this.name=e,this.type=t,this._evaluate=r,this.args=o,this._overloadIndex=s}evaluate(e){if(!this._evaluate){const e=an.definitions[this.name];this._evaluate=Array.isArray(e)?e[2]:e.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,t){const r=e[0],o=an.definitions[r];if(!o)return t.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(o)?o[0]:o.type,l=Array.isArray(o)?[[o[1],o[2]]]:o.overloads,c=[];let h=null,u=-1;for(const[o,d]of l){if(Array.isArray(o)&&o.length!==e.length-1)continue;c.push(o),u++,h=new Ii(t.registry,t.path,null,t.scope,void 0,t._scope,t.options,t.iconImageUseTheme);const l=[];let p=!1;for(let t=1;t<e.length;t++){const r=e[t],s=Array.isArray(o)?o[t-1]:o.type,c=h.parse(r,1+l.length,s);if(!c){p=!0;break}l.push(c)}if(!p)if(Array.isArray(o)&&o.length!==l.length)h.error(`Expected ${o.length} arguments, but found ${l.length} instead.`);else{for(let e=0;e<l.length;e++){const t=Array.isArray(o)?o[e]:o.type,r=l[e];h.concat(e+1).checkSubtype(t,r.type)}if(0===h.errors.length)return new an(r,s,d,l,u)}}if(1===c.length)t.errors.push(...h.errors);else{const r=(c.length?c:l.map((([e])=>e))).map(Sn).join(" | "),o=[];for(let r=1;r<e.length;r++){const s=t.parse(e[r],1+o.length);if(!s)return null;o.push(en(s.type))}t.error(`Expected arguments of type ${r}, but found (${o.join(", ")}) instead.`)}return null}static register(e,t){an.definitions=t;for(const r in t)e[r]=an}}function Sn(e){return Array.isArray(e)?`(${e.map(en).join(", ")})`:`(${en(e.type)}...)`}class ln{constructor(e,t,r){this.type=jr,this.locale=r,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const r=e[1];if("object"!=typeof r||Array.isArray(r))return t.error("Collator options argument must be an object.");const o=void 0===r["case-sensitive"]?t.parse(!1,1,kr):t.parseObjectValue(r["case-sensitive"],1,"case-sensitive",kr);if(!o)return null;const s=void 0===r["diacritic-sensitive"]?t.parse(!1,1,kr):t.parseObjectValue(r["diacritic-sensitive"],1,"diacritic-sensitive",kr);if(!s)return null;let l=null;return r.locale&&(l=t.parseObjectValue(r.locale,1,"locale",Br),!l)?null:new ln(o,s,l)}evaluate(e){return new Dr(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function En(e,t,r=0,o=e.length-1,s=Mn){for(;o>r;){if(o-r>600){const l=o-r+1,c=t-r+1,h=Math.log(l),u=.5*Math.exp(2*h/3),d=.5*Math.sqrt(h*u*(l-u)/l)*(c-l/2<0?-1:1);En(e,t,Math.max(r,Math.floor(t-c*u/l+d)),Math.min(o,Math.floor(t+(l-c)*u/l+d)),s)}const l=e[t];let c=r,h=o;for(An(e,r,t),s(e[o],l)>0&&An(e,r,o);c<h;){for(An(e,c,h),c++,h--;s(e[c],l)<0;)c++;for(;s(e[h],l)>0;)h--}0===s(e[r],l)?An(e,r,h):(h++,An(e,h,o)),h<=t&&(r=h+1),t<=h&&(o=h-1)}}function An(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function Mn(e,t){return e<t?-1:e>t?1:0}function Pn(e){let t=0;for(let r,o,s=0,l=e.length,c=l-1;s<l;c=s++)r=e[s],o=e[c],t+=(o.x-r.x)*(r.y+o.y);return t}function Cn(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function zn(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function Dn(e,t,r){const o=e[0]-t[0],s=e[1]-t[1],l=e[0]-r[0],c=e[1]-r[1];return o*c-l*s===0&&o*l<=0&&s*c<=0}function Ln(e,t,r){return t[1]>e[1]!=r[1]>e[1]&&e[0]<(r[0]-t[0])*(e[1]-t[1])/(r[1]-t[1])+t[0]}function On(e,t,r=!1){let o=!1;for(let s=0,l=t.length;s<l;s++){const l=t[s];for(let t=0,s=l.length,c=s-1;t<s;c=t++){const s=l[c],h=l[t];if(Dn(e,s,h))return r;Ln(e,s,h)&&(o=!o)}}return o}function Fn(e,t,r,o){const s=o[0]-r[0],l=o[1]-r[1],c=(e[0]-r[0])*l-s*(e[1]-r[1]),h=(t[0]-r[0])*l-s*(t[1]-r[1]);return c>0&&h<0||c<0&&h>0}function Bn(e,t,r,o){return 0!==(s=[o[0]-r[0],o[1]-r[1]])[0]*(l=[t[0]-e[0],t[1]-e[1]])[1]-s[1]*l[0]&&!(!Fn(e,t,r,o)||!Fn(r,o,e,t));var s,l}function kn(e){const t=new Je(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=new Je(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const o of e[0])t.x>o.x&&(t.x=o.x),t.y>o.y&&(t.y=o.y),r.x<o.x&&(r.x=o.x),r.y<o.y&&(r.y=o.y);return{min:t,max:r}}const Un=8192;function jn(e,t){const r=(180+e[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,s=Math.pow(2,t.z);return[Math.round(r*s*Un),Math.round(o*s*Un)]}function Gn(e,t){for(let r=0;r<t.length;r++)if(On(e,t[r]))return!0;return!1}function Hn(e,t,r){for(const o of r)for(let r=0,s=o.length,l=s-1;r<s;l=r++)if(Bn(e,t,o[l],o[r]))return!0;return!1}function Zn(e,t){for(let r=0;r<e.length;++r)if(!On(e[r],t))return!1;for(let r=0;r<e.length-1;++r)if(Hn(e[r],e[r+1],t))return!1;return!0}function Yn(e,t){for(let r=0;r<t.length;r++)if(Zn(e,t[r]))return!0;return!1}function Jn(e,t,r){const o=[];for(let s=0;s<e.length;s++){const l=[];for(let o=0;o<e[s].length;o++){const c=jn(e[s][o],r);Cn(t,c),l.push(c)}o.push(l)}return o}function Qn(e,t,r){const o=[];for(let s=0;s<e.length;s++){const l=Jn(e[s],t,r);o.push(l)}return o}function Kn(e,t,r,o){if(e[0]<r[0]||e[0]>r[2]){const t=.5*o;let s=e[0]-r[0]>t?-o:r[0]-e[0]>t?o:0;0===s&&(s=e[0]-r[2]>t?-o:r[2]-e[0]>t?o:0),e[0]+=s}Cn(t,e)}function co(e,t,r,o){const s=Math.pow(2,o.z)*Un,l=[o.x*Un,o.y*Un],c=[];if(!e)return c;for(const o of e)for(const e of o){const o=[e.x+l[0],e.y+l[1]];Kn(o,t,r,s),c.push(o)}return c}function ho(e,t,r,o){const s=Math.pow(2,o.z)*Un,l=[o.x*Un,o.y*Un],c=[];if(!e)return c;for(const r of e){const e=[];for(const o of r){const r=[o.x+l[0],o.y+l[1]];Cn(t,r),e.push(r)}c.push(e)}if(t[2]-t[0]<=s/2){(h=t)[0]=h[1]=1/0,h[2]=h[3]=-1/0;for(const e of c)for(const o of e)Kn(o,t,r,s)}var h;return c}class Vn{constructor(e,t){this.type=kr,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(pn(e[1])){const t=e[1];if("FeatureCollection"===t.type)for(let e=0;e<t.features.length;++e){const r=t.features[e].geometry.type;if("Polygon"===r||"MultiPolygon"===r)return new Vn(t,t.features[e].geometry)}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new Vn(t,t.geometry)}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new Vn(t,t)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const r=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if("Polygon"===t.type){const l=Jn(t.coordinates,o,s),c=co(e.geometry(),r,o,s);if(!zn(r,o))return!1;for(const e of c)if(!On(e,l))return!1}if("MultiPolygon"===t.type){const l=Qn(t.coordinates,o,s),c=co(e.geometry(),r,o,s);if(!zn(r,o))return!1;for(const e of c)if(!Gn(e,l))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const r=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if("Polygon"===t.type){const l=Jn(t.coordinates,o,s),c=ho(e.geometry(),r,o,s);if(!zn(r,o))return!1;for(const e of c)if(!Zn(e,l))return!1}if("MultiPolygon"===t.type){const l=Qn(t.coordinates,o,s),c=ho(e.geometry(),r,o,s);if(!zn(r,o))return!1;for(const e of c)if(!Yn(e,l))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const fo={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},mo=1/298.257223563,go=mo*(2-mo),xo=Math.PI/180;class Rn{static fromTile(e,t,r){const o=Math.PI*(1-2*(e+.5)/Math.pow(2,t)),s=Math.atan(.5*(Math.exp(o)-Math.exp(-o)))/xo;return new Rn(s,r)}static get units(){return fo}constructor(e,t){if(void 0===e)throw new Error("No latitude given.");if(t&&!fo[t])throw new Error(`Unknown unit ${t}. Use one of: ${Object.keys(fo).join(", ")}`);const r=6378.137*xo*(t?fo[t]:1),o=Math.cos(e*xo),s=1/(1-go*(1-o*o)),l=Math.sqrt(s);this.kx=r*l*o,this.ky=r*l*s*(1-go)}distance(e,t){const r=wo(e[0]-t[0])*this.kx,o=(e[1]-t[1])*this.ky;return Math.sqrt(r*r+o*o)}bearing(e,t){const r=wo(t[0]-e[0])*this.kx;return Math.atan2(r,(t[1]-e[1])*this.ky)/xo}destination(e,t,r){const o=r*xo;return this.offset(e,Math.sin(o)*t,Math.cos(o)*t)}offset(e,t,r){return[e[0]+t/this.kx,e[1]+r/this.ky]}lineDistance(e){let t=0;for(let r=0;r<e.length-1;r++)t+=this.distance(e[r],e[r+1]);return t}area(e){let t=0;for(let r=0;r<e.length;r++){const o=e[r];for(let e=0,s=o.length,l=s-1;e<s;l=e++)t+=wo(o[e][0]-o[l][0])*(o[e][1]+o[l][1])*(r?-1:1)}return Math.abs(t)/2*this.kx*this.ky}along(e,t){let r=0;if(t<=0)return e[0];for(let o=0;o<e.length-1;o++){const s=e[o],l=e[o+1],c=this.distance(s,l);if(r+=c,r>t)return bo(s,l,(t-(r-c))/c)}return e[e.length-1]}pointToSegmentDistance(e,t,r){let[o,s]=t,l=wo(r[0]-o)*this.kx,c=(r[1]-s)*this.ky;if(0!==l||0!==c){const t=(wo(e[0]-o)*this.kx*l+(e[1]-s)*this.ky*c)/(l*l+c*c);t>1?(o=r[0],s=r[1]):t>0&&(o+=l/this.kx*t,s+=c/this.ky*t)}return l=wo(e[0]-o)*this.kx,c=(e[1]-s)*this.ky,Math.sqrt(l*l+c*c)}pointOnLine(e,t){let r=1/0,o=e[0][0],s=e[0][1],l=0,c=0;for(let h=0;h<e.length-1;h++){let u=e[h][0],d=e[h][1],p=wo(e[h+1][0]-u)*this.kx,f=(e[h+1][1]-d)*this.ky,m=0;0===p&&0===f||(m=(wo(t[0]-u)*this.kx*p+(t[1]-d)*this.ky*f)/(p*p+f*f),m>1?(u=e[h+1][0],d=e[h+1][1]):m>0&&(u+=p/this.kx*m,d+=f/this.ky*m)),p=wo(t[0]-u)*this.kx,f=(t[1]-d)*this.ky;const _=p*p+f*f;_<r&&(r=_,o=u,s=d,l=h,c=m)}return{point:[o,s],index:l,t:Math.max(0,Math.min(1,c))}}lineSlice(e,t,r){let o=this.pointOnLine(r,e),s=this.pointOnLine(r,t);if(o.index>s.index||o.index===s.index&&o.t>s.t){const e=o;o=s,s=e}const l=[o.point],c=o.index+1,h=s.index;!vo(r[c],l[0])&&c<=h&&l.push(r[c]);for(let e=c+1;e<=h;e++)l.push(r[e]);return vo(r[h],s.point)||l.push(s.point),l}lineSliceAlong(e,t,r){let o=0;const s=[];for(let l=0;l<r.length-1;l++){const c=r[l],h=r[l+1],u=this.distance(c,h);if(o+=u,o>e&&0===s.length&&s.push(bo(c,h,(e-(o-u))/u)),o>=t)return s.push(bo(c,h,(t-(o-u))/u)),s;o>e&&s.push(h)}return s}bufferPoint(e,t){const r=t/this.ky,o=t/this.kx;return[e[0]-o,e[1]-r,e[0]+o,e[1]+r]}bufferBBox(e,t){const r=t/this.ky,o=t/this.kx;return[e[0]-o,e[1]-r,e[2]+o,e[3]+r]}insideBBox(e,t){return wo(e[0]-t[0])>=0&&wo(e[0]-t[2])<=0&&e[1]>=t[1]&&e[1]<=t[3]}}function vo(e,t){return e[0]===t[0]&&e[1]===t[1]}function bo(e,t,r){const o=wo(t[0]-e[0]);return[e[0]+o*r,e[1]+(t[1]-e[1])*r]}function wo(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}class Nn{constructor(e=[],t=(e,t)=>e<t?-1:e>t?1:0){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:r}=this,o=t[e];for(;e>0;){const s=e-1>>1,l=t[s];if(r(o,l)>=0)break;t[e]=l,e=s}t[e]=o}_down(e){const{data:t,compare:r}=this,o=this.length>>1,s=t[e];for(;e<o;){let o=1+(e<<1);const l=o+1;if(l<this.length&&r(t[l],t[o])<0&&(o=l),r(t[o],s)>=0)break;t[e]=t[o],e=o}t[e]=s}}var Ao=8192;function Mo(e,t){return t.dist-e.dist}function Po(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function Ro(e){return e[1]-e[0]+1}function zo(e,t){const r=e[1]>=e[0]&&e[1]<t;return r||console.warn("Distance Expression: Index is out of range"),r}function Do(e,t){if(e[0]>e[1])return[null,null];const r=Ro(e);if(t){if(2===r)return[e,null];const t=Math.floor(r/2);return[[e[0],e[0]+t],[e[0]+t,e[1]]]}{if(1===r)return[e,null];const t=Math.floor(r/2)-1;return[[e[0],e[0]+t],[e[0]+t+1,e[1]]]}}function Bo(e,t){const r=[1/0,1/0,-1/0,-1/0];if(!zo(t,e.length))return r;for(let o=t[0];o<=t[1];++o)Cn(r,e[o]);return r}function ko(e){const t=[1/0,1/0,-1/0,-1/0];for(let r=0;r<e.length;++r)for(let o=0;o<e[r].length;++o)Cn(t,e[r][o]);return t}function Vo(e,t,r){if(Po(e)||Po(t))return NaN;let o=0,s=0;return e[2]<t[0]&&(o=t[0]-e[2]),e[0]>t[2]&&(o=e[0]-t[2]),e[1]>t[3]&&(s=e[1]-t[3]),e[3]<t[1]&&(s=t[1]-e[3]),r.distance([0,0],[o,s])}function Uo(e){return 360*e-180}function os(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function ss(e,t){const r=Math.pow(2,t.z),o=(e.y/Ao+t.y)/r;return[Uo((e.x/Ao+t.x)/r),os(o)]}function as(e,t){const r=[];for(let o=0;o<e.length;++o)r.push(ss(e[o],t));return r}function ls(e,t,r){const o=r.pointOnLine(t,e).point;return r.distance(e,o)}function cs(e,t,r,o,s){const l=r.slice(o[0],o[1]+1);let c=1/0;for(let r=t[0];r<=t[1];++r)if(0===(c=Math.min(c,ls(e[r],l,s))))return 0;return c}function Ls(e,t,r,o,s){const l=Math.min(s.pointToSegmentDistance(e,r,o),s.pointToSegmentDistance(t,r,o)),c=Math.min(s.pointToSegmentDistance(r,e,t),s.pointToSegmentDistance(o,e,t));return Math.min(l,c)}function Ws(e,t,r,o,s){if(!zo(t,e.length)||!zo(o,r.length))return NaN;let l=1/0;for(let c=t[0];c<t[1];++c)for(let t=o[0];t<o[1];++t){if(Bn(e[c],e[c+1],r[t],r[t+1]))return 0;l=Math.min(l,Ls(e[c],e[c+1],r[t],r[t+1],s))}return l}function Ys(e,t,r,o,s){if(!zo(t,e.length)||!zo(o,r.length))return NaN;let l=1/0;for(let c=t[0];c<=t[1];++c)for(let t=o[0];t<=o[1];++t)if(0===(l=Math.min(l,s.distance(e[c],r[t]))))return l;return l}function Js(e,t,r){if(On(e,t,!0))return 0;let o=1/0;for(const s of t){const t=s.length;if(t<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(s[0]!==s[t-1]&&0===(o=Math.min(o,r.pointToSegmentDistance(e,s[t-1],s[0]))))return o;if(0===(o=Math.min(o,ls(e,s,r))))return o}return o}function Qs(e,t,r,o){if(!zo(t,e.length))return NaN;for(let o=t[0];o<=t[1];++o)if(On(e[o],r,!0))return 0;let s=1/0;for(let l=t[0];l<t[1];++l)for(const t of r)for(let r=0,c=t.length,h=c-1;r<c;h=r++){if(Bn(e[l],e[l+1],t[h],t[r]))return 0;s=Math.min(s,Ls(e[l],e[l+1],t[h],t[r],o))}return s}function Ks(e,t){for(const r of e)for(let e=0;e<=r.length-1;++e)if(On(r[e],t,!0))return!0;return!1}function ea(e,t,r,o=1/0){const s=ko(e),l=ko(t);if(o!==1/0&&Vo(s,l,r)>=o)return o;if(zn(s,l)){if(Ks(e,t))return 0}else if(Ks(t,e))return 0;let c=o;for(const o of e)for(let e=0,s=o.length,l=s-1;e<s;l=e++)for(const s of t)for(let t=0,h=s.length,u=h-1;t<h;u=t++){if(Bn(o[l],o[e],s[u],s[t]))return 0;c=Math.min(c,Ls(o[l],o[e],s[u],s[t],r))}return c}function ta(e,t,r,o,s,l,c){if(null===l||null===c)return;const h=Vo(Bo(o,l),Bo(s,c),r);h<t&&e.push({dist:h,range1:l,range2:c})}function ia(e,t,r,o,s=1/0){let l=Math.min(o.distance(e[0],r[0][0]),s);if(0===l)return l;const c=new Nn([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Mo),h=t?50:100,u=ko(r);for(;c.length;){const s=c.pop();if(s.dist>=l)continue;const d=s.range1;if(Ro(d)<=h){if(!zo(d,e.length))return NaN;if(t){const t=Qs(e,d,r,o);if(0===(l=Math.min(l,t)))return l}else for(let t=d[0];t<=d[1];++t){const s=Js(e[t],r,o);if(0===(l=Math.min(l,s)))return l}}else{const r=Do(d,t);if(null!==r[0]){const t=Vo(Bo(e,r[0]),u,o);t<l&&c.push({dist:t,range1:r[0],range2:[0,0]})}if(null!==r[1]){const t=Vo(Bo(e,r[1]),u,o);t<l&&c.push({dist:t,range1:r[1],range2:[0,0]})}}}return l}function ra(e,t,r,o,s,l=1/0){let c=Math.min(l,s.distance(e[0],r[0]));if(0===c)return c;const h=new Nn([{dist:0,range1:[0,e.length-1],range2:[0,r.length-1]}],Mo),u=t?50:100,d=o?50:100;for(;h.length;){const l=h.pop();if(l.dist>=c)continue;const p=l.range1,f=l.range2;if(Ro(p)<=u&&Ro(f)<=d){if(!zo(p,e.length)||!zo(f,r.length))return NaN;if(t&&o?c=Math.min(c,Ws(e,p,r,f,s)):t||o?t&&!o?c=Math.min(c,cs(r,f,e,p,s)):!t&&o&&(c=Math.min(c,cs(e,p,r,f,s))):c=Math.min(c,Ys(e,p,r,f,s)),0===c)return c}else{const l=Do(p,t),u=Do(f,o);ta(h,c,s,e,r,l[0],u[0]),ta(h,c,s,e,r,l[0],u[1]),ta(h,c,s,e,r,l[1],u[0]),ta(h,c,s,e,r,l[1],u[1])}}return c}function na(e,t,r,o,s=1/0){let l=s;const c=Bo(e,[0,e.length-1]);for(const s of r)if(!(l!==1/0&&Vo(c,Bo(s,[0,s.length-1]),o)>=l)&&(l=Math.min(l,ra(e,t,s,!0,o,l)),0===l))return l;return l}function oa(e,t,r,o,s=1/0){let l=s;const c=Bo(e,[0,e.length-1]);for(const s of r){if(l!==1/0&&Vo(c,ko(s),o)>=l)continue;const r=ia(e,t,s,o,l);if(isNaN(r))return r;if(0===(l=Math.min(l,r)))return l}return l}function sa(e){return"Point"===e||"MultiPoint"===e||"LineString"===e||"MultiLineString"===e||"Polygon"===e||"MultiPolygon"===e}class yi{constructor(e,t){this.type=Fr,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(pn(e[1])){const t=e[1];if("FeatureCollection"===t.type){for(let e=0;e<t.features.length;++e)if(sa(t.features[e].geometry.type))return new yi(t,t.features[e].geometry)}else if("Feature"===t.type){if(sa(t.geometry.type))return new yi(t,t.geometry)}else if(sa(t.type))return new yi(t,t)}return t.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const t=e.geometry(),r=e.canonicalID();if(null!=t&&null!=r){if("Point"===e.geometryType())return function(e,t,r){const o=[];for(const r of e)for(const e of r)o.push(ss(e,t));const s=new Rn(o[0][1],"meters");return"Point"===r.type||"MultiPoint"===r.type||"LineString"===r.type?ra(o,!1,"Point"===r.type?[r.coordinates]:r.coordinates,"LineString"===r.type,s):"MultiLineString"===r.type?na(o,!1,r.coordinates,s):"Polygon"===r.type||"MultiPolygon"===r.type?oa(o,!1,"Polygon"===r.type?[r.coordinates]:r.coordinates,s):null}(t,r,this.geometries);if("LineString"===e.geometryType())return function(e,t,r){const o=[];for(const r of e){const e=[];for(const o of r)e.push(ss(o,t));o.push(e)}const s=new Rn(o[0][0][1],"meters");if("Point"===r.type||"MultiPoint"===r.type||"LineString"===r.type)return na("Point"===r.type?[r.coordinates]:r.coordinates,"LineString"===r.type,o,s);if("MultiLineString"===r.type){let e=1/0;for(let t=0;t<r.coordinates.length;t++){const l=na(r.coordinates[t],!0,o,s,e);if(isNaN(l))return l;if(0===(e=Math.min(e,l)))return e}return e}if("Polygon"===r.type||"MultiPolygon"===r.type){let e=1/0;for(let t=0;t<o.length;t++){const l=oa(o[t],!0,"Polygon"===r.type?[r.coordinates]:r.coordinates,s,e);if(isNaN(l))return l;if(0===(e=Math.min(e,l)))return e}return e}return null}(t,r,this.geometries);if("Polygon"===e.geometryType())return function(e,t,r){const o=[];for(const r of function(e){const t=e.length;if(t<=1)return[e];const r=[];let o,s;for(let l=0;l<t;l++){const t=Pn(e[l]);0!==t&&(e[l].area=Math.abs(t),void 0===s&&(s=t<0),s===t<0?(o&&r.push(o),o=[e[l]]):o.push(e[l]))}return o&&r.push(o),r}(e)){const e=[];for(let o=0;o<r.length;++o)e.push(as(r[o],t));o.push(e)}const s=new Rn(o[0][0][0][1],"meters");if("Point"===r.type||"MultiPoint"===r.type||"LineString"===r.type)return oa("Point"===r.type?[r.coordinates]:r.coordinates,"LineString"===r.type,o,s);if("MultiLineString"===r.type){let e=1/0;for(let t=0;t<r.coordinates.length;t++){const l=oa(r.coordinates[t],!0,o,s,e);if(isNaN(l))return l;if(0===(e=Math.min(e,l)))return e}return e}return"Polygon"===r.type||"MultiPolygon"===r.type?function(e,t,r){let o=1/0;for(const s of e)for(const e of t){const t=ea(s,e,r,o);if(isNaN(t))return t;if(0===(o=Math.min(o,t)))return o}return o}("Polygon"===r.type?[r.coordinates]:r.coordinates,o,s):null}(t,r,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function aa(e){if(e instanceof an){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof Vn)return!1;if(e instanceof yi)return!1;if(e instanceof Ai)return e.featureConstant;let t=!0;return e.eachChild((e=>{t&&!aa(e)&&(t=!1)})),t}function la(e){if(e instanceof an&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild((e=>{t&&!la(e)&&(t=!1)})),t}function ca(e,t){if(e instanceof an&&t.indexOf(e.name)>=0)return!1;let r=!0;return e.eachChild((e=>{r&&!ca(e,t)&&(r=!1)})),r}function ha(e,t,r){return[e,t,r].filter(Boolean).join("")}function ua(e,t){switch(e){case"string":return mn(t);case"number":return+t;case"boolean":return!!t;case"color":return ur.parse(t);case"formatted":return Rr.fromString(mn(t));case"resolvedImage":return Or.build(mn(t))}return t}function da(e,t,r,o){return void 0!==o&&(e=o*Math.round(e/o)),void 0!==t&&e<t&&(e=t),void 0!==r&&e>r&&(e=r),e}class Ai{constructor(e,t,r,o=!1){this.type=e,this.key=t,this.scope=r,this.featureConstant=o}static parse(e,t){let r=t.expectedType;if(null==r&&(r=Ur),e.length<2||e.length>3)return t.error("Invalid number of arguments for 'config' expression.");const o=t.parse(e[1],1);if(!(o instanceof $r))return t.error("Key name of 'config' expression must be a string literal.");let s,l=!0;const c=mn(o.value);if(e.length>=3){const r=t.parse(e[2],2);if(!(r instanceof $r))return t.error("Scope of 'config' expression must be a string literal.");s=mn(r.value)}if(t.options){const e=ha(c,s,t._scope),r=t.options.get(e);r&&(l=aa(r.value||r.default))}return new Ai(r,c,s,l)}evaluate(e){const t=ha(this.key,this.scope,e.scope),r=e.getConfig(t);if(!r)return null;const{type:o,value:s,values:l,minValue:c,maxValue:h,stepValue:u}=r,d=r.default.evaluate(e);let p=d;if(s){const t=e.scope;e.scope=(t||"").split("").slice(1).join(""),p=s.evaluate(e),e.scope=t}return o&&(p=ua(o,p)),void 0===p||void 0===c&&void 0===h&&void 0===u||("number"==typeof p?p=da(p,c,h,u):Array.isArray(p)&&(p=p.map((e=>"number"==typeof e?da(e,c,h,u):e)))),void 0!==s&&void 0!==p&&l&&!l.includes(p)&&(p=d,o&&(p=ua(o,p))),(o&&o!==this.type||void 0!==p&&!hn(fn(p),this.type))&&(p=ua(this.type.kind,p)),p}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Mi{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const r=e[1];return t.scope.has(r)?new Mi(r,t.scope.get(r)):t.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ii{constructor(e,t=[],r,o=new gr,s=[],l,c,h){this.registry=e,this.path=t,this.key=t.map((e=>"string"==typeof e?`['${e}']`:`[${e}]`)).join(""),this.scope=o,this.errors=s,this.expectedType=r,this._scope=l,this.options=c,this.iconImageUseTheme=h}parse(e,t,r,o,s={}){return t||r?this.concat(t,null,r,o)._parse(e,s):this._parse(e,s)}parseObjectValue(e,t,r,o,s,l={}){return this.concat(t,r,o,s)._parse(e,l)}_parse(e,t){function r(e,t,r){return"assert"===r?new Hr(t,[e]):"coerce"===r?new rn(t,[e]):e}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const o="string"==typeof e[0]?this.registry[e[0]]:void 0;if(o){let s=o.parse(e,this);if(!s)return null;if(this.expectedType){const e=this.expectedType,o=s.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==o.kind)if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==o.kind&&"string"!==o.kind){if(this.checkSubtype(e,o))return null}else s=r(s,e,t.typeAnnotation||"coerce");else s=r(s,e,t.typeAnnotation||"assert")}if(!(s instanceof $r)&&"resolvedImage"!==s.type.kind&&ma(s)){const t=new sn(this._scope,this.options,this.iconImageUseTheme);try{s=new $r(s.type,s.evaluate(t))}catch(e){return this.error(e.message),null}}return s}return rn.parse(["to-array",e],this)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,t,r,o){let s="number"==typeof e?this.path.concat(e):this.path;s="string"==typeof t?s.concat(t):s;const l=o?this.scope.concat(o):this.scope;return new Ii(this.registry,s,r||null,l,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...t){const r=`${this.key}${t.map((e=>`[${e}]`)).join("")}`;this.errors.push(new yr(r,e))}checkSubtype(e,t){const r=nn(e,t);return r&&this.error(r),r}}function ma(e){if(e instanceof Mi)return ma(e.boundExpression);if(e instanceof an&&"error"===e.name)return!1;if(e instanceof ln)return!1;if(e instanceof Vn)return!1;if(e instanceof yi)return!1;if(e instanceof Ai)return!1;const t=e instanceof rn||e instanceof Hr;let r=!0;return e.eachChild((e=>{r=t?r&&ma(e):r&&e instanceof $r})),!!r&&aa(e)&&ca(e,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function va(e,t){const r=e.length-1;let o,s,l=0,c=r,h=0;for(;l<=c;)if(h=Math.floor((l+c)/2),o=e[h],s=e[h+1],o<=t){if(h===r||t<s)return h;l=h+1}else{if(!(o>t))throw new qr("Input is not a number.");c=h-1}return 0}class zi{constructor(e,t,r){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of r)this.labels.push(e),this.outputs.push(t)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const r=t.parse(e[1],1,Fr);if(!r)return null;const o=[];let s=null;t.expectedType&&"value"!==t.expectedType.kind&&(s=t.expectedType);for(let r=1;r<e.length;r+=2){const l=1===r?-1/0:e[r],c=e[r+1],h=r,u=r+1;if("number"!=typeof l)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',h);if(o.length&&o[o.length-1][0]>=l)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',h);const d=t.parse(c,u,s);if(!d)return null;s=s||d.type,o.push([l,d])}return new zi(s,r,o)}evaluate(e){const t=this.labels,r=this.outputs;if(1===t.length)return r[0].evaluate(e);const o=this.input.evaluate(e);if(o<=t[0])return r[0].evaluate(e);const s=t.length;return o>=t[s-1]?r[s-1].evaluate(e):r[va(t,o)].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let t=0;t<this.labels.length;t++)t>0&&e.push(this.labels[t]),e.push(this.outputs[t].serialize());return e}}const ba=.95047,wa=1.08883,Ta=4/29,Ia=6/29,Aa=3*Ia*Ia,Ma=Ia*Ia*Ia,Ra=Math.PI/180,Da=180/Math.PI;function La(e){return e>Ma?Math.pow(e,1/3):e/Aa+Ta}function Oa(e){return e>Ia?e*e*e:Aa*(e-Ta)}function Fa(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function Ba(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function ka(e){const t=Ba(e.r),r=Ba(e.g),o=Ba(e.b),s=La((.4124564*t+.3575761*r+.1804375*o)/ba),l=La((.2126729*t+.7151522*r+.072175*o)/1);return{l:116*l-16,a:500*(s-l),b:200*(l-La((.0193339*t+.119192*r+.9503041*o)/wa)),alpha:e.a}}function Va(e){let t=(e.l+16)/116,r=isNaN(e.a)?t:t+e.a/500,o=isNaN(e.b)?t:t-e.b/200;return t=1*Oa(t),r=ba*Oa(r),o=wa*Oa(o),new ur(Fa(3.2404542*r-1.5371385*t-.4985314*o),Fa(-.969266*r+1.8760108*t+.041556*o),Fa(.0556434*r-.2040259*t+1.0572252*o),e.alpha)}function Na(e,t,r){const o=t-e;return e+r*(o>180||o<-180?o-360*Math.round(o/360):o)}const Ua={forward:ka,reverse:Va,interpolate:function(e,t,r){return{l:Ar(e.l,t.l,r),a:Ar(e.a,t.a,r),b:Ar(e.b,t.b,r),alpha:Ar(e.alpha,t.alpha,r)}}},Ga={forward:function(e){const{l:t,a:r,b:o}=ka(e),s=Math.atan2(o,r)*Da;return{h:s<0?s+360:s,c:Math.sqrt(r*r+o*o),l:t,alpha:e.a}},reverse:function(e){const t=e.h*Ra,r=e.c;return Va({l:e.l,a:Math.cos(t)*r,b:Math.sin(t)*r,alpha:e.alpha})},interpolate:function(e,t,r){return{h:Na(e.h,t.h,r),c:Ar(e.c,t.c,r),l:Ar(e.l,t.l,r),alpha:Ar(e.alpha,t.alpha,r)}}};var Ya=Object.freeze({__proto__:null,hcl:Ga,lab:Ua});class Hi{constructor(e,t,r,o,s){this.type=e,this.operator=t,this.interpolation=r,this.input=o,this.labels=[],this.outputs=[];for(const[e,t]of s)this.labels.push(e),this.outputs.push(t)}static interpolationFactor(e,t,r,o){let s=0;if("exponential"===e.name)s=Ul(t,e.base,r,o);else if("linear"===e.name)s=Ul(t,1,r,o);else if("cubic-bezier"===e.name){const l=e.controlPoints;s=new Ye(l[0],l[1],l[2],l[3]).solve(Ul(t,1,r,o))}return s}static parse(e,t){let[r,o,s,...l]=e;if(!Array.isArray(o)||0===o.length)return t.error("Expected an interpolation type expression.",1);if("linear"===o[0])o={name:"linear"};else if("exponential"===o[0]){const e=o[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);o={name:"exponential",base:e}}else{if("cubic-bezier"!==o[0])return t.error(`Unknown interpolation type ${String(o[0])}`,1,0);{const e=o.slice(1);if(4!==e.length||e.some((e=>"number"!=typeof e||e<0||e>1)))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);o={name:"cubic-bezier",controlPoints:e}}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(s=t.parse(s,2,Fr),!s)return null;const c=[];let h=null;"interpolate-hcl"===r||"interpolate-lab"===r?h=Vr:t.expectedType&&"value"!==t.expectedType.kind&&(h=t.expectedType);for(let e=0;e<l.length;e+=2){const r=l[e],o=l[e+1],s=e+3,u=e+4;if("number"!=typeof r)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',s);if(c.length&&c[c.length-1][0]>=r)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',s);const d=t.parse(o,u,h);if(!d)return null;h=h||d.type,c.push([r,d])}return"number"===h.kind||"color"===h.kind||"array"===h.kind&&"number"===h.itemType.kind&&"number"==typeof h.N?new Hi(h,r,o,s,c):t.error(`Type ${en(h)} is not interpolatable.`)}evaluate(e){const t=this.labels,r=this.outputs;if(1===t.length)return r[0].evaluate(e);const o=this.input.evaluate(e);if(o<=t[0])return r[0].evaluate(e);const s=t.length;if(o>=t[s-1])return r[s-1].evaluate(e);const l=va(t,o),c=Hi.interpolationFactor(this.interpolation,o,t[l],t[l+1]),h=r[l].evaluate(e),u=r[l+1].evaluate(e);return"interpolate"===this.operator?Pr[this.type.kind.toLowerCase()](h,u,c):"interpolate-hcl"===this.operator?Ga.reverse(Ga.interpolate(Ga.forward(h),Ga.forward(u),c)):Ua.reverse(Ua.interpolate(Ua.forward(h),Ua.forward(u),c))}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const t=[this.operator,e,this.input.serialize()];for(let e=0;e<this.labels.length;e++)t.push(this.labels[e],this.outputs[e].serialize());return t}}function Ul(e,t,r,o){const s=o-r,l=e-r;return 0===s?0:1===t?l/s:(Math.pow(t,l)-1)/(Math.pow(t,s)-1)}class Wi{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expectected at least one argument.");let r=null;const o=t.expectedType;o&&"value"!==o.kind&&(r=o);const s=[];for(const o of e.slice(1)){const e=t.parse(o,1+s.length,r,void 0,{typeAnnotation:"omit"});if(!e)return null;r=r||e.type,s.push(e)}const l=o&&s.some((e=>nn(o,e.type)));return new Wi(l?Ur:r,s)}evaluate(e){let t,r=null,o=0;for(const s of this.args){if(o++,r=s.evaluate(e),r&&r instanceof Or&&!r.available&&(t||(t=r),r=null,o===this.args.length))return t;if(null!==r)break}return r}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((t=>{e.push(t.serialize())})),e}}class Yi{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const r=[];for(let o=1;o<e.length-1;o+=2){const s=e[o];if("string"!=typeof s)return t.error(`Expected string, but found ${typeof s} instead.`,o);if(/[^a-zA-Z0-9_]/.test(s))return t.error("Variable names must contain only alphanumeric characters or '_'.",o);const l=t.parse(e[o+1],o+1);if(!l)return null;r.push([s,l])}const o=t.parse(e[e.length-1],e.length-1,t.expectedType,r);return o?new Yi(r,o):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[t,r]of this.bindings)e.push(t,r.serialize());return e.push(this.result.serialize()),e}}class Ji{constructor(e,t,r){this.type=e,this.index=t,this.input=r}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Fr),o=t.parse(e[2],2,Qr(t.expectedType||Ur));return r&&o?new Ji(o.type.itemType,r,o):null}evaluate(e){const t=this.index.evaluate(e),r=this.input.evaluate(e);if(t<0)throw new qr("Array index out of bounds: negative index");if(t>=r.length)throw new qr("Array index out of bounds: index exceeds array size");if(t!==Math.floor(t))throw new qr("Array index must be an integer. Use at-interpolated for fractional indices");return r[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Ki{constructor(e,t,r){this.type=e,this.index=t,this.input=r}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Fr),o=t.parse(e[2],2,Qr(t.expectedType||Ur));return r&&o?new Ki(o.type.itemType,r,o):null}evaluate(e){const t=this.index.evaluate(e),r=this.input.evaluate(e);if(t<0)throw new qr(`Array index out of bounds: ${t} < 0.`);if(t>r.length-1)throw new qr(`Array index out of bounds: ${t} > ${r.length-1}.`);if(t===Math.floor(t))return r[t];const o=Math.floor(t),s=Math.ceil(t),l=r[o],c=r[s];if("number"!=typeof l||"number"!=typeof c)throw new qr(`Cannot interpolate between non-number values at index ${t}.`);const h=t-o;return l*(1-h)+c*h}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Qi{constructor(e,t){this.type=kr,this.needle=e,this.haystack=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Ur),o=t.parse(e[2],2,Ur);return r&&o?on(r.type,[kr,Br,Fr,zr,Ur])?new Qi(r,o):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${en(r.type)} instead`):null}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(null==r)return!1;if(!cn(t,["boolean","string","number","null"]))throw new qr(`Expected first argument to be of type boolean, string, number or null, but found ${en(fn(t))} instead.`);if(!cn(r,["string","array"]))throw new qr(`Expected second argument to be of type array or string, but found ${en(fn(r))} instead.`);return r.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class ts{constructor(e,t,r){this.type=Fr,this.needle=e,this.haystack=t,this.fromIndex=r}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Ur),o=t.parse(e[2],2,Ur);if(!r||!o)return null;if(!on(r.type,[kr,Br,Fr,zr,Ur]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${en(r.type)} instead`);if(4===e.length){const s=t.parse(e[3],3,Fr);return s?new ts(r,o,s):null}return new ts(r,o)}evaluate(e){const t=this.needle.evaluate(e),r=this.haystack.evaluate(e);if(!cn(t,["boolean","string","number","null"]))throw new qr(`Expected first argument to be of type boolean, string, number or null, but found ${en(fn(t))} instead.`);if(!cn(r,["string","array"]))throw new qr(`Expected second argument to be of type array or string, but found ${en(fn(r))} instead.`);if(this.fromIndex){const o=this.fromIndex.evaluate(e);return r.indexOf(t,o)}return r.indexOf(t)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class es{constructor(e,t,r,o,s,l){this.inputType=e,this.type=t,this.input=r,this.cases=o,this.outputs=s,this.otherwise=l}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let r,o;t.expectedType&&"value"!==t.expectedType.kind&&(o=t.expectedType);const s={},l=[];for(let c=2;c<e.length-1;c+=2){let h=e[c];const u=e[c+1];Array.isArray(h)||(h=[h]);const d=t.concat(c);if(0===h.length)return d.error("Expected at least one branch label.");for(const e of h){if("number"!=typeof e&&"string"!=typeof e)return d.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return d.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return d.error("Numeric branch labels must be integer values.");if(r){if(d.checkSubtype(r,fn(e)))return null}else r=fn(e);if(void 0!==s[String(e)])return d.error("Branch labels must be unique.");s[String(e)]=l.length}const p=t.parse(u,c,o);if(!p)return null;o=o||p.type,l.push(p)}const c=t.parse(e[1],1,Ur);if(!c)return null;const h=t.parse(e[e.length-1],e.length-1,o);return h?"value"!==c.type.kind&&t.concat(1).checkSubtype(r,c.type)?null:new es(r,o,c,s,l,h):null}evaluate(e){const t=this.input.evaluate(e);return(hn(fn(t),this.inputType)&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],t=Object.keys(this.cases).sort(),r=[],o={};for(const e of t){const t=o[this.cases[e]];void 0===t?(o[this.cases[e]]=r.length,r.push([this.cases[e],[e]])):r[t][1].push(e)}const s=e=>"number"===this.inputType.kind?Number(e):e;for(const[t,o]of r)e.push(1===o.length?s(o[0]):o.map(s)),e.push(this.outputs[t].serialize());return e.push(this.otherwise.serialize()),e}}class rs{constructor(e,t,r){this.type=e,this.branches=t,this.otherwise=r}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let r;t.expectedType&&"value"!==t.expectedType.kind&&(r=t.expectedType);const o=[];for(let s=1;s<e.length-1;s+=2){const l=t.parse(e[s],s,kr);if(!l)return null;const c=t.parse(e[s+1],s+1,r);if(!c)return null;o.push([l,c]),r=r||c.type}const s=t.parse(e[e.length-1],e.length-1,r);return s?new rs(r,o,s):null}evaluate(e){for(const[t,r]of this.branches)if(t.evaluate(e))return r.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,r]of this.branches)e(t),e(r);e(this.otherwise)}outputDefined(){return this.branches.every((([e,t])=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((t=>{e.push(t.serialize())})),e}}class ns{constructor(e,t,r,o){this.type=e,this.input=t,this.beginIndex=r,this.endIndex=o}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Ur),o=t.parse(e[2],2,Fr);if(!r||!o)return null;if(!on(r.type,[Qr(Ur),Br,Ur]))return t.error(`Expected first argument to be of type array or string, but found ${en(r.type)} instead`);if(4===e.length){const s=t.parse(e[3],3,Fr);return s?new ns(r.type,r,o,s):null}return new ns(r.type,r,o)}evaluate(e){const t=this.input.evaluate(e),r=this.beginIndex.evaluate(e);if(!cn(t,["string","array"]))throw new qr(`Expected first argument to be of type array or string, but found ${en(fn(t))} instead.`);if(this.endIndex){const o=this.endIndex.evaluate(e);return t.slice(r,o)}return t.slice(r)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class is{constructor(e,t){this.type=Qr(Br),this.str=e,this.delimiter=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const r=t.parse(e[1],1,Br),o=t.parse(e[2],2,Br);return r&&o?new is(r,o):void 0}evaluate(e){const t=this.str.evaluate(e),r=this.delimiter.evaluate(e);return t.split(r)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Gl(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function ql(e,t,r,o){return 0===o.compare(t,r)}function Hl(e,t,r){const o="=="!==e&&"!="!==e;return class i{constructor(e,t,r){this.type=kr,this.lhs=e,this.rhs=t,this.collator=r,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const r=e[0];let s=t.parse(e[1],1,Ur);if(!s)return null;if(!Gl(r,s.type))return t.concat(1).error(`"${r}" comparisons are not supported for type '${en(s.type)}'.`);let l=t.parse(e[2],2,Ur);if(!l)return null;if(!Gl(r,l.type))return t.concat(2).error(`"${r}" comparisons are not supported for type '${en(l.type)}'.`);if(s.type.kind!==l.type.kind&&"value"!==s.type.kind&&"value"!==l.type.kind)return t.error(`Cannot compare types '${en(s.type)}' and '${en(l.type)}'.`);o&&("value"===s.type.kind&&"value"!==l.type.kind?s=new Hr(l.type,[s]):"value"!==s.type.kind&&"value"===l.type.kind&&(l=new Hr(s.type,[l])));let c=null;if(4===e.length){if("string"!==s.type.kind&&"string"!==l.type.kind&&"value"!==s.type.kind&&"value"!==l.type.kind)return t.error("Cannot use collator to compare non-string types.");if(c=t.parse(e[3],3,jr),!c)return null}return new i(s,l,c)}evaluate(s){const l=this.lhs.evaluate(s),c=this.rhs.evaluate(s);if(o&&this.hasUntypedArgument){const t=fn(l),r=fn(c);if(t.kind!==r.kind||"string"!==t.kind&&"number"!==t.kind)throw new qr(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${r.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const e=fn(l),r=fn(c);if("string"!==e.kind||"string"!==r.kind)return t(s,l,c)}return this.collator?r(s,l,c,this.collator.evaluate(s)):t(s,l,c)}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator)}outputDefined(){return!0}serialize(){const t=[e];return this.eachChild((e=>{t.push(e.serialize())})),t}}}const Xl=Hl("==",(function(e,t,r){return t===r}),ql),ec=Hl("!=",(function(e,t,r){return t!==r}),(function(e,t,r,o){return!ql(0,t,r,o)})),tc=Hl("<",(function(e,t,r){return t<r}),(function(e,t,r,o){return o.compare(t,r)<0})),nc=Hl(">",(function(e,t,r){return t>r}),(function(e,t,r,o){return o.compare(t,r)>0})),oc=Hl("<=",(function(e,t,r){return t<=r}),(function(e,t,r,o){return o.compare(t,r)<=0})),sc=Hl(">=",(function(e,t,r){return t>=r}),(function(e,t,r,o){return o.compare(t,r)>=0}));class fs{constructor(e,t,r,o,s,l){this.type=Br,this.number=e,this.locale=t,this.currency=r,this.unit=o,this.minFractionDigits=s,this.maxFractionDigits=l}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const r=t.parse(e[1],1,Fr);if(!r)return null;const o=e[2];if("object"!=typeof o||Array.isArray(o))return t.error("NumberFormat options argument must be an object.");let s=null;if(o.locale&&(s=t.parseObjectValue(o.locale,2,"locale",Br),!s))return null;let l=null;if(o.currency&&(l=t.parseObjectValue(o.currency,2,"currency",Br),!l))return null;let c=null;if(o.unit&&(c=t.parseObjectValue(o.unit,2,"unit",Br),!c))return null;let h=null;if(o["min-fraction-digits"]&&(h=t.parseObjectValue(o["min-fraction-digits"],2,"min-fraction-digits",Fr),!h))return null;let u=null;return o["max-fraction-digits"]&&(u=t.parseObjectValue(o["max-fraction-digits"],2,"max-fraction-digits",Fr),!u)?null:new fs(r,s,l,c,h,u)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class ms{constructor(e){this.type=Fr,this.input=e}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const r=t.parse(e[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?t.error(`Expected argument of type string or array, but found ${en(r.type)} instead.`):new ms(r):null}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return t.length;if(Array.isArray(t))return t.length;throw new qr(`Expected value to be of type string or array, but found ${en(fn(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((t=>{e.push(t.serialize())})),e}}function ac(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const cc={"==":Xl,"!=":ec,">":nc,"<":tc,">=":sc,"<=":oc,array:Hr,at:Ji,"at-interpolated":Ki,boolean:Hr,case:rs,coalesce:Wi,collator:ln,format:Zr,image:Wr,in:Qi,"index-of":ts,interpolate:Hi,"interpolate-hcl":Hi,"interpolate-lab":Hi,length:ms,let:Yi,literal:$r,match:es,number:Hr,"number-format":fs,object:Hr,slice:ns,step:zi,string:Hr,"to-boolean":rn,"to-color":rn,"to-number":rn,"to-string":rn,var:Mi,within:Vn,distance:yi,config:Ai,split:is};function hc(e,[t,r,o,s]){t=t.evaluate(e),r=r.evaluate(e),o=o.evaluate(e);const l=s?s.evaluate(e):1,c=dn(t,r,o,l);if(c)throw new qr(c);return new ur(t/255,r/255,o/255,l)}function gc(e,[t,r,o,s]){t=t.evaluate(e),r=r.evaluate(e),o=o.evaluate(e);const l=s?s.evaluate(e):1,c=function(e,t,r,o){return"number"==typeof e&&e>=0&&e<=360?"number"==typeof t&&t>=0&&t<=100&&"number"==typeof r&&r>=0&&r<=100?void 0===o||"number"==typeof o&&o>=0&&o<=1?null:`Invalid hsla value [${[e,t,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof o?[e,t,r,o]:[e,t,r]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof o?[e,t,r,o]:[e,t,r]).join(", ")}]: 'h' must be between 0 and 360.`}(t,r,o,l);if(c)throw new qr(c);const h=`hsla(${t}, ${r}%, ${o}%, ${l})`,u=ur.parse(h);if(!u)throw new qr(`Failed to parse HSLA color: ${h}`);return u}function yc(e,t){return e in t}function xc(e,t){const r=t[e];return void 0===r?null:r}function vc(e){return{type:e}}function Tc(e){if(e instanceof Ai)return new Set([e.key]);let t=new Set;return e.eachChild((e=>{t=new Set([...t,...Tc(e)])})),t}function Ec(e){if(e instanceof an&&"is-active-floor"===e.name)return!0;let t=!1;return e.eachChild((e=>{!t&&Ec(e)&&(t=!0)})),t}function Pc(e){return{result:"success",value:e}}function Cc(e){return{result:"error",value:e}}function Rc(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function zc(e){return"data-driven"===e["property-type"]}function Dc(e){return Rc(e.expression,"measure-light")}function Lc(e){return Rc(e.expression,"zoom")}function Oc(e){return!!e.expression&&e.expression.interpolated}function Fc(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function Bc(e){return e}function kc(e,t){const r="color"===t.type,o=e.stops&&"object"==typeof e.stops[0][0],s=o||!(o||void 0!==e.property),l=e.type||(Oc(t)?"exponential":"interval");if(r&&((e=Object.assign({},e)).stops&&(e.stops=e.stops.map((e=>[e[0],ur.parse(e[1])]))),e.default=ur.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!Ya[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let c,h,u;if("exponential"===l)c=jc;else if("interval"===l)c=Uc;else if("categorical"===l){c=Nc,h=Object.create(null);for(const t of e.stops)h[t[0]]=t[1];u=typeof e.stops[0][0]}else{if("identity"!==l)throw new Error(`Unknown function type "${l}"`);c=Gc}if(o){const r={},o=[];for(let t=0;t<e.stops.length;t++){const s=e.stops[t],l=s[0].zoom;void 0===r[l]&&(r[l]={zoom:l,type:e.type,property:e.property,default:e.default,stops:[]},o.push(l)),r[l].stops.push([s[0].value,s[1]])}const s=[];for(const e of o)s.push([r[e].zoom,kc(r[e],t)]);const l={name:"linear"};return{kind:"composite",interpolationType:l,interpolationFactor:Hi.interpolationFactor.bind(void 0,l),zoomStops:s.map((e=>e[0])),evaluate:({zoom:r},o)=>jc({stops:s,base:e.base},t,r).evaluate(r,o)}}if(s){const r="exponential"===l?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:r,interpolationFactor:Hi.interpolationFactor.bind(void 0,r),zoomStops:e.stops.map((e=>e[0])),evaluate:({zoom:r})=>c(e,t,r,h,u)}}return{kind:"source",evaluate(r,o){const s=o&&o.properties?o.properties[e.property]:void 0;return void 0===s?Vc(e.default,t.default):c(e,t,s,h,u)}}}function Vc(e,t,r){return void 0!==e?e:void 0!==t?t:void 0!==r?r:void 0}function Nc(e,t,r,o,s){return Vc(typeof r===s?o[r]:void 0,e.default,t.default)}function Uc(e,t,r){if(!vn(r))return Vc(e.default,t.default);const o=e.stops.length;if(1===o)return e.stops[0][1];if(r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[o-1][0])return e.stops[o-1][1];const s=va(e.stops.map((e=>e[0])),r);return e.stops[s][1]}function jc(e,t,r){const o=void 0!==e.base?e.base:1;if(!vn(r))return Vc(e.default,t.default);const s=e.stops.length;if(1===s)return e.stops[0][1];if(r<=e.stops[0][0])return e.stops[0][1];if(r>=e.stops[s-1][0])return e.stops[s-1][1];const l=va(e.stops.map((e=>e[0])),r),c=function(e,t,r,o){const s=o-r,l=e-r;return 0===s?0:1===t?l/s:(Math.pow(t,l)-1)/(Math.pow(t,s)-1)}(r,o,e.stops[l][0],e.stops[l+1][0]),h=e.stops[l][1],u=e.stops[l+1][1];let d=Pr[t.type]||Bc;if(e.colorSpace&&"rgb"!==e.colorSpace){const t=Ya[e.colorSpace];d=(e,r)=>t.reverse(t.interpolate(t.forward(e),t.forward(r),c))}return"function"==typeof h.evaluate?{evaluate(...e){const t=h.evaluate.apply(void 0,e),r=u.evaluate.apply(void 0,e);if(void 0!==t&&void 0!==r)return d(t,r,c)}}:d(h,u,c)}function Gc(e,t,r){return"color"===t.type?r=ur.parse(r):"formatted"===t.type?r=Rr.fromString(r.toString()):"resolvedImage"===t.type?r=Or.build(r.toString()):gn(r)===t.type||"enum"===t.type&&t.values[r]||(r=void 0),Vc(r,e.default,t.default)}an.register(cc,{error:[{kind:"error"},[Br],(e,[t])=>{throw new qr(t.evaluate(e))}],typeof:[Br,[Ur],(e,[t])=>en(fn(t.evaluate(e)))],"to-rgba":[Qr(Fr,4),[Vr],(e,[t])=>t.evaluate(e).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Qr(Fr,4),[Vr],(e,[t])=>t.evaluate(e).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Vr,[Fr,Fr,Fr],hc],rgba:[Vr,[Fr,Fr,Fr,Fr],hc],hsl:[Vr,[Fr,Fr,Fr],gc],hsla:[Vr,[Fr,Fr,Fr,Fr],gc],has:{type:kr,overloads:[[[Br],(e,[t])=>yc(t.evaluate(e),e.properties())],[[Br,Nr],(e,[t,r])=>yc(t.evaluate(e),r.evaluate(e))]]},get:{type:Ur,overloads:[[[Br],(e,[t])=>xc(t.evaluate(e),e.properties())],[[Br,Nr],(e,[t,r])=>xc(t.evaluate(e),r.evaluate(e))]]},"feature-state":[Ur,[Br],(e,[t])=>xc(t.evaluate(e),e.featureState||{})],properties:[Nr,[],e=>e.properties()],"geometry-type":[Br,[],e=>e.geometryType()],worldview:[Br,[],e=>e.globals.worldview||""],"is-active-floor":[kr,vc(Br),(e,t)=>{if(!(e.globals.activeFloors&&e.globals.activeFloors.size>0))return!1;const r=e.globals.activeFloors;return t.some((t=>{const o=t.evaluate(e);return r.has(o)}))}],id:[Ur,[],e=>e.id()],zoom:[Fr,[],e=>e.globals.zoom],pitch:[Fr,[],e=>e.globals.pitch||0],"distance-from-center":[Fr,[],e=>e.distanceFromCenter()],"measure-light":[Fr,[Br],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[Fr,[],e=>e.globals.heatmapDensity||0],"line-progress":[Fr,[],e=>e.globals.lineProgress||0],"raster-value":[Fr,[],e=>e.globals.rasterValue||0],"raster-particle-speed":[Fr,[],e=>e.globals.rasterParticleSpeed||0],"sky-radial-progress":[Fr,[],e=>e.globals.skyRadialProgress||0],accumulated:[Ur,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[Fr,vc(Fr),(e,t)=>{let r=0;for(const o of t)r+=o.evaluate(e);return r}],"*":[Fr,vc(Fr),(e,t)=>{let r=1;for(const o of t)r*=o.evaluate(e);return r}],"-":{type:Fr,overloads:[[[Fr,Fr],(e,[t,r])=>t.evaluate(e)-r.evaluate(e)],[[Fr],(e,[t])=>-t.evaluate(e)]]},"/":[Fr,[Fr,Fr],(e,[t,r])=>t.evaluate(e)/r.evaluate(e)],"%":[Fr,[Fr,Fr],(e,[t,r])=>t.evaluate(e)%r.evaluate(e)],ln2:[Fr,[],()=>Math.LN2],pi:[Fr,[],()=>Math.PI],e:[Fr,[],()=>Math.E],"^":[Fr,[Fr,Fr],(e,[t,r])=>Math.pow(t.evaluate(e),r.evaluate(e))],sqrt:[Fr,[Fr],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Fr,[Fr],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Fr,[Fr],(e,[t])=>Math.log(t.evaluate(e))],log2:[Fr,[Fr],(e,[t])=>Math.log2(t.evaluate(e))],sin:[Fr,[Fr],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Fr,[Fr],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Fr,[Fr],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Fr,[Fr],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Fr,[Fr],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Fr,[Fr],(e,[t])=>Math.atan(t.evaluate(e))],min:[Fr,vc(Fr),(e,t)=>Math.min(...t.map((t=>t.evaluate(e))))],max:[Fr,vc(Fr),(e,t)=>Math.max(...t.map((t=>t.evaluate(e))))],abs:[Fr,[Fr],(e,[t])=>Math.abs(t.evaluate(e))],round:[Fr,[Fr],(e,[t])=>{const r=t.evaluate(e);return r<0?-Math.round(-r):Math.round(r)}],floor:[Fr,[Fr],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Fr,[Fr],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[kr,[Br,Ur],(e,[t,r])=>e.properties()[t.value]===r.value],"filter-id-==":[kr,[Ur],(e,[t])=>e.id()===t.value],"filter-type-==":[kr,[Br],(e,[t])=>e.geometryType()===t.value],"filter-<":[kr,[Br,Ur],(e,[t,r])=>{const o=e.properties()[t.value],s=r.value;return typeof o==typeof s&&o<s}],"filter-id-<":[kr,[Ur],(e,[t])=>{const r=e.id(),o=t.value;return typeof r==typeof o&&r<o}],"filter->":[kr,[Br,Ur],(e,[t,r])=>{const o=e.properties()[t.value],s=r.value;return typeof o==typeof s&&o>s}],"filter-id->":[kr,[Ur],(e,[t])=>{const r=e.id(),o=t.value;return typeof r==typeof o&&r>o}],"filter-<=":[kr,[Br,Ur],(e,[t,r])=>{const o=e.properties()[t.value],s=r.value;return typeof o==typeof s&&o<=s}],"filter-id-<=":[kr,[Ur],(e,[t])=>{const r=e.id(),o=t.value;return typeof r==typeof o&&r<=o}],"filter->=":[kr,[Br,Ur],(e,[t,r])=>{const o=e.properties()[t.value],s=r.value;return typeof o==typeof s&&o>=s}],"filter-id->=":[kr,[Ur],(e,[t])=>{const r=e.id(),o=t.value;return typeof r==typeof o&&r>=o}],"filter-has":[kr,[Ur],(e,[t])=>t.value in e.properties()],"filter-has-id":[kr,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[kr,[Qr(Br)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[kr,[Qr(Ur)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[kr,[Br,Qr(Ur)],(e,[t,r])=>r.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[kr,[Br,Qr(Ur)],(e,[t,r])=>function(e,t,r,o){for(;r<=o;){const s=r+o>>1;if(t[s]===e)return!0;t[s]>e?o=s-1:r=s+1}return!1}(e.properties()[t.value],r.value,0,r.value.length-1)],all:{type:kr,overloads:[[[kr,kr],(e,[t,r])=>t.evaluate(e)&&r.evaluate(e)],[vc(kr),(e,t)=>{for(const r of t)if(!r.evaluate(e))return!1;return!0}]]},any:{type:kr,overloads:[[[kr,kr],(e,[t,r])=>t.evaluate(e)||r.evaluate(e)],[vc(kr),(e,t)=>{for(const r of t)if(r.evaluate(e))return!0;return!1}]]},"!":[kr,[kr],(e,[t])=>!t.evaluate(e)],"is-supported-script":[kr,[Br],(e,[t])=>{const r=e.globals&&e.globals.isSupportedScript;return!r||r(t.evaluate(e))}],upcase:[Br,[Br],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[Br,[Br],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[Br,vc(Ur),(e,t)=>t.map((t=>mn(t.evaluate(e)))).join("")],"resolved-locale":[Br,[jr],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[Fr,[Fr,Fr,Ur],(e,t)=>{const[r,o,s]=t.map((t=>t.evaluate(e)));if(r>o)return r;if(r===o)return r;let l;if("string"==typeof s)l=function(e){let t=0;if(0===e.length)return t;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return t}(s);else{if("number"!=typeof s)throw new qr(`Invalid seed input: ${s}`);l=s}return r+ac(l)()*(o-r)}]});class Us{constructor(e,t,r,o,s){this.expression=e,this._warningHistory={},this._scope=r,this._options=o,this._iconImageUseTheme=s,this._evaluator=new sn(r,o,s),this._defaultValue=t?function(e){return"color"===e.type&&(Fc(e.default)||Array.isArray(e.default))?new ur(0,0,0,0):"color"===e.type?ur.parse(e.default)||null:void 0===e.default?null:e.default}(t):null,this._enumValues=t&&"enum"===t.type?t.values:null,this.configDependencies=Tc(e),this.isIndoorDependent=Ec(e)}evaluateWithoutErrorHandling(e,t,r,o,s,l,c,h){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=r,this._evaluator.canonical=o||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=l,this._evaluator.featureTileCoord=c||null,this._evaluator.featureDistanceData=h||null,this.expression.evaluate(this._evaluator)}evaluate(e,t,r,o,s,l,c,h,u){this._evaluator||(this._evaluator=new sn(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=r||null,this._evaluator.canonical=o||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=l||null,this._evaluator.featureTileCoord=c||null,this._evaluator.featureDistanceData=h||null,this._evaluator.iconImageUseTheme=u||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new qr(`Expected value to be one of ${Object.keys(this._enumValues).map((e=>JSON.stringify(e))).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e}catch(e){const t=e;return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${t.message}`)),this._defaultValue}}}function $c(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in cc}function qc(e,t,r,o,s){const l=new Ii(cc,[],t?function(e){const t={color:Vr,string:Br,number:Fr,enum:Br,boolean:kr,formatted:Gr,resolvedImage:Xr};return"array"===e.type?Qr(t[e.value]||Ur,e.length):t[e.type]}(t):void 0,void 0,void 0,r,o,s),c=l.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return c?Pc(new Us(c,t,r,o,s)):Cc(l.errors)}class Gs{constructor(e,t,r,o){this.kind=e,this._styleExpression=t,this.isLightConstant=r,this.isLineProgressConstant=o,this.isStateDependent="constant"!==e&&!la(t.expression),this.configDependencies=Tc(t.expression),this.isIndoorDependent=Ec(t.expression)}evaluateWithoutErrorHandling(e,t,r,o,s,l){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,o,s,l)}evaluate(e,t,r,o,s,l,c){return this._styleExpression.evaluate(e,t,r,o,s,l,void 0,void 0,c)}}class $s{constructor(e,t,r,o,s,l){this.kind=e,this.zoomStops=r,this._styleExpression=t,this.isStateDependent="camera"!==e&&!la(t.expression),this.isIndoorDependent=Ec(t.expression),this.isLightConstant=s,this.isLineProgressConstant=l,this.configDependencies=Tc(t.expression),this.interpolationType=o}evaluateWithoutErrorHandling(e,t,r,o,s,l){return this._styleExpression.evaluateWithoutErrorHandling(e,t,r,o,s,l)}evaluate(e,t,r,o,s,l){return this._styleExpression.evaluate(e,t,r,o,s,l)}interpolationFactor(e,t,r){return this.interpolationType?Hi.interpolationFactor(this.interpolationType,e,t,r):0}}function Hc(e,t,r,o,s){if("error"===(e=qc(e,t,r,o,s)).result)return e;const l=e.value.expression,c=aa(l);if(!c&&!zc(t))return Cc([new yr("","data expressions not supported")]);const h=ca(l,["zoom","pitch","distance-from-center"]);if(!h&&!Lc(t))return Cc([new yr("","zoom expressions not supported")]);const u=ca(l,["measure-light"]);if(!u&&!Dc(t))return Cc([new yr("","measure-light expression not supported")]);const d=ca(l,["line-progress"]);if(!d&&!function(e){return Rc(e.expression,"line-progress")}(t))return Cc([new yr("","line-progress expression not supported")]);const p=t.expression&&t.expression.relaxZoomRestriction,f=Wc(l);return f||h||p?f instanceof yr?Cc([f]):f instanceof Hi&&!Oc(t)?Cc([new yr("",'"interpolate" expressions cannot be used with this property')]):Pc(f?new $s(c&&d?"camera":"composite",e.value,f.labels,f instanceof Hi?f.interpolation:void 0,u,d):new Gs(c&&d?"constant":"source",e.value,u,d)):Cc([new yr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Xs{constructor(e,t){this._parameters=e,this._specification=t,Object.assign(this,kc(this._parameters,this._specification))}static deserialize(e){return new Xs(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Wc(e){let t=null;if(e instanceof Yi)t=Wc(e.result);else if(e instanceof Wi){for(const r of e.args)if(t=Wc(r),t)break}else(e instanceof zi||e instanceof Hi)&&e.input instanceof an&&"zoom"===e.input.name&&(t=e);return t instanceof yr||e.eachChild((e=>{const r=Wc(e);r instanceof yr?t=r:t&&r&&t!==r&&(t=new yr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),t}var Zc,Xc,Qc=function(){if(Xc)return Zc;Xc=1,Zc=r;var t=3;function r(r,o,s){var l=(this||e).cells=[];if(r instanceof ArrayBuffer){(this||e).arrayBuffer=r;var c=new Int32Array((this||e).arrayBuffer);r=c[0],(this||e).d=(o=c[1])+2*(s=c[2]);for(var h=0;h<(this||e).d*(this||e).d;h++){var u=c[t+h],d=c[t+h+1];l.push(u===d?null:c.subarray(u,d))}var p=c[t+l.length+1];(this||e).keys=c.subarray(c[t+l.length],p),(this||e).bboxes=c.subarray(p),(this||e).insert=(this||e)._insertReadonly}else{(this||e).d=o+2*s;for(var f=0;f<(this||e).d*(this||e).d;f++)l.push([]);(this||e).keys=[],(this||e).bboxes=[]}(this||e).n=o,(this||e).extent=r,(this||e).padding=s,(this||e).scale=o/r,(this||e).uid=0;var m=s/o*r;(this||e).min=-m,(this||e).max=r+m}return r.prototype.insert=function(t,r,o,s,l){this._forEachCell(r,o,s,l,(this||e)._insertCell,(this||e).uid++),(this||e).keys.push(t),(this||e).bboxes.push(r),(this||e).bboxes.push(o),(this||e).bboxes.push(s),(this||e).bboxes.push(l)},r.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},r.prototype._insertCell=function(t,r,o,s,l,c){(this||e).cells[l].push(c)},r.prototype.query=function(t,r,o,s,l){var c=(this||e).min,h=(this||e).max;if(t<=c&&r<=c&&h<=o&&h<=s&&!l)return Array.prototype.slice.call((this||e).keys);var u=[];return this._forEachCell(t,r,o,s,(this||e)._queryCell,u,{},l),u},r.prototype._queryCell=function(t,r,o,s,l,c,h,u){var d=(this||e).cells[l];if(null!==d)for(var p=(this||e).keys,f=(this||e).bboxes,m=0;m<d.length;m++){var _=d[m];if(void 0===h[_]){var v=4*_;(u?u(f[v+0],f[v+1],f[v+2],f[v+3]):t<=f[v+2]&&r<=f[v+3]&&o>=f[v+0]&&s>=f[v+1])?(h[_]=!0,c.push(p[_])):h[_]=!1}}},r.prototype._forEachCell=function(t,r,o,s,l,c,h,u){for(var d=this._convertToCellCoord(t),p=this._convertToCellCoord(r),f=this._convertToCellCoord(o),m=this._convertToCellCoord(s),_=d;_<=f;_++)for(var v=p;v<=m;v++){var E=(this||e).d*v+_;if((!u||u(this._convertFromCellCoord(_),this._convertFromCellCoord(v),this._convertFromCellCoord(_+1),this._convertFromCellCoord(v+1)))&&l.call(this||e,t,r,o,s,E,c,h,u))return}},r.prototype._convertFromCellCoord=function(t){return(t-(this||e).padding)/(this||e).scale},r.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min((this||e).d-1,Math.floor(t*(this||e).scale)+(this||e).padding))},r.prototype.toArrayBuffer=function(){if((this||e).arrayBuffer)return(this||e).arrayBuffer;for(var r=(this||e).cells,o=t+(this||e).cells.length+1+1,s=0,l=0;l<(this||e).cells.length;l++)s+=(this||e).cells[l].length;var c=new Int32Array(o+s+(this||e).keys.length+(this||e).bboxes.length);c[0]=(this||e).extent,c[1]=(this||e).n,c[2]=(this||e).padding;for(var h=o,u=0;u<r.length;u++){var d=r[u];c[t+u]=h,c.set(d,h),h+=d.length}return c[t+r.length]=h,c.set((this||e).keys,h),c[t+r.length+1]=h+=(this||e).keys.length,c.set((this||e).bboxes,h),h+=(this||e).bboxes.length,c.buffer},Zc}(),eh=Ze(Qc);const th={};function ih(e,t,r={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writable:!1}),th[t]={klass:e,omit:r.omit||[]}}ih(Object,"Object"),eh.serialize=function(e,t){const r=e.toArrayBuffer();return t&&t.add(r),{buffer:r}},eh.deserialize=function(e){return new eh(e.buffer)},Object.defineProperty(eh,"name",{value:"Grid"}),ih(eh,"Grid"),delete Je.prototype.constructor,ih(ur,"Color"),ih(Error,"Error"),ih(Rr,"Formatted"),ih(Cr,"FormattedSection"),ih(Re,"AJAXError"),ih(Or,"ResolvedImage"),ih(Xs,"StylePropertyFunction"),ih(Us,"StyleExpression",{omit:["_evaluator"]}),ih(sr,"ImageId"),ih(Lr,"ImageVariant"),ih($s,"ZoomDependentExpression"),ih(Gs,"ZoomConstantExpression"),ih(an,"CompoundExpression",{omit:["_evaluate"]});for(const e in cc)th[cc[e]._classRegistryKey]||ih(cc[e],`Expression${e}`);function rh(e){return e&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function nh(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(rh(e)||e instanceof ImageBitmap)return t&&t.add(e),e;if(ArrayBuffer.isView(e))return t&&t.add(e.buffer),e;if(e instanceof ImageData)return t&&t.add(e.data.buffer),e;if(Array.isArray(e)){const r=[];for(const o of e)r.push(nh(o,t));return r}if(e instanceof Map){const r={$name:"Map",entries:[]};for(const[o,s]of e.entries())r.entries.push(nh(o),nh(s,t));return r}if(e instanceof Set){const t={$name:"Set"};let r=0;for(const o of e.values())t[++r]=nh(o);return t}if("bigint"==typeof e)return{$name:"BigInt",value:e.toString()};if("object"==typeof e){const r=e.constructor,o=r._classRegistryKey;if(!o)throw new Error(`Can't serialize object of unregistered class "${r.name}".`);const s=r.serialize?r.serialize(e,t):{};if(!r.serialize){for(const r in e)e.hasOwnProperty(r)&&(th[o].omit.indexOf(r)>=0||(s[r]=nh(e[r],t)));e instanceof Error&&(s.message=e.message)}if(s.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==o&&(s.$name=o),s}throw new Error("can't serialize object of type "+typeof e)}function oh(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||rh(e)||e instanceof ImageBitmap||ArrayBuffer.isView(e)||e instanceof ImageData)return e;if(Array.isArray(e))return e.map(oh);if("object"==typeof e){const t=e.$name||"Object";if("Map"===t){const t=e.entries||[],r=new Map;for(let e=0;e<t.length;e+=2)r.set(oh(t[e]),oh(t[e+1]));return r}if("Set"===t){const t=new Set;for(const r of Object.keys(e))"$name"!==r&&t.add(oh(e[r]));return t}if("BigInt"===t)return BigInt(e.value);const{klass:r}=th[t];if(!r)throw new Error(`Can't deserialize unregistered class "${t}".`);if(r.deserialize)return r.deserialize(e);const o=Object.create(r.prototype);for(const t of Object.keys(e))"$name"!==t&&(o[t]=oh(e[t]));return o}throw new Error("can't deserialize object of type "+typeof e)}const sh=e=>e>=1536&&e<=1791,ah=e=>e>=1872&&e<=1919,ch=e=>e>=2208&&e<=2303,hh=e=>e>=11904&&e<=12031,uh=e=>e>=12032&&e<=12255,dh=e=>e>=12272&&e<=12287,ph=e=>e>=12288&&e<=12351,fh=e=>e>=12352&&e<=12447,mh=e=>e>=12448&&e<=12543,_h=e=>e>=12544&&e<=12591,gh=e=>e>=12704&&e<=12735,yh=e=>e>=12736&&e<=12783,xh=e=>e>=12784&&e<=12799,vh=e=>e>=12800&&e<=13055,bh=e=>e>=13056&&e<=13311,wh=e=>e>=13312&&e<=19903,Th=e=>e>=19968&&e<=40959,Sh=e=>e>=40960&&e<=42127,Ih=e=>e>=42128&&e<=42191,Eh=e=>e>=44032&&e<=55215,Ah=e=>e>=63744&&e<=64255,Mh=e=>e>=64336&&e<=65023,Ph=e=>e>=65040&&e<=65055,Ch=e=>e>=65072&&e<=65103,zh=e=>e>=65104&&e<=65135,Dh=e=>e>=65136&&e<=65279,Lh=e=>e>=65280&&e<=65519;function Oh(e){for(const t of e)if(Vh(t.charCodeAt(0)))return!0;return!1}function Fh(e){for(const t of e)if(!Bh(t.charCodeAt(0)))return!1;return!0}function Bh(e){return!(sh(e)||ah(e)||ch(e)||Mh(e)||Dh(e))}function kh(e){return!(e<11904||!(gh(e)||_h(e)||Ch(e)||Ah(e)||bh(e)||hh(e)||yh(e)||ph(e)||wh(e)||Th(e)||vh(e)||Lh(e)||fh(e)||dh(e)||uh(e)||xh(e)||mh(e)||Ph(e)||Ih(e)||Sh(e)))}function Vh(e){return!(746!==e&&747!==e&&(e<4352||!(gh(e)||_h(e)||Ch(e)&&!(e>=65097&&e<=65103)||Ah(e)||bh(e)||hh(e)||yh(e)||!(!ph(e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||wh(e)||Th(e)||vh(e)||(e=>e>=12592&&e<=12687)(e)||(e=>e>=43360&&e<=43391)(e)||(e=>e>=55216&&e<=55295)(e)||(e=>e>=4352&&e<=4607)(e)||Eh(e)||fh(e)||dh(e)||(e=>e>=12688&&e<=12703)(e)||uh(e)||xh(e)||mh(e)&&12540!==e||!(!Lh(e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!zh(e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||(e=>e>=5120&&e<=5759)(e)||(e=>e>=6320&&e<=6399)(e)||Ph(e)||(e=>e>=19904&&e<=19967)(e)||Sh(e)||Ih(e))))}function Nh(e){return 12312===e||12313===e||12316===e||12540===e||12448===e}function Uh(e){return!(Vh(e)||function(e){return!!((e=>e>=128&&e<=255)(e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||(e=>e>=8192&&e<=8303)(e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||(e=>e>=8448&&e<=8527)(e)||(e=>e>=8528&&e<=8591)(e)||(e=>e>=8960&&e<=9215)(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||(e=>e>=9216&&e<=9279)(e)&&9251!==e||(e=>e>=9280&&e<=9311)(e)||(e=>e>=9312&&e<=9471)(e)||(e=>e>=9632&&e<=9727)(e)||(e=>e>=9728&&e<=9983)(e)&&!(e>=9754&&e<=9759)||(e=>e>=11008&&e<=11263)(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||ph(e)||mh(e)||(e=>e>=57344&&e<=63743)(e)||Ch(e)||zh(e)||Lh(e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e)}(e))}function jh(e){return sh(e)||ah(e)||ch(e)||Mh(e)||Dh(e)}function Gh(e){return e>=1424&&e<=2303||Mh(e)||Dh(e)}function $h(e,t){return!(!t&&Gh(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||(e=>e>=6016&&e<=6143)(e))}function Wh(e){for(const t of e)if(Gh(t.charCodeAt(0)))return!0;return!1}const Zh={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Yh=null,Jh=Zh.unavailable,Qh=null;const Kh=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(Jh=Zh.error),Yh&&Yh(e)};function eu(){iu.fire(new tr("pluginStateChange",{pluginStatus:Jh,pluginURL:Qh}))}const iu=new ir,nu=function(){return Jh},ou=function(){if(Jh!==Zh.deferred||!Qh)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Jh=Zh.loading,eu(),Qh&&Bi({url:Qh},(e=>{e?Kh(e):(Jh=Zh.loaded,eu())}))},au={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Jh===Zh.loaded||null!=au.applyArabicShaping,isLoading:()=>Jh===Zh.loading,setState(e){Jh=e.pluginStatus,Qh=e.pluginURL},isParsing:()=>Jh===Zh.parsing,isParsed:()=>Jh===Zh.parsed,getPluginURL:()=>Qh};class Ja{constructor(e,t){this.zoom=e,t?(this.now=t.now,this.fadeDuration=t.fadeDuration,this.transition=t.transition,this.pitch=t.pitch,this.brightness=t.brightness,this.worldview=t.worldview,this.activeFloors=t.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(e,t){for(const r of e)if(!$h(r.charCodeAt(0),t))return!1;return!0}(e,au.isLoaded())}}class Ka{constructor(e,t,r,o,s){this.property=e,this.value=t,this.expression=function(e,t,r,o,s){if(Fc(e))return new Xs(e,t);if($c(e)||Array.isArray(e)&&e.length>0){const l=Hc(e,t,r,o,s);if("error"===l.result)throw new Error(l.value.map((e=>`${e.key}: ${e.message}`)).join(", "));return l.value}{let r=e;return"string"==typeof e&&"color"===t.type&&(r=ur.parse(e)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>r}}}(void 0===t?e.specification.default:t,e.specification,r,o,s)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(e,t,r,o){return this.property.possiblyEvaluate(this,e,t,r,o)}}class Qa{constructor(e,t,r,o){this.property=e,this.value=new Ka(e,void 0,t,r,o)}transitioned(e,t){return new eo(this.property,this.value,t,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new eo(this.property,this.value,null,{},0)}}class to{constructor(e,t,r,o){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=t,this._options=r,this._iconImageUseTheme=o,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Tt(this._values[e].value.value)}setValue(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Qa(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new Ka(this._values[e].property,null===t?void 0:Tt(t),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,t){t&&(this._options=t);const r=this._properties.properties;if(e)for(const t in e){const o=e[t];if(t.endsWith("-transition")){const e=t.slice(0,-11);r[e]&&this.setTransition(e,o)}else r.hasOwnProperty(t)&&this.setValue(t,o)}}getTransition(e){return Tt(this._values[e].transition)}setTransition(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Qa(this._values[e].property)),this._values[e].transition=Tt(t)||void 0}serialize(){const e={};for(const t of Object.keys(this._values)){const r=this.getValue(t);void 0!==r&&(e[t]=r);const o=this.getTransition(t);void 0!==o&&(e[`${t}-transition`]=o)}return e}transitioned(e,t){const r=new ro(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].transitioned(e,t._values[o]);return r}untransitioned(){const e=new ro(this._properties);for(const t of Object.keys(this._values))e._values[t]=this._values[t].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class eo{constructor(e,t,r,o,s){const l=o.delay||0,c=o.duration||0;s=s||0,this.property=e,this.value=t,this.begin=s+l,this.end=this.begin+c,e.specification.transition&&(o.delay||o.duration)&&(this.prior=r)}possiblyEvaluate(e,t,r){const o=e.now||0,s=this.value.possiblyEvaluate(e,t,r),l=this.prior;if(l){if(o>this.end)return this.prior=null,s;if(this.value.isDataDriven())return this.prior=null,s;if(o<this.begin)return l.possiblyEvaluate(e,t,r);{const c=(o-this.begin)/(this.end-this.begin);return this.property.interpolate(l.possiblyEvaluate(e,t,r),s,ot(c))}}return s}}class ro{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,t,r){const o=new so(this._properties);for(const s of Object.keys(this._values))o._values[s]=this._values[s].possiblyEvaluate(e,t,r);return o}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class no{constructor(e,t,r,o){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=t,this._options=r,this._iconImageUseTheme=o,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return Tt(this._values[e].value)}setValue(e,t){this._values[e]=new Ka(this._values[e].property,null===t?void 0:Tt(t),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const t of Object.keys(this._values)){const r=this.getValue(t);void 0!==r&&(e[t]=r)}return e}possiblyEvaluate(e,t,r,o){const s=new so(this._properties);for(const l of Object.keys(this._values))s._values[l]=this._values[l].possiblyEvaluate(e,t,r,o);return s}isIndoorDependent(){return this._isIndoorDependent}}class io{constructor(e,t,r,o){this.property=e,this.value=t,this.parameters=r,this.iconImageUseTheme=o}isConstant(){return"constant"===this.value.kind}constantOr(e){return"constant"===this.value.kind?this.value.value:e}evaluate(e,t,r,o){return this.property.evaluate(this.value,this.parameters,e,t,r,o,this.iconImageUseTheme)}}class so{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ao{constructor(e){this.specification=e}possiblyEvaluate(e,t){return e.expression.evaluate(t)}interpolate(e,t,r){const o=Pr[this.specification.type];return o?o(e,t,r):e}}class oo{constructor(e,t){this.specification=e,this.overrides=t}possiblyEvaluate(e,t,r,o,s){return"constant"===e.expression.kind||"camera"===e.expression.kind?new io(this,{kind:"constant",value:e.expression.evaluate(t,null,{},r,o,void 0,s)},t):new io(this,e.expression,t,s)}interpolate(e,t,r){if("constant"!==e.value.kind||"constant"!==t.value.kind)return e;if(void 0===e.value.value||void 0===t.value.value)return new io(this,{kind:"constant",value:void 0},e.parameters);const o=Pr[this.specification.type];return o?new io(this,{kind:"constant",value:o(e.value.value,t.value.value,r)},e.parameters):e}evaluate(e,t,r,o,s,l,c){return"constant"===e.kind?e.value:e.evaluate(t,r,o,s,l,void 0,c)}}class lo{constructor(e){this.specification=e}possiblyEvaluate(e,t,r,o){return!!e.expression.evaluate(t,null,{},r,o)}interpolate(){return!1}}class uo{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const t=new Ja(0,{});for(const r in e){const o=e[r];o.specification.overridable&&this.overridableProperties.push(r);const s=this.defaultPropertyValues[r]=new Ka(o,void 0),l=this.defaultTransitionablePropertyValues[r]=new Qa(o);this.defaultTransitioningPropertyValues[r]=l.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=s.possiblyEvaluate(t)}}}ih(oo,"DataDrivenProperty"),ih(ao,"DataConstantProperty"),ih(lo,"ColorRampProperty");var mu=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"shadow-draw-before-layer":{"type":"string"}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"url":{"type":"string"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"interpolated":true,"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"model-allow-density-reduction":{"type":"boolean","default":true}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function _u(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function gu(e){if(Array.isArray(e))return e.map(gu);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const r in e)t[r]=gu(e[r]);return t}return _u(e)}function yu(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!yu(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}function xu(e,t="",r=null,o="fill"){if(null==e)return{filter:()=>!0,needGeometry:!1,needFeature:!1};yu(e)||(e=Eu(e));const s=e;let l=!0;try{l=function(e){if(!wu(e))return e;let t=gu(e);return bu(t),t=vu(t),t}(s)}catch(e){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(s,null,2)}\n        `)}let c=null,h=null;if("background"!==o&&"sky"!==o&&"slot"!==o){h=mu[`filter_${o}`];const e=qc(l,h,t,r);if("error"===e.result)throw new Error(e.value.map((e=>`${e.key}: ${e.message}`)).join(", "));c=(t,r,o)=>e.value.evaluate(t,r,{},o)}let u=null,d=null;if(l!==s){const e=qc(s,h,t,r);if("error"===e.result)throw new Error(e.value.map((e=>`${e.key}: ${e.message}`)).join(", "));u=(t,r,o,s,l)=>e.value.evaluate(t,r,{},o,void 0,void 0,s,l),d=!aa(e.value.expression)}return{filter:c,dynamicFilter:u||void 0,needGeometry:Iu(l),needFeature:!!d}}function vu(e){if(!Array.isArray(e))return e;const t=function(e){if(Tu.has(e[0]))for(let t=1;t<e.length;t++)if(wu(e[t]))return!0;return e}(e);return!0===t?t:t.map((e=>vu(e)))}function bu(e){let t=!1;const r=[];if("case"===e[0]){for(let o=1;o<e.length-1;o+=2)t=t||wu(e[o]),r.push(e[o+1]);r.push(e[e.length-1])}else if("match"===e[0]){t=t||wu(e[1]);for(let t=2;t<e.length-1;t+=2)r.push(e[t+1]);r.push(e[e.length-1])}else if("step"===e[0]){t=t||wu(e[1]);for(let t=1;t<e.length-1;t+=2)r.push(e[t+1])}t&&(e.length=0,e.push("any",...r));for(let t=1;t<e.length;t++)bu(e[t])}function wu(e){if(!Array.isArray(e))return!1;if("pitch"===(t=e[0])||"distance-from-center"===t)return!0;var t;for(let t=1;t<e.length;t++)if(wu(e[t]))return!0;return!1}const Tu=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Su(e,t){return e<t?-1:e>t?1:0}function Iu(e){if(!Array.isArray(e))return!1;if("within"===e[0]||"distance"===e[0])return!0;for(let t=1;t<e.length;t++)if(Iu(e[t]))return!0;return!1}function Eu(e){if(!e)return!0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?Au(e[1],e[2],"=="):"!="===t?Cu(Au(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?Au(e[1],e[2],t):"any"===t?(r=e.slice(1),["any"].concat(r.map(Eu))):"all"===t?["all"].concat(e.slice(1).map(Eu)):"none"===t?["all"].concat(e.slice(1).map(Eu).map(Cu)):"in"===t?Mu(e[1],e.slice(2)):"!in"===t?Cu(Mu(e[1],e.slice(2))):"has"===t?Pu(e[1]):"!has"!==t||Cu(Pu(e[1]));var r}function Au(e,t,r){switch(e){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,e,t]}}function Mu(e,t){if(0===t.length)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some((e=>typeof e!=typeof t[0]))?["filter-in-large",e,["literal",t.sort(Su)]]:["filter-in-small",e,["literal",t]]}}function Pu(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function Cu(e){return["!",e]}const Ru="";function zu(e,t){return t?`${e}${Ru}${t}`:e}let Du;const Lu=()=>Du||(Du=new uo({"icon-size":new oo(mu.layout_symbol["icon-size"]),"icon-image":new oo(mu.layout_symbol["icon-image"]),"icon-rotate":new oo(mu.layout_symbol["icon-rotate"]),"icon-offset":new oo(mu.layout_symbol["icon-offset"]),"text-size":new oo(mu.layout_symbol["text-size"]),"text-rotate":new oo(mu.layout_symbol["text-rotate"]),"text-offset":new oo(mu.layout_symbol["text-offset"])}));class To{constructor(e,t,r,o,s,l){const c=qc(e,mu.appearance.condition);if("success"===c.result&&(this.condition=c.value),this.name=t,r){this.properties=new so(Lu()),this.unevaluatedLayout=new no(Lu(),o,s,l);for(const e in r)this.unevaluatedLayout.setValue(e,r[e])}}isActive(e){return!(this.condition||!e.isHidden||"hidden"!==this.name)||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}getUnevaluatedProperty(e){return this.unevaluatedLayout._values[e]}recalculate(e,t,r){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,t,r))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}hasIconProperties(){const e=this.hasProperty("icon-image"),t=this.hasProperty("icon-size"),r=this.hasProperty("icon-offset"),o=this.hasProperty("icon-rotate");return e||t||r||o}hasTextProperties(){const e=this.hasProperty("text-size"),t=this.hasProperty("text-offset"),r=this.hasProperty("text-rotate");return e||t||r}hasProperty(e){return void 0!==this.getUnevaluatedProperty(e).value}}const Ou="-transition",Fu=new Set(["fill","line","background","hillshade","raster"]);class Fo extends ir{constructor(e,t,r,o,s,l){if(super(),this.id=e.id,this.fqid=zu(this.id,r),this.type=e.type,this.scope=r,this.lut=o,this.options=s,this.iconImageUseTheme=l,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},"custom"!==e.type){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&"background"!==e.type&&"sky"!==e.type&&"slot"!==e.type){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const t=qc(this.filter,mu[`filter_${e.type}`]);"error"!==t.result&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...t.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||t.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),t.layout&&(this._unevaluatedLayout=new no(t.layout,this.scope,s,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),t.paint){this._transitionablePaint=new to(t.paint,this.scope,s);for(const t in e.paint)this.setPaintProperty(t,e.paint[t]);for(const t in e.layout)this.setLayoutProperty(t,e.layout[t]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new so(t.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Fu.has(this.type)}getLayoutProperty(e){return"visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,t){if("custom"===this.type&&"visibility"===e)return void(this.visibility=t);const r=this._unevaluatedLayout;r._properties.properties[e]&&(r.setValue(e,t),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...r.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||r.isIndoorDependent(),"visibility"===e&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach((e=>{this.appearances.push(new To(e.condition,e.name,e.properties,this.scope,this.options,this.iconImageUseTheme))}))}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(Ou)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,t){const r=this._transitionablePaint,o=r._properties.properties;if(e.endsWith(Ou)){const s=e.slice(0,-11);return o[s]&&r.setTransition(s,t||void 0),!1}if(!o[e])return!1;const s=r._values[e],l=s.value.isDataDriven(),c=s.value;r.setValue(e,t),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...r.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||r.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const h=r._values[e].value,u=h.isDataDriven(),d=e.endsWith("pattern")||"line-dasharray"===e;return u||l||d||this._handleOverridablePaintPropertyUpdate(e,c,h)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,t,r){return null}_handleOverridablePaintPropertyUpdate(e,t,r){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,t){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,t,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,t)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return 0!==this.appearances.length&&(e.appearances=this.appearances.map((e=>e.serialize()))),wt(e,((e,t)=>!(void 0===e||"layout"===t&&!Object.keys(e).length||"paint"===t&&!Object.keys(e).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const t=this.paint.get(e);if(t instanceof io&&zc(t.property.specification)&&("source"===t.value.kind||"composite"===t.value.kind)&&t.value.isStateDependent)return!0}for(const e of this.appearances)if(!la(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=xu(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&("shadow"===e.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,t,r){return{}}queryRadius(e){}queryIntersectsFeature(e,t,r,o,s,l,c,h,u,d){}}const Vu={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Co{constructor(e,t){this._structArray=e,this._pos1=t*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}const Nu=new ArrayBuffer(0);class Lo{constructor(){this._reallocCount=0,this.capacity=0,this.length=0}static serialize(e,t){return e._trim(),t&&e.arrayBuffer&&t.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const t=Object.create(this.prototype);return t.arrayBuffer=e.arrayBuffer,t.length=e.length,e.arrayBuffer?t.capacity=e.arrayBuffer.byteLength/t.bytesPerElement:(t.capacity=0,t.arrayBuffer=Nu),t._refreshViews(),t}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this._reallocCount++,this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const t=this.uint8;this._refreshViews(),t&&this.uint8.set(t)}}reserveForAdditional(e){this.reserve(this.length+e)}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Uu(e,t=1){let r=0,o=0;return{members:e.map((e=>{const s=Vu[e.type].BYTES_PER_ELEMENT,l=r=ju(r,Math.max(t,s)),c=e.components||1;return o=Math.max(o,s),r+=s*c,{name:e.name,type:e.type,components:c,offset:l}})),size:ju(r,Math.max(o,t)),alignment:t}}function ju(e,t){return Math.ceil(e/t)*t}class No extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const o=2*e;return this.int16[o+0]=t,this.int16[o+1]=r,e}}No.prototype.bytesPerElement=4,ih(No,"StructArrayLayout2i4");class jo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r)}emplace(e,t,r,o){const s=3*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.int16[s+2]=o,e}}jo.prototype.bytesPerElement=6,ih(jo,"StructArrayLayout3i6");class Go extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,r,o)}emplace(e,t,r,o,s){const l=4*e;return this.int16[l+0]=t,this.int16[l+1]=r,this.int16[l+2]=o,this.int16[l+3]=s,e}}Go.prototype.bytesPerElement=8,ih(Go,"StructArrayLayout4i8");class $o extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.float32[1*e+0]=t,e}}$o.prototype.bytesPerElement=4,ih($o,"StructArrayLayout1f4");class qo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r)}emplace(e,t,r,o){const s=4*e,l=2*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.float32[l+1]=o,e}}qo.prototype.bytesPerElement=8,ih(qo,"StructArrayLayout2i1f8");class Xo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r)}emplace(e,t,r,o){const s=4*e;return this.int16[s+0]=t,this.int16[s+1]=r,this.int16[s+2]=o,e}}Xo.prototype.bytesPerElement=8,ih(Xo,"StructArrayLayout3i8");class Ho extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s){const l=this.length;return this.resize(l+1),this.emplace(l,e,t,r,o,s)}emplace(e,t,r,o,s,l){const c=5*e;return this.int16[c+0]=t,this.int16[c+1]=r,this.int16[c+2]=o,this.int16[c+3]=s,this.int16[c+4]=l,e}}Ho.prototype.bytesPerElement=10,ih(Ho,"StructArrayLayout5i10");class Zo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,r,o,s,l,c)}emplace(e,t,r,o,s,l,c,h){const u=6*e,d=12*e,p=3*e;return this.int16[u+0]=t,this.int16[u+1]=r,this.uint8[d+4]=o,this.uint8[d+5]=s,this.uint8[d+6]=l,this.uint8[d+7]=c,this.float32[p+2]=h,e}}Zo.prototype.bytesPerElement=12,ih(Zo,"StructArrayLayout2i4ub1f12");class Wo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r)}emplace(e,t,r,o){const s=3*e;return this.float32[s+0]=t,this.float32[s+1]=r,this.float32[s+2]=o,e}}Wo.prototype.bytesPerElement=12,ih(Wo,"StructArrayLayout3f12");class Yo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s){const l=this.length;return this.resize(l+1),this.emplace(l,e,t,r,o,s)}emplace(e,t,r,o,s,l){const c=6*e,h=3*e;return this.uint16[c+0]=t,this.uint16[c+1]=r,this.uint16[c+2]=o,this.uint16[c+3]=s,this.float32[h+2]=l,e}}Yo.prototype.bytesPerElement=12,ih(Yo,"StructArrayLayout4ui1f12");class Jo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,r,o)}emplace(e,t,r,o,s){const l=4*e;return this.uint16[l+0]=t,this.uint16[l+1]=r,this.uint16[l+2]=o,this.uint16[l+3]=s,e}}Jo.prototype.bytesPerElement=8,ih(Jo,"StructArrayLayout4ui8");class Ko extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,r,o,s,l)}emplace(e,t,r,o,s,l,c){const h=6*e;return this.int16[h+0]=t,this.int16[h+1]=r,this.int16[h+2]=o,this.int16[h+3]=s,this.int16[h+4]=l,this.int16[h+5]=c,e}}Ko.prototype.bytesPerElement=12,ih(Ko,"StructArrayLayout6i12");class Qo extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p,f){const m=this.length;return this.resize(m+1),this.emplace(m,e,t,r,o,s,l,c,h,u,d,p,f)}emplace(e,t,r,o,s,l,c,h,u,d,p,f,m){const _=12*e;return this.int16[_+0]=t,this.int16[_+1]=r,this.int16[_+2]=o,this.int16[_+3]=s,this.uint16[_+4]=l,this.uint16[_+5]=c,this.uint16[_+6]=h,this.uint16[_+7]=u,this.int16[_+8]=d,this.int16[_+9]=p,this.int16[_+10]=f,this.int16[_+11]=m,e}}Qo.prototype.bytesPerElement=24,ih(Qo,"StructArrayLayout4i4ui4i24");class tl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,r,o,s,l)}emplace(e,t,r,o,s,l,c){const h=10*e,u=5*e;return this.int16[h+0]=t,this.int16[h+1]=r,this.int16[h+2]=o,this.float32[u+2]=s,this.float32[u+3]=l,this.float32[u+4]=c,e}}tl.prototype.bytesPerElement=20,ih(tl,"StructArrayLayout3i3f20");class el extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,r,o)}emplace(e,t,r,o,s){const l=4*e;return this.float32[l+0]=t,this.float32[l+1]=r,this.float32[l+2]=o,this.float32[l+3]=s,e}}el.prototype.bytesPerElement=16,ih(el,"StructArrayLayout4f16");class rl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint32[1*e+0]=t,e}}rl.prototype.bytesPerElement=4,ih(rl,"StructArrayLayout1ul4");class nl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const o=2*e;return this.uint16[o+0]=t,this.uint16[o+1]=r,e}}nl.prototype.bytesPerElement=4,ih(nl,"StructArrayLayout2ui4");class il extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p,f,m){const _=this.length;return this.resize(_+1),this.emplace(_,e,t,r,o,s,l,c,h,u,d,p,f,m)}emplace(e,t,r,o,s,l,c,h,u,d,p,f,m,_){const v=20*e,E=10*e;return this.int16[v+0]=t,this.int16[v+1]=r,this.int16[v+2]=o,this.int16[v+3]=s,this.int16[v+4]=l,this.float32[E+3]=c,this.float32[E+4]=h,this.float32[E+5]=u,this.float32[E+6]=d,this.int16[v+14]=p,this.uint32[E+8]=f,this.uint16[v+18]=m,this.uint16[v+19]=_,e}}il.prototype.bytesPerElement=40,ih(il,"StructArrayLayout5i4f1i1ul2ui40");class sl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,r,o,s,l,c)}emplace(e,t,r,o,s,l,c,h){const u=8*e;return this.int16[u+0]=t,this.int16[u+1]=r,this.int16[u+2]=o,this.int16[u+4]=s,this.int16[u+5]=l,this.int16[u+6]=c,this.int16[u+7]=h,e}}sl.prototype.bytesPerElement=16,ih(sl,"StructArrayLayout3i2i2i16");class al extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s){const l=this.length;return this.resize(l+1),this.emplace(l,e,t,r,o,s)}emplace(e,t,r,o,s,l){const c=4*e,h=8*e;return this.float32[c+0]=t,this.float32[c+1]=r,this.float32[c+2]=o,this.int16[h+6]=s,this.int16[h+7]=l,e}}al.prototype.bytesPerElement=16,ih(al,"StructArrayLayout2f1f2i16");class ol extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,r,o,s,l)}emplace(e,t,r,o,s,l,c){const h=20*e,u=5*e;return this.uint8[h+0]=t,this.uint8[h+1]=r,this.float32[u+1]=o,this.float32[u+2]=s,this.float32[u+3]=l,this.float32[u+4]=c,e}}ol.prototype.bytesPerElement=20,ih(ol,"StructArrayLayout2ub4f20");class ll extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,r)}emplace(e,t,r,o){const s=3*e;return this.uint16[s+0]=t,this.uint16[s+1]=r,this.uint16[s+2]=o,e}}ll.prototype.bytesPerElement=6,ih(ll,"StructArrayLayout3ui6");class ul extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D){const O=this.length;return this.resize(O+1),this.emplace(O,e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D)}emplace(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O){const F=30*e,B=15*e,k=60*e;return this.int16[F+0]=t,this.int16[F+1]=r,this.int16[F+2]=o,this.float32[B+2]=s,this.float32[B+3]=l,this.uint16[F+8]=c,this.uint16[F+9]=h,this.uint32[B+5]=u,this.uint32[B+6]=d,this.uint32[B+7]=p,this.uint16[F+16]=f,this.uint16[F+17]=m,this.uint16[F+18]=_,this.float32[B+10]=v,this.float32[B+11]=E,this.uint8[k+48]=P,this.uint8[k+49]=C,this.uint8[k+50]=R,this.uint32[B+13]=z,this.int16[F+28]=D,this.uint8[k+58]=O,e}}ul.prototype.bytesPerElement=60,ih(ul,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class cl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k,V,N,U,j,$,q,H,Z){const Y=this.length;return this.resize(Y+1),this.emplace(Y,e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k,V,N,U,j,$,q,H,Z)}emplace(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k,V,N,U,j,$,q,H,Z,Y){const J=20*e,Q=40*e,K=80*e;return this.float32[J+0]=t,this.float32[J+1]=r,this.int16[Q+4]=o,this.int16[Q+5]=s,this.int16[Q+6]=l,this.int16[Q+7]=c,this.int16[Q+8]=h,this.int16[Q+9]=u,this.int16[Q+10]=d,this.int16[Q+11]=p,this.int16[Q+12]=f,this.uint16[Q+13]=m,this.uint16[Q+14]=_,this.uint16[Q+15]=v,this.uint16[Q+16]=E,this.uint16[Q+17]=P,this.uint16[Q+18]=C,this.uint16[Q+19]=R,this.uint16[Q+20]=z,this.uint16[Q+21]=D,this.uint16[Q+22]=O,this.uint16[Q+23]=F,this.uint16[Q+24]=B,this.uint16[Q+25]=k,this.uint16[Q+26]=V,this.uint16[Q+27]=N,this.uint32[J+14]=U,this.float32[J+15]=j,this.float32[J+16]=$,this.float32[J+17]=q,this.float32[J+18]=H,this.uint8[K+76]=Z,this.uint16[Q+39]=Y,e}}cl.prototype.bytesPerElement=80,ih(cl,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class hl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,r,o,s,l)}emplace(e,t,r,o,s,l,c){const h=6*e;return this.float32[h+0]=t,this.float32[h+1]=r,this.float32[h+2]=o,this.float32[h+3]=s,this.float32[h+4]=l,this.float32[h+5]=c,e}}hl.prototype.bytesPerElement=24,ih(hl,"StructArrayLayout6f24");class pl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s){const l=this.length;return this.resize(l+1),this.emplace(l,e,t,r,o,s)}emplace(e,t,r,o,s,l){const c=5*e;return this.float32[c+0]=t,this.float32[c+1]=r,this.float32[c+2]=o,this.float32[c+3]=s,this.float32[c+4]=l,e}}pl.prototype.bytesPerElement=20,ih(pl,"StructArrayLayout5f20");class dl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,r,o,s,l,c)}emplace(e,t,r,o,s,l,c,h){const u=7*e;return this.float32[u+0]=t,this.float32[u+1]=r,this.float32[u+2]=o,this.float32[u+3]=s,this.float32[u+4]=l,this.float32[u+5]=c,this.float32[u+6]=h,e}}dl.prototype.bytesPerElement=28,ih(dl,"StructArrayLayout7f28");class fl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p){const f=this.length;return this.resize(f+1),this.emplace(f,e,t,r,o,s,l,c,h,u,d,p)}emplace(e,t,r,o,s,l,c,h,u,d,p,f){const m=11*e;return this.float32[m+0]=t,this.float32[m+1]=r,this.float32[m+2]=o,this.float32[m+3]=s,this.float32[m+4]=l,this.float32[m+5]=c,this.float32[m+6]=h,this.float32[m+7]=u,this.float32[m+8]=d,this.float32[m+9]=p,this.float32[m+10]=f,e}}fl.prototype.bytesPerElement=44,ih(fl,"StructArrayLayout11f44");class ml extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u){const d=this.length;return this.resize(d+1),this.emplace(d,e,t,r,o,s,l,c,h,u)}emplace(e,t,r,o,s,l,c,h,u,d){const p=9*e;return this.float32[p+0]=t,this.float32[p+1]=r,this.float32[p+2]=o,this.float32[p+3]=s,this.float32[p+4]=l,this.float32[p+5]=c,this.float32[p+6]=h,this.float32[p+7]=u,this.float32[p+8]=d,e}}ml.prototype.bytesPerElement=36,ih(ml,"StructArrayLayout9f36");class yl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t){const r=this.length;return this.resize(r+1),this.emplace(r,e,t)}emplace(e,t,r){const o=2*e;return this.float32[o+0]=t,this.float32[o+1]=r,e}}yl.prototype.bytesPerElement=8,ih(yl,"StructArrayLayout2f8");class gl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,r,o)}emplace(e,t,r,o,s){const l=6*e;return this.uint32[3*e+0]=t,this.uint16[l+2]=r,this.uint16[l+3]=o,this.uint16[l+4]=s,e}}gl.prototype.bytesPerElement=12,ih(gl,"StructArrayLayout1ul3ui12");class xl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint16[1*e+0]=t,e}}xl.prototype.bytesPerElement=2,ih(xl,"StructArrayLayout1ui2");class vl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E){const P=this.length;return this.resize(P+1),this.emplace(P,e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E)}emplace(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P){const C=16*e;return this.float32[C+0]=t,this.float32[C+1]=r,this.float32[C+2]=o,this.float32[C+3]=s,this.float32[C+4]=l,this.float32[C+5]=c,this.float32[C+6]=h,this.float32[C+7]=u,this.float32[C+8]=d,this.float32[C+9]=p,this.float32[C+10]=f,this.float32[C+11]=m,this.float32[C+12]=_,this.float32[C+13]=v,this.float32[C+14]=E,this.float32[C+15]=P,e}}vl.prototype.bytesPerElement=64,ih(vl,"StructArrayLayout16f64");class bl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,r,o,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,r,o,s,l,c)}emplace(e,t,r,o,s,l,c,h){const u=10*e,d=5*e;return this.uint16[u+0]=t,this.uint16[u+1]=r,this.uint16[u+2]=o,this.uint16[u+3]=s,this.float32[d+2]=l,this.float32[d+3]=c,this.float32[d+4]=h,e}}bl.prototype.bytesPerElement=20,ih(bl,"StructArrayLayout4ui3f20");class wl extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.int16[1*e+0]=t,e}}wl.prototype.bytesPerElement=2,ih(wl,"StructArrayLayout1i2");class _l extends Lo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint8[1*e+0]=t,e}}_l.prototype.bytesPerElement=1,ih(_l,"StructArrayLayout1ub1");class Al extends Co{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Al.prototype.size=40;class Ml extends il{get(e){return new Al(this,e)}}ih(Ml,"CollisionBoxArray");class Il extends Co{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Il.prototype.size=60;class Sl extends ul{get(e){return new Il(this,e)}}ih(Sl,"PlacedSymbolArray");class Pl extends Co{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Pl.prototype.size=80;class zl extends cl{get(e){return new Pl(this,e)}}ih(zl,"SymbolInstanceArray");class Bl extends $o{getoffsetX(e){return this.float32[1*e+0]}}ih(Bl,"GlyphOffsetArray");class kl extends No{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}ih(kl,"SymbolLineVertexArray");class Tl extends Co{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Tl.prototype.size=12;class Vl extends gl{get(e){return new Tl(this,e)}}ih(Vl,"FeatureIndexArray");class El extends nl{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}ih(El,"FillExtrusionCentroidArray");class Fl extends Co{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Fl.prototype.size=6;class Dl extends jo{get(e){return new Fl(this,e)}}ih(Dl,"FillExtrusionWallArray");const $u=Uu([{name:"a_pos",components:2,type:"Int16"}],4),qu=Uu([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Hu=Uu([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ol{constructor(e=[]){this.segments=e}_prepareSegment(e,t,r,o){let s=this.segments[this.segments.length-1];return e>Ol.MAX_VERTEX_ARRAY_LENGTH&&Et(`Max vertices per segment is ${Ol.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!s||s.vertexLength+e>Ol.MAX_VERTEX_ARRAY_LENGTH||s.sortKey!==o)&&(s={vertexOffset:t,primitiveOffset:r,vertexLength:0,primitiveLength:0},void 0!==o&&(s.sortKey=o),this.segments.push(s)),s}prepareSegment(e,t,r,o){return this._prepareSegment(e,t.length,r.length,o)}get(){return this.segments}destroy(){for(const e of this.segments)for(const t in e.vaos)e.vaos[t].destroy()}static simpleSegment(e,t,r,o){return new Ol([{vertexOffset:e,primitiveOffset:t,vertexLength:r,primitiveLength:o,vaos:{},sortKey:0}])}}function Wu(e,t){return 256*(e=ct(Math.floor(e),0,255))+ct(Math.floor(t),0,255)}Ol.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,ih(Ol,"SegmentVector");const Zu=Uu([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Xu=Uu([{name:"a_pattern_b",components:4,type:"Uint16"}]),Yu=Uu([{name:"a_dash",components:4,type:"Uint16"}]);class $l{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,t,r,o){this.ids.push(Ju(e)),this.positions.push(t,r,o)}eachPosition(e,t){const r=Ju(e);let o=0,s=this.ids.length-1;for(;o<s;){const e=o+s>>1;this.ids[e]>=r?s=e:o=e+1}for(;this.ids[o]===r;)t(this.positions[3*o],this.positions[3*o+1],this.positions[3*o+2]),o++}static serialize(e,t){const r=new Float64Array(e.ids),o=new Uint32Array(e.positions);return Ku(r,o,0,r.length-1),t&&(t.add(r.buffer),t.add(o.buffer)),{ids:r,positions:o}}static deserialize(e){const t=new $l;let r;t.ids=e.ids,t.positions=e.positions;for(const e of t.ids)e!==r&&t.uniqueIds.push(e),r=e;return t.indexed=!0,t}}function Ju(e){const t=+e;return Number.isSafeInteger(t)?t:br(String(e))}function Ku(e,t,r,o){for(;r<o;){const s=e[r+o>>1];let l=r-1,c=o+1;for(;;){do{l++}while(e[l]<s);do{c--}while(e[c]>s);if(l>=c)break;ed(e,l,c),ed(t,3*l,3*c),ed(t,3*l+1,3*c+1),ed(t,3*l+2,3*c+2)}c-r<o-c?(Ku(e,t,r,c),r=c+1):(Ku(e,t,c+1,o),o=c)}}function ed(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}ih($l,"FeaturePositionMap");class Zl{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,t){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,t),this.initialized=!0),!!this.location}set(e,t,r){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Wl extends Zl{constructor(e){super(e),this.current=0}set(e,t,r){this.fetchUniformLocation(e,t)&&this.current!==r&&(this.current=r,this.gl.uniform1i(this.location,r))}}class Yl extends Zl{constructor(e){super(e),this.current=0}set(e,t,r){this.fetchUniformLocation(e,t)&&this.current!==r&&(this.current=r,this.gl.uniform1f(this.location,r))}}class Jl extends Zl{constructor(e){super(e),this.current=[0,0]}set(e,t,r){this.fetchUniformLocation(e,t)&&(r[0]===this.current[0]&&r[1]===this.current[1]||(this.current=r,this.gl.uniform2f(this.location,r[0],r[1])))}}class Kl extends Zl{constructor(e){super(e),this.current=[0,0,0]}set(e,t,r){this.fetchUniformLocation(e,t)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]||(this.current=r,this.gl.uniform3f(this.location,r[0],r[1],r[2])))}}class Ql extends Zl{constructor(e){super(e),this.current=[0,0,0,0]}set(e,t,r){this.fetchUniformLocation(e,t)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]&&r[3]===this.current[3]||(this.current=r,this.gl.uniform4f(this.location,r[0],r[1],r[2],r[3])))}}class tu extends Zl{constructor(e){super(e),this.current=ur.transparent.toPremultipliedRenderColor(null)}set(e,t,r){this.fetchUniformLocation(e,t)&&(r.r===this.current.r&&r.g===this.current.g&&r.b===this.current.b&&r.a===this.current.a||(this.current=r,this.gl.uniform4f(this.location,r.r,r.g,r.b,r.a)))}}const td=new Float32Array(16);class ru extends Zl{constructor(e){super(e),this.current=td}set(e,t,r){if(this.fetchUniformLocation(e,t)){if(r[12]!==this.current[12]||r[0]!==this.current[0])return this.current=r,void this.gl.uniformMatrix4fv(this.location,!1,r);for(let e=1;e<16;e++)if(r[e]!==this.current[e]){this.current=r,this.gl.uniformMatrix4fv(this.location,!1,r);break}}}}const rd=new Float32Array(9),nd=new Float32Array(4);class su extends Zl{constructor(e){super(e),this.current=nd}set(e,t,r){if(this.fetchUniformLocation(e,t))for(let e=0;e<4;e++)if(r[e]!==this.current[e]){this.current=r,this.gl.uniformMatrix2fv(this.location,!1,r);break}}}function od(e){return[Wu(255*e.r,255*e.g),Wu(255*e.b,255*e.a)]}function sd(e,t,r,o,s,l,c,h){return!!e&&("composite"===e.kind||"source"===e.kind?"none"===e.evaluate(new Ja(0,{brightness:l,worldview:h}),t,r,s,o,c):"none"===e.value)}class lu{constructor(e,t,r,o){this.value=e,this.uniformNames=t.map((e=>`u_${e}`)),this.type=r,this.context=o}setUniform(e,t,r,o,s){const l=o.constantOr(this.value);t.set(e,s,l instanceof ur?l.toPremultipliedRenderColor(this.lutExpression&&"constant"===this.lutExpression.kind&&"none"===this.lutExpression.value?null:this.context.lut):l)}getBinding(e,t){return"color"===this.type?new tu(e):new Yl(e)}}class uu{constructor(e,t){this.uniformNames=t.map((e=>`u_${e}`)),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,t){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=t?t.tl.concat(t.br):this.pattern}setUniform(e,t,r,o,s){let l=null;"u_pattern"!==s&&"u_dash"!==s||(l=this.pattern),"u_pattern_b"===s&&(l=this.patternTransition),"u_pixel_ratio"===s&&(l=this.pixelRatio),l&&t.set(e,s,l)}getBinding(e,t){return"u_pattern"===t||"u_pattern_b"===t||"u_dash"===t?new Ql(e):new Yl(e)}}class cu{constructor(e,t,r,o){this.expression=e,this.type=r,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===r?2:1,offset:0}))),this.paintVertexArray=new o}populatePaintArray(e,t,r,o,s,l,c,h){const u=this.paintVertexArray.length,d="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Ja(0,{brightness:l,worldview:h}),t,{},s,o,c):"constant"===this.expression.kind&&this.expression.value,p=sd(this.lutExpression,t,{},o,s,l,c,h);this.paintVertexArray.resize(e),this._setPaintValue(u,e,d,p?null:this.context.lut)}updatePaintArray(e,t,r,o,s,l,c,h){const u="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:c,worldview:h},r,o,void 0,s):"constant"===this.expression.kind&&this.expression.value,d=sd(this.lutExpression,r,o,s,void 0,c,void 0,h);this._setPaintValue(e,t,u,d?null:this.context.lut)}_setPaintValue(e,t,r,o){if("color"===this.type){const s=od(r.toPremultipliedRenderColor(o));for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,s[0],s[1])}else{for(let o=e;o<t;o++)this.paintVertexArray.emplace(o,r);this.maxValue=Math.max(this.maxValue,Math.abs(r))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class hu{constructor(e,t,r,o,s,l){this.expression=e,this.uniformNames=t.map((e=>`u_${e}_t`)),this.type=r,this.useIntegerZoom=o,this.context=s,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===r?4:2,offset:0}))),this.paintVertexArray=new l}populatePaintArray(e,t,r,o,s,l,c,h){const u=this.expression.evaluate(new Ja(this.context.zoom,{brightness:l,worldview:h}),t,{},s,o,c),d=this.expression.evaluate(new Ja(this.context.zoom+1,{brightness:l,worldview:h}),t,{},s,o,c),p=sd(this.lutExpression,t,{},o,s,l,c,h),f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(f,e,u,d,p?null:this.context.lut)}updatePaintArray(e,t,r,o,s,l,c,h){const u=this.expression.evaluate({zoom:this.context.zoom,brightness:c,worldview:h},r,o,void 0,s),d=this.expression.evaluate({zoom:this.context.zoom+1,brightness:c,worldview:h},r,o,void 0,s),p=sd(this.lutExpression,r,o,s,void 0,c,void 0,h);this._setPaintValue(e,t,u,d,p?null:this.context.lut)}_setPaintValue(e,t,r,o,s){if("color"===this.type){const l=od(r.toPremultipliedRenderColor(s)),c=od(o.toPremultipliedRenderColor(s));for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,l[0],l[1],c[0],c[1])}else{for(let s=e;s<t;s++)this.paintVertexArray.emplace(s,r,o);this.maxValue=Math.max(this.maxValue,Math.abs(r),Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,t,r,o,s){const l=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,c=ct(this.expression.interpolationFactor(l,this.context.zoom,this.context.zoom+1),0,1);t.set(e,s,c)}getBinding(e,t){return new Yl(e)}}class pu{constructor(e,t,r,o,s){this.expression=e,this.layerId=s,this.paintVertexAttributes=("array"===r?Yu:Zu).members;for(let e=0;e<t.length;++e);this.paintVertexArray=new o,this.paintTransitionVertexArray=new Jo}populatePaintArray(e,t,r,o){const s=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(s,e,t.patterns&&t.patterns[this.layerId],r)}updatePaintArray(e,t,r,o,s,l,c){this._setPaintValues(e,t,r.patterns&&r.patterns[this.layerId],l)}_setPaintValues(e,t,r,o){if(!o||!r)return;const s=o[r[0]],l=o[r[1]];if(s){if(s){const{tl:r,br:o,pixelRatio:l}=s;for(let s=e;s<t;s++)this.paintVertexArray.emplace(s,r[0],r[1],o[0],o[1],l)}if(l){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:r,br:o}=l;for(let s=e;s<t;s++)this.paintTransitionVertexArray.emplace(s,r[0],r[1],o[0],o[1])}}}upload(e){const t=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,t)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,Xu.members,t))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class du{constructor(e,t,r=()=>!0){this.binders={},this._buffers=[],this.context=t;const o=[];for(const s in e.paint._values){const l=e.paint.get(s);if(s.endsWith("-use-theme"))continue;if(!r(s))continue;if(!(l instanceof io&&zc(l.property.specification)))continue;const c=ld(s,e.type),h=l.value,u=l.property.specification.type,d=!!l.property.useIntegerZoom,p="line-dasharray"===s||s.endsWith("pattern"),f=e.paint.get(`${s}-use-theme`),m="line-dasharray"===s&&"constant"!==e.layout.get("line-cap").value.kind||f&&"constant"!==f.value.kind;if("constant"!==h.kind||m)if("source"===h.kind||m||p){const t=ud(s,u,"source");this.binders[s]=p?new pu(h,c,u,t,e.id):new cu(h,c,u,t),o.push(`/a_${s}`)}else{const e=ud(s,u,"composite");this.binders[s]=new hu(h,c,u,d,t,e),o.push(`/z_${s}`)}else this.binders[s]=p?new uu(h.value,c):new lu(h.value,c,u,t),o.push(`/u_${s}`);f&&(this.binders[s].lutExpression=f.value)}this.cacheKey=o.sort().join("")}getMaxValue(e){const t=this.binders[e];return t instanceof cu||t instanceof hu?t.maxValue:0}populatePaintArrays(e,t,r,o,s,l,c,h){for(const u in this.binders){const d=this.binders[u];d.context=this.context,(d instanceof cu||d instanceof hu||d instanceof pu)&&d.populatePaintArray(e,t,r,o,s,l,c,h)}}setConstantPatternPositions(e,t){for(const r in this.binders){const o=this.binders[r];o instanceof uu&&o.setConstantPatternPositions(e,t)}}getPatternTransitionVertexBuffer(e){const t=this.binders[e];return t instanceof pu?t.paintTransitionVertexBuffer:null}updatePaintArrays(e,t,r,o,s,l,c,h,u,d){let p=!1;const f=Object.keys(e),m=0!==f.length&&!h,_=m?f:t.uniqueIds;this.context.lut=s.lut;for(const h in this.binders){const f=this.binders[h];if(f.context=this.context,(f instanceof cu||f instanceof hu||f instanceof pu)&&f.expression&&f.expression.kind&&"constant"!==f.expression.kind&&(!0===f.expression.isStateDependent||!1===f.expression.isLightConstant)){const v=s.paint.get(h);f.expression=v.value;for(const r of _){const s=e[r.toString()];t.eachPosition(r,((e,t,r)=>{const h=o.feature(e);f.updatePaintArray(t,r,h,s,l,c,u,d)}))}if(!m)for(const t of r.uniqueIds){const s=e[t.toString()];r.eachPosition(t,((e,t,r)=>{const h=o.feature(e);f.updatePaintArray(t,r,h,s,l,c,u,d)}))}p=!0}}return p}defines(){const e=[];for(const t in this.binders){const r=this.binders[t];(r instanceof lu||r instanceof uu)&&e.push(...r.uniformNames.map((e=>`#define HAS_UNIFORM_${e}`)))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const t=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof lu||o instanceof uu||o instanceof hu)for(const s of o.uniformNames)t.push({name:s,property:r,binding:o.getBinding(e,s)})}return t}setUniforms(e,t,r,o,s){for(const{name:t,property:l,binding:c}of r)this.binders[l].setUniform(e,c,s,o.get(l),t)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const t=this.binders[e];(t instanceof cu||t instanceof hu||t instanceof pu)&&t.paintVertexBuffer&&this._buffers.push(t.paintVertexBuffer),t instanceof pu&&t.paintTransitionVertexBuffer&&this._buffers.push(t.paintTransitionVertexBuffer)}}upload(e){for(const t in this.binders){const r=this.binders[t];(r instanceof cu||r instanceof hu||r instanceof pu)&&r.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const t=this.binders[e];(t instanceof cu||t instanceof hu||t instanceof pu)&&t.destroy()}}}class fu{constructor(e,t,r=()=>!0){this.programConfigurations={};for(const o of e)this.programConfigurations[o.id]=new du(o,t,r);this.needsUpload=!1,this._featureMap=new $l,this._featureMapWithoutIds=new $l,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,t,r,o,s,l,c,h,u){for(const r in this.programConfigurations)this.programConfigurations[r].populatePaintArrays(e,t,o,s,l,c,h,u);void 0!==t.id?this._featureMap.add(t.id,r,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,r,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,t,r,o,s,l,c,h){for(const u of r)this.needsUpload=this.programConfigurations[u.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,t,u,o,s,l,c||0,h)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const t in this.programConfigurations)this.programConfigurations[t].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const ad={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function ld(e,t){return ad[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const cd={"line-pattern":{source:Yo,composite:Yo},"fill-pattern":{source:Yo,composite:Yo},"fill-extrusion-pattern":{source:Yo,composite:Yo},"line-dasharray":{source:Jo,composite:Jo}},hd={color:{source:yl,composite:el},number:{source:$o,composite:yl}};function ud(e,t,r){const o=cd[e];return o&&o[r]||hd[t][r]}ih(lu,"ConstantBinder"),ih(uu,"PatternConstantBinder"),ih(cu,"SourceExpressionBinder"),ih(pu,"PatternCompositeBinder"),ih(hu,"CompositeExpressionBinder"),ih(du,"ProgramConfiguration",{omit:["_buffers"]}),ih(fu,"ProgramConfigurationSet");const dd=Ao/Math.PI/2,pd=64,fd=[pd,32,16],md=-dd,_d=dd;function gd(e,t,r,o=dd){return r=it(r),[e*Math.sin(r)*o,-t*o,e*Math.cos(r)*o]}function yd(e,t,r){return gd(Math.cos(it(e)),Math.sin(it(e)),t,r)}const bd=6371008.8,wd=2*Math.PI*bd;class Bu{constructor(e,t){if(isNaN(e)||isNaN(t))throw new Error(`Invalid LngLat object: (${e}, ${t})`);if(this.lng=+e,this.lat=+t,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Bu(mt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const t=Math.PI/180,r=this.lat*t,o=e.lat*t,s=Math.sin(r)*Math.sin(o)+Math.cos(r)*Math.cos(o)*Math.cos((e.lng-this.lng)*t);return bd*Math.acos(Math.min(s,1))}toBounds(e=0){const t=360*e/40075017,r=t/Math.cos(Math.PI/180*this.lat);return new ku({lng:this.lng-r,lat:this.lat-t},{lng:this.lng+r,lat:this.lat+t})}toEcef(e){return yd(this.lat,this.lng,dd+e*dd/bd)}static convert(e){if(e instanceof Bu)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new Bu(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new Bu(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class ku{constructor(e,t){e&&(t?this.setSouthWest(e).setNorthEast(t):Array.isArray(e)&&4===e.length?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Bu?new Bu(e.lng,e.lat):Bu.convert(e),this}setSouthWest(e){return this._sw=e instanceof Bu?new Bu(e.lng,e.lat):Bu.convert(e),this}extend(e){const t=this._sw,r=this._ne;let o,s;if(e instanceof Bu)o=e,s=e;else{if(!(e instanceof ku))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(ku.convert(e)):this.extend(Bu.convert(e)):"object"==typeof e&&null!==e&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Bu.convert(e)):this;if(o=e._sw,s=e._ne,!o||!s)return this}return t||r?(t.lng=Math.min(o.lng,t.lng),t.lat=Math.min(o.lat,t.lat),r.lng=Math.max(s.lng,r.lng),r.lat=Math.max(s.lat,r.lat)):(this._sw=new Bu(o.lng,o.lat),this._ne=new Bu(s.lng,s.lat)),this}getCenter(){return new Bu((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Bu(this.getWest(),this.getNorth())}getSouthEast(){return new Bu(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:t,lat:r}=Bu.convert(e);let o=this._sw.lng<=t&&t<=this._ne.lng;return this._sw.lng>this._ne.lng&&(o=this._sw.lng>=t&&t>=this._ne.lng),this._sw.lat<=r&&r<=this._ne.lat&&o}static convert(e){if(e)return e instanceof ku?e:new ku(e)}}function Td(e){return wd*Math.cos(e*Math.PI/180)}function Id(e){return(180+e)/360}function Ed(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function Ad(e,t){return e/Td(t)}function Pd(e){return 360*e-180}function Cd(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function Rd(e,t){return e*Td(Cd(t))}const zd=85.051129;function Dd(e){return Math.cos(it(ct(e,-85.051129,zd)))}function Ld(e,t){const r=ct(t,0,25.5),o=Math.pow(2,r);return Dd(e)*wd/(512*o)}function Od(e){return 1/Math.cos(e*Math.PI/180)}function Fd(e,t=0){const r=Math.exp(Math.PI*(1-(e.y+t/Ao)/(1<<e.z)*2));return 80150034*r/(r*r+1)/Ao/(1<<e.z)}class Gu{constructor(e,t,r=0){this.x=+e,this.y=+t,this.z=+r}static fromLngLat(e,t=0){const r=Bu.convert(e);return new Gu(Id(r.lng),Ed(r.lat),Ad(t,r.lat))}toLngLat(){return new Bu(Pd(this.x),Cd(this.y))}toAltitude(){return Rd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/wd*Od(Cd(this.y))}}function Bd(e,t,r,o,s,l,c,h,u){const d=(t+o)/2,p=(r+s)/2,f=new Je(d,p);h(f),function(e,t,r,o,s,l){const c=r-s,h=o-l;return Math.abs((o-t)*c-(r-e)*h)/Math.hypot(c,h)}(f.x,f.y,l.x,l.y,c.x,c.y)>=u?(Bd(e,t,r,d,p,l,f,h,u),Bd(e,d,p,o,s,f,c,h,u)):e.push(c)}function kd(e,t,r){let o=e[0],s=o.x,l=o.y;t(o);const c=[o];for(let h=1;h<e.length;h++){const u=e[h],{x:d,y:p}=u;t(u),Bd(c,s,l,d,p,o,u,t,r),s=d,l=p,o=u}return c}function Vd(e,t,r,o){if(o(t,r)){const s=t.add(r)._mult(.5);Vd(e,t,s,o),Vd(e,s,r,o)}else e.push(r)}function Nd(e,t){let r=e[0];const o=[r];for(let s=1;s<e.length;s++){const l=e[s];Vd(o,r,l,t),r=l}return o}const Ud=Math.pow(2,14)-1,jd=-Ud-1;function Gd(e,t){const r=Math.round(e.x*t),o=Math.round(e.y*t);return e.x=ct(r,jd,Ud),e.y=ct(o,jd,Ud),(r<e.x||r>e.x+1||o<e.y||o>e.y+1)&&Et("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function $d(e,t,r){const o=e.loadGeometry(),s=e.extent,l=Ao/s;if(t&&r&&r.projection.isReprojectedInTileSpace){const l=1<<t.z,{scale:c,x:h,y:u,projection:d}=r,p=e=>{const r=Pd((t.x+e.x/s)/l),o=Cd((t.y+e.y/s)/l),p=d.project(r,o);e.x=(p.x*c-h)*s,e.y=(p.y*c-u)*s};for(let t=0;t<o.length;t++)if(1!==e.type)o[t]=kd(o[t],p,1);else{const e=[];for(const r of o[t])r.x<0||r.x>=s||r.y<0||r.y>=s||(p(r),e.push(r));o[t]=e}}for(const e of o)for(const t of e)Gd(t,l);return o}function qd(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?$d(e):[]}}class Qu{constructor(e,t,r,o,s){this.properties={},this.extent=r,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=o,this._values=s,e.readFields(Hd,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,r=[];let o,s=1,l=0,c=0,h=0;for(;e.pos<t;){if(l<=0){const t=e.readVarint();s=7&t,l=t>>3}if(l--,1===s||2===s)c+=e.readSVarint(),h+=e.readSVarint(),1===s&&(o&&r.push(o),o=[]),o&&o.push(new Je(c,h));else{if(7!==s)throw new Error(`unknown command ${s}`);o&&o.push(o[0].clone())}}return o&&r.push(o),r}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let r=1,o=0,s=0,l=0,c=1/0,h=-1/0,u=1/0,d=-1/0;for(;e.pos<t;){if(o<=0){const t=e.readVarint();r=7&t,o=t>>3}if(o--,1===r||2===r)s+=e.readSVarint(),l+=e.readSVarint(),s<c&&(c=s),s>h&&(h=s),l<u&&(u=l),l>d&&(d=l);else if(7!==r)throw new Error(`unknown command ${r}`)}return[c,u,h,d]}toGeoJSON(e,t,r){const o=this.extent*Math.pow(2,r),s=this.extent*e,l=this.extent*t,c=this.loadGeometry();function h(e){return[360*(e.x+s)/o-180,360/Math.PI*Math.atan(Math.exp((1-2*(e.y+l)/o)*Math.PI))-90]}function u(e){return e.map(h)}let d;if(1===this.type){const e=[];for(const t of c)e.push(t[0]);const t=u(e);d=1===e.length?{type:"Point",coordinates:t[0]}:{type:"MultiPoint",coordinates:t}}else if(2===this.type){const e=c.map(u);d=1===e.length?{type:"LineString",coordinates:e[0]}:{type:"MultiLineString",coordinates:e}}else{if(3!==this.type)throw new Error("unknown feature type");{const e=function(e){const t=e.length;if(t<=1)return[e];const r=[];let o,s;for(let l=0;l<t;l++){const t=Wd(e[l]);0!==t&&(void 0===s&&(s=t<0),s===t<0?(o&&r.push(o),o=[e[l]]):o&&o.push(e[l]))}return o&&r.push(o),r}(c),t=[];for(const r of e)t.push(r.map(u));d=1===t.length?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}}const p={type:"Feature",geometry:d,properties:this.properties};return null!=this.id&&(p.id=this.id),p}}function Hd(e,t,r){1===e?t.id=r.readVarint():2===e?function(e,t){const r=e.readVarint()+e.pos;for(;e.pos<r;){const r=t._keys[e.readVarint()],o=t._values[e.readVarint()];t.properties[r]=o}}(r,t):3===e?t.type=r.readVarint():4===e&&(t._geometry=r.pos)}function Wd(e){let t=0;for(let r,o,s=0,l=e.length,c=l-1;s<l;c=s++)r=e[s],o=e[c],t+=(o.x-r.x)*(r.y+o.y);return t}Qu.types=["Unknown","Point","LineString","Polygon"];class rc{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Zd,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new Qu(this._pbf,t,this.extent,this._keys,this._values)}}function Zd(e,t,r){15===e?t.version=r.readVarint():1===e?t.name=r.readString():5===e?t.extent=r.readVarint():2===e?t._features.push(r.pos):3===e?t._keys.push(r.readString()):4===e&&t._values.push(function(e){let t=null;const r=e.readVarint()+e.pos;for(;e.pos<r;){const r=e.readVarint()>>3;t=1===r?e.readString():2===r?e.readFloat():3===r?e.readDouble():4===r?e.readVarint64():5===r?e.readVarint():6===r?e.readSVarint():7===r?e.readBoolean():null}if(null==t)throw new Error("unknown feature value");return t}(r))}class ic{constructor(e,t){this.layers=e.readFields(Xd,{},t)}}function Xd(e,t,r){if(3===e){const e=new rc(r,r.readVarint()+r.pos);e.length&&(t[e.name]=e)}}const Yd="3d_elevation_id",Jd="level";class lc{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(e,t){return this._valid&&e(t(this._geometry)),this}require(e,t,r){return this.get(e,!0,t,r)}optional(e,t,r){return this.get(e,!1,t,r)}success(){return this._valid}get(e,t,r,o){const s=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&void 0!==s&&!Number.isNaN(s)?r(o?o(s):s):t&&(this._valid=!1),this}}class uc{constructor(e,t){this.featureFunc=e,this.vertexFunc=t}parseFeature(e,t,r){return this.featureFunc(e,t,r)}parseVertex(e,t,r){return this.vertexFunc(e,t,r)}}const Qd=new uc(((e,t,r)=>e.reset(t).require(Yd,(e=>{r.id=e})).optional("fixed_height_relative",(e=>{r.constantHeight=e}),pc.decodeRelativeHeight).geometry((e=>{r.bounds=e}),kn).success()),((e,t,r)=>e.reset(t).require(Yd,(e=>{r.id=e})).require("elevation_idx",(e=>{r.idx=e})).require("extent",(e=>{r.extent=e})).require("height_relative",(e=>{r.height=e}),pc.decodeRelativeHeight).geometry((e=>{r.position=e}),pc.getPoint).success())),Kd=new uc(((e,t,r)=>e.reset(t).require(Yd,(e=>{r.id=e})).optional("fixed_height",(e=>{r.constantHeight=e}),pc.decodeMetricHeight).geometry((e=>{r.bounds=e}),kn).success()),((e,t,r)=>e.reset(t).require(Yd,(e=>{r.id=e})).require("elevation_idx",(e=>{r.idx=e})).require("extent",(e=>{r.extent=e})).require("height",(e=>{r.height=e}),pc.decodeMetricHeight).geometry((e=>{r.position=e}),pc.getPoint).success()));class pc{static getPoint(e){return De(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?"1.0.1"===e?Kd:void 0:Qd}static parse(e){const t=[],r=[],o=e.length,s=new lc;for(let l=0;l<o;l++){const o=e.feature(l),c=o.properties.version,h=pc.getVersionSchema(c);if(void 0===h){Et(`Unknown elevation feature version number ${c||"(unknown)"}`);continue}const u=o.properties.type;if(!u)continue;const d=Qu.types[o.type];if("Point"===d&&"curve_point"===u){const e={};h.parseVertex(s,o,e)&&t.push(e)}else if("Polygon"===d&&"curve_meta"===u){const e={};h.parseFeature(s,o,e)&&r.push(e)}}return{vertices:t,features:r}}}class dc{constructor(e,t){this.pos=e,this.dir=t}intersectsPlane(e,t,r){const o=Ge(t,this.dir);if(Math.abs(o)<1e-6)return!1;const s=((e[0]-this.pos[0])*t[0]+(e[1]-this.pos[1])*t[1])/o;return r[0]=this.pos[0]+this.dir[0]*s,r[1]=this.pos[1]+this.dir[1]*s,!0}}class fc{constructor(e,t){this.pos=e,this.dir=t}intersectsPlane(e,t,r){const o=re(t,this.dir);if(Math.abs(o)<1e-6)return!1;const s=((e[0]-this.pos[0])*t[0]+(e[1]-this.pos[1])*t[1]+(e[2]-this.pos[2])*t[2])/o;return r[0]=this.pos[0]+this.dir[0]*s,r[1]=this.pos[1]+this.dir[1]*s,r[2]=this.pos[2]+this.dir[2]*s,!0}closestPointOnSphere(e,t,o){if(function(e,t){var o=e[0],s=e[1],l=e[2],c=t[0],h=t[1],u=t[2];return Math.abs(o-c)<=r*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(s-h)<=r*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(l-u)<=r*Math.max(1,Math.abs(l),Math.abs(u))}(this.pos,e)||0===t)return o[0]=o[1]=o[2]=0,!1;const[s,l,c]=this.dir,h=this.pos[0]-e[0],u=this.pos[1]-e[1],d=this.pos[2]-e[2],p=s*s+l*l+c*c,f=2*(h*s+u*l+d*c),m=f*f-4*p*(h*h+u*u+d*d-t*t);if(m<0){const e=Math.max(-f/2,0),r=h+s*e,p=u+l*e,m=d+c*e,_=Math.hypot(r,p,m);return o[0]=r*t/_,o[1]=p*t/_,o[2]=m*t/_,!1}{const e=(-f-Math.sqrt(m))/(2*p);if(e<0){const e=Math.hypot(h,u,d);return o[0]=h*t/e,o[1]=u*t/e,o[2]=d*t/e,!1}return o[0]=h+s*e,o[1]=u+l*e,o[2]=d+c*e,!0}}}class mc{constructor(e,t,r,o,s){this.TL=e,this.TR=t,this.BR=r,this.BL=o,this.horizon=s}static fromInvProjectionMatrix(e,t,r){const o=[-1,1,1],s=[1,1,1],l=[1,-1,1],c=[-1,-1,1],h=se(o,o,e),u=se(s,s,e),d=se(l,l,e),p=se(c,c,e);return new mc(h,u,d,p,t/r)}}function ep(e,t,r){let o=1/0,s=-1/0;const l=[];for(const c of e){ue(l,c,t);const e=re(l,r);o=Math.min(o,e),s=Math.max(s,e)}return[o,s]}function tp(e,t){let r=!0;for(let o=0;o<e.planes.length;o++){const s=e.planes[o];let l=0;for(let e=0;e<t.length;e++)l+=+(re(s,t[e])+s[3]>=0);if(0===l)return 0;l!==t.length&&(r=!1)}return r?2:1}function ip(e,t){for(const r of e.projections){const o=ep(t,e.points[0],r.axis);if(r.projection[1]<o[0]||r.projection[0]>o[1])return 0}return 1}function rp(e,t){let r=0;const o=[0,0,0,0];for(let s=0;s<e.length;s++)o[0]=e[s][0],o[1]=e[s][1],o[2]=e[s][2],o[3]=1,ye(o,t)>=0&&r++;return r}class bc{constructor(e,t){this.points=e||new Array(8).fill([0,0,0]),this.planes=t||new Array(6).fill([0,0,0,0]),this.bounds=wc.fromPoints(this.points),this.projections=[],this.frustumEdges=[ue([],this.points[2],this.points[3]),ue([],this.points[0],this.points[3]),ue([],this.points[4],this.points[0]),ue([],this.points[5],this.points[1]),ue([],this.points[6],this.points[2]),ue([],this.points[7],this.points[3])];for(const e of this.frustumEdges){const t=[0,-e[2],e[1]],r=[e[2],0,-e[0]];this.projections.push({axis:t,projection:ep(this.points,this.points[0],t)}),this.projections.push({axis:r,projection:ep(this.points,this.points[0],r)})}}static fromInvProjectionMatrix(e,t,r,o){const s=Math.pow(2,r),l=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((r=>{const l=xe([],r,e),c=1/l[3]/t*s;return(h=l)[0]=(u=l)[0]*(d=[c,c,o?1/l[3]:c,c])[0],h[1]=u[1]*d[1],h[2]=u[2]*d[2],h[3]=u[3]*d[3],h;var h,u,d})),c=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((e=>{const t=ie([],ne([],ue([],l[e[0]],l[e[1]]),ue([],l[e[2]],l[e[1]]))),r=-re(t,l[e[1]]);return t.concat(r)})),h=[];for(let e=0;e<l.length;e++)h.push([l[e][0],l[e][1],l[e][2]]);return new bc(h,c)}intersectsPrecise(e,t,r){for(let r=0;r<t.length;r++)if(!rp(e,t[r]))return 0;for(let t=0;t<this.planes.length;t++)if(!rp(e,this.planes[t]))return 0;for(const t of r)for(const r of this.frustumEdges){const o=ne([],t,r),s=V(o);if(0===s)continue;Y(o,o,1/s);const l=ep(this.points,this.points[0],o),c=ep(e,this.points[0],o);if(l[0]>c[1]||c[0]>l[1])return 0}return 1}containsPoint(e){for(const t of this.planes){const r=t[3];if(re([t[0],t[1],t[2]],e)+r<0)return!1}return!0}}class wc{static fromPoints(e){const t=[1/0,1/0,1/0],r=[-1/0,-1/0,-1/0];for(const o of e)H(t,t,o),Z(r,r,o);return new wc(t,r)}static fromTileIdAndHeight(e,t,r){const o=1<<e.canonical.z,s=e.canonical.x,l=e.canonical.y;return new wc([s/o,l/o,t],[(s+1)/o,(l+1)/o,r])}static applyTransform(e,t){const r=e.getCorners();for(let e=0;e<r.length;++e)se(r[e],r[e],t);return wc.fromPoints(r)}static applyTransformFast(e,t){const r=[t[12],t[13],t[14]],o=[...r];for(let s=0;s<3;s++)for(let l=0;l<3;l++){const c=t[4*l+s],h=c*e.min[l],u=c*e.max[l];r[s]+=Math.min(h,u),o[s]+=Math.max(h,u)}return new wc(r,o)}static projectAabbCorners(e,t){const r=e.getCorners();for(let e=0;e<r.length;++e)se(r[e],r[e],t);return r}constructor(e,t){this.min=e,this.max=t,this.center=Y([],j([],this.min,this.max),.5)}quadrant(e){const t=[e%2==0,e<2],r=k(this.min),o=k(this.max);for(let e=0;e<t.length;e++)r[e]=t[e]?this.min[e]:this.center[e],o[e]=t[e]?this.center[e]:this.max[e];return o[2]=this.max[2],new wc(r,o)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,t=this.max;return[[e[0],e[1],e[2]],[t[0],e[1],e[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]],[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],t[2]],[e[0],t[1],t[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?tp(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?tp(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,t){return t||this.intersects(e)?ip(e,this.getCorners()):0}intersectsPreciseFlat(e,t){return t||this.intersectsFlat(e)?ip(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let t=0;t<3;++t)if(this.min[t]>e.max[t]||e.min[t]>this.max[t])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let t=0;t<3;t++)this.min[t]=Math.min(this.min[t],e.min[t]),this.max[t]=Math.max(this.max[t],e.max[t])}encapsulatePoint(e){for(let t=0;t<3;t++)this.min[t]=Math.min(this.min[t],e[t]),this.max[t]=Math.max(this.max[t],e[t])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}ih(wc,"Aabb");class _c{constructor(e,t){this.feature=e,this.metersToTile=t,this.index=0}get(){const e=this.feature.vertices[this.index],t=this.feature.vertexProps[this.index].dir,r=t[1],o=-t[0],s=(e.extent+1)*this.metersToTile;return[new Je(Math.trunc(e.position[0]+r*s),Math.trunc(e.position[1]+o*s)),new Je(Math.trunc(e.position[0]-r*s),Math.trunc(e.position[1]-o*s))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ac{constructor(e,t,r,o,s,l){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[ze(),ze(),ze(),ze(),ze(),ze(),ze()],this.id=e,this.heightRange={min:r,max:r},this.safeArea=t,this.constantHeight=r,null==this.constantHeight&&(null!=this.constantHeight||0!==o.length)){this.vertices=o,this.edges=s,this.edges=this.edges.filter((e=>{return e.a<this.vertices.length&&e.b<this.vertices.length&&!((t=this.vertices[e.a].position)[0]===(r=this.vertices[e.b].position)[0]&&t[1]===r[1]);var t,r})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const e of this.vertices)this.vertexProps.push({dir:De(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,e.height),this.heightRange.max=Math.max(this.heightRange.max,e.height);for(const e of this.edges){const t=this.vertices[e.a].position,r=this.vertices[e.b].position,o=Be(ze(),r,t),s=Ue(o),l=Ve(ze(),o,1/s);this.edgeProps.push({vec:o,dir:l,len:s});const c=this.vertexProps[e.a].dir,h=this.vertexProps[e.b].dir;Fe(c,c,l),Fe(h,h,l)}for(const e of this.vertexProps)0===e.dir[0]&&0===e.dir[1]||je(e.dir,e.dir);this.tessellate(l)}}pointElevation(e){if(null!=this.constantHeight)return this.constantHeight;const t=this.getClosestEdge(e);if(null==t)return 0;const[r,o]=t;return Ar(this.vertices[this.edges[r].a].height,this.vertices[this.edges[r].b].height,o)}computeSlopeNormal(e,t){const r=this.getClosestEdge(e);if(!r)return N(0,0,1);const o=r[0],s=this.edges[o],l=this.edgeProps[o].vec,c=N(l[0],l[1],(this.vertices[s.b].height-this.vertices[s.a].height)*t),h=N(c[1],-c[0],0);ne(h,h,c);const u=V(h);return u>0?Y(h,h,1/u):U(h,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(0===this.edges.length)return;let t=0,r=Number.POSITIVE_INFINITY,o=0;const[s,l,c,h,u,d,p]=this._tmpVec2;Oe(p,e.x,e.y);const f=new dc(p,null);for(let e=0;e<this.edges.length;e++){const m=this.edges[e],_=this.edgeProps[e].dir;f.dir=_;const v=this.vertices[m.a].position,E=this.vertices[m.b].position,P=f.intersectsPlane(v,this.vertexProps[m.a].dir,s),C=f.intersectsPlane(E,this.vertexProps[m.b].dir,l);if(!P||!C)continue;Be(c,l,s),Be(h,p,s);const R=Ge(c,c),z=R>0?Ge(h,c)/R:0,D=ct(z,0,1),O=Math.abs((z-D)*this.edgeProps[e].len);Be(u,p,v),Oe(d,_[1],-_[0]);const F=O+Math.abs(Ge(u,d));F<r&&(t=e,r=F,o=D)}return[t,o]}tessellate(e){const t=B(),r=B(),o=B(),s=B();for(let l=this.edges.length-1;l>=0;--l){const c=this.edges[l].a,h=this.edges[l].b,{position:u,height:d,extent:p}=this.vertices[c],{position:f,height:m,extent:_}=this.vertices[h],v=this.vertexProps[c].dir,E=this.vertexProps[h].dir;if(U(t,u[0]/e,u[1]/e,d),U(r,f[0]/e,f[1]/e,m),U(o,v[1],-v[0],0),Y(o,o,p),U(s,E[1],-E[0],0),Y(s,s,_),this.distSqLines(N(t[0]+.5*o[0],t[1]+.5*o[1],t[2]+.5*o[2]),N(r[0]-.5*s[0],r[1]-.5*s[1],r[2]-.5*s[2]),N(t[0]-.5*o[0],t[1]-.5*o[1],t[2]-.5*o[2]),N(r[0]+.5*s[0],r[1]+.5*s[1],r[2]+.5*s[2]))<=.0025000000000000005)continue;const P=this.vertices.length,C=Fe(ze(),u,f);this.vertices.push({position:Ve(C,C,.5),height:.5*(d+m),extent:.5*(p+_)});const R=Fe(ze(),v,E);this.vertexProps.push({dir:je(R,R)}),this.edges.splice(l,1),this.edgeProps.splice(l,1),this.edges.push({a:c,b:P}),this.edges.push({a:P,b:h});const z=Be(ze(),this.vertices[P].position,u),D=Ue(z),O={vec:z,dir:Ve(ze(),z,1/D),len:D};this.edgeProps.push(O),this.edgeProps.push(O)}}distSqLines(e,t,r,o){const s=$(B(),t,e),l=$(B(),o,r),c=$(B(),e,r),h=re(s,s),u=re(s,l),d=re(s,c),p=re(l,l),f=re(l,c),m=h*p-u*u;if(0===m)return K(oe(s,r,o,re(c,l)/re(l,l)),e);const _=(h*f-u*d)/m;return K(oe(s,e,t,(u*f-d*p)/m),oe(l,r,o,_))}}class Mc{static parseFrom(e,t){const r=pc.parse(e);if(!r)return[];let{vertices:o,features:s}=r;const l=1/Fd(t);s.sort(((e,t)=>e.id-t.id)),o.sort(((e,t)=>e.id-t.id||e.idx-t.idx)),o=o.filter(((e,t,r)=>t===r.findIndex((t=>t.id===e.id&&t.idx===e.idx))));const c=new Array;let h=0;const u=o.length;for(const e of s){if(e.constantHeight){c.push(new Ac(e.id,e.bounds,e.constantHeight));continue}for(;h!==u&&o[h].id<e.id;)h++;if(h===u||o[h].id!==e.id)continue;const t=new Array,r=new Array,s=h;for(;h!==u&&o[h].id===e.id;){const e=o[h];if(t.push({position:e.position,height:e.height,extent:e.extent}),h!==s&&o[h-1].idx===e.idx-1){const e=h-s;r.push({a:e-1,b:e})}h++}c.push(new Ac(e.id,e.bounds,void 0,t,r,l))}return c}static getElevationFeature(e,t){if(!t)return;const r=+e.properties[Yd];return Number.isNaN(r)?void 0:t.find((e=>e.id===r))}}class Ic{constructor(e,t){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(t)||(this.zScale=Math.pow(2,t.z-e.z),this.xOffset=(e.x*this.zScale-t.x)*Ao,this.yOffset=(e.y*this.zScale-t.y)*Ao)}constantElevation(e,t){if(null!=e.constantHeight)return this.computeBiasedHeight(e.constantHeight,t)}pointElevation(e,t,r){const o=this.constantElevation(t,r);return null!=o?o:(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(t.pointElevation(e),r))}computeBiasedHeight(e,t){return t<=0?e:e+t*ft(0,t,e>=0?e:Math.abs(.5*e))}}ih(Ac,"ElevationFeature");class Sc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new No,this.indexArray=new ll,this.segments=new Ol,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,"none"!==this.elevationMode&&(this.elevatedLayoutVertexArray=new $o),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,r,o){}populate(e,t,r,o){const s=this.layers[0],l=[];let c=null;"circle"===s.type&&(c=s.layout.get("circle-sort-key"));for(const{feature:s,id:h,index:u,sourceLayerIndex:d}of e){const e=this.layers[0]._featureFilter.needGeometry,p=qd(s,e);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),p,r))continue;const f=c?c.evaluate(p,{},r):void 0,m={id:h,properties:s.properties,type:s.type,sourceLayerIndex:d,index:u,geometry:e?p.geometry:$d(s,r,o),patterns:{},sortKey:f};l.push(m)}c&&l.sort(((e,t)=>e.sortKey-t.sortKey));let h=null;"globe"===o.projection.name&&(this.globeExtVertexArray=new Ko,h=o.projection);for(const o of l){const{geometry:s,index:l,sourceLayerIndex:c}=o,u=e[l].feature;this.addFeature(o,s,l,t.availableImages,r,h,t.brightness,t.elevationFeatures),t.featureIndex.insert(u,s,l,c,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,t,r,o,s,l,c){this.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,$u.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Hu.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,qu.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,t,r,o,s,l,c,h){let u;"none"!==this.elevationMode&&(u=Mc.getElevationFeature(e,h));for(const r of t)for(const t of r){const r=t.x,o=t.y;if(r<0||r>=Ao||o<0||o>=Ao)continue;if(l){const e=l.projectTilePoint(r,o,s),t=l.upVector(s,r,o);this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t)}const c=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),h=c.vertexLength;if(this.addCircleVertex(r,o,-1,-1),this.addCircleVertex(r,o,1,-1),this.addCircleVertex(r,o,1,1),this.addCircleVertex(r,o,-1,1),"none"!==this.elevationMode){const e=u?u.pointElevation(new Je(r,o)):0;this.hasElevation=this.hasElevation||0!==e;for(let t=0;t<4;t++)this.elevatedLayoutVertexArray.emplaceBack(e)}this.indexArray.emplaceBack(h,h+1,h+2),this.indexArray.emplaceBack(h,h+2,h+3),c.vertexLength+=4,c.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,{},o,s,c,void 0,this.worldview)}addCircleVertex(e,t,r,o){this.layoutVertexArray.emplaceBack(2*e+(r+1)/2,2*t+(o+1)/2)}addGlobeExtVertex(e,t){const r=16384;this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,t[0]*r,t[1]*r,t[2]*r)}}function np(e,t){for(let r=0;r<e.length;r++)if(mp(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(mp(e,t[r]))return!0;return!!lp(e,t)}function op(e,t,r){return!!mp(e,t)||!!dp(t,e,r)}function sp(e,t){if(1===e.length)return fp(t,e[0]);for(let r=0;r<t.length;r++){const o=t[r];for(let t=0;t<o.length;t++)if(mp(e,o[t]))return!0}for(let r=0;r<e.length;r++)if(fp(t,e[r]))return!0;for(let r=0;r<t.length;r++)if(lp(e,t[r]))return!0;return!1}function ap(e,t,r){if(e.length>1){if(lp(e,t))return!0;for(let o=0;o<t.length;o++)if(dp(t[o],e,r))return!0}for(let o=0;o<e.length;o++)if(dp(e[o],t,r))return!0;return!1}function lp(e,t){if(0===e.length||0===t.length)return!1;for(let r=0;r<e.length-1;r++){const o=e[r],s=e[r+1];for(let e=0;e<t.length-1;e++)if(cp(o,s,t[e],t[e+1]))return!0}return!1}function cp(e,t,r,o){return At(e,r,o)!==At(t,r,o)&&At(e,t,r)!==At(e,t,o)}function hp(e,t,r){return(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x)}function up(e,t,r,o){const s=hp(e,t,o),l=hp(e,t,r);if(Math.sign(s)===Math.sign(l))return;const c=hp(r,o,e),h=c+l-s;return Math.sign(c)!==Math.sign(h)?[c/(c-h),l/(l-s)]:void 0}function dp(e,t,r){const o=r*r;if(1===t.length)return e.distSqr(t[0])<o;for(let r=1;r<t.length;r++)if(pp(e,t[r-1],t[r])<o)return!0;return!1}function pp(e,t,r){const o=t.distSqr(r);if(0===o)return e.distSqr(t);const s=((e.x-t.x)*(r.x-t.x)+(e.y-t.y)*(r.y-t.y))/o;return e.distSqr(s<0?t:s>1?r:r.sub(t)._mult(s)._add(t))}function fp(e,t){let r,o,s,l=!1;for(let c=0;c<e.length;c++){r=e[c];for(let e=0,c=r.length-1;e<r.length;c=e++)o=r[e],s=r[c],o.y>t.y!=s.y>t.y&&t.x<(s.x-o.x)*(t.y-o.y)/(s.y-o.y)+o.x&&(l=!l)}return l}function mp(e,t){let r=!1;for(let o=0,s=e.length-1;o<e.length;s=o++){const l=e[o],c=e[s];l.y>t.y!=c.y>t.y&&t.x<(c.x-l.x)*(t.y-l.y)/(c.y-l.y)+l.x&&(r=!r)}return r}function _p(e,t,r,o,s){for(const l of e)if(t<=l.x&&r<=l.y&&o>=l.x&&s>=l.y)return!0;const l=[new Je(t,r),new Je(t,s),new Je(o,s),new Je(o,r)];if(e.length>2)for(const t of l)if(mp(e,t))return!0;for(let t=0;t<e.length-1;t++)if(gp(e[t],e[t+1],l))return!0;return!1}function gp(e,t,r){const o=r[0],s=r[2];if(e.x<o.x&&t.x<o.x||e.x>s.x&&t.x>s.x||e.y<o.y&&t.y<o.y||e.y>s.y&&t.y>s.y)return!1;const l=At(e,t,r[0]);return l!==At(e,t,r[1])||l!==At(e,t,r[2])||l!==At(e,t,r[3])}function yp(e,t,r,o,s,l){let c=t.y-e.y,h=e.x-t.x;if(l=l||0){const e=c*c+h*h;if(0===e)return!0;const t=Math.sqrt(e);c/=t,h/=t}return!((r.x-e.x)*c+(r.y-e.y)*h-l<0||(o.x-e.x)*c+(o.y-e.y)*h-l<0||(s.x-e.x)*c+(s.y-e.y)*h-l<0)}function xp(e,t,r,o,s,l,c){return!(yp(e,t,o,s,l,c)||yp(t,r,o,s,l,c)||yp(r,e,o,s,l,c)||yp(o,s,e,t,r,c)||yp(s,l,e,t,r,c)||yp(l,o,e,t,r,c))}function vp(e,t,r){const o=t.paint.get(e).value;return"constant"===o.kind?o.value:r.programConfigurations.get(t.id).getMaxValue(e)}function bp(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function wp(e,t,r,o,s){if(!t[0]&&!t[1])return e;const l=Je.convert(t)._mult(s);"viewport"===r&&l._rotate(-o);const c=[];for(let t=0;t<e.length;t++)c.push(e[t].sub(l));return c}function Sp(e,t,r,o){const s=Je.convert(e)._mult(o);return"viewport"===t&&s._rotate(-r),s}let Ip,Ep;function Ap(e,t,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[e*o-2*Math.PI*6378137/2,t*o-2*Math.PI*6378137/2]}ih(Sc,"CircleBucket",{omit:["layers"]});class Yc{constructor(e,t,r){this.z=e,this.x=t,this.y=r,this.key=Mp(0,e,e,t,r)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const t=this.z-e.z;return 0===e.z||e.z<this.z&&e.x===this.x>>t&&e.y===this.y>>t}url(e,t){const r=function(e,t,r){var o=Ap(256*e,256*(t=Math.pow(2,r)-t-1),r),s=Ap(256*(e+1),256*(t+1),r);return o[0]+","+o[1]+","+s[0]+","+s[1]}(this.x,this.y,this.z),o=function(e,t,r){let o,s="";for(let l=e;l>0;l--)o=1<<l-1,s+=(t&o?1:0)+(r&o?2:0);return s}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===t?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",o).replace("{bbox-epsg-3857}",r)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Jc{constructor(e,t){this.wrap=e,this.canonical=t,this.key=Mp(e,t.z,t.z,t.x,t.y)}}class Kc{constructor(e,t,r,o,s){this.overscaledZ=e,this.wrap=t,this.canonical=new Yc(r,+o,+s),this.key=0===t&&e===r?this.canonical.key:Mp(t,e,r,o,s)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const t=this.canonical.z-e;return e>this.canonical.z?new Kc(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Kc(e,this.wrap,e,this.canonical.x>>t,this.canonical.y>>t)}calculateScaledKey(e,t=!0){if(this.overscaledZ===e&&t)return this.key;if(e>this.canonical.z)return Mp(this.wrap*+t,e,this.canonical.z,this.canonical.x,this.canonical.y);{const r=this.canonical.z-e;return Mp(this.wrap*+t,e,e,this.canonical.x>>r,this.canonical.y>>r)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const t=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>t&&e.canonical.y===this.canonical.y>>t}children(e){if(this.overscaledZ>=e)return[new Kc(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const t=this.canonical.z+1,r=2*this.canonical.x,o=2*this.canonical.y;return[new Kc(t,this.wrap,t,r,o),new Kc(t,this.wrap,t,r+1,o),new Kc(t,this.wrap,t,r,o+1),new Kc(t,this.wrap,t,r+1,o+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Kc(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Kc(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Jc(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Mp(e,t,r,o,s){const l=1<<Math.min(r,22);let c=l*(s%l)+o%l;return e&&r<22&&(c+=l*l*((e<0?-2*e-1:2*e)%(1<<2*(22-r)))),16*(32*c+r)+(t-r)}const Pp=[e=>{let t=e.canonical.x-1,r=e.wrap;return t<0&&(t=(1<<e.canonical.z)-1,r--),new Kc(e.overscaledZ,r,e.canonical.z,t,e.canonical.y)},e=>{let t=e.canonical.x+1,r=e.wrap;return t===1<<e.canonical.z&&(t=0,r++),new Kc(e.overscaledZ,r,e.canonical.z,t,e.canonical.y)},e=>new Kc(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new Kc(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)];ih(Yc,"CanonicalTileID"),ih(Kc,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Cp=Uu([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Rp}=Cp,zp=Uu([{name:"a_pos_3",components:3,type:"Int16"}]);var Dp=Uu([{name:"a_pos",type:"Int16",components:2}]);function Lp(e){return e*dd/bd}const Op=[new wc([md,md,md],[_d,_d,_d]),new wc([md,md,md],[0,0,_d]),new wc([0,md,md],[_d,0,_d]),new wc([md,0,md],[0,_d,_d]),new wc([0,0,md],[_d,_d,_d])];function Bp(e,t,r,o=!0){const s=Y([],e._camera.position,e.worldSize),l=[t,r,1,1];xe(l,l,e.pixelMatrixInverse),me(l,l,1/l[3]);const c=ie([],ue([],l,s)),h=e.globeMatrix,u=[h[12],h[13],h[14]],d=ue([],u,s),p=V(d),f=ie([],d),m=e.worldSize/(2*Math.PI),_=re(f,c),v=Math.asin(m/p);if(v<Math.acos(_)){if(!o)return null;const e=[],t=[];Y(e,c,p/_),ie(t,ue(t,e,d)),ie(c,j(c,d,Y(c,t,Math.tan(v)*p)))}const E=[];new fc(s,c).closestPointOnSphere(u,m,E);const P=ie([],kt(h,0)),C=ie([],kt(h,1)),R=ie([],kt(h,2)),z=re(P,E),D=re(C,E),O=re(R,E),F=rt(Math.asin(-D/m));let B=rt(Math.atan2(z,O));B=e.center.lng+function(e,t){const r=(t-e+180)%360-180;return r<-180?r+360:r}(e.center.lng,B);const k=Id(B),N=ct(Ed(F),0,1);return new Gu(k,N)}class lh{constructor(e,t,r){this.a=ue([],e,r),this.b=ue([],t,r),this.center=r;const o=ie([],this.a),s=ie([],this.b);this.angle=Math.acos(re(o,s))}}function Np(e,t){if(0===e.angle)return null;let r;return r=0===e.a[t]?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),r<0||r>1?null:function(e,t,r,o){const s=Math.sin(r);return e*(Math.sin((1-o)*r)/s)+t*(Math.sin(o*r)/s)}(e.a[t],e.b[t],e.angle,ct(r,0,1))+e.center[t]}function Up(e){if(e.z<=1)return Op[e.z+2*e.y+e.x];const t=Hp(qp(e));return wc.fromPoints(t)}function jp(e,t,r){return Y(e,e,1-r),J(e,e,t,r)}function Gp(e,t,r){for(const o of e)se(o,o,t),Y(o,o,r)}function $p(e,t,r,o){const s=t/e.worldSize,l=e.globeMatrix;if(r.z<=1){const e=Up(r).getCorners();return Gp(e,l,s),wc.fromPoints(e)}const c=qp(r,o),h=Hp(c,dd+Lp(e._tileCoverLift));Gp(h,l,s);const u=Number.MAX_VALUE,d=[-u,-u,-u],p=[u,u,u];if(c.contains(e.center)){for(const e of h)H(p,p,e),Z(d,d,e);d[2]=0;const t=e.point,r=[t.x*s,t.y*s,0];return H(p,p,r),Z(d,d,r),new wc(p,d)}if(e._tileCoverLift>0){for(const e of h)H(p,p,e),Z(d,d,e);return new wc(p,d)}const f=[l[12]*s,l[13]*s,l[14]*s],m=c.getCenter(),_=ct(e.center.lat,-85.051129,zd),v=ct(m.lat,-85.051129,zd),E=Id(e.center.lng),P=Ed(_);let C=E-Id(m.lng);const R=P-Ed(v);C>.5?C-=1:C<-.5&&(C+=1);let z=0;Math.abs(C)>Math.abs(R)?z=C>=0?1:3:(z=R>=0?0:2,J(f,f,[l[4]*s,l[5]*s,l[6]*s],-Math.sin(it(R>=0?c.getSouth():c.getNorth()))*dd));const D=h[z],O=h[(z+1)%4],F=new lh(D,O,f),B=[Np(F,0)||D[0],Np(F,1)||D[1],Np(F,2)||D[2]],k=rf(e.zoom);if(k>0){const o=function({x:e,y:t,z:r},o,s,l,c){const h=1/(1<<r);let u=e*h,d=u+h,p=t*h,f=p+h,m=0;const _=(u+d)/2-l;return _>.5?m=-1:_<-.5&&(m=1),u=((u+m)*o-(l*=o))*s+l,d=((d+m)*o-l)*s+l,p=(p*o-(c*=o))*s+c,f=(f*o-c)*s+c,[[u,f,0],[d,f,0],[d,p,0],[u,p,0]]}(r,t,e._pixelsPerMercatorPixel,E,P);for(let e=0;e<h.length;e++)jp(h[e],o[e],k);const s=j([],o[z],o[(z+1)%4]);Y(s,s,.5),jp(B,s,k)}for(const e of h)H(p,p,e),Z(d,d,e);return p[2]=Math.min(D[2],O[2]),H(p,p,B),Z(d,d,B),new wc(p,d)}function qp({x:e,y:t,z:r},o=!1){const s=1/(1<<r),l=new Bu(Pd(e*s),t===(1<<r)-1&&o?-90:Cd((t+1)*s)),c=new Bu(Pd((e+1)*s),0===t&&o?90:Cd(t*s));return new ku(l,c)}function Hp(e,t=dd){const r=it(e.getNorth()),o=it(e.getSouth()),s=Math.cos(r),l=Math.cos(o),c=Math.sin(r),h=Math.sin(o),u=e.getWest(),d=e.getEast();return[gd(l,h,u,t),gd(l,h,d,t),gd(s,c,d,t),gd(s,c,u,t)]}function Zp(e,t,r,o){const s=1<<r.z,l=(e/Ao+r.x)/s;return yd(Cd((t/Ao+r.y)/s),Pd(l),o)}function Xp({min:e,max:t}){return 16383/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const Yp=new Float64Array(16);function Jp(e){const t=Xp(e),r=R(Yp,[t,t,t]);return _(r,r,te([],e.min))}function Qp(e){const t=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}(Yp,e.min),r=1/Xp(e);return v(t,t,[r,r,r])}function Kp(e){const t=Ao/(2*Math.PI);return e/(2*Math.PI)/t}function ef(e,t){return Ao/(512*Math.pow(2,e))*Xp(Up(t))}function tf(e,t,r,o,s){const l=Kp(r),c=[e,t,-r/(2*Math.PI)],h=p(new Float64Array(16));return _(h,h,c),v(h,h,[l,l,l]),E(h,h,it(-s)),P(h,h,it(-o)),h}function rf(e){return ft(5,6,e)}function nf(e,t){const r=yd(t.lat,t.lng),o=function(e){const t=yd(e._center.lat,e._center.lng);let r=ne([],N(0,1,0),t);const o=z([],-e.angle,t);r=se(r,r,o),z(o,-e._pitch,r);const s=ie([],t);return Y(s,s,Lp(e.cameraToCenterDistance/e.pixelsPerMeter)),se(s,s,o),j([],t,s)}(e);return c=(s=$([],o,r))[0],h=s[1],u=s[2],d=(l=r)[0],p=l[1],f=l[2],_=(m=Math.sqrt((c*c+h*h+u*u)*(d*d+p*p+f*f)))&&re(s,l)/m,Math.acos(Math.min(Math.max(_,-1),1));var s,l,c,h,u,d,p,f,m,_}function of(e,t){return nf(e,t)>Math.PI/2*1.01}const sf=it(85),af=Math.cos(sf),hf=Math.sin(sf),df=u(),pf=e=>{const t=[];return"map"===e.paint.get("circle-pitch-alignment")&&t.push("PITCH_WITH_MAP"),"map"===e.paint.get("circle-pitch-scale")&&t.push("SCALE_WITH_MAP"),t};function _f(e,t,r,o,s,l,c,h,u){if(l&&e.queryGeometry.isAboveHorizon)return!1;l&&(u*=e.pixelToTileUnitsFactor);const d=e.tileID.canonical,p=r.projection.upVectorScale(d,r.center.lat,r.worldSize).metersToTile;for(const f of t)for(const t of f){const f=t.add(h),m=s&&r.elevation?r.elevation.exaggeration()*s.getElevationAt(f.x,f.y,!0):0,_=r.projection.projectTilePoint(f.x,f.y,d);if(m>0){const e=r.projection.upVector(d,f.x,f.y);_.x+=e[0]*p*m,_.y+=e[1]*p*m,_.z+=e[2]*p*m}const v=l?f:gf(_.x,_.y,_.z,o),E=l?e.tilespaceRays.map((e=>vf(e,m))):e.queryGeometry.screenGeometry,P=xe([],[_.x,_.y,_.z,1],o);if(!c&&l?u*=P[3]/r.cameraToCenterDistance:c&&!l&&(u*=r.cameraToCenterDistance/P[3]),l){const e=Cd((t.y/Ao+d.y)/(1<<d.z));u/=r.projection.pixelsPerMeter(e,1)/Ad(1,e)}if(op(E,v,u))return!0}return!1}function gf(e,t,r,o){const s=xe([],[e,t,r,1],o);return new Je(s[0]/s[3],s[1]/s[3])}const yf=N(0,0,0),xf=N(0,0,1);function vf(e,t){const r=B();return yf[2]=t,e.intersectsPlane(yf,xf,r),new Je(r[0],r[1])}class Rh extends Sc{}let bf,wf,Tf,Sf;function If(e,{width:t,height:r},o,s){if(s){if(s instanceof Uint8ClampedArray)s=new Uint8Array(s.buffer);else if(s.length!==t*r*o)throw new RangeError("mismatched image size")}else s=new Uint8Array(t*r*o);return e.width=t,e.height=r,e.data=s,e}function Ef(e,t,r){const{width:o,height:s}=t;o===e.width&&s===e.height||(Af(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,o),height:Math.min(e.height,s)},r,null),e.width=o,e.height=s,e.data=t.data)}function Af(e,t,r,o,s,l,c,h){if(0===s.width||0===s.height)return t;if(s.width>e.width||s.height>e.height||r.x>e.width-s.width||r.y>e.height-s.height)throw new RangeError("out of range source coordinates for image copy");if(s.width>t.width||s.height>t.height||o.x>t.width-s.width||o.y>t.height-s.height)throw new RangeError("out of range destination coordinates for image copy");const u=e.data,d=t.data,p=4===l&&h;for(let h=0;h<s.height;h++){const f=((r.y+h)*e.width+r.x)*l,m=((o.y+h)*t.width+o.x)*l;if(p)for(let e=0;e<s.width;e++){const t=f+e*l+3,r=m+e*l;d[r+0]=255,d[r+1]=255,d[r+2]=255,d[r+3]=u[t]}else if(c)for(let e=0;e<s.width;e++){const t=f+e*l,r=m+e*l,o=new ur(u[t+0]/255,u[t+1]/255,u[t+2]/255,u[t+3]).toNonPremultipliedRenderColor(c).toArray();d[r+0]=o[0],d[r+1]=o[1],d[r+2]=o[2],d[r+3]=o[3]}else for(let e=0;e<s.width*l;e++)d[m+e]=u[f+e]}return t}ih(Rh,"HeatmapBucket",{omit:["layers"]});class qh{constructor(e,t){If(this,e,1,t)}resize(e){Ef(this,new qh(e),1)}clone(){return new qh({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,r,o,s){Af(e,t,r,o,s,1,null)}}class Xh{constructor(e,t){If(this,e,4,t)}resize(e){Ef(this,new Xh(e),4)}replace(e,t){t?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Xh({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,r,o,s,l,c){Af(e,t,r,o,s,4,l,c)}}class Hh{constructor(e,t){this.width=e.width,this.height=e.height,this.data=t instanceof Uint8Array?new Float32Array(t.buffer):t}}function Mf(e){const t={},r=e.resolution||256,o=e.clips?e.clips.length:1,s=e.image||new Xh({width:r,height:o}),l=(r,o,l)=>{t[e.evaluationKey]=l;const c=e.expression.evaluate(t),h=c?c.toNonPremultipliedRenderColor(null):null;h&&(s.data[r+o+0]=Math.floor(255*h.r),s.data[r+o+1]=Math.floor(255*h.g),s.data[r+o+2]=Math.floor(255*h.b),s.data[r+o+3]=Math.floor(255*h.a))};if(e.clips)for(let t=0,s=0;t<o;++t,s+=4*r)for(let o=0,c=0;o<r;o++,c+=4){const h=o/(r-1),{start:u,end:d}=e.clips[t];l(s,c,u*(1-h)+d*h)}else for(let e=0,t=0;e<r;e++,t+=4)l(0,t,e/(r-1));return s}ih(qh,"AlphaImage"),ih(Xh,"RGBAImage");const Pf=Uu([{name:"a_pos",components:2,type:"Int16"}],4),Cf=Uu([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Rf=Uu([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),zf=Uu([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Df(e,t,r=2){const o=t&&t.length,s=o?t[0]*r:e.length;let l=Lf(e,0,s,r,!0);const c=[];if(!l||l.next===l.prev)return c;let h,u,d;if(o&&(l=function(e,t,r,o){const s=[];for(let r=0,l=t.length;r<l;r++){const c=Lf(e,t[r]*o,r<l-1?t[r+1]*o:e.length,o,!1);c===c.next&&(c.steiner=!0),s.push(Kf(c))}s.sort(Wf);for(let e=0;e<s.length;e++)r=Xf(s[e],r);return r}(e,t,l,r)),e.length>80*r){h=e[0],u=e[1];let t=h,o=u;for(let l=r;l<s;l+=r){const r=e[l],s=e[l+1];r<h&&(h=r),s<u&&(u=s),r>t&&(t=r),s>o&&(o=s)}d=Math.max(t-h,o-u),d=0!==d?32767/d:0}return Ff(l,c,r,h,u,d,0),c}function Lf(e,t,r,o,s){let l;if(s===function(e,t,r,o){let s=0;for(let l=t,c=r-o;l<r;l+=o)s+=(e[c]-e[l])*(e[l+1]+e[c+1]),c=l;return s}(e,t,r,o)>0)for(let s=t;s<r;s+=o)l=hm(s/o|0,e[s],e[s+1],l);else for(let s=r-o;s>=t;s-=o)l=hm(s/o|0,e[s],e[s+1],l);return l&&nm(l,l.next)&&(um(l),l=l.next),l}function Of(e,t){if(!e)return e;t||(t=e);let r,o=e;do{if(r=!1,o.steiner||!nm(o,o.next)&&0!==rm(o.prev,o,o.next))o=o.next;else{if(um(o),o=t=o.prev,o===o.next)break;r=!0}}while(r||o!==t);return t}function Ff(e,t,r,o,s,l,c){if(!e)return;!c&&l&&function(e,t,r,o){let s=e;do{0===s.z&&(s.z=Jf(s.x,s.y,t,r,o)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t,r=1;do{let o,s=e;e=null;let l=null;for(t=0;s;){t++;let c=s,h=0;for(let e=0;e<r&&(h++,c=c.nextZ,c);e++);let u=r;for(;h>0||u>0&&c;)0!==h&&(0===u||!c||s.z<=c.z)?(o=s,s=s.nextZ,h--):(o=c,c=c.nextZ,u--),l?l.nextZ=o:e=o,o.prevZ=l,l=o;s=c}l.nextZ=null,r*=2}while(t>1)}(s)}(e,o,s,l);let h=e;for(;e.prev!==e.next;){const u=e.prev,d=e.next;if(l?Uf(e,o,s,l):Vf(e))t.push(u.i,e.i,d.i),um(e),e=d.next,h=d.next;else if((e=d)===h){c?1===c?Ff(e=$f(Of(e),t),t,r,o,s,l,2):2===c&&qf(e,t,r,o,s,l):Ff(Of(e),t,r,o,s,l,1);break}}}function Vf(e){const t=e.prev,r=e,o=e.next;if(rm(t,r,o)>=0)return!1;const s=t.x,l=r.x,c=o.x,h=t.y,u=r.y,d=o.y,p=Math.min(s,l,c),f=Math.min(h,u,d),m=Math.max(s,l,c),_=Math.max(h,u,d);let v=o.next;for(;v!==t;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=_&&tm(s,h,l,u,c,d,v.x,v.y)&&rm(v.prev,v,v.next)>=0)return!1;v=v.next}return!0}function Uf(e,t,r,o){const s=e.prev,l=e,c=e.next;if(rm(s,l,c)>=0)return!1;const h=s.x,u=l.x,d=c.x,p=s.y,f=l.y,m=c.y,_=Math.min(h,u,d),v=Math.min(p,f,m),E=Math.max(h,u,d),P=Math.max(p,f,m),C=Jf(_,v,t,r,o),R=Jf(E,P,t,r,o);let z=e.prevZ,D=e.nextZ;for(;z&&z.z>=C&&D&&D.z<=R;){if(z.x>=_&&z.x<=E&&z.y>=v&&z.y<=P&&z!==s&&z!==c&&tm(h,p,u,f,d,m,z.x,z.y)&&rm(z.prev,z,z.next)>=0)return!1;if(z=z.prevZ,D.x>=_&&D.x<=E&&D.y>=v&&D.y<=P&&D!==s&&D!==c&&tm(h,p,u,f,d,m,D.x,D.y)&&rm(D.prev,D,D.next)>=0)return!1;D=D.nextZ}for(;z&&z.z>=C;){if(z.x>=_&&z.x<=E&&z.y>=v&&z.y<=P&&z!==s&&z!==c&&tm(h,p,u,f,d,m,z.x,z.y)&&rm(z.prev,z,z.next)>=0)return!1;z=z.prevZ}for(;D&&D.z<=R;){if(D.x>=_&&D.x<=E&&D.y>=v&&D.y<=P&&D!==s&&D!==c&&tm(h,p,u,f,d,m,D.x,D.y)&&rm(D.prev,D,D.next)>=0)return!1;D=D.nextZ}return!0}function $f(e,t){let r=e;do{const o=r.prev,s=r.next.next;!nm(o,s)&&om(o,r,r.next,s)&&lm(o,s)&&lm(s,o)&&(t.push(o.i,r.i,s.i),um(r),um(r.next),r=e=s),r=r.next}while(r!==e);return Of(r)}function qf(e,t,r,o,s,l){let c=e;do{let e=c.next.next;for(;e!==c.prev;){if(c.i!==e.i&&im(c,e)){let h=cm(c,e);return c=Of(c,c.next),h=Of(h,h.next),Ff(c,t,r,o,s,l,0),void Ff(h,t,r,o,s,l,0)}e=e.next}c=c.next}while(c!==e)}function Wf(e,t){let r=e.x-t.x;return 0===r&&(r=e.y-t.y,0===r)&&(r=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)),r}function Xf(e,t){const r=function(e,t){let r=t;const o=e.x,s=e.y;let l,c=-1/0;if(nm(e,r))return r;do{if(nm(e,r.next))return r.next;if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){const e=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=o&&e>c&&(c=e,l=r.x<r.next.x?r:r.next,e===o))return l}r=r.next}while(r!==t);if(!l)return null;const h=l,u=l.x,d=l.y;let p=1/0;r=l;do{if(o>=r.x&&r.x>=u&&o!==r.x&&em(s<d?o:c,s,u,d,s<d?c:o,s,r.x,r.y)){const t=Math.abs(s-r.y)/(o-r.x);lm(r,e)&&(t<p||t===p&&(r.x>l.x||r.x===l.x&&Yf(l,r)))&&(l=r,p=t)}r=r.next}while(r!==h);return l}(e,t);if(!r)return t;const o=cm(r,e);return Of(o,o.next),Of(r,r.next)}function Yf(e,t){return rm(e.prev,e,t.prev)<0&&rm(t.next,e,e.next)<0}function Jf(e,t,r,o,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-o)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Kf(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function em(e,t,r,o,s,l,c,h){return(s-c)*(t-h)>=(e-c)*(l-h)&&(e-c)*(o-h)>=(r-c)*(t-h)&&(r-c)*(l-h)>=(s-c)*(o-h)}function tm(e,t,r,o,s,l,c,h){return!(e===c&&t===h)&&em(e,t,r,o,s,l,c,h)}function im(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&om(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(lm(e,t)&&lm(t,e)&&function(e,t){let r=e,o=!1;const s=(e.x+t.x)/2,l=(e.y+t.y)/2;do{r.y>l!=r.next.y>l&&r.next.y!==r.y&&s<(r.next.x-r.x)*(l-r.y)/(r.next.y-r.y)+r.x&&(o=!o),r=r.next}while(r!==e);return o}(e,t)&&(rm(e.prev,e,t.prev)||rm(e,t.prev,t))||nm(e,t)&&rm(e.prev,e,e.next)>0&&rm(t.prev,t,t.next)>0)}function rm(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function nm(e,t){return e.x===t.x&&e.y===t.y}function om(e,t,r,o){const s=am(rm(e,t,r)),l=am(rm(e,t,o)),c=am(rm(r,o,e)),h=am(rm(r,o,t));return s!==l&&c!==h||!(0!==s||!sm(e,r,t))||!(0!==l||!sm(e,o,t))||!(0!==c||!sm(r,e,o))||!(0!==h||!sm(r,t,o))}function sm(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function am(e){return e>0?1:e<0?-1:0}function lm(e,t){return rm(e.prev,e,e.next)<0?rm(e,t,e.next)>=0&&rm(e,e.prev,t)>=0:rm(e,t,e.prev)<0||rm(e,e.next,t)<0}function cm(e,t){const r=dm(e.i,e.x,e.y),o=dm(t.i,t.x,t.y),s=e.next,l=t.prev;return e.next=t,t.prev=e,r.next=s,s.prev=r,o.next=r,r.prev=o,l.next=o,o.prev=l,o}function hm(e,t,r,o){const s=dm(e,t,r);return o?(s.next=o.next,s.prev=o,o.next.prev=s,o.next=s):(s.prev=s,s.next=s),s}function um(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function dm(e,t,r){return{i:e,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function pm(e,t){const r=e.length;if(r<=1)return[e];const o=[];let s,l;for(let t=0;t<r;t++){const r=Ct(e[t]);0!==r&&(e[t].area=Math.abs(r),void 0===l&&(l=r<0),l===r<0?(s&&o.push(s),s=[e[t]]):s.push(e[t]))}if(s&&o.push(s),t>1)for(let e=0;e<o.length;e++)o[e].length<=t||(En(o[e],t,1,o[e].length-1,fm),o[e]=o[e].slice(0,t));return o}function fm(e,t){return t.area-e.area}function mm(e,t,r=1){if(!e)return null;const o="string"==typeof e?Or.from(e).getPrimary():e.getPrimary(),s="string"==typeof e?null:e.getSecondary();for(const e of[o,s]){if(!e)continue;const o=e.id.toString();t.has(o)||t.set(o,[]),e.scaleSelf(r),t.get(o).push(e)}return{primary:o.toString(),secondary:s?s.toString():null}}function _m(e,t,r,o){const s=o.patternDependencies;let l=!1;for(const o of t){const t=o.paint.get(`${e}-pattern`);t.isConstant()||(l=!0),mm(t.constantOr(null),s,r)&&(l=!0)}return l}function gm(e,t,r,o,s,l){const c=l.patternDependencies;for(const h of t){const t=h.paint.get(`${e}-pattern`).value;if("constant"!==t.kind){let e=t.evaluate({zoom:o},r,{},l.availableImages);e=e&&e.name?e.name:e;const u=mm(e,c,s);if(!u)continue;const{primary:d,secondary:p}=u;d&&(r.patterns[h.id]=[d,p].filter(Boolean))}}return r}class kp{constructor(){this.portals=[]}static isOnBorder(e,t){return e<=0&&t<=0||e>=Ao&&t>=Ao}static evaluate(e){if(0===e.length)return new kp;let t=[];for(const r of e)t.push(...r.portals);if(0===t.length)return new kp;for(const e of t){const t=e.va,r=e.vb;(kp.isOnBorder(t.x,r.x)||kp.isOnBorder(t.y,r.y))&&(e.type="border")}const r=t.filter((e=>"unevaluated"!==e.type)),o=t.filter((e=>"unevaluated"===e.type));if(0===o.length)return new kp;o.sort(((e,t)=>e.hash===t.hash?e.isTunnel===t.isTunnel?0:e.isTunnel?-1:1:e.hash<t.hash?1:-1)),t=r.concat(o);let s=r.length,l=s,c=s;do{if(l++,l===t.length||t[s].hash!==t[l].hash){if(l-s===2){c<s&&(t[c]=t[s],t[s]=null);const e=t[c],r=t[l-1];e.type=e.isTunnel!==r.isTunnel?"tunnel":"polygon",e.connection={a:e.connection.a,b:r.connection.a},c++}s=l}}while(s!==t.length);return t.splice(c),t.sort(((e,t)=>e.hash<t.hash?1:-1)),{portals:t}}}ih(kp,"ElevationPortalGraph");class Tp{constructor(e,t,r){this.outPositions=e,this.outNormals=t,this.outIndices=r,this.vertexLookup=new Map}addVertex(e,t,r){let o=e[2];null!=r&&(o*=r);const s=`${e[0]},${e[1]},${e[2]},${t[0]},${t[1]},${t[2]}`,l=this.vertexLookup.get(s);if(null!=l)return l;const c=this.outPositions.length;this.vertexLookup.set(s,c);const h=Math.trunc(16384*t[0]),u=Math.trunc(16384*t[1]),d=Math.trunc(16384*t[2]);return this.outPositions.emplaceBack(e[0],e[1],o),this.outNormals.emplaceBack(h,u,d),c}addTriangle(e,t,r){this.outIndices.emplaceBack(e,t,r)}addTriangles(e,t,r){if(0===e.length)return;const o=1===r.length,s=B(),l=B();for(let c=0;c<e.length;c+=3){const h=t[e[c+0]],u=t[e[c+1]],d=t[e[c+2]],p=o?r[0]:r[e[c+1]],f=o?r[0]:r[e[c+2]];U(s,h.x,h.y,o?r[0]:r[e[c+0]]);const m=this.addVertex(s,l);U(s,u.x,u.y,p);const _=this.addVertex(s,l);U(s,d.x,d.y,f);const v=this.addVertex(s,l);this.outIndices.emplaceBack(m,_,v)}}addQuad(e,t,r,o,s,l){const c=this.addVertex(e,s,l),h=this.addVertex(t,s,l),u=this.addVertex(r,s,l),d=this.addVertex(o,s,l);this.addTriangle(c,h,u),this.addTriangle(u,d,c)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class Vp{constructor(e,t,r,o){this.unevaluatedPortals=new kp,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new qo,this.vertexNormals=new Xo,this.indexArray=new ll,this.tileToMeters=Fd(e),this.bridgeProgramConfigurations=new fu(t,{zoom:r,lut:o},(e=>"fill-tunnel-structure-color"!==e)),this.tunnelProgramConfigurations=new fu(t,{zoom:r,lut:o},(e=>"fill-bridge-guard-rail-color"!==e))}addVertices(e,t){const r=this.unevalVertices.length;for(let r=0;r<e.length;r++)this.unevalVertices.push(e[r]),this.unevalHeights.push(t[r]);return r}addTriangles(e,t,r){const o=r?this.unevalTunnelTriangles:this.unevalTriangles;for(const r of e)o.push(r+t)}addRenderableRing(e,t,r,o,s,l){const c=[new Je(s.min.x,s.min.y),new Je(s.max.x,s.min.y),new Je(s.max.x,s.max.y),new Je(s.min.x,s.max.y)];for(let h=0;h<r-1;h++){const r=t+h,u=r+1,d=this.unevalVertices[r],p=this.unevalVertices[u];if(!(d.x>=s.min.x&&d.x<=s.max.x&&d.y>=s.min.y&&d.y<=s.max.y||p.x>=s.min.x&&p.x<=s.max.x&&p.y>=s.min.y&&p.y<=s.max.y||gp(d,p,c)))continue;if(this.isOnBorder(d.x,p.x)||this.isOnBorder(d.y,p.y))continue;const f=Vp.computeEdgeHash(this.unevalVertices[r],this.unevalVertices[u]);let m,_=this.vertexHashLookup.get(Vp.computePosHash(d));null!=_?m=_.next:(_=this.vertexHashLookup.get(Vp.computePosHash(p)),m=null!=_?_.prev:f),this.unevalEdges.push({polygonIdx:e,a:r,b:u,hash:f,portalHash:m,isTunnel:o,type:"unevaluated",featureInfo:l})}}addPortalCandidates(e,t,r,o,s){if(0!==t.length){this.vertexHashLookup.clear();for(const s of t){if(0===s.length)continue;const t=s[0];let l=Vp.computeEdgeHash(t[t.length-2],t[t.length-1]);for(let s=0;s<t.length-1;s++){const c=t[s+0],h=t[s+1],u=De(h.x-c.x,h.y-c.y),d=Ue(u);if(0===d)continue;let p="unevaluated";const f=o.pointElevation(c),m=o.pointElevation(h);Math.abs(f)<.01&&Math.abs(m)<.01?p="entrance":(this.isOnBorder(c.x,h.x)||this.isOnBorder(c.y,h.y))&&(p="border");const _=Vp.computeEdgeHash(c,h);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:c,vb:h,vab:u,length:d,hash:_,isTunnel:r,type:p});const v=Vp.computePosHash(c);this.vertexHashLookup.set(v,{prev:l,next:_}),l=_}}}}construct(e){if(0===this.unevalVertices.length)return;const t=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),r=e=>{e.primitiveLength=this.indexArray.length-e.primitiveOffset},o=new Tp(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const s=t(),l=t(),c=t(),h=(e,t)=>{e.sort(((e,r)=>e.type===t&&r.type!==t?-1:e.type!==t&&r.type===t?1:0));const r=e.findIndex((e=>e.type!==t));return r>=0?r:e.length};let u=0;this.unevalEdges.length>0&&(u=h(this.unevalEdges,"none"),this.constructBridgeStructures(o,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:u},this.tileToMeters)),r(c);const d=t(),p=t();if(this.unevalEdges.length>0){const e=this.unevalEdges.splice(u),t=h(e,"tunnel")+u;this.unevalEdges.push(...e),this.constructTunnelStructures(o,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:u},{min:u,max:t})}r(d),o.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),r(p),o.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),r(l),o.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),r(s),this.maskSegments=Ol.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength),this.depthSegments=Ol.simpleSegment(0,l.primitiveOffset,0,l.primitiveLength),this.renderableBridgeSegments=Ol.simpleSegment(0,c.primitiveOffset,0,c.primitiveLength),this.renderableTunnelSegments=Ol.simpleSegment(0,d.primitiveOffset,0,d.primitiveLength),this.shadowCasterSegments=Ol.simpleSegment(0,s.primitiveOffset,0,s.primitiveLength)}update(e,t,r,o,s,l,c,h){this.bridgeProgramConfigurations.updatePaintArrays(e,t,s,r,o,l,c,h),this.tunnelProgramConfigurations.updatePaintArrays(e,t,s,r,o,l,c,h)}upload(e){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Rf.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,zf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,t,r,o,s){const l=(l,c)=>{for(let h=0;h<c.length-1;h++){const u=c[h].featureIndex,d=c[h+1].vertexStart,p=e.feature(u);l.populatePaintArrays(d,p,u,{},r,t,o,void 0,s)}};l(this.bridgeProgramConfigurations,this.bridgeFeatureSections),l(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,t,r,o,s){const l=new Map;for(let c=o;c<s;c++){const o=r[c],s=o.a,h=o.b,u=Vp.computePosHash(e[s]),d=Vp.computePosHash(e[h]);let p=l.get(u);p||(p={},l.set(u,p));let f=l.get(d);f||(f={},l.set(d,f)),t[s]<=0&&t[h]<=0||(p.to=h,f.from=s)}return l}isTerminalVertex(e,t){const r=Vp.computePosHash(this.unevalVertices[e]),o=t.get(r);return!o||!o.from||!o.to}constructBridgeStructures(e,t,r,o,s,l){e.clearVertexLookup();const c=this.computeVertexConnections(t,r,o,s.min,s.max),h=1/l,u=.5*h,d=(e,o)=>U(e,t[o].x,t[o].y,r[o]*h),p=B(),f=B(),m=B(),_=B(),v=B(),E=(e,r)=>{const o=c.get(Vp.computePosHash(t[r])),s=o.from,l=o.to;if(!s||!l)return;d(p,s),d(f,r),d(m,l),ce(_),he(p,f)||(ue(v,f,p),ie(_,v)),he(m,f)||(ue(v,m,f),j(_,_,ie(v,v)));const h=pe(_);return h>0?Y(e,_,1/h):void 0};let P=Number.POSITIVE_INFINITY;this.sortSubarray(o,s.min,s.max,((e,t)=>e.featureInfo.featureIndex-t.featureInfo.featureIndex));const C=B(),R=B(),z=B(),D=B(),O=B(),F=B(),k=B(),V=B(),N=B(),$=[B(),B(),B(),B()],q=[B(),B(),B(),B()],H=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],Z=(e,t)=>e>t;for(let d=s.min;d<s.max;d++){const s=o[d];if(!s.featureInfo.guardRailEnabled)continue;if(!this.prepareEdgePoints(H,t,r,s,Z))continue;const[p,f]=H;if(U(C,p.coord.x,p.coord.y,h*p.height),U(R,f.coord.x,f.coord.y,h*f.height),he(C,R))continue;ue(z,R,C),ie(z,z);const m=E(V,s.a)||z,_=E(N,s.b)||z;U(D,m[1],-m[0],0),ie(D,D),U(O,_[1],-_[0],0),ie(O,O),ne(V,D,m),ie(F,V),ne(V,O,_),ie(k,V),j($[0],C,Y(V,ue(V,D,F),u)),j($[1],C,Y(V,j(V,D,F),u)),j($[2],C,Y(V,F,u)),$[3]=C,j(q[0],R,Y(V,ue(V,O,k),u)),j(q[1],R,Y(V,j(V,O,k),u)),j(q[2],R,Y(V,k,u)),q[3]=R,P=this.addFeatureSection(s.featureInfo.featureIndex,P,this.bridgeFeatureSections,e);const v=e.addVertex($[0],D,l),B=e.addVertex($[1],D,l),J=e.addVertex(q[0],O,l),Q=e.addVertex(q[1],O,l);e.addTriangle(v,B,J),e.addTriangle(B,Q,J);const K=e.addVertex($[1],F,l),ee=e.addVertex($[2],F,l),re=e.addVertex(q[1],k,l),oe=e.addVertex(q[2],k,l);e.addTriangle(K,ee,re),e.addTriangle(ee,oe,re),te(D,D),te(O,O);const se=e.addVertex($[2],D,l),ae=e.addVertex($[3],D,l),le=e.addVertex(q[2],O,l),ce=e.addVertex(q[3],O,l);e.addTriangle(se,ae,le),e.addTriangle(ae,ce,le);const de=this.isTerminalVertex(s.a,c),pe=this.isTerminalVertex(s.b,c);p.height<.01&&de&&e.addQuad($[3],$[2],$[1],$[0],te(m,m),l),f.height<.01&&pe&&e.addQuad(q[0],q[1],q[2],q[3],_,l)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,t,r,o,s,l){e.clearVertexLookup();let c=Number.POSITIVE_INFINITY;const h=(e,t)=>e.featureInfo.featureIndex-t.featureInfo.featureIndex;this.sortSubarray(o,s.min,s.max,h),this.sortSubarray(o,l.min,l.max,h);const u=e=>ie(e,e),d=[{coord:new Je(0,0),height:0},{coord:new Je(0,0),height:0}],p=(e,t)=>e<t,f=B(),m=B(),_=B(),v=B(),E=B();for(let l=s.min;l<s.max;l++){if(!this.prepareEdgePoints(d,t,r,o[l],p))continue;const[s,h]=d,P=u(U(E,-(h.coord.y-s.coord.y),h.coord.x-s.coord.x,0));c=this.addFeatureSection(o[l].featureInfo.featureIndex,c,this.tunnelFeatureSections,e),e.addQuad(U(f,s.coord.x,s.coord.y,s.height),U(m,h.coord.x,h.coord.y,h.height),U(_,h.coord.x,h.coord.y,o[l].isTunnel?-.1:0),U(v,s.coord.x,s.coord.y,o[l].isTunnel?-.1:0),P)}for(let s=l.min;s<l.max;s++){const l=o[s];l.isTunnel&&([l.a,l.b]=[l.b,l.a]);const h=t[l.a],d=t[l.b],p=u(U(E,-(d.y-h.y),d.x-h.x,0));c=this.addFeatureSection(l.featureInfo.featureIndex,c,this.tunnelFeatureSections,e),e.addQuad(U(f,d.x,d.y,0),U(m,h.x,h.y,0),U(_,h.x,h.y,r[l.a]+4),U(v,d.x,d.y,r[l.b]+4),p),e.addQuad(U(f,h.x,h.y,0),U(m,d.x,d.y,0),U(_,d.x,d.y,r[l.b]+4),U(v,h.x,h.y,r[l.a]+4),p)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,t,r,o){e.coord.x=t,e.coord.y=r,e.height=o}prepareEdgePoints(e,t,r,o,s){let l=t[o.a].x,c=t[o.a].y,h=t[o.b].x,u=t[o.b].y,d=r[o.a],p=r[o.b];const f=s(d,0),m=s(p,0);if(f&&m)return this.setElevatedPoint(e[0],l,c,d),this.setElevatedPoint(e[1],h,u,p),!0;if(!f&&!m)return!1;if(f){if(!m){const e=p/(p-d);h=Ar(h,l,e),u=Ar(u,c,e),p=Ar(p,d,e)}}else{const e=d/(d-p);l=Ar(l,h,e),c=Ar(c,u,e),d=Ar(d,p,e)}return this.setElevatedPoint(e[0],l,c,d),this.setElevatedPoint(e[1],h,u,p),!0}prepareEdges(e,t){if(0===t.length)return;t.sort(((e,t)=>e.hash===t.hash?t.polygonIdx-e.polygonIdx:t.hash>e.hash?1:-1));let r=0,o=0,s=0,l=t[r].polygonIdx;do{o++,(o===t.length||t[r].hash!==t[o].hash)&&((1===o-r||t[o-1].polygonIdx!==l)&&(s<r&&(t[s]=t[r],t[r]=null),t[s].type="none",s++),r=o,r!==t.length&&(l=t[r].polygonIdx))}while(r!==t.length);if(t.splice(s),0!==t.length&&0!==e.length){t.sort(((e,t)=>e.portalHash<t.portalHash?1:-1));let r=0,o=0;for(;r!==t.length&&o!==e.length;){const s=t[r],l=e[o];s.portalHash>l.hash?r++:l.hash>s.portalHash?o++:(s.type=l.type,r++)}}}isOnBorder(e,t){return e<=0&&t<=0||e>=Ao&&t>=Ao}addFeatureSection(e,t,r,o){return e!==t&&(t=e,r.push({featureIndex:e,vertexStart:o.getVertexCount()}),o.clearVertexLookup()),t}sortSubarray(e,t,r,o){const s=e.slice(t,r);s.sort(o),e.splice(t,s.length,...s)}static computeEdgeHash(e,t){return(e.y===t.y&&e.x>t.x||e.y>t.y)&&([e,t]=[t,e]),BigInt(Vp.computePosHash(e))<<32n|BigInt(Vp.computePosHash(t))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}function ym(e,t){return e>t?1:e<t?-1:0}class Fp{constructor(e=ym,t=!1){this._compare=e,this._root=null,this._size=0,this._noDuplicates=!!t}rotateLeft(e){var t=e.right;t&&(e.right=t.left,t.left&&(t.left.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.left=e),e.parent=t}rotateRight(e){var t=e.left;t&&(e.left=t.right,t.right&&(t.right.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.right=e),e.parent=t}_splay(e){for(;e.parent;){var t=e.parent;t.parent?t.left===e&&t.parent.left===t?(this.rotateRight(t.parent),this.rotateRight(t)):t.right===e&&t.parent.right===t?(this.rotateLeft(t.parent),this.rotateLeft(t)):t.left===e&&t.parent.right===t?(this.rotateRight(t),this.rotateLeft(t)):(this.rotateLeft(t),this.rotateRight(t)):t.left===e?this.rotateRight(t):this.rotateLeft(t)}}splay(e){for(var t,r,o,s,l;e.parent;)(r=(t=e.parent).parent)&&r.parent?((o=r.parent).left===r?o.left=e:o.right=e,e.parent=o):(e.parent=null,this._root=e),s=e.left,l=e.right,e===t.left?(r&&(r.left===t?(t.right?(r.left=t.right,r.left.parent=r):r.left=null,t.right=r,r.parent=t):(s?(r.right=s,s.parent=r):r.right=null,e.left=r,r.parent=e)),l?(t.left=l,l.parent=t):t.left=null,e.right=t,t.parent=e):(r&&(r.right===t?(t.left?(r.right=t.left,r.right.parent=r):r.right=null,t.left=r,r.parent=t):(l?(r.left=l,l.parent=r):r.left=null,e.right=r,r.parent=e)),s?(t.right=s,s.parent=t):t.right=null,e.left=t,t.parent=e)}replace(e,t){e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.parent=e.parent)}minNode(e=this._root){if(e)for(;e.left;)e=e.left;return e}maxNode(e=this._root){if(e)for(;e.right;)e=e.right;return e}insert(e,t){var r=this._root,o=null,s=this._compare;if(this._noDuplicates)for(;r;){if(o=r,0===s(r.key,e))return;r=s(r.key,e)<0?r.right:r.left}else for(;r;)o=r,r=s(r.key,e)<0?r.right:r.left;return r={key:e,data:t,left:null,right:null,parent:o},o?s(o.key,r.key)<0?o.right=r:o.left=r:this._root=r,this.splay(r),this._size++,r}find(e){for(var t=this._root,r=this._compare;t;){var o=r(t.key,e);if(o<0)t=t.right;else{if(!(o>0))return t;t=t.left}}return null}contains(e){for(var t=this._root,r=this._compare;t;){var o=r(e,t.key);if(0===o)return!0;t=o<0?t.left:t.right}return!1}remove(e){var t=this.find(e);if(!t)return!1;if(this.splay(t),t.left)if(t.right){var r=this.minNode(t.right);r.parent!==t&&(this.replace(r,r.right),r.right=t.right,r.right.parent=r),this.replace(t,r),r.left=t.left,r.left.parent=r}else this.replace(t,t.left);else this.replace(t,t.right);return this._size--,!0}removeNode(e){if(!e)return!1;if(this.splay(e),e.left)if(e.right){var t=this.minNode(e.right);t.parent!==e&&(this.replace(t,t.right),t.right=e.right,t.right.parent=t),this.replace(e,t),t.left=e.left,t.left.parent=t}else this.replace(e,e.left);else this.replace(e,e.right);return this._size--,!0}erase(e){var t=this.find(e);if(t){this.splay(t);var r=t.left,o=t.right,s=null;r&&(r.parent=null,s=this.maxNode(r),this.splay(s),this._root=s),o&&(r?s.right=o:this._root=o,o.parent=s),this._size--}}pop(){var e=this._root,t=null;if(e){for(;e.left;)e=e.left;t={key:e.key,data:e.data},this.remove(e.key)}return t}next(e){var t=e;if(t)if(t.right)for(t=t.right;t&&t.left;)t=t.left;else for(t=e.parent;t&&t.right===e;)e=t,t=t.parent;return t}prev(e){var t=e;if(t)if(t.left)for(t=t.left;t&&t.right;)t=t.right;else for(t=e.parent;t&&t.left===e;)e=t,t=t.parent;return t}forEach(e){for(var t=this._root,r=[],o=!1,s=0;!o;)t?(r.push(t),t=t.left):r.length>0?(e(t=r.pop(),s++),t=t.right):o=!0;return this}range(e,t,r,o){const s=[],l=this._compare;let c,h=this._root;for(;0!==s.length||h;)if(h)s.push(h),h=h.left;else{if(h=s.pop(),c=l(h.key,t),c>0)break;if(l(h.key,e)>=0&&r.call(o,h))return this;h=h.right}return this}keys(){for(var e=this._root,t=[],r=[],o=!1;!o;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),r.push(e.key),e=e.right):o=!0;return r}values(){for(var e=this._root,t=[],r=[],o=!1;!o;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),r.push(e.data),e=e.right):o=!0;return r}at(e){for(var t=this._root,r=[],o=!1,s=0;!o;)if(t)r.push(t),t=t.left;else if(r.length>0){if(t=r.pop(),s===e)return t;s++,t=t.right}else o=!0;return null}load(e=[],t=[],r=!1){if(0!==this._size)throw new Error("bulk-load: tree is not empty");const o=e.length;return r&&vm(e,t,0,o-1,this._compare),this._root=xm(null,e,t,0,o),this._size=o,this}min(){var e=this.minNode(this._root);return e?e.key:null}max(){var e=this.maxNode(this._root);return e?e.key:null}isEmpty(){return null===this._root}get size(){return this._size}static createTree(e,t,r,o,s){return new Fp(r,s).load(e,t,o)}}function xm(e,t,r,o,s){const l=s-o;if(l>0){const c=o+Math.floor(l/2),h={key:t[c],data:r[c],parent:e};return h.left=xm(h,t,r,o,c),h.right=xm(h,t,r,c+1,s),h}return null}function vm(e,t,r,o,s){if(r>=o)return;const l=e[r+o>>1];let c=r-1,h=o+1;for(;;){do{c++}while(s(e[c],l)<0);do{h--}while(s(e[h],l)>0);if(c>=h)break;let r=e[c];e[c]=e[h],e[h]=r,r=t[c],t[c]=t[h],t[h]=r}vm(e,t,r,h,s),vm(e,t,h+1,o,s)}const bm=11102230246251565e-32,wm=134217729,Tm=(3+8*bm)*bm;function Sm(e,t,r,o,s){let l,c,h,u,d=t[0],p=o[0],f=0,m=0;p>d==p>-d?(l=d,d=t[++f]):(l=p,p=o[++m]);let _=0;if(f<e&&m<r)for(p>d==p>-d?(c=d+l,h=l-(c-d),d=t[++f]):(c=p+l,h=l-(c-p),p=o[++m]),l=c,0!==h&&(s[_++]=h);f<e&&m<r;)p>d==p>-d?(c=l+d,u=c-l,h=l-(c-u)+(d-u),d=t[++f]):(c=l+p,u=c-l,h=l-(c-u)+(p-u),p=o[++m]),l=c,0!==h&&(s[_++]=h);for(;f<e;)c=l+d,u=c-l,h=l-(c-u)+(d-u),d=t[++f],l=c,0!==h&&(s[_++]=h);for(;m<r;)c=l+p,u=c-l,h=l-(c-u)+(p-u),p=o[++m],l=c,0!==h&&(s[_++]=h);return 0===l&&0!==_||(s[_++]=l),_}function Im(e){return new Float64Array(e)}const Em=Im(4),Am=Im(8),Mm=Im(12),Pm=Im(16),zm=Im(4);function Dm(e,t,r){null===t?(e.inOut=!1,e.otherInOut=!0):(e.isSubject===t.isSubject?(e.inOut=!t.inOut,e.otherInOut=t.otherInOut):(e.inOut=!t.otherInOut,e.otherInOut=t.isVertical()?!t.inOut:t.inOut),t&&(e.prevInResult=!Lm(t,r)||t.isVertical()?t.prevInResult:t)),e.resultTransition=Lm(e,r)?function(e,t){let r,o=!e.inOut,s=!e.otherInOut;switch(t){case 0:r=o&&s;break;case 1:r=o||s;break;case 3:r=o!==s;break;case 2:r=e.isSubject?o&&!s:s&&!o}return r?1:-1}(e,r):0}function Lm(e,t){switch(e.type){case 0:switch(t){case 0:return!e.otherInOut;case 1:return e.otherInOut;case 2:return e.isSubject&&e.otherInOut||!e.isSubject&&!e.otherInOut;case 3:return!0}break;case 2:return 0===t||1===t;case 3:return 2===t;case 1:return!1}return!1}class Wp{constructor(e,t,r,o,s){this.left=t,this.point=e,this.otherEvent=r,this.isSubject=o??!1,this.type=s||0,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(e){const t=this.point,r=this.otherEvent.point;return this.left?(t[0]-e[0])*(r[1]-e[1])-(r[0]-e[0])*(t[1]-e[1])>0:(r[0]-e[0])*(t[1]-e[1])-(t[0]-e[0])*(r[1]-e[1])>0}isAbove(e){return!this.isBelow(e)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return 0!==this.resultTransition}clone(){const e=new Wp(this.point,this.left,this.otherEvent,this.isSubject,this.type);return e.contourId=this.contourId,e.resultTransition=this.resultTransition,e.prevInResult=this.prevInResult,e.isExteriorRing=this.isExteriorRing,e.inOut=this.inOut,e.otherInOut=this.otherInOut,e}}function Om(e,t){return e[0]===t[0]&&e[1]===t[1]}function Fm(e,t,r){const o=function(e,t,r,o,s,l){const c=(t-l)*(r-s),h=(e-s)*(o-l),u=c-h;if(0===c||0===h||c>0!=h>0)return u;const d=Math.abs(c+h);return Math.abs(u)>=33306690738754716e-32*d?u:-function(e,t,r,o,s,l,c){let h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k;const V=e-s,N=r-s,U=t-l,j=o-l;D=V*j,m=wm*V,_=m-(m-V),v=V-_,m=wm*j,E=m-(m-j),P=j-E,O=v*P-(D-_*E-v*E-_*P),F=U*N,m=wm*U,_=m-(m-U),v=U-_,m=wm*N,E=m-(m-N),P=N-E,B=v*P-(F-_*E-v*E-_*P),C=O-B,f=O-C,Em[0]=O-(C+f)+(f-B),R=D+C,f=R-D,z=D-(R-f)+(C-f),C=z-F,f=z-C,Em[1]=z-(C+f)+(f-F),k=R+C,f=k-R,Em[2]=R-(k-f)+(C-f),Em[3]=k;let $=function(e,t){let r=t[0];for(let e=1;e<4;e++)r+=t[e];return r}(0,Em),q=22204460492503146e-32*c;if($>=q||-$>=q)return $;if(f=e-V,h=e-(V+f)+(f-s),f=r-N,d=r-(N+f)+(f-s),f=t-U,u=t-(U+f)+(f-l),f=o-j,p=o-(j+f)+(f-l),0===h&&0===u&&0===d&&0===p)return $;if(q=11093356479670487e-47*c+Tm*Math.abs($),$+=V*p+j*h-(U*d+N*u),$>=q||-$>=q)return $;D=h*j,m=wm*h,_=m-(m-h),v=h-_,m=wm*j,E=m-(m-j),P=j-E,O=v*P-(D-_*E-v*E-_*P),F=u*N,m=wm*u,_=m-(m-u),v=u-_,m=wm*N,E=m-(m-N),P=N-E,B=v*P-(F-_*E-v*E-_*P),C=O-B,f=O-C,zm[0]=O-(C+f)+(f-B),R=D+C,f=R-D,z=D-(R-f)+(C-f),C=z-F,f=z-C,zm[1]=z-(C+f)+(f-F),k=R+C,f=k-R,zm[2]=R-(k-f)+(C-f),zm[3]=k;const H=Sm(4,Em,4,zm,Am);D=V*p,m=wm*V,_=m-(m-V),v=V-_,m=wm*p,E=m-(m-p),P=p-E,O=v*P-(D-_*E-v*E-_*P),F=U*d,m=wm*U,_=m-(m-U),v=U-_,m=wm*d,E=m-(m-d),P=d-E,B=v*P-(F-_*E-v*E-_*P),C=O-B,f=O-C,zm[0]=O-(C+f)+(f-B),R=D+C,f=R-D,z=D-(R-f)+(C-f),C=z-F,f=z-C,zm[1]=z-(C+f)+(f-F),k=R+C,f=k-R,zm[2]=R-(k-f)+(C-f),zm[3]=k;const Z=Sm(H,Am,4,zm,Mm);D=h*p,m=wm*h,_=m-(m-h),v=h-_,m=wm*p,E=m-(m-p),P=p-E,O=v*P-(D-_*E-v*E-_*P),F=u*d,m=wm*u,_=m-(m-u),v=u-_,m=wm*d,E=m-(m-d),P=d-E,B=v*P-(F-_*E-v*E-_*P),C=O-B,f=O-C,zm[0]=O-(C+f)+(f-B),R=D+C,f=R-D,z=D-(R-f)+(C-f),C=z-F,f=z-C,zm[1]=z-(C+f)+(f-F),k=R+C,f=k-R,zm[2]=R-(k-f)+(C-f),zm[3]=k;const Y=Sm(Z,Mm,4,zm,Pm);return Pm[Y-1]}(e,t,r,o,s,l,d)}(e[0],e[1],t[0],t[1],r[0],r[1]);return o>0?-1:o<0?1:0}function Bm(e,t){const r=e.point,o=t.point;return r[0]>o[0]?1:r[0]<o[0]?-1:r[1]!==o[1]?r[1]>o[1]?1:-1:function(e,t,r){return e.left!==t.left?e.left?1:-1:0!==Fm(r,e.otherEvent.point,t.otherEvent.point)?e.isBelow(t.otherEvent.point)?-1:1:!e.isSubject&&t.isSubject?1:-1}(e,t,r)}function km(e,t,r){const o=new Wp(t,!1,e,e.isSubject),s=new Wp(t,!0,e.otherEvent,e.isSubject);return Om(e.point,e.otherEvent.point)&&console.warn("what is that, a collapsed segment?",e),o.contourId=s.contourId=e.contourId,Bm(s,e.otherEvent)>0&&(e.otherEvent.left=!0,s.left=!1),e.otherEvent.otherEvent=s,e.otherEvent=o,r.push(s),r.push(o),r}function Vm(e,t){return e[0]*t[1]-e[1]*t[0]}function Nm(e,t){return e[0]*t[0]+e[1]*t[1]}function Um(e,t,r){const o=function(e,t,r,o){const s=[t[0]-e[0],t[1]-e[1]],l=[o[0]-r[0],o[1]-r[1]];function c(e,t,r){return[e[0]+t*r[0],e[1]+t*r[1]]}const h=[r[0]-e[0],r[1]-e[1]];let u=Vm(s,l),d=u*u;const p=Nm(s,s);if(d>0){const t=Vm(h,l)/u;if(t<0||t>1)return null;const o=Vm(h,s)/u;return o<0||o>1?null:0===t||1===t?[c(e,t,s)]:0===o||1===o?[c(r,o,l)]:[c(e,t,s)]}if(u=Vm(h,s),d=u*u,d>0)return null;const f=Nm(s,h)/p,m=f+Nm(s,l)/p,_=Math.min(f,m),v=Math.max(f,m);return _<=1&&v>=0?1===_?[c(e,_>0?_:0,s)]:0===v?[c(e,v<1?v:1,s)]:[c(e,_>0?_:0,s),c(e,v<1?v:1,s)]:null}(e.point,e.otherEvent.point,t.point,t.otherEvent.point),s=o?o.length:0;if(0===s||1===s&&(Om(e.point,t.point)||Om(e.otherEvent.point,t.otherEvent.point))||2===s&&e.isSubject===t.isSubject)return 0;if(1===s)return!Om(e.point,o[0])&&!Om(e.otherEvent.point,o[0])&&km(e,o[0],r),!Om(t.point,o[0])&&!Om(t.otherEvent.point,o[0])&&km(t,o[0],r),1;const l=[];let c=!1,h=!1;return Om(e.point,t.point)?c=!0:1===Bm(e,t)?l.push(t,e):l.push(e,t),Om(e.otherEvent.point,t.otherEvent.point)?h=!0:1===Bm(e.otherEvent,t.otherEvent)?l.push(t.otherEvent,e.otherEvent):l.push(e.otherEvent,t.otherEvent),c&&h||c?(t.type=1,e.type=t.inOut===e.inOut?2:3,c&&!h&&km(l[1].otherEvent,l[0].point,r),2):h?(km(l[0],l[1].point,r),3):l[0]!==l[3].otherEvent?(km(l[0],l[1].point,r),km(l[1],l[2].point,r),3):(km(l[0],l[1].point,r),km(l[3].otherEvent,l[2].point,r),3)}function jm(e,t){if(e===t)return 0;if(0!==Fm(e.point,e.otherEvent.point,t.point)||0!==Fm(e.point,e.otherEvent.point,t.otherEvent.point))return Om(e.point,t.point)?e.isBelow(t.otherEvent.point)?-1:1:e.point[0]===t.point[0]?e.point[1]<t.point[1]?-1:1:1===Bm(e,t)?t.isAbove(e.point)?-1:1:e.isBelow(t.point)?-1:1;if(e.isSubject!==t.isSubject)return e.isSubject?-1:1;{let r=e.point,o=t.point;if(r[0]===o[0]&&r[1]===o[1])return r=e.otherEvent.point,o=t.otherEvent.point,r[0]===o[0]&&r[1]===o[1]?0:(e.contourId??0)>(t.contourId??0)?1:-1}return 1===Bm(e,t)?1:-1}class id{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return null==this.holeOf}}function Gm(e,t,r,o){let s,l=e+1,c=t[e].point;const h=t.length;for(l<h&&(s=t[l].point);l<h&&s[0]===c[0]&&s[1]===c[1];){if(!r[l])return l;l++,l<h&&(s=t[l].point)}for(l=e-1;r[l]&&l>o;)l--;return l}function $m(e,t,r){const o=new id;if(null!=e.prevInResult){const s=e.prevInResult,l=s.outputContourId;if(s.resultTransition>0){const e=t[l];if(null!=e.holeOf){const s=e.holeOf;t[s].holeIds.push(r),o.holeOf=s,o.depth=t[l].depth}else t[l].holeIds.push(r),o.holeOf=l,o.depth=t[l].depth+1}else o.holeOf=null,o.depth=t[l].depth}else o.holeOf=null,o.depth=0;return o}const qm=Math.max,Hm=Math.min;let Wm=0;function Zm(e,t,r,o,s,l){let c,h,u,d,p,f;for(c=0,h=e.length-1;c<h;c++){if(u=e[c],d=e[c+1],p=new Wp(u,!1,void 0,t),f=new Wp(d,!1,p,t),p.otherEvent=f,u[0]===d[0]&&u[1]===d[1])continue;p.contourId=f.contourId=r,l||(p.isExteriorRing=!1,f.isExteriorRing=!1),Bm(p,f)>0?f.left=!0:p.left=!0;const h=u[0],m=u[1];s[0]=Hm(s[0],h),s[1]=Hm(s[1],m),s[2]=qm(s[2],h),s[3]=qm(s[3],m),o.push(p),o.push(f)}}const Xm=[];function Ym(e,t,r){let o=e,s=t;"number"==typeof e[0][0][0]&&(o=[e]),"number"==typeof t[0][0][0]&&(s=[t]);let l=function(e,t,r){let o=null;return e.length*t.length===0&&(0===r?o=Xm:2===r?o=e:(1===r||3===r)&&(o=0===e.length?t:e)),o}(o,s,r);if(l)return l===Xm?null:l;const c=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],u=function(e,t,r,o,s){const l=new Nn(void 0,Bm);let c,h,u,d,p,f;for(u=0,d=e.length;u<d;u++)for(c=e[u],p=0,f=c.length;p<f;p++)h=0===p,h&&Wm++,Zm(c[p],!0,Wm,l,r,h);for(u=0,d=t.length;u<d;u++)for(c=t[u],p=0,f=c.length;p<f;p++)h=0===p,2===s&&(h=!1),h&&Wm++,Zm(c[p],!1,Wm,l,o,h);return l}(o,s,c,h,r);if(l=function(e,t,r,o,s){let l=null;return(r[0]>o[2]||o[0]>r[2]||r[1]>o[3]||o[1]>r[3])&&(0===s?l=Xm:2===s?l=e:(1===s||3===s)&&(l=e.concat(t))),l}(o,s,c,h,r),l)return l===Xm?null:l;const d=function(e,t,r,o,s,l){const c=new Fp(jm),h=[],u=Math.min(o[2],s[2]);let d,p,f;for(;0!==e.length;){let t=e.pop();if(h.push(t),0===l&&t.point[0]>u||2===l&&t.point[0]>o[2])break;if(t.left){p=d=c.insert(t),f=c.minNode(),d=d!==f?c.prev(d):null,p=c.next(p);const r=d?d.key:null;let o;if(Dm(t,r,l),p&&2===Um(t,p.key,e)&&(Dm(t,r,l),Dm(p.key,t,l)),d&&2===Um(d.key,t,e)){let e=d;e=e!==f?c.prev(e):null,o=e?e.key:null,Dm(r,o,l),Dm(t,r,l)}}else t=t.otherEvent,p=d=c.find(t),d&&p&&(d=d!==f?c.prev(d):null,p=c.next(p),c.remove(t),p&&d&&Um(d.key,p.key,e))}return h}(u,0,0,c,h,r),p=function(e){let t,r;const o=function(e){let t,r,o,s,l;const c=[];for(r=0,o=e.length;r<o;r++)t=e[r],(t.left&&t.inResult||!t.left&&t.otherEvent.inResult)&&c.push(t);let h=!1;for(;!h;)for(h=!0,r=0,o=c.length;r<o;r++)r+1<o&&1===Bm(c[r],c[r+1])&&(s=c[r],c[r]=c[r+1],c[r+1]=s,h=!1);for(r=0,o=c.length;r<o;r++)t=c[r],t.otherPos=r;for(r=0,o=c.length;r<o;r++)t=c[r],t.left||(l=t.otherPos,t.otherPos=t.otherEvent.otherPos,t.otherEvent.otherPos=l);return c}(e),s={},l=[];for(t=0,r=o.length;t<r;t++){if(s[t])continue;const e=l.length,r=$m(o[t],l,e),c=t=>{s[t]=!0,t<o.length&&o[t]&&(o[t].outputContourId=e)};let h=t,u=t;for(r.points.push(o[t].point);c(h),h=o[h].otherPos,c(h),r.points.push(o[h].point),h=Gm(h,o,s,u),!(h==u||h>=o.length)&&o[h];);l.push(r)}return l}(d),f=[];for(let e=0;e<p.length;e++){let t=p[e];if(t.isExterior()){let e=[t.points];for(let r=0;r<t.holeIds.length;r++)e.push(p[t.holeIds[r]].points);f.push(e)}}return f}function Jm(e,t,r,o){const s=[],l=0===o?(e,t,r,o,s,l)=>{e.push(new Je(l,r+(l-t)/(o-t)*(s-r)))}:(e,t,r,o,s,l)=>{e.push(new Je(t+(l-r)/(s-r)*(o-t),l))};for(const c of e){const e=[];for(const s of c){if(s.length<=2)continue;const c=[];for(let e=0;e<s.length-1;e++){const h=s[e].x,u=s[e].y,d=s[e+1].x,p=s[e+1].y,f=0===o?h:u,m=0===o?d:p;f<t?m>t&&l(c,h,u,d,p,t):f>r?m<r&&l(c,h,u,d,p,r):c.push(s[e]),m<t&&f>=t&&l(c,h,u,d,p,t),m>r&&f<=r&&l(c,h,u,d,p,r)}let h=s[s.length-1];const u=0===o?h.x:h.y;u>=t&&u<=r&&c.push(h),c.length&&(h=c[c.length-1],c[0].x===h.x&&c[0].y===h.y||c.push(c[0]),e.push(c))}e.length&&s.push(e)}return s}function Qm(e,t){const r=Ym(e_(e),e_([t]),0);return null==r?[]:t_(r)}function Km(e,t){const r=65536;let o=e_(e,r);const s=[];for(;t.valid();t.next()){const[e,o]=t.get(),l=e.x*r,c=e.y*r,h=o.x*r,u=o.y*r,d=h-l,p=u-c,f=Math.hypot(d,p);if(0===f)continue;const m=Math.trunc(p/f*3),_=-Math.trunc(d/f*3);s.push([[[l,c],[h,u],[h+m,u+_],[l+m,c+_],[l,c]]])}return s.length>0&&(o=Ym(o,s,2)),t_(o,1/r,128)}function e_(e,t=1){return[e.map((e=>e.map((e=>[e.x*t,e.y*t]))))]}function t_(e,t=1,r){return e.map((e=>e.map(((e,o)=>{const s=e.map((e=>{let o=e[0],s=e[1];return r&&(o=Math.round(o/r)*r,s=Math.round(s/r)*r),new Je(o*t,s*t)._round()}));return o>0&&s.reverse(),s}))))}class xd{constructor(e,t){this.layoutVertexArray=new No,this.indexArray=new ll,this.lineIndexArray=new nl,this.triangleSegments=new Ol,this.lineSegments=new Ol,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,t&&(this.elevatedLayoutVertexArray=new $o)}update(e,t,r,o,s,l,c,h){this.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,h)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Pf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Cf.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,t,r,o,s,l,c){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,t,r,o,s,l,void 0,c)}}class vd{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new xd(e,!1),this.elevationBufferData=new xd(e,!0),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,r,o){}populate(e,t,r,o){this.hasPattern=_m("fill",this.layers,this.pixelRatio,t);const s=this.layers[0].layout.get("fill-sort-key"),l=[];for(const{feature:c,id:h,index:u,sourceLayerIndex:d}of e){const e=this.layers[0]._featureFilter.needGeometry,p=qd(c,e);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),p,r))continue;const f=s?s.evaluate(p,{},r,t.availableImages):void 0,m={id:h,properties:c.properties,type:c.type,sourceLayerIndex:d,index:u,geometry:e?p.geometry:$d(c,r,o),patterns:{},sortKey:f};l.push(m)}s&&l.sort(((e,t)=>e.sortKey-t.sortKey));for(const o of l){const{geometry:s,index:l,sourceLayerIndex:c}=o;if(this.hasPattern){const e=gm("fill",this.layers,o,this.zoom,this.pixelRatio,t);this.patternFeatures.push(e)}else this.addFeature(o,s,l,r,{},t.availableImages,t.brightness,t.elevationFeatures);t.featureIndex.insert(e[l].feature,s,l,c,this.index)}}update(e,t,r,o,s,l,c){this.bufferData.update(e,t,r,o,s,l,c,this.worldview),this.elevationBufferData.update(e,t,r,o,s,l,c,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,t,r,o,s,l,c,this.worldview)}addFeatures(e,t,r,o,s,l){for(const s of this.patternFeatures)this.addFeature(s,s.geometry,s.index,t,r,o,l,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,t,r,o,s,l=[],c,h){const u=pm(t,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(e,u,o,r,h):this.addGeometry(u,this.bufferData),this.bufferData.populatePaintArrays(e,r,s,l,o,c,this.worldview),this.elevationBufferData.populatePaintArrays(e,r,s,l,o,c,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}setEvaluatedPortalGraph(e,t,r,o,s){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(t,r,o,s,this.worldview))}addElevatedRoadFeature(e,t,r,o,s){const l=new Array,c=Mc.getElevationFeature(e,s);if(!c)return void this.addGeometry(t,this.bufferData);{const e=this.clipPolygonsToTile(t,1);e.length>0&&l.push({polygons:e,elevationFeature:c,elevationTileID:r})}const h={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},r),featureIndex:o};for(const t of l)if(t.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new Vp(t.elevationTileID,this.layers,this.zoom,this.lut));const r=t.elevationFeature.isTunnel();let o=0;e.properties.hasOwnProperty(Jd)&&(o=+e.properties[Jd]),this.elevatedStructures.addPortalCandidates(t.elevationFeature.id,t.polygons,r,t.elevationFeature,o)}null==t.elevationFeature.constantHeight&&(t.polygons=this.prepareElevatedPolygons(t.polygons,t.elevationFeature,t.elevationTileID));const s=new Ic(r,t.elevationTileID);this.addElevatedGeometry(t.polygons,s,t.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,o,h)}}addElevatedGeometry(e,t,r,o,s,l){const c={elevation:r,elevationSampler:t,bias:o,index:s,featureInfo:l},[h,u]=this.addGeometry(e,this.elevationBufferData,c);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:h,max:u}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,h),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,u))}addGeometry(e,t,r){let o=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,l=null;r&&(l=r.elevationSampler.constantElevation(r.elevation,r.bias),null!=l&&(o=l,s=l));const c=(e,c,h)=>{if(null!=r)if(c.push(e),null!=l)t.elevatedLayoutVertexArray.emplaceBack(l),h.push(l);else{const l=r.elevationSampler.pointElevation(e,r.elevation,r.bias);t.elevatedLayoutVertexArray.emplaceBack(l),h.push(l),o=Math.min(o,l),s=Math.max(s,l)}};for(const o of e){let e=0;for(const t of o)e+=t.length;const s=t.triangleSegments.prepareSegment(e,t.layoutVertexArray,t.indexArray),l=s.vertexLength,h=[],u=[],d=[],p=[],f=[],m=t.layoutVertexArray.length;for(const e of o){if(0===e.length)continue;e!==o[0]&&u.push(h.length/2);const s=t.lineSegments.prepareSegment(e.length,t.layoutVertexArray,t.lineIndexArray),l=s.vertexLength;r&&f.push(t.layoutVertexArray.length-m),c(e[0],d,p),t.layoutVertexArray.emplaceBack(e[0].x,e[0].y),t.lineIndexArray.emplaceBack(l+e.length-1,l),h.push(e[0].x),h.push(e[0].y);for(let r=1;r<e.length;r++)c(e[r],d,p),t.layoutVertexArray.emplaceBack(e[r].x,e[r].y),t.lineIndexArray.emplaceBack(l+r-1,l+r),h.push(e[r].x),h.push(e[r].y);s.vertexLength+=e.length,s.primitiveLength+=e.length}const _=Df(h,u);for(let e=0;e<_.length;e+=3)t.indexArray.emplaceBack(l+_[e],l+_[e+1],l+_[e+2]);if(_.length>0&&r&&"hd-road-base"===this.elevationMode){const e=r.elevation.isTunnel(),t=r.elevation.safeArea,o=this.elevatedStructures.addVertices(d,p);this.elevatedStructures.addTriangles(_,o,e);const s=f.length;if(s>0){for(let l=0;l<s-1;l++)this.elevatedStructures.addRenderableRing(r.index,f[l]+o,f[l+1]-f[l],e,t,r.featureInfo);this.elevatedStructures.addRenderableRing(r.index,f[s-1]+o,d.length-f[s-1],e,t,r.featureInfo)}}s.vertexLength+=e,s.primitiveLength+=_.length/3}return[o,s]}prepareElevatedPolygons(e,t,r){const o=1/Fd(r),s=[];for(const r of e){const e=Km(r,new _c(t,o));s.push(...e)}return s}clipPolygonsToTile(e,t){const r=-t,o=-t,s=Ao+t,l=Ao+t;let c=0;const h=[],u=[];for(;c<e.length;c++){const t=e[c],d=kn(t);(d.min.x>=r&&d.max.x<=s&&d.min.y>=o&&d.max.y<=l?h:u).push(t)}if(h.length===e.length)return e;const d=[new Je(r,o),new Je(s,o),new Je(s,l),new Je(r,l),new Je(r,o)],p=h;for(const e of u)p.push(...Qm(e,d));return p}}let i_,n_,o_,s_;ih(vd,"FillBucket",{omit:["layers","patternFeatures"]}),ih(xd,"FillBufferData"),ih(Vp,"ElevatedStructures");class Md{constructor(e,t,r,o){if(this.triangleCount=t.length/3,this.min=new Je(0,0),this.max=new Je(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===e.length)return;const[s,l]=[e[0].clone(),e[0].clone()];for(let t=1;t<e.length;++t){const r=e[t];s.x=Math.min(s.x,r.x),s.y=Math.min(s.y,r.y),l.x=Math.max(l.x,r.x),l.y=Math.max(l.y,r.y)}if(o){const e=Math.ceil(Math.max(l.x-s.x,l.y-s.y)/o);r=Math.max(r,e)}if(0===r)return;this.min=s,this.max=l;const c=this.max.sub(this.min);c.x=Math.max(c.x,1),c.y=Math.max(c.y,1);const h=Math.max(c.x,c.y)/r;this.cellsX=Math.max(1,Math.ceil(c.x/h)),this.cellsY=Math.max(1,Math.ceil(c.y/h)),this.xScale=1/h,this.yScale=1/h;const u=[];for(let r=0;r<this.triangleCount;r++){const o=e[t[3*r+0]].sub(this.min),s=e[t[3*r+1]].sub(this.min),l=e[t[3*r+2]].sub(this.min),c=a_(Math.floor(Math.min(o.x,s.x,l.x)),this.xScale,this.cellsX),d=a_(Math.floor(Math.max(o.x,s.x,l.x)),this.xScale,this.cellsX),p=a_(Math.floor(Math.min(o.y,s.y,l.y)),this.yScale,this.cellsY),f=a_(Math.floor(Math.max(o.y,s.y,l.y)),this.yScale,this.cellsY),m=new Je(0,0),_=new Je(0,0),v=new Je(0,0),E=new Je(0,0);for(let e=p;e<=f;++e){m.y=_.y=e*h,v.y=E.y=(e+1)*h;for(let t=c;t<=d;++t)m.x=v.x=t*h,_.x=E.x=(t+1)*h,(xp(o,s,l,m,_,E)||xp(o,s,l,m,E,v))&&u.push({cellIdx:e*this.cellsX+t,triIdx:r})}}if(0===u.length)return;u.sort(((e,t)=>e.cellIdx-t.cellIdx||e.triIdx-t.triIdx));let d=0;for(;d<u.length;){const e=u[d].cellIdx,t={start:this.payload.length,len:0};for(;d<u.length&&u[d].cellIdx===e;)++t.len,this.payload.push(u[d++].triIdx);this.cells[e]=t}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,t){if(0===this.triangleCount||0===this.cells.length)return;if(e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const r=a_(e.x-this.min.x,this.xScale,this.cellsX),o=a_(e.y-this.min.y,this.yScale,this.cellsY),s=this.cells[o*this.cellsX+r];if(s){this._lazyInitLookup();for(let e=0;e<s.len;e++){const r=this.payload[s.start+e],o=Math.floor(r/8),l=1<<r%8;if(!(this.lookup[o]&l)&&(this.lookup[o]|=l,t.push(r),t.length===this.triangleCount))return}}}query(e,t,r){if(0===this.triangleCount||0===this.cells.length)return;if(e.x>this.max.x||this.min.x>t.x)return;if(e.y>this.max.y||this.min.y>t.y)return;this._lazyInitLookup();const o=a_(e.x-this.min.x,this.xScale,this.cellsX),s=a_(t.x-this.min.x,this.xScale,this.cellsX),l=a_(e.y-this.min.y,this.yScale,this.cellsY),c=a_(t.y-this.min.y,this.yScale,this.cellsY);for(let e=l;e<=c;e++)for(let t=o;t<=s;t++){const o=this.cells[e*this.cellsX+t];if(o)for(let e=0;e<o.len;e++){const t=this.payload[o.start+e],s=Math.floor(t/8),l=1<<t%8;if(!(this.lookup[s]&l)&&(this.lookup[s]|=l,r.push(t),r.length===this.triangleCount))return}}}}function a_(e,t,r){return Math.max(0,Math.min(r-1,Math.floor(e*t)))}ih(Md,"TriangleGridIndex");class Sd{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){for(const r of this.footprints)t.push({footprint:r,id:e})}updateAppearances(e,t,r,o){}populate(e,t,r,o){const s=[];for(const{feature:l,id:c,index:h,sourceLayerIndex:u}of e){const e=this.layers[0]._featureFilter.needGeometry,d=qd(l,e);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),d,r))continue;const p={id:c,properties:l.properties,type:l.type,sourceLayerIndex:u,index:h,geometry:e?d.geometry:$d(l,r,o),patterns:{}};s.push(p)}for(const o of s){const{geometry:s,index:l,sourceLayerIndex:c}=o;this.addFeature(o,s,l,r,{},t.availableImages,t.brightness),t.featureIndex.insert(e[l].feature,s,l,c,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(e){}update(e,t,r,o,s,l,c){}destroy(){}addFeature(e,t,r,o,s,l=[],c){for(const e of pm(t,2)){const t=[],r=[],o=[],s=new Je(1/0,1/0),l=new Je(-1/0,-1/0);for(const c of e)if(0!==c.length){c!==e[0]&&o.push(r.length/2);for(let e=0;e<c.length;e++)r.push(c[e].x),r.push(c[e].y),t.push(c[e]),s.x=Math.min(s.x,c[e].x),s.y=Math.min(s.y,c[e].y),l.x=Math.max(l.x,c[e].x),l.y=Math.max(l.y,c[e].y)}const c=Df(r,o),h=new Md(t,c,8,256);this.footprints.push({vertices:t,indices:c,grid:h,min:s,max:l})}}}ih(Sd,"ClipBucket",{omit:["layers"]});const l_=Uu([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),c_=Uu([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),h_=Uu([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),u_=Uu([{name:"a_centroid_pos",components:2,type:"Uint16"}]),d_=Uu([{name:"a_join_normal_inside",components:3,type:"Int16"}]),p_=Uu([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),f_=Uu([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:m_}=l_,__=Number.MAX_SAFE_INTEGER,g_=__-1;function y_(e,t,r,o){return e.order<t||e.order===__||!(e.clipMask&r)||function(e,t){return 0!==t.length&&void 0===t.find((t=>t===e))}(o,e.clipScope)}function x_(e,t){return e.x-t.x||e.y-t.y}function v_(e,t){return 0===x_(e.min,t.min)&&0===x_(e.max,t.max)}function b_(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function w_(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r].sourceId!==t[r].sourceId||!v_(e[r],t[r])||e[r].order!==t[r].order||e[r].clipMask!==t[r].clipMask||!Qe(e[r].clipScope,t[r].clipScope))return!1;return!0}function T_(e,t,r){const o=1/Ao,s=1/(1<<r.canonical.z),l=(t.x*o+r.canonical.x)*s+r.wrap,c=(t.y*o+r.canonical.y)*s;return{min:new Je((e.x*o+r.canonical.x)*s+r.wrap,(e.y*o+r.canonical.y)*s),max:new Je(l,c)}}function S_(e,t,r){const o=1<<r.canonical.z,s=((t.x-r.wrap)*o-r.canonical.x)*Ao,l=(t.y*o-r.canonical.y)*Ao;return{min:new Je(((e.x-r.wrap)*o-r.canonical.x)*Ao,(e.y*o-r.canonical.y)*Ao),max:new Je(s,l)}}function I_(e,t,r,o,s,l,c){const h=e.indices,u=e.vertices,d=[];for(let p=o;p<o+s;p+=3){const o=t[r[p+0]+l],s=t[r[p+1]+l],f=t[r[p+2]+l],m=Math.min(o.x,s.x,f.x),_=Math.max(o.x,s.x,f.x),v=Math.min(o.y,s.y,f.y),E=Math.max(o.y,s.y,f.y);d.length=0,e.grid.query(new Je(m,v),new Je(_,E),d);for(let e=0;e<d.length;e++){const t=d[e];if(xp(u[h[3*t+0]],u[h[3*t+1]],u[h[3*t+2]],o,s,f,c))return!0}}return!1}function E_(e,t,r,o){if(!e||!r)return!1;let s=e.vertices;if(!t.canonical.equals(o.canonical)||t.wrap!==o.wrap){if(r.vertices.length<e.vertices.length)return E_(r,o,e,t);const l=t.canonical,c=o.canonical,h=Math.pow(2,c.z-l.z);s=e.vertices.map((e=>new Je((e.x+l.x*Ao)*h-c.x*Ao,(e.y+l.y*Ao)*h-c.y*Ao)))}return I_(r,s,e.indices,0,e.indices.length,0,0)}function A_(e,t,r,o){const s=Math.pow(2,o.z-r.z);return new Je((e+r.x*Ao)*s-o.x*Ao,(t+r.y*Ao)*s-o.y*Ao)}function M_(e,t){const r=[];t.grid.queryPoint(e,r);const o=t.indices,s=t.vertices;for(let t=0;t<r.length;t++){const l=r[t];if(mp([s[o[3*l+0]],s[o[3*l+1]],s[o[3*l+2]]],e))return!0}return!1}const P_=[new Je(0,0),new Je(Ao,0),new Je(Ao,Ao),new Je(0,Ao)];function C_(e,t){const r=[];let o=[];if(!t||e.length<2)return[e];if(2===e.length)return gp(e[0],e[1],P_)?[e]:[];for(let t=0;t<e.length+2;t++){const s=e[t%e.length],l=e[(t+1)%e.length],c=gp(0===t?e[e.length-1]:e[(t-1)%e.length],s,P_),h=gp(s,l,P_),u=c||h;u&&o.push(s),u&&h||o.length>0&&(o.length>1&&r.push(o),o=[])}return o.length>1&&r.push(o),r}const R_=Qu.types,z_=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],D_=["fill-extrusion-flood-light-ground-radius"],L_=Math.pow(2,13),O_=Math.pow(2,15)-1,F_=new Je(0,1),B_=2147483648;function k_(e,t,r,o,s,l,c,h){e.emplaceBack((t<<1)+c,(r<<1)+l,(Math.floor(o*L_)<<1)+s,Math.round(h))}function V_(e,t,r){e.emplaceBack(t.x*Ao,t.y*Ao,r?1:0)}function N_(e,t,r,o,s,l){e.emplaceBack(t.x,t.y,(r.x<<1)+o,(r.y<<1)+s,l)}function U_(e,t,r){const o=16384;e.emplaceBack(t.x,t.y,t.z,r[0]*o,r[1]*o,r[2]*o)}class lf{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class uf{constructor(){this.centroidXY=new Je(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Je(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Je(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Je(this.max.x-this.min.x,this.max.y-this.min.y)}}class cf{constructor(){this.acc=new Je(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,t){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=t.x,e.min.y=e.max.y=t.y)}appendEdge(e,t,r){this.accCount++,this.acc._add(t);let o=!!this.borders;t.x<e.min.x?(e.min.x=t.x,o=!0):t.x>e.max.x&&(e.max.x=t.x,o=!0),t.y<e.min.y?(e.min.y=t.y,o=!0):t.y>e.max.y&&(e.max.y=t.y,o=!0),((0===t.x||t.x===Ao)&&t.x===r.x)!=((0===t.y||t.y===Ao)&&t.y===r.y)&&this.processBorderOverlap(t,r),o&&this.checkBorderIntersection(t,r)}checkBorderIntersection(e,t){t.x<0!=e.x<0&&this.addBorderIntersection(0,Ar(t.y,e.y,(0-t.x)/(e.x-t.x))),t.x>Ao!=e.x>Ao&&this.addBorderIntersection(1,Ar(t.y,e.y,(Ao-t.x)/(e.x-t.x))),t.y<0!=e.y<0&&this.addBorderIntersection(2,Ar(t.x,e.x,(0-t.y)/(e.y-t.y))),t.y>Ao!=e.y>Ao&&this.addBorderIntersection(3,Ar(t.x,e.x,(Ao-t.y)/(e.y-t.y)))}addBorderIntersection(e,t){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const r=this.borders[e];t<r[0]&&(r[0]=t),t>r[1]&&(r[1]=t)}processBorderOverlap(e,t){if(e.x===t.x){if(e.y===t.y)return;const r=0===e.x?0:1;this.addBorderIntersection(r,t.y),this.addBorderIntersection(r,e.y)}else{const r=0===e.y?2:3;this.addBorderIntersection(r,t.x),this.addBorderIntersection(r,e.x)}}centroid(){return 0===this.accCount?new Je(0,0):new Je(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,t)=>e+ +(t[0]!==Number.MAX_VALUE)),0):0}}function G_(e,t){const r=e.add(t)._unit(),o=ct(e.x*r.x+e.y*r.y,-1,1);var s,l,c;return c=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(c)))/4*O_*((s=e).x*(l=t).y-s.y*l.x<0?-1:1)}const $_=[e=>e.x<0,e=>e.x>Ao,e=>e.y<0,e=>e.y>Ao];function q_(e,t,r,o){const s=[4];if(0===o)return s;r._mult(o);const l=e.sub(r),c=t.sub(r),h=[e,t,l,c];for(let e=0;e<4;e++)for(const t of h)if($_[e](t)){s.push(e);break}return s}class ff{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new Ho,this.indexArray=new ll,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut},(e=>D_.includes(e))),this._segments=new Ol,this.hiddenByLandmarkVertexArray=new _l,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ol}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(e,t,r,o=!1){const s=e.length;if(s>2){let l=Math.max(0,this._segments.get().length-1);const c=this._segments._prepareSegment(4*s,this.vertexArray.length,2*this._segmentToGroundQuads[l].length);let h;l!==this._segments.get().length-1&&(l++,this._segmentToGroundQuads[l]=[],this._segmentToRegionTriCounts[l]=[0,0,0,0,0]);{const t=e[0],r=e[1];h=G_(t.sub(e[s-1])._perp()._unit(),r.sub(t)._perp()._unit())}for(let u=0;u<s;u++){const d=u===s-1?0:u+1,p=e[u],f=e[d],m=e[d===s-1?0:d+1],_=f.sub(p)._perp()._unit(),v=G_(_,m.sub(f)._perp()._unit()),E=h,P=v;if(eg(p,f,t)||o&&tg(p,t)&&tg(f,t)){h=v;continue}const C=c.vertexLength;N_(this.vertexArray,p,f,1,1,E),N_(this.vertexArray,p,f,1,0,E),N_(this.vertexArray,p,f,0,1,P),N_(this.vertexArray,p,f,0,0,P),c.vertexLength+=4;const R=q_(p,f,_,r);for(const e of R)this._segmentToGroundQuads[l].push({id:C,region:e}),this._segmentToRegionTriCounts[l][e]+=2,c.primitiveLength+=2;h=v}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),t=e.length;for(let e=0;e<t;e++)this._segmentToGroundQuads[e].sort(((e,t)=>e.region-t.region));for(let r=0;r<t;r++){const t=this._segmentToGroundQuads[r],o=e[r],s=this._segmentToRegionTriCounts[r];s.reduce(((e,t)=>e+t),0);let l=0;for(let e=0;e<=4;e++){const t=s[e];if(0!==t){let r=this.regionSegments[e];r||(r=this.regionSegments[e]=new Ol);const s={vertexOffset:o.vertexOffset,primitiveOffset:o.primitiveOffset+l,vertexLength:o.vertexLength,primitiveLength:t};r.get().push(s)}l+=t}for(let e=0;e<t.length;e++){const r=t[e].id;this.indexArray.emplaceBack(r,r+1,r+3),this.indexArray.emplaceBack(r,r+3,r+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,t,r,o,s,l,c){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,t,r,o,s,l,void 0,c)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,c_.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),null!=this.groundRadiusArray&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,h_.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,t,r,o,s,l,c,h){this.hasData()&&this.programConfigurations.updatePaintArrays(e,t,r,o,s,l,c,h)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&B_))}updateHiddenByLandmarkRange(e,t,r){if(!this.hasData())return;const o=t+e;if(0!==t){for(let t=e;t<o;++t)this.hiddenByLandmarkVertexArray.emplace(t,r?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,p_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const t=this.regionSegments[e];t&&t.destroy()}}}}class mf{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ll,this.footprintVertices=new No,this.footprintSegments=[],this.layoutVertexArray=new Go,this.centroidVertexArray=new El,this.wallVertexArray=new Dl,this.indexArray=new ll,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut},(e=>z_.includes(e))),this.segments=new Ol,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.groundEffect=new ff(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,r,o){}populate(e,t,r,o){this.features=[],this.hasPattern=_m("fill-extrusion",this.layers,this.pixelRatio,t),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Fd(r),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:s,id:l,index:c,sourceLayerIndex:h}of e){const e=this.layers[0]._featureFilter.needGeometry,u=qd(s,e);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),u,r))continue;const d={id:l,sourceLayerIndex:h,index:c,geometry:e?u.geometry:$d(s,r,o),properties:s.properties,type:s.type,patterns:{}},p=this.layoutVertexArray.length,f="Polygon"===R_[d.type];if(this.hasPattern)this.features.push({featureId:s.id,feature:gm("fill-extrusion",this.layers,d,this.zoom,this.pixelRatio,t)});else if(this.wallMode)for(const e of d.geometry)for(const l of C_(e,f))this.addFeature(s.id,d,[l],c,r,{},t.availableImages,o,t.brightness);else this.addFeature(s.id,d,d.geometry,c,r,{},t.availableImages,o,t.brightness);t.featureIndex.insert(s,d.geometry,c,h,this.index,p)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,t,r,o,s,l){for(const{featureId:e,feature:c}of this.features){const h="Polygon"===R_[c.type],{geometry:u}=c;if(this.wallMode)for(const d of u)for(const u of C_(d,h))this.addFeature(e,c,[u],c.index,t,r,o,s,l);else this.addFeature(e,c,u,c.index,t,r,o,s,l)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(e,t,r,o,s,l,c){this.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,this.worldview),this.groundEffect.update(e,t,s,r,o,l,c,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,m_),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,d_.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,f_.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,u_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,t,r,o,s,l,c,h,u){const d=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,p=[new Je(0,0),new Je(Ao,Ao)],f=h.projection,m="globe"===f.name,_=this.wallMode||"Polygon"===R_[t.type],v=new cf;v.centroidDataIndex=this.centroidData.length;const E=new uf;E.buildingId=e,t.properties&&t.properties.hasOwnProperty("building_id")&&(E.buildingId=Number(t.properties.building_id));const P=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},s)<=0,C=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},s);let R;if(E.height=C,E.vertexArrayOffset=this.layoutVertexArray.length,E.groundVertexArrayOffset=this.groundEffect.vertexArray.length,m&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ko),this.wallMode){if(m)return void Et("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==r.length)return;R=function(e){const t=e[0].x===e[e.length-1].x&&e[0].y===e[e.length-1].y,r=function(e){let t=0;const r=e.length;for(let o=0;o<r;o++)t+=(e[(o+1)%r].x-e[o].x)*(e[(o+1)%r].y+e[o].y);return t>=0}(e);r||(e=e.reverse());const o={geometry:[],joinNormals:[],indices:[]},s=[],l=[],c=[];let h=e.length;for(;h>=2&&e[h-1].equals(e[h-2]);)h--;if(h<(t?3:2))return o;let u,d,p,f,m,_=0;for(;_<h-1&&e[_].equals(e[_+1]);)_++;t&&(u=e[h-2],m=e[_].sub(u)._unit()._perp());for(let r=_;r<h;r++){if(p=r===h-1?t?e[_+1]:void 0:e[r+1],p&&e[r].equals(p))continue;m&&(f=m),u&&(d=u),u=e[r],m=p?p.sub(u)._unit()._perp():f,f=f||m;let o=f.add(m);0===o.x&&0===o.y||o._unit();const v=o.x*m.x+o.y*m.y,E=0!==v?1/v:1/0,P=f.x*m.y-f.y*m.x>0;let C="miter";const R=2;"miter"===C&&E>R&&(C="bevel"),"bevel"===C&&(E>100&&(C="flipbevel"),E<R&&(C="miter"));const z=(e,t,r,o)=>{const h=new Je(e.x,e.y),u=new Je(e.x,e.y);h.x+=t.x*o,h.y+=t.y*o,u.x-=t.x*Math.max(r,1),u.y-=t.y*Math.max(r,1),c.push(t),s.push(h),l.push(u)};if("miter"===C)o._mult(E),z(u,o,0,0);else if("flipbevel"===C)o=m.mult(-1),z(u,o,0,0),z(u,o.mult(-1),0,0);else{const e=-Math.sqrt(E*E-1),t=P?e:0,r=P?0:e;d&&z(u,f,t,r),p&&z(u,m,t,r)}}o.geometry=[...s,...l.reverse(),s[0]],o.joinNormals=[...c,...c.reverse(),c[c.length-1]];const v=o.geometry.length-1;for(let e=0;e<v/2;e++)if(e+1<v/2){let t=e,r=e+1,s=v-1-e,l=v-2-e;t=0===t?v-1:t-1,r=0===r?v-1:r-1,s=0===s?v-1:s-1,l=0===l?v-1:l-1,o.indices.push(s),o.indices.push(r),o.indices.push(t),o.indices.push(s),o.indices.push(l),o.indices.push(r)}return o}(r[0]),r=[R.geometry]}const z=(e,t)=>e<(t.length-1)/2||e===t.length-1,D=this.wallMode?[r]:pm(r,500);for(let e=D.length-1;e>=0;e--){const t=D[e];(0===t.length||ig(t[0]))&&D.splice(e,1)}let O;if(m)O=sg(D,p,s);else{O=[];for(const e of D)O.push({polygon:e,bounds:p})}const F=_?this.edgeRadius:0,B=F>0&&this.zoom<17,k=(e,t)=>{if(0===e.length)return!1;const r=e[e.length-1];return t.x===r.x&&t.y===r.y};for(const{polygon:e,bounds:t}of O){let r=0,o=0;for(const t of e)_&&!t[0].equals(t[t.length-1])&&t.push(t[0]),o+=_?t.length-1:t.length;const l=this.segments.prepareSegment((_?5:4)*o,this.layoutVertexArray,this.indexArray);E.footprintSegIdx<0&&(E.footprintSegIdx=this.footprintSegments.length),E.polygonSegIdx<0&&(E.polygonSegIdx=this.polygonSegments.length);const c={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},h=new lf;if(h.vertexOffset=this.footprintVertices.length,h.indexOffset=3*this.footprintIndices.length,h.ringIndices=[],_){const o=[],c=[];r=l.vertexLength;for(let r=0;r<e.length;r++){const u=e[r];u.length&&0!==r&&c.push(o.length/2);const p=[];let _,v;_=u[1].sub(u[0])._perp()._unit(),h.ringIndices.push(u.length-1);for(let e=1;e<u.length;e++){const t=u[e],r=u[e===u.length-1?1:e+1],c=t.clone();if(F){v=r.sub(t)._perp()._unit();const e=_.add(v)._unit(),o=F*Math.min(4,1/(_.x*e.x+_.y*e.y));c.x+=o*e.x,c.y+=o*e.y,c.x=Math.round(c.x),c.y=Math.round(c.y),_=v}if(!P||0!==F&&!B||k(p,c)||p.push(c),k_(this.layoutVertexArray,c.x,c.y,0,0,1,1,0),this.wallMode){const t=z(e,u);V_(this.wallVertexArray,R.joinNormals[e],!t)}l.vertexLength++,this.footprintVertices.emplaceBack(t.x,t.y),o.push(t.x,t.y),m&&U_(this.layoutVertexExtArray,f.projectTilePoint(c.x,c.y,s),f.upVector(s,c.x,c.y))}P&&(0===F||B)&&(0!==p.length&&k(p,p[0])&&p.pop(),this.groundEffect.addData(p,t,d))}const u=this.wallMode?R.indices:Df(o,c);for(let e=0;e<u.length;e+=3)this.footprintIndices.emplaceBack(h.vertexOffset+u[e+0],h.vertexOffset+u[e+1],h.vertexOffset+u[e+2]),this.indexArray.emplaceBack(r+u[e],r+u[e+2],r+u[e+1]),l.primitiveLength++;h.indexCount+=u.length,h.vertexCount+=this.footprintVertices.length-h.vertexOffset}for(let o=0;o<e.length;o++){const c=e[o];v.startRing(E,c[0]);let h=c.length>4&&rg(c[c.length-2],c[0],c[1]),u=F?Q_(c[c.length-2],c[0],c[1],F):0;const p=[];let C,D,O;D=c[1].sub(c[0])._perp()._unit();let B=!0;for(let e=1,o=0;e<c.length;e++){let d=c[e-1],_=c[e];const V=c[e===c.length-1?1:e+1];if(v.appendEdge(E,_,d),eg(_,d,t)){F&&(D=V.sub(_)._perp()._unit(),B=!B);continue}const N=_.sub(d)._perp(),U=N.x/(Math.abs(N.x)+Math.abs(N.y)),j=N.y>0?1:0,$=d.dist(_);if(o+$>32768&&(o=0),F){O=V.sub(_)._perp()._unit();let e=K_(d,_,V,X_(D,O),F);isNaN(e)&&(e=0);const t=_.sub(d)._unit();d=d.add(t.mult(u))._round(),_=_.add(t.mult(-e))._round(),u=e,D=O,P&&this.zoom>=17&&(k(p,d)||p.push(d),k(p,_)||p.push(_))}const q=l.vertexLength,H=c.length>4&&rg(d,_,V);let Z=ng(o,h,B);if(k_(this.layoutVertexArray,d.x,d.y,U,j,0,0,Z),k_(this.layoutVertexArray,d.x,d.y,U,j,0,1,Z),this.wallMode){const t=z(e-1,c),r=R.joinNormals[e-1];V_(this.wallVertexArray,r,t),V_(this.wallVertexArray,r,t)}if(o+=$,Z=ng(o,H,!B),h=H,k_(this.layoutVertexArray,_.x,_.y,U,j,0,0,Z),k_(this.layoutVertexArray,_.x,_.y,U,j,0,1,Z),this.wallMode){const t=z(e,c),r=R.joinNormals[e];V_(this.wallVertexArray,r,t),V_(this.wallVertexArray,r,t)}if(l.vertexLength+=4,this.indexArray.emplaceBack(q+0,q+1,q+2),this.indexArray.emplaceBack(q+1,q+3,q+2),l.primitiveLength+=2,F){const o=r+(1===e?c.length-2:e-2),s=1===e?r:o+1;if(this.indexArray.emplaceBack(q+1,o,q+3),this.indexArray.emplaceBack(o,s,q+3),l.primitiveLength+=2,void 0===C&&(C=q),!eg(V,c[e],t)){const t=e===c.length-1?C:l.vertexLength;this.indexArray.emplaceBack(q+2,q+3,t),this.indexArray.emplaceBack(q+3,t+1,t),this.indexArray.emplaceBack(q+3,s,t+1),l.primitiveLength+=3}B=!B}if(m){const e=this.layoutVertexExtArray,t=f.projectTilePoint(d.x,d.y,s),r=f.projectTilePoint(_.x,_.y,s),o=f.upVector(s,d.x,d.y),l=f.upVector(s,_.x,_.y);U_(e,t,o),U_(e,t,o),U_(e,r,l),U_(e,r,l)}}_&&(r+=c.length-1),P&&F&&this.zoom>=17&&(0!==p.length&&k(p,p[0])&&p.pop(),this.groundEffect.addData(p,t,d,F>0))}this.footprintSegments.push(h),c.triangleCount=this.indexArray.length-c.triangleArrayOffset,this.polygonSegments.push(c),++E.footprintSegLen,++E.polygonSegLen}if(E.vertexCount=this.layoutVertexArray.length-E.vertexArrayOffset,E.groundVertexCount=this.groundEffect.vertexArray.length-E.groundVertexArrayOffset,0!==E.vertexCount){if(E.centroidXY=v.borders?F_:this.encodeCentroid(v,E),this.centroidData.push(E),v.borders){this.featuresOnBorder.push(v);const e=this.featuresOnBorder.length-1;for(let t=0;t<v.borders.length;t++)v.borders[t][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[t].push(e)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,l,c,s,u,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(t,o,l,c,s,u,this.worldview),this.maxHeight=Math.max(this.maxHeight,C)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((t,r)=>this.featuresOnBorder[t].borders[e][0]-this.featuresOnBorder[r].borders[e][0]))}splitToSubtiles(){const e=[];for(let t=0;t<this.centroidData.length;t++){const r=this.centroidData[t],o=+(r.min.y+r.max.y>Ao),s=2*o+(+(r.min.x+r.max.x>Ao)^o);for(let o=0;o<r.polygonSegLen;o++){const l=r.polygonSegIdx+o;e.push({centroidIdx:t,subtile:s,polygonSegmentIdx:l,triangleSegmentIdx:this.polygonSegments[l].triangleSegIdx})}}const t=new ll;e.sort(((e,t)=>e.triangleSegmentIdx===t.triangleSegmentIdx?e.subtile-t.subtile:e.triangleSegmentIdx-t.triangleSegmentIdx));let r=0,o=0,s=0;for(const t of e){if(t.triangleSegmentIdx!==r)break;s++}const l=e.length;for(;o!==e.length;){r=e[o].triangleSegmentIdx;let c=0,h=o,u=o;for(let t=h;t<s&&e[t].subtile===c;t++)u++;for(;h!==s;){const o=e[h];c=o.subtile;const l=this.centroidData[o.centroidIdx].min.clone(),d=this.centroidData[o.centroidIdx].max.clone(),p={vertexOffset:this.segments.segments[r].vertexOffset,primitiveOffset:t.length,vertexLength:this.segments.segments[r].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let r=h;r<u;r++){const o=e[r],s=this.polygonSegments[o.polygonSegmentIdx],c=this.centroidData[o.centroidIdx].min,h=this.centroidData[o.centroidIdx].max,u=this.indexArray.uint16;for(let e=s.triangleArrayOffset;e<s.triangleArrayOffset+s.triangleCount;e++)t.emplaceBack(u[3*e],u[3*e+1],u[3*e+2]);p.primitiveLength+=s.triangleCount,l.x=Math.min(l.x,c.x),l.y=Math.min(l.y,c.y),d.x=Math.max(d.x,h.x),d.y=Math.max(d.y,h.y)}p.primitiveLength>0&&this.triangleSubSegments.push({segment:p,min:l,max:d}),h=u;for(let t=h;t<s&&e[t].subtile===e[h].subtile;t++)u++}o=s;for(let t=o;t<l&&e[t].triangleSegmentIdx===e[o].triangleSegmentIdx;t++)s++}t._trim(),this.indexArray=t}getVisibleSegments(e,t,r){const o=new Ol;if(this.wallMode){for(const e of this.triangleSubSegments)o.segments.push(e.segment);return o}let s=0,l=0;const c=1<<e.canonical.z;if(t){const r=t.getMinMaxForTile(e);r&&(s=r.min,l=r.max)}l+=this.maxHeight;const h=e.toUnwrapped();let u;const d=[h.canonical.x/c+h.wrap,h.canonical.y/c],p=[(h.canonical.x+1)/c+h.wrap,(h.canonical.y+1)/c],f=(e,t,r)=>[e[0]*(1-r[0])+t[0]*r[0],e[1]*(1-r[1])+t[1]*r[1]],m=[],_=[];for(const e of this.triangleSubSegments){m[0]=e.min.x/Ao,m[1]=e.min.y/Ao,_[0]=e.max.x/Ao,_[1]=e.max.y/Ao;const t=f(d,p,m),c=f(d,p,_);if(0===new wc([t[0],t[1],s],[c[0],c[1],l]).intersectsPrecise(r)){u&&(o.segments.push(u),u=void 0);continue}const h=e.segment;u&&u.vertexOffset!==h.vertexOffset&&(o.segments.push(u),u=void 0),u?(u.vertexLength+=h.vertexLength,u.primitiveLength+=h.primitiveLength):u={vertexOffset:h.vertexOffset,primitiveLength:h.primitiveLength,vertexLength:h.vertexLength,primitiveOffset:h.primitiveOffset,sortKey:void 0,vaos:{}}}return u&&o.segments.push(u),o}encodeCentroid(e,t){const r=e.centroid(),o=t.span(),s=Math.min(7,Math.round(o.x*this.tileToMeter/10)),l=Math.min(7,Math.round(o.y*this.tileToMeter/10));return new Je(ct(r.x,1,8191)<<3|s,ct(r.y,1,8191)<<3|l)}encodeBorderCentroid(e){if(!e.borders)return new Je(0,0);const t=e.borders,r=Number.MAX_VALUE;if(t[0][0]!==r||t[1][0]!==r){const e=t[0][0]!==r?0:1;return new Je(6|(t[0][0]!==r?0:65528),(t[e][0]+t[e][1])/2<<3|6)}{const e=t[2][0]!==r?2:3;return new Je((t[e][0]+t[e][1])/2<<3|6,6|(t[2][0]!==r?0:65528))}}showCentroid(e){const t=this.centroidData[e.centroidDataIndex];t.flags&=2147483647,t.centroidXY.x=0,t.centroidXY.y=0,this.writeCentroidToBuffer(t)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const t=e.vertexArrayOffset,r=e.vertexCount+e.vertexArrayOffset,o=e.flags&B_?F_:e.centroidXY,s=this.centroidVertexArray.geta_centroid_pos0(t);if(this.centroidVertexArray.geta_centroid_pos1(t)!==o.y||s!==o.x){for(let e=t;e<r;++e)this.centroidVertexArray.emplace(e,o.x,o.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,t,r){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const o=t.getReplacementRegionsForTile(e.toUnwrapped());if(w_(this.activeReplacements,o))return;if(this.activeReplacements=o,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const e of this.centroidData)e.flags&=2147483647;const s=[];for(const t of this.activeReplacements){if(t.order<r)continue;const o=Math.max(1,Math.pow(2,t.footprintTileId.canonical.z-e.canonical.z));if(t.footprint.buildingIds)for(const e of this.centroidData)e.flags&B_||t.min.x>e.max.x||e.min.x>t.max.x||t.min.y>e.max.y||e.min.y>t.max.y||t.footprint.buildingIds.has(e.buildingId)&&(e.flags|=B_);else for(const r of this.centroidData)if(!(r.flags&B_||t.min.x>r.max.x||r.min.x>t.max.x||t.min.y>r.max.y||r.min.y>t.max.y))for(let l=0;l<r.footprintSegLen;l++){const c=this.footprintSegments[r.footprintSegIdx+l];if(s.length=0,ag(this.footprintVertices,c.vertexOffset,c.vertexCount,t.footprintTileId.canonical,e.canonical,s),I_(t.footprint,s,this.footprintIndices.uint16,c.indexOffset,c.indexCount,-c.vertexOffset,-o)){r.flags|=B_;break}}}for(const e of this.centroidData)this.writeCentroidToBuffer(e);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,t,r){let o=!1;for(let s=0;s<r.footprintSegLen;s++){const l=this.footprintSegments[r.footprintSegIdx+s];let c=0;for(const r of l.ringIndices){for(let s=c,h=r+c-1;s<r+c;h=s++){const r=this.footprintVertices.int16[2*(s+l.vertexOffset)+0],c=this.footprintVertices.int16[2*(s+l.vertexOffset)+1],u=this.footprintVertices.int16[2*(h+l.vertexOffset)+1];c>t!=u>t&&e<(this.footprintVertices.int16[2*(h+l.vertexOffset)+0]-r)*(t-c)/(u-c)+r&&(o=!o)}c=r}}return o}getHeightAtTileCoord(e,t){let r=Number.NEGATIVE_INFINITY,o=!0;const s=4*(e+Ao)*Ao+(t+Ao);if(this.partLookup.hasOwnProperty(s)){const e=this.partLookup[s];return e?{height:e.height,hidden:!!(e.flags&B_)}:void 0}for(const l of this.centroidData)e>l.max.x||l.min.x>e||t>l.max.y||l.min.y>t||l.height<=r||this.footprintContainsPoint(e,t,l)&&(r=l.height,this.partLookup[s]=l,o=!!(l.flags&B_));if(r!==Number.NEGATIVE_INFINITY)return{height:r,hidden:o};this.partLookup[s]=void 0}}function X_(e,t){const r=e.add(t)._unit();return e.x*r.x+e.y*r.y}function Q_(e,t,r,o){const s=t.sub(e)._perp()._unit(),l=r.sub(t)._perp()._unit();return K_(e,t,r,X_(s,l),o)}function K_(e,t,r,o,s){const l=Math.sqrt(1-o*o);return Math.min(e.dist(t)/3,t.dist(r)/3,s*l/o)}function eg(e,t,r){return e.x<r[0].x&&t.x<r[0].x||e.x>r[1].x&&t.x>r[1].x||e.y<r[0].y&&t.y<r[0].y||e.y>r[1].y&&t.y>r[1].y}function tg(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function ig(e){return e.every((e=>e.x<=0))||e.every((e=>e.x>=Ao))||e.every((e=>e.y<=0))||e.every((e=>e.y>=Ao))}function rg(e,t,r){if(e.x<0||e.x>=Ao||t.x<0||t.x>=Ao||r.x<0||r.x>=Ao)return!1;const o=r.sub(t),s=o.perp(),l=e.sub(t);return(o.x*l.x+o.y*l.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(l.x*l.x+l.y*l.y))>-.866&&s.x*l.x+s.y*l.y<0}function ng(e,t,r){const o=t?2|e:-3&e;return r?1|o:-2&o}function og(){const e=Math.PI/32,t=Math.tan(e),r=bd;return r*Math.sqrt(1+2*t*t)-r}function sg(e,t,r){const o=1<<r.z,s=Pd(r.x/o),l=Pd((r.x+1)/o),c=Cd(r.y/o),h=Cd((r.y+1)/o);return function(e,t,r,o,s=0,l){const c=[];if(!e.length||!r||!o)return c;const h=(e,t)=>{for(const r of e)c.push({polygon:r,bounds:t})},u=Math.ceil(Math.log2(r)),d=Math.ceil(Math.log2(o)),p=u-d,f=[];for(let e=0;e<Math.abs(p);e++)f.push(p>0?0:1);for(let e=0;e<Math.min(u,d);e++)f.push(0),f.push(1);let m=e;if(m=Jm(m,t[0].y-s,t[1].y+s,1),m=Jm(m,t[0].x-s,t[1].x+s,0),!m.length)return c;const _=[];for(f.length?_.push({polygons:m,bounds:t,depth:0}):h(m,t);_.length;){const e=_.pop(),t=e.depth,r=f[t],o=e.bounds[0],c=e.bounds[1],u=0===r?o.x:o.y,d=0===r?c.x:c.y,p=l?l(r,u,d):.5*(u+d),m=Jm(e.polygons,u-s,p+s,r),v=Jm(e.polygons,p-s,d+s,r);if(m.length){const e=[o,new Je(0===r?p:c.x,1===r?p:c.y)];f.length>t+1?_.push({polygons:m,bounds:e,depth:t+1}):h(m,e)}if(v.length){const e=[new Je(0===r?p:o.x,1===r?p:o.y),c];f.length>t+1?_.push({polygons:v,bounds:e,depth:t+1}):h(v,e)}}return c}(e,t,Math.ceil((l-s)/11.25),Math.ceil((c-h)/11.25),1,((e,t,s)=>{if(0===e)return.5*(t+s);{const e=Cd((r.y+t/Ao)/o);return(Ed(.5*(Cd((r.y+s/Ao)/o)+e))*o-r.y)*Ao}}))}function ag(e,t,r,o,s,l){const c=Math.pow(2,o.z-s.z);for(let h=0;h<r;h++){let r=e.int16[2*(h+t)+0],u=e.int16[2*(h+t)+1];r=(r+s.x*Ao)*c-o.x*Ao,u=(u+s.y*Ao)*c-o.y*Ao,l.push(new Je(r,u))}}let lg,cg;ih(mf,"FillExtrusionBucket",{omit:["layers","features"]}),ih(uf,"PartData"),ih(lf,"FootprintSegment"),ih(cf,"BorderCentroidData"),ih(ff,"GroundEffect");class Bf extends Je{constructor(e,t,r){super(e,t),this.z=r}}class kf extends Bf{constructor(e,t,r,o){super(e,t,r),this.w=o}}function ug(e,t,r,o){const s="x"===r?"y":"x",l=(o-e[r])/(t[r]-e[r]);e[s]=Math.round(e[s]+(t[s]-e[s])*l),e[r]=o,e.hasOwnProperty("z")&&(e.z=Ar(e.z,t.z,l)),e.hasOwnProperty("w")&&(e.w=Ar(e.w,t.w,l))}function dg(e,t,r,o){const s=r,l=o;for(const r of["x","y"]){let o=e,c=t;o[r]>=c[r]&&(o=t,c=e),o[r]<s&&c[r]>s&&ug(o,c,r,s),o[r]<l&&c[r]>l&&ug(c,o,r,l)}}function pg(e,t,r,o,s,l){const c=[];for(let h=0;h<e.length;h++){const u=e[h];let d;const p=c.length;let f=0;for(let e=0;e<u.length-1;e++){let p=u[e],m=u[e+1],_=0;const v=f;let E,P;l&&(_=Math.hypot(m.x-p.x,m.y-p.y),f+=_,E=p,P=m),p.x<t&&m.x<t||(p.x<t?p=new Je(t,p.y+(t-p.x)/(m.x-p.x)*(m.y-p.y))._round():m.x<t&&(m=new Je(t,p.y+(t-p.x)/(m.x-p.x)*(m.y-p.y))._round()),p.y<r&&m.y<r||(p.y<r?p=new Je(p.x+(r-p.y)/(m.y-p.y)*(m.x-p.x),r)._round():m.y<r&&(m=new Je(p.x+(r-p.y)/(m.y-p.y)*(m.x-p.x),r)._round()),p.x>=o&&m.x>=o||(p.x>=o?p=new Je(o,p.y+(o-p.x)/(m.x-p.x)*(m.y-p.y))._round():m.x>=o&&(m=new Je(o,p.y+(o-p.x)/(m.x-p.x)*(m.y-p.y))._round()),p.y>=s&&m.y>=s||(p.y>=s?p=new Je(p.x+(s-p.y)/(m.y-p.y)*(m.x-p.x),s)._round():m.y>=s&&(m=new Je(p.x+(s-p.y)/(m.y-p.y)*(m.x-p.x),s)._round()),d&&p.equals(d[d.length-1])||(d=[p],c.push(d),l&&l.push({progress:{min:v+mg(E,P,p)*_,max:1},parentIndex:h,prevPoint:E,nextPoint:P})),d.push(m),l&&(l[l.length-1].progress.max=v+mg(E,P,m)*_,l[l.length-1].nextPoint=P)))))}if(l&&f>0)for(let e=p;e<c.length;e++)l[e].progress.min/=f,l[e].progress.max/=f}return c}function fg(e,t,r,o,s){if(e.length<2)return void o.push(e);const l=[];for(;t.valid();){const[r,o]=t.get();for(let t=0;t<e.length-1;t++){const s=e[t],c=e[t+1],h=up(s,c,r,o);if(h){const[e]=h,r=new Je(Ar(s.x,c.x,e),Ar(s.y,c.y,e));l.push({t:t+e,distance:0,point:r})}}t.next()}if(0===l.length)return void o.push(e);l.sort(((e,t)=>e.t-t.t));let c=0,h=0,u=[];for(o.push(u);c!==e.length;){if(h===l.length){for(;c!==e.length;)0!==u.length&&u[u.length-1].equals(e[c])||u.push(e[c]),c++;break}l[h].t<=c?(0!==u.length&&u[u.length-1].equals(l[h].point)||u.push(l[h].point),Math.trunc(l[h].t),h++):(0!==u.length&&u[u.length-1].equals(e[c])||u.push(e[c]),c++)}}function mg(e,t,r){return e.x!==t.x?(r.x-e.x)/(t.x-e.x):e.y!==t.y?(r.y-e.y)/(t.y-e.y):0}function _g(e,t){return e.x*t.x+e.y*t.y}function gg(e,t){if(1===e.length){let r=0;const o=t[r++];let s;for(;!s||o.equals(s);)if(s=t[r++],!s)return 1/0;for(;r<t.length;r++){const l=t[r],c=e[0],h=s.sub(o),u=l.sub(o),d=c.sub(o),p=_g(h,h),f=_g(h,u),m=_g(u,u),_=_g(d,h),v=_g(d,u),E=p*m-f*f,P=(m*_-f*v)/E,C=(p*v-f*_)/E,R=o.z*(1-P-C)+s.z*P+l.z*C;if(isFinite(R))return R}return 1/0}{let e=1/0;for(const r of t)e=Math.min(e,r.z);return e}}function yg(e,t,r){let o=1/0;sp(r,t)&&(o=gg(r,t[0]));for(let s=0;s<t.length;s++){const l=t[s],c=e[s];for(let e=0;e<l.length-1;e++){const t=l[e],s=[t,l[e+1],c[e+1],c[e],t];np(r,s)&&(o=Math.min(o,gg(r,s)))}}return o!==1/0&&o}function xg(e,t,r,o,s,l,c,h,u,d,p){return"globe"===e.projection.name?function(e,t,r,o,s,l,c,h,u,d,p){const f=[],m=[],_=e.projection.upVectorScale(p,e.center.lat,e.worldSize).metersToTile,v=[0,0,0,1],E=[0,0,0,1],P=(e,t,r,o)=>{e[0]=t,e[1]=r,e[2]=o,e[3]=1},C=og();r>0&&(r+=C),o+=C;for(const C of t){const t=[],R=[];for(const f of C){const m=f.x+s.x,C=f.y+s.y,z=e.projection.projectTilePoint(m,C,p),D=e.projection.upVector(p,f.x,f.y);let O=r,F=o;if(c){const e=vg(m,C,r,o,c,h,u,d);O+=e.base,F+=e.top}0!==r?P(v,z.x+D[0]*_*O,z.y+D[1]*_*O,z.z+D[2]*_*O):P(v,z.x,z.y,z.z),P(E,z.x+D[0]*_*F,z.y+D[1]*_*F,z.z+D[2]*_*F),se(v,v,l),se(E,E,l),t.push(new Bf(v[0],v[1],v[2])),R.push(new Bf(E[0],E[1],E[2]))}f.push(t),m.push(R)}return[f,m]}(e,t,r,o,s,l,c,h,u,d,p):c?function(e,t,r,o,s,l,c,h,u){const d=[],p=[],f=[0,0,0,1];for(const m of e){const e=[],_=[];for(const d of m){const p=d.x+o.x,m=d.y+o.y,v=vg(p,m,t,r,l,c,h,u);f[0]=p,f[1]=m,f[2]=v.base,f[3]=1,xe(f,f,s),f[3]=Math.max(f[3],1e-5);const E=new Bf(f[0]/f[3],f[1]/f[3],f[2]/f[3]);f[0]=p,f[1]=m,f[2]=v.top,f[3]=1,xe(f,f,s),f[3]=Math.max(f[3],1e-5);const P=new Bf(f[0]/f[3],f[1]/f[3],f[2]/f[3]);e.push(E),_.push(P)}d.push(e),p.push(_)}return[d,p]}(t,r,o,s,l,c,h,u,d):function(e,t,r,o,s){const l=[],c=[],h=s[8]*t,u=s[9]*t,d=s[10]*t,p=s[11]*t,f=s[8]*r,m=s[9]*r,_=s[10]*r,v=s[11]*r;for(const t of e){const e=[],r=[];for(const l of t){const t=l.x+o.x,c=l.y+o.y,E=s[0]*t+s[4]*c+s[12],P=s[1]*t+s[5]*c+s[13],C=s[2]*t+s[6]*c+s[14],R=s[3]*t+s[7]*c+s[15],z=E+h,D=P+u,O=C+d,F=Math.max(R+p,1e-5),B=E+f,k=P+m,V=C+_,N=Math.max(R+v,1e-5);e.push(new Bf(z/F,D/F,O/F)),r.push(new Bf(B/N,k/N,V/N))}l.push(e),c.push(r)}return[l,c]}(t,r,o,s,l)}function vg(e,t,r,o,s,l,c,h){const u=c*s.getElevationAt(e,t,!0,!0),d=0!==l[0],p=d?0===l[1]?c*(l[0]/7-450):c*function(e,t,r){const o=Math.floor(t[0]/8),s=Math.floor(t[1]/8),l=10*(t[0]-8*o),c=10*(t[1]-8*s),h=e.getElevationAt(o,s,!0,!0),u=e.getMeterToDEM(r),d=Math.floor(.5*(l*u-1)),p=Math.floor(.5*(c*u-1)),f=e.tileCoordToPixel(o,s),m=2*d+1,_=2*p+1,v=function(e,t,r,o,s){return[e.getElevationAtPixel(t,r,!0),e.getElevationAtPixel(t+s,r,!0),e.getElevationAtPixel(t,r+s,!0),e.getElevationAtPixel(t+o,r+s,!0)]}(e,f.x-d,f.y-p,m,_),E=Math.abs(v[0]-v[1]),P=Math.abs(v[2]-v[3]),C=Math.abs(v[0]-v[2])+Math.abs(v[1]-v[3]),R=Math.min(.25,.5*u*(E+P)/m),z=Math.min(.25,.5*u*C/_);return h+Math.max(R*l,z*c)}(s,l,h):u;return{base:u+(0===r?-1:r),top:d?Math.max(p+o,u+r+2):u+o}}class Nf{constructor(e){this._callback=e,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class jf{constructor(){this.tasks={},this.taskQueue=[],vt(["process"],this),this.invoker=new Nf(this.process),this.nextId=0}add(e,t){const r=this.nextId++,o=function({type:e,isSymbolTile:t,zoom:r}){return r=r||0,"message"===e?0:"maybePrepare"!==e||t?"parseTile"!==e||t?"parseTile"===e&&t?300-r:"maybePrepare"===e&&t?400-r:500:200-r:100-r}(t);if(0===o){try{e()}finally{}return null}return this.tasks[r]={fn:e,metadata:t,priority:o,id:r},this.taskQueue.push(r),this.invoker.trigger(),{cancel:()=>{delete this.tasks[r]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((e=>!!this.tasks[e])),!this.taskQueue.length)return;const e=this.pick();if(null===e)return;const t=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!t)return;t.fn()}finally{}}pick(){let e=null,t=1/0;for(let r=0;r<this.taskQueue.length;r++){const o=this.tasks[this.taskQueue[r]];o.priority<t&&(t=o.priority,e=r)}if(null===e)return null;const r=this.taskQueue[e];return this.taskQueue.splice(e,1),r}remove(){this.invoker.remove()}}class Gf{constructor(e,t,r){this.target=e,this.parent=t,this.mapId=r,this.callbacks={},this.cancelCallbacks={},vt(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new jf}send(e,t,r,o,s=!1,l){const c=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(r.metadata=l,this.callbacks[c]=r);const h=new Set;return this.target.postMessage({id:c,type:e,hasCallback:!!r,targetMapId:o,mustQueue:s,sourceMapId:this.mapId,data:nh(t,h)},h),{cancel:()=>{r&&delete this.callbacks[c],this.target.postMessage({id:c,type:"<cancel>",targetMapId:o,sourceMapId:this.mapId})}}}receive(e){const t=e.data;if(!t)return;const r=t.id;if(r&&(!t.targetMapId||this.mapId===t.targetMapId))if("<cancel>"===t.type){const e=this.cancelCallbacks[r];delete this.cancelCallbacks[r],e&&e.cancel()}else if(t.mustQueue||Dt(self)){const e=this.callbacks[r],o=this.scheduler.add((()=>this.processTask(r,t)),e&&e.metadata||{type:"message"});o&&(this.cancelCallbacks[r]=o)}else this.processTask(r,t)}processTask(e,t){if(delete this.cancelCallbacks[e],"<response>"===t.type){const r=this.callbacks[e];delete this.callbacks[e],r&&(t.error?r(oh(t.error)):r(null,oh(t.data)))}else{const r=new Set,o=t.hasCallback?(t,o)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:t?nh(t):null,data:nh(o,r)},r)}:()=>{},s=oh(t.data);if(this.parent[t.type])this.parent[t.type](t.sourceMapId,s,o);else if(this.parent.getWorkerSource){const e=t.type.split("."),{source:r,scope:l}=s;this.parent.getWorkerSource(t.sourceMapId,e[0],r,l)[e[1]](s,o)}else o(new Error(`Could not find function ${t.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var bg={workerUrl:"",workerClass:null,workerParams:void 0};function wg(e){return null!=bg.workerClass?new bg.workerClass:new self.Worker(bg.workerUrl,Object.assign({name:e},bg.workerParams))}const Tg="mapboxgl_preloaded_worker_pool";class Hf{constructor(e){this.active={},this.name=e}acquire(e,t=Hf.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<t;){const t=wg(`${this.name||""}WorkerPool: ${e}-${this.workers.length}`);this.workers.push(t)}return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&0===this.numActive()&&(this.workers.forEach((e=>{e.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Tg]}numActive(){return Object.keys(this.active).length}}Hf.workerCount=2;class Zf{constructor(e,t,r="Worker",o=Hf.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=yt();const s=this.workerPool.acquire(this.id,o);for(let e=0;e<s.length;e++){const o=new Zf.Actor(s[e],t,this.id);o.name=`${r} ${e}`,this.actors.push(o)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,t,r){_t(this.actors,((r,o)=>{r.send(e,t,o)}),r=r||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Sg,Ig;function Eg(){return Sg||(Sg=new Hf),Sg}Zf.Actor=Gf;const Ag=4096;class Qf{constructor(e){this.module=e,this.memoryStack=this.module.malloc(Ag),this.memoryStackNextFree=this.memoryStack}createIntArray(e){const t=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Int32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>Ag?-1:(new Int32Array(this.module.heap32.buffer,t,e.length).set(e),t)}createFloatArray(e){const t=this.memoryStackNextFree;return this.memoryStackNextFree+=e.length*Float32Array.BYTES_PER_ELEMENT,this.memoryStackNextFree-this.memoryStack>Ag?-1:(new Float32Array(this.module.heapF32.buffer,t,e.length).set(e),t)}readStringBuffer(e){let t="";for(;0!==this.module.heapU8[e];)t+=String.fromCharCode(this.module.heapU8[e]),++e;return t}setStyle(e){const t=e.normalScale;this.module.setStyle(t[0],t[1],t[2],e.tileToMeters)}setAOOptions(e,t){this.module.setAOOptions(e?1:0,t)}setMetricOptions(e,t){this.module.setMetricOptions(e?1:0,t)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,t){this.module.setFacadeOptions(e,t?1:0)}setFauxFacadeOptions(e,t,r){this.module.setFauxFacadeOptions(e?1:0,t?1:0,r)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,t){this.memoryStackNextFree=this.memoryStack;for(const t of e){const e=this.createIntArray(t.ringIndices),r=this.createFloatArray(t.coordinates);if(-1===e||-1===r)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFeature(t.id,t.sourceId,t.minHeight,t.height,t.roofType,r,e,t.ringIndices.length-1)}for(const e of t){let t;t=e.entrances?JSON.parse(e.entrances):[];const r=this.createFloatArray(t),o=this.createFloatArray(e.coordinates);if(-1===r||-1===o)return`building_gen: Out of stack memory: ${this.memoryStackNextFree-this.memoryStack}/4096`;this.module.addFacade(e.sourceId,e.crossPerc,e.distanceToRoad,r,t.length,o,e.coordinates.length)}if(!this.module.generateMesh()){const e=this.module.getLastError();return this.readStringBuffer(e)}const r=this.module.getMeshCount(),o=new Array(r);for(let e=0;e<r;e++){const t=this.module.getPositionsPtr(e),r=this.module.getPositionsLength(e),s=new Float32Array(this.module.heapF32.buffer,t,r),l=this.module.getNormalsPtr(e),c=this.module.getNormalsLength(e),h=new Float32Array(this.module.heapF32.buffer,l,c),u=this.module.getAOPtr(e),d=this.module.getAOLength(e),p=new Float32Array(this.module.heapF32.buffer,u,d),f=this.module.getUVPtr(e),m=this.module.getUVLength(e),_=new Float32Array(this.module.heapF32.buffer,f,m),v=this.module.getFauxFacadePtr(e),E=this.module.getFauxFacadeLength(e),P=new Uint8Array(this.module.heapU8.buffer,v,E),C=this.module.getIndicesPtr(e),R=this.module.getIndicesLength(e),z=new Int16Array(this.module.heap16.buffer,C,R),D=this.module.getBuildingPart(e);o[e]={positions:s,normals:h,ao:p,uv:_,isFauxFacade:P,indices:z,buildingPart:D}}const s=this.module.getRingCount(),l=[];for(let e=0;e<s;e++){const t=this.module.getRingPtr(e),r=this.module.getRingLength(e),o=new Float32Array(this.module.heapF32.buffer,t,r);l.push(o)}return{meshes:o,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:l}}}let Mg,Pg,Cg,Rg,zg,Dg=null,Lg=null,Og=null,Fg=null;function Bg(){return Dt(self)&&self.worker.dracoUrl?self.worker.dracoUrl:Pg||qt.DRACO_URL}function kg(){if(Dt(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Rg)return Rg;const e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Rg=WebAssembly.validate(e)?qt.MESHOPT_SIMD_URL:qt.MESHOPT_URL,Rg}function Vg(){return Fg}const Ng=5120,Ug=5121,jg=5122,Gg=5123,$g=5125,qg=5126,Hg={[Ng]:Int8Array,[Ug]:Uint8Array,[jg]:Int16Array,[Gg]:Uint16Array,[$g]:Uint32Array,[qg]:Float32Array},Xg={[Ng]:"DT_INT8",[Ug]:"DT_UINT8",[jg]:"DT_INT16",[Gg]:"DT_UINT16",[$g]:"DT_UINT32",[qg]:"DT_FLOAT32"},Yg={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Jg(e,t,r){const o=r.json.bufferViews.length,s=r.buffers.length;t.bufferView=o,r.json.bufferViews[o]={buffer:s,byteLength:e.byteLength},r.buffers[s]=e}const Qg="KHR_draco_mesh_compression";function Kg(e,t){const r=e.extensions&&e.extensions[Qg];if(!r)return;const o=new Cg.Decoder,s=ay(t,r.bufferView),l=new Cg.Mesh;if(!o.DecodeArrayToMesh(s,s.byteLength,l))throw new Error("Failed to decode Draco mesh");const c=t.json.accessors[e.indices],h=Hg[c.componentType],u=c.count*h.BYTES_PER_ELEMENT,d=Cg._malloc(u);h===Uint16Array?o.GetTrianglesUInt16Array(l,u,d):o.GetTrianglesUInt32Array(l,u,d),Jg(Cg.memory.buffer.slice(d,d+u),c,t),Cg._free(d);for(const s of Object.keys(r.attributes)){const c=o.GetAttributeByUniqueId(l,r.attributes[s]),h=t.json.accessors[e.attributes[s]],u=Xg[h.componentType],d=h.count*Yg[h.type]*Hg[h.componentType].BYTES_PER_ELEMENT,p=Cg._malloc(d);o.GetAttributeDataArrayForAllPoints(l,c,Cg[u],d,p),Jg(Cg.memory.buffer.slice(p,p+d),h,t),Cg._free(p)}o.destroy(),l.destroy(),delete e.extensions[Qg]}const ey="EXT_meshopt_compression";function ty(e,t){if(!e.extensions||!e.extensions[ey])return;const r=e.extensions[ey],o=new Uint8Array(t.buffers[r.buffer],r.byteOffset||0,r.byteLength||0),s=new Uint8Array(r.count*r.byteStride);zg.decodeGltfBuffer(s,r.count,r.byteStride,o,r.mode,r.filter),e.buffer=t.buffers.length,e.byteOffset=0,t.buffers[e.buffer]=s.buffer,delete e.extensions[ey]}const ry=1179937895,ny=new TextDecoder("utf8");function oy(e,t){return new URL(e,t).href}function sy(e,t,r,o){return fetch(oy(e.uri,o)).then((e=>e.arrayBuffer())).then((e=>{t.buffers[r]=e}))}function ay(e,t){const r=e.json.bufferViews[t];return new Uint8Array(e.buffers[r.buffer],r.byteOffset||0,r.byteLength)}function ly(e,t,r,o){if(e.uri){const s=oy(e.uri,o);return fetch(s).then((e=>e.blob())).then((e=>createImageBitmap(e))).then((e=>{t.images[r]=e}))}if(void 0!==e.bufferView){const o=ay(t,e.bufferView),s=new Blob([o],{type:e.mimeType});return createImageBitmap(s).then((e=>{t.images[r]=e}))}}function cy(e,t=0,r){const o={json:null,images:[],buffers:[]};if(new Uint32Array(e,t,1)[0]===ry){const r=new Uint32Array(e,t);let s=2;const l=(r[s++]>>2)-3,c=r[s++]>>2;if(s++,o.json=JSON.parse(ny.decode(r.subarray(s,s+c))),s+=c,s<l){const l=r[s++];s++;const c=t+(s<<2);o.buffers[0]=e.slice(c,c+l)}}else o.json=JSON.parse(ny.decode(new Uint8Array(e,t)));const{buffers:s,images:l,meshes:c,extensionsUsed:h,bufferViews:u}=o.json;let d=Promise.resolve();if(s){const e=[];for(let t=0;t<s.length;t++){const l=s[t];l.uri?e.push(sy(l,o,t,r)):o.buffers[t]||(o.buffers[t]=null)}d=Promise.all(e)}return d.then((()=>{const e=[],t=h&&h.includes(Qg),s=h&&h.includes(ey);if(t&&e.push(function(){if(!Cg)return null!=Mg?Mg:(Mg=function(e){let t,r=null;function o(){t=new Uint8Array(r.buffer)}function s(){throw new Error("Unexpected Draco error.")}const l={a:{a:s,d:function(e,r,o){return t.copyWithin(e,r,r+o)},c:function(e){const s=t.length,l=Math.max(e>>>0,Math.ceil(1.2*s)),c=Math.ceil((l-s)/65536);try{return r.grow(c),o(),!0}catch(e){return!1}},b:s}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(e,l):e.then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,l)))).then((e=>{const{Rb:s,Qb:l,P:c,T:h,X:u,Ja:d,La:p,Qa:f,Va:m,Wa:_,eb:v,jb:E,f:P,e:C,yb:R,zb:z,Ab:D,Bb:O,Db:F,Gb:B}=e.instance.exports;r=C;const k=(()=>{let e=0,r=0,o=0,c=0;return h=>{o&&(s(c),s(e),r+=o,o=e=0),e||(r+=128,e=l(r));const u=h.length+7&-8;let d=e;u>=r&&(o=u,d=c=l(u));for(let e=0;e<h.length;e++)t[d+e]=h[e];return d}})();return o(),P(),{memory:C,_free:s,_malloc:l,Mesh:class{constructor(){this.ptr=c()}destroy(){h(this.ptr)}},Decoder:class{constructor(){this.ptr=d()}destroy(){E(this.ptr)}DecodeArrayToMesh(e,t,r){const o=k(e),s=p(this.ptr,o,t,r.ptr);return!!u(s)}GetAttributeByUniqueId(e,t){return{ptr:f(this.ptr,e.ptr,t)}}GetTrianglesUInt16Array(e,t,r){m(this.ptr,e.ptr,t,r)}GetTrianglesUInt32Array(e,t,r){_(this.ptr,e.ptr,t,r)}GetAttributeDataArrayForAllPoints(e,t,r,o,s){v(this.ptr,e.ptr,t.ptr,r,o,s)}},DT_INT8:R(),DT_UINT8:z(),DT_INT16:D(),DT_UINT16:O(),DT_UINT32:F(),DT_FLOAT32:B()}}))}(fetch(Bg())),Mg.then((e=>{Cg=e,Mg=void 0})))}()),s&&e.push(function(){if(zg)return;const e=function(e){let t;const r=WebAssembly.instantiateStreaming(e,{}).then((e=>{t=e.instance,t.exports.__wasm_call_ctors()})),o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},s={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:r,supported:!0,decodeGltfBuffer(e,r,l,c,h,u){!function(e,t,r,o,s,l,c){const h=e.exports.sbrk,u=o+3&-4,d=h(u*s),p=h(l.length),f=new Uint8Array(e.exports.memory.buffer);f.set(l,p);const m=t(d,o,s,p,l.length);if(0===m&&c&&c(d,u,s),r.set(f.subarray(d,d+o*s)),h(d-h(0)),0!==m)throw new Error(`Malformed buffer data: ${m}`)}(t,t.exports[s[h]],e,r,l,c,t.exports[o[u]])}}}(fetch(kg()));return e.ready.then((()=>{zg=e}))}()),l)for(let t=0;t<l.length;t++)e.push(ly(l[t],o,t,r));return(e.length?Promise.all(e):Promise.resolve()).then((()=>{if(t&&c)for(const{primitives:e}of c)for(const t of e)Kg(t,o);if(s&&c&&u)for(const e of u)ty(e,o);return o}))}))}function hy(e){return fetch(e).then((e=>e.arrayBuffer())).then((t=>cy(t,0,e)))}function uy(e){switch(e){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function dy(e){switch(e){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Cm{constructor(e,t,r,o){this.context=e,this.format=r,this.useMipmap=o&&o.useMipmap,this.texture=e.gl.createTexture(),this.update(t,{premultiply:o&&o.premultiply})}update(e,t){const r=e&&e instanceof HTMLVideoElement&&0===e.width?e.videoWidth:e.width,o=e&&e instanceof HTMLVideoElement&&0===e.height?e.videoHeight:e.height,{context:s}=this,{gl:l}=s,{x:c,y:h}=t&&t.position?t.position:{x:0,y:0},u=c+r,d=h+o;!this.size||this.size[0]===u&&this.size[1]===d||(l.bindTexture(l.TEXTURE_2D,null),l.deleteTexture(this.texture),this.texture=l.createTexture(),this.size=null),l.bindTexture(l.TEXTURE_2D,this.texture),s.pixelStoreUnpackFlipY.set(!1),s.pixelStoreUnpack.set(1),s.pixelStoreUnpackPremultiplyAlpha.set(this.format===l.RGBA8&&(!t||!1!==t.premultiply));const p=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&u>0&&d>0){const e=this.useMipmap?Math.floor(Math.log2(Math.max(u,d)))+1:1;l.texStorage2D(l.TEXTURE_2D,e,this.format,u,d),this.size=[u,d]}this.size&&(p?l.texSubImage2D(l.TEXTURE_2D,0,c,h,uy(this.format),dy(this.format),e):"data"in e&&e.data&&l.texSubImage2D(l.TEXTURE_2D,0,c,h,r,o,uy(this.format),dy(this.format),e.data)),this.useMipmap&&l.generateMipmap(l.TEXTURE_2D)}bind(e,t,r=!1){const{context:o}=this,{gl:s}=o;s.bindTexture(s.TEXTURE_2D,this.texture),e!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,e),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this.useMipmap&&!r?e===s.NEAREST?s.NEAREST_MIPMAP_NEAREST:s.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),t!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,t),this.wrapS=t)}bindExtraParam(e,t,r,o,s){const{context:l}=this,{gl:c}=l;c.bindTexture(c.TEXTURE_2D,this.texture),t!==this.magFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,t),this.magFilter=t),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,this.useMipmap?e===c.NEAREST?c.NEAREST_MIPMAP_NEAREST:c.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),r!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,r),this.wrapS=r),o!==this.wrapT&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,o),this.wrapT=o),s!==this.compareMode&&(s?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_COMPARE_FUNC,s)):c.texParameteri(c.TEXTURE_2D,c.TEXTURE_COMPARE_MODE,c.NONE),this.compareMode=s)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Rm{constructor(e,t){this.context=e,this.texture=t}bind(e,t){const{context:r}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_2D,this.texture),e!==this.minFilter&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,e),this.minFilter=e),t!==this.wrapS&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,t),this.wrapS=t)}}const py=Uu([{name:"a_pos_3f",components:3,type:"Float32"}]),fy=Uu([{name:"a_color_3f",components:3,type:"Float32"}]),my=Uu([{name:"a_color_4f",components:4,type:"Float32"}]),_y=Uu([{name:"a_uv_2f",components:2,type:"Float32"}]),gy=Uu([{name:"a_normal_3f",components:3,type:"Float32"}]),yy=Uu([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),xy=Uu([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function vy(e,t){const r=wy(e.projection,e.zoom,e.width,e.height),o=function(e,t,r,o,s){const l=new Bu(r.lng-180*Ty,r.lat),c=new Bu(r.lng+180*Ty,r.lat),h=e.project(l.lng,l.lat),u=e.project(c.lng,c.lat),d=-Math.atan2(u.y-h.y,u.x-h.x),f=Gu.fromLngLat(r);f.y=ct(f.y,-1+Ty,1-Ty);const _=f.toLngLat(),E=e.project(_.lng,_.lat),P=Gu.fromLngLat(_);P.x+=Ty;const R=P.toLngLat(),z=e.project(R.lng,R.lat),D=Iy(z.x-E.x,z.y-E.y,d),O=Gu.fromLngLat(_);O.y+=Ty;const F=O.toLngLat(),B=e.project(F.lng,F.lat),k=Iy(B.x-E.x,B.y-E.y,d),V=Math.abs(D.x)/Math.abs(k.y),N=p([]);C(N,N,-d*(1-(s?0:o)));const U=p([]);return v(U,U,[1,1-(1-V)*o,1]),U[4]=-k.x/k.y*o,C(U,U,d),m(U,N,U),U}(e.projection,0,e.center,r,t),s=by(e);return v(o,o,[s,s,1]),o}function by(e){const t=e.projection,r=wy(e.projection,e.zoom,e.width,e.height),o=Sy(t,e.center),s=Sy(t,Bu.convert(t.center));return Math.pow(2,o*r+(1-r)*s)}function wy(e,t,r,o,s=1/0){const l=e.range;if(!l)return 0;const c=Math.min(s,Math.max(r,o)),h=Math.log2(c/1024);return ft(l[0]+h,l[1]+h,t)}const Ty=1/4e4;function Sy(e,t){const r=ct(t.lat,-85.051129,zd),o=new Bu(t.lng-180*Ty,r),s=new Bu(t.lng+180*Ty,r),l=e.project(o.lng,r),c=e.project(s.lng,r),h=Gu.fromLngLat(o),u=Gu.fromLngLat(s),d=c.x-l.x,p=c.y-l.y,f=u.x-h.x,m=u.y-h.y,_=Math.sqrt((f*f+m*m)/(d*d+p*p));return Math.log2(_)}function Iy(e,t,r){const o=Math.cos(r),s=Math.sin(r);return{x:e*o-t*s,y:e*s+t*o}}function Ey(e,t,r){p(e),C(e,e,it(t[2])),E(e,e,it(t[0])),P(e,e,it(t[1])),v(e,e,r),m(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Ay(e,t,r,o,s,l,c,h){const u=[r[0]-t[0],r[1]-t[1],0],d=[o[0]-t[0],o[1]-t[1],0];if(V(u)<1e-12||V(d)<1e-12)return be(e);const p=ne([],u,d);ie(p,p),$(d,o,t),u[2]=(l-s)*h,d[2]=(c-s)*h;const f=u;return ne(f,u,d),ie(f,f),Ce(e,p,f)}function My(e,t,r=!1){const o=rf(t.zoom),s=function(e,t,r){const o=t.worldSize,s=[e[12],e[13],e[14]],l=Cd(s[1]/o),c=Pd(s[0]/o),h=p([]),u=Ad(1,l)*o,d=Ad(1,0)*o*Ld(l,t.zoom),f=1/Kp(o);let E=d*f;if(r){const e=wy(t.projection,t.zoom,t.width,t.height,1024);E=f*t.projection.pixelSpaceConversion(t.center.lat,o,e)}const P=yd(l,c);j(P,P,Y([],ie([],P),u*E*s[2]));const C=function(e){const t=[e[0],e[1],e[2]];let r=[0,1,0];const o=ne([],r,t);return ne(r,t,o),0===ee(r)&&(r=[0,1,0],ne(o,t,r)),ie(o,o),ie(r,r),ie(t,t),[o[0],o[1],o[2],0,r[0],r[1],r[2],0,t[0],t[1],t[2],0,e[0],e[1],e[2],1]}(P);v(h,h,[E,E,E*u]),_(h,h,[-s[0],-s[1],-s[2]]);const R=m([],t.globeMatrix,C);return m(R,R,h),m(R,R,e),R}(e,t,r);if(o>0){const r=function(e,t){const r=t.worldSize,o=Ad(1,0)*r*Ld(t.center.lat,t.zoom)/Kp(r),s=Ad(1,t.center.lat)*r,l=p([]);P(l,l,it(t.center.lng)),E(l,l,it(t.center.lat)),_(l,l,[0,0,dd]),v(l,l,[o,o,o*s]);const c=t.point;return _(l,l,[-c.x,-c.y,0]),m(l,l,e),m(l,t.globeMatrix,l)}(e,t);return function(e,t,r){const o=(e,t,r)=>{const o=V(e),s=V(t),l=jp(e,t,r);return Y(l,l,1/V(l)*Ar(o,s,r))},s=o([e[0],e[1],e[2]],[t[0],t[1],t[2]],r),l=o([e[4],e[5],e[6]],[t[4],t[5],t[6]],r),c=o([e[8],e[9],e[10]],[t[8],t[9],t[10]],r),h=jp([e[12],e[13],e[14]],[t[12],t[13],t[14]],r);return[s[0],s[1],s[2],0,l[0],l[1],l[2],0,c[0],c[1],c[2],0,h[0],h[1],h[2],1]}(s,r,o)}return s}function Py(e,t,r,o){const s=wc.projectAabbCorners(o,r);let l=Number.MAX_VALUE;for(let e=0;e<s.length;++e){const r=s[e];r[0]=(.5*r[0]+.5)*t.width,r[1]=(.5-.5*r[1])*t.height,r[2]<l&&(l=r[2])}const c=function(e){const t=[];let r=0;for(let t=1;t<e.length;t++)(e[t][0]<e[r][0]||e[t][0]===e[r][0]&&e[t][1]<e[r][1])&&(r=t);let o,s=r;const l=new Uint8Array(e.length);do{if(l[s])break;t.push(new Je(e[s][0],e[s][1])),l[s]=1,o=(s+1)%e.length;for(let t=0;t<e.length;t++){if(e[t][0]===e[o][0]&&e[t][1]===e[o][1]||e[t][0]===e[s][0]&&e[t][1]===e[s][1])continue;const r=[e[t][0]-e[s][0],e[t][1]-e[s][1]],l=[e[o][0]-e[s][0],e[o][1]-e[s][1]],c=r[0]*l[1]-r[1]*l[0];(c>0||0===c&&r[0]*l[0]+r[1]*l[1]>=0&&r[0]*r[0]+r[1]*r[1]>l[0]*l[0]+l[1]*l[1])&&(o=t)}s=o}while(s!==r);return t.length>0&&t.push(t[0]),t}(s);if(np(e,c))return l}const zy=64,Ly={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Oy(e,t,r,o,s,l,c,h,u,d=!1){const f=r.zoom,E=r.project(o),P=Ld(o.lat,f),C=1/P;p(e),_(e,e,[E.x+c[0]*C,E.y+c[1]*C,c[2]]);let R=1,z=1;const D=r.worldSize;if(d){if("mercator"===r.projection.name){let e=0;r.elevation&&(e=r.elevation.getAtPointOrZero(new Gu(E.x/D,E.y/D),0));const t=xe([],[E.x,E.y,e,1],r.projMatrix)[3]/r.cameraToCenterDistance;R=t,z=t*Ld(r.center.lat,f)}else if("globe"===r.projection.name){const t=My(e,r),s=[0,0,0,1];xe(s,s,m([],r.projMatrix,t));const l=s[3]/r.cameraToCenterDistance,c=rf(f),h=r.projection.pixelsPerMeter(o.lat,D)*Ld(o.lat,f),u=r.projection.pixelsPerMeter(r.center.lat,D)*Ld(r.center.lat,f);R=l/Ar(h,Dd(r.center.lat),c),z=l*P/h,R*=u,z*=u}}else R=C;v(e,e,[R,R,z]);const F=[...e],B=t.orientation,k=[];if(Ey(k,[B[0]+(s?s[0]:0),B[1]+(s?s[1]:0),B[2]+(s?s[2]:0)],l),m(e,F,k),h&&r.elevation){let s=0;const l=[];if(u&&r.elevation){s=function(e,t,r,o,s){const l=t.elevation;if(!l)return 0;const c=wc.projectAabbCorners(r,o),h=Ad(1,s.lat)*t.worldSize,u=function(e,t){const r=[0,0,1],o=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const s of o){const o=e[s.corners[0]],l=e[s.corners[1]],c=e[s.corners[2]],h=[l[0]-o[0],l[1]-o[1],t*(l[2]-o[2])],u=ne(h,h,[c[0]-o[0],c[1]-o[1],t*(c[2]-o[2])]);ie(u,u),s.dotProductWithUp=re(u,r)}return o.sort(((e,t)=>e.dotProductWithUp-t.dotProductWithUp)),o[0].corners}(c,h),d=c[u[0]],p=c[u[1]],f=c[u[2]],m=c[u[3]],_=l.getAtPointOrZero(new Gu(d[0]/t.worldSize,d[1]/t.worldSize),0),v=l.getAtPointOrZero(new Gu(p[0]/t.worldSize,p[1]/t.worldSize),0),E=l.getAtPointOrZero(new Gu(f[0]/t.worldSize,f[1]/t.worldSize),0),P=l.getAtPointOrZero(new Gu(m[0]/t.worldSize,m[1]/t.worldSize),0),C=(_+P)/2,R=(v+E)/2;return C>R?v<E?Ay(e,p,m,d,v,P,_,h):Ay(e,f,d,m,E,_,P,h):_<P?Ay(e,d,p,f,_,v,E,h):Ay(e,m,f,p,P,E,v,h),Math.max(C,R)}(l,r,t.aabb,e,o);const c=m([],O([],l),k);m(e,F,c)}else s=r.elevation.getAtPointOrZero(new Gu(E.x/D,E.y/D),0);0!==s&&(e[14]+=s)}}class iy{constructor(e,t,r,o,s){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=t,this.position=null!=r?new Bu(r[0],r[1]):new Bu(0,0),this.orientation=null!=o?o:[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new wc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,t){m(e.globalMatrix,t,e.localMatrix);const r=this.nodeOverrides.get(e.name);if(void 0!==r){const t=[];s=r.orientation,p(o=t),P(o,o,it(s[1])),C(o,o,it(s[2])),E(o,o,it(s[0])),m(e.globalMatrix,e.globalMatrix,t)}var o,s;if(e.meshes)for(const t of e.meshes){const r=wc.applyTransformFast(t.aabb,e.globalMatrix);this.aabb.encapsulate(r)}if(e.children)for(const t of e.children)this._applyTransformations(t,e.globalMatrix)}computeBoundsAndApplyParent(){const e=p([]);this.aabb=new wc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const t of this.nodes)this._applyTransformations(t,e)}computeModelMatrix(e,t,r,o,s,l,c=!1){Oy(this.matrix,this,e.transform,this.position,t,r,o,s,l,c)}upload(e){if(!this.uploaded){for(const t of this.nodes)ky(t,e);for(const e of this.nodes)Vy(e);this.uploaded=!0}}destroy(){for(const e of this.nodes)Uy(e)}}function Fy(e,t,r=!1){e.uploaded||(e.gfxTexture=new Cm(t,e.image,r?t.gl.R8:t.gl.RGBA8,{useMipmap:e.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),e.uploaded=!0,e.image=null)}function By(e,t,r){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,py.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,gy.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,_y.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(12===e.colorArray.bytesPerElement?fy:my).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,xy.members,!0)),e.segments=Ol.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const o=e.material;o.pbrMetallicRoughness.baseColorTexture&&Fy(o.pbrMetallicRoughness.baseColorTexture,t),o.pbrMetallicRoughness.metallicRoughnessTexture&&Fy(o.pbrMetallicRoughness.metallicRoughnessTexture,t),o.normalTexture&&Fy(o.normalTexture,t),o.occlusionTexture&&Fy(o.occlusionTexture,t,r),o.emissionTexture&&Fy(o.emissionTexture,t)}function ky(e,t,r){if(e.meshes)for(const o of e.meshes)By(o,t,r);if(e.children)for(const o of e.children)ky(o,t,r)}function Vy(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)Vy(t)}function Ny(e){e.pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()}function Uy(e){if(e.meshes)for(const t of e.meshes)t.vertexBuffer&&(t.vertexBuffer.destroy(),t.indexBuffer.destroy(),t.normalBuffer&&t.normalBuffer.destroy(),t.texcoordBuffer&&t.texcoordBuffer.destroy(),t.colorBuffer&&t.colorBuffer.destroy(),t.pbrBuffer&&t.pbrBuffer.destroy(),t.segments.destroy(),t.material&&Ny(t.material));if(e.children)for(const t of e.children)Uy(t)}function jy(e,t){const r=e.json.bufferViews[t.bufferView],o=Hg[t.componentType];return new o(e.buffers[r.buffer],(t.byteOffset||0)+(r.byteOffset||0),t.count*(r.byteStride&&r.byteStride!==Yg[t.type]*o.BYTES_PER_ELEMENT?r.byteStride/o.BYTES_PER_ELEMENT:Yg[t.type]))}function Gy(e,t,r,o){const s=Hg[t.componentType],l=function(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(s),c=e.json.bufferViews[t.bufferView],h=c.byteStride?c.byteStride/s.BYTES_PER_ELEMENT:Yg[t.type],u=r.float32,d=u.length/r.capacity;for(let e=0,r=0;e<t.count*h;e+=h,r+=d)for(let t=0;t<d;t++)u[r+t]=o[e+t]*l;r._trim()}function $y(e,t,r){const o=e.indices,s=e.attributes,l={};l.indexArray=new ll;const c=t.json.accessors[o],h=c.count/3;l.indexArray.reserve(h);const u=jy(t,c);for(let e=0;e<h;e++)l.indexArray.emplaceBack(u[3*e],u[3*e+1],u[3*e+2]);l.indexArray._trim(),l.vertexArray=new Wo;const d=t.json.accessors[s.POSITION];l.vertexArray.reserve(d.count);const p=jy(t,d);for(let e=0;e<d.count;e++)l.vertexArray.emplaceBack(p[3*e],p[3*e+1],p[3*e+2]);if(l.vertexArray._trim(),l.aabb=new wc(d.min,d.max),l.centroid=function(e,t){const r=[0,0,0],o=e.length;if(o>0){for(let s=0;s<o;s++){const o=3*e[s];r[0]+=t[o],r[1]+=t[o+1],r[2]+=t[o+2]}r[0]/=o,r[1]/=o,r[2]/=o}return r}(u,p),void 0!==s.COLOR_0){const e=t.json.accessors[s.COLOR_0],r=Yg[e.type],o=jy(t,e);l.colorArray=3===r?new Wo:new el,l.colorArray.resize(e.count),Gy(t,e,l.colorArray,o)}if(void 0!==s.NORMAL){l.normalArray=new Wo;const e=t.json.accessors[s.NORMAL];l.normalArray.resize(e.count);const r=jy(t,e);Gy(t,e,l.normalArray,r)}if(void 0!==s.TEXCOORD_0&&r.length>0){l.texcoordArray=new yl;const e=t.json.accessors[s.TEXCOORD_0];l.texcoordArray.resize(e.count);const r=jy(t,e);Gy(t,e,l.texcoordArray,r)}if(void 0!==s._FEATURE_ID_RGBA4444){const e=t.json.accessors[s._FEATURE_ID_RGBA4444];t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression")&&(l.featureData=jy(t,e))}void 0!==s._FEATURE_RGBA4444&&(l.featureData=new Uint32Array(jy(t,t.json.accessors[s._FEATURE_RGBA4444]).buffer));const f=e.material;return l.material=function(e,t){const{emissiveFactor:r=[0,0,0],alphaMode:o="OPAQUE",alphaCutoff:s=.5,normalTexture:l,occlusionTexture:c,emissiveTexture:h,doubleSided:u,name:d}=e,{baseColorFactor:p=[1,1,1,1],metallicFactor:f=1,roughnessFactor:m=1,baseColorTexture:_,metallicRoughnessTexture:v}=e.pbrMetallicRoughness||{},E=c?t[c.index]:void 0;if(c&&c.extensions&&c.extensions.KHR_texture_transform&&E){const e=c.extensions.KHR_texture_transform;E.offsetScale=[e.offset[0],e.offset[1],e.scale[0],e.scale[1]]}return{name:d,pbrMetallicRoughness:{baseColorFactor:new ur(...p),metallicFactor:f,roughnessFactor:m,baseColorTexture:_?t[_.index]:void 0,metallicRoughnessTexture:v?t[v.index]:void 0},doubleSided:u,emissiveFactor:new ur(...r),alphaMode:o,alphaCutoff:s,normalTexture:l?t[l.index]:void 0,occlusionTexture:E,emissionTexture:h?t[h.index]:void 0,defined:void 0===e.defined}}(void 0!==f?t.json.materials[f]:{defined:!1},r),l}function qy(e,t,r){const{matrix:o,rotation:s,translation:l,scale:c,mesh:h,extras:u,children:p,name:f}=e,m={};if(m.name=f,m.localMatrix=o||function(e,t,r,o){var s=t[0],l=t[1],c=t[2],h=t[3],u=s+s,d=l+l,p=c+c,f=s*u,m=s*d,_=s*p,v=l*d,E=l*p,P=c*p,C=h*u,R=h*d,z=h*p,D=o[0],O=o[1],F=o[2];return e[0]=(1-(v+P))*D,e[1]=(m+z)*D,e[2]=(_-R)*D,e[3]=0,e[4]=(m-z)*O,e[5]=(1-(f+P))*O,e[6]=(E+C)*O,e[7]=0,e[8]=(_+R)*F,e[9]=(E-C)*F,e[10]=(1-(f+v))*F,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}([],s||[0,0,0,1],l||[0,0,0],c||[1,1,1]),m.globalMatrix=d(m.localMatrix),void 0!==h){m.meshes=r[h];const e=m.anchor=[0,0];for(const t of m.meshes){const{min:r,max:o}=t.aabb;e[0]+=r[0]+o[0],e[1]+=r[1]+o[1]}e[0]=Math.floor(e[0]/m.meshes.length/2),e[1]=Math.floor(e[1]/m.meshes.length/2)}if(u&&(u.id&&(m.id=u.id),u.lights&&(m.lights=function(e){if(!e.length)return[];const t=function(e){const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.codePointAt(e);return r}(e),r=[],o=t.length/24,s=new Uint16Array(t.buffer),l=new Float32Array(t.buffer);for(let e=0;e<o;e++){const t=s[2*e*6]/30,o=s[2*e*6+1]/30,c=s[2*e*6+10]/100,h=l[6*e+1],u=l[6*e+2],d=l[6*e+3],p=l[6*e+4],f=d-h,m=p-u,_=Math.hypot(f,m);r.push({pos:[h+.5*f,u+.5*m,o],normal:[m/_,-f/_,0],width:_,height:t,depth:c,points:[h,u,d,p]})}return r}(u.lights)),u.MAPBOX_geometry_bloom&&(m.isGeometryBloom=u.MAPBOX_geometry_bloom)),p){const e=[];for(const o of p)e.push(qy(t.json.nodes[o],t,r));m.children=e}return m}function Hy(e){if(0===e.vertices.length||0===e.indices.length)return null;const t=new Md(e.vertices,e.indices,8,256),[r,o]=[t.min.clone(),t.max.clone()];return{vertices:e.vertices,indices:e.indices,grid:t,min:r,max:o}}function Zy(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||0===t.length)return null;const r=t[0];if(!r||!Array.isArray(r)||0===r.length)return null;const o=[];for(const e of r){if(!Array.isArray(e)||2!==e.length)continue;const t=e[0],r=e[1];"number"==typeof t&&"number"==typeof r&&o.push(new Je(t,r))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let s=0;for(let e=0;e<o.length;e++){const t=o[e],r=o[(e+1)%o.length],l=o[(e+2)%o.length];s+=(t.x-r.x)*(l.y-r.y)-(l.x-r.x)*(t.y-r.y)}s>0&&o.reverse();const l=Df(o.flatMap((e=>[e.x,e.y])),[]);return 0===l.length?null:{vertices:o,indices:l}}function Xy(e,t){const r=[],o=[];let s=0;const l=[];for(const c of e){s=r.length;const e=c.vertexArray.float32,h=c.indexArray.uint16;for(let o=0;o<c.vertexArray.length;o++)l[0]=e[3*o+0],l[1]=e[3*o+1],l[2]=e[3*o+2],se(l,l,t),r.push(new Je(l[0],l[1]));for(let e=0;e<3*c.indexArray.length;e++)o.push(h[e]+s)}if(o.length%3!=0)return null;for(let e=0;e<o.length;e+=3){const t=r[o[e+0]],s=r[o[e+1]],l=r[o[e+2]];(t.x-s.x)*(l.y-s.y)-(l.x-s.x)*(t.y-s.y)>0&&([o[e+1],o[e+2]]=[o[e+2],o[e+1]])}return{vertices:r,indices:o}}function Yy(e){const t=function(e,t){const r=[],o=WebGL2RenderingContext;if(e.json.textures)for(const s of e.json.textures){const l={magFilter:o.LINEAR,minFilter:o.NEAREST,wrapS:o.REPEAT,wrapT:o.REPEAT};void 0!==s.sampler&&Object.assign(l,e.json.samplers[s.sampler]),r.push({image:t[s.source],sampler:l,uploaded:!1})}return r}(e,e.images),r=function(e,t){const r=[];for(const o of e.json.meshes){const s=[];for(const r of o.primitives)s.push($y(r,e,t));r.push(s)}return r}(e,t),{scenes:o,scene:s,nodes:l}=e.json,c=o?o[s||0].nodes:[...l.keys()],h=[];for(const t of c)h.push(qy(l[t],e,r));return function(e,t,r){const o={},s=new Set;for(let l=0;l<e.length;l++){const e=r[t[l]];if(!e.extras)continue;const c=e.extras["mapbox:footprint:version"],h=e.extras["mapbox:footprint:id"];(c||h)&&s.add(l),"1.0.0"===c&&h&&(o[h]=l)}for(let l=0;l<e.length;l++){if(s.has(l))continue;const c=e[l],h=r[t[l]];if(!h.extras)continue;let u=null;c.id in o&&(u=Xy(e[o[c.id]].meshes,c.localMatrix)),u||(u=Zy(h)),u&&(c.footprint=Hy(u))}if(s.size>0){const t=Array.from(s.values()).sort(((e,t)=>e-t));for(let r=t.length-1;r>=0;r--)e.splice(t[r],1)}}(h,c,e.json.nodes),h}function Jy(e){e.heightmap=new Float32Array(4096),e.heightmap.fill(-1);const t=e.vertexArray.float32,r=e.aabb.min[0]-1,o=e.aabb.min[1]-1,s=zy/(e.aabb.max[0]-r+2),l=zy/(e.aabb.max[1]-o+2);for(let c=0;c<t.length;c+=3){const h=t[c+2],u=(t[c+0]-r)*s|0,d=(t[c+1]-o)*l|0;h>e.heightmap[d*zy+u]&&(e.heightmap[d*zy+u]=h)}}function Ky(e,t,r,o,s){r.reserve(r.length+4*e.length),o.reserve(o.length+10*e.length),s.reserve(s.length+10*e.length);let l=o.length;for(const c of e){const e=Math.min(10,Math.max(4,1.3*c.height))*t,h=[-c.normal[1],c.normal[0],0],u=Math.min(.29,.1*c.width/c.depth),d=c.width-2*c.depth*t*(u+.01),p=J([],c.pos,h,d/2),f=J([],c.pos,h,-d/2),m=[p[0],p[1],p[2]+c.height],_=[f[0],f[1],f[2]+c.height],v=J([],c.normal,h,u);Y(v,v,e);const E=J([],c.normal,h,-u);Y(E,E,e),j(v,p,v),j(E,f,E),p[2]+=.1,f[2]+=.1,o.emplaceBack(v[0],v[1],v[2]),o.emplaceBack(E[0],E[1],E[2]),o.emplaceBack(p[0],p[1],p[2]),o.emplaceBack(f[0],f[1],f[2]),o.emplaceBack(m[0],m[1],m[2]),o.emplaceBack(_[0],_[1],_[2]),o.emplaceBack(p[0],p[1],p[2]),o.emplaceBack(f[0],f[1],f[2]),o.emplaceBack(v[0],v[1],v[2]),o.emplaceBack(E[0],E[1],E[2]);const P=d/e/2;s.emplaceBack(-P-u,-1,P,.8),s.emplaceBack(P+u,-1,P,.8),s.emplaceBack(-P,0,P,1.3),s.emplaceBack(P,0,P,1.3),s.emplaceBack(P+u,-.8,P,.7),s.emplaceBack(P+u,-.8,P,.7),s.emplaceBack(0,0,P,1.3),s.emplaceBack(0,0,P,1.3),s.emplaceBack(P+u,-1.2,P,.8),s.emplaceBack(P+u,-1.2,P,.8),r.emplaceBack(6+l,4+l,8+l),r.emplaceBack(7+l,9+l,5+l),r.emplaceBack(0+l,1+l,2+l),r.emplaceBack(1+l,3+l,2+l),l+=10}}function ex(e,t){const r={};r.indexArray=new ll,r.vertexArray=new Wo,r.colorArray=new el,Ky(e,t,r.indexArray,r.vertexArray,r.colorArray);const o={defined:!0};o.emissiveFactor=ur.black;const s={};return s.baseColorFactor=ur.white,o.pbrMetallicRoughness=s,r.material=o,r.aabb=new wc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),r}const tx=Uu([{name:"a_pos_3f",components:3,type:"Float32"}]),ix=Uu([{name:"a_normal_3",components:3,type:"Int16"}]),rx=Uu([{name:"a_centroid_3",components:3,type:"Int16"}]),nx=Uu([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),ox=Uu([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),sx=Uu([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),ax=Uu([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),lx=Uu([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),cx=Uu([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),hx=Qu.types,ux=32767;function dx(e,t){const r=Ao+t;for(const o of e)for(const e of o)if(e.x<-t||e.x>r||e.y<-t||e.y>r)return!1;return!0}function px(e){switch(e){case"flat":return 3;case"hipped":return 1;case"gabled":return 2;case"parapet":return 0;case"mansard":return 4;case"skillion":return 5;case"pyramidal":return 6;default:throw new Error(`Unknown roof shape: ${e}`)}}class Dy{constructor(){this.layoutVertexArray=new Wo,this.layoutAttenuationArray=new el,this.layoutColorArray=new nl,this.indexArray=new ll,this.indexArrayForConflation=new ll,this.segmentsBucket=new Ol}}class Cy{constructor(e){this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.segmentsBucket=new Ol,this.entranceBloom=new Dy;const t=66560;this.layoutVertexArray=new Wo,this.layoutVertexArray.reserve(t),this.layoutNormalArray=new jo,this.layoutNormalArray.reserve(t),this.layoutCentroidArray=new jo,this.layoutCentroidArray.reserve(t),this.layoutColorArray=new nl,this.layoutColorArray.reserve(t),this.layoutFloodLightDataArray=new xl,this.layoutFloodLightDataArray.reserve(t),this.layoutAOArray=new _l,this.layoutAOArray.reserve(t),this.indexArray=new ll,this.indexArray.reserve(66560),this.indexArrayForConflation=new ll,this.segmentsBucket=new Ol,this.entranceBloom=new Dy,e&&(this.layoutFacadePaintArray=new nl,this.layoutFacadeDataArray=new Jo,this.layoutFacadeVerticalRangeArray=new nl)}reserve(e,t,r){this.layoutVertexArray.reserveForAdditional(e),this.layoutCentroidArray.reserveForAdditional(e),this.layoutFloodLightDataArray.reserveForAdditional(e),this.layoutNormalArray.reserveForAdditional(e),this.layoutAOArray.reserveForAdditional(e),this.layoutColorArray.reserveForAdditional(e),this.indexArray.reserveForAdditional(t),r&&(this.layoutFacadePaintArray.reserveForAdditional(e),this.layoutFacadeDataArray.reserveForAdditional(e),this.layoutFacadeVerticalRangeArray.reserveForAdditional(e))}}class Ry{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.footprintsVertices=new yl,this.footprintsIndices=new xl,this.footprintsMin=new Je(1/0,1/0),this.footprintsMax=new Je(-1/0,-1/0),this.featuresOnBorder=[],this.buildingWithoutFacade=new Cy(!1),this.buildingWithFacade=new Cy(!0),this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.buildingIds=new Set,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.projection=e.projection,this.groundEffect=new ff(e),this.groundEffect.groundRadiusArray=new $o,this.hasAppearances=null}updateFootprints(e,t){const r=new Md([],[],1),o={vertices:[],indices:new Uint32Array(0),grid:r,min:this.footprintsMin,max:this.footprintsMax,buildingIds:this.buildingIds};t.push({footprint:o,id:e})}updateAppearances(e,t,r,o){}prepare(){return function(){if(null!=Fg||null!=Og)return null;if(null!=Lg)return Lg;const e=fetch(qt.BUILDING_GEN_URL);return Lg=function(e){let t,r,o,s,l;function c(){t=new Uint8Array(l.buffer),r=new Int16Array(l.buffer),o=new Int32Array(l.buffer),s=new Float32Array(l.buffer)}function h(){throw new Error("Unexpected BuildingGen error.")}const u=()=>{},d={a:{a:h,f:function(e){const r=t.length,o=Math.max(e>>>0,Math.ceil(1.2*r)),s=Math.ceil((o-r)/65536);try{return l.grow(s),c(),!0}catch(e){return!1}},g:h,b:u,c:u,d:u,e:u}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(e,d):e.then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,d)))).then((e=>{const h=e.instance.exports;return(0,h.g)(),l=h.f,c(),new Qf({setStyle:h.h,setAOOptions:h.i,setMetricOptions:h.j,setStructuralOptions:h.k,setFacadeOptions:h.l,setFauxFacadeOptions:h.m,setFacadeClassifierOptions:h.n,addFeature:h.o,addFacade:h.p,generateMesh:h.q,getLastError:h.r,getOuterRingLength:h.s,getMeshCount:h.t,getPositionsPtr:h.u,getPositionsLength:h.v,getNormalsPtr:h.w,getNormalsLength:h.x,getAOPtr:h.y,getAOLength:h.z,getUVPtr:h.A,getUVLength:h.B,getFauxFacadePtr:h.C,getFauxFacadeLength:h.D,getIndicesPtr:h.E,getIndicesLength:h.F,getBuildingPart:h.G,getRingCount:h.H,getRingPtr:h.I,getRingLength:h.J,malloc:h.K,free:h.L,heapU8:t,heap16:r,heap32:o,heapF32:s})}))}(e).then((e=>(Lg=null,Fg=e,Fg))).catch((e=>{Et("Could not load building-gen"),Lg=null,Og=e})),Lg}()}populate(e,t,r,o){const s=Vg();if(!s)return;const l=Fd(r);this.tileToMeter=l,this.brightness=t.brightness,s.setStyle({normalScale:[1,-1,l],tileToMeters:l}),s.setAOOptions(!1,.3),s.setMetricOptions(!1,16),s.setStructuralOptions(!0),s.setFacadeClassifierOptions(3);const c=new Map,h=new Map;let u=0;for(const{feature:t}of e){if("LineString"!==hx[t.type]){c.set(t.id,t.properties.source_id);continue}const e=this.layers[0]._featureFilter.needGeometry;if(e&&!this.layers[0]._featureFilter.filter(new Ja(this.zoom),t,r))continue;const s=qd(t,e);if(!e&&!this.layers[0]._featureFilter.filter(new Ja(this.zoom),s,r))continue;const l=e?s.geometry:$d(t,r,o),d=[];for(const e of l)for(const t of e)d.push(t.x),d.push(t.y);const p={coordinates:d,crossPerc:t.properties.cross_perc,distanceToRoad:t.properties.distance_to_road,entrances:t.properties.entrances,sourceId:0},f=t.properties.source_id;let m=h.get(f);m||(m=[],h.set(f,m)),m.push(p),++u}this.maxHeight=0;const d=new Array,p=new Set,f=e=>{null!=e&&p.add(e)},m=(e,t)=>{null!=e&&d.push({buildingId:e,footprintIndex:t})},_=64*(e.length-u),v=_/2;this.buildingWithFacade.reserve(_,v,!0),this.buildingWithoutFacade.reserve(2*_,2*v,!1),this.footprintsIndices.reserve(16*(e.length-u)),this.footprintsVertices.reserve(8*(e.length-u));for(const{feature:u,id:d,index:_,sourceLayerIndex:v}of e){if("LineString"===hx[u.type])continue;const e=this.layers[0]._featureFilter.needGeometry;if(e&&!this.layers[0]._featureFilter.filter(new Ja(this.zoom),u,r))continue;let E=null;if(u.properties&&u.properties.hasOwnProperty("building_id")&&(E=Number(u.properties.building_id),p.has(E)))continue;const P=qd(u,e);if(!e&&!this.layers[0]._featureFilter.filter(new Ja(this.zoom),P,r))continue;const C=e?P.geometry:$d(u,r,o),R=pm(C,500);let z=!1;for(const e of R)if(1!==e.length){z=!0;break}if(z){f(E);continue}if(!dx(C,163)){f(E);continue}const D=this.layers[0],O=px(D.layout.get("building-roof-shape").evaluate(u,{},r)),F=D.layout.get("building-base").evaluate(u,{},r),B=D.layout.get("building-height").evaluate(u,{},r),k=D.layout.get("building-flood-light-ground-radius").evaluate(u,{},r),V=D.paint.get("building-ambient-occlusion-intensity"),N=k/this.tileToMeter;u.properties["building-part"]="roof";const U=D.paint.get("building-color").evaluate(u,{},this.canonical).toPremultipliedRenderColor(this.lut),j=D.paint.get("building-emissive-strength").evaluate(u,{},this.canonical);u.properties["building-part"]="wall";const $=D.paint.get("building-color").evaluate(u,{},this.canonical).toPremultipliedRenderColor(this.lut),q=D.paint.get("building-emissive-strength").evaluate(u,{},this.canonical);u.properties["building-part"]="window";const H=D.paint.get("building-color").evaluate(u,{},this.canonical).toPremultipliedRenderColor(this.lut),Z=D.paint.get("building-emissive-strength").evaluate(u,{},this.canonical);u.properties["building-part"]="door";const Y=D.paint.get("building-color").evaluate(u,{},this.canonical).toPremultipliedRenderColor(this.lut),J=D.paint.get("building-emissive-strength").evaluate(u,{},this.canonical);let Q=D.layout.get("building-flood-light-wall-radius").evaluate(u,{},r);Q=ct(Q,0,2048);const K=Q/2048*ux,ee=c.get(d),te=h.get(ee)||[],ie=0!==te.length&&D.layout.get("building-facade").evaluate(u,{},r);s.setFacadeOptions(4,!0),s.setFauxFacadeOptions(ie,!1,1);let re=0,ne=0,oe=0,se=0,ae=0,le=0,ce=0,he=0,ue=0,de=0,pe=0;if(ie){let e=Math.round(D.layout.get("building-facade-floors").evaluate(u,{},r));if(0===F){e=Math.max(1,e-(te.length>0?1:0));let t=4;if(B>100){const e=[10,13,15];t=e[u.id?u.id%e.length:0]}else B<=10&&(t=3);s.setFacadeOptions(t,!0),ae=(B<15?1.3:1.61803)*t/l}else ae=F/l;le=B/l,ae=Math.min(ae,le),oe=D.layout.get("building-facade-unit-width").evaluate(u,{},r)/l,se=(le-ae)/e,s.setFauxFacadeOptions(!0,!0,oe);const t=D.layout.get("building-facade-window").evaluate(u,{},r);re=t[0],ne=t[1],ce=Math.floor(65535*Math.min(1,ae/Ao)),he=Math.floor(65535*Math.min(1,le/Ao)),ue=Math.floor(255*re)<<8|Math.floor(255*ne),de=Math.floor(65535*Math.min(1,oe/Ao)),pe=Math.floor(65535*Math.min(1,se/Ao))}const fe=Array(R.length),me={x:1/0,y:1/0},ge={x:-1/0,y:-1/0},ye={x:0,y:0};let xe=0;for(let e=0;e<R.length;e++){const t=R[e];if(t.length>0){const r=[],o=Array(t.length+1);o[0]=0;for(let e=0;e<t.length;e++){const s=t[e];for(let e=0;e<s.length;e++){const t=s[s.length-e-1];me.x=Math.min(me.x,t.x),me.y=Math.min(me.y,t.y),ge.x=Math.max(ge.x,t.x),ge.y=Math.max(ge.y,t.y),ye.x+=t.x,ye.y+=t.y,xe++,r.push(t.x),r.push(t.y)}o[e+1]=r.length}fe[e]={id:u.id?u.id:0,height:B,minHeight:F,sourceId:0,roofType:O,coordinates:r,ringIndices:o}}}ye.x/=xe||1,ye.y/=xe||1;const ve=s.generateMesh(fe,te);if("string"==typeof ve){Et(`Unable to generate building ${u.id}: ${ve}`),f(E);continue}if(0===ve.meshes.length||0===ve.modifiedPolygonRings.length){f(E);continue}const be=ie?this.buildingWithFacade:this.buildingWithoutFacade;let we=0;for(const e of ve.meshes)we+=e.positions.length/3;const Ie=be.segmentsBucket.prepareSegment(we,be.layoutVertexArray,be.indexArray),Ee=[];let Ae=null,Me=0,Pe=-1;const Ce=be.layoutVertexArray.length,ze=Ce+we;be.layoutVertexArray.resize(ze),be.layoutCentroidArray.resize(ze),be.layoutNormalArray.resize(ze),be.layoutAOArray.resize(ze),be.layoutColorArray.resize(ze),be.layoutFloodLightDataArray.resize(ze),ie&&(be.layoutFacadePaintArray.resize(ze),be.layoutFacadeDataArray.resize(ze),be.layoutFacadeVerticalRangeArray.resize(ze));const De=be.indexArray.length;let Oe=0,Fe=Ce;for(const e of ve.meshes){let t,r;if(1===e.buildingPart)t=U,r=j;else if(0===e.buildingPart)t=$,r=q;else if(2===e.buildingPart)t=H,r=Z;else{if(3!==e.buildingPart)continue;t=Y,r=J}if(r=ct(r,0,1),3===e.buildingPart){const t=new Array;for(let r=0;r<e.positions.length;r+=12){const o=e.positions[r+0],s=e.positions[r+1],l=e.positions[r+3],c=e.positions[r+4],h=e.positions[r+2],u=e.positions[r+8]-h,d=1,p=l-o,f=c-s,m=Math.hypot(p,f);t.push({pos:[o+.5*p,s+.5*f,h],normal:[f/m,-p/m,0],width:m,height:u,depth:d,points:[o,s,l,c]})}const r=be.entranceBloom.segmentsBucket.prepareSegment(10*t.length,be.entranceBloom.layoutVertexArray,be.entranceBloom.indexArray),o=be.entranceBloom.layoutVertexArray.length;Me=be.entranceBloom.indexArray.length,Ky(t,.5/this.tileToMeter,be.entranceBloom.indexArray,be.entranceBloom.layoutVertexArray,be.entranceBloom.layoutAttenuationArray);const s=be.entranceBloom.layoutVertexArray.length-o;Pe=be.entranceBloom.indexArray.length-Me;for(let e=0;e<s;e++)be.entranceBloom.layoutColorArray.emplaceBack(255*Y.r<<8|255*Y.g,255*Y.b<<8|51*J);r.vertexLength+=s,r.primitiveLength+=Pe,Ae={part:e.buildingPart,vertexOffset:o,vertexLength:s}}be.layoutVertexArray.float32.set(e.positions,3*Fe);const o=e.positions.length/3;for(let s=0;s<o;++s){const o=3*s;Oe=Math.max(Oe,e.positions[o+2]);const l=e.normals[o+1]*ux,c=e.normals[o+2]*ux,h=3*(Fe+s);be.layoutNormalArray.int16[h]=e.normals[o]*ux,be.layoutNormalArray.int16[h+1]=l,be.layoutNormalArray.int16[h+2]=c;const u=e.ao[s];be.layoutAOArray.uint8[Fe+s]=255*u;const d=1+(u-1)*V,p=255*t.b*d<<8|255*r;be.layoutColorArray.uint16[2*(Fe+s)]=255*t.r*d<<8|255*t.g*d,be.layoutColorArray.uint16[2*(Fe+s)+1]=p}const s=Math.floor(ye.x),l=Math.floor(ye.y),c=Math.floor(B);for(let e=0;e<o;++e){const t=3*(Fe+e);be.layoutCentroidArray.int16[t]=s,be.layoutCentroidArray.int16[t+1]=l,be.layoutCentroidArray.int16[t+2]=c}if(be.layoutFloodLightDataArray.uint16.fill(0===e.buildingPart?K:0,Fe,Fe+o),ie){const t=255*H.r<<8|255*H.g,r=255*H.b<<8|255*Z;for(let e=0;e<o;++e){const o=2*(Fe+e);be.layoutFacadePaintArray.uint16[o]=t,be.layoutFacadePaintArray.uint16[o+1]=r}for(let t=0;t<o;++t)if(e.isFauxFacade[t]){const r=Math.min(65535,Math.floor(e.uv[2*t]*ve.outerRingLength));be.layoutFacadeDataArray.emplace(Fe+t,1|r,ue,de,pe),be.layoutFacadeVerticalRangeArray.emplace(Fe+t,ce,he)}else be.layoutFacadeDataArray.emplace(Fe+t,0,0,0,0),be.layoutFacadeVerticalRangeArray.emplace(Fe+t,0,0)}const h=Ie.vertexLength,u=e.indices.length/3,d=be.indexArray.length;be.indexArray.resize(d+u);for(let t=0;t<u;++t){const r=3*t,o=3*d+r;be.indexArray.uint16[o]=h+e.indices[r],be.indexArray.uint16[o+1]=h+e.indices[r+1],be.indexArray.uint16[o+2]=h+e.indices[r+2]}1!==e.buildingPart&&0!==e.buildingPart&&2!==e.buildingPart&&3!==e.buildingPart||Ee.push({part:e.buildingPart,vertexOffset:Fe,vertexLength:e.positions.length/3}),Fe+=o,Ie.vertexLength+=o,Ie.primitiveLength+=e.indices.length/3}this.maxHeight=Math.max(this.maxHeight,Oe);const Be=be.indexArray.length-De,Ve=this.footprintsIndices.length,Ue=this.footprintsVertices.length,je=[],Ge=new Je(1/0,1/0),qe=new Je(-1/0,-1/0),He=this.groundEffect.vertexArray.length;for(const e of ve.modifiedPolygonRings){const t=[],r=new Je(1/0,1/0),o=new Je(-1/0,-1/0);for(let s=0;s<e.length;s+=2){const l=e.length-s-2;r.x=Math.min(r.x,e[l]),r.y=Math.min(r.y,e[l+1]),o.x=Math.max(o.x,e[l]),o.y=Math.max(o.y,e[l+1]);const c=new Je(e[l],e[l+1]);t.push(c),je.push(c.x,c.y),this.footprintsVertices.emplaceBack(c.x,c.y)}Ge.x=Math.min(Ge.x,r.x),Ge.y=Math.min(Ge.y,r.y),qe.x=Math.max(qe.x,o.x),qe.y=Math.max(qe.y,o.y),this.groundEffect.addData(t,[r,o],N)}const We=this.groundEffect.vertexArray.length-He;this.groundEffect.groundRadiusArray.reserveForAdditional(We);for(let e=0;e<We;e++)this.groundEffect.groundRadiusArray.emplaceBack(k);(me.x<0||ge.x>Ao||me.y<0||ge.y>Ao)&&this.featuresOnBorder.push({featureId:u.id,footprintIndex:this.footprints.length});{const e=Df(je,null,2);this.footprintsIndices.resize(this.footprintsIndices.length+e.length),this.footprintsIndices.uint16.set(e,Ve),this.buildingIds.add(null!=E?E:u.id),this.footprintsMin.x=Math.min(this.footprintsMin.x,Ge.x),this.footprintsMin.y=Math.min(this.footprintsMin.y,Ge.y),this.footprintsMax.x=Math.max(this.footprintsMax.x,qe.x),this.footprintsMax.y=Math.max(this.footprintsMax.y,qe.y);const t={footprintVertexOffset:Ue,footprintVertexLength:this.footprintsVertices.length-Ue,footprintIndexOffset:Ve,footprintIndexLength:this.footprintsIndices.length-Ve,min:Ge,max:qe,hiddenFlags:0,indicesOffset:De,indicesLength:Be,bloomIndicesOffset:Me,bloomIndicesLength:Pe,groundEffectVertexOffset:He,groundEffectVertexLength:We,hasFauxFacade:ie,height:Oe,promoteId:d,feature:P,parts:Ee,buildingBloom:Ae},r=this.footprints.length;void 0!==u.id&&this.featureFootprintLookup.set(u.id,r),m(E,r),this.footprints.push(t)}this.programConfigurations.populatePaintArrays(be.layoutVertexArray.length,u,_,{},t.availableImages,r,t.brightness),this.groundEffect.addPaintPropertiesData(u,_,{},t.availableImages,r,t.brightness),t.featureIndex.insert(u,C,_,v,this.index,Ce)}d.forEach((({buildingId:e,footprintIndex:t})=>{p.has(e)&&(this.footprints[t].hiddenFlags|=4)}));const E=new Set;this.buildingIds.forEach(((e,t,r)=>{p.has(e)||E.add(e)})),this.buildingIds=E,this.groundEffect.prepareBorderSegments()}update(e,t,r,o,s,l,c){this.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c),this.groundEffect.update(e,t,s,r,o,l,c),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return 0===this.buildingWithoutFacade.layoutVertexArray.length&&0===this.buildingWithFacade.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const t=t=>{t.layoutVertexBuffer=e.createVertexBuffer(t.layoutVertexArray,tx.members),t.layoutNormalBuffer=e.createVertexBuffer(t.layoutNormalArray,ix.members),t.layoutCentroidBuffer=e.createVertexBuffer(t.layoutCentroidArray,rx.members),t.layoutFloodLightDataBuffer=e.createVertexBuffer(t.layoutFloodLightDataArray,cx.members),t.layoutFacadeDataArray&&t.layoutFacadeDataArray.length&&(t.layoutFacadeDataBuffer=e.createVertexBuffer(t.layoutFacadeDataArray,sx.members)),t.layoutFacadeVerticalRangeArray&&t.layoutFacadeVerticalRangeArray.length&&(t.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(t.layoutFacadeVerticalRangeArray,ax.members)),t.entranceBloom.layoutVertexArray.length&&(t.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(t.entranceBloom.layoutVertexArray,tx.members),t.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(t.entranceBloom.layoutAttenuationArray,lx.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=e=>{e.layoutVertexBuffer&&(e.layoutVertexBuffer.destroy(),e.layoutNormalBuffer.destroy(),e.layoutColorBuffer.destroy(),e.segmentsBucket.destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.entranceBloom.layoutVertexBuffer&&(e.entranceBloom.layoutVertexBuffer.destroy(),e.entranceBloom.layoutColorBuffer.destroy(),e.entranceBloom.layoutAttenuationBuffer.destroy(),e.entranceBloom.indexBuffer.destroy(),e.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,t,r=!0){let o=!1;const s=r?t:0,l=0|(r?-1:~t);0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of e){const e=this.footprints[t],r=e.hiddenFlags&l|s;e.hiddenFlags!==r&&(e.hiddenFlags=r,o=!0,this.groundEffect.updateHiddenByLandmarkRange(e.groundEffectVertexOffset,e.groundEffectVertexLength,0!==e.hiddenFlags))}return o&&(this.indexArrayForConflationUploaded=!1),o}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const t=e=>{0!==e.indexArray.length&&(e.indexArrayForConflation.resize(e.indexArray.length),e.indexArrayForConflation.uint16.set(e.indexArray.uint16),e.entranceBloom.indexArrayForConflation.resize(e.entranceBloom.indexArray.length),e.entranceBloom.indexArrayForConflation.uint16.set(e.entranceBloom.indexArray.uint16))};t(this.buildingWithoutFacade),t(this.buildingWithFacade);for(const e of this.footprints){const t=e.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,r=e.indicesOffset+e.indicesLength;if(0!==e.hiddenFlags){for(let o=e.indicesOffset;o<r;o++)t.indexArrayForConflation.uint16[3*o+0]=0,t.indexArrayForConflation.uint16[3*o+1]=0,t.indexArrayForConflation.uint16[3*o+2]=0;const o=e.bloomIndicesOffset+e.bloomIndicesLength;for(let r=e.bloomIndicesOffset;r<o;r++)t.entranceBloom.indexArrayForConflation.uint16[3*r+0]=0,t.entranceBloom.indexArrayForConflation.uint16[3*r+1]=0,t.entranceBloom.indexArrayForConflation.uint16[3*r+2]=0}}const r=t=>{0!==t.indexArray.length&&(t.indexBuffer?t.indexBuffer.updateData(t.indexArrayForConflation):t.indexBuffer=e.createIndexBuffer(t.indexArrayForConflation,!0),t.entranceBloom.indexBuffer?t.entranceBloom.indexBuffer.updateData(t.entranceBloom.indexArrayForConflation):t.entranceBloom.indexBuffer=e.createIndexBuffer(t.entranceBloom.indexArrayForConflation,!0))};r(this.buildingWithoutFacade),r(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const t=t=>{t.layoutColorBuffer?t.layoutColorBuffer.updateData(t.layoutColorArray):t.layoutColorBuffer=e.createVertexBuffer(t.layoutColorArray,nx.members,!0),t.layoutFacadePaintArray&&(t.layoutFacadePaintBuffer?t.layoutFacadePaintBuffer.updateData(t.layoutFacadePaintArray):t.layoutFacadePaintBuffer=e.createVertexBuffer(t.layoutFacadePaintArray,ox.members,!0)),t.entranceBloom.layoutColorBuffer?t.entranceBloom.layoutColorBuffer.updateData(t.entranceBloom.layoutColorArray):t.entranceBloom.layoutColorBuffer=e.createVertexBuffer(t.entranceBloom.layoutColorArray,nx.members,!0)};t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,t){const r=e.paint.get("building-ambient-occlusion-intensity");for(const o of this.footprints){if(4&o.hiddenFlags)continue;const s=t[o.promoteId],l=o.feature;l.properties["building-part"]="roof";const c=e.paint.get("building-color").evaluate(l,s,this.canonical).toPremultipliedRenderColor(this.lut),h=e.paint.get("building-emissive-strength").evaluate(l,s,this.canonical);l.properties["building-part"]="wall";const u=e.paint.get("building-color").evaluate(l,s,this.canonical).toPremultipliedRenderColor(this.lut),d=e.paint.get("building-emissive-strength").evaluate(l,s,this.canonical);l.properties["building-part"]="window";const p=e.paint.get("building-color").evaluate(l,s,this.canonical).toPremultipliedRenderColor(this.lut),f=e.paint.get("building-emissive-strength").evaluate(l,s,this.canonical);l.properties["building-part"]="door";const m=e.paint.get("building-color").evaluate(l,s,this.canonical).toPremultipliedRenderColor(this.lut),_=e.paint.get("building-emissive-strength").evaluate(l,s,this.canonical),v=o.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const e of o.parts){let t,s=c;1===e.part?(s=c,t=h):0===e.part?(s=u,t=d):2===e.part?(s=p,t=f):3===e.part&&(s=m,t=_),t=ct(t,0,1);for(let l=0;l<e.vertexLength;l++){const c=e.vertexOffset+l,h=1+(v.layoutAOArray.uint8[c]/255-1)*r;v.layoutColorArray.emplace(c,s.r*h*255<<8|s.g*h*255,s.b*h*255<<8|255*t),o.hasFauxFacade&&v.layoutFacadePaintArray.emplace(c,255*p.r<<8|255*p.g,255*p.b<<8|255*f)}}const E=o.buildingBloom;if(E)for(let e=0;e<E.vertexLength;e++)v.entranceBloom.layoutColorArray.emplace(E.vertexOffset+e,255*m.r<<8|255*m.g,255*m.b<<8|51*_)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,t,r){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const o=t.getReplacementRegionsForTile(e.toUnwrapped());if(w_(this.activeReplacements,o))return;this.activeReplacements=o;for(const e of this.footprints)e.hiddenFlags&=-2;const s=[];for(const t of this.activeReplacements){if(t.order<r)continue;const o=Math.max(1,Math.pow(2,t.footprintTileId.canonical.z-e.canonical.z));for(const r of this.footprints)r.min.x>t.max.x||r.max.x<t.min.x||r.min.y>t.max.y||r.max.y<t.min.y||(s.length=0,mx(this.footprintsVertices,r.footprintVertexOffset,r.footprintVertexLength,t.footprintTileId.canonical,e.canonical,s),I_(t.footprint,s,this.footprintsIndices.uint16,r.footprintIndexOffset,r.footprintIndexLength,0,-o)&&(r.hiddenFlags|=1))}0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(e.groundEffectVertexOffset,e.groundEffectVertexLength,0!==e.hiddenFlags);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(void 0!==e.id){const t=this.featureFootprintLookup.get(e.id);return this.footprints[t]}return null}getHeightAtTileCoord(e,t){let r=Number.NEGATIVE_INFINITY,o=!0;const s=4*(e+Ao)*Ao+(t+Ao);if(this.footprintLookup.hasOwnProperty(s)){const e=this.footprintLookup[s];return e?{height:e.height,hidden:0!==e.hiddenFlags}:void 0}const l=new Je(e,t);for(const c of this.footprints)e>c.max.x||c.min.x>e||t>c.max.y||c.min.y>t||c.height<=r||fx(l,this.footprintsVertices.float32.subarray(2*c.footprintVertexOffset,2*(c.footprintVertexOffset+c.footprintVertexLength)),this.footprintsIndices.uint16.subarray(c.footprintIndexOffset,c.footprintIndexOffset+c.footprintIndexLength))&&(r=c.height,this.footprintLookup[s]=c,o=0!==c.hiddenFlags);if(r!==Number.NEGATIVE_INFINITY)return{height:r,hidden:o};this.footprintLookup[s]=void 0}}function fx(e,t,r){for(let o=0;o<r.length;o+=3){const s=r[o],l=r[o+1],c=r[o+2],h=t[2*s+0],u=t[2*s+1],d=t[2*l+0],p=t[2*l+1],f=t[2*c+0],m=t[2*c+1],_=(h-f)*(e.y-m)-(u-m)*(e.x-f),v=(d-h)*(e.y-u)-(p-u)*(e.x-h);if(_<0!=v<0&&0!==_&&0!==v)continue;const E=(f-d)*(e.y-p)-(m-p)*(e.x-d);if(0===E||E<0==_+v<=0)return!0}return!1}function mx(e,t,r,o,s,l){const c=Math.pow(2,o.z-s.z);for(let h=0;h<r;h++){let r=e.float32[2*(h+t)+0],u=e.float32[2*(h+t)+1];r=(r+s.x*Ao)*c-o.x*Ao,u=(u+s.y*Ao)*c-o.y*Ao,l.push(new Je(r,u))}}let _x,gx;ih(Ry,"BuildingBucket",{omit:["layers"]}),ih(Cy,"BuildingGeometry"),ih(Dy,"BuildingBloomGeometry");const xx=Uu([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),vx=Uu([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:bx}=xx,wx=Uu([{name:"a_packed",components:3,type:"Float32"}]),{members:Tx}=wx,Sx=Uu([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Ex}=Sx;class Wy{constructor(e,t){this.width=e,this.height=t,this.nextRow=0,this.image=new qh({width:e,height:t}),this.positions={},this.uploaded=!1}getDash(e,t){const r=this.getKey(e,t);return this.positions[r]}trim(){const e=this.width,t=this.height=xt(this.nextRow);this.image.resize({width:e,height:t})}getKey(e,t){return e.join(",")+t}getDashRanges(e,t,r){const o=[];let s=e.length%2==1?-e[e.length-1]*r:0,l=e[0]*r,c=!0;o.push({left:s,right:l,isDash:c,zeroLength:0===e[0]});let h=e[0];for(let t=1;t<e.length;t++){c=!c;const u=e[t];s=h*r,h+=u,l=h*r,o.push({left:s,right:l,isDash:c,zeroLength:0===u})}return o}addRoundDash(e,t,r){const o=t/2;for(let t=-r;t<=r;t++){const s=this.width*(this.nextRow+r+t);let l=0,c=e[l];for(let h=0;h<this.width;h++){h/c.right>1&&(c=e[++l]);const u=Math.abs(h-c.left),d=Math.abs(h-c.right),p=Math.min(u,d);let f;const m=t/r*(o+1);if(c.isDash){const e=o-Math.abs(m);f=Math.sqrt(p*p+e*e)}else f=o-Math.sqrt(p*p+m*m);this.image.data[s+h]=Math.max(0,Math.min(255,f+128))}}}addRegularDash(e,t){for(let t=e.length-1;t>=0;--t){const r=e[t],o=e[t+1];r.zeroLength?e.splice(t,1):o&&o.isDash===r.isDash&&(o.left=r.left,e.splice(t,1))}const r=e[0],o=e[e.length-1];r.isDash===o.isDash&&(r.left=o.left-this.width,o.right=r.right+this.width);const s=this.width*this.nextRow;let l=0,c=e[l];for(let r=0;r<this.width;r++){r/c.right>1&&(c=e[++l]);const o=Math.abs(r-c.left),h=Math.abs(r-c.right),u=Math.min(o,h);this.image.data[s+r]=Math.max(0,Math.min(255,(c.isDash?u:-u)+t+128))}}addDash(e,t){const r=this.getKey(e,t);if(this.positions[r])return this.positions[r];const o="round"===t,s=o?7:0,l=2*s+1;if(this.nextRow+l>this.height)return Et("LineAtlas out of space"),null;0===e.length&&e.push(1);let c=0;for(let t=0;t<e.length;t++)e[t]<0&&(Et("Negative value is found in line dasharray, replacing values with 0"),e[t]=0),c+=e[t];if(0!==c){const r=this.width/c,l=this.getDashRanges(e,this.width,r);o?this.addRoundDash(l,r,s):this.addRegularDash(l,"square"===t?.5*r:0)}const h=this.nextRow+s;this.nextRow+=l;const u={tl:[h,s],br:[c,0]};return this.positions[r]=u,u}}ih(Wy,"LineAtlas");const Ax=Qu.types,Mx=Math.cos(Math.PI/180*37.5),Cx=Math.cos(Math.PI/180*5);class Qy{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((e=>{this.gradients[e.id]={}})),this.layoutVertexArray=new Zo,this.layoutVertexArray2=new Wo,this.patternVertexArray=new Wo,this.indexArray=new ll,this.programConfigurations=new fu(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ol,this.maxLineLength=0,this.zOffsetVertexArray=new Wo,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:128,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,r,o){}populate(e,t,r,o){this.hasPattern=_m("line",this.layers,this.pixelRatio,t);const s=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Fd(r);const l=this.layers[0].layout.get("line-elevation-reference");if("hd-road-markup"===l)this.elevationType="road";else{const e=this.layers[0].layout.get("line-z-offset"),t=e.isConstant()&&!e.constantOr(0);this.elevationType="sea"!==l&&"ground"!==l&&t?"none":"offset","offset"===this.elevationType&&"none"===l&&Et(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const c=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope="offset"===this.elevationType&&void 0!==c;const h=[];for(const{feature:l,id:c,index:u,sourceLayerIndex:d}of e){const e=this.layers[0]._featureFilter.needGeometry,p=qd(l,e);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),p,r))continue;const f=s?s.evaluate(p,{},r):void 0,m={id:c,properties:l.properties,type:l.type,sourceLayerIndex:d,index:u,geometry:e?p.geometry:$d(l,r,o),patterns:{},sortKey:f};h.push(m)}s&&h.sort(((e,t)=>e.sortKey-t.sortKey));const{lineAtlas:u,featureIndex:d}=t,p=this.addConstantDashes(u);for(const o of h){const{geometry:s,index:l,sourceLayerIndex:c}=o;if(p&&this.addFeatureDashes(o,u),this.hasPattern){const e=gm("line",this.layers,o,this.zoom,this.pixelRatio,t);this.patternFeatures.push(e)}else this.addFeature(o,s,l,r,u.positions,t.availableImages,t.brightness,t.elevationFeatures);d.insert(e[l].feature,s,l,c,this.index)}}addConstantDashes(e){let t=!1;for(const r of this.layers){const o=r.paint.get("line-dasharray").value,s=r.layout.get("line-cap").value;if("constant"!==o.kind||"constant"!==s.kind)t=!0;else{const t=s.value,r=o.value;if(!r)continue;e.addDash(r,t)}}return t}addFeatureDashes(e,t){const r=this.zoom;for(const o of this.layers){const s=o.paint.get("line-dasharray").value,l=o.layout.get("line-cap").value;if("constant"===s.kind&&"constant"===l.kind)continue;let c,h;if("constant"===s.kind){if(c=s.value,!c)continue}else c=s.evaluate({zoom:r},e);h="constant"===l.kind?l.value:l.evaluate({zoom:r},e),t.addDash(c,h),e.patterns[o.id]=[t.getKey(c,h)]}}update(e,t,r,o,s,l,c,h){this.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,h)}addFeatures(e,t,r,o,s,l){for(const s of this.patternFeatures)this.addFeature(s,s.geometry,s.index,t,r,o,l,e.elevationFeatures)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Tx)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,Ex)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,vx.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,bx),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,t){let r,o;if(t&&t>0?(r=`mapbox_clip_start_${t}`,o=`mapbox_clip_end_${t}`):(r="mapbox_clip_start",o="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(r)&&e.properties.hasOwnProperty(o))return{start:+e.properties[r],end:+e.properties[o]}}addFeature(e,t,r,o,s,l,c,h){const u=this.layers[0].layout,d=u.get("line-join").evaluate(e,{}),p=u.get("line-cap").evaluate(e,{}),f=u.get("line-miter-limit"),m=u.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const _=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=u.get("line-z-offset").value;const v=this.layers[0].paint.get("line-width").value;if("constant"!==v.kind&&!1===v.isLineProgressConstant&&(this.variableWidthValue=v),"road"===this.elevationType){const r=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,t,o,h,d,p,f,m)){const[s,l]=this.clipRuntimeLinesToTile(t,1);for(let t=0;t<s.length;t++){const r=s[t],c=l[t],h={progress:{min:c.progress.min,max:c.progress.max},nextDir:this.computeSegNextDir(c,r),prevDir:this.computeSegPrevDir(c,r)};this.addLine(r,e,o,d,p,f,m,h,_&&c.parentIndex>0?c.parentIndex:null)}this.fillNonElevatedRoadSegment(r)}}else for(let r=0;r<t.length;r++)this.addLine(t[r],e,o,d,p,f,m,void 0,_&&r>0?r:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,r,s,l,o,c,void 0,this.worldview)}computeSegNextDir(e,t){return e.nextPoint.sub(t.at(-2)).unit()}computeSegPrevDir(e,t){return t[1].sub(e.prevPoint).unit()}clipLinesToTile(e,t){return pg(e,-t,-t,Ao+t,Ao+t)}clipRuntimeLinesToTile(e,t){const r=[];return[pg(e,-t,-t,Ao+t,Ao+t,r),r]}addElevatedRoadFeature(e,t,r,o,s,l,c,h){const u=[],d=Mc.getElevationFeature(e,o);if(d){const e=this.clipLinesToTile(t,1),o=this.prepareElevatedLines(e,d,r);for(const e of o)u.push({geometry:e,elevation:d,elevationTileID:r,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(0===u.length)return!1;for(const t of u){const o=this.layoutVertexArray.length;this.addLine(t.geometry,e,r,s,l,c,h);const u=new Ic(r,t.elevationTileID);if(t.elevation)for(let e=o;e<this.layoutVertexArray.length;e++){const r=new Je(this.layoutVertexArray.int16[6*e]>>1,this.layoutVertexArray.int16[6*e+1]>>1),o=u.pointElevation(r,t.elevation,.05);this.updateHeightRange(o),this.zOffsetVertexArray.emplaceBack(o,0,0)}else this.fillNonElevatedRoadSegment(o)}return!0}prepareElevatedLines(e,t,r){if(null!=t.constantHeight)return e;const o=[],s=1/Fd(r);for(const r of e)fg(r,new _c(t,s),0,o);return o}fillNonElevatedRoadSegment(e){for(let t=e;t<this.layoutVertexArray.length;t++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,t,r,o,s,l,c,h,u){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=u?this.lineFeatureClips(t,u):this.lineClips;const d="none"===o;this.patternJoinNone=this.hasPattern&&d,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const p=h&&h.progress.min>0,f=h&&h.progress.max<1;if(this.lineClips){let r={min:this.lineClips.start,max:this.lineClips.end},o=1;if(h){const e=this.lineClips.end-this.lineClips.start;r=function(e,t,r){return{min:$t(e.min,t,r),max:$t(e.max,t,r)}}(h.progress,{min:0,max:1},r),e>0&&(o=(r.max-r.min)/e)}const s=+t.properties.mapbox_clip_feature_len,l=+t.properties.mapbox_clip_seg_len;if(Number.isNaN(s)||Number.isNaN(l)){for(let t=0;t<e.length-1;t++)this.totalDistance+=e[t].dist(e[t+1]);const t=this.totalDistance/(r.max-r.min);this.totalFeatureLength=Number.isFinite(t)?t:0,this.lineClips.start=r.min,this.lineClips.end=r.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=s,this.distance=l*o,this.lineClips.start=r.min,this.lineClips.end=r.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const m="Polygon"===Ax[t.type];let _=e.length;for(;_>=2&&e[_-1].equals(e[_-2]);)_--;let v=0;for(;v<_-1&&e[v].equals(e[v+1]);)v++;if(_<(m?3:2))return;"bevel"===o&&(l=1.05);const E=this.segments.prepareSegment(10*_,this.layoutVertexArray,this.indexArray);let P,C,R,z,D,O,F,B;h&&h.prevDir&&(O=h.prevDir.perp()),h&&h.nextDir&&(F=h.nextDir.perp()),this.e1=this.e2=-1,m&&(P=e[_-2],D=e[v].sub(P)._unit()._perp());for(let t=v;t<_;t++){if(R=t===_-1?m?e[v+1]:void 0:e[t+1],R&&e[t].equals(R))continue;D&&(z=D),P&&(C=P),P=e[t],B=this.evaluateLineProgressFeatures(C?C.dist(P):0),D=R?R.sub(P)._unit()._perp():z,z=z||D;const r=C&&R;let h=r?o:m||d?"butt":s;const u=z.x*D.x+z.y*D.y;if(d){const e=function(e){if(e.patternJoinNone){const t=e.segmentPoints.length/2,r=e.lineSoFar-e.segmentStart;for(let o=0;o<t;++o){const t=e.segmentPoints[2*o+1],s=Math.round(e.segmentPoints[2*o])+.5+.25*t;e.patternVertexArray.emplaceBack(s,r,e.segmentStart),e.patternVertexArray.emplaceBack(s,r,e.segmentStart)}e.segmentPoints.length=0}e.e1=e.e2=-1};if(r&&u<Cx){this.updateDistance(C,P),this.addCurrentVertex(P,z,1,1,E,B),e(this),this.addCurrentVertex(P,D,-1,-1,E,B);continue}if(C){if(!R){this.updateDistance(C,P),this.addCurrentVertex(P,z,1,1,E,B),e(this);continue}h="miter"}}let k=z.add(D);0===k.x&&0===k.y||k._unit();const V=k.x*D.x+k.y*D.y,N=0!==V?1/V:1/0,U=2*Math.sqrt(2-2*V),j=V<Mx&&C&&R,$=z.x*D.y-z.y*D.x>0,q=this.overscaling<=16?122880/(512*this.overscaling):0;if(r&&"round"===h)if(N<c)h="miter";else if(N<=2){const e=Rx(P,-10,8202);h="offset"===this.elevationType&&(e||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===h&&N>l&&(h="bevel"),"bevel"===h&&(N>2&&(h="flipbevel"),N<l&&(h="miter")),C&&!("miter"===h&&j)&&this.updateDistance(C,P),"miter"===h)if(j){const e=P.dist(C);if(e>2*q){const t=P.sub(P.sub(C)._mult(q/e)._round());this.updateDistance(C,t),this.addCurrentVertex(t,z,0,0,E,B),C=t}this.updateDistance(C,P),k._mult(N),this.addCurrentVertex(P,k,0,0,E,B);const t=P.dist(R);if(t>2*q){const e=P.add(R.sub(P)._mult(q/t)._round());this.updateDistance(P,e),this.addCurrentVertex(e,D,0,0,E,B),P=e}}else k._mult(N),this.addCurrentVertex(P,k,0,0,E,B);else if("flipbevel"===h){if(N>100)k=D.mult(-1);else{const e=N*z.add(D).mag()/z.sub(D).mag();k._perp()._mult(e*($?-1:1))}this.addCurrentVertex(P,k,0,0,E,B),this.addCurrentVertex(P,k.mult(-1),0,0,E,B)}else if("bevel"===h||"fakeround"===h){null!=B&&C&&this.addCurrentVertex(P,F||z,-1,-1,E,B);const e=P.dist(C)<=2*q&&"bevel"!==h,t=k.mult($?1:-1);t._mult(N);const r=D.mult($?-1:1),o=z.mult($?-1:1),s=this.evaluateLineProgressFeatures(this.distance);if(null==B&&(this.addHalfVertex(P,t.x,t.y,!1,!$,0,E,s),e||this.addHalfVertex(P,t.x+2*o.x,t.y+2*o.y,!1,$,0,E,s)),"fakeround"===h){const e=Math.round(180*U/Math.PI/20);this.addHalfVertex(P,o.x,o.y,!1,$,0,E,s);for(let t=0;t<e;t++){let l=t/e;if(.5!==l){const e=l-.5;l+=l*e*(l-1)*((1.0904+u*(u*(3.55645-1.43519*u)-3.2452))*e*e+(.848013+u*(.215638*u-1.06021)))}const c=r.sub(o)._mult(l)._add(o)._unit();this.addHalfVertex(P,c.x,c.y,!1,$,0,E,s)}this.addHalfVertex(P,r.x,r.y,!1,$,0,E,s)}e||null!=B||this.addHalfVertex(P,t.x+2*r.x,t.y+2*r.y,!1,$,0,E,s),null!=B&&R&&this.addCurrentVertex(P,O||D,1,1,E,B)}else if("butt"===h)this.addCurrentVertex(P,k,0,0,E,B);else if("square"===h){if(!C){const e=p?0:-1;this.addCurrentVertex(P,k,e,e,E,B)}if(this.addCurrentVertex(P,k,0,0,E,B),C){const e=f?0:1;this.addCurrentVertex(P,k,e,e,E,B)}}else if("round"===h){if(C){const e=!r&&F?F:z;this.addCurrentVertex(P,e,0,0,E,B),!r&&f||this.addCurrentVertex(P,e,1,1,E,B,!0)}if(R){const e=!r&&O?O:D;!r&&p||this.addCurrentVertex(P,e,-1,-1,E,B,!0),this.addCurrentVertex(P,e,0,0,E,B)}}}}addVerticesTo(e,t,r,o,s,l,c,h,u,d){const p=(t.w-e.w)/this.tessellationStep|0;let f=0;const m=this.scaledDistance;if(p>1){this.lineSoFar=e.w;const m=(t.x-e.x)/p,_=(t.y-e.y)/p,v=(t.z-e.z)/p,E=(t.w-e.w)/p;for(let t=1;t<p;++t){e.x+=m,e.y+=_,e.z+=v,this.lineSoFar+=E,f+=E;const t=this.evaluateLineProgressFeatures(this.prevDistance+f);this.scaledDistance=(this.prevDistance+f)/this.totalDistance,this.addHalfVertex(e,r,o,d,!1,c,u,t),this.addHalfVertex(e,s,l,d,!0,-h,u,t)}}this.lineSoFar=t.w,this.scaledDistance=m;const _=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(t,r,o,d,!1,c,u,_),this.addHalfVertex(t,s,l,d,!0,-h,u,_)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&"offset"!==this.elevationType)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Et(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let t=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(t=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),"offset"!==this.elevationType?{zOffset:0,variableWidth:t}:"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:t}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:t}}addCurrentVertex(e,t,r,o,s,l,c=!1){const h=t.x+t.y*r,u=t.y-t.x*r,d=t.y*o-t.x,p=-t.y-t.x*o;if(null!=l){const t="offset"===this.elevationType,f=-10,m=8202,_=l.zOffset,v=new kf(e.x,e.y,_,this.lineSoFar),E=!!t&&Rx(e,f,m),P=this.lineSoFar,C=this.distance;if(this.currentVertex)if(E){const t=this.currentVertexIsOutside,l=this.currentVertex,E=new kf(e.x,e.y,_,this.lineSoFar);if(dg(l,E,f,m),!Rx(E,f,m)){if(t){this.e1=this.e2=-1,this.distance-=l.dist(v),this.lineSoFar=l.w;const e=this.evaluateLineProgressFeatures(l.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(l,h,u,c,!1,r,s,e),this.addHalfVertex(l,d,p,c,!0,-o,s,e),this.prevDistance=this.distance}this.distance=this.prevDistance+l.dist(E),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(l,E,h,u,d,p,r,o,s,c),this.distance=C,this.scaledDistance=this.distance/this.totalDistance}}else{const e=this.currentVertex;if(this.currentVertexIsOutside){dg(e,v,f,m),this.e1=this.e2=-1,this.distance-=e.dist(v),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e.w;const t=this.evaluateLineProgressFeatures(e.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(e,h,u,c,!1,r,s,t),this.addHalfVertex(e,d,p,c,!0,-o,s,t),this.prevDistance=this.distance,this.distance=C,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(e,v,h,u,d,p,r,o,s,c)}else E||(this.addHalfVertex(e,h,u,c,!1,r,s,l),this.addHalfVertex(e,d,p,c,!0,-o,s,l));this.currentVertex=v,this.currentVertexIsOutside=E,this.lineSoFar=P}else this.addHalfVertex(e,h,u,c,!1,r,s,l),this.addHalfVertex(e,d,p,c,!0,-o,s,l)}addHalfVertex({x:e,y:t},r,o,s,l,c,h,u){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),l||this.segmentPoints.push(this.lineSoFar-this.segmentStart,c)),this.layoutVertexArray.emplaceBack((e<<1)+(s?1:0),(t<<1)+(l?1:0),Math.round(63*r)+128,Math.round(63*o)+128,1+(0===c?0:c<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const e=Ar(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,e)}const d=h.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,d),h.primitiveLength++),l?this.e2=d:this.e1=d,null!=u&&this.zOffsetVertexArray.emplaceBack(u.zOffset,u.variableWidth,u.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,t){this.prevDistance=this.distance,this.distance+=e.dist(t),this.updateScaledDistance()}}function Rx(e,t,r){return e.x<t||e.x>r||e.y<t||e.y>r}let zx,Dx;function Lx(e,t,r){return t*(Ao/(e.tileSize*Math.pow(2,r-e.tileID.overscaledZ)))}ih(Qy,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Ox=(e,t,r)=>(1-r)*e+r*t;function Fx(e,t){return 1/Lx(e,1,t.tileZoom)}function Bx(e,t,r,o){return e.translatePosMatrix(o||t.tileID.projMatrix,t,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}const kx=e=>{const t=[];Nx(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const r=e.paint.get("line-trim-offset");0===r[0]&&0===r[1]||t.push("RENDER_LINE_TRIM_OFFSET"),0!==e.paint.get("line-border-width").constantOr(1)&&t.push("RENDER_LINE_BORDER");const o="none"===e.layout.get("line-join").constantOr("miter"),s=!!e.paint.get("line-pattern").constantOr(1);return o&&s&&t.push("LINE_JOIN_NONE"),t};function Nx(e){const t=e.paint.get("line-dasharray").value;return"constant"!==t.kind||t.value}let Ux;const jx=()=>Ux||(Ux={layout:zx||(zx=new uo({"line-cap":new oo(mu.layout_line["line-cap"]),"line-join":new oo(mu.layout_line["line-join"]),"line-miter-limit":new ao(mu.layout_line["line-miter-limit"]),"line-round-limit":new ao(mu.layout_line["line-round-limit"]),"line-sort-key":new oo(mu.layout_line["line-sort-key"]),"line-z-offset":new oo(mu.layout_line["line-z-offset"]),"line-elevation-reference":new ao(mu.layout_line["line-elevation-reference"]),"line-cross-slope":new ao(mu.layout_line["line-cross-slope"]),visibility:new ao(mu.layout_line.visibility),"line-width-unit":new ao(mu.layout_line["line-width-unit"])})),paint:Dx||(Dx=new uo({"line-opacity":new oo(mu.paint_line["line-opacity"]),"line-color":new oo(mu.paint_line["line-color"]),"line-translate":new ao(mu.paint_line["line-translate"]),"line-translate-anchor":new ao(mu.paint_line["line-translate-anchor"]),"line-width":new oo(mu.paint_line["line-width"]),"line-gap-width":new oo(mu.paint_line["line-gap-width"]),"line-offset":new oo(mu.paint_line["line-offset"]),"line-blur":new oo(mu.paint_line["line-blur"]),"line-dasharray":new oo(mu.paint_line["line-dasharray"]),"line-pattern":new oo(mu.paint_line["line-pattern"]),"line-pattern-cross-fade":new ao(mu.paint_line["line-pattern-cross-fade"]),"line-gradient":new lo(mu.paint_line["line-gradient"]),"line-trim-offset":new ao(mu.paint_line["line-trim-offset"]),"line-trim-fade-range":new ao(mu.paint_line["line-trim-fade-range"]),"line-trim-color":new ao(mu.paint_line["line-trim-color"]),"line-emissive-strength":new oo(mu.paint_line["line-emissive-strength"]),"line-border-width":new oo(mu.paint_line["line-border-width"]),"line-border-color":new oo(mu.paint_line["line-border-color"]),"line-occlusion-opacity":new ao(mu.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},Ux);class hg extends oo{possiblyEvaluate(e,t){return t=new Ja(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition,worldview:t.worldview}),super.possiblyEvaluate(e,t)}evaluate(e,t,r,o){return t=Object.assign({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,r,o)}}let Gx;function $x(e,t){return t>0?t+2*e:e}const Hx=Uu([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Wx=Uu([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Zx=Uu([{name:"a_projected_pos",components:4,type:"Float32"}],4);Uu([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Xx=Uu([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Yx=Uu([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Jx=Uu([{name:"a_texb",components:2,type:"Uint16"}]),Qx=Uu([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Kx=Uu([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Uu([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const ev=Uu([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),tv=Uu([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Uu([{name:"triangle",components:3,type:"Uint16"}]),Uu([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Uu([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Uu([{type:"Float32",name:"offsetX"}]),Uu([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var iv=24;function rv(e,t,r){return e.sections.forEach((e=>{e.text=function(e,t,r){const o=t.layout.get("text-transform").evaluate(r,{});return"uppercase"===o?e=e.toLocaleUpperCase():"lowercase"===o&&(e=e.toLocaleLowerCase()),au.applyArabicShaping&&(e=au.applyArabicShaping(e)),e}(e.text,t,r)})),e}const nv={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function ov(e){return""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e}function sv(e){return""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e||""===e}const av=4294967296,lv=1/av,cv="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");let hv=class{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,r=this.length){for(;this.pos<r;){const r=this.readVarint(),o=r>>3,s=this.pos;this.type=7&r,e(o,t,this),this.pos===s&&this.skip(r)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*av;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*av;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let r,o;return o=t[this.pos++],r=127&o,o<128?r:(o=t[this.pos++],r|=(127&o)<<7,o<128?r:(o=t[this.pos++],r|=(127&o)<<14,o<128?r:(o=t[this.pos++],r|=(127&o)<<21,o<128?r:(o=t[this.pos],r|=(15&o)<<28,function(e,t,r){const o=r.buf;let s,l;if(l=o[r.pos++],s=(112&l)>>4,l<128)return uv(e,s,t);if(l=o[r.pos++],s|=(127&l)<<3,l<128)return uv(e,s,t);if(l=o[r.pos++],s|=(127&l)<<10,l<128)return uv(e,s,t);if(l=o[r.pos++],s|=(127&l)<<17,l<128)return uv(e,s,t);if(l=o[r.pos++],s|=(127&l)<<24,l<128)return uv(e,s,t);if(l=o[r.pos++],s|=(1&l)<<31,l<128)return uv(e,s,t);throw new Error("Expected varint not more than 10 bytes")}(r,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return Boolean(this.readVarint())}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&cv?cv.decode(this.buf.subarray(t,e)):function(e,t,r){let o="",s=t;for(;s<r;){const t=e[s];let l,c,h,u=null,d=t>239?4:t>223?3:t>191?2:1;if(s+d>r)break;1===d?t<128&&(u=t):2===d?(l=e[s+1],128==(192&l)&&(u=(31&t)<<6|63&l,u<=127&&(u=null))):3===d?(l=e[s+1],c=e[s+2],128==(192&l)&&128==(192&c)&&(u=(15&t)<<12|(63&l)<<6|63&c,(u<=2047||u>=55296&&u<=57343)&&(u=null))):4===d&&(l=e[s+1],c=e[s+2],h=e[s+3],128==(192&l)&&128==(192&c)&&128==(192&h)&&(u=(15&t)<<18|(63&l)<<12|(63&c)<<6|63&h,(u<=65535||u>=1114112)&&(u=null))),null===u?(u=65533,d=1):u>65535&&(u-=65536,o+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),o+=String.fromCharCode(u),s+=d}return o}(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(e){const t=7&e;if(0===t)for(;this.buf[this.pos++]>127;);else if(2===t)this.pos=this.readVarint()+this.pos;else if(5===t)this.pos+=4;else{if(1!==t)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.dataView=new DataView(e.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*lv),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*lv),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?function(e,t){let r,o;if(e>=0?(r=e%4294967296|0,o=e/4294967296|0):(r=~(-e%4294967296),o=~(-e/4294967296),4294967295^r?r=r+1|0:(r=0,o=o+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,r){r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,r.buf[r.pos]=127&(e>>>=7)}(r,0,t),function(e,t){const r=(7&e)<<4;t.buf[t.pos++]|=r|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}(o,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const t=this.pos;this.pos=function(e,t,r){for(let o,s,l=0;l<t.length;l++){if(o=t.charCodeAt(l),o>55295&&o<57344){if(!s){o>56319||l+1===t.length?(e[r++]=239,e[r++]=191,e[r++]=189):s=o;continue}if(o<56320){e[r++]=239,e[r++]=191,e[r++]=189,s=o;continue}o=s-55296<<10|o-56320|65536,s=null}else s&&(e[r++]=239,e[r++]=191,e[r++]=189,s=null);o<128?e[r++]=o:(o<2048?e[r++]=o>>6|192:(o<65536?e[r++]=o>>12|224:(e[r++]=o>>18|240,e[r++]=o>>12&63|128),e[r++]=o>>6&63|128),e[r++]=63&o|128)}return r}(this.buf,e,this.pos);const r=this.pos-t;r>=128&&dv(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=e[r]}writeRawMessage(e,t){this.pos++;const r=this.pos;e(t,this);const o=this.pos-r;o>=128&&dv(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o}writeMessage(e,t,r){this.writeTag(e,2),this.writeRawMessage(t,r)}writePackedVarint(e,t){t.length&&this.writeMessage(e,pv,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,fv,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,gv,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,mv,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,_v,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,yv,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,xv,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,vv,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,bv,t)}writeBytesField(e,t){this.writeTag(e,2),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,5),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,5),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,1),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,1),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,0),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,0),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,2),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,5),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,1),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}};function uv(e,t,r){return r?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function dv(e,t,r){const o=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(o);for(let t=r.pos-1;t>=e;t--)r.buf[t+o]=r.buf[t]}function pv(e,t){for(let r=0;r<e.length;r++)t.writeVarint(e[r])}function fv(e,t){for(let r=0;r<e.length;r++)t.writeSVarint(e[r])}function mv(e,t){for(let r=0;r<e.length;r++)t.writeFloat(e[r])}function _v(e,t){for(let r=0;r<e.length;r++)t.writeDouble(e[r])}function gv(e,t){for(let r=0;r<e.length;r++)t.writeBoolean(e[r])}function yv(e,t){for(let r=0;r<e.length;r++)t.writeFixed32(e[r])}function xv(e,t){for(let r=0;r<e.length;r++)t.writeSFixed32(e[r])}function vv(e,t){for(let r=0;r<e.length;r++)t.writeFixed64(e[r])}function bv(e,t){for(let r=0;r<e.length;r++)t.writeSFixed64(e[r])}function wv(e,t,r){t.glyphs=[],1===e&&r.readMessage(Tv,t)}function Tv(e,t,r){if(3===e){const{id:e,bitmap:o,width:s,height:l,left:c,top:h,advance:u}=r.readMessage(Av,{});t.glyphs.push({id:e,bitmap:new qh({width:s+6,height:l+6},o),metrics:{width:s,height:l,left:c,top:h,advance:u}})}else 4===e?t.ascender=r.readSVarint():5===e&&(t.descender=r.readSVarint())}function Av(e,t,r){1===e?t.id=r.readVarint():2===e?t.bitmap=r.readBytes():3===e?t.width=r.readVarint():4===e?t.height=r.readVarint():5===e?t.left=r.readSVarint():6===e?t.top=r.readSVarint():7===e&&(t.advance=r.readVarint())}const Mv={horizontal:1,vertical:2,horizontalOnly:3};class Zg{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,t){const r=new Zg;return r.scale=e||1,r.fontStack=t,r}static forImage(e){const t=new Zg;return t.image=e,t}}class Wg{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,t,r){const o=new Wg;for(let s=0;s<e.sections.length;s++){const l=e.sections[s];l.image?o.addImageSection(l,r):o.addTextSection(l,t)}return o}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(e,t){let r="";for(let o=0;o<e.length;o++){const s=e.charCodeAt(o+1)||null,l=e.charCodeAt(o-1)||null;r+=!t&&(s&&Uh(s)&&!nv[e[o+1]]||l&&Uh(l)&&!nv[e[o-1]])||!nv[e[o]]?e[o]:nv[e[o]]}return r}(this.text,e)}trim(){let e=0;for(let t=0;t<this.text.length&&zv[this.text.charCodeAt(t)];t++)e++;let t=this.text.length;for(let r=this.text.length-1;r>=0&&r>=e&&zv[this.text.charCodeAt(r)];r--)t--;this.text=this.text.substring(e,t),this.sectionIndex=this.sectionIndex.slice(e,t)}substring(e,t){const r=new Wg;return r.text=this.text.substring(e,t),r.sectionIndex=this.sectionIndex.slice(e,t),r.sections=this.sections,r}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,t)=>Math.max(e,this.sections[t].scale)),0)}addTextSection(e,t){this.text+=e.text,this.sections.push(Zg.forText(e.scale,e.fontStack||t));const r=this.sections.length-1;for(let t=0;t<e.text.length;++t)this.sectionIndex.push(r)}addImageSection(e,t){const r=e.image?e.image.getPrimary():null;if(!r)return void Et("Can't add FormattedSection with an empty image.");r.scaleSelf(t);const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCodePoint(o),this.sections.push(Zg.forImage(r)),this.sectionIndex.push(this.sections.length-1)):Et("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Pv(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E=1){const P=Wg.fromFeature(e,s,E);f===Mv.vertical&&P.verticalizePunctuation(m);let C=[];const R=function(e,t,r,o,s,l){if(!e)return[];const c=[],h=function(e,t,r,o,s,l){let c=0;for(let r=0;r<e.length();r++){const h=e.getSection(r);c+=Lv(e.getCodePoint(r),h,o,s,t,l)}return c/Math.max(1,Math.ceil(c/r))}(e,t,r,o,s,l),u=e.text.indexOf("")>=0;let d=0;for(let r=0;r<e.length();r++){const p=e.getSection(r),f=e.getCodePoint(r);if(zv[f]||(d+=Lv(f,p,o,s,t,l)),r<e.length()-1){const t=kh(f);(Dv[f]||t||p.image)&&c.push(kv(r+1,d,h,c,Bv(f,e.getCodePoint(r+1),t&&u),!1))}}return Uv(kv(e.length(),d,h,c,0,!0))}(P,d,l,t,o,_),{processBidirectionalText:z,processStyledBidirectionalText:D}=au;if(z&&1===P.sections.length){const e=z(P.toString(),R);for(const t of e){const e=new Wg;e.text=t,e.sections=P.sections;for(let r=0;r<t.length;r++)e.sectionIndex.push(0);C.push(e)}}else if(D){const e=D(P.text,P.sectionIndex,R);for(const t of e){const e=new Wg;e.text=t[0],e.sectionIndex=t[1],e.sections=P.sections,C.push(e)}}else C=function(e,t){const r=[],o=e.text;let s=0;for(const o of t)r.push(e.substring(s,o)),s=o;return s<o.length&&r.push(e.substring(s,o.length)),r}(P,R);const O=[],F={positionedLines:O,text:P.toString(),top:p[1],bottom:p[1],left:p[0],right:p[0],writingMode:f,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(e,t,r,o,s,l,c,h,u,d,p,f){let m=0,_=0,v=0;const E="right"===h?1:"left"===h?0:.5;let P=!1;for(const e of s){const r=e.getSections();for(const e of r){if(e.image)continue;const r=t[e.fontStack];if(r&&(P=void 0!==r.ascender&&void 0!==r.descender,!P))break}if(!P)break}let C=0;for(const c of s){c.trim();const s=c.getMaxScale(),h=(s-1)*iv,R={positionedGlyphs:[],lineOffset:0};e.positionedLines[C]=R;const z=R.positionedGlyphs;let D=0;if(!c.length()){_+=l,++C;continue}let O=0,F=0;for(let l=0;l<c.length();l++){const h=c.getSection(l),v=c.getSectionIndex(l),E=c.getCodePoint(l);let C=h.scale,R=null,B=null,k=null,V=iv,N=0,U=u;U===Mv.vertical&&Nh(E)&&(U=Mv.horizontal);const j=!(U===Mv.horizontal||!p&&!Vh(E)||p&&(zv[E]||jh(E)));if(h.image){const t=o.get(h.image.toString());if(!t)continue;k=h.image,e.iconsInText=e.iconsInText||!0,B=t.paddedRect;const r=t.displaySize;C=C*iv/f,R={width:r[0],height:r[1],left:0,top:-3,advance:j?r[1]:r[0],localGlyph:!1},N=P?-R.height*C:s*iv-17-r[1]*C,V=R.advance;const l=(j?r[0]:r[1])*C-iv*s;l>0&&l>D&&(D=l)}else{const e=r[h.fontStack];if(!e)continue;e[E]&&(B=e[E]);const o=t[h.fontStack];if(!o)continue;const l=o.glyphs[E];if(!l)continue;if(R=l.metrics,V=8203!==E?iv:0,P){const e=void 0!==o.ascender?Math.abs(o.ascender):0,t=void 0!==o.descender?Math.abs(o.descender):0,r=(e+t)*C;O<r&&(O=r,F=(e-t)/2*C),N=-e*C}else N=(s-C)*iv-17}j?(e.verticalizable=!0,z.push({glyph:E,image:k,x:m,y:_+N,vertical:j,scale:C,localGlyph:R.localGlyph,fontStack:h.fontStack,sectionIndex:v,metrics:R,rect:B}),m+=V*C+d):(z.push({glyph:E,image:k,x:m,y:_+N,vertical:j,scale:C,localGlyph:R.localGlyph,fontStack:h.fontStack,sectionIndex:v,metrics:R,rect:B}),m+=R.advance*C+d)}0!==z.length&&(v=Math.max(m-d,v),P?qv(z,E,D,F,l*s/2):qv(z,E,D,0,l/2)),m=0;const B=l*s+D;R.lineOffset=Math.max(D,h),_+=B,++C}const R=_,{horizontalAlign:z,verticalAlign:D}=$v(c);(function(e,t,r,o,s,l){const c=(t-r)*s,h=-l*o;for(const t of e)for(const e of t.positionedGlyphs)e.x+=c,e.y+=h})(e.positionedLines,E,z,D,v,R),e.top+=-D*R,e.bottom=e.top+R,e.left+=-z*v,e.right=e.left+v,e.hasBaseline=P}(F,t,r,o,C,c,h,u,f,d,m,v),!function(e){for(const t of e)if(0!==t.positionedGlyphs.length)return!1;return!0}(O))return F}const zv={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Dv={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Lv(e,t,r,o,s,l){if(t.image){const e=o.get(t.image.toString());return e?e.displaySize[0]*t.scale*iv/l+s:0}{const o=r[t.fontStack],l=o&&o.glyphs[e];return l?l.metrics.advance*t.scale+s:0}}function Fv(e,t,r,o){const s=Math.pow(e-t,2);return o?e<t?s/2:2*s:s+Math.abs(r)*r}function Bv(e,t,r){let o=0;return 10===e&&(o-=1e4),r&&(o+=150),40!==e&&65288!==e||(o+=50),41!==t&&65289!==t||(o+=50),o}function kv(e,t,r,o,s,l){let c=null,h=Fv(t,r,s,l);for(const e of o){const o=Fv(t-e.x,r,s,l)+e.badness;o<=h&&(c=e,h=o)}return{index:e,x:t,priorBreak:c,badness:h}}function Uv(e){return e?Uv(e.priorBreak).concat(e.index):[]}function $v(e){let t=.5,r=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function qv(e,t,r,o,s){if(!(t||r||o||s))return;const l=e.length-1,c=e[l],h=(c.x+c.metrics.advance*c.scale)*t;for(let t=0;t<=l;t++)e[t].x-=h,e[t].y+=r+o+s}function Hv(e){return void 0!==e.imagePrimary&&void 0!==e.top&&void 0!==e.bottom&&void 0!==e.left&&void 0!==e.right}function Wv(e,t,r,o){const{horizontalAlign:s,verticalAlign:l}=$v(o),c=r[0]-e.displaySize[0]*s,h=r[1]-e.displaySize[1]*l;return{imagePrimary:e,imageSecondary:t,top:h,bottom:h+e.displaySize[1],left:c,right:c+e.displaySize[0]}}function Zv(e,t,r,o,s,l){const c=e.imagePrimary;let h;if(c.content){const e=c.content,t=c.pixelRatio||1;h=[e[0]/t,e[1]/t,c.displaySize[0]-e[2]/t,c.displaySize[1]-e[3]/t]}const u=t.left*l,d=t.right*l;let p,f,m,_;"width"===r||"both"===r?(_=s[0]+u-o[3],f=s[0]+d+o[1]):(_=s[0]+(u+d-c.displaySize[0])/2,f=_+c.displaySize[0]);const v=t.top*l,E=t.bottom*l;return"height"===r||"both"===r?(p=s[1]+v-o[0],m=s[1]+E+o[2]):(p=s[1]+(v+E-c.displaySize[1])/2,m=p+c.displaySize[1]),{imagePrimary:c,imageSecondary:void 0,top:p,right:f,bottom:m,left:_,collisionPadding:h}}function Xv(e){return!e.imagePrimary.stretchX}function Yv(e){return!e.imagePrimary.stretchY}function Jv(e){return{width:e.right-e.left,height:e.bottom-e.top}}const Kv=128;function ib(e,t,r,o){const{expression:s}=t;if("constant"===s.kind)return{kind:"constant",layoutSize:s.evaluate(new Ja(e+1,{worldview:r}),void 0,void 0,void 0,o)};if("source"===s.kind)return{kind:"source"};{const{zoomStops:t,interpolationType:l}=s;let c=0;for(;c<t.length&&t[c]<=e;)c++;c=Math.max(0,c-1);let h=c;for(;h<t.length&&t[h]<e+1;)h++;h=Math.min(t.length-1,h);const u=t[c],d=t[h];return"composite"===s.kind?{kind:"composite",minZoom:u,maxZoom:d,interpolationType:l}:{kind:"camera",minZoom:u,maxZoom:d,minSize:s.evaluate(new Ja(u,{worldview:r}),void 0,void 0,void 0,o),maxSize:s.evaluate(new Ja(d,{worldview:r}),void 0,void 0,void 0,o),interpolationType:l}}}function rb(e,{uSize:t,uSizeT:r},{lowerSize:o,upperSize:s}){return"source"===e.kind?o/Kv:"composite"===e.kind?Ar(o/Kv,s/Kv,r):t}function nb(e,t,r=1){let o=0,s=0;if("constant"===e.kind)s=e.layoutSize*r;else if("source"!==e.kind){const{interpolationType:l,minZoom:c,maxZoom:h}=e,u=l?ct(Hi.interpolationFactor(l,t,c,h),0,1):0;"camera"===e.kind?s=Ar(e.minSize,e.maxSize,u)*r:o=u*r}return{uSizeT:o,uSize:s}}class yx extends Je{constructor(e,t,r,o,s){super(e,t),this.angle=o,this.z=r,void 0!==s&&(this.segment=s)}clone(){return new yx(this.x,this.y,this.z,this.angle,this.segment)}}function ob(e,t,r,o,s){if(void 0===t.segment)return!0;let l=t,c=t.segment+1,h=0;for(;h>-r/2;){if(c--,c<0)return!1;h-=e[c].dist(l),l=e[c]}h+=e[c].dist(e[c+1]),c++;const u=[];let d=0;for(;h<r/2;){const t=e[c],r=e[c+1];if(!r)return!1;let l=e[c-1].angleTo(t)-t.angleTo(r);for(l=Math.abs((l+3*Math.PI)%(2*Math.PI)-Math.PI),u.push({distance:h,angleDelta:l}),d+=l;h-u[0].distance>o;)d-=u.shift().angleDelta;if(d>s)return!1;c++,h+=t.dist(r)}return!0}function sb(e){let t=0;for(let r=0;r<e.length-1;r++)t+=e[r].dist(e[r+1]);return t}function cb(e,t,r){return e?.6*t*r:0}function hb(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function ub(e,t,r,o,s,l){const c=cb(r,s,l),h=hb(r,o)*l;let u=0;const d=sb(e)/2;for(let r=0;r<e.length-1;r++){const o=e[r],s=e[r+1],l=o.dist(s);if(u+l>d){const p=(d-u)/l,f=Ar(o.x,s.x,p),m=Ar(o.y,s.y,p),_=new yx(f,m,0,s.angleTo(o),r);return!c||ob(e,_,h,c,t)?_:void 0}u+=l}}function db(e,t,r,o,s,l,c,h,u){const d=cb(o,l,c),p=hb(o,s),f=p*c,m=0===e[0].x||e[0].x===u||0===e[0].y||e[0].y===u;return t-f<t/4&&(t=f+t/4),pb(e,m?t/2*h%t:(p/2+2*l)*c*h%t,t,d,r,f,m,!1,u)}function pb(e,t,r,o,s,l,c,h,u){const d=l/2,p=sb(e);let f=0,m=t-r,_=[];for(let t=0;t<e.length-1;t++){const c=e[t],h=e[t+1],v=c.dist(h),E=h.angleTo(c);for(;m+r<f+v;){m+=r;const P=(m-f)/v,C=Ar(c.x,h.x,P),R=Ar(c.y,h.y,P);if(C>=0&&C<u&&R>=0&&R<u&&m-d>=0&&m+d<=p){const r=new yx(C,R,0,E,t);o&&!ob(e,r,l,o,s)||_.push(r)}}f+=v}return h||_.length||c||(_=pb(e,f/2,r,o,s,l,c,!0,u)),_}function fb(e){let t=0,r=0;for(const o of e)t+=o.w*o.h,r=Math.max(r,o.w);e.sort(((e,t)=>t.h-e.h));const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let s=0,l=0;for(const t of e)for(let e=o.length-1;e>=0;e--){const r=o[e];if(!(t.w>r.w||t.h>r.h)){if(t.x=r.x,t.y=r.y,l=Math.max(l,t.y+t.h),s=Math.max(s,t.x+t.w),t.w===r.w&&t.h===r.h){const t=o.pop();t&&e<o.length&&(o[e]=t)}else t.h===r.h?(r.x+=t.w,r.w-=t.w):t.w===r.w?(r.y+=t.h,r.h-=t.h):(o.push({x:r.x+t.w,y:r.y,w:r.w-t.w,h:t.h}),r.y+=t.h,r.h-=t.h);break}}return{w:s,h:l,fill:t/(s*l)||0}}ih(yx,"Anchor");class Ix{static getImagePositionScale(e,t,r){if(t&&e){const{sx:t,sy:r}=e;return{x:t,y:r}}return{x:r,y:r}}constructor(e,t,r,o){this.paddedRect=e;const{pixelRatio:s,version:l,stretchX:c,stretchY:h,content:u,sdf:d,usvg:p}=t;this.pixelRatio=s,this.stretchX=c,this.stretchY=h,this.content=u,this.version=l,this.padding=r,this.sdf=d,this.usvg=p,this.scale=Ix.getImagePositionScale(o,p,s)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function mb(e,t,r){const o=Lr.parse(e),s=function(e,t,r=[1,1]){return{x:0,y:0,w:(e.data?e.data.width:e.width*r[0])+2*t,h:(e.data?e.data.height:e.height*r[1])+2*t}}(t,r,[o.sx,o.sy]);return{bin:s,imagePosition:new Ix(s,t,r,o),imageVariant:o}}class Px{constructor(e,t,r){const o=new Map,s=new Map;this.haveRenderCallbacks=[];const l=[];this.addImages(e,o,1,l),this.addImages(t,s,2,l);const{w:c,h:h}=fb(l),u=new Xh({width:c||1,height:h||1});for(const[t,r]of e.entries()){const e=o.get(t).paddedRect;Xh.copy(r.data,u,{x:0,y:0},{x:e.x+1,y:e.y+1},r.data,null,r.sdf)}for(const[e,o]of t.entries()){const t=s.get(e),l=t.paddedRect;let c=t.padding;const h=l.x+c,d=l.y+c,p=o.data.width,f=o.data.height;c=c>1?c-1:c,Xh.copy(o.data,u,{x:0,y:0},{x:h,y:d},o.data,r),Xh.copy(o.data,u,{x:0,y:f-c},{x:h,y:d-c},{width:p,height:c},r),Xh.copy(o.data,u,{x:0,y:0},{x:h,y:d+f},{width:p,height:c},r),Xh.copy(o.data,u,{x:p-c,y:0},{x:h-c,y:d},{width:c,height:f},r),Xh.copy(o.data,u,{x:0,y:0},{x:h+p,y:d},{width:c,height:f},r),Xh.copy(o.data,u,{x:p-c,y:f-c},{x:h-c,y:d-c},{width:c,height:c},r),Xh.copy(o.data,u,{x:0,y:f-c},{x:h+p,y:d-c},{width:c,height:c},r),Xh.copy(o.data,u,{x:0,y:0},{x:h+p,y:d+f},{width:c,height:c},r),Xh.copy(o.data,u,{x:p-c,y:0},{x:h-c,y:d+f},{width:c,height:c},r)}this.lut=r,this.image=u,this.iconPositions=o,this.patternPositions=s}addImages(e,t,r,o){for(const[s,l]of e.entries()){const{bin:e,imagePosition:c,imageVariant:h}=mb(s,l,r);t.set(s,c),o.push(e),l.hasRenderCallback&&this.haveRenderCallbacks.push(h.id)}}patchUpdatedImages(e,t,r,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((t=>e.hasImage(t,r))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,r);for(const s of e.getUpdatedImages(r)){for(const o of this.iconPositions.keys()){const l=Lr.parse(o);if(sr.isEqual(l.id,s)){const l=e.getImage(s,r);this.patchUpdatedImage(this.iconPositions.get(o),l,t,null)}}for(const l of this.patternPositions.keys()){const c=Lr.parse(l);if(sr.isEqual(c.id,s)){const c=e.getImage(s,r);this.patchUpdatedImage(this.patternPositions.get(l),c,t,o||this.lut)}}}}patchUpdatedImage(e,t,r,o=null){if(!e||!t)return;if(e.version===t.version)return;e.version=t.version;const[s,l]=e.tl,c=e.sdf;if(this.lut||c){const e={width:t.data.width,height:t.data.height},h=new Xh(e);Xh.copy(t.data,h,{x:0,y:0},{x:0,y:0},e,o,c),r.update(h,{position:{x:s,y:l}})}else r.update(t.data,{position:{x:s,y:l}})}}ih(Ix,"ImagePosition"),ih(Px,"ImageAtlas",{omit:["lut"]});const _b=1e20;function yb(e,t,r,o,s,l,c,h,u){for(let d=t;d<t+o;d++)xb(e,r*l+d,l,s,c,h,u);for(let d=r;d<r+s;d++)xb(e,d*l+t,1,o,c,h,u)}function xb(e,t,r,o,s,l,c){l[0]=0,c[0]=-_b,c[1]=_b,s[0]=e[t];for(let h=1,u=0,d=0;h<o;h++){s[h]=e[t+h*r];const o=h*h;do{const e=l[u];d=(s[h]-s[e]+o-e*e)/(h-e)/2}while(d<=c[u]&&--u>-1);u++,l[u]=h,c[u]=d,c[u+1]=_b}for(let h=0,u=0;h<o;h++){for(;c[u+1]<h;)u++;const o=l[u],d=h-o;e[t+h*r]=s[o]+d*d}}const vb={none:0,ideographs:1,all:2};class Vx{constructor(e,t,r){this.requestManager=e,this.localGlyphMode=t,this.localFontFamily=r,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,t){const r=[],o=this.url||qt.GLYPHS_URL;for(const t in e)for(const o of e[t])r.push({stack:t,id:o});_t(r,(({stack:e,id:t},r)=>{let s=this.entries[e];s||(s=this.entries[e]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let l=s.glyphs[t];if(void 0!==l)return void r(null,{stack:e,id:t,glyph:l});if(l=this._tinySDF(s,e,t),l)return s.glyphs[t]=l,void r(null,{stack:e,id:t,glyph:l});const c=Math.floor(t/256);if(256*c>65535)return Et("glyphs > 65535 not supported"),void r(null,{stack:e,id:t,glyph:l});if(s.ranges[c])return void r(null,{stack:e,id:t,glyph:l});let h=s.requests[c];h||(h=s.requests[c]=[],Vx.loadGlyphRange(e,c,o,this.requestManager,((e,t)=>{if(t){s.ascender=t.ascender,s.descender=t.descender;for(const e in t.glyphs)this._doesCharSupportLocalGlyph(+e)||(s.glyphs[+e]=t.glyphs[+e]);s.ranges[c]=!0}for(const r of h)r(e,t);delete s.requests[c]}))),h.push(((o,s)=>{o?r(o):s&&r(null,{stack:e,id:t,glyph:s.glyphs[t]||null})}))}),((e,r)=>{if(e)t(e);else if(r){const e={};for(const{stack:t,id:o,glyph:s}of r)void 0===e[t]&&(e[t]={}),void 0===e[t].glyphs&&(e[t].glyphs={}),e[t].glyphs[o]=s&&{id:s.id,bitmap:s.bitmap.clone(),metrics:s.metrics},e[t].ascender=this.entries[t].ascender,e[t].descender=this.entries[t].descender;t(null,e)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==vb.none&&(this.localGlyphMode===vb.all?!!this.localFontFamily:!!this.localFontFamily&&(Th(e)||Eh(e)||fh(e)||mh(e)||ph(e)||wh(e)||(t=e)>=131072&&t<=173791||(e=>e>=66736&&e<=66815)(e)));var t}_tinySDF(e,t,r){const o=this.localFontFamily;if(!o||!this._doesCharSupportLocalGlyph(r))return;let s=e.tinySDF;if(!s){let r="400";/bold/i.test(t)?r="900":/medium/i.test(t)?r="500":/light/i.test(t)&&(r="200"),s=e.tinySDF=new Vx.TinySDF({fontFamily:o,fontWeight:r,fontSize:48,buffer:6,radius:16}),s.fontWeight=r}if(this.localGlyphs[s.fontWeight][r])return this.localGlyphs[s.fontWeight][r];const l=String.fromCodePoint(r),{data:c,width:h,height:u,glyphWidth:d,glyphHeight:p,glyphLeft:f,glyphTop:m,glyphAdvance:_}=s.draw(l);return this.localGlyphs[s.fontWeight][r]={id:r,bitmap:new qh({width:h,height:u},c),metrics:{width:d/2,height:p/2,left:f/2,top:m/2-27,advance:_/2,localGlyph:!0}}}}function wb(e,t){return e+t[1]-t[0]}function Tb(e,t,r,o,s=1){const l=[],c=e.imagePrimary,h=c.pixelRatio,u=c.paddedRect.w-2,d=c.paddedRect.h-2,p=(e.right-e.left)*s,f=(e.bottom-e.top)*s,m=c.stretchX||[[0,u]],_=c.stretchY||[[0,d]],v=m.reduce(wb,0),E=_.reduce(wb,0),P=u-v,C=d-E;let R=0,z=v,D=0,O=E,F=0,B=P,k=0,V=C;if(c.content&&o){const e=c.content;R=Ab(m,0,e[0]),D=Ab(_,0,e[1]),z=Ab(m,e[0],e[2]),O=Ab(_,e[1],e[3]),F=e[0]-R,k=e[1]-D,B=e[2]-e[0]-z,V=e[3]-e[1]-O}const N=(o,l,u,d)=>{const m=zb(o.stretch-R,z,p,e.left*s),_=Db(o.fixed-F,B,o.stretch,v),P=zb(l.stretch-D,O,f,e.top*s),C=Db(l.fixed-k,V,l.stretch,E),N=zb(u.stretch-R,z,p,e.left*s),U=Db(u.fixed-F,B,u.stretch,v),j=zb(d.stretch-D,O,f,e.top*s),$=Db(d.fixed-k,V,d.stretch,E),q=new Je(m,P),H=new Je(N,P),Z=new Je(N,j),Y=new Je(m,j),J=new Je(_/h,C/h),Q=new Je(U/h,$/h),K=t*Math.PI/180;if(K){const e=Math.sin(K),t=Math.cos(K),r=[t,-e,e,t];q._matMult(r),H._matMult(r),Y._matMult(r),Z._matMult(r)}const ee=o.stretch+o.fixed,te=u.stretch+u.fixed,ie=l.stretch+l.fixed,re=d.stretch+d.fixed,ne=e.imageSecondary;return{tl:q,tr:H,bl:Y,br:Z,texPrimary:{x:c.paddedRect.x+1+ee,y:c.paddedRect.y+1+ie,w:te-ee,h:re-ie},texSecondary:ne?{x:ne.paddedRect.x+1+ee,y:ne.paddedRect.y+1+ie,w:te-ee,h:re-ie}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:J,pixelOffsetBR:Q,minFontScaleX:B/h/p,minFontScaleY:V/h/f,isSDF:r}};if(c.stretchX||c.stretchY){const e=Mb(m,P,v),t=Mb(_,C,E);for(let r=0;r<e.length-1;r++){const o=e[r],s=e[r+1];for(let e=0;e<t.length-1;e++)l.push(N(o,t[e],s,t[e+1]))}}else l.push(N({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:u+1},{fixed:0,stretch:d+1}));return l}function Ib(e,t){const r=e.stretchY||[[0,e.paddedRect.h-2]];return e.stretchX||e.stretchY?Cb(e.stretchX||[[0,e.paddedRect.w-2]])*Cb(r):1}function Ab(e,t,r){let o=0;for(const s of e)o+=Math.max(t,Math.min(r,s[1]))-Math.max(t,Math.min(r,s[0]));return o}function Mb(e,t,r){const o=[{fixed:-1,stretch:0}];for(const[t,r]of e){const e=o[o.length-1];o.push({fixed:t-e.stretch,stretch:e.stretch}),o.push({fixed:t-e.stretch,stretch:e.stretch+(r-t)})}return o.push({fixed:t+1,stretch:r}),o}function Cb(e){return 2*e.length+1}function zb(e,t,r,o){return e/t*r+o}function Db(e,t,r,o){return e-t*r/o}function Lb(e,t,r,o){const s=t+e.positionedLines[o].lineOffset;return 0===o?r+s/2:r+(s+(t+e.positionedLines[o-1].lineOffset))/2}function Ob(e,t,r,o,s,l,c,h,u){const d=[];if(0===t.positionedLines.length)return d;const p=(void 0!==u?u:o.layout.get("text-rotate").evaluate(l,{}))*Math.PI/180,f=function(e){const t=e[0],r=e[1],o=t*r;return o>0?[t,-r]:o<0?[-t,r]:0===t?[r,t]:[r,-t]}(r);let m=Math.abs(t.top-t.bottom);for(const e of t.positionedLines)m-=e.lineOffset;const _=t.positionedLines.length,v=m/_;let E=t.top-r[1];for(let e=0;e<_;++e){const o=t.positionedLines[e];E=Lb(t,v,E,e);for(const e of o.positionedGlyphs){if(!e.rect)continue;const o=e.rect||{};let l=4,u=!0,m=1,_=0;if(e.image){const t=c.get(e.image.toString());if(!t)continue;if(t.sdf){Et("SDF images are not supported in formatted text and will be ignored.");continue}u=!1,m=t.pixelRatio,l=1/m}const v=(s||h)&&e.vertical,P=e.metrics.advance*e.scale/2,C=e.metrics,R=e.rect;if(null===R)continue;h&&t.verticalizable&&(_=e.image?P-e.metrics.width*e.scale/2:0);const z=s?[e.x+P,e.y]:[0,0];let D=[0,0],O=[0,0],F=!1;s||(v?(O=[e.x+P+f[0],e.y+f[1]-_],F=!0):D=[e.x+P+r[0],e.y+r[1]-_]);const B=R.w*e.scale/(m*(e.localGlyph?2:1)),k=R.h*e.scale/(m*(e.localGlyph?2:1));let V,N,U,j;if(v){const t=e.y-E,r=new Je(-P,P-t),o=-Math.PI/2,s=new Je(...O);V=new Je(-P+D[0],D[1]),V._rotateAround(o,r)._add(s),V.x+=-t+P,V.y-=(C.left-l)*e.scale;const c=e.image?C.advance*e.scale:iv*e.scale,h=String.fromCodePoint(e.glyph);ov(h)?V.x+=(1-l)*e.scale:sv(h)?V.x+=c-C.height*e.scale+(-l-1)*e.scale:V.x+=e.image||C.width+2*l===R.w&&C.height+2*l===R.h?(c-k)/2:(c-(C.height+2*l)*e.scale)/2,N=new Je(V.x,V.y-B),U=new Je(V.x+k,V.y),j=new Je(V.x+k,V.y-B)}else{const t=(C.left-l)*e.scale-P+D[0],r=(-C.top-l)*e.scale+D[1],o=t+B,s=r+k;V=new Je(t,r),N=new Je(o,r),U=new Je(t,s),j=new Je(o,s)}if(p){let e;e=s?new Je(0,0):F?new Je(f[0],f[1]):new Je(r[0],r[1]),V._rotateAround(p,e),N._rotateAround(p,e),U._rotateAround(p,e),j._rotateAround(p,e)}const $=new Je(0,0),q=new Je(0,0);d.push({tl:V,tr:N,bl:U,br:j,texPrimary:o,texSecondary:void 0,writingMode:t.writingMode,glyphOffset:z,sectionIndex:e.sectionIndex,isSDF:u,pixelOffsetTL:$,pixelOffsetBR:q,minFontScaleX:0,minFontScaleY:0})}}return d}function Bb(e,t=1,r=!1){let o=1/0,s=1/0,l=-1/0,c=-1/0;const h=e[0];for(let e=0;e<h.length;e++){const t=h[e];(!e||t.x<o)&&(o=t.x),(!e||t.y<s)&&(s=t.y),(!e||t.x>l)&&(l=t.x),(!e||t.y>c)&&(c=t.y)}const u=Math.min(l-o,c-s);let d=u/2;const p=new Nn([],Nb);if(0===u)return new Je(o,s);for(let t=o;t<l;t+=u)for(let r=s;r<c;r+=u)p.push(new qx(t+d,r+d,d,e));let f=function(e){let t=0,r=0,o=0;const s=e[0];for(let e=0,l=s.length,c=l-1;e<l;c=e++){const l=s[e],h=s[c],u=l.x*h.y-h.x*l.y;r+=(l.x+h.x)*u,o+=(l.y+h.y)*u,t+=3*u}return new qx(r/t,o/t,0,e)}(e),m=p.length;for(;p.length;){const o=p.pop();(o.d>f.d||!f.d)&&(f=o,r&&console.log("found best %d after %d probes",Math.round(1e4*o.d)/1e4,m)),o.max-f.d<=t||(d=o.h/2,p.push(new qx(o.p.x-d,o.p.y-d,d,e)),p.push(new qx(o.p.x+d,o.p.y-d,d,e)),p.push(new qx(o.p.x-d,o.p.y+d,d,e)),p.push(new qx(o.p.x+d,o.p.y+d,d,e)),m+=4)}return r&&(console.log(`num probes: ${m}`),console.log(`best distance: ${f.d}`)),f.p}function Nb(e,t){return t.max-e.max}Vx.loadGlyphRange=function(e,t,r,o,s){const l=256*t,c=l+255,h=o.transformRequest(o.normalizeGlyphsURL(r).replace("{fontstack}",e).replace("{range}",`${l}-${c}`),Li.Glyphs);Bi(h,((e,t)=>{if(e)s(e);else if(t){const e={},r=function(e){return new hv(e).readFields(wv,{})}(t);for(const t of r.glyphs)e[t.id]=t;s(null,{glyphs:e,ascender:r.ascender,descender:r.descender})}}))},Vx.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:o=.25,fontFamily:s="sans-serif",fontWeight:l="normal",fontStyle:c="normal",lang:h=null}={}){this.buffer=t,this.cutoff=o,this.radius=r,this.lang=h;const u=this.size=e+4*t,d=this._createCanvas(u),p=this.ctx=d.getContext("2d",{willReadFrequently:!0});p.font=`${c} ${l} ${e}px ${s}`,p.textBaseline="alphabetic",p.textAlign="left",p.fillStyle="black",this.gridOuter=new Float64Array(u*u),this.gridInner=new Float64Array(u*u),this.f=new Float64Array(u),this.z=new Float64Array(u+1),this.v=new Uint16Array(u)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:o,actualBoundingBoxLeft:s,actualBoundingBoxRight:l}=this.ctx.measureText(e),c=Math.ceil(r),h=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(l-s))),u=Math.min(this.size-this.buffer,c+Math.ceil(o)),d=h+2*this.buffer,p=u+2*this.buffer,f=Math.max(d*p,0),m=new Uint8ClampedArray(f),_={data:m,width:d,height:p,glyphWidth:h,glyphHeight:u,glyphTop:c,glyphLeft:0,glyphAdvance:t};if(0===h||0===u)return _;const{ctx:v,buffer:E,gridInner:P,gridOuter:C}=this;this.lang&&(v.lang=this.lang),v.clearRect(E,E,h,u),v.fillText(e,E,E+c);const R=v.getImageData(E,E,h,u);C.fill(_b,0,f),P.fill(0,0,f);for(let e=0;e<u;e++)for(let t=0;t<h;t++){const r=R.data[4*(e*h+t)+3]/255;if(0===r)continue;const o=(e+E)*d+t+E;if(1===r)C[o]=0,P[o]=_b;else{const e=.5-r;C[o]=e>0?e*e:0,P[o]=e<0?e*e:0}}yb(C,0,0,d,p,d,this.f,this.v,this.z),yb(P,E,E,h,u,d,this.f,this.v,this.z);for(let e=0;e<f;e++){const t=Math.sqrt(C[e])-Math.sqrt(P[e]);m[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return _}};class qx{constructor(e,t,r,o){this.p=new Je(e,t),this.h=r,this.d=function(e,t){let r=!1,o=1/0;for(let s=0;s<t.length;s++){const l=t[s];for(let t=0,s=l.length,c=s-1;t<s;c=t++){const s=l[t],h=l[c];s.y>e.y!=h.y>e.y&&e.x<(h.x-s.x)*(e.y-s.y)/(h.y-s.y)+s.x&&(r=!r),o=Math.min(o,pp(e,s,h))}}return(r?1:-1)*Math.sqrt(o)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}}const Ub=Object.keys,jb=Number.POSITIVE_INFINITY,qb=Math.sqrt(2);function Hb(e,t,r,o,s){const l=Hv(e)&&e.collisionPadding?e.collisionPadding:[0,0,0,0],c={top:e.top-l[1],bottom:e.bottom+l[3],left:e.left-l[0],right:e.right+l[2],scaled:!1};return void 0!==o&&function(e,t){e.top*=t,e.bottom*=t,e.left*=t,e.right*=t,e.scaled=!0}(c,o),r&&function(e,t){if(!t)return;const r=it(t),o=new Je(e.left,e.top),s=new Je(e.right,e.top),l=new Je(e.left,e.bottom),c=new Je(e.right,e.bottom),h=new Je(0,0);o._rotateAround(r,h),s._rotateAround(r,h),l._rotateAround(r,h),c._rotateAround(r,h),e.left=Math.min(o.x,s.x,l.x,c.x),e.right=Math.max(o.x,s.x,l.x,c.x),e.top=Math.min(o.y,s.y,l.y,c.y),e.bottom=Math.max(o.y,s.y,l.y,c.y)}(c,r),s&&(c.left+=s[0],c.right+=s[0],c.top+=s[1],c.bottom+=s[1]),t?{top:Math.min(t.top,c.top),bottom:Math.max(t.bottom,c.bottom),left:Math.min(t.left,c.left),right:Math.max(t.right,c.right),scaled:t.scaled||c.scaled}:c}function Zb(e,[t,r]){let o=0,s=0;if(r===jb){t<0&&(t=0);const r=t/qb;switch(e){case"top-right":case"top-left":s=r-7;break;case"bottom-right":case"bottom-left":s=7-r;break;case"bottom":s=7-t;break;case"top":s=t-7}switch(e){case"top-right":case"bottom-right":o=-r;break;case"top-left":case"bottom-left":o=r;break;case"left":o=t;break;case"right":o=-t}}else{switch(t=Math.abs(t),r=Math.abs(r),e){case"top-right":case"top-left":case"top":s=r-7;break;case"bottom-right":case"bottom-left":case"bottom":s=7-r}switch(e){case"top-right":case"bottom-right":case"right":o=-t;break;case"top-left":case"bottom-left":case"left":o=t}}return[o,s]}function Xb(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v){const E=e.layers[0],P=E.appearances;if(0===P.length)return{iconBBox:null,iconVerticalBBox:null,textBBox:null,textVerticalBBox:null};const C={iconBBox:null,iconVerticalBBox:null},R={textBBox:null,textVerticalBBox:null},{baseIconRotate:z,baseTextRotate:D,iconScaleFactor:O}=function(e,t,r){const o=e.get("icon-rotate").evaluate(t,{},r),s=e.get("text-rotate").evaluate(t,{},r),[l,c]=e.get("icon-size-scale-range");return{baseIconRotate:o,baseTextRotate:s,iconScaleFactor:ct(1,l,c)}}(o,s,l);t&&(C.iconBBox=Hb(t,C.iconBBox,z,c),r)&&(C.iconVerticalBBox=Hb(r,C.iconVerticalBBox,z+90,c));const F=_w(f.horizontal);F&&(R.textBBox=Hb(F,R.textBBox,D,1,_)),f.vertical&&(R.textVerticalBBox=Hb(f.vertical,R.textVerticalBBox,D+90,1,_));for(const r of P)r.hasIconProperties()&&Jb(C,e,E,r,s,l,h,z,c,u,t,d,O,p,v),r.hasTextProperties()&&Kb(R,E,r,s,l,_,D,m,F,f.vertical);return{iconBBox:C.iconBBox,iconVerticalBBox:C.iconVerticalBBox,textBBox:R.textBBox,textVerticalBBox:R.textVerticalBBox}}function Jb(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v){const{appearanceIconOffset:E,appearanceIconRotate:P,appearanceIconSize:C}=Qb(o,r,s,l,c,h,u,d.iconScaleFactor);let R=null,z=null,D=null;o.hasProperty("icon-image")?D=function(e,t,r,o,s,l,c,h){let u=null;const d=t.getAppearanceValueAndResolveTokens(r,"icon-image",o,s,h);if(d){const t=e.getResolvedImageFromTokens(d),p=r.getUnevaluatedProperty("icon-size"),f=rw(t,ib(e.zoom,p,e.worldview,h),p,s,e.zoom,o,e.pixelRatio,c,e.worldview,h);u=l.get(f.iconPrimary.toString())}return u}(t,r,o,s,l,f,m,v):p&&(D=p.imagePrimary),D&&(R=Wv(D,null,E,_),t.allowVerticalPlacement&&(z=Wv(D,null,E,_))),R&&(e.iconBBox=Hb(R,e.iconBBox,P,C)),z&&(e.iconVerticalBBox=Hb(z,e.iconVerticalBBox,P+90,C))}function Qb(e,t,r,o,s,l,c,h){const u=e.hasProperty("icon-offset")?t.getAppearanceValueAndResolveTokens(e,"icon-offset",r,o,[]):null,d=u&&Array.isArray(u)?u:s,p=e.hasProperty("icon-rotate")?t.getAppearanceValueAndResolveTokens(e,"icon-rotate",r,o,[]):null,f="number"==typeof p?p:l,m=e.hasProperty("icon-size")?t.getAppearanceValueAndResolveTokens(e,"icon-size",r,o,[]):null;return{appearanceIconOffset:d,appearanceIconRotate:f,appearanceIconSize:"number"==typeof m?m*h:c}}function Kb(e,t,r,o,s,l,c,h,u,d){const{appearanceTextOffset:p,appearanceTextRotate:f,appearanceTextSize:m}=ew(r,t,o,s,l,c,h),_=m/h;u&&(e.textBBox=Hb(u,e.textBBox,f,_,p)),d&&(e.textVerticalBBox=Hb(d,e.textVerticalBBox,f+90,_,p))}function ew(e,t,r,o,s,l,c){const h=e.hasProperty("text-offset")?t.getAppearanceValueAndResolveTokens(e,"text-offset",r,o,[]):null,u=h&&Array.isArray(h)?[h[0]*iv,h[1]*iv]:s,d=e.hasProperty("text-rotate")?t.getAppearanceValueAndResolveTokens(e,"text-rotate",r,o,[]):null,p="number"==typeof d?d:l,f=e.hasProperty("text-size")?t.getAppearanceValueAndResolveTokens(e,"text-size",r,o,[]):null;return{appearanceTextOffset:u,appearanceTextRotate:p,appearanceTextSize:"number"==typeof f?f:c}}function tw(e,t,r,o,s,l,c,h,u){if(!t||!t.usvg)return;const d=Jv(o),p=Jv(s),f="both"!==l&&"width"!==l||!Xv(o)?1:p.width/d.width,m="both"!==l&&"height"!==l||!Yv(o)?1:p.height/d.height;r.scaleSelf(f,m);const _=r.toString();c.set(_,r),h.set(_,t);const{imagePosition:v}=mb(_,t,1);u.set(_,v)}function iw(e,t,r,o,s,l,c,h,u,d){if(!e)return;const p=function(e,t,r,o,s,l,c){if("camera"===e.kind)return e.maxSize;if("composite"===e.kind){const o=t.possiblyEvaluate(new Ja(e.maxZoom,{worldview:l}),r,c).evaluate(s,{},r,c),h=t.possiblyEvaluate(new Ja(e.minZoom,{worldview:l}),r,c).evaluate(s,{},r,c);return Math.max(o,h)}return t.possiblyEvaluate(new Ja(o,{worldview:l}),r,c).evaluate(s,{},r,c)}(t,r,o,s,l,u,d);return e.scaleSelf(p*h*c)}function rw(e,t,r,o,s,l,c,h,u,d){return{iconPrimary:iw(e.getPrimary(),t,r,o,s,l,c,h,u,d),iconSecondary:iw(e.getSecondary(),t,r,o,s,l,c,h,u,d)}}function nw(e,t,r){if(!t)return;const o=r.get(e.toString()),s=r.get(t.toString());o&&s&&(o.paddedRect.w===s.paddedRect.w&&o.paddedRect.h===s.paddedRect.h||Et(`Mismatch in icon variant sizes: ${e.toString()} and ${t.toString()}`),o.usvg!==s.usvg&&Et(`Mismatch in icon variant image types: ${e.id} and ${t.id}`))}function ow(e,t,r,o){if(!e)return;const s=t.get(r.toString());if(e.imagePrimary=s,o){const r=t.get(o.toString());e.imageSecondary=r}}function sw(e,t){for(const r in e.horizontal)aw(e.horizontal[r],t);aw(e.vertical,t)}function aw(e,t){if(e)for(const r of e.positionedLines)for(const e of r.positionedGlyphs)if(null!==e.image){const r=e.image.toString();e.rect=t.get(r).paddedRect}}function lw(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function cw(e,t,r,o,s,l,c,h,u){const d=_w(l.horizontal)||l.vertical,p=r.get("icon-text-fit-padding").evaluate(o,{},s);let f,m=t;return t&&"none"!==u&&(e.allowVerticalPlacement&&l.vertical&&(f=Zv(t,l.vertical,u,p,h,c)),d&&(m=Zv(t,d,u,p,h,c))),{defaultShapedIcon:m,verticallyShapedIcon:f}}function hw(e,t){return e*t/24}function uw(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B){let k=c.textMaxSize.evaluate(t,{},m);void 0===k?k=h*c.textScaleFactor:k*=c.textScaleFactor;const V=e.layers[0].layout,N=hw(h,c.textScaleFactor),U=_w(r.horizontal)||r.vertical,j=e.hasAnyAppearanceProperty(["text-size","text-offset","text-rotate"]);if(("none"!==P||j)&&e.appearanceFeatureData&&e.featureToAppearanceIndex[t.index]<e.appearanceFeatureData.length){const r=e.appearanceFeatureData[e.featureToAppearanceIndex[t.index]];r&&(r.textShaping=U,r.iconTextFitPadding=V.get("icon-text-fit-padding").evaluate(t,{},m),r.fontScale=N,r.textScaleFactor=c.textScaleFactor)}const $="globe"===_.name,q=e.tilePixelRatio*k/24,H=(ee=e.overscaling,e.zoom>18&&ee>2&&(ee>>=1),Math.max(Ao/(512*ee),1)*V.get("symbol-spacing")),Z=V.get("text-padding")*e.tilePixelRatio,Y=V.get("icon-padding")*e.tilePixelRatio,J=it(V.get("text-max-angle")),Q="map"===V.get("icon-rotation-alignment")&&"point"!==z,K=H/2;var ee;!1===e.hasAnyIconTextFit&&"none"!==P&&(e.hasAnyIconTextFit=!0);const te=t.properties?+t.properties[Yd]:null,ie=te&&e.elevationFeatureIdToIndex?e.elevationFeatureIdToIndex.get(te):65535,re=(h,u,z)=>{if(u.x<0||u.x>=Ao||u.y<0||u.y>=Ao)return;let B=null;if($){const{x:e,y:t,z:r}=_.projectTilePoint(u.x,u.y,z);B={anchor:new yx(e,t,r,0,void 0),up:_.upVector(z,u.x,u.y)}}!function(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k,V,N,U,j,$,q,H){const Z=e.addToLineVertexArray(t,o);let Y,J,Q,K,ee,te,ie,re=0,ne=0,oe=0,se=0,ae=-1,le=-1;const ce={};let he=br("");const ue=r?r.anchor:t,de="none"!==U;let pe=0,fe=0;if(void 0===u._unevaluatedLayout.getValue("text-radial-offset")){const e=u.layout.get("text-offset").evaluate(D,{},k);pe=e[0]*iv,fe=e[1]*iv}else pe=u.layout.get("text-radial-offset").evaluate(D,{},k)*iv,fe=jb;if(e.allowVerticalPlacement&&s.vertical){const e=s.vertical;if(v)te=yw(e),h&&(ie=yw(h));else{const r=u.layout.get("text-rotate").evaluate(D,{},k)+90;Q=gw(d,ue,t,p,f,m,e,_,r,E,H),h&&(K=gw(d,ue,t,p,f,m,h,C,r,null,q))}}if(l){const o=u.layout.get("icon-rotate").evaluate(D,{},k),s=Tb(l,o,F,de,O.iconScaleFactor),c=h?Tb(h,o,F,de,O.iconScaleFactor):void 0;J=gw(d,ue,t,p,f,m,l,C,o,null,$);const _=function(e,t,r,o,s,l,c,h,u,d){const p=e.layers[0],f=p.appearances;let m=t.length;if(r&&(m=Math.max(m,r.length)),0===f.length)return m;const[_,v]=o.get("icon-size-scale-range"),E=ct(1,_,v);for(const t of f){const r=t.getUnevaluatedProperties();if(void 0!==r._values["icon-image"].value){const o=p.getAppearanceValueAndResolveTokens(t,"icon-image",l,c,d);if(o){const u=e.getResolvedImageFromTokens(o);if(u){const o=t.hasProperty("icon-size")?r._values["icon-size"]:s._values["icon-size"],p=rw(u,ib(e.zoom,o,e.worldview,d),o,c,e.zoom,l,e.pixelRatio,E,e.worldview,d),f=h.get(p.iconPrimary.toString());f&&(m=Math.max(m,Ib(f)))}}}}return m}(e,s,c,u.layout,u._unevaluatedLayout,D,k,e.iconAtlasPositions,0,B);re=4*_;const v=u.layout.get("icon-size").evaluate(D,{},k,B),E=O.compositeIconSizes?O.compositeIconSizes[0].evaluate(D,{},k,B):0,P=O.compositeIconSizes?O.compositeIconSizes[1].evaluate(D,{},k,B):0,U=mw(e.layerIds[0],e.iconSizeData,v,O.iconScaleFactor,E,P);e.addSymbols(e.icon,s,U,z,R,D,void 0,r,t,Z.lineStartIndex,Z.lineLength,-1,B,k,V,N,e.symbolInstances.length,_),ae=e.icon.placedSymbolArray.length-1,c&&(ne=4*_,e.addSymbols(e.icon,c,U,z,R,D,Mv.vertical,r,t,Z.lineStartIndex,Z.lineLength,-1,B,k,V,N,e.symbolInstances.length,_),le=e.icon.placedSymbolArray.length-1)}for(const o in s.horizontal){const l=o,h=s.horizontal[l];Y||(he=br(h.text),v?ee=yw(h):Y=gw(d,ue,t,p,f,m,h,_,u.layout.get("text-rotate").evaluate(D,{},k),E,H));const P=1===h.positionedLines.length;if(oe+=fw(e,r,t,h,c,u,v,D,E,Z,s.vertical?Mv.horizontal:Mv.horizontalOnly,P?Ub(s.horizontal):[l],ce,ae,O,B,k,e.symbolInstances.length,V),P)break}s.vertical&&(se+=fw(e,r,t,s.vertical,c,u,v,D,E,Z,Mv.vertical,["vertical"],ce,le,O,B,k,e.symbolInstances.length,V));let me=-1;const ge=(e,t)=>e?Math.max(e,t):t;me=ge(ee,me),me=ge(te,me),me=ge(ie,me);const ye=me>-1?1:0;e.glyphOffsetArray.length>=65535&&Et("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==D.sortKey&&e.addToSortKeyRanges(e.symbolInstances.length,D.sortKey),e.symbolInstances.emplaceBack(t.x,t.y,ue.x,ue.y,ue.z,ce.right>=0?ce.right:-1,ce.center>=0?ce.center:-1,ce.left>=0?ce.left:-1,ce.vertical>=0?ce.vertical:-1,ae,le,he,void 0!==Y?Y:e.collisionBoxArray.length,void 0!==Y?Y+1:e.collisionBoxArray.length,void 0!==Q?Q:e.collisionBoxArray.length,void 0!==Q?Q+1:e.collisionBoxArray.length,void 0!==J?J:e.collisionBoxArray.length,void 0!==J?J+1:e.collisionBoxArray.length,K||e.collisionBoxArray.length,K?K+1:e.collisionBoxArray.length,p,oe,se,re,ne,ye,0,pe,fe,me,0,de?1:0,j)}(e,u,B,h,r,o,l,s,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,Z,R,d,0,Y,Q,C,t,c,p,f,m,v,E,P,ie,D,O,F)};if("line"===z)for(const s of pg(t.geometry,0,0,Ao,Ao)){const t=db(s,H,J,r.vertical||U,o,24,q,e.overscaling,Ao);for(const r of t)U&&xw(e,U.text,K,r)||re(s,r,m)}else if("line-center"===z){for(const e of t.geometry)if(e.length>1){const t=ub(e,J,r.vertical||U,o,24,q);t&&re(e,t,m)}}else if("Polygon"===t.type)for(const e of pm(t.geometry,0)){const t=Bb(e,16);re(e[0],new yx(t.x,t.y,0,0,void 0),m)}else if("LineString"===t.type)for(const e of t.geometry)re(e,new yx(e[0].x,e[0].y,0,0,void 0),m);else if("Point"===t.type)for(const e of t.geometry)for(const t of e)re([t],new yx(t.x,t.y,0,0,void 0),m)}const dw=255,pw=dw*Kv;function fw(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R){const z=Ob(0,o,u,l,c,h,s,e.allowVerticalPlacement,void 0),D=l.layout.get("text-size").evaluate(h,{},P),O=v.compositeTextSizes?v.compositeTextSizes[0].evaluate(h,{},P):0,F=v.compositeTextSizes?v.compositeTextSizes[1].evaluate(h,{},P):0,B=mw(e.layerIds[0],e.textSizeData,D,v.textScaleFactor,O,F);e.addSymbols(e.text,z,B,u,c,h,p,t,r,d.lineStartIndex,d.lineLength,_,E,P,R,!1,C,z.length);for(const t of f)m[t]=e.text.placedSymbolArray.length-1;return 4*z.length}function mw(e,t,r,o,s,l){const c=t;let h=null;return"source"===c.kind?(h=[Kv*r*o],h[0]>pw&&Et(`${e}: Value for "text-size" is >= ${dw}. Reduce your "text-size".`)):"composite"===c.kind&&(h=[Kv*s*o,Kv*l*o],(h[0]>pw||h[1]>pw)&&Et(`${e}: Value for "text-size" is >= ${dw}. Reduce your "text-size".`)),h}function _w(e){for(const t in e)return e[t];return null}function gw(e,t,r,o,s,l,c,h,u,d,p){let f,m,_,v;if(f=p?p.top:c.top,m=p?p.bottom:c.bottom,_=p?p.left:c.left,v=p?p.right:c.right,Hv(c)&&c.collisionPadding){const e=c.collisionPadding;_-=e[0],f-=e[1],v+=e[2],m+=e[3]}if(u){const e=new Je(_,f),t=new Je(v,f),r=new Je(_,m),o=new Je(v,m),s=it(u);let l=new Je(0,0);d&&(l=new Je(d[0],d[1])),e._rotateAround(s,l),t._rotateAround(s,l),r._rotateAround(s,l),o._rotateAround(s,l),_=Math.min(e.x,t.x,r.x,o.x),v=Math.max(e.x,t.x,r.x,o.x),f=Math.min(e.y,t.y,r.y,o.y),m=Math.max(e.y,t.y,r.y,o.y)}return e.emplaceBack(t.x,t.y,t.z,r.x,r.y,_,f,v,m,h,o,s,l),e.length-1}function yw(e){Hv(e)&&e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function xw(e,t,r,o){const s=e.compareText;if(t in s){const e=s[t];for(let t=e.length-1;t>=0;t--)if(o.dist(e[t])<r)return!0}else s[t]=[];return s[t].push(o),!1}function vw(e,t){const r=e.fovAboveCenter,o=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,s=(e._camera.position[2]*e.worldSize-o)/Math.cos(e._pitch),l=Math.sin(r)*s/Math.sin(Math.max(Math.PI/2-e._pitch-r,.01));let c=Math.sin(e._pitch)*l+s;const h=s*(1/e._horizonShift);if(!e.elevation||0===e.elevation.exaggeration()){let t=Math.max(e.zoom-17,0);e.isOrthographic&&(t/=10),c*=1+t}return Math.min(1.01*c,h)}function bw(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const r=Math.pow(2,-e.z),o=e.x*r,s=(e.x+1)*r,l=e.y*r,c=(e.y+1)*r,h=Pd(o),u=Pd(s),d=Cd(l),p=Cd(c),f=t.project(h,d),m=t.project(u,d),_=t.project(u,p),v=t.project(h,p);let E=Math.min(f.x,m.x,_.x,v.x),P=Math.min(f.y,m.y,_.y,v.y),C=Math.max(f.x,m.x,_.x,v.x),R=Math.max(f.y,m.y,_.y,v.y);const z=r/16;function D(e,r,o,s,l,c){const h=(o+l)/2,u=(s+c)/2,d=t.project(Pd(h),Cd(u)),p=Math.max(0,E-d.x,P-d.y,d.x-C,d.y-R);E=Math.min(E,d.x),C=Math.max(C,d.x),P=Math.min(P,d.y),R=Math.max(R,d.y),p>z&&(D(e,d,o,s,h,u),D(d,r,h,u,l,c))}D(f,m,o,l,s,l),D(m,_,s,l,s,c),D(_,v,s,c,o,c),D(v,f,o,c,o,l),E-=z,P-=z,C+=z,R+=z;const O=1/Math.max(C-E,R-P);return{scale:O,x:E*O,y:P*O,x2:C*O,y2:R*O,projection:t}}function ww(e,{x:t,y:r},o=0){return new Je(((t-o)*e.scale-e.x)*Ao,(r*e.scale-e.y)*Ao)}const Tw=p(new Float32Array(16));class Iv{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,t){return{x:0,y:0,z:0}}unproject(e,t){return new Bu(0,0)}projectTilePoint(e,t,r){return{x:e,y:t,z:0}}locationPoint(e,t,r,o=!0){return e._coordinatePoint(e.locationCoordinate(t,r),o)}pixelsPerMeter(e,t){return Ad(1,e)*t}pixelSpaceConversion(e,t,r){return 1}farthestPixelDistance(e){return vw(e,e.pixelsPerMeter)}pointCoordinate(e,t,r,o){const s=e.horizonLineFromTop(!1),l=new Je(t,Math.max(s,r));return e.rayIntersectionCoordinate(e.pointRayIntersection(l,o))}pointCoordinate3D(e,t,r){const o=new Je(t,r);if(e.elevation)return e.elevation.pointCoordinate(o);{const t=this.pointCoordinate(e,o.x,o.y,0);return[t.x,t.y,t.z]}}isPointAboveHorizon(e,t){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,t.x,t.y);const r=e.horizonLineFromTop();return t.y<r}createInversionMatrix(e,t){return Tw}createTileMatrix(e,t,r){let o,s,l;const c=r.canonical,h=p(new Float64Array(16));if(this.isReprojectedInTileSpace){const u=bw(c,this);o=1,s=u.x+r.wrap*u.scale,l=u.y,v(h,h,[o/u.scale,o/u.scale,e.pixelsPerMeter/t])}else o=t/e.zoomScale(c.z),s=(c.x+Math.pow(2,c.z)*r.wrap)*o,l=c.y*o;return _(h,h,[s,l,0]),v(h,h,[o/Ao,o/Ao,1]),h}upVector(e,t,r){return[0,0,1]}upVectorScale(e,t,r){return{metersToTile:1}}}class Sv extends Iv{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[t,r]=this.parallels=e.parallels||[29.5,45.5],o=Math.sin(it(t));this.n=(o+Math.sin(it(r)))/2,this.c=1+o*(2*this.n-o),this.r0=Math.sqrt(this.c)/this.n}project(e,t){const{n:r,c:o,r0:s}=this,l=it(e-this.center[0]),c=it(t),h=Math.sqrt(o-2*r*Math.sin(c))/r;return{x:h*Math.sin(l*r),y:h*Math.cos(l*r)-s,z:0}}unproject(e,t){const{n:r,c:o,r0:s}=this,l=s+t;let c=Math.atan2(e,Math.abs(l))*Math.sign(l);l*r<0&&(c-=Math.PI*Math.sign(e)*Math.sign(l));const h=it(this.center[0])*r;c=mt(c,-Math.PI-h,Math.PI-h);const u=ct(rt(c/r)+this.center[0],-180,180),d=Math.asin(ct((o-(e*e+l*l)*r*r)/(2*r),-1,1)),p=ct(rt(d),-85.051129,zd);return new Bu(u,p)}}const Sw=1.340264,Iw=-.081106,Ew=893e-6,Aw=.003796,Pw=Math.sqrt(3)/2;class Vv extends Iv{project(e,t){t=t/180*Math.PI,e=e/180*Math.PI;const r=Math.asin(Pw*Math.sin(t)),o=r*r,s=o*o*o;return{x:.5*(e*Math.cos(r)/(Pw*(Sw+3*Iw*o+s*(7*Ew+9*Aw*o)))/Math.PI+.5),y:1-.5*(r*(Sw+Iw*o+s*(Ew+Aw*o))/Math.PI+1),z:0}}unproject(e,t){e=(2*e-.5)*Math.PI;let r=t=(2*(1-t)-1)*Math.PI,o=r*r,s=o*o*o;for(let e,l,c,h=0;h<12&&(l=r*(Sw+Iw*o+s*(Ew+Aw*o))-t,c=Sw+3*Iw*o+s*(7*Ew+9*Aw*o),e=l/c,r=ct(r-e,-Math.PI/3,Math.PI/3),o=r*r,s=o*o*o,!(Math.abs(e)<1e-12));++h);const l=Pw*e*(Sw+3*Iw*o+s*(7*Ew+9*Aw*o))/Math.cos(r),c=Math.asin(Math.sin(r)/Pw),h=ct(180*l/Math.PI,-180,180),u=ct(180*c/Math.PI,-85.051129,zd);return new Bu(h,u)}}class Ev extends Iv{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,t){return{x:.5+e/360,y:.5-t/360,z:0}}unproject(e,t){const r=360*(e-.5),o=ct(360*(.5-t),-85.051129,zd);return new Bu(r,o)}}const Cw=Math.PI/2;function Rw(e){return Math.tan((Cw+e)/2)}class Cv extends Iv{constructor(e){super(e),this.center=e.center||[0,30];const[t,r]=this.parallels=e.parallels||[30,30];let o=it(t),s=it(r);this.southernCenter=o+s<0,this.southernCenter&&(o=-o,s=-s);const l=Math.cos(o),c=Rw(o);this.n=o===s?Math.sin(o):Math.log(l/Math.cos(s))/Math.log(Rw(s)/c),this.f=l*Math.pow(Rw(o),this.n)/this.n}project(e,t){t=it(t),this.southernCenter&&(t=-t),e=it(e-this.center[0]);const r=1e-6,{n:o,f:s}=this;s>0?t<-Cw+r&&(t=-Cw+r):t>Cw-r&&(t=Cw-r);const l=s/Math.pow(Rw(t),o);let c=l*Math.sin(o*e),h=s-l*Math.cos(o*e);return c=.5*(c/Math.PI+.5),h=.5*(h/Math.PI+.5),{x:c,y:this.southernCenter?h:1-h,z:0}}unproject(e,t){e=(2*e-.5)*Math.PI,this.southernCenter&&(t=1-t),t=(2*(1-t)-.5)*Math.PI;const{n:r,f:o}=this,s=o-t,l=Math.sign(s),c=Math.sign(r)*Math.sqrt(e*e+s*s);let h=Math.atan2(e,Math.abs(s))*l;s*r<0&&(h-=Math.PI*Math.sign(e)*l);const u=ct(rt(h/r)+this.center[0],-180,180),d=ct(rt(2*Math.atan(Math.pow(o/c,1/r))-Cw),-85.051129,zd);return new Bu(u,this.southernCenter?-d:d)}}class Rv extends Iv{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,t){return{x:Id(e),y:Ed(t),z:0}}unproject(e,t){const r=Pd(e),o=Cd(t);return new Bu(r,o)}}const zw=it(zd);class Ov extends Iv{project(e,t){const r=(t=it(t))*t,o=r*r;return{x:.5*((e=it(e))*(.8707-.131979*r+o*(o*(.003971*r-.001529*o)-.013791))/Math.PI+.5),y:1-.5*(t*(1.007226+r*(.015085+o*(.028874*r-.044475-.005916*o)))/Math.PI+1),z:0}}unproject(e,t){e=(2*e-.5)*Math.PI;let r=t=(2*(1-t)-1)*Math.PI,o=25,s=0,l=r*r;do{l=r*r;const e=l*l;s=(r*(1.007226+l*(.015085+e*(.028874*l-.044475-.005916*e)))-t)/(1.007226+l*(.045255+e*(.259866*l-.311325-.005916*11*e))),r=ct(r-s,-zw,zw)}while(Math.abs(s)>1e-6&&--o>0);l=r*r;const c=ct(rt(e/(.8707+l*(l*(l*l*l*(.003971-.001529*l)-.013791)-.131979))),-180,180),h=rt(r);return new Bu(c,h)}}const Dw=it(zd);class Nv extends Iv{project(e,t){t=it(t),e=it(e);const r=Math.cos(t),o=2/Math.PI,s=Math.acos(r*Math.cos(e/2)),l=Math.sin(s)/s,c=.5*(e*o+2*r*Math.sin(e/2)/l)||0,h=.5*(t+Math.sin(t)/l)||0;return{x:.5*(c/Math.PI+.5),y:1-.5*(h/Math.PI+1),z:0}}unproject(e,t){let r=e=(2*e-.5)*Math.PI,o=t=(2*(1-t)-1)*Math.PI,s=25;const l=1e-6;let c=0,h=0;do{const s=Math.cos(o),l=Math.sin(o),u=2*l*s,d=l*l,p=s*s,f=Math.cos(r/2),m=Math.sin(r/2),_=2*f*m,v=m*m,E=1-p*f*f,P=E?1/E:0,C=E?Math.acos(s*f)*Math.sqrt(1/E):0,R=.5*(2*C*s*m+2*r/Math.PI)-e,z=.5*(C*l+o)-t,D=.5*P*(p*v+C*s*f*d)+1/Math.PI,O=P*(_*u/4-C*l*m),F=.125*P*(u*m-C*l*p*_),B=.5*P*(d*f+C*v*s)+.5,k=O*F-B*D;c=(z*O-R*B)/k,h=(R*F-z*D)/k,r=ct(r-c,-Math.PI,Math.PI),o=ct(o-h,-Dw,Dw)}while((Math.abs(c)>l||Math.abs(h)>l)&&--s>0);return new Bu(rt(r),rt(o))}}class jv extends Iv{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(it(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,t){const{scale:r,cosPhi:o}=this;return{x:it(e)*o*r+.5,y:-Math.sin(it(t))/o*r+.5,z:0}}unproject(e,t){const{scale:r,cosPhi:o}=this,s=-(t-.5)/r,l=ct(rt((e-.5)/r)/o,-180,180),c=Math.asin(ct(s*o,-1,1)),h=ct(rt(c),-85.051129,zd);return new Bu(l,h)}}class Gv extends Rv{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,t,r){const o=Zp(e,t,r);return se(o,o,Jp(Up(r))),{x:o[0],y:o[1],z:o[2]}}locationPoint(e,t,r){const o=yd(t.lat,t.lng),s=ie([],o),l=r?e._centerAltitude+r:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(t),e._centerAltitude):e._centerAltitude;J(o,o,s,Ad(1,0)*Ao*l);const c=p(new Float64Array(16));return m(c,e.pixelMatrix,e.globeMatrix),se(o,o,c),new Je(o[0],o[1])}pixelsPerMeter(e,t){return Ad(1,0)*t}pixelSpaceConversion(e,t,r){const o=Ad(1,e)*t,s=Ar(Ad(1,45)*t,o,r);return this.pixelsPerMeter(e,t)/s}createTileMatrix(e,t,r){const o=Qp(Up(r.canonical));return m(new Float64Array(16),e.globeMatrix,o)}createInversionMatrix(e,t){const{center:r}=e,o=Jp(Up(t));return P(o,o,it(r.lng)),E(o,o,it(r.lat)),v(o,o,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(o)}pointCoordinate(e,t,r,o){return Bp(e,t,r,!0)||new Gu(0,0)}pointCoordinate3D(e,t,r){const o=this.pointCoordinate(e,t,r,0);return[o.x,o.y,o.z]}isPointAboveHorizon(e,t){return!Bp(e,t.x,t.y,!1)}farthestPixelDistance(e){const t=function(e,t){const r=e.cameraToCenterDistance,o=e._centerAltitude*t,s=e._camera,l=e._camera.forward(),c=j([],Y([],l,-r),[0,0,o]),h=e.worldSize/(2*Math.PI),u=[0,0,-h],d=e.width/e.height,p=Math.tan(e.fovAboveCenter),f=Y([],s.up(),p),m=Y([],s.right(),p*d),_=ie([],j([],j([],l,f),m)),v=[];let E;if(new fc(c,_).closestPointOnSphere(u,h,v)){const t=j([],v,u),r=ue([],t,c);E=Math.cos(e.fovAboveCenter)*V(r)}else{const e=ue([],c,u),t=ue([],u,c);ie(t,t);const r=V(e)-h;E=Math.sqrt(r*(r+2*h));const o=Math.acos(E/(h+r))-Math.acos(re(l,t));E*=Math.cos(o)}return 1.01*E}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),r=rf(e.zoom);if(r>0){const o=vw(e,Ad(1,e.center.lat)*e.worldSize),s=e.worldSize/(2*Math.PI),l=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ar(t,o+s*(1-Math.cos(l)),Math.pow(r,10))}return t}upVector(e,t,r){return Zp(t,r,e,1)}upVectorScale(e){return{metersToTile:Lp(Xp(Up(e)))}}}function Lw(e){const t=e.parallels,r=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new Rv(e);case"equirectangular":return new Ev(e);case"naturalEarth":return new Ov(e);case"equalEarth":return new Vv(e);case"winkelTripel":return new Nv(e);case"albers":return r?new jv(e):new Sv(e);case"lambertConformalConic":return r?new jv(e):new Cv(e);case"globe":return new Gv(e)}throw new Error(`Invalid projection name: ${e.name}`)}const Ow=Qu.types,Fw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Bw(e,t,r,o,s,l,c,h,u,d,p,f,m){const _=h?Math.min(pw,Math.round(h[0])):0,v=h?Math.min(pw,Math.round(h[1])):0;e.emplaceBack(t,r,Math.round(32*o),Math.round(32*s),l,c,(_<<1)+(u?1:0),0+(v<<1),16*d,16*p,256*f,256*m)}function kw(e,t,r){e.emplaceBack(t,r)}function Vw(e,t,r,o,s,l,c){e.emplaceBack(t,r,o,s,l,c)}const Nw=(e,t,r,o)=>{for(let s=0;s<t;s++)e.emplaceBack(r[0],r[1],r[2],o[0],o[1],o[2])};function Uw(e,t,r,o,s){e.emplaceBack(t,r,o,s),e.emplaceBack(t,r,o,s),e.emplaceBack(t,r,o,s),e.emplaceBack(t,r,o,s)}function jw(e){for(const t of e.sections)if(Wh(t.text))return!0;return!1}class Qv{constructor(e){this.layoutVertexArray=new Qo,this.indexArray=new ll,this.programConfigurations=e,this.segments=new Ol,this.dynamicLayoutVertexArray=new el,this.opacityVertexArray=new rl,this.placedSymbolArray=new Sl,this.iconTransitioningVertexArray=new nl,this.globeExtVertexArray=new tl,this.zOffsetVertexArray=new $o,this.orientationVertexArray=new hl,this.symbolInstanceIndices=[]}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}getSymbolVertexData(e,t){const r=[],o=this.layoutVertexArray.uint16;for(let s=0;s<t;++s){const t=12*(e+s);r.push(...o.slice(t,t+12))}return r}updateSymbolVertexData(e,t,r,o,s,l,c,h,u,d,p,f,m){const _=this.layoutVertexArray.uint16,v=12*e;_[v]=t,_[v+1]=r,_[v+2]=o,_[v+3]=s,_[v+4]=l,_[v+5]=c,_[v+6]=h,_[v+7]=u,_[v+8]=d,_[v+9]=p,_[v+10]=f,_[v+11]=m}upload(e,t,r,o,s,l){this.isEmpty()||(r&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Hx.members,!!l),this.indexBuffer=e.createIndexBuffer(this.indexArray,t),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Zx.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Fw,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Jx.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Wx.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||s)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Xx.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,Yx.members,!0)),this.opacityVertexBuffer.itemSize=1),(r||o)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}ih(Qv,"SymbolBuffers");class tb{constructor(e,t,r){this.layoutVertexArray=new e,this.layoutAttributes=t,this.indexArray=new r,this.segments=new Ol,this.collisionVertexArray=new ol,this.collisionVertexArrayExt=new el}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Qx.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Kx.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}ih(tb,"CollisionBuffers");class eb{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=p([]),this.placementViewportMatrix=p([]);const t=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.localizable=e.localizable,this.textSizeData=ib(this.zoom,t["text-size"],this.worldview,e.availableImages),this.iconSizeData=ib(this.zoom,t["icon-size"],this.worldview,e.availableImages);const r=this.layers[0].layout,o=r.get("symbol-sort-key"),s=r.get("symbol-z-order");this.lut=e.lut,this.canOverlap=r.get("text-allow-overlap")||r.get("icon-allow-overlap")||r.get("text-ignore-placement")||r.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==s&&void 0!==o.constantOr(1),this.sortFeaturesByY=("viewport-y"===s||"auto"===s&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=r.get("text-writing-mode").map((e=>Mv[e])),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null,this.featureToAppearanceIndex={}}hasAnyAppearanceProperty(e){const t=this.layers[0].getAppearances();if(!t||0===t.length)return!1;const r=Array.isArray(e)?e:[e];return t.some((e=>r.some((t=>null!=e.getProperty(t)))))}createArrays(){this.text=new Qv(new fu(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new Qv(new fu(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new Bl,this.lineVertexArray=new kl,this.symbolInstances=new zl}calculateGlyphDependencies(e,t,r,o,s){for(const r of e){const e=r.codePointAt(0);if(void 0===e)break;if(t[e]=!0,o&&s&&e<=65535){const e=nv[r];e&&(t[e.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,t,r,o,s,l,c){if(!e.hasProperty("icon-size"))return c*l;let h=1;const u=e.getUnevaluatedProperties()._values["icon-size"],d=ib(this.zoom,u,this.worldview,s),p=nb(d,t);if("constant"!==d.kind&&"camera"!==d.kind||(h=p.uSize),"composite"===d.kind){const{minZoom:e,maxZoom:t}=d,l=u.possiblyEvaluate(new Ja(e,{worldview:this.worldview}),o),c=u.possiblyEvaluate(new Ja(t,{worldview:this.worldview}),o),f=l.evaluate(r,{},o,s);h=f+(c.evaluate(r,{},o,s)-f)*p.uSizeT}return"source"===d.kind&&(h=u.possiblyEvaluate(new Ja(this.zoom,{worldview:this.worldview}),o).evaluate(r,{},o,s)),h*l}updateFootprints(e,t){}updateReplacement(e,t){if(t.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=t.updateTime;const r=t.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!w_(this.activeReplacements,r)&&(this.activeReplacements=r,!0)}getResolvedImageFromTokens(e){return"string"==typeof e?Or.build(e):e}populate(e,t,r,o){const s=this.layers[0],l=s.layout,c="globe"===this.projection.name,h=l.get("text-font"),u=l.get("text-field"),d=l.get("icon-image"),[p,f]=l.get("icon-size-scale-range"),m=ct(t.scaleFactor||1,p,f),_=("constant"!==u.value.kind||u.value.value instanceof Rr&&!u.value.value.isEmpty()||u.value.value.toString().length>0)&&("constant"!==h.value.kind||h.value.value.length>0),v="constant"!==d.value.kind||!!d.value.value||Object.keys(d.parameters).length>0,E=this.hasAnyAppearanceProperty("icon-image"),P=l.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!_&&!v&&!E)return;const C=t.iconDependencies,R=t.glyphDependencies,z=t.availableImages,D=new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),O=e=>{const t=e.id.toString();C.has(t)?C.get(t).push(e):C.set(t,[e])};for(const t of e){const{feature:e,id:u,index:d,sourceLayerIndex:p}=t,f=s._featureFilter.needGeometry,F=qd(e,f);if(!s._featureFilter.filter(D,F,r))continue;if(f||(F.geometry=$d(e,r,o)),c&&1!==e.type&&r.z<=5){const e=F.geometry,t=.98078528056,o=(e,o)=>re(Zp(e.x,e.y,r,1),Zp(o.x,o.y,r,1))<t;for(let t=0;t<e.length;t++)e[t]=Nd(e[t],o)}let B,k;if(_){const e=s.getValueAndResolveTokens("text-field",F,r,z),t=Rr.factory(e);jw(t)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===nu()||this.hasRTLText&&au.isParsed())&&(B=rv(t,s,F))}if(v){const e=s.getValueAndResolveTokens("icon-image",F,r,z);k=this.getResolvedImageFromTokens(e)}const V=this.layers[0];let N=!1;if(!k&&E){const e=V.getAppearances();for(const t of e)if(t.getProperty("icon-image")){const e=V.getAppearanceValueAndResolveTokens(t,"icon-image",F,r,z);if(e){k=this.getResolvedImageFromTokens(e),N=!0;break}}}if(!B&&!k)continue;const U=this.sortFeaturesByKey?P.evaluate(F,{},r):void 0,j={id:u,text:B,icon:k,index:d,sourceLayerIndex:p,geometry:F.geometry,properties:e.properties,type:Ow[e.type],sortKey:U};if(this.features.push(j),this.featureToAppearanceIndex[d]=this.appearanceFeatureData.length,this.appearanceFeatureData.push({id:u,properties:e.properties,usesAppearanceIconAsPlaceholder:N,isUsingAppearanceIconVertexData:!1,isUsingAppearanceTextVertexData:!1,layoutBasedIconVertexData:[],layoutBasedTextVertexData:[],activeAppearance:null}),k){const e=V._unevaluatedLayout._values,{iconPrimary:t,iconSecondary:o}=rw(k,this.iconSizeData,e["icon-size"],r,this.zoom,j,this.pixelRatio,m,this.worldview,z);O(t),o&&(this.hasAnySecondaryIcon=!0,O(o))}const $=V.getAppearances();if(0!==$.length&&$.forEach((e=>{if(!e.getProperty("icon-image"))return;const t=this.getCombinedIconPrimary(e,V,F,r,z,j,m);t&&O(t)})),B){const e=h.evaluate(F,{},r).join(","),t="map"===l.get("text-rotation-alignment")&&"point"!==l.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Mv.vertical)>=0;for(const r of B.sections)if(r.image){const e=r.image.getPrimary().scaleSelf(this.pixelRatio),t=e.id.toString(),o=C.get(t)||[];o.push(e),C.set(t,o)}else{const o=Oh(B.toString()),s=r.fontStack||e,l=R[s]=R[s]||{};this.calculateGlyphDependencies(r.text,l,t,this.allowVerticalPlacement,o)}}}if("line"===l.get("symbol-placement")&&(this.features=function(e){const t={},r={},o=[];let s=0;function l(t){o.push(e[t]),s++}function c(e,t,s){const l=r[e];return delete r[e],r[t]=l,o[l].geometry[0].pop(),o[l].geometry[0]=o[l].geometry[0].concat(s[0]),l}function h(e,r,s){const l=t[r];return delete t[r],t[e]=l,o[l].geometry[0].shift(),o[l].geometry[0]=s[0].concat(o[l].geometry[0]),l}function u(e,t,r){const o=r?t[0][t[0].length-1]:t[0][0];return`${e}:${o.x}:${o.y}`}for(let d=0;d<e.length;d++){const p=e[d],f=p.geometry,m=p.text?p.text.toString():null;if(!m){l(d);continue}const _=u(m,f),v=u(m,f,!0);if(_ in r&&v in t&&r[_]!==t[v]){const e=h(_,v,f),s=c(_,v,o[e].geometry);delete t[_],delete r[v],r[u(m,o[s].geometry,!0)]=s,o[e].geometry=null}else _ in r?c(_,v,f):v in t?h(_,v,f):(l(d),t[_]=s-1,r[v]=s-1)}return o.filter((e=>e.geometry))}(this.features)),"hd-road-markup"===l.get("symbol-elevation-reference")){if(this.elevationType="road",t.elevationFeatures){!this.elevationFeatures&&t.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const e of t.elevationFeatures)this.elevationFeatureIdToIndex.set(e.id,this.elevationFeatures.length),this.elevationFeatures.push(e)}}else l.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((e,t)=>e.sortKey-t.sortKey))}getCombinedIconPrimary(e,t,r,o,s,l,c){let h,u;const d=e.getUnevaluatedProperties();if(void 0!==d._values["icon-image"].value){const l=t.getAppearanceValueAndResolveTokens(e,"icon-image",r,o,s);h=this.getResolvedImageFromTokens(l)}else{const e=t.getValueAndResolveTokens("icon-image",r,o,s);h=this.getResolvedImageFromTokens(e)}if(h){const r=e.hasProperty("icon-size")?d._values["icon-size"]:t._unevaluatedLayout._values["icon-size"];u=rw(h,ib(this.zoom,r,this.worldview,s),r,o,this.zoom,l,this.pixelRatio,c,this.worldview,s).iconPrimary}return u}updateSymbolInstanceIconVertices(e,t,r,o,s,l,c,h,u,d,p,f,m,_){if(e.placedIconSymbolIndex<0)return{vertexOffsetDelta:0,hasChanges:!1};if(t.activeAppearance===r)return{vertexOffsetDelta:e.numIconVertices,hasChanges:!1};if(r){const v=this.getCombinedIconPrimary(r,u,o,l,c,{sortKey:void 0,text:void 0,icon:null,index:e.featureIndex,sourceLayerIndex:e.featureIndex,geometry:[],properties:t.properties,type:"Point",id:t.id},d);if(!v)return{vertexOffsetDelta:0,hasChanges:!1};const E=v.toString(),P=this.iconAtlasPositions&&this.iconAtlasPositions.get(E);if(P){const{appearanceIconOffset:v,appearanceIconRotate:E}=Qb(r,u,o,l,f,_,m,d);let C=Wv(P,void 0,v,u.layout.get("icon-anchor").evaluate(o,p,l));const R=P.sdf,z=u.layout.get("icon-text-fit").constantOr("none");"none"!==z&&t.textShaping&&t.iconTextFitPadding&&t.fontScale&&(C=Zv(C,t.textShaping,z,t.iconTextFitPadding,v,t.fontScale));const D=this.calculateEffectiveAppearanceIconSize(r,h.zoom,o,l,c,d,m),O=0,F=1+(Math.min(pw,Math.round(D*Kv))<<1),B=Tb(C,E,R,"none"!==z,d);t.isUsingAppearanceIconVertexData||(t.isUsingAppearanceIconVertexData=!0,t.layoutBasedIconVertexData=this.icon.getSymbolVertexData(s,e.numIconVertices));let k=s;for(let r=0;r<B.length;++r){const o=B[r],s=t.layoutBasedIconVertexData[0]||e.tileAnchorX,l=t.layoutBasedIconVertexData[1]||e.tileAnchorY,c=16*o.pixelOffsetTL.x,h=16*o.pixelOffsetTL.y,u=16*o.pixelOffsetBR.x,d=16*o.pixelOffsetBR.y,p=16*o.minFontScaleX,f=16*o.minFontScaleY;this.icon.updateSymbolVertexData(k,s,l,Math.round(32*o.tl.x),Math.round(32*o.tl.y),o.texPrimary.x,o.texPrimary.y,O,F,c,h,p,f),this.icon.updateSymbolVertexData(k+1,s,l,Math.round(32*o.tr.x),Math.round(32*o.tr.y),o.texPrimary.x+o.texPrimary.w,o.texPrimary.y,O,F,u,h,p,f),this.icon.updateSymbolVertexData(k+2,s,l,Math.round(32*o.bl.x),Math.round(32*o.bl.y),o.texPrimary.x,o.texPrimary.y+o.texPrimary.h,O,F,c,d,p,f),this.icon.updateSymbolVertexData(k+3,s,l,Math.round(32*o.br.x),Math.round(32*o.br.y),o.texPrimary.x+o.texPrimary.w,o.texPrimary.y+o.texPrimary.h,O,F,u,d,p,f),k+=4}const V=e.numIconVertices-4*B.length;for(let e=0;e<V;++e)this.icon.updateSymbolVertexData(k+e,0,0,0,0,0,0,0,0,0,0,0,0);return{vertexOffsetDelta:e.numIconVertices,hasChanges:!0}}}else if(t.usesAppearanceIconAsPlaceholder){if(this.layers[0].appearances&&this.layers[0].appearances.length>0)return this.icon.updateSymbolVertexData(s,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(s+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(s+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateSymbolVertexData(s+3,0,0,0,0,0,0,0,0,0,0,0,0),{vertexOffsetDelta:e.numIconVertices,hasChanges:!0}}else if(t.isUsingAppearanceIconVertexData){const e=12,r=t.layoutBasedIconVertexData.length/e;for(let o=0;o<r;++o){const r=o*e;this.icon.updateSymbolVertexData(s+o,t.layoutBasedIconVertexData[r+0],t.layoutBasedIconVertexData[r+1],t.layoutBasedIconVertexData[r+2],t.layoutBasedIconVertexData[r+3],t.layoutBasedIconVertexData[r+4],t.layoutBasedIconVertexData[r+5],t.layoutBasedIconVertexData[r+6],t.layoutBasedIconVertexData[r+7],t.layoutBasedIconVertexData[r+8],t.layoutBasedIconVertexData[r+9],t.layoutBasedIconVertexData[r+10],t.layoutBasedIconVertexData[r+11])}return t.isUsingAppearanceIconVertexData=!1,{vertexOffsetDelta:r,hasChanges:!0}}return{vertexOffsetDelta:e.numIconVertices,hasChanges:!1}}updateSymbolInstanceTextVertices(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C){const R=e.numHorizontalGlyphVertices>0||e.numVerticalGlyphVertices>0;if(!R)return{vertexOffsetDelta:R?e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices:0,hasChanges:!1};if(t.activeAppearance===r)return{vertexOffsetDelta:e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices,hasChanges:!1};if(r&&t.textShaping){const{appearanceTextOffset:R,appearanceTextRotate:z,appearanceTextSize:D}=ew(r,c,o,l,p,m,f);t.fontScale=hw(D,t.textScaleFactor);const O=r.getUnevaluatedProperty("text-size");let F=this.textSizeData,B=E,k=P;r.hasProperty("text-size")&&(F=ib(this.zoom,O,this.worldview,C),B="composite"===this.textSizeData.kind?this.textSizeData.minZoom:0,k="composite"===this.textSizeData.kind?this.textSizeData.maxZoom:0);const V=t.textShaping.bottom-p[1],N=t.textShaping.left-p[0],U=t.textShaping.right-p[0];t.textShaping.top=R[1]+(t.textShaping.top-p[1]),t.textShaping.bottom=R[1]+V,t.textShaping.left=R[0]+N,t.textShaping.right=R[0]+U;const j=Ob(0,t.textShaping,R,c,!1,o,u,this.allowVerticalPlacement,z),$=D&&"composite"===F.kind?O.possiblyEvaluate(new Ja(B,{}),l).evaluate(o,d,l):_,q=D&&"composite"===F.kind?O.possiblyEvaluate(new Ja(k,{}),l).evaluate(o,d,l):v,H=mw(r.name,F,D,h,$,q),Z=Array.isArray(H)?H[1]:D,Y=0,J=1+(Math.min(pw,Math.round(Z*Kv))<<1);t.isUsingAppearanceTextVertexData||(t.isUsingAppearanceTextVertexData=!0,t.layoutBasedTextVertexData=this.text.getSymbolVertexData(s,e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices));for(let t=0;t<j.length&&t<(e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices)/4;++t){const r=j[t],o=r.glyphOffset[1],l=e.tileAnchorX,c=e.tileAnchorY,h=s+4*t;this.text.updateSymbolVertexData(h,l,c,Math.round(32*r.tl.x),Math.round(32*(o+r.tl.y)),r.texPrimary.x,r.texPrimary.y,Y,J,r.pixelOffsetTL.x,r.pixelOffsetTL.y,r.minFontScaleX,r.minFontScaleY),this.text.updateSymbolVertexData(h+1,l,c,Math.round(32*r.tr.x),Math.round(32*(o+r.tr.y)),r.texPrimary.x+r.texPrimary.w,r.texPrimary.y,Y,J,r.pixelOffsetBR.x,r.pixelOffsetTL.y,r.minFontScaleX,r.minFontScaleY),this.text.updateSymbolVertexData(h+2,l,c,Math.round(32*r.bl.x),Math.round(32*(o+r.bl.y)),r.texPrimary.x,r.texPrimary.y+r.texPrimary.h,Y,J,r.pixelOffsetTL.x,r.pixelOffsetBR.y,r.minFontScaleX,r.minFontScaleY),this.text.updateSymbolVertexData(h+3,l,c,Math.round(32*r.br.x),Math.round(32*(o+r.br.y)),r.texPrimary.x+r.texPrimary.w,r.texPrimary.y+r.texPrimary.h,Y,J,r.pixelOffsetBR.x,r.pixelOffsetBR.y,r.minFontScaleX,r.minFontScaleY)}return{vertexOffsetDelta:e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices,hasChanges:!0}}if(t.isUsingAppearanceTextVertexData){const e=12,r=t.layoutBasedTextVertexData.length/e;for(let o=0;o<r;++o){const r=o*e;this.text.updateSymbolVertexData(s+o,t.layoutBasedTextVertexData[r+0],t.layoutBasedTextVertexData[r+1],t.layoutBasedTextVertexData[r+2],t.layoutBasedTextVertexData[r+3],t.layoutBasedTextVertexData[r+4],t.layoutBasedTextVertexData[r+5],t.layoutBasedTextVertexData[r+6],t.layoutBasedTextVertexData[r+7],t.layoutBasedTextVertexData[r+8],t.layoutBasedTextVertexData[r+9],t.layoutBasedTextVertexData[r+10],t.layoutBasedTextVertexData[r+11])}return t.isUsingAppearanceTextVertexData=!1,{vertexOffsetDelta:r,hasChanges:!0}}return{vertexOffsetDelta:e.numHorizontalGlyphVertices+e.numVerticalGlyphVertices,hasChanges:!1}}update(e,t,r,o,s,l,c){this.text.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,t,s,r,o,l,c,this.worldview)}updateRoadElevation(e){if("road"!==this.elevationType||!this.elevationFeatures)return;if(this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let t=!1;const r=Fd(e),o=1/r;let s=!1,l=!1;for(let e=0;e<this.symbolInstances.length;e++){const c=this.symbolInstances.get(e),h=N(1,0,0),u=N(0,1,0),{numHorizontalGlyphVertices:d,numVerticalGlyphVertices:p,numIconVertices:f,numVerticalIconVertices:m}=c,_=d>0||p>0,v=f>0,E=this.elevationFeatures[c.elevationFeatureIndex];if(E){const e=new Je(c.tileAnchorX,c.tileAnchorY),d=.075+E.pointElevation(e);c.zOffset!==d&&(t=!0,c.zOffset=d),0!==d&&(this.hasAnyZOffset=!0);const p=E.computeSlopeNormal(e,o),f=Ce(ve(),N(0,0,1),p);le(h,h,f),le(u,u,f),h[2]*=r,u[2]*=r,1===h[0]&&0===h[1]&&0===h[2]&&0===u[0]&&1===u[1]&&0===u[2]||(s=s||_,l=l||v)}if(_&&(Nw(this.text.orientationVertexArray,d,h,u),Nw(this.text.orientationVertexArray,p,h,u)),v){const{placedIconSymbolIndex:e,verticalPlacedIconSymbolIndex:t}=c;e>=0&&Nw(this.icon.orientationVertexArray,f,h,u),t>=0&&Nw(this.icon.orientationVertexArray,m,h,u)}}s||(this.text.orientationVertexArray=void 0),l||(this.icon.orientationVertexArray=void 0),t&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(e,t,o)=>{r+=t,r>e.length&&e.resize(r);for(let s=-t;s<0;s++)e.emplace(s+r,o)},t=(e,t,r)=>{o+=t,o>e.length&&e.resize(o);for(let s=-t;s<0;s++)e.emplace(s+o,r)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let r=0,o=0;for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r),{numHorizontalGlyphVertices:s,numVerticalGlyphVertices:l,numIconVertices:c}=o,h=o.zOffset,u=c>0;if((s>0||l>0)&&(e(this.text.zOffsetVertexArray,s,h),e(this.text.zOffsetVertexArray,l,h)),u){const{placedIconSymbolIndex:e,verticalPlacedIconSymbolIndex:r}=o;e>=0&&t(this.icon.zOffsetVertexArray,c,h),r>=0&&t(this.icon.zOffsetVertexArray,o.numVerticalIconVertices,h)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,t,r,o,s){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),null===this.hasAppearances&&(this.hasAppearances=this.layers.some((e=>e.appearances&&e.appearances.length>0))),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,t,r,o,s){if(!(e&&t&&r&&this.appearanceFeatureData))return!1;const l=this.icon.layoutVertexArray&&this.icon.layoutVertexArray.length>0&&this.icon.layoutVertexArray.arrayBuffer,c=this.text.layoutVertexArray&&this.text.layoutVertexArray.length>0&&this.text.layoutVertexArray.arrayBuffer;if(!l&&!c)return!1;const h=this.layers[0],u=h.layout;let d=1,p=0,f=!1;if(l){const[e,t]=u.get("icon-size-scale-range");d=ct(1,e,t)}let m=1,_=0,v=!1;if(c){const[e,t]=u.get("text-size-scale-range");m=ct(1,e,t)}const E=new Map;if(s&&r)for(const e of r){const t=s.getImage(e,h.scope);if(t){const r=new Lr(e.toString());E.set(r.toString(),t)}}for(let s=0;s<this.symbolInstances.length;s++){const P=this.symbolInstances.get(s),C=this.featureToAppearanceIndex[P.featureIndex],R=void 0!==C?this.appearanceFeatureData[C]:void 0;if(!R)continue;const z=R.id,D=t&&void 0!==z?t[String(z)]:void 0,O={type:"Point",id:R.id,properties:R.properties,geometry:[]},F=h.appearances&&h.appearances.find((t=>t.isActive({globals:o,feature:O,canonical:e,featureState:D})));if(c){const t=u.get("text-size"),o=u.get("text-offset").evaluate(O,D,e),s=t.evaluate(O,D,e),l=u.get("text-rotate").evaluate(O,D,e),c="composite"===this.textSizeData.kind?this.textSizeData.minZoom:0,d="composite"===this.textSizeData.kind?this.textSizeData.maxZoom:0,p=t.evaluate(O,{zoom:c},e),f=t.evaluate(O,{zoom:d},e),C=this.updateSymbolInstanceTextVertices(P,R,F,O,_,e,h,m,E,D,o,s,l,p,f,c,d,r);_+=C.vertexOffsetDelta,v=v||C.hasChanges}if(l){const t=u.get("icon-offset").evaluate(O,D,e),s=u.get("icon-size").evaluate(O,D,e,r),l=u.get("icon-rotate").evaluate(O,D,e),c=this.updateSymbolInstanceIconVertices(P,R,F,O,p,e,r,o,h,d,D,t,s,l);p+=c.vertexOffsetDelta,f=f||c.hasChanges}R.activeAppearance=F}return f&&this.icon.layoutVertexBuffer&&null!==this.icon.layoutVertexArray.arrayBuffer&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray),v&&this.text.layoutVertexBuffer&&null!==this.text.layoutVertexArray.arrayBuffer&&this.text.layoutVertexArray.length===this.text.layoutVertexBuffer.length&&this.text.layoutVertexBuffer.updateData(this.text.layoutVertexArray),f||v}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Lw(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,t){const r=this.lineVertexArray.length;if(void 0!==e.segment)for(const{x:e,y:r}of t)this.lineVertexArray.emplaceBack(e,r);return{lineStartIndex:r,lineLength:this.lineVertexArray.length-r}}addSymbols(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C){const R=e.indexArray,z=e.layoutVertexArray,D=e.globeExtVertexArray,O=e.segments.prepareSegment(4*C,z,R,this.canOverlap?l.sortKey:void 0),F=this.glyphOffsetArray.length,B=O.vertexLength,k=this.allowVerticalPlacement&&c===Mv.vertical?Math.PI/2:0,V=l.text&&l.text.sections;for(let o=0;o<t.length;o++){const{tl:s,tr:c,bl:d,br:p,texPrimary:f,texSecondary:P,pixelOffsetTL:C,pixelOffsetBR:F,minFontScaleX:B,minFontScaleY:N,glyphOffset:U,isSDF:j,sectionIndex:$}=t[o],q=O.vertexLength,H=U[1];if(Bw(z,u.x,u.y,s.x,H+s.y,f.x,f.y,r,j,C.x,C.y,B,N),Bw(z,u.x,u.y,c.x,H+c.y,f.x+f.w,f.y,r,j,F.x,C.y,B,N),Bw(z,u.x,u.y,d.x,H+d.y,f.x,f.y+f.h,r,j,C.x,F.y,B,N),Bw(z,u.x,u.y,p.x,H+p.y,f.x+f.w,f.y+f.h,r,j,F.x,F.y,B,N),h){const{x:t,y:r,z:o}=h.anchor,[s,l,c]=h.up;Vw(D,t,r,o,s,l,c),Vw(D,t,r,o,s,l,c),Vw(D,t,r,o,s,l,c),Vw(D,t,r,o,s,l,c),Uw(e.dynamicLayoutVertexArray,t,r,o,k)}else Uw(e.dynamicLayoutVertexArray,u.x,u.y,u.z,k);if(E){const t=P||f;kw(e.iconTransitioningVertexArray,t.x,t.y),kw(e.iconTransitioningVertexArray,t.x+t.w,t.y),kw(e.iconTransitioningVertexArray,t.x,t.y+t.h),kw(e.iconTransitioningVertexArray,t.x+t.w,t.y+t.h)}R.emplaceBack(q,q+1,q+2),R.emplaceBack(q+1,q+2,q+3),O.vertexLength+=4,O.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(U[0]),o!==t.length-1&&$===t[o+1].sectionIndex||e.programConfigurations.populatePaintArrays(z.length,l,l.index,{},m,_,v,V&&V[$],this.worldview)}const N=C-t.length;0!==N&&this._addNullVertices(N,z,r,h,D,e,E,O,R);const U=h?h.anchor:u;e.placedSymbolArray.emplaceBack(U.x,U.y,U.z,u.x,u.y,F,this.glyphOffsetArray.length-F,B,d,p,u.segment,r?r[0]:0,r?r[1]:0,o[0],o[1],c,0,0,0,f,0),e.symbolInstanceIndices.push(P)}_addNullVertices(e,t,r,o,s,l,c,h,u){for(let d=0;d<e;d++){for(let e=0;e<4;e++)Bw(t,0,0,0,0,0,0,r,!1,0,0,0,0),o?(Vw(s,0,0,0,0,0,0),Uw(l.dynamicLayoutVertexArray,0,0,0,0)):Uw(l.dynamicLayoutVertexArray,0,0,0,0),c&&kw(l.iconTransitioningVertexArray,0,0);const e=h.vertexLength;u.emplaceBack(e,e+1,e+2),u.emplaceBack(e+1,e+2,e+3),h.vertexLength+=4,h.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,t,r,o,s,l,c){e.emplaceBack(t,r,o,s,l,Math.round(c.x),Math.round(c.y))}_addCollisionDebugVertices(e,t,r,o,s,l,c){const h=r.segments.prepareSegment(4,r.layoutVertexArray,r.indexArray),u=h.vertexLength,d=c.tileAnchorX,p=c.tileAnchorY;for(let e=0;e<4;e++)r.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(r.collisionVertexArrayExt,t,e.padding,c.zOffset),this._commitLayoutVertex(r.layoutVertexArray,o,s,l,d,p,new Je(e.x1,e.y1)),this._commitLayoutVertex(r.layoutVertexArray,o,s,l,d,p,new Je(e.x2,e.y1)),this._commitLayoutVertex(r.layoutVertexArray,o,s,l,d,p,new Je(e.x2,e.y2)),this._commitLayoutVertex(r.layoutVertexArray,o,s,l,d,p,new Je(e.x1,e.y2)),h.vertexLength+=4;const f=r.indexArray;f.emplaceBack(u,u+1),f.emplaceBack(u+1,u+2),f.emplaceBack(u+2,u+3),f.emplaceBack(u+3,u),h.primitiveLength+=4}_addTextDebugCollisionBoxes(e,t,r,o,s,l){for(let c=o;c<s;c++){const o=r.get(c),s=this.getSymbolInstanceTextSize(e,l,t,c);this._addCollisionDebugVertices(o,s,this.textCollisionBox,o.projectedAnchorX,o.projectedAnchorY,o.projectedAnchorZ,l)}}_addIconDebugCollisionBoxes(e,t,r,o,s,l){for(let c=o;c<s;c++){const o=r.get(c),s=this.getSymbolInstanceIconSize(e,t,l.placedIconSymbolIndex);this._addCollisionDebugVertices(o,s,this.iconCollisionBox,o.projectedAnchorX,o.projectedAnchorY,o.projectedAnchorZ,l)}}generateCollisionDebugBuffers(e,t,r){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new tb(sl,ev.members,nl),this.iconCollisionBox=new tb(sl,ev.members,nl);const o=nb(this.iconSizeData,e),s=nb(this.textSizeData,e,r);for(let r=0;r<this.symbolInstances.length;r++){const l=this.symbolInstances.get(r);this._addTextDebugCollisionBoxes(s,e,t,l.textBoxStartIndex,l.textBoxEndIndex,l),this._addTextDebugCollisionBoxes(s,e,t,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l),this._addIconDebugCollisionBoxes(o,e,t,l.iconBoxStartIndex,l.iconBoxEndIndex,l),this._addIconDebugCollisionBoxes(o,e,t,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex,l)}}getSymbolInstanceTextSize(e,t,r,o){const s=this.text.placedSymbolArray.get(t.rightJustifiedTextSymbolIndex>=0?t.rightJustifiedTextSymbolIndex:t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.leftJustifiedTextSymbolIndex>=0?t.leftJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex>=0?t.verticalPlacedTextSymbolIndex:o),l=rb(this.textSizeData,e,s)/iv;return this.tilePixelRatio*l}getSymbolInstanceIconSize(e,t,r){const o=this.icon.placedSymbolArray.get(r),s=rb(this.iconSizeData,e,o);return this.tilePixelRatio*s}_commitDebugCollisionVertexUpdate(e,t,r,o){e.emplaceBack(t,-r,-r,o),e.emplaceBack(t,r,-r,o),e.emplaceBack(t,r,r,o),e.emplaceBack(t,-r,r,o)}_updateTextDebugCollisionBoxes(e,t,r,o,s,l,c){for(let c=o;c<s;c++){const o=r.get(c),s=this.getSymbolInstanceTextSize(e,l,t,c);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,s,o.padding,l.zOffset)}}_updateIconDebugCollisionBoxes(e,t,r,o,s,l,c){for(let c=o;c<s;c++){const o=r.get(c),s=this.getSymbolInstanceIconSize(e,t,l.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,s,o.padding,l.zOffset)}}updateCollisionDebugBuffers(e,t,r,o){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const s=nb(this.iconSizeData,e,o),l=nb(this.textSizeData,e,r);for(let c=0;c<this.symbolInstances.length;c++){const h=this.symbolInstances.get(c);this._updateTextDebugCollisionBoxes(l,e,t,h.textBoxStartIndex,h.textBoxEndIndex,h,r),this._updateTextDebugCollisionBoxes(l,e,t,h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h,r),this._updateIconDebugCollisionBoxes(s,e,t,h.iconBoxStartIndex,h.iconBoxEndIndex,h,o),this._updateIconDebugCollisionBoxes(s,e,t,h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h,o)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,t,r,o,s,l,c,h,u){const d={};if(t<r){const{x1:r,y1:o,x2:s,y2:l,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m,featureIndex:_}=e.get(t);d.textBox={x1:r,y1:o,x2:s,y2:l,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m},d.textFeatureIndex=_}if(o<s){const{x1:t,y1:r,x2:s,y2:l,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m,featureIndex:_}=e.get(o);d.verticalTextBox={x1:t,y1:r,x2:s,y2:l,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m},d.verticalTextFeatureIndex=_}if(l<c){const{x1:t,y1:r,x2:o,y2:s,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m,featureIndex:_}=e.get(l);d.iconBox={x1:t,y1:r,x2:o,y2:s,padding:c,projectedAnchorX:h,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m},d.iconFeatureIndex=_}if(h<u){const{x1:t,y1:r,x2:o,y2:s,padding:l,projectedAnchorX:c,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m,featureIndex:_}=e.get(h);d.verticalIconBox={x1:t,y1:r,x2:o,y2:s,padding:l,projectedAnchorX:c,projectedAnchorY:u,projectedAnchorZ:p,tileAnchorX:f,tileAnchorY:m},d.verticalIconFeatureIndex=_}return d}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let t=0;t<this.symbolInstances.length;t++){const r=this.symbolInstances.get(t);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,r.textBoxStartIndex,r.textBoxEndIndex,r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r.iconBoxStartIndex,r.iconBoxEndIndex,r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,t){const r=e.placedSymbolArray.get(t),o=r.vertexStartIndex+4*r.numGlyphs;for(let t=r.vertexStartIndex;t<o;t+=4)e.indexArray.emplaceBack(t,t+1,t+2),e.indexArray.emplaceBack(t+1,t+2,t+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const t=Math.sin(e),r=Math.cos(e),o=[],s=[],l=[];for(let e=0;e<this.symbolInstances.length;++e){l.push(e);const c=this.symbolInstances.get(e);o.push(0|Math.round(t*c.tileAnchorX+r*c.tileAnchorY)),s.push(c.featureIndex)}return l.sort(((e,t)=>o[e]-o[t]||s[t]-s[e])),l}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,t)=>this.symbolInstances.get(t).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,t){const r=this.sortKeyRanges[this.sortKeyRanges.length-1];r&&r.sortKey===t?r.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:t,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const e of this.symbolInstanceIndexes){const t=this.symbolInstances.get(e);this.featureSortOrder.push(t.featureIndex);const{rightJustifiedTextSymbolIndex:r,centerJustifiedTextSymbolIndex:o,leftJustifiedTextSymbolIndex:s,verticalPlacedTextSymbolIndex:l,placedIconSymbolIndex:c,verticalPlacedIconSymbolIndex:h}=t;r>=0&&this.addIndicesForPlacedSymbol(this.text,r),o>=0&&o!==r&&this.addIndicesForPlacedSymbol(this.text,o),s>=0&&s!==o&&s!==r&&this.addIndicesForPlacedSymbol(this.text,s),l>=0&&this.addIndicesForPlacedSymbol(this.text,l),c>=0&&this.addIndicesForPlacedSymbol(this.icon,c),h>=0&&this.addIndicesForPlacedSymbol(this.icon,h)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const t=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let r;return this.elevationFeatures&&t<this.elevationFeatures.length&&(r=this.elevationFeatures[t]),r}}function Hw(e,t){return t.replace(/{([^{}]+)}/g,((t,r)=>r in e?String(e[r]):""))}let Ww,Zw,Xw;ih(eb,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),eb.addDynamicAttributes=Uw;class ab{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:zr,this.defaultValue=e}evaluate(e){if(e.formattedSection){const t=this.defaultValue.property.overrides;if(t&&t.hasOverride(e.formattedSection))return t.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}ih(ab,"FormatSectionOverride",{omit:["defaultValue"]});const Jw=()=>Xw||(Xw={layout:Ww||(Ww=new uo({"symbol-placement":new ao(mu.layout_symbol["symbol-placement"]),"symbol-spacing":new ao(mu.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ao(mu.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new oo(mu.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ao(mu.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ao(mu.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ao(mu.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ao(mu.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ao(mu.layout_symbol["icon-ignore-placement"]),"icon-optional":new ao(mu.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ao(mu.layout_symbol["icon-rotation-alignment"]),"icon-size":new oo(mu.layout_symbol["icon-size"]),"icon-size-scale-range":new ao(mu.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new oo(mu.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new oo(mu.layout_symbol["icon-text-fit-padding"]),"icon-image":new oo(mu.layout_symbol["icon-image"]),"icon-image-use-theme":new ao({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new oo(mu.layout_symbol["icon-rotate"]),"icon-padding":new ao(mu.layout_symbol["icon-padding"]),"icon-keep-upright":new ao(mu.layout_symbol["icon-keep-upright"]),"icon-offset":new oo(mu.layout_symbol["icon-offset"]),"icon-anchor":new oo(mu.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ao(mu.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ao(mu.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ao(mu.layout_symbol["text-rotation-alignment"]),"text-field":new oo(mu.layout_symbol["text-field"]),"text-font":new oo(mu.layout_symbol["text-font"]),"text-size":new oo(mu.layout_symbol["text-size"]),"text-size-scale-range":new ao(mu.layout_symbol["text-size-scale-range"]),"text-max-width":new oo(mu.layout_symbol["text-max-width"]),"text-line-height":new oo(mu.layout_symbol["text-line-height"]),"text-letter-spacing":new oo(mu.layout_symbol["text-letter-spacing"]),"text-justify":new oo(mu.layout_symbol["text-justify"]),"text-radial-offset":new oo(mu.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ao(mu.layout_symbol["text-variable-anchor"]),"text-anchor":new oo(mu.layout_symbol["text-anchor"]),"text-max-angle":new ao(mu.layout_symbol["text-max-angle"]),"text-writing-mode":new ao(mu.layout_symbol["text-writing-mode"]),"text-rotate":new oo(mu.layout_symbol["text-rotate"]),"text-padding":new ao(mu.layout_symbol["text-padding"]),"text-keep-upright":new ao(mu.layout_symbol["text-keep-upright"]),"text-transform":new oo(mu.layout_symbol["text-transform"]),"text-offset":new oo(mu.layout_symbol["text-offset"]),"text-allow-overlap":new ao(mu.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ao(mu.layout_symbol["text-ignore-placement"]),"text-optional":new ao(mu.layout_symbol["text-optional"]),visibility:new ao(mu.layout_symbol.visibility)})),paint:Zw||(Zw=new uo({"icon-opacity":new oo(mu.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new oo(mu.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new oo(mu.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new oo(mu.paint_symbol["text-emissive-strength"]),"icon-color":new oo(mu.paint_symbol["icon-color"]),"icon-halo-color":new oo(mu.paint_symbol["icon-halo-color"]),"icon-halo-width":new oo(mu.paint_symbol["icon-halo-width"]),"icon-halo-blur":new oo(mu.paint_symbol["icon-halo-blur"]),"icon-translate":new ao(mu.paint_symbol["icon-translate"]),"icon-translate-anchor":new ao(mu.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ao(mu.paint_symbol["icon-image-cross-fade"]),"text-opacity":new oo(mu.paint_symbol["text-opacity"]),"text-occlusion-opacity":new oo(mu.paint_symbol["text-occlusion-opacity"]),"text-color":new oo(mu.paint_symbol["text-color"],{runtimeType:Vr,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new oo(mu.paint_symbol["text-halo-color"]),"text-halo-width":new oo(mu.paint_symbol["text-halo-width"]),"text-halo-blur":new oo(mu.paint_symbol["text-halo-blur"]),"text-translate":new ao(mu.paint_symbol["text-translate"]),"text-translate-anchor":new ao(mu.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ao(mu.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ao(mu.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ao(mu.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ao(mu.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new oo(mu.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},Xw);class lb extends Fo{constructor(e,t,r,o){super(e,Jw(),t,r,o,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=p([]),this.hasOcclusionOpacityProperties=void 0!==e.paint&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){"icon-occlusion-opacity"!==e&&"text-occlusion-opacity"!==e||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,t){super.recalculate(e,t),this.appearances&&this.appearances.forEach((r=>{r.recalculate(e,t,this.iconImageUseTheme)})),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const r=this.layout.get("text-writing-mode");if(r){const e=[];for(const t of r)e.indexOf(t)<0&&e.push(t);this.layout._values["text-writing-mode"]=e}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,t,r,o){return this._saturation===e&&this._contrast===t&&this._brightnessMin===r&&this._brightnessMax===o||(this._colorAdjustmentMatrix=function(e,t,r,o){e=Gt(e),t=jt(t);const s=u(),l=e/3,c=1-2*l,h=[c,l,l,0,l,c,l,0,l,l,c,0,0,0,0,1],d=.5-.5*t,p=o-r;return m(s,[p,0,0,0,0,p,0,0,0,0,p,0,r,r,r,1],[t,0,0,0,0,t,0,0,0,0,t,0,d,d,d,1]),m(s,s,h),s}(e,t,r,o),this._saturation=e,this._contrast=t,this._brightnessMin=r,this._brightnessMax=o),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,t,r,o){const s=this.layout.get(e).evaluate(t,{},r,o),l=this._unevaluatedLayout._values[e];return l.isDataDriven()||$c(l.value)||!s?s:Hw(t.properties,s)}getAppearanceValueAndResolveTokens(e,t,r,o,s){const l=e.getProperty(t);if(!l)return;const c=l.evaluate(r,{},o,s),h=e.getUnevaluatedProperties()._values[t];return h.isDataDriven()||$c(h.value)||!c||"string"!=typeof c?c:Hw(r.properties,c)}createBucket(e){return new eb(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Jw().paint.overridableProperties){if(!lb.hasPaintOverride(this.layout,e))continue;const t=this.paint.get(e),r=new ab(t),o=new Us(r,t.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let s=null;s="constant"===t.value.kind||"source"===t.value.kind?new Gs("source",o):new $s("composite",o,t.value.zoomStops,t.value.interpolationType),this.paint._values[e]=new io(t.property,s,t.parameters)}}_handleOverridablePaintPropertyUpdate(e,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven())&&lb.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,t){const r=e.get("text-field"),o=Jw().paint.properties[t];let s=!1;const l=e=>{for(const t of e)if(o.overrides&&o.overrides.hasOverride(t))return void(s=!0)};if("constant"===r.value.kind&&r.value.value instanceof Rr)l(r.value.value.sections);else if("source"===r.value.kind){const e=t=>{s||(t instanceof $r&&fn(t.value)===Gr?l(t.value.sections):t instanceof Zr?l(t.sections):t.eachChild(e))},t=r.value;t._styleExpression&&e(t._styleExpression.expression)}return s}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,t,r){return{config:new du(this,{zoom:t,lut:r}),overrideFog:!1}}hasElevation(){return this.layout&&"hd-road-markup"===this.layout.get("symbol-elevation-reference")}}let Qw,Kw,eT,tT;var iT=Uu([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function rT(e,t,r,o,s,l,u,d){const p=[e,t,1,r,o,1,s,l,1],f=[u,d,1],m=c([],p),[_,v,E]=ae(f,f,m);return h(p,p,[_,0,0,0,v,0,0,0,E])}function nT(e,t,r,o,s,l,u,d){const p=function(e,t,r,o,s,l,u,d){const p=rT(0,0,1,0,1,1,0,1),f=rT(e,t,r,o,s,l,u,d);return h(f,f,c([],p))}(e,t,r,o,s,l,u,d);return[p[2]/p[8]/Ao,p[5]/p[8]/Ao]}function oT(e){return[e[0],Math.min(Math.max(e[1],-85.051129),zd)]}class gb extends ir{constructor(e,t,r,o){super(),this.id=e,this.dispatcher=r,this.coordinates=t.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(o),this.options=t,this._dirty=!1}load(e,t){if(this._loaded=t||!1,this.fire(new tr("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=ar(this.map._requestManager.transformRequest(this.url,Li.Image),((t,r)=>{this._imageRequest=null,this._loaded=!0,t?this.fire(new er(t)):r&&(this.image=r instanceof HTMLImageElement?ri.getImageData(r):r,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Rm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new tr("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Rm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let t=e[0][1],r=e[0][1];for(const o of e)o[1]>r&&(r=o[1]),o[1]<t&&(t=o[1]);const o=(r+t)/2;if(o>zd?this.onNorthPole=!0:o<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const t=e.map(Gu.fromLngLat);this.tileID=function(e){let t=1/0,r=1/0,o=-1/0,s=-1/0;for(const l of e)t=Math.min(t,l.x),r=Math.min(r,l.y),o=Math.max(o,l.x),s=Math.max(s,l.y);const l=Math.max(o-t,s-r),c=Math.max(0,Math.floor(-Math.log2(l))),h=Math.pow(2,c);let u=Math.floor((t+o)/2*h);return u>1&&(u-=1),new Yc(c,u,Math.floor((r+s)/2*h))}(t),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new tr("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Rm||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const t=bw(new Yc(0,0,0),this.map.transform.projection),r=[t.projection.project(this.coordinates[0][0],this.coordinates[0][1]),t.projection.project(this.coordinates[1][0],this.coordinates[1][1]),t.projection.project(this.coordinates[2][0],this.coordinates[2][1]),t.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(e){const t=e[1].x-e[0].x,r=e[1].y-e[0].y,o=e[2].x-e[1].x,s=e[2].y-e[1].y,l=e[3].x-e[2].x,c=e[3].y-e[2].y,h=e[0].x-e[3].x,u=e[0].y-e[3].y,d=t*s-o*r,p=o*c-l*s,f=l*u-h*c,m=h*r-t*u;return d>0&&p>0&&f>0&&m>0||d<0&&p<0&&f<0&&m<0}(r))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const o=bw(this.tileID,this.map.transform.projection),[s,l,u,d]=this.coordinates.map((e=>{const t=o.projection.project(e[0],e[1]);return ww(o,t)._round()}));this.perspectiveTransform=nT(s.x,s.y,l.x,l.y,u.x,u.y,d.x,d.y);const p=this._boundsArray=new Go;p.emplaceBack(s.x,s.y,0,0),p.emplaceBack(l.x,l.y,Ao,0),p.emplaceBack(d.x,d.y,0,Ao),p.emplaceBack(u.x,u.y,Ao,Ao),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(p,iT.members),this.boundsSegments=Ol.simpleSegment(0,0,4,2);const f=[],m=[oT((_=this.coordinates)[0]),oT(_[1]),oT(_[2]),oT(_[3])];var _;const[v,E,P,C]=function(e){let t=e[0][0],r=t,o=e[0][1],s=o;for(let l=1;l<e.length;l++)e[l][0]<t?t=e[l][0]:e[l][0]>r&&(r=e[l][0]),e[l][1]<o?o=e[l][1]:e[l][1]>s&&(s=e[l][1]);return[t,o,r-t,s-o]}(m);{const o=new Go,[s,l,u,d]=function(e){let t=e[0].x,r=t,o=e[0].y,s=o;for(let l=1;l<e.length;l++)e[l].x<t?t=e[l].x:e[l].x>r&&(r=e[l].x),e[l].y<o?o=e[l].y:e[l].y>s&&(s=e[l].y);return[t,o,r-t,s-o]}(r),p=e=>[(e.x-s)/u,(e.y-l)/d],[m,_,R,z]=r.map(p),D=function(e,t,r,o,s,l,u,d){const p=rT(0,0,1,0,1,1,0,1);return h(p,p,c([],rT(e,t,r,o,s,l,u,d)))}(m[0],m[1],_[0],_[1],R[0],R[1],z[0],z[1]);this.elevatedGlobePerspectiveTransform=nT(m[0],m[1],_[0],_[1],R[0],R[1],z[0],z[1]);const O=(e,t)=>{f.push(e.lng);const r=Math.round((e.lng-v)/P*Ao),s=Math.round((e.lat-E)/C*Ao),l=p(t),c=ae([],[l[0],l[1],1],D),h=Math.round(c[0]/c[2]*Ao),u=Math.round(c[1]/c[2]*Ao);o.emplaceBack(r,s,h,u)},F=r[3].x-r[0].x,B=r[3].y-r[0].y,k=r[2].x-r[1].x,V=r[2].y-r[1].y;for(let e=0;e<65;e++){const o=e/64,s=[r[0].x+o*F,r[0].y+o*B],l=[r[1].x+o*k,r[1].y+o*V],c=l[0]-s[0],h=l[1]-s[1];for(let e=0;e<65;e++){const r=e/64,o={x:s[0]+c*r,y:s[1]+h*r};O(t.projection.unproject(o.x,o.y),o)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(o,iT.members)}{this.maxLongitudeTriangleSize=0;let t=[],r=new ll;const o=(e,o,s)=>{r.emplaceBack(e,o,s);const l=f[e],c=f[o],h=f[s],u=Math.min(Math.min(l,c),h),d=Math.max(Math.max(l,c),h)-u;d>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=d),t.push(u+d/2)};for(let e=0;e<64;e++)for(let t=0;t<64;t++){const r=65*e+t,s=r+1,l=r+65,c=l+1;o(r,l,s),o(s,l,c)}[t,r]=function(e,t){const r=Array.from({length:e.length},((e,t)=>t));r.sort(((t,r)=>e[t]-e[r]));const o=[],s=new ll;for(let l=0;l<r.length;l++){const c=r[l];o.push(e[c]);const h=3*c,u=h+1;s.emplaceBack(t.uint16[h],t.uint16[u],t.uint16[u+1])}return[o,s]}(t,r),this.elevatedGlobeTrianglesCenterLongitudes=t,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(r)}this.elevatedGlobeSegments=Ol.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,P/Ao,0,C/Ao,0,0,E,v,0])}prepare(){const e=0!==Object.keys(this.tiles).length;if(this.tileID&&!e)return;const t=this.map.painter.context,r=t.gl;!this._dirty||this.texture instanceof Rm||(this.texture?this.texture.update(this.image):(this.texture=new Cm(t,this.image,r.RGBA8),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(t)}loadTile(e,t){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},t(null)):(e.state="errored",t(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const t=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!t)return null;const r=this.elevatedGlobeTrianglesCenterLongitudes;let o=(s=e+180)+360*Math.round((r[0]-s)/360);var s;const l=new Ol,c=(e,r)=>{l.segments.push({vertexOffset:0,primitiveOffset:e,vertexLength:t.segments[0].vertexLength,primitiveLength:r,sortKey:void 0,vaos:{}})},h=.51*this.maxLongitudeTriangleSize;if(Math.abs(r[0]-o)<=h){const e=Nt(r,0,r.length,o+h);return e===r.length||c(e,Vt(r,e+1,r.length,o+360-h)-e),l}o<r[0]&&(o+=360);const u=Vt(r,0,r.length,o-h);if(u===r.length)return c(0,r.length),l;c(0,u-0);const d=Nt(r,u+1,r.length,o+h);return d!==r.length&&c(d,r.length-d),l}}const sT=1024,aT=(Math.pow(sT,2)-1)/268170240;class bb extends Fo{constructor(e,t,r,o){super(e,{layout:eT||(eT=new uo({visibility:new ao(mu.layout_raster.visibility)})),paint:tT||(tT=new uo({"raster-opacity":new ao(mu.paint_raster["raster-opacity"]),"raster-color":new lo(mu.paint_raster["raster-color"]),"raster-color-mix":new ao(mu.paint_raster["raster-color-mix"]),"raster-color-range":new ao(mu.paint_raster["raster-color-range"]),"raster-hue-rotate":new ao(mu.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ao(mu.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ao(mu.paint_raster["raster-brightness-max"]),"raster-saturation":new ao(mu.paint_raster["raster-saturation"]),"raster-contrast":new ao(mu.paint_raster["raster-contrast"]),"raster-resampling":new ao(mu.paint_raster["raster-resampling"]),"raster-fade-duration":new ao(mu.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ao(mu.paint_raster["raster-emissive-strength"]),"raster-array-band":new ao(mu.paint_raster["raster-array-band"]),"raster-elevation":new ao(mu.paint_raster["raster-elevation"]),"raster-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof gb&&(e._source.onNorthPole||e._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap())return;if(!this._curRampRange)return;const t=this._transitionablePaint._values["raster-color"].value.expression,[r,o]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(r)&&isNaN(o)||r===this._curRampRange[0]&&o===this._curRampRange[1]||(this.colorRamp=Mf({expression:t,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:r,end:o}],resolution:sT}),this.colorRampTexture=null,this._curRampRange=[r,o])}is3D(e){return this.paint.get("raster-elevation")>0}}let lT,cT,hT,uT,dT;class Sb extends Fo{constructor(e,t,r,o){super(e,{layout:lT||(lT=new uo({visibility:new ao(mu["layout_raster-particle"].visibility)})),paint:cT||(cT=new uo({"raster-particle-array-band":new ao(mu["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ao(mu["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new lo(mu["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ao(mu["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ao(mu["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ao(mu["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ao(mu["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ao(mu["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this._updateColorRamp(),this.lastInvalidatedAt=ri.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){"raster-particle-color"!==e&&"raster-particle-max-speed"!==e||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===e&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,t=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Mf({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:t}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=ri.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Pb extends Fo{constructor(e,t){super(e,{},t,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(e){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function pT(e,t,r){const o=[0,0,1],s=be([]);return Ie(s,s,r?-it(e)+Math.PI:it(e)),we(s,s,-it(t)),le(o,o,s),ie(o,o)}const fT={None:0,Model:1,Symbol:2,FillExtrusion:4};class kb{constructor(e,t,r,o){this.message=(e?`${e}: `:"")+r,o&&(this.identifier=o),null!=t&&t.__line__&&(this.line=t.__line__)}}function mT(e,t){const r=-1===e.indexOf("://");try{return new URL(e,r&&t?"http://example.com":void 0),!0}catch(e){return!1}}class Vb{constructor(e,t){this.feature=e,this.instancedDataOffset=t,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Eb{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new vl,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const t=16*e,r=this.instancedDataArray.float32;let o=Math.floor(r[t+2]);const s=1.05*(r[t+2]-o);return o/=100,[r[t]%1*1.05,r[t+1]%1*1.05,s,o]}tileCoordinatesForInstance(e){const t=16*e,r=this.instancedDataArray.float32;let o=r[t+0];return o=o>Ao?o-Ao:o,new Je(Math.trunc(o),Math.trunc(r[t+1]))}translationForInstance(e){const t=16*e,r=this.instancedDataArray.float32;return[r[t+4],r[t+5],r[t+6]]}rotationScaleForInstance(e){const t=16*e,r=this.instancedDataArray.float32;return[r[t+7],r[t+8],r[t+9],r[t+10],r[t+11],r[t+12],r[t+13],r[t+14],r[t+15]]}transformForInstance(e){const t=16*e,r=this.instancedDataArray.float32;return[r[t+7],r[t+8],r[t+9],r[t+4],r[t+10],r[t+11],r[t+12],r[t+5],r[t+13],r[t+14],r[t+15],r[t+6],0,0,0,1]}}class Fb{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,r,o){}populate(e,t,r,o){this.tileToMeter=Fd(r);const s=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);const l="hd-road-markup"===this.layers[0].paint.get("model-elevation-reference")?t.elevationFeatures:void 0;for(const{feature:c,id:h,index:u,sourceLayerIndex:d}of e){const e=null!=h?h:c.properties&&c.properties.hasOwnProperty("id")?c.properties.id:void 0,p=qd(c,s);if(!this.layers[0]._featureFilter.filter(new Ja(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),p,r))continue;const f={id:e,sourceLayerIndex:d,index:u,geometry:s?p.geometry:$d(c,r,o),properties:c.properties,type:c.type,patterns:{}},m=this.addFeature(f,f.geometry,p,l,r);m&&t.featureIndex.insert(c,f.geometry,u,d,this.index,this.instancesPerModel[m].instancedDataArray.length,256)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,t=this.layers[0].scope;let r=0;for(const o of this.modelUris){const s=e.getModel(o,t);if(!s)continue;const l=this.instancesPerModel[o];if(l){const e=.5*Q(s.aabb.max,s.aabb.min)*l.maxScale+l.maxXYTranslationDistance,t=Math.min(Ao,Math.max(e/this.tileToMeter,256));r=Math.max(t,r)}}return r}update(e,t,r,o){for(const t in this.instancesPerModel){const r=this.instancesPerModel[t];for(const t in e)r.idToFeaturesIndex.hasOwnProperty(t)&&(this.evaluate(r.features[r.idToFeaturesIndex[t]],e[t],r,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const t in this.instancesPerModel){const r=this.instancesPerModel[t];for(const t of r.features){const o=this.layers[0],s=t.feature,l=this.canonical,c=o.paint.get("model-rotation").evaluate(s,{},l),h=o.paint.get("model-scale").evaluate(s,{},l),u=o.paint.get("model-translation").evaluate(s,{},l);he(t.rotation,c)&&he(t.scale,h)&&he(t.translation,u)||(this.evaluate(t,t.featureStates,r,!0),e=!0)}}return e}updateReplacement(e,t,r,o){if(t.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=t.updateTime;const s=t.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(w_(this.activeReplacements,s))return!1;this.activeReplacements=s;let l=!1;for(const t in this.instancesPerModel){const s=this.instancesPerModel[t],c=s.instancedDataArray;for(const t of s.features){const s=t.instancedDataOffset,h=t.instancedDataCount;for(let t=0;t<h;t++){const h=16*(t+s);let u=c.float32[h+0];const d=u>Ao;u=d?u-Ao:u;const p=Math.floor(u),f=Math.floor(c.float32[h+1]);let m=!1;for(const t of this.activeReplacements)if(!y_(t,r,fT.Model,o)&&!(t.min.x>p||p>t.max.x||t.min.y>f||f>t.max.y)&&(m=M_(A_(p,f,e.canonical,t.footprintTileId.canonical),t.footprint),m))break;c.float32[h]=m?u+Ao:u,l=l||m!==d}}}return l}isEmpty(){for(const e in this.instancesPerModel)if(0!==this.instancesPerModel[e].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const t in this.instancesPerModel){const r=this.instancesPerModel[t];r.instancedDataArray.length<0||0===r.instancedDataArray.length||(r.instancedDataBuffer?r.instancedDataBuffer.updateData(r.instancedDataArray):r.instancedDataBuffer=e.createVertexBuffer(r.instancedDataArray,yy.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(e){for(const e in this.instancesPerModel){const t=this.instancesPerModel[e];0!==t.instancedDataArray.length&&t.instancedDataBuffer&&t.instancedDataBuffer.destroy()}const t=this.layers[0].modelManager;if(e&&t&&this.modelUris&&this.modelsRequested)for(const e of this.modelUris)t.removeModel(e,"",!0)}addFeature(e,t,r,o,s){const l=this.layers[0],c=l.layout.get("model-id"),h=l.layout.get("model-allow-density-reduction"),u=c.evaluate(r,{},this.canonical);if(!u)return Et(`modelId is not evaluated for layer ${l.id} and it is not going to get rendered.`),u;(mT(u,!1)||void 0!==this.styleDefinedModelURLs[u])&&(this.modelUris.includes(u)||this.modelUris.push(u)),this.instancesPerModel[u]||(this.instancesPerModel[u]=new Eb);const d=this.instancesPerModel[u],p=d.instancedDataArray,f=new Vb(r,p.length);let m;o&&(m=Mc.getElevationFeature(e,o));for(const e of t)for(const t of e){if(t.x<0||t.x>=Ao||t.y<0||t.y>=Ao)continue;if(0!==this.lookupDim&&h){const e=(this.lookupDim-1)/Ao,r=this.lookupDim*(t.y*e|0)+t.x*e|0;if(this.lookup){if(0!==this.lookup[r])continue;this.lookup[r]=1}}this.instanceCount++;const e=p.length;if(p.resize(e+1),o){d.instancesRoadElevation||(d.instancesRoadElevation=[]);const e=m?m.pointElevation(new Je(t.x,t.y)):0;d.instancesRoadElevation.push(e)}d.instancesEvaluatedElevation.push(0),p.float32[16*e]=t.x,p.float32[16*e+1]=t.y}return f.instancedDataCount=d.instancedDataArray.length-f.instancedDataOffset,f.instancedDataCount>0&&(e.id&&(d.idToFeaturesIndex[e.id]=d.features.length),d.features.push(f),this.evaluate(f,{},d,!1)),u}getModelUris(){return this.modelUris}evaluate(e,t,r,o){const s=this.layers[0],l=e.feature,c=this.canonical,h=e.rotation=s.paint.get("model-rotation").evaluate(l,t,c),u=e.scale=s.paint.get("model-scale").evaluate(l,t,c),d=e.translation=s.paint.get("model-translation").evaluate(l,t,c),p=Object.assign({},s.paint.get("model-color").evaluate(l,t,c));p.a=s.paint.get("model-color-mix-intensity").evaluate(l,t,c);const f=[];this.maxVerticalOffset<d[2]&&(this.maxVerticalOffset=d[2]);const m=d[0]*d[0]+d[1]*d[1],_=m>0?Math.sqrt(m):0;r.maxScale=Math.max(Math.max(r.maxScale,u[0]),Math.max(u[1],u[2])),r.maxXYTranslationDistance=Math.max(r.maxXYTranslationDistance,_),this.maxScale=Math.max(Math.max(this.maxScale,u[0]),Math.max(u[1],u[2])),Ey(f,h,u);const v=Math.round(100*p.a)+p.b/1.05;for(let t=0;t<e.instancedDataCount;++t){const s=e.instancedDataOffset+t,l=16*s,h=r.instancedDataArray.float32;let u=0;o&&(u=h[l+6]-r.instancesEvaluatedElevation[s]);const m=0|h[l+1];h[l]=(0|h[l])+p.r/1.05,h[l+1]=m+p.g/1.05,h[l+2]=v,h[l+3]=1/(c.z>10?this.tileToMeter:Fd(c,m)),h[l+4]=d[0],h[l+5]=d[1],h[l+6]=d[2]+(r.instancesRoadElevation?r.instancesRoadElevation[s]:0)+u,h[l+7]=f[0],h[l+8]=f[1],h[l+9]=f[2],h[l+10]=f[4],h[l+11]=f[5],h[l+12]=f[6],h[l+13]=f[8],h[l+14]=f[9],h[l+15]=f[10],r.instancesEvaluatedElevation[s]=d[2]}}}let _T,gT;ih(Fb,"ModelBucket",{omit:["layers"]}),ih(Eb,"PerModelAttributes"),ih(Vb,"ModelFeature");class Rb{constructor(e,t,r){this._demTile=e,this._dem=this._demTile.dem,this._scale=t,this._offset=r}static create(e,t,r){const o=r||e.findDEMTileFor(t);if(!o||!o.dem)return;const s=o.dem,l=o.tileID,c=1<<t.canonical.z-l.canonical.z;return new Rb(o,s.dim/Ao/c,[(t.canonical.x/c-l.canonical.x)*s.dim,(t.canonical.y/c-l.canonical.y)*s.dim])}tileCoordToPixel(e,t){const r=t*this._scale+this._offset[1];return new Je(Math.floor(e*this._scale+this._offset[0]),Math.floor(r))}getElevationAt(e,t,r,o){const s=e*this._scale+this._offset[0],l=t*this._scale+this._offset[1],c=Math.floor(s),h=Math.floor(l),u=this._dem;return o=!!o,r?Ar(Ar(u.get(c,h,o),u.get(c,h+1,o),l-h),Ar(u.get(c+1,h,o),u.get(c+1,h+1,o),l-h),s-c):u.get(c,h,o)}getElevationAtPixel(e,t,r){return this._dem.get(e,t,!!r)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Ad(1,e)*this._dem.stride}}const yT=new Float32Array(262144),xT=new Uint8Array(262144);function vT(e){let t=0;if(e.meshes)for(const r of e.meshes)t=Math.max(t,r.aabb.max[2]);if(e.children)for(const r of e.children)t=Math.max(t,vT(r));return t}function bT(e,t,r){if(e.meshes)for(const o of e.meshes){if(o.aabb.min[0]===1/0)continue;const s=wc.applyTransform(o.aabb,e.globalMatrix);r.insert(t,s.min[0],s.min[1],s.max[0],s.max[1])}if(e.children)for(const o of e.children)bT(o,t,r)}const wT=["","wall","door","roof","window","lamp","logo"];class Gb{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:vT(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new wc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const t=new wc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const r of this.node.meshes)this.node.lightMeshIndex!==e&&(r.transformedAabb=wc.applyTransformFast(r.aabb,this.node.globalMatrix),t.encapsulate(r.transformedAabb)),e++;this.aabb=t}return this.aabb}}class $b{constructor(e,t,r,o,s,l,c,h){this.id=r,this.layers=e,this.layerIds=this.layers.map((e=>e.fqid)),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.modelTraits|=Ly.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,o&&(this.modelTraits|=Ly.HasMapboxMeshFeatures),s&&(this.modelTraits|=Ly.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=l,this.worldview=h,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const e of t)this.nodesInfo.push(new Gb(e)),bT(e,c.featureIndexArray.length,c.grid),c.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,c.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,t){for(const r of this.getNodesInfo()){const o=r.node;o.footprint&&t.push({footprint:o.footprint,id:e})}}updateAppearances(e,t,r,o){}update(e){const t=0!==Object.keys(e).length;if(t&&!this.stateDependentLayers.length)return;const r=t?this.stateDependentLayers:this.layers;if(!Qe(e,this.states))for(const t of r)this.evaluate(t,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const t=this.getNodesInfo();for(const r of t){const t=r.node;this.uploaded?this.updatePbrBuffer(t):ky(t,e,!0)}for(const e of t)Vy(e.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let t=!1;if(!e.meshes)return t;for(const r of e.meshes)r.pbrBuffer&&(r.pbrBuffer.updateData(r.featureArray),t=!0);return t}needsReEvaluation(e,t,r){const o=e.transform.projectionOptions,s=e.style.getBrightness(),l=this.brightness!==s;if(!this.uploaded||this.dirty||o.name!==this.projection.name||TT(r.paint.get("model-color").value,l)||TT(r.paint.get("model-color-mix-intensity").value,l)||TT(r.paint.get("model-roughness").value,l)||TT(r.paint.get("model-emissive-strength").value,l)||TT(r.paint.get("model-height-based-emissive-strength-multiplier").value,l)){this.projection=o,this.brightness=s;const e=this.getNodesInfo();for(const t of e)t.state=null;return!0}return!1}evaluateTransform(e,t){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const r=this.getNodesInfo(),o=this.id.canonical;for(const e of r){const r=e.feature;e.evaluatedTranslation=t.paint.get("model-translation").evaluate(r,{},o),e.evaluatedScale=t.paint.get("model-scale").evaluate(r,{},o)}}evaluate(e,t){const r=this.getNodesInfo();for(const o of r){if(!o.node.meshes)continue;const r=o.feature,s=t&&t[r.id];if(Qe(s,o.state))continue;o.state=structuredClone(s);const l=o.node.meshes&&o.node.meshes[0].featureData,c=o.evaluatedColor[2],h=o.evaluatedRMEA[2],u=this.id.canonical;if(o.hasTranslucentParts=!1,l){for(let t=0;t<wT.length;t++){const l=wT[t];l.length&&(r.properties.part=l);const c=e.paint.get("model-color").evaluate(r,s,u).toPremultipliedRenderColor(null),h=e.paint.get("model-color-mix-intensity").evaluate(r,s,u);o.evaluatedColor[t]=[c.r,c.g,c.b,h],o.evaluatedRMEA[t][0]=e.paint.get("model-roughness").evaluate(r,s,u),o.evaluatedRMEA[t][2]=e.paint.get("model-emissive-strength").evaluate(r,s,u),o.evaluatedRMEA[t][3]=c.a,o.emissionHeightBasedParams[t]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(r,s,u),!o.hasTranslucentParts&&c.a<1&&(o.hasTranslucentParts=!0)}delete r.properties.part,IT(o,c!==o.evaluatedColor[2]||h!==o.evaluatedRMEA[2],this.modelTraits)}else o.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(r,s,u);o.evaluatedTranslation=e.paint.get("model-translation").evaluate(r,s,u),o.evaluatedScale=e.paint.get("model-scale").evaluate(r,s,u),this.updatePbrBuffer(o.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,t,r,o){const s=e.findDEMTileFor(r);if(s&&(s.tileID.canonical!==this.terrainTile||t!==this.terrainExaggeration)){if(s.dem&&s.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=s.tileID.overscaledZ;const t=Rb.create(e,r,s);if(!t)return;this.modelTraits&Ly.HasMapboxMeshFeatures&&this.updateDEM(e,t,r,o);for(const e of this.getNodesInfo()){const r=e.node;if(!r.footprint||!r.footprint.vertices||!r.footprint.vertices.length)continue;const o=r.footprint.vertices;let s=t.getElevationAt(o[0].x,o[0].y,!0,!0);for(let e=1;e<o.length;e++)s=Math.min(s,t.getElevationAt(o[e].x,o[e].y,!0,!0));r.elevation=s}}this.terrainTile=s.tileID.canonical,this.terrainExaggeration=t}}updateDEM(e,t,r,o){let s=t._dem._modifiedForSources[o];if(void 0===s&&(t._dem._modifiedForSources[o]=[],s=t._dem._modifiedForSources[o]),s.includes(r.canonical))return;const l=t._dem.dim;s.push(r.canonical);let c=!1;for(const e of this.getNodesInfo()){const r=e.node;if(!r.footprint||!r.footprint.grid)continue;const o=r.footprint.grid,s=t.tileCoordToPixel(o.min.x,o.min.y),h=t.tileCoordToPixel(o.max.x,o.max.y),u=Math.min(Math.min(l-h.y,s.x),Math.min(s.y,l-h.x));if(u<0)continue;const d=ct(u,2,5);let p=Math.max(0,s.x-d),f=Math.max(0,s.y-d),m=Math.min(h.x+d,l-1),_=Math.min(h.y+d,l-1);for(let e=f;e<=_;++e)for(let t=p;t<=m;++t)xT[e*l+t]=255;let v=0,E=0;for(let e=0;e<o.cellsY;++e)for(let r=0;r<o.cellsX;++r){if(!o.cells[e*o.cellsX+r])continue;const s=t.tileCoordToPixel(o.min.x+r/o.xScale,o.min.y+e/o.yScale),c=t.tileCoordToPixel(o.min.x+(r+1)/o.xScale,o.min.y+(e+1)/o.yScale);for(let e=s.y;e<=Math.min(c.y+1,l-1);++e)for(let r=s.x;r<=Math.min(c.x+1,l-1);++r)255===xT[e*l+r]&&(xT[e*l+r]=0,v+=t.getElevationAtPixel(r,e),E++)}const P=v/E;p=Math.max(1,s.x-d),f=Math.max(1,s.y-d),m=Math.min(h.x+d,l-2),_=Math.min(h.y+d,l-2),c=!0;for(let e=f;e<=_;++e)for(let r=p;r<=m;++r)0===xT[e*l+r]&&(yT[e*l+r]=t._dem.set(r,e,P));for(let e=1;e<d;++e){p=Math.max(1,s.x-e),f=Math.max(1,s.y-e),m=Math.min(h.x+e,l-2),_=Math.min(h.y+e,l-2);for(let r=f;r<=_;++r)for(let o=p;o<=m;++o){const s=r*l+o;if(255===xT[s]){let c=0,h=0,u=-1,p=-1;for(let t=-1;t<=1;++t)for(let s=-1;s<=1;++s){const d=(r+t)*l+o+s;if(xT[d]>=e)continue;const f=yT[d],m=Math.abs(f);m>h&&(c=f,h=m,u=s,p=t)}if(h>.1){const l=1-(e+.5*Math.abs(u*p))/d;let h=t._dem.get(o,r)+c*l;const f=t._dem.get(o+u,r+p),m=t._dem.get(o-u,r-p,!0);(h-f)*(h-m)>0&&(h=(f+m)/2),yT[s]=t._dem.set(o,r,h),xT[s]=e}}}}}c&&(t._demTile.needsDEMTextureUpload=!0,t._dem._timestamp=ri.now())}setFilter(e){this.filter=e?xu(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new Ja(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const t of e)Vy(t.node),Uy(t.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,t){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const r=t.getReplacementRegionsForTile(e.toUnwrapped());for(const e of this.getNodesInfo()){const t=e.node.footprint;e.hiddenByReplacement=!!t&&!r.find((e=>e.footprint===t))}}getHeightAtTileCoord(e,t){const r=[],o=[0,0,0],s=p([]);for(const l of this.getNodesInfo()){const c=l.node.meshes[0],h=c.transformedAabb;if(e<h.min[0]||t<h.min[1]||e>h.max[0]||t>h.max[1])continue;if(!0===l.node.hidden)return{height:1/0,maxHeight:l.feature.properties.height,hidden:!1,verticalScale:l.evaluatedScale[2]};f(s,l.node.globalMatrix),o[0]=e,o[1]=t,se(o,o,s);const u=(o[0]-c.aabb.min[0])/(c.aabb.max[0]-c.aabb.min[0])*zy|0,d=Math.min(63,(o[1]-c.aabb.min[1])/(c.aabb.max[1]-c.aabb.min[1])*zy|0)*zy+Math.min(63,u),p=c.heightmap[d];if(!(p<0&&l.node.footprint)){if(l.hiddenByReplacement)return;return{height:p,maxHeight:l.feature.properties.height,hidden:!1,verticalScale:l.evaluatedScale[2]}}if(l.node.footprint.grid.query(new Je(e,t),new Je(e,t),r),r.length>0)return{height:void 0,maxHeight:l.feature.properties.height,hidden:l.hiddenByReplacement,verticalScale:l.evaluatedScale[2]}}}}function TT(e,t){return e instanceof Gs&&!e.isLightConstant&&t}function ST(e,t,r,o,s,l,c,h){let u=(61440&t|(61440&t)>>4)>>8,d=(3840&t|(3840&t)>>4)>>4,p=240&t|(240&t)>>4;r[3]>0&&(u=Ar(u,255*r[0],r[3]),d=Ar(d,255*r[1],r[3]),p=Ar(p,255*r[2],r[3]));const f=u<<8|d,m=p<<8|Math.floor(255*o[3]),_=function(e){const t=ct(e,0,2);return Math.min(Math.round(.5*t*255),255)}(o[2])<<8|15*o[0]<<4|15*o[1],v=ct(s[0],0,1),E=ct(s[1],0,1),P=ct(s[2],0,1),C=ct(s[3],0,1);let R,z,D,O;if(v!==E&&c!==l&&E!==v){const e=c-l;z=1/(e*(E-v)),D=-(l+e*v)/(e*(E-v));const t=ct(s[4],-1,1);O=Math.pow(10,t),R=255*P<<8|255*C}else R=65535,z=0,D=1,O=1;if(e.emplaceBack(f,m,_,R,z,D,O),h){const e=h.length;h.clear();for(let t=0;t<e;t++)h.emplaceBack(f,m,_,R,z,D,O)}}function IT(e,t,r){const o=e.node;let s=0;const l=r&Ly.HasMeshoptCompression;for(const r of o.meshes){if(o.lights&&o.lightMeshIndex===s)continue;if(!r.featureData)continue;r.featureArray=new bl,r.featureArray.reserve(r.featureData.length);let c=t;for(const t of r.featureData){const s=l?65535&t:t>>16&65535,h=l?t>>16&65535:65535&t,u=(15&h)<8?15&h:0,d=e.evaluatedRMEA[u],p=e.evaluatedColor[u],f=e.emissionHeightBasedParams[u];let m;if(c&&2===u&&o.lights&&(m=new bl,m.resize(10*o.lights.length)),ST(r.featureArray,s,p,d,f,r.aabb.min[2],r.aabb.max[2],m),m&&c){c=!1;const e=o.meshes[o.lightMeshIndex];e.featureArray=m,e.featureArray._trim()}}r.featureArray._trim(),s++}}ih($b,"Tiled3dModelBucket",{omit:["layers"]}),ih(Gb,"Tiled3dModelFeature");const ET=["id","tile","layer","source","sourceLayer","state"];class Wb{constructor(e,t,r,o,s){this.type="Feature",this._vectorTileFeature=e,this._z=t,this._x=r,this._y=o,this.properties=e?e.properties:{},this.id=s}clone(){const e=new Wb(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return void 0===this._geometry&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const t of ET)void 0!==this[t]&&(e[t]=this[t]);return e}}class Yb extends ir{constructor(e,t,r,o){super(),this.id=e,this.type="model",this.models=[],this._options=t,this._modelsInfo=new Map}loadGLTFFromURI(e){return hy(this.map._requestManager.transformRequest(e,Li.Model).url)}load(){for(const e in this._options.models){const t=this._options.models[e],r=this._modelsInfo.get(e);if(r){r.modelSpec=t;const e=r.model;e&&(e.position=null!=t.position?new Bu(t.position[0],t.position[1]):new Bu(0,0),e.orientation=null!=t.orientation?t.orientation:[0,0,0],Yb.applyModelSpecification(e,t),e.computeBoundsAndApplyParent(),this.models.push(e))}else this._modelsInfo.set(e,{modelSpec:t,model:null}),this.loadGLTFFromURI(t.uri).then((t=>{if(!t)return;const r=this._modelsInfo.get(e);if(!r)return;const o=Yy(t),s=r.modelSpec,l=new iy(e,s.uri,s.position,s.orientation,o);Yb.applyModelSpecification(l,s),l.computeBoundsAndApplyParent(),this.models.push(l),r.model=l,this.loaded()&&this.fire(new tr("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((r=>{this.fire(new er(new Error(`Could not load model ${e} from ${t.uri}: ${r.message}`)))}))}this.loaded()&&this.fire(new tr("data",{dataType:"source",sourceDataType:"metadata"}))}static applyModelSpecification(e,t){t.nodeOverrides&&Yb.convertNodeOverrides(e,t.nodeOverrides),t.materialOverrides&&Yb.convertMaterialOverrides(e,t.materialOverrides),t.nodeOverrideNames&&(e.nodeOverrideNames=[...t.nodeOverrideNames]),t.materialOverrideNames&&(e.materialOverrideNames=[...t.materialOverrideNames]),t.featureProperties&&(e.featureProperties=t.featureProperties)}static convertNodeOverrides(e,t){if(Array.isArray(t)&&t.every((e=>"string"==typeof e))){e.nodeOverrideNames=[];for(const r of t)e.nodeOverrideNames.push(r)}else Object.entries(t).forEach((([t,r])=>{const o={orientation:[0,0,0]};if(r.hasOwnProperty("orientation")){const e=r.orientation;e&&(o.orientation=e)}e.nodeOverrides.set(t,o)}))}static convertMaterialOverrides(e,t){if(Array.isArray(t)&&t.every((e=>"string"==typeof e))){e.materialOverrideNames=[];for(const r of t)e.materialOverrideNames.push(r)}else Object.entries(t).forEach((([t,r])=>{const o={color:new ur(1,1,1),colorMix:0,emissionStrength:0,opacity:1},s=r["model-color"];void 0!==s&&(o.color.r=s[0],o.color.g=s[1],o.color.b=s[2]);const l=r["model-color-mix-intensity"];void 0!==l&&(o.colorMix=l);const c=r["model-emissive-strength"];void 0!==c&&(o.emissionStrength=c);const h=r["model-opacity"];void 0!==h&&(o.opacity=h),e.materialOverrides.set(t,o)}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){if(0===this._modelsInfo.size)return!0;for(const e of this._modelsInfo.values())if(null==e.model)return!1;return!0}getModels(){return this.models}loadTile(e,t){}serialize(){return this._options}setProperty(e,t){return!1}reload(){const e=zu(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this.load()}setModels(e){this.models=[];const t=new Map;for(const r in e){const o=e[r];if(this._modelsInfo.has(r)){const e=this._modelsInfo.get(r);e&&e.modelSpec.uri===o.uri&&t.set(r,e)}}this._modelsInfo=t,this._options.models=e,this.load()}}function AT(e,t,r,o){const s=1<<e.z;t.lat=Cd((o/Ao+e.y)/s),t.lng=Pd((r/Ao+e.x)/s)}function MT(e,t,r,o){const s=e.getNodesInfo()[t];if(!s||s.hiddenByReplacement||!s.node.meshes)return;let l=Number.MAX_VALUE;const c=s.node,h=r.tile,u=o.calculatePosMatrix(h.tileID.toUnwrapped(),o.worldSize),d=s.evaluatedScale;let p=0;o.elevation&&c.elevation&&(p=c.elevation*o.elevation.exaggeration()),_(u,u,[(c.anchor?c.anchor[0]:0)*(d[0]-1),(c.anchor?c.anchor[1]:0)*(d[1]-1),p]),v(u,u,d);const f=r.queryGeometry,E=f.isPointQuery()?f.screenBounds:f.screenGeometry,P=function(e){const t=m([],u,e.globalMatrix);m(t,o.expandedFarZProjMatrix,t);for(let r=0;r<e.meshes.length;++r){const s=e.meshes[r];if(r===e.lightMeshIndex)continue;const c=Py(E,o,t,s.aabb);null!=c&&(l=Math.min(c,l))}if(e.children)for(const t of e.children)P(t)};if(P(c),l===Number.MAX_VALUE)return;const C=new Bu(0,0);return AT(h.tileID.canonical,C,s.node.anchor[0],s.node.anchor[1]),{intersectionZ:l,position:C,feature:s.feature}}const PT={circle:class extends Fo{constructor(e,t,r,o){super(e,{layout:Ip||(Ip=new uo({"circle-sort-key":new oo(mu.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ao(mu.layout_circle["circle-elevation-reference"]),visibility:new ao(mu.layout_circle.visibility)})),paint:Ep||(Ep=new uo({"circle-radius":new oo(mu.paint_circle["circle-radius"]),"circle-color":new oo(mu.paint_circle["circle-color"]),"circle-blur":new oo(mu.paint_circle["circle-blur"]),"circle-opacity":new oo(mu.paint_circle["circle-opacity"]),"circle-translate":new ao(mu.paint_circle["circle-translate"]),"circle-translate-anchor":new ao(mu.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ao(mu.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ao(mu.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new oo(mu.paint_circle["circle-stroke-width"]),"circle-stroke-color":new oo(mu.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new oo(mu.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ao(mu.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o)}createBucket(e){return new Sc(e)}queryRadius(e){const t=e;return vp("circle-radius",this,t)+vp("circle-stroke-width",this,t)+bp(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,r,o,s,l,c,h){const u=Sp(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),d=this.paint.get("circle-radius").evaluate(t,r)+this.paint.get("circle-stroke-width").evaluate(t,r);return _f(e,o,l,c,h,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),u,d)}getProgramIds(){return["circle"]}getDefaultProgramParams(e,t,r){const o=pf(this);return{config:new du(this,{zoom:t,lut:r}),defines:o,overrideFog:!1}}is3D(e){return!e&&!!this.layout&&"none"!==this.layout.get("circle-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("circle-elevation-reference")}},heatmap:class extends Fo{createBucket(e){return new Rh(e)}constructor(e,t,r,o){super(e,{layout:bf||(bf=new uo({visibility:new ao(mu.layout_heatmap.visibility)})),paint:wf||(wf=new uo({"heatmap-radius":new oo(mu.paint_heatmap["heatmap-radius"]),"heatmap-weight":new oo(mu.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ao(mu.paint_heatmap["heatmap-intensity"]),"heatmap-color":new lo(mu.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ao(mu.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Mf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(e){return vp("heatmap-radius",this,e)}queryIntersectsFeature(e,t,r,o,s,l,c,h){const u=this.paint.get("heatmap-radius").evaluate(t,r);return _f(e,o,l,c,h,!0,!0,new Je(0,0),u)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(e,t,r){return"heatmap"===e?{config:new du(this,{zoom:t,lut:r}),overrideFog:!1}:{}}},hillshade:class extends Fo{constructor(e,t,r,o){super(e,{layout:Tf||(Tf=new uo({visibility:new ao(mu.layout_hillshade.visibility)})),paint:Sf||(Sf=new uo({"hillshade-illumination-direction":new ao(mu.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ao(mu.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ao(mu.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ao(mu.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ao(mu.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ao(mu.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ao(mu.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(e,t,r){return{overrideFog:!1}}},fill:class extends Fo{constructor(e,t,r,o){super(e,{layout:i_||(i_=new uo({"fill-sort-key":new oo(mu.layout_fill["fill-sort-key"]),visibility:new ao(mu.layout_fill.visibility),"fill-elevation-reference":new ao(mu.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new oo(mu.layout_fill["fill-construct-bridge-guard-rail"])})),paint:n_||(n_=new uo({"fill-antialias":new ao(mu.paint_fill["fill-antialias"]),"fill-opacity":new oo(mu.paint_fill["fill-opacity"]),"fill-color":new oo(mu.paint_fill["fill-color"]),"fill-outline-color":new oo(mu.paint_fill["fill-outline-color"]),"fill-translate":new ao(mu.paint_fill["fill-translate"]),"fill-translate-anchor":new ao(mu.paint_fill["fill-translate-anchor"]),"fill-pattern":new oo(mu.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new ao(mu.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new ao(mu.paint_fill["fill-emissive-strength"]),"fill-z-offset":new oo(mu.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new oo(mu.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new oo(mu.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),r=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getDefaultProgramParams(e,t,r){return{config:new du(this,{zoom:t,lut:r}),overrideFog:!1}}recalculate(e,t){super.recalculate(e,t);const r=this.paint._values["fill-outline-color"];"constant"===r.value.kind&&void 0===r.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new vd(e)}queryRadius(){return bp(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,r,o,s,l){return!e.queryGeometry.isAboveHorizon&&sp(wp(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),o)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(e){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const t=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=e?t&&!e:t}hasElevation(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}hasShadowPass(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}},"fill-extrusion":class extends Fo{constructor(e,t,r,o){super(e,{layout:lg||(lg=new uo({visibility:new ao(mu["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ao(mu["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:cg||(cg=new uo({"fill-extrusion-opacity":new ao(mu["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new oo(mu["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ao(mu["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ao(mu["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new oo(mu["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new ao(mu["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new oo(mu["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new oo(mu["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ao(mu["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ao(mu["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ao(mu["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ao(mu["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ao(mu["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ao(mu["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ao(mu["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ao(mu["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ao(mu["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ao(mu["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new oo(mu["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new oo(mu["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ao(mu["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ao(mu["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ao(mu["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ao(mu["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new oo(mu["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new oo(mu["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ao(mu["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new mf(e)}queryRadius(){return bp(this.paint.get("fill-extrusion-translate"))}is3D(e){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(e,t,r,o,s,l,c,h,u){const d=Sp(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),p=this.paint.get("fill-extrusion-height").evaluate(t,r),f=this.paint.get("fill-extrusion-base").evaluate(t,r),m=[0,0],_=h&&l.elevation,v=l.elevation?l.elevation.exaggeration():1,E=e.tile.getBucket(this);if(_&&E instanceof mf){const e=E.centroidVertexArray,t=u+1;t<e.length&&(m[0]=e.geta_centroid_pos0(t),m[1]=e.geta_centroid_pos1(t))}if(0===m[0]&&1===m[1])return!1;"globe"===l.projection.name&&(o=sg([o],[new Je(0,0),new Je(Ao,Ao)],e.tileID.canonical).map((e=>e.polygon)).flat());const P=_?h:null,[C,R]=xg(l,o,f,p,d,c,P,m,v,l.center.lat,e.tileID.canonical),z=e.queryGeometry;return yg(C,R,z.isPointQuery()?z.screenBounds:z.screenGeometry)}},building:class extends Fo{constructor(e,t,r,o){super(e,{layout:_x||(_x=new uo({visibility:new ao(mu.layout_building.visibility),"building-facade":new oo(mu.layout_building["building-facade"]),"building-facade-floors":new oo(mu.layout_building["building-facade-floors"]),"building-facade-unit-width":new oo(mu.layout_building["building-facade-unit-width"]),"building-facade-window":new oo(mu.layout_building["building-facade-window"]),"building-roof-shape":new oo(mu.layout_building["building-roof-shape"]),"building-height":new oo(mu.layout_building["building-height"]),"building-base":new oo(mu.layout_building["building-base"]),"building-flood-light-wall-radius":new oo(mu.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new oo(mu.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new oo(mu.layout_building["building-flip-roof-orientation"])})),paint:gx||(gx=new uo({"building-opacity":new ao(mu.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new ao(mu.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new ao(mu.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new ao(mu.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new ao(mu.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new ao(mu.paint_building["building-vertical-scale"]),"building-cast-shadows":new ao(mu.paint_building["building-cast-shadows"]),"building-color":new oo(mu.paint_building["building-color"]),"building-emissive-strength":new oo(mu.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new ao(mu.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new ao(mu.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new ao(mu.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new ao(mu.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new ao(mu.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new Ry(e)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(e){return!0}queryRadius(e){return 0}queryIntersectsFeature(e,t,r,o,s,l,c,h,u,d){let p=this.layout.get("building-height").evaluate(t,r);const f=this.layout.get("building-base").evaluate(t,r),m=e.tile.getBucket(this).getFootprint(t);if(m){if(0!==m.hiddenFlags)return!1;p=m.height}const[_,v]=xg(l,o,f,p,new Je(0,0),c,null,[0,0],1,l.center.lat,e.tileID.canonical),E=e.queryGeometry;return yg(_,v,E.isPointQuery()?E.screenBounds:E.screenGeometry)}},line:class extends Fo{constructor(e,t,r,o){const s=jx();super(e,s,t,r,o),s.layout&&(this.layout=new so(s.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(e){if("line-gradient"===e){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof zi,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}emissiveStrengthExpression(){return this._transitionablePaint._values["line-emissive-strength"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=(()=>{if(Gx)return Gx;const e=jx();return Gx=new hg(e.paint.properties["line-width"].specification),Gx.useIntegerZoom=!0,Gx})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new Qy(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(e,t,r){const o=kx(this);return{config:new du(this,{zoom:t,lut:r}),defines:o,overrideFog:!1}}queryRadius(e){const t=e,r=$x(vp("line-width",this,t),vp("line-gap-width",this,t)),o=vp("line-offset",this,t);return r/2+Math.abs(o)+bp(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,r,o,s,l){if(e.queryGeometry.isAboveHorizon)return!1;const c=wp(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),h=e.pixelToTileUnitsFactor/2*$x(this.paint.get("line-width").evaluate(t,r),this.paint.get("line-gap-width").evaluate(t,r)),u=this.paint.get("line-offset").evaluate(t,r);return u&&(o=function(e,t){const r=[],o=new Je(0,0);for(let s=0;s<e.length;s++){const l=e[s],c=[];for(let e=0;e<l.length;e++){const r=l[e],s=l[e+1],h=0===e?o:r.sub(l[e-1])._unit()._perp(),u=e===l.length-1?o:s.sub(r)._unit()._perp(),d=h._add(u)._unit();d._mult(1/(d.x*u.x+d.y*u.y)),c.push(d._mult(t)._add(r))}r.push(c)}return r}(o,u*e.pixelToTileUnitsFactor)),function(e,t,r){for(let o=0;o<t.length;o++){const s=t[o];if(e.length>=3)for(let t=0;t<s.length;t++)if(mp(e,s[t]))return!0;if(ap(e,s,r))return!0}return!1}(c,o,h)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(e){return!this.hasElevatedBuckets||this.layout&&"hd-road-markup"===this.layout.get("line-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("line-elevation-reference")}},symbol:lb,background:class extends Fo{constructor(e,t,r,o){super(e,{layout:Qw||(Qw=new uo({visibility:new ao(mu.layout_background.visibility)})),paint:Kw||(Kw=new uo({"background-pitch-alignment":new ao(mu.paint_background["background-pitch-alignment"]),"background-color":new ao(mu.paint_background["background-color"]),"background-pattern":new ao(mu.paint_background["background-pattern"]),"background-opacity":new ao(mu.paint_background["background-opacity"]),"background-emissive-strength":new ao(mu.paint_background["background-emissive-strength"]),"background-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(e,t,r){return{overrideFog:!1}}is3D(e){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:bb,"raster-particle":Sb,sky:class extends Fo{constructor(e,t,r,o){super(e,{layout:hT||(hT=new uo({visibility:new ao(mu.layout_sky.visibility)})),paint:uT||(uT=new uo({"sky-type":new ao(mu.paint_sky["sky-type"]),"sky-atmosphere-sun":new ao(mu.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ao(mu.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ao(mu.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ao(mu.paint_sky["sky-gradient-radius"]),"sky-gradient":new lo(mu.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ao(mu.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ao(mu.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ao(mu.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(e){"sky-gradient"===e?this._updateColorRamp():"sky-atmosphere-sun"!==e&&"sky-atmosphere-halo-color"!==e&&"sky-atmosphere-color"!==e&&"sky-atmosphere-sun-intensity"!==e||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Mf({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if("atmosphere"===this.paint.get("sky-type")){const r=this.paint.get("sky-atmosphere-sun"),o=!r,s=e.style.light,l=s.properties.get("position");return o&&"viewport"===s.properties.get("anchor")&&Et("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),o?pT(l.azimuthal,90-l.polar,t):pT(r[0],90-r[1],t)}const r=this.paint.get("sky-gradient-center");return pT(r[0],90-r[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return"atmosphere"===e?["skyboxCapture","skybox"]:"gradient"===e?["skyboxGradient"]:null}},slot:class extends Fo{constructor(e,t,r,o){super(e,{paint:dT||(dT=new uo({}))},t,null)}},model:class extends Fo{constructor(e,t,r,o){super(e,{layout:_T||(_T=new uo({visibility:new ao(mu.layout_model.visibility),"model-id":new oo(mu.layout_model["model-id"]),"model-allow-density-reduction":new ao(mu.layout_model["model-allow-density-reduction"])})),paint:gT||(gT=new uo({"model-opacity":new oo(mu.paint_model["model-opacity"]),"model-rotation":new oo(mu.paint_model["model-rotation"]),"model-scale":new oo(mu.paint_model["model-scale"]),"model-translation":new oo(mu.paint_model["model-translation"]),"model-color":new oo(mu.paint_model["model-color"]),"model-color-mix-intensity":new oo(mu.paint_model["model-color-mix-intensity"]),"model-type":new ao(mu.paint_model["model-type"]),"model-cast-shadows":new ao(mu.paint_model["model-cast-shadows"]),"model-receive-shadows":new ao(mu.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ao(mu.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new oo(mu.paint_model["model-emissive-strength"]),"model-roughness":new oo(mu.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new oo(mu.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ao(mu.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ao(mu.paint_model["model-front-cutoff"]),"model-elevation-reference":new ao(mu.paint_model["model-elevation-reference"]),"model-color-use-theme":new oo({type:"string",default:"default","property-type":"data-driven"})}))},t,r,o),this.layer=e,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new Fb(e)}getProgramIds(){return["model"]}is3D(e){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(e){return e instanceof $b?8191:0}queryRenderedFeatures(e,t,r){const o=t.getSource();if(!(o&&o instanceof Yb))return{};const s=o,l={};l[this.id]=[];const c=l[this.id];let h=0;for(const o of s.models){const s=t.getFeatureState(this.sourceLayer,o.id),l={type:"Unknown",id:o.id,properties:o.featureProperties},u=this.paint.get("model-rotation").evaluate(l,s),d=this.paint.get("model-scale").evaluate(l,s),p=this.paint.get("model-translation").evaluate(l,s),f=this.paint.get("model-elevation-reference");let _=[];Oy(_,o,r,o.position,u,d,p,"ground"===f,"ground"===f,!1),"globe"===r.projection.name&&(_=My(_,r));const v=m([],r.projMatrix,_),E=Py(e.isPointQuery()?e.screenBounds:e.screenGeometry,r,v,o.aabb);if(null!=E){const e=new Wb(void 0,0,0,0,o.id);e.layer=this.layer,e.properties=structuredClone(o.featureProperties),e.properties.layer=this.id,e.properties.uri=o.uri,e.properties.orientation=o.orientation,e.sourceLayer=this.sourceLayer,e.geometry={type:"Point",coordinates:[o.position.lng,o.position.lat]},e.state=s,e.source=this.source,c.push({featureIndex:h,feature:e,intersectionZ:E})}++h}return l}queryIntersectsFeature(e,t,r,o,s,l,c,h,u,d){if(!this.modelManager)return!1;const p=this.modelManager,f=e.tile.getBucket(this);if(!(f&&f instanceof Fb))return!1;for(const r in f.instancesPerModel){const o=f.instancesPerModel[r],s=void 0!==t.id?t.id:t.properties&&t.properties.hasOwnProperty("id")?t.properties.id:void 0;if(o.idToFeaturesIndex.hasOwnProperty(s)){const t=o.features[o.idToFeaturesIndex[s]],c=p.getModel(r,d||this.scope);if(!c)return!1;let h=[];const u=new Bu(0,0),_=f.canonical;let v=Number.MAX_VALUE;for(let r=0;r<t.instancedDataCount;++r){const s=16*(t.instancedDataOffset+r),d=o.instancedDataArray.float32,p=[d[s+4],d[s+5],d[s+6]];AT(_,u,Math.floor(d[s]),Math.floor(d[s+1])),Oy(h,c,l,u,t.rotation,t.scale,p,!1,!1,!1),"globe"===l.projection.name&&(h=My(h,l));const f=m([],l.projMatrix,h),E=e.queryGeometry,P=Py(E.isPointQuery()?E.screenBounds:E.screenGeometry,l,f,c.aabb);null!=P&&(v=Math.min(P,v))}return v!==Number.MAX_VALUE&&v}}return!1}_handleOverridablePaintPropertyUpdate(e,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven()||"model-color"!==e&&"model-color-mix-intensity"!==e&&"model-rotation"!==e&&"model-scale"!==e&&"model-translation"!==e&&"model-emissive-strength"!==e)}_isPropertyZoomDependent(e){const t=this._transitionablePaint._values[e];return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof $s}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Fo{constructor(e,t,r,o){super(e,{layout:o_||(o_=new uo({"clip-layer-types":new ao(mu.layout_clip["clip-layer-types"]),"clip-layer-scope":new ao(mu.layout_clip["clip-layer-scope"]),visibility:new ao(mu.layout_clip.visibility)})),paint:s_||(s_=new uo({}))},t,r,o)}recalculate(e,t){super.recalculate(e,t)}createBucket(e){return new Sd(e)}is3D(e){return!0}}},CT=new ur(0,0,0);function RT(e,t,r){1===e&&t.icons.push(function(e,t){return function(e){if(e.usvg_tree.height||(e.usvg_tree.height=e.usvg_tree.width),!e.metadata)return e;const{metadata:t}=e;if(t.content_area){const{content_area:r}=t;null==r.left&&(r.left=0),null==r.top&&(r.top=r.left),null==r.width&&(r.width=e.usvg_tree.width),null==r.height&&(r.height=r.width)}if(t.text_placeholder){const{text_placeholder:e}=t;null==e.top&&(e.top=e.left),null==e.height&&(e.height=e.width)}return t.stretch_x&&t.stretch_x.length&&zT(t,"x"),t.stretch_y&&t.stretch_y.length&&zT(t,"y"),e}(e.readFields(DT,{name:void 0},t))}(r,r.readVarint()+r.pos))}function zT(e,t){const r=[],o=e[`stretch_${t}`];let s=null;for(let e=0;e<o.length;e++)null===s?s=0===r.length?o[0]:r[r.length-1][1]+o[e]:(r.push([s,s+o[e]]),s=null);e[`stretch_${t}_areas`]=r}function DT(e,t,r){1===e?t.name=r.readString():2===e?t.metadata=function(e,t){return e.readFields(LT,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},t)}(r,r.readVarint()+r.pos):3===e&&(t.usvg_tree=function(e,t){return e.readFields(kT,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},t)}(r,r.readVarint()+r.pos),t.data="usvg_tree")}function LT(e,t,r){1===e?t.stretch_x=r.readPackedVarint():2===e?t.stretch_y=r.readPackedVarint():3===e?t.content_area=OT(r,r.readVarint()+r.pos):4===e?t.variables.push(function(e,t){return e.readFields(BT,{name:void 0},t)}(r,r.readVarint()+r.pos)):5===e&&(t.text_placeholder=OT(r,r.readVarint()+r.pos))}function OT(e,t){return e.readFields(FT,{},t)}function FT(e,t,r){1===e?t.left=r.readVarint():2===e?t.width=r.readVarint():3===e?t.top=r.readVarint():4===e&&(t.height=r.readVarint())}function BT(e,t,r){1===e?t.name=r.readString():2===e&&(t.rgb_color=HT(r.readVarint()),t.value="rgb_color")}function kT(e,t,r){1===e?t.width=t.height=r.readVarint():2===e?t.height=r.readVarint():3===e?t.children.push(VT(r,r.readVarint()+r.pos)):4===e?t.linear_gradients.push(function(e,t){return e.readFields(ZT,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},t)}(r,r.readVarint()+r.pos)):5===e?t.radial_gradients.push(function(e,t){return e.readFields(JT,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},t)}(r,r.readVarint()+r.pos)):7===e?t.clip_paths.push(function(e,t){return e.readFields(QT,{children:[]},t)}(r,r.readVarint()+r.pos)):8===e&&t.masks.push(function(e,t){const r=e.readFields(KT,{left:0,width:20,mask_type:1,children:[]},t);return null==r.height&&(r.height=r.width),null==r.top&&(r.top=r.left),r}(r,r.readVarint()+r.pos))}function VT(e,t){return e.readFields(NT,{},t)}function NT(e,t,r){1===e?(t.group=function(e,t){return e.readFields(UT,{opacity:255,children:[]},t)}(r,r.readVarint()+r.pos),t.node="group"):2===e&&(t.path=function(e,t){return e.readFields($T,{paint_order:1,commands:[],step:1,diffs:[],rule:1},t)}(r,r.readVarint()+r.pos),t.node="path")}function UT(e,t,r){1===e?t.transform=jT(r,r.readVarint()+r.pos):2===e?t.opacity=r.readVarint():5===e?t.clip_path_idx=r.readVarint():6===e?t.mask_idx=r.readVarint():7===e&&t.children.push(VT(r,r.readVarint()+r.pos))}function jT(e,t){return e.readFields(GT,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},t)}function GT(e,t,r){1===e?t.sx=r.readFloat():2===e?t.ky=r.readFloat():3===e?t.kx=r.readFloat():4===e?t.sy=r.readFloat():5===e?t.tx=r.readFloat():6===e&&(t.ty=r.readFloat())}function $T(e,t,r){1===e?t.fill=function(e,t){return e.readFields(qT,{rgb_color:CT,paint:"rgb_color",opacity:255},t)}(r,r.readVarint()+r.pos):2===e?t.stroke=function(e,t){return e.readFields(WT,{rgb_color:CT,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},t)}(r,r.readVarint()+r.pos):3===e?t.paint_order=r.readVarint():5===e?r.readPackedVarint(t.commands):6===e?t.step=r.readFloat():7===e?r.readPackedSVarint(t.diffs):8===e&&(t.rule=r.readVarint())}function qT(e,t,r){1===e?(t.rgb_color=HT(r.readVarint()),t.paint="rgb_color"):2===e?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):3===e?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):5===e&&(t.opacity=r.readVarint())}function HT(e){return new ur((e>>16&255)/255,(e>>8&255)/255,(255&e)/255,1)}function WT(e,t,r){1===e?(t.rgb_color=HT(r.readVarint()),t.paint="rgb_color"):2===e?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):3===e?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):5===e?r.readPackedFloat(t.dasharray):6===e?t.dashoffset=r.readFloat():7===e?t.miterlimit=r.readFloat():8===e?t.opacity=r.readVarint():9===e?t.width=r.readFloat():10===e?t.linecap=r.readVarint():11===e&&(t.linejoin=r.readVarint())}function ZT(e,t,r){1===e?t.transform=jT(r,r.readVarint()+r.pos):2===e?t.spread_method=r.readVarint():3===e?t.stops.push(XT(r,r.readVarint()+r.pos)):4===e?t.x1=r.readFloat():5===e?t.y1=r.readFloat():6===e?t.x2=r.readFloat():7===e&&(t.y2=r.readFloat())}function XT(e,t){return e.readFields(YT,{offset:0,opacity:255,rgb_color:CT},t)}function YT(e,t,r){1===e?t.offset=r.readFloat():2===e?t.opacity=r.readVarint():3===e&&(t.rgb_color=HT(r.readVarint()))}function JT(e,t,r){1===e?t.transform=jT(r,r.readVarint()+r.pos):2===e?t.spread_method=r.readVarint():3===e?t.stops.push(XT(r,r.readVarint()+r.pos)):4===e?t.cx=r.readFloat():5===e?t.cy=r.readFloat():6===e?t.r=r.readFloat():7===e?t.fx=r.readFloat():8===e?t.fy=r.readFloat():9===e&&(t.fr=r.readFloat())}function QT(e,t,r){1===e?t.transform=jT(r,r.readVarint()+r.pos):2===e?t.clip_path_idx=r.readVarint():3===e&&t.children.push(VT(r,r.readVarint()+r.pos))}function KT(e,t,r){1===e?t.left=t.top=r.readFloat():2===e?t.width=t.height=r.readFloat():3===e?t.top=r.readFloat():4===e?t.height=r.readFloat():5===e?t.mask_type=r.readVarint():6===e?t.mask_idx=r.readVarint():7===e&&t.children.push(VT(r,r.readVarint()+r.pos))}class Mw{static calculate(e={},t=[]){const r=new Map,o=new Map;if(0===Object.keys(e).length)return r;t.forEach((e=>{o.set(e.name,e.rgb_color||new ur(0,0,0))}));for(const[t,s]of Object.entries(e))o.has(t)?r.set(o.get(t).toString(),s):console.warn(`Ignoring unknown image variable "${t}"`);return r}}function eS(e,t=255,r){const o=t/255,s=e.toString(),l=r.has(s)?r.get(s).clone():e.clone();return l.a*=o,l.toString()}function tS(e,t){if(!ii()){const r=document.createElement("canvas");return r.width=e,r.height=t,r}return new OffscreenCanvas(e,t)}let iS,rS=null;function nS(e,t,r,o,s){for(const l of o.children)oS(e,t,r,l,s)}function oS(e,t,r,o,s){o.group?(e.save(),function(e,t,r,o,s){const l=null!=o.mask_idx?r.masks[o.mask_idx]:null,c=null!=o.clip_path_idx?r.clip_paths[o.clip_path_idx]:null;if(o.transform&&(t=fS(o.transform).preMultiplySelf(t)),!function(e,t,r){return 255!==e.opacity||t||r}(o,null!=c,null!=l))return void nS(e,t,r,o,s);const h=tS(e.canvas.width,e.canvas.height),u=h.getContext("2d");nS(u,t,r,o,s),c&&dS(u,t,r,c),l&&pS(u,t,r,l,s),e.globalAlpha=o.opacity/255,e.drawImage(h,0,0)}(e,t,r,o.group,s),e.restore()):o.path&&(e.save(),function(e,t,r,o,s){e.setTransform(t),1===o.paint_order?(sS(e,r,o,s),lS(e,r,o,s)):(lS(e,r,o,s),sS(e,r,o,s))}(e,t,r,o.path,s),e.restore())}function sS(e,t,r,o){const s=r.fill;if(!s)return;const l=s.opacity/255;switch(e.save(),e.beginPath(),mS(r,e),s.paint){case"rgb_color":e.fillStyle=eS(s.rgb_color,s.opacity,o);break;case"linear_gradient_idx":{const r=t.linear_gradients[s.linear_gradient_idx];r.transform&&e.setTransform(fS(r.transform).preMultiplySelf(e.getTransform())),e.fillStyle=cS(e,r,l,o);break}case"radial_gradient_idx":{const r=t.radial_gradients[s.radial_gradient_idx];r.transform&&e.setTransform(fS(r.transform).preMultiplySelf(e.getTransform())),e.fillStyle=hS(e,r,l,o)}}e.fill(aS(r)),e.restore()}function aS(e){return 1===e.rule?"nonzero":2===e.rule?"evenodd":void 0}function lS(e,t,r,o){const s=r.stroke;if(!s)return;const l=_S(r);e.lineWidth=s.width,e.miterLimit=s.miterlimit,e.setLineDash(s.dasharray),e.lineDashOffset=s.dashoffset;const c=s.opacity/255;switch(s.paint){case"rgb_color":e.strokeStyle=eS(s.rgb_color,s.opacity,o);break;case"linear_gradient_idx":e.strokeStyle=cS(e,t.linear_gradients[s.linear_gradient_idx],c,o,!0);break;case"radial_gradient_idx":e.strokeStyle=hS(e,t.radial_gradients[s.radial_gradient_idx],c,o,!0)}switch(s.linejoin){case 2:case 1:e.lineJoin="miter";break;case 3:e.lineJoin="round";break;case 4:e.lineJoin="bevel"}switch(s.linecap){case 1:e.lineCap="butt";break;case 2:e.lineCap="round";break;case 3:e.lineCap="square"}e.stroke(l)}function cS(e,t,r,o,s=!1){if(1===t.stops.length){const e=t.stops[0];return eS(e.rgb_color,e.opacity*r,o)}const{x1:l,y1:c,x2:h,y2:u}=t;let d=new DOMPoint(l,c),p=new DOMPoint(h,u);if(s){const e=fS(t.transform);d=e.transformPoint(d),p=e.transformPoint(p)}const f=e.createLinearGradient(d.x,d.y,p.x,p.y);for(const e of t.stops)f.addColorStop(e.offset,eS(e.rgb_color,e.opacity*r,o));return f}function hS(e,t,r,o,s=!1){if(1===t.stops.length){const e=t.stops[0];return eS(e.rgb_color,e.opacity*r,o)}const l=fS(t.transform),{fx:c,fy:h,fr:u,cx:d,cy:p,r:f}=t;let m=new DOMPoint(c,h),_=new DOMPoint(d,p),v=u,E=f;if(s){m=l.transformPoint(m),_=l.transformPoint(_);const e=(l.a+l.d)/2;v=u*e,E=t.r*e}const P=e.createRadialGradient(m.x,m.y,v,_.x,_.y,E);for(const e of t.stops)P.addColorStop(e.offset,eS(e.rgb_color,e.opacity*r,o));return P}function uS(e,t,r,o){const s=o.transform?fS(o.transform).preMultiplySelf(t):t,l=tS(e.canvas.width,e.canvas.height),c=l.getContext("2d");for(const e of o.children)if(e.group)uS(c,s,r,e.group);else if(e.path){const t=e.path,r=new Path2D;r.addPath(_S(t),s),c.fill(r,aS(t))}const h=null!=o.clip_path_idx?r.clip_paths[o.clip_path_idx]:null;h&&dS(c,s,r,h),e.globalCompositeOperation="source-over",e.drawImage(l,0,0)}function dS(e,t,r,o){const s=tS(e.canvas.width,e.canvas.height);uS(s.getContext("2d"),t,r,o),e.globalCompositeOperation="destination-in",e.drawImage(s,0,0)}function pS(e,t,r,o,s){if(0===o.children.length)return;const l=null!=o.mask_idx?r.masks[o.mask_idx]:null;l&&pS(e,t,r,l,s);const c=e.canvas.width,h=e.canvas.height,u=tS(c,h),d=u.getContext("2d"),p=o.width,f=o.height,m=o.left,_=o.top,v=new Path2D,E=new Path2D;E.rect(m,_,p,f),v.addPath(E,t),d.clip(v);for(const e of o.children)oS(d,t,r,e,s);const P=d.getImageData(0,0,c,h),C=P.data;if(1===o.mask_type)for(let e=0;e<C.length;e+=4)C[e+3]=C[e+3]/255*(.2126*C[e]+.7152*C[e+1]+.0722*C[e+2]);d.putImageData(P,0,0),e.globalCompositeOperation="destination-in",e.drawImage(u,0,0)}function fS(e){return e?new DOMMatrix([e.sx,e.ky,e.kx,e.sy,e.tx,e.ty]):new DOMMatrix}function mS(e,t){const r=e.step;let o=e.diffs[0]*r,s=e.diffs[1]*r;t.moveTo(o,s);for(let l=0,c=2;l<e.commands.length;l++)switch(e.commands[l]){case 1:o+=e.diffs[c++]*r,s+=e.diffs[c++]*r,t.moveTo(o,s);break;case 2:o+=e.diffs[c++]*r,s+=e.diffs[c++]*r,t.lineTo(o,s);break;case 3:{const l=o+e.diffs[c++]*r,h=s+e.diffs[c++]*r;o=l+e.diffs[c++]*r,s=h+e.diffs[c++]*r,t.quadraticCurveTo(l,h,o,s);break}case 4:{const l=o+e.diffs[c++]*r,h=s+e.diffs[c++]*r,u=l+e.diffs[c++]*r,d=h+e.diffs[c++]*r;o=u+e.diffs[c++]*r,s=d+e.diffs[c++]*r,t.bezierCurveTo(l,h,u,d,o,s);break}case 5:t.closePath();break;default:gS()}return t}function _S(e){return mS(e,new Path2D)}function gS(e,t){}class Gw{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}put(e,t){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,t)}delete(e){this.cache.delete(e)}}ih(Gw,"LRUCache");class $w{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Xh(e,e.data)}getFromCache(e,t,r){return this.cacheMap.has(r)||this.cacheMap.set(r,new Gw(150)),this.cacheMap.get(r).get(zu(e.toString(),t))}setInCache(e,t,r,o){this.cacheDependenciesMap.has(o)||this.cacheDependenciesMap.set(o,new Map),this.cacheMap.has(o)||this.cacheMap.set(o,new Gw(150));const s=this.cacheDependenciesMap.get(o),l=zu(e.id.toString(),r);s.get(l)||s.set(l,new Set);const c=this.cacheMap.get(o),h=e.toString();s.get(l).add(h),c.put(zu(e.toString(),r),t)}removeImagesFromCacheByIds(e,t,r=0){if(!this.cacheMap.has(r)||!this.cacheDependenciesMap.has(r))return;const o=this.cacheMap.get(r),s=this.cacheDependenciesMap.get(r);for(const r of e){const e=zu(r.toString(),t);if(s.has(e)){for(const t of s.get(e))o.delete(t);s.delete(e)}}}rasterize(e,t,r,o){const s=this.getFromCache(e,r,o);if(s)return s.clone();const l=function(e,t){const r=Mw.calculate(t.params,e.metadata?e.metadata.variables:[]),o=e.usvg_tree,s=o.width,l=o.height,c=Math.max(1,Math.round(s*t.sx)),h=Math.max(1,Math.round(l*t.sy)),u=new DOMMatrix([c/s,0,0,h/l,0,0]);return null===rS&&(rS=tS(10,10),iS=rS.getContext("2d",{willReadFrequently:!0})),rS.width=c,rS.height=h,nS(iS,u,o,o,r),iS.getImageData(0,0,c,h)}(t.icon,e),c=$w._getImage(l);return this.setInCache(e,c,r,o),c.clone()}}class qw{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,t){const r=this.toIdx(e,t);return{min:this.minimums[r],max:this.maximums[r]}}isLeaf(e,t){return this.leaves[this.toIdx(e,t)]}toIdx(e,t){return t*this.size+e}}function yS(e,t,r,o){let s=0,l=Number.MAX_VALUE;for(let c=0;c<3;c++)if(Math.abs(o[c])<1e-15){if(r[c]<e[c]||r[c]>t[c])return null}else{const h=1/o[c];let u=(e[c]-r[c])*h,d=(t[c]-r[c])*h;if(u>d){const e=u;u=d,d=e}if(u>s&&(s=u),d<l&&(l=d),s>l)return null}return s}function xS(e,t,r,o,s,l,c,h,u,d,p){const f=o-e,m=s-t,_=l-r,v=c-e,E=h-t,P=u-r,C=p[1]*P-p[2]*E,R=p[2]*v-p[0]*P,z=p[0]*E-p[1]*v,D=f*C+m*R+_*z;if(Math.abs(D)<1e-15)return null;const O=1/D,F=d[0]-e,B=d[1]-t,k=d[2]-r,V=(F*C+B*R+k*z)*O;if(V<0||V>1)return null;const N=B*_-k*m,U=k*f-F*_,j=F*m-B*f,$=(p[0]*N+p[1]*U+p[2]*j)*O;return $<0||V+$>1?null:(v*N+E*U+P*j)*O}function vS(e,t,r){return(e-t)/(r-t)}function bS(e,t,r,o,s,l,c,h,u){const d=1<<r,p=l-o,f=c-s,m=(e+1)/d*p+o,_=(t+0)/d*f+s,v=(t+1)/d*f+s;h[0]=(e+0)/d*p+o,h[1]=_,u[0]=m,u[1]=v}class Yw{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const t=function(e){const t=Math.ceil(Math.log2(e.dim/8)),r=[];let o=Math.ceil(Math.pow(2,t));const s=1/o,l=(e,t,r,o,s)=>{const l=o?1:0,c=(e+1)*r-l,h=t*r,u=(t+1)*r-l;s[0]=e*r,s[1]=h,s[2]=c,s[3]=u};let c=new qw(o);const h=[];for(let t=0;t<o*o;t++){l(t%o,Math.floor(t/o),s,!1,h);const r=TS(h[0],h[1],e),u=TS(h[2],h[1],e),d=TS(h[2],h[3],e),p=TS(h[0],h[3],e);c.minimums.push(Math.min(r,u,d,p)),c.maximums.push(Math.max(r,u,d,p)),c.leaves.push(1)}for(r.push(c),o/=2;o>=1;o/=2){const e=r[r.length-1];c=new qw(o);for(let t=0;t<o*o;t++){l(t%o,Math.floor(t/o),2,!0,h);const r=e.getElevation(h[0],h[1]),s=e.getElevation(h[2],h[1]),u=e.getElevation(h[2],h[3]),d=e.getElevation(h[0],h[3]),p=e.isLeaf(h[0],h[1]),f=e.isLeaf(h[2],h[1]),m=e.isLeaf(h[2],h[3]),_=e.isLeaf(h[0],h[3]),v=Math.min(r.min,s.min,u.min,d.min),E=Math.max(r.max,s.max,u.max,d.max),P=p&&f&&m&&_;c.maximums.push(E),c.minimums.push(v),c.leaves.push(E-v<=5&&P?1:0)}r.push(c)}return r}(this.dem),r=t.length-1,o=t[r];this._addNode(o.minimums[0],o.maximums[0],o.leaves[0]),this._construct(t,0,0,r,0)}raycastRoot(e,t,r,o,s,l,c=1){return yS([e,t,-100],[r,o,this.maximums[0]*c],s,l)}raycast(e,t,r,o,s,l,c=1){if(!this.nodeCount)return null;const h=this.raycastRoot(e,t,r,o,s,l,c);if(null==h)return null;const u=[],d=[],p=[],f=[],m=[{idx:0,t:h,nodex:0,nodey:0,depth:0}];for(;m.length>0;){const{idx:h,t:_,nodex:v,nodey:E,depth:P}=m.pop();if(this.leaves[h]){bS(v,E,P,e,t,r,o,p,f);const h=1<<P,u=(v+0)/h,d=(v+1)/h,m=(E+0)/h,C=(E+1)/h,R=TS(u,m,this.dem)*c,z=TS(d,m,this.dem)*c,D=TS(d,C,this.dem)*c,O=TS(u,C,this.dem)*c,F=xS(p[0],p[1],R,f[0],p[1],z,f[0],f[1],D,s,l),B=xS(f[0],f[1],D,p[0],f[1],O,p[0],p[1],R,s,l),k=Math.min(null!==F?F:Number.MAX_VALUE,null!==B?B:Number.MAX_VALUE);if(k!==Number.MAX_VALUE)return k;{const e=J([],s,l,_);if(wS(R,z,O,D,vS(e[0],p[0],f[0]),vS(e[1],p[1],f[1]))>=e[2])return _}continue}let C=0;for(let m=0;m<this._siblingOffset.length;m++){bS((v<<1)+this._siblingOffset[m][0],(E<<1)+this._siblingOffset[m][1],P+1,e,t,r,o,p,f),p[2]=-100,f[2]=this.maximums[this.childOffsets[h]+m]*c;const _=yS(p,f,s,l);if(null!=_){const e=_;u[m]=e;let t=!1;for(let r=0;r<C&&!t;r++)e>=u[d[r]]&&(d.splice(r,0,m),t=!0);t||(d[C]=m),C++}}for(let e=0;e<C;e++){const t=d[e];m.push({idx:this.childOffsets[h]+t,t:u[t],nodex:(v<<1)+this._siblingOffset[t][0],nodey:(E<<1)+this._siblingOffset[t][1],depth:P+1})}}return null}_addNode(e,t,r){return this.minimums.push(e),this.maximums.push(t),this.leaves.push(r),this.childOffsets.push(0),this.nodeCount++}_construct(e,t,r,o,s){if(1===e[o].isLeaf(t,r))return;this.childOffsets[s]||(this.childOffsets[s]=this.nodeCount);const l=o-1,c=e[l];let h=0,u=0;for(let e=0;e<this._siblingOffset.length;e++){const o=2*t+this._siblingOffset[e][0],s=2*r+this._siblingOffset[e][1],l=c.getElevation(o,s),d=c.isLeaf(o,s),p=this._addNode(l.min,l.max,d);d&&(h|=1<<e),u||(u=p)}for(let o=0;o<this._siblingOffset.length;o++)h&1<<o||this._construct(e,2*t+this._siblingOffset[o][0],2*r+this._siblingOffset[o][1],l,u+o)}}function wS(e,t,r,o,s,l){return Ar(Ar(e,r,l),Ar(t,o,l),s)}function TS(e,t,r){const o=r.dim,s=ct(e*o-.5,0,o-1),l=ct(t*o-.5,0,o-1),c=Math.floor(s),h=Math.floor(l),u=Math.min(c+1,o-1),d=Math.min(h+1,o-1);return wS(r.get(c,h),r.get(u,h),r.get(c,d),r.get(u,d),s-c,l-h)}const SS={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function IS(e,t,r){return(256*e*256+256*t+r)/10-1e4}function ES(e,t,r){return 256*e+t+r/256-32768}class r_{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,t,r,o=!1){if(this.uid=e,t.height!==t.width)throw new RangeError("DEM tiles must be square");if(r&&"mapbox"!==r&&"terrarium"!==r)return void Et(`"${r}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=t.height;const s=this.dim=t.height-2,l=new Uint32Array(t.data.buffer);if(this.pixels=new Uint8Array(t.data.buffer),this.floatView=new Float32Array(t.data.buffer),this.borderReady=o,this._modifiedForSources={},!o){for(let e=0;e<s;e++)l[this._idx(-1,e)]=l[this._idx(0,e)],l[this._idx(s,e)]=l[this._idx(s-1,e)],l[this._idx(e,-1)]=l[this._idx(e,0)],l[this._idx(e,s)]=l[this._idx(e,s-1)];l[this._idx(-1,-1)]=l[this._idx(0,0)],l[this._idx(s,-1)]=l[this._idx(s-1,0)],l[this._idx(-1,s)]=l[this._idx(0,s-1)],l[this._idx(s,s)]=l[this._idx(s-1,s-1)]}const c="terrarium"===r?ES:IS;for(let e=0;e<l.length;++e){const t=4*e;this.floatView[e]=c(this.pixels[t],this.pixels[t+1],this.pixels[t+2])}this._timestamp=ri.now()}_buildQuadTree(){this._tree=new Yw(this)}get(e,t,r=!1){r&&(e=ct(e,-1,this.dim),t=ct(t,-1,this.dim));const o=this._idx(e,t);return this.floatView[o]}set(e,t,r){const o=this._idx(e,t),s=this.floatView[o];return this.floatView[o]=r,r-s}static getUnpackVector(e){return SS[e]}_idx(e,t){if(e<-1||e>=this.dim+1||t<-1||t>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(t+1)*this.stride+(e+1)}static pack(e,t){const r=[0,0,0,0],o=r_.getUnpackVector(t);let s=Math.floor((e+o[3])/o[2]);return r[2]=s%256,s=Math.floor(s/256),r[1]=s%256,s=Math.floor(s/256),r[0]=s,r}getPixels(){return new Hh({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,t,r){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let o=t*this.dim,s=t*this.dim+this.dim,l=r*this.dim,c=r*this.dim+this.dim;switch(t){case-1:o=s-1;break;case 1:s=o+1}switch(r){case-1:l=c-1;break;case 1:c=l+1}const h=-t*this.dim,u=-r*this.dim;for(let t=l;t<c;t++)for(let r=o;r<s;r++){const o=4*this._idx(r,t),s=4*this._idx(r+h,t+u);this.pixels[o+0]=e.pixels[s+0],this.pixels[o+1]=e.pixels[s+1],this.pixels[o+2]=e.pixels[s+2],this.pixels[o+3]=e.pixels[s+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function AS(e,t,r){1===e?t.headerLength=r.readFixed32():2===e?t.x=r.readVarint():3===e?t.y=r.readVarint():4===e?t.z=r.readVarint():5===e&&t.layers.push(function(e,t){return e.readFields(zS,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},t)}(r,r.readVarint()+r.pos))}function MS(e,t,r){1===e?(t.delta_filter=function(e,t){return e.readFields(PS,{blockSize:0},t)}(r,r.readVarint()+r.pos),t.filter="delta_filter"):2===e?(r.readVarint(),t.filter="zigzag_filter"):3===e?(r.readVarint(),t.filter="bitshuffle_filter"):4===e&&(r.readVarint(),t.filter="byteshuffle_filter")}function PS(e,t,r){1===e&&(t.blockSize=r.readVarint())}function CS(e,t,r){1===e?(r.readVarint(),t.codec="gzip_data"):2===e?(r.readVarint(),t.codec="jpeg_image"):3===e?(r.readVarint(),t.codec="webp_image"):4===e&&(r.readVarint(),t.codec="png_image")}function RS(e,t,r){let o=0,s=0;1===e?t.firstByte=r.readFixed64():2===e?t.lastByte=r.readFixed64():3===e?t.filters.push(function(e,t){return e.readFields(MS,{},t)}(r,r.readVarint()+r.pos)):4===e?t.codec=function(e,t){return e.readFields(CS,{},t)}(r,r.readVarint()+r.pos):5===e?s=r.readFloat():6===e?o=r.readFloat():7===e?t.bands.push(r.readString()):8===e?t.offset=r.readDouble():9===e&&(t.scale=r.readDouble()),0===t.offset&&(t.offset=s),0===t.scale&&(t.scale=o)}function zS(e,t,r){1===e?t.version=r.readVarint():2===e?t.name=r.readString():3===e?t.units=r.readString():4===e?t.tileSize=r.readVarint():5===e?t.buffer=r.readVarint():6===e?t.pixelFormat=r.readVarint():7===e&&t.dataIndex.push(function(e,t){return e.readFields(RS,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},t)}(r,r.readVarint()+r.pos))}function DS(e,t,r){if(2===e)!function(e,t,r){e.readFields(LS,r,t)}(r,r.readVarint()+r.pos,t);else if(3===e)throw new Error("Not implemented")}function LS(e,t,r){if(1===e){let e=0;const o=r.readVarint()+r.pos;for(;r.pos<o;)t[e++]=r.readVarint()}}function OS(e,t){if(4!==t.length)throw new Error(`Expected data of dimension 4 but got ${t.length}.`);let r=t[3];for(let o=2;o>=1;o--){const s=1===o?1:0,l=2===o?1:0;for(let o=0;o<t[0];o++){const c=t[1]*o;for(let o=s;o<t[1];o++){const s=t[2]*(o+c);for(let o=l;o<t[2];o++){const l=t[3]*(o+s);for(let o=0;o<t[3];o++){const t=l+o;e[t]+=e[t-r]}}}}r*=t[o]}return e}function FS(e){for(let t=0,r=e.length;t<r;t++)e[t]=e[t]>>>1^-(1&e[t]);return e}function BS(e,t){switch(t){case"uint32":return e;case"uint16":for(let t=0;t<e.length;t+=2){const r=e[t],o=e[t+1];e[t]=(240&r)>>4|(61440&r)>>8|(240&o)<<4|61440&o,e[t+1]=15&r|(3840&r)>>4|(15&o)<<8|(3840&o)<<4}return e;case"uint8":for(let t=0;t<e.length;t+=4){const r=e[t],o=e[t+1],s=e[t+2],l=e[t+3];e[t+0]=(192&r)>>6|(192&o)>>4|(192&s)>>2|192&l,e[t+1]=(48&r)>>4|(48&o)>>2|48&s|(48&l)<<2,e[t+2]=(12&r)>>2|12&o|(12&s)<<2|(12&l)<<4,e[t+3]=3&r|(3&o)<<2|(3&s)<<4|(3&l)<<6}return e;default:throw new Error(`Invalid pixel format, "${t}"`)}}ih(r_,"DEMData"),ih(Yw,"DemMinMaxQuadTree",{omit:["dem"]});var kS=Uint8Array,VS=Uint16Array,NS=Int32Array,US=new kS([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),jS=new kS([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),GS=new kS([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$S=function(e,t){for(var r=new VS(31),o=0;o<31;++o)r[o]=t+=1<<e[o-1];var s=new NS(r[30]);for(o=1;o<30;++o)for(var l=r[o];l<r[o+1];++l)s[l]=l-r[o]<<5|o;return{b:r,r:s}},qS=$S(US,2),HS=qS.b,WS=qS.r;HS[28]=258,WS[258]=28;for(var ZS=$S(jS,0).b,XS=new VS(32768),YS=0;YS<32768;++YS){var JS=(43690&YS)>>1|(21845&YS)<<1;XS[YS]=((65280&(JS=(61680&(JS=(52428&JS)>>2|(13107&JS)<<2))>>4|(3855&JS)<<4))>>8|(255&JS)<<8)>>1}var QS=function(e,t,r){for(var o=e.length,s=0,l=new VS(t);s<o;++s)e[s]&&++l[e[s]-1];var c,h=new VS(t);for(s=1;s<t;++s)h[s]=h[s-1]+l[s-1]<<1;c=new VS(1<<t);var u=15-t;for(s=0;s<o;++s)if(e[s])for(var d=s<<4|e[s],p=t-e[s],f=h[e[s]-1]++<<p,m=f|(1<<p)-1;f<=m;++f)c[XS[f]>>u]=d;return c},KS=new kS(288);for(YS=0;YS<144;++YS)KS[YS]=8;for(YS=144;YS<256;++YS)KS[YS]=9;for(YS=256;YS<280;++YS)KS[YS]=7;for(YS=280;YS<288;++YS)KS[YS]=8;var eI=new kS(32);for(YS=0;YS<32;++YS)eI[YS]=5;var tI=QS(KS,9),iI=QS(eI,5),rI=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},nI=function(e,t,r){var o=t/8|0;return(e[o]|e[o+1]<<8)>>(7&t)&r},oI=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},sI=function(e){return(e+7)/8|0},aI=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],lI=function(e,t,r){var o=new Error(t||aI[e]);if(o.code=e,Error.captureStackTrace&&Error.captureStackTrace(o,lI),!r)throw o;return o},cI=new kS(0);var hI="undefined"!=typeof TextDecoder&&new TextDecoder;try{hI.decode(cI,{stream:!0})}catch(t){}const uI={gzip_data:"gzip"};class j_ extends Error{constructor(e){super(e),this.name="MRTError"}}const dI={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},pI={uint32:1,uint16:2,uint8:4},fI={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let mI;class H_{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const t=this.layers[e];if(!t)throw new j_(`Layer '${e}' not found`);return t}getHeaderLength(e){const t=new Uint8Array(e),r=new DataView(e);if(13!==t[0])throw new j_("File is not a valid MRT.");return r.getUint32(1,!0)}parseHeader(e){const t=new Uint8Array(e),r=this.getHeaderLength(e);if(t.length<r)throw new j_(`Expected header with length >= ${r} but got buffer of length ${t.length}`);const o=new mI(t.subarray(0,r)).readFields(AS,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==o.x||this.y!==o.y||this.z!==o.z))throw new j_(`Invalid attempt to parse header ${o.z}/${o.x}/${o.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=o.x,this.y=o.y,this.z=o.z;for(const e of o.layers)this.layers[e.name]=new Z_(e,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const t=[],r=this.getLayer(e.layerName);for(let o of e.blockIndices){const s=r.dataIndex[o],l=s.firstByte-e.firstByte,c=s.lastByte-e.firstByte;if(r._blocksInProgress.has(o))continue;const h={layerName:r.name,firstByte:l,lastByte:c,pixelFormat:r.pixelFormat,blockIndex:o,blockShape:[s.bands.length].concat(r.bandShape),buffer:r.buffer,codec:s.codec.codec,filters:s.filters.map((e=>e.filter))};r._blocksInProgress.add(o),t.push(h)}return new W_(t,(()=>{t.forEach((e=>r._blocksInProgress.delete(e.blockIndex)))}),((e,o)=>{if(t.forEach((e=>r._blocksInProgress.delete(e.blockIndex))),e)throw e;o.forEach((e=>{this.getLayer(e.layerName).processDecodedData(e)}))}))}}class Z_{constructor({version:e,name:t,units:r,tileSize:o,pixelFormat:s,buffer:l,dataIndex:c},h){if(this.version=e,1!==this.version)throw new j_(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=t,this.units=r,this.tileSize=o,this.buffer=l,this.pixelFormat=dI[s],this.dataIndex=c,this.bandShape=[o+2*l,o+2*l,pI[this.pixelFormat]],this._decodedBlocks=new Gw(h?h.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return pI[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const t=e.blockIndex.toString();this._decodedBlocks.get(t)||this._decodedBlocks.put(t,e.data)}getBlockForBand(e){let t=0;switch(typeof e){case"string":for(const[r,o]of this.dataIndex.entries()){for(const[s,l]of o.bands.entries())if(l===e)return{bandIndex:t+s,blockIndex:r,blockBandIndex:s};t+=o.bands.length}break;case"number":for(const[r,o]of this.dataIndex.entries()){if(e>=t&&e<t+o.bands.length)return{bandIndex:e,blockIndex:r,blockBandIndex:e-t};t+=o.bands.length}break;default:throw new j_(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let t=1/0,r=-1/0;const o=[],s=new Set;for(const l of e){const{blockIndex:e}=this.getBlockForBand(l);if(e<0)throw new j_(`Invalid band: ${JSON.stringify(l)}`);const c=this.dataIndex[e];o.includes(e)||o.push(e),s.add(e),t=Math.min(t,c.firstByte),r=Math.max(r,c.lastByte)}if(s.size>this.cacheSize)throw new j_(`Number of blocks to decode (${s.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:t,lastByte:r,blockIndices:o}}hasBand(e){const{blockIndex:t}=this.getBlockForBand(e);return t>=0}hasDataForBand(e){const{blockIndex:t}=this.getBlockForBand(e);return t>=0&&!!this._decodedBlocks.get(t.toString())}getBandView(e){const{blockIndex:t,blockBandIndex:r}=this.getBlockForBand(e);if(t<0)throw new j_(`Band not found: ${JSON.stringify(e)}`);const o=this._decodedBlocks.get(t.toString());if(!o)throw new j_(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const s=this.dataIndex[t],l=this.bandShape.reduce(((e,t)=>e*t),1),c=r*l,h=o.subarray(c,c+l);return{data:h,bytes:new Uint8Array(h.buffer).subarray(h.byteOffset,h.byteOffset+h.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:s.offset,scale:s.scale}}}H_.setPbf=function(e){mI=e};class W_{constructor(e,t,r){this.tasks=e,this._onCancel=t,this._onComplete=r,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,t){this._finalized||(this._onComplete(e,t),this._finalized=!0)}}H_.performDecoding=function(e,t){const r=new Uint8Array(e);return Promise.all(t.tasks.map((e=>{const{layerName:t,firstByte:o,lastByte:s,pixelFormat:l,blockShape:c,blockIndex:h,filters:u,codec:d}=e,p=r.subarray(o,s+1),f=new Uint32Array(c[0]*c[1]*c[2]);let m;if("gzip_data"!==d)throw new j_(`Unhandled codec: ${d}`);return m=function(e,t){if(!globalThis.DecompressionStream&&"gzip_data"===t)return Promise.resolve((c=function(e){31==e[0]&&139==e[1]&&8==e[2]||lI(6,"invalid gzip data");var t=e[3],r=10;4&t&&(r+=2+(e[10]|e[11]<<8));for(var o=(t>>3&1)+(t>>4&1);o>0;o-=!e[r++]);return r+(2&t)}(r=e),c+8>r.length&&lI(6,"invalid gzip data"),function(e,t,r,o){var s=e.length;if(!s||t.f&&!t.l)return r||new kS(0);var l=!r,c=l||2!=t.i,h=t.i;l&&(r=new kS(3*s));var u=function(e){var t=r.length;if(e>t){var o=new kS(Math.max(2*t,e));o.set(r),r=o}},d=t.f||0,p=t.p||0,f=t.b||0,m=t.l,_=t.d,v=t.m,E=t.n,P=8*s;do{if(!m){d=nI(e,p,1);var C=nI(e,p+1,3);if(p+=3,!C){var R=e[($=sI(p)+4)-4]|e[$-3]<<8,z=$+R;if(z>s){h&&lI(0);break}c&&u(f+R),r.set(e.subarray($,z),f),t.b=f+=R,t.p=p=8*z,t.f=d;continue}if(1==C)m=tI,_=iI,v=9,E=5;else if(2==C){var D=nI(e,p,31)+257,O=nI(e,p+10,15)+4,F=D+nI(e,p+5,31)+1;p+=14;for(var B=new kS(F),k=new kS(19),V=0;V<O;++V)k[GS[V]]=nI(e,p+3*V,7);p+=3*O;var N=rI(k),U=(1<<N)-1,j=QS(k,N);for(V=0;V<F;){var $,q=j[nI(e,p,U)];if(p+=15&q,($=q>>4)<16)B[V++]=$;else{var H=0,Z=0;for(16==$?(Z=3+nI(e,p,3),p+=2,H=B[V-1]):17==$?(Z=3+nI(e,p,7),p+=3):18==$&&(Z=11+nI(e,p,127),p+=7);Z--;)B[V++]=H}}var Y=B.subarray(0,D),J=B.subarray(D);v=rI(Y),E=rI(J),m=QS(Y,v),_=QS(J,E)}else lI(1);if(p>P){h&&lI(0);break}}c&&u(f+131072);for(var Q=(1<<v)-1,K=(1<<E)-1,ee=p;;ee=p){var te=(H=m[oI(e,p)&Q])>>4;if((p+=15&H)>P){h&&lI(0);break}if(H||lI(2),te<256)r[f++]=te;else{if(256==te){ee=p,m=null;break}var ie=te-254;te>264&&(ie=nI(e,p,(1<<(oe=US[V=te-257]))-1)+HS[V],p+=oe);var re=_[oI(e,p)&K],ne=re>>4;if(re||lI(3),p+=15&re,J=ZS[ne],ne>3){var oe=jS[ne];J+=oI(e,p)&(1<<oe)-1,p+=oe}if(p>P){h&&lI(0);break}c&&u(f+131072);var se=f+ie;if(f<J){var ae=0-J,le=Math.min(J,se);for(ae+f<0&&lI(3);f<le;++f)r[f]=o[ae+f]}for(;f<se;++f)r[f]=r[f-J]}}t.l=m,t.p=ee,t.b=f,t.f=d,m&&(d=1,t.m=v,t.d=_,t.n=E)}while(!d);return f!=r.length&&l?function(e,t,r){return(null==r||r>e.length)&&(r=e.length),new kS(e.subarray(0,r))}(r,0,f):r.subarray(0,f)}(r.subarray(c,-8),{i:2},new kS(((s=r)[(l=s.length)-4]|s[l-3]<<8|s[l-2]<<16|s[l-1]<<24)>>>0),o)));var r,o,s,l,c;const h=uI[t];if(!h)throw new Error(`Unhandled codec: ${t}`);const u=new globalThis.DecompressionStream(h);return new Response(new Blob([e]).stream().pipeThrough(u)).arrayBuffer().then((e=>new Uint8Array(e)))}(p,d).then((e=>(function(e,t){e.readFields(DS,t)}(new mI(e),f),new(0,fI[l])(f.buffer)))),m.then((e=>{for(let t=u.length-1;t>=0;t--)switch(u[t]){case"delta_filter":OS(e,c);break;case"zigzag_filter":FS(e);break;case"bitshuffle_filter":BS(e,l);break;default:throw new j_(`Unhandled filter "${u[t]}"`)}return{layerName:t,blockIndex:h,data:e}})).catch((e=>{throw e}))})))},ih(W_,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),ih(H_,"MapboxRasterTile"),ih(Z_,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class Y_{constructor(e){this._stringToNumber={},this._numberToString=[];for(let t=0;t<e.length;t++){const r=e[t];this._stringToNumber[r]=t,this._numberToString[t]=r}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class J_{constructor(e,t){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new eh(Ao,16,0),this.featureIndexArray=new Vl,this.promoteId=t,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,t,r,o,s,l=0,c=0){const h=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(r,o,s,l);const u=this.grid;for(let e=0;e<t.length;e++){const r=t[e],o=[1/0,1/0,-1/0,-1/0];for(let e=0;e<r.length;e++){const t=r[e];o[0]=Math.min(o[0],t.x),o[1]=Math.min(o[1],t.y),o[2]=Math.max(o[2],t.x),o[3]=Math.max(o[3],t.y)}0!==c&&(o[0]-=c,o[1]-=c,o[2]+=c,o[3]+=c),o[0]<Ao&&o[1]<Ao&&o[2]>=0&&o[3]>=0&&u.insert(h,o[0],o[1],o[2],o[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ic(new hv(this.rawTileData)).layers,this.sourceLayerCoder=new Y_(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,t){const{tilespaceGeometry:r,transform:o,tileTransform:s,pixelPosMatrix:l,availableImages:c,worldview:h}=t;this.loadVTLayers(),this.serializedLayersCache.clear();const u=t.queryRadius?t.queryRadius:0,d=r.bufferedTilespaceBounds,p=this.grid.query(d.min.x,d.min.y,d.max.x,d.max.y,((e,t,o,s)=>_p(r.bufferedTilespaceGeometry,e-u,t-u,o+u,s+u)));p.sort(gI);let f=null;o.elevation&&p.length>0&&(f=Rb.create(o.elevation,this.tileID));const m={};let _;for(let u=0;u<p.length;u++){const d=p[u];if(d===_)continue;_=d;const v=this.featureIndexArray.get(d);let E=null;this.is3DTile?this.loadMatchingModelFeature(m,v,e,r,o,h):this.loadMatchingFeature(m,v,e,c,h,((e,c,h,u=0)=>(E||(E=$d(e,this.tileID.canonical,s)),c.queryIntersectsFeature(r,e,h,E,this.z,o,l,f,u,t.scope))))}return m}loadMatchingFeature(e,t,r,o,s,l){const{featureIndex:c,bucketIndex:h,sourceLayerIndex:u,layoutVertexArrayOffset:d}=t,p=this.bucketLayerIDs[h],f=r.layers,m=Object.keys(f);if(m.length&&!St(m,p))return;const _=r.sourceCache,v=this.sourceLayerCoder.decode(u),E=this.vtLayers[v].feature(c),P=this.getId(E,v);for(let t=0;t<p.length;t++){const r=p[t];if(!f[r])continue;const{styleLayer:h,targets:u}=f[r];let m={};void 0!==P&&(m=_.getFeatureState(h.sourceLayer,P));const v=!l||l(E,h,m,d);if(!v)continue;const C=new Wb(E,this.z,this.x,this.y,P);C.tile=this.tileID.canonical,C.state=m;let R=this.serializedLayersCache.get(r);R||(R=h.serialize(),R.id=r,this.serializedLayersCache.set(r,R)),C.source=R.source,C.sourceLayer=R["source-layer"],C.layer=Object.assign({},R),C.layer.paint=_I(R.paint,h.paint,E,m,o),C.layer.layout=_I(R.layout,h.layout,E,m,o);let z=!1;for(const e of u){this.updateFeatureProperties(C,e);const{filter:t}=e;if(t)if(E.properties=C.properties,t.needGeometry){const e=qd(E,!0);if(!t.filter(new Ja(this.tileID.overscaledZ,{worldview:s}),e,this.tileID.canonical))continue}else if(!t.filter(new Ja(this.tileID.overscaledZ,{worldview:s}),E))continue;z=!0,e.targetId&&this.addFeatureVariant(C,e)}z&&this.appendToResult(e,r,c,C,v)}}loadMatchingModelFeature(e,t,r,o,s,l){const{featureIndex:c,bucketIndex:h}=t,u=this.bucketLayerIDs[h],d=r.layers,p=Object.keys(d);if(!p.length||St(p,u))for(let t=0;t<u.length;t++){const h=u[t],{styleLayer:p,targets:f}=d[h];if("model"!==p.type)continue;const m=o.tile,_=m.getBucket(p);if(!(_&&_ instanceof $b))continue;const v=MT(_,c,o,s);if(!v)continue;const{z:E,x:P,y:C}=m.tileID.canonical,{feature:R,intersectionZ:z,position:D}=v;let O={};void 0!==R.id&&(O=r.sourceCache.getFeatureState(p.sourceLayer,R.id));const F=new Wb({},E,P,C,R.id);F.tile=this.tileID.canonical,F.state=O,F.properties=R.properties,F.geometry={type:"Point",coordinates:[D.lng,D.lat]};let B=this.serializedLayersCache.get(h);B||(B=p.serialize(),B.id=h,this.serializedLayersCache.set(h,B)),F.source=B.source,F.sourceLayer=B["source-layer"],F.layer=Object.assign({},B);let k=!1;for(const e of f){this.updateFeatureProperties(F,e);const{filter:t}=e;if(t)if(R.properties=F.properties,t.needGeometry){if(!t.filter(new Ja(this.tileID.overscaledZ,{worldview:l}),R,this.tileID.canonical))continue}else if(!t.filter(new Ja(this.tileID.overscaledZ,{worldview:l}),R))continue;k=!0,e.targetId&&this.addFeatureVariant(F,e)}k&&this.appendToResult(e,h,c,F,z)}}updateFeatureProperties(e,t,r){if(t.properties){const o={};for(const s in t.properties){const l=t.properties[s].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,r);null!=l&&(o[s]=l)}e.properties=o}}addFeatureVariant(e,t,r){const o={target:t.target,namespace:t.namespace,uniqueFeatureID:t.uniqueFeatureID};t.properties&&(o.properties=e.properties),e.variants=e.variants||{},e.variants[t.targetId]=e.variants[t.targetId]||[],e.variants[t.targetId].push(o)}appendToResult(e,t,r,o,s){let l=e[t];void 0===l&&(l=e[t]=[]),l.push({featureIndex:r,feature:o,intersectionZ:s})}lookupSymbolFeatures(e,t,r,o,s,l){const c={};this.loadVTLayers();for(const h of e)this.loadMatchingFeature(c,{bucketIndex:t,sourceLayerIndex:r,featureIndex:h,layoutVertexArrayOffset:0},o,s,l);return c}loadFeature(e){const{featureIndex:t,sourceLayerIndex:r}=e;this.loadVTLayers();const o=this.sourceLayerCoder.decode(r),s=this.vtFeatures[o];if(s[t])return s[t];const l=this.vtLayers[o].feature(t);return s[t]=l,l}hasLayer(e){for(const t of this.bucketLayerIDs)for(const r of t)if(e===r)return!0;return!1}getId(e,t){let r=e.id;if(this.promoteId){const o=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[t];if(null!=o)if(Array.isArray(o)){if(!this.promoteIdExpression){const e=qc(o);if("success"!==e.result){const t=e.value.map((e=>`${e.key}: ${e.message}`)).join(", ");return void Et(`Failed to create expression for promoteId: ${t}`)}this.promoteIdExpression=e.value}r=this.promoteIdExpression.evaluate({zoom:0},e)}else r=e.properties[o];"boolean"==typeof r&&(r=Number(r))}return r}}function _I(e,t,r,o,s){return bt(e,((e,l)=>{const c=t instanceof so?t.get(l):null;return c&&c.evaluate?c.evaluate(r,o,void 0,s):c}))}function gI(e,t){return t-e}ih(J_,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const yI=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class eA{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,r]=new Uint8Array(e,0,2);if(219!==t)throw new Error("Data does not appear to be in a KDBush format.");const o=r>>4;if(1!==o)throw new Error(`Got v${o} data when expected v1.`);const s=yI[15&r];if(!s)throw new Error("Unrecognized array type.");const[l]=new Uint16Array(e,2,1),[c]=new Uint32Array(e,4,1);return new eA(c,l,s,e)}constructor(e,t=64,r=Float64Array,o){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=r,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const s=yI.indexOf(this.ArrayType),l=2*e*this.ArrayType.BYTES_PER_ELEMENT,c=e*this.IndexArrayType.BYTES_PER_ELEMENT,h=(8-c%8)%8;if(s<0)throw new Error(`Unexpected typed array class: ${r}.`);o&&o instanceof ArrayBuffer?(this.data=o,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+c+h,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+l+c+h),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+c+h,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+s]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=e,this.coords[this._pos++]=t,r}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return xI(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:l,nodeSize:c}=this,h=[0,s.length-1,0],u=[];for(;h.length;){const d=h.pop()||0,p=h.pop()||0,f=h.pop()||0;if(p-f<=c){for(let c=f;c<=p;c++){const h=l[2*c],d=l[2*c+1];h>=e&&h<=r&&d>=t&&d<=o&&u.push(s[c])}continue}const m=f+p>>1,_=l[2*m],v=l[2*m+1];_>=e&&_<=r&&v>=t&&v<=o&&u.push(s[m]),(0===d?e<=_:t<=v)&&(h.push(f),h.push(m-1),h.push(1-d)),(0===d?r>=_:o>=v)&&(h.push(m+1),h.push(p),h.push(1-d))}return u}within(e,t,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:s,nodeSize:l}=this,c=[0,o.length-1,0],h=[],u=r*r;for(;c.length;){const d=c.pop()||0,p=c.pop()||0,f=c.pop()||0;if(p-f<=l){for(let r=f;r<=p;r++)TI(s[2*r],s[2*r+1],e,t)<=u&&h.push(o[r]);continue}const m=f+p>>1,_=s[2*m],v=s[2*m+1];TI(_,v,e,t)<=u&&h.push(o[m]),(0===d?e-r<=_:t-r<=v)&&(c.push(f),c.push(m-1),c.push(1-d)),(0===d?e+r>=_:t+r>=v)&&(c.push(m+1),c.push(p),c.push(1-d))}return h}}function xI(e,t,r,o,s,l){if(s-o<=r)return;const c=o+s>>1;vI(e,t,c,o,s,l),xI(e,t,r,o,c-1,1-l),xI(e,t,r,c+1,s,1-l)}function vI(e,t,r,o,s,l){for(;s>o;){if(s-o>600){const c=s-o+1,h=r-o+1,u=Math.log(c),d=.5*Math.exp(2*u/3),p=.5*Math.sqrt(u*d*(c-d)/c)*(h-c/2<0?-1:1);vI(e,t,r,Math.max(o,Math.floor(r-h*d/c+p)),Math.min(s,Math.floor(r+(c-h)*d/c+p)),l)}const c=t[2*r+l];let h=o,u=s;for(bI(e,t,o,r),t[2*s+l]>c&&bI(e,t,o,s);h<u;){for(bI(e,t,h,u),h++,u--;t[2*h+l]<c;)h++;for(;t[2*u+l]>c;)u--}t[2*o+l]===c?bI(e,t,o,u):(u++,bI(e,t,u,s)),u<=r&&(o=u+1),r<=u&&(s=u-1)}}function bI(e,t,r,o){wI(e,r,o),wI(t,2*r,2*o),wI(t,2*r+1,2*o+1)}function wI(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function TI(e,t,r,o){const s=e-r,l=t-o;return s*s+l*l}t.$=bn,t.A=Lr,t.B=zu,t.C=2,t.D=Zf,t.E=ir,t.F=Ix,t.G=fb,t.H=yn,t.I=sr,t.J=_u,t.K=gn,t.L=vn,t.M=Oc,t.N=zc,t.O=Lc,t.P=Je,t.Q=$c,t.R=Li,t.S=gu,t.T=Cm,t.U=qc,t.V=kb,t.W=Hc,t.X=ca,t.Y=aa,t.Z=la,t._=an,t.a=function(e){return qt.API_CDN_URL_REGEX.test(e)},t.a$=Cd,t.a0=xn,t.a1=Er,t.a2=yu,t.a3=class extends kb{},t.a4=Fc,t.a5=Dc,t.a6=mu,t.a7=function(e){const t=e.value;return t?xn(t)?mT(t,!0)?[]:[new kb(e.key,t,`invalid url "${t}"`)]:[new kb(e.key,t,`string expected, "${gn(t)}" found`)]:[]},t.a8=to,t.a9=uo,t.aA=ct,t.aB=m,t.aC=xe,t.aD=dd,t.aE=mp,t.aF=Id,t.aG=kd,t.aH=function(e,t){const r={};for(let o=0;o<t.length;o++){const s=t[o];s in e&&(r[s]=e[s])}return r},t.aI=ku,t.aJ=Ed,t.aK=class{constructor(e){this.entries={},this.scheduler=e}request(e,t,r,o){const s=this.entries[e]=this.entries[e]||{callbacks:[]};if(s.result){const[e,r]=s.result;return this.scheduler?this.scheduler.add((()=>{o(e,r)}),t):o(e,r),()=>{}}return s.callbacks.push(o),s.cancel||(s.cancel=r(((r,o)=>{s.result=[r,o];for(const e of s.callbacks)this.scheduler?this.scheduler.add((()=>{e(r,o)}),t):e(r,o);setTimeout((()=>delete this.entries[e]),3e3)}))),()=>{s.result||(s.callbacks=s.callbacks.filter((e=>e!==o)),s.callbacks.length||(s.cancel(),delete this.entries[e]))}}},t.aL=function(t,r,o){const s=JSON.stringify(t.request);return t.data&&((this||e).deduped.entries[s]={result:[null,t.data]}),(this||e).deduped.request(s,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},(e=>{const r=Bi(t.request,((t,r,s)=>{t?e(t):r&&e(null,{rawData:r,vectorTile:o?void 0:new ic(new hv(r)),responseHeaders:new Map(s.entries())})}));return()=>{r.cancel(),e()}}),r)},t.aM=function(e){return e?{cacheControl:e.get("Cache-Control"),expires:e.get("Expires")}:{cacheControl:void 0,expires:void 0}},t.aN=Re,t.aO=function(e){fi++,fi>li&&(e.getActor().send("enforceCacheSizeLimit",ai),fi=0)},t.aP=function(e){return e<=1?1:Math.pow(2,Math.floor(Math.log2(e)))},t.aQ=Kc,t.aR=bb,t.aS=Sb,t.aT=Bu,t.aU=gb,t.aV=function(e,t){const r=document.createElement("video");r.muted=!0,r.onloadstart=function(){t(null,r)};for(let t=0;t<e.length;t++){const o=document.createElement("source");ki(e[t])||(r.crossOrigin="Anonymous"),o.src=e[t],r.appendChild(o)}return{cancel:()=>{}}},t.aW=Rm,t.aX=Yb,t.aY=vt,t.aZ=bw,t.a_=Pd,t.aa=ao,t.ab=class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return Rt(e.expression.evaluate(t))}interpolate(e,t,r){return{x:Ar(e.x,t.x,r),y:Ar(e.y,t.y,r),z:Ar(e.z,t.z,r),azimuthal:Ar(e.azimuthal,t.azimuthal,r),polar:Ar(e.polar,t.polar,r)}}},t.ac=Ja,t.ad=$s,t.ae=Gu,t.af=se,t.ag=V,t.ah=ft,t.ai=so,t.aj=rf,t.ak=Ar,t.al=Ao,t.am=Mr,t.an=it,t.ao=ur,t.ap=class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([e,t]){const r=Rt([1,e,t]);return{x:r.x,y:r.y,z:r.z}}(e.expression.evaluate(t))}interpolate(e,t,r){return{x:Ar(e.x,t.x,r),y:Ar(e.y,t.y,r),z:Ar(e.z,t.z,r)}}},t.aq=function(e,t,r=0,o=!0){const s=new Je(r,r),l=e.sub(s),c=t.add(s),h=[l,new Je(c.x,l.y),c,new Je(l.x,c.y)];return o&&h.push(l.clone()),h},t.ar=function(e,t){const r=[];for(let o=0;o<e.length;o++){const s=mt(o-1,-1,e.length-1),l=mt(o+1,-1,e.length-1),c=e[o],h=e[l],u=e[s].sub(c).unit(),d=h.sub(c).unit(),p=d.angleWithSep(u.x,u.y),f=u.add(d).unit().mult(-1*t/Math.sin(p/2));r.push(c.add(f))}return r},t.as=ww,t.at=_p,t.au=function(e,t,r=0){return N(((t.x-r)*e.scale-e.x)*Ao,(t.y*e.scale-e.y)*Ao,Rd(t.z,t.y))},t.av=ue,t.aw=ie,t.ax=fc,t.ay=Lx,t.az=function(e){let t=1/0,r=1/0,o=-1/0,s=-1/0;for(const l of e)t=Math.min(t,l.x),r=Math.min(r,l.y),o=Math.max(o,l.x),s=Math.max(s,l.y);return{min:new Je(t,r),max:new Je(o,s)}},t.b=function(e){return qt.API_FONTS_REGEX.test(e)},t.b$=A_,t.b0=ll,t.b1=Go,t.b2=yt,t.b3=Ml,t.b4=eb,t.b5=function(){au.isLoading()||au.isLoaded()||"deferred"!==nu()||ou()},t.b6=xu,t.b7=qd,t.b8=Wb,t.b9=Lt,t.bA=p,t.bB=C,t.bC=u,t.bD=function(e,t){const{x:r,y:o}=e.point,s=tf(r,o,e.worldSize/e._pixelsPerMercatorPixel,0,0);return m(s,s,Qp(Up(t)))},t.bE=s,t.bF=ce,t.bG=Q,t.bH=J,t.bI=ne,t.bJ=re,t.bK=nb,t.bL=Mv,t.bM=rb,t.bN=function(e,t,r,o,s){const l=5*t+2;e.float32[l+0]=r,e.float32[l+1]=o,e.float32[l+2]=s},t.bO=Uw,t.bP=De,t.bQ=Ve,t.bR=Fe,t.bS=We,t.bT=mt,t.bU=function(e,t,r,s){var l=new o(4);return l[0]=e,l[1]=t,l[2]=r,l[3]=s,l},t.bV=class{isDataAvailableAtPoint(e){const t=this._source();if(this.isUsingMockSource()||!t||e.y<0||e.y>1)return!1;const r=t.getSource().maxzoom,o=1<<r,s=Math.floor(e.x),l=Math.floor((e.x-s)*o),c=Math.floor(e.y*o),h=this.findDEMTileFor(new Kc(r,s,r,l,c));return!(!h||!h.dem)}getAtPointOrZero(e,t=0){return this.getAtPoint(e,t)||0}getAtPoint(e,t,r=!0){if(this.isUsingMockSource())return null;null==t&&(t=null);const o=this._source();if(!o)return t;if(e.y<0||e.y>1)return t;const s=o.getSource().maxzoom,l=1<<s,c=Math.floor(e.x),h=e.x-c,u=new Kc(s,c,s,Math.floor(h*l),Math.floor(e.y*l)),d=this.findDEMTileFor(u);if(!d||!d.dem)return t;const p=d.dem,f=1<<d.tileID.canonical.z,m=(h*f-d.tileID.canonical.x)*p.dim,_=(e.y*f-d.tileID.canonical.y)*p.dim,v=Math.floor(m),E=Math.floor(_);return(r?this.exaggeration():1)*Ar(Ar(p.get(v,E),p.get(v,E+1),_-E),Ar(p.get(v+1,E),p.get(v+1,E+1),_-E),m-v)}static getAtTileOffset(e,t,r,o){const s=1<<e.canonical.z;return o?o.pointElevation(t):r?r.getAtPointOrZero(new Gu(e.wrap+(e.canonical.x+t.x/Ao)/s,(e.canonical.y+t.y/Ao)/s)):0}static getAtTileOffsetFunc(e,t,r,o){return(s,l,c)=>{const h=this.getAtTileOffset(e,s,l,c),u=o.upVector(e.canonical,s.x,s.y);return Y(u,u,h*o.upVectorScale(e.canonical,t,r).metersToTile),u}}getForTilePoints(e,t,r,o){if(this.isUsingMockSource())return!1;const s=Rb.create(this,e,o);return!!s&&(t.forEach((e=>{e[2]=this.exaggeration()*s.getElevationAt(e[0],e[1],r)})),!0)}getMinMaxForTile(e){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(e);if(!t||!t.dem)return null;const r=t.dem.tree,o=t.tileID,s=1<<e.canonical.z-o.canonical.z;let l=e.canonical.x/s-o.canonical.x,c=e.canonical.y/s-o.canonical.y,h=0;for(let t=0;t<e.canonical.z-o.canonical.z&&!r.leaves[h];t++){l*=2,c*=2;const e=2*Math.floor(c)+Math.floor(l);h=r.childOffsets[h]+e,l%=1,c%=1}return{min:this.exaggeration()*r.minimums[h],max:this.exaggeration()*r.maximums[h]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(e,t,r){throw new Error("Pure virtual method called.")}pointCoordinate(e){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(e){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const e=this.visibleDemTiles;if(0===e.length)return null;let t=!1,r=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const s of e){const e=this.getMinMaxForTile(s.tileID);e&&(r=Math.min(r,e.min),o=Math.max(o,e.max),t=!0)}return t?{min:r,max:o}:null}},t.bW=pg,t.bX=np,t.bY=iv,t.bZ=y_,t.b_=fT,t.ba=Qy,t.bb=vd,t.bc=$d,t.bd=No,t.be=xl,t.bf=Dp,t.bg=Ol,t.bh=Df,t.bi=iT,t.bj=function(e,t){const r=rf(t.zoom);if(0===r)return Up(e);const o=qp(e),s=Hp(o),l=Id(o.getWest())*t.worldSize,c=Id(o.getEast())*t.worldSize,h=Ed(o.getNorth())*t.worldSize,u=Ed(o.getSouth())*t.worldSize,d=[l,h,0],p=[c,h,0],m=[l,u,0],_=[c,u,0],v=f([],t.globeMatrix);return se(d,d,v),se(p,p,v),se(m,m,v),se(_,_,v),s[0]=jp(s[0],m,r),s[1]=jp(s[1],_,r),s[2]=jp(s[2],p,r),s[3]=jp(s[3],d,r),wc.fromPoints(s)},t.bk=Jp,t.bl=f,t.bm=Zp,t.bn=jp,t.bo=jo,t.bp=zp,t.bq=R,t.br=_,t.bs=H_,t.bt=hv,t.bu=Bi,t.bv=function(e,t){const r=[];for(const o in e)o in t||r.push(o);return r},t.bw=_t,t.bx=["type","source","source-layer","minzoom","maxzoom","filter","layout"],t.by=Qe,t.bz=d,t.c=Wt,t.c$=function(e,t,r){let o=0;for(let r=0;r<2;++r){const s=0;e[r]>s&&(o+=(e[r]-s)*(e[r]-s)),t[r]<s&&(o+=(s-t[r])*(s-t[r]))}return o},t.c0=M_,t.c1=$v,t.c2=Zb,t.c3=lw,t.c4=eA,t.c5=Y,t.c6=pe,t.c7=be,t.c8=function(e,t,r){r*=.5;var o=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(r),u=Math.cos(r);return e[0]=o*u+s*h,e[1]=s*u-o*h,e[2]=l*u+c*h,e[3]=c*u-l*h,e},t.c9=we,t.cA=B,t.cB=bc,t.cC=by,t.cD=Yc,t.cE=$p,t.cF=function(e,t,r,o,s,l,c,h,u){if("globe"===u.name)return $p(e,t,new Yc(r,o,s),!1);const d=bw({z:r,x:o,y:s},u);return new wc([(l+d.x/d.scale)*t,t*(d.y/d.scale),c],[(l+d.x2/d.scale)*t,t*(d.y2/d.scale),h])},t.cG=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},t.cH=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},t.cI=function(e){const t=Math.round((e+45+360)%360/90)%4;return nt[t]},t.cJ=zd,t.cK=me,t.cL=6,t.cM=function(e){const t=p(new Float64Array(16));m(t,e.pixelMatrix,e.globeMatrix);const r=[0,md,0],o=[0,_d,0];return se(r,r,t),se(o,o,t),[r[0]>0&&r[0]<=e.width&&r[1]>0&&r[1]<=e.height&&!of(e,new Bu(e.center.lat,90)),o[0]>0&&o[0]<=e.width&&o[1]>0&&o[1]<=e.height&&!of(e,new Bu(e.center.lat,-90))]},t.cN=function(e,t){const{scale:r}=e.tileTransform,o=r*Ao/(e.tileSize*Math.pow(2,t.zoom-e.tileID.overscaledZ+e.tileID.canonical.z));return function(e,t,r){var o=t[1],s=t[2],l=t[3],c=r[0],h=r[1];return e[0]=t[0]*c,e[1]=o*c,e[2]=s*h,e[3]=l*h,e}(new Float32Array(4),t.inverseAdjustmentMatrix,[o,o])},t.cO=wy,t.cP=F,t.cQ=vy,t.cR=function(e){const t=vy(e,!0);return s([],[t[0],t[1],t[4],t[5]])},t.cS=v,t.cT=mc,t.cU=E,t.cV=function(e){const{x:t,y:r}=e.point,{lng:o,lat:s}=e._center;return tf(t,r,e.worldSize,o,s)},t.cW=q,t.cX=rt,t.cY=Mp,t.cZ=gp,t.c_=5,t.ca=kt,t.cb=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},t.cc=O,t.cd=function(e,t,r,o,s){var l=1/Math.tan(t/2);if(e[0]=l/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0){var c=1/(o-s);e[10]=(s+o)*c,e[14]=2*s*o*c}else e[10]=-1,e[14]=-2*o;return e},t.ce=function(e,t,r,o,s,l,c){var h=1/(t-r),u=1/(o-s),d=1/(l-c);return e[0]=-2*h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*d,e[11]=0,e[12]=(t+r)*h,e[13]=(s+o)*u,e[14]=(c+l)*d,e[15]=1,e},t.cf=Ad,t.cg=function(e,t,r){e[4*t+0]=r[0],e[4*t+1]=r[1],e[4*t+2]=r[2],e[4*t+3]=r[3]},t.ch=Wl,t.ci=Kl,t.cj=Yl,t.ck=Jl,t.cl=ru,t.cm=Lw,t.cn=function(){var e=new o(4);return o!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},t.co=function(e,t,r){var o=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(r),u=Math.cos(r);return e[0]=o*u+l*h,e[1]=s*u+c*h,e[2]=o*-h+l*u,e[3]=s*-h+c*u,e},t.cp=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},t.cq=he,t.cr=function(e){var t=e[0],r=e[1],o=e[2],s=e[3];return Math.sqrt(t*t+r*r+o*o+s*s)},t.cs=Pe,t.ct=le,t.cu=Jc,t.cv=3,t.cw=2,t.cx=7,t.cy=6,t.cz=oe,t.d=function(e){return qt.API_TILEJSON_REGEX.test(e)},t.d$=class{constructor(e,t,r,o){this.context=e,this.format=o,this.size=r,this.texture=e.gl.createTexture();const[s,l,c]=this.size,{gl:h}=e;h.bindTexture(h.TEXTURE_3D,this.texture),e.pixelStoreUnpackFlipY.set(!1),e.pixelStoreUnpack.set(1),e.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in t&&t.data&&h.texImage3D(h.TEXTURE_3D,0,this.format,s,l,c,0,uy(this.format),dy(this.format),t.data)}bind(e,t){const{context:r}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_3D,this.texture),e!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,e),this.minFilter=e),t!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,t),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,t),this.wrapS=t)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}},t.d0=function(e){return e*e*e*e*e},t.d1=Td,t.d2=45,t.d3=Ql,t.d4=function(e,t,r){const o=Math.sqrt(e*e+t*t+r*r),s=o>0?Math.acos(r/o)*tt:0;let l=0!==e||0!==t?Math.atan2(-t,-e)*tt+90:0;return l<0&&(l+=360),[o,l,s]},t.d5=N,t.d6=Rt,t.d7=Fd,t.d8=j,t.d9=wc,t.dA=function(e){return e({pluginStatus:Jh,pluginURL:Qh}),iu.on("pluginStateChange",e),e},t.dB=tu,t.dC=class extends Zl{constructor(e){super(e),this.current=rd}set(e,t,r){if(this.fetchUniformLocation(e,t))for(let e=0;e<9;e++)if(r[e]!==this.current[e]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}},t.dD=ot,t.dE=function(e,t,r){const o=rf(r.zoom),s=e.style.map._antialias,l=e.terrain&&e.terrain.exaggeration()>0;return 0===o&&!s&&!l},t.dF=function(e){const t=e.pixelsPerMeter,r=t/Ad(1,e.center.lat),o=p(new Float64Array(16));return _(o,o,[e.point.x,e.point.y,0]),v(o,o,[r,r,t]),Float32Array.from(o)},t.dG=qp,t.dH=function(e){const t=80.051129;e=ct(e,-80.051129,t)/t*90;const r=Math.pow(Math.abs(Math.sin(it(e))),3);return Math.round(r*(fd.length-1))},t.dI=function(e,t,r,o){const s=t.getNorth(),l=t.getSouth(),c=t.getWest(),u=t.getEast(),d=1<<e.z,p=u-c,f=s-l,m=p/pd,_=-f/fd[r],v=[0,m,0,_,0,0,s,c,0];if(e.z>0){const e=180/o;h(v,v,[e/p+1,0,0,0,e/f+1,0,-.5*e/m,.5*e/_,1])}return v[2]=d,v[5]=e.x,v[8]=e.y,v},t.dJ=Up,t.dK=function(e,t,r){const o=p(new Float64Array(16)),s=(t/(1<<e)-.5)*Math.PI*2;return P(o,r.globeMatrix,s),Float32Array.from(o)},t.dL=Hh,t.dM=Lp,t.dN=function(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]},t.dO=l,t.dP=function(e,t){var r=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=r,e[2]=0,e[3]=-r,e[4]=o,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.dQ=ae,t.dR=ef,t.dS=jt,t.dT=Gt,t.dU=sT,t.dV=function(e,t){const r=[0,0,0];return se(r,r,Jp(Up(t.canonical))),se(r,r,e),r},t.dW=e=>({u_matrix:new ru(e),u_texsize:new Jl(e),u_pixels_to_tile_units:new su(e),u_device_pixel_ratio:new Yl(e),u_width_scale:new Yl(e),u_floor_width_scale:new Yl(e),u_image:new Wl(e),u_units_to_pixels:new Jl(e),u_tile_units_to_pixels:new Yl(e),u_alpha_discard_threshold:new Yl(e),u_trim_offset:new Jl(e),u_trim_fade_range:new Jl(e),u_trim_gradient_mix_range:new Jl(e),u_trim_color:new Ql(e),u_zbias_factor:new Yl(e),u_tile_to_meter:new Yl(e),u_ground_shadow_factor:new Kl(e),u_pattern_transition:new Yl(e)}),t.dX=e=>({u_matrix:new ru(e),u_pixels_to_tile_units:new su(e),u_device_pixel_ratio:new Yl(e),u_width_scale:new Yl(e),u_floor_width_scale:new Yl(e),u_units_to_pixels:new Jl(e),u_dash_image:new Wl(e),u_gradient_image:new Wl(e),u_image_height:new Yl(e),u_texsize:new Jl(e),u_tile_units_to_pixels:new Yl(e),u_alpha_discard_threshold:new Yl(e),u_trim_offset:new Jl(e),u_trim_fade_range:new Jl(e),u_trim_gradient_mix_range:new Jl(e),u_trim_color:new Ql(e),u_zbias_factor:new Yl(e),u_tile_to_meter:new Yl(e),u_ground_shadow_factor:new Kl(e)}),t.dY=e=>({u_camera_to_center_distance:new Yl(e),u_extrude_scale:new su(e),u_device_pixel_ratio:new Yl(e),u_matrix:new ru(e),u_inv_rot_matrix:new ru(e),u_merc_center:new Jl(e),u_tile_id:new Kl(e),u_zoom_transition:new Yl(e),u_up_dir:new Kl(e),u_emissive_strength:new Yl(e)}),t.dZ=al,t.d_=tv,t.da=$,t.db=function(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]},t.dc=hy,t.dd=Yy,t.de=iy,t.df=mT,t.dg=function(e,t){return e.readFields(RT,{icons:[]},t)},t.dh=Eg,t.di=Vx,t.dj=vb,t.dk=Oi,t.dl=Kh,t.dm=oi,t.dn=br,t.dp=Tt,t.dq=function(e){const t=e.indexOf(Ru);return t>=0?e.slice(0,t):e},t.dr=function(e){return e.indexOf(Ru)>=0},t.ds=function(e){const t=e.lastIndexOf(Ru);return t>=0?e.slice(t+1):""},t.dt=function(e){const t=[],r=e.id;return void 0===r&&t.push({message:`layers.${r}: missing required property "id"`}),void 0===e.render&&t.push({message:`layers.${r}: missing required method "render"`}),e.renderingMode&&"2d"!==e.renderingMode&&"3d"!==e.renderingMode&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},t.du=function(e,t,r,o){return"custom"===e.type?new Pb(e,t):new PT[e.type](e,t,r,o)},t.dv=wt,t.dw=function(e){const t=e.indexOf(Ru);return t>=0?e.slice(t+1):""},t.dx=class extends Wb{constructor(e,t){super(e._vectorTileFeature,e._z,e._x,e._y,e.id),e.state&&(this.state=Object.assign({},e.state)),this.target=t.target,this.namespace=t.namespace,t.properties&&(this.properties=t.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=e.source,this.sourceLayer=e.sourceLayer,this.layer=e.layer)}toJSON(){const e=super.toJSON();return e.target=this.target,e.namespace=this.namespace,e}},t.dy=iu,t.dz=Fi,t.e=qt,t.e$=U,t.e0=pf,t.e1=(e,t,r,o,s,l)=>{const c=e.transform,h="globe"===c.projection.name;let u;if("map"===l.paint.get("circle-pitch-alignment"))if(h){const e=ef(c.zoom,t.canonical)*c._pixelsPerMercatorPixel;u=Float32Array.from([e,0,0,e])}else u=c.calculatePixelsToTileUnitsMatrix(r);else u=new Float32Array([c.pixelsToGLUnits[0],0,0,c.pixelsToGLUnits[1]]);const d={u_camera_to_center_distance:e.transform.getCameraToCenterDistance(c.projection),u_matrix:e.translatePosMatrix(t.projMatrix,r,l.paint.get("circle-translate"),l.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ri.devicePixelRatio,u_extrude_scale:u,u_inv_rot_matrix:df,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:l.paint.get("circle-emissive-strength")};if(h){d.u_inv_rot_matrix=o,d.u_merc_center=s,d.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],d.u_zoom_transition=rf(c.zoom);const e=s[0]*Ao,r=s[1]*Ao;d.u_up_dir=c.projection.upVector(new Yc(0,0,0),e,r)}return d},t.e2=kx,t.e3=Or,t.e4=(e,t,r,o,s,l,c,h,u,d)=>{const p=e.transform,f=p.pitch<15?Ox(.07,.7,ct((14-p.zoom)/5,0,1)):.07,m="none"===r.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Bx(e,t,r,o),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:p.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:s,u_width_scale:l,u_floor_width_scale:c,u_image:0,u_tile_units_to_pixels:Fx(t,p),u_units_to_pixels:[1/p.pixelsToGLUnits[0],1/p.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:h,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_gradient_mix_range:[1,1],u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(m?null:r.lut).toArray01(),u_zbias_factor:f,u_tile_to_meter:Fd(t.tileID.canonical,0),u_ground_shadow_factor:u,u_pattern_transition:d}},t.e5=(e,t,r,o,s,l,c,h,u,d)=>{const p=e.transform,f=p.calculatePixelsToTileUnitsMatrix(t),m="none"===r.paint.get("line-trim-color-use-theme").constantOr("default"),_=p.pitch<15?Ox(.07,.7,ct((14-p.zoom)/5,0,1)):.07;return{u_matrix:Bx(e,t,r,o),u_pixels_to_tile_units:f,u_device_pixel_ratio:l,u_width_scale:c,u_floor_width_scale:h,u_units_to_pixels:[1/p.pixelsToGLUnits[0],1/p.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:s,u_texsize:Nx(r)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Fx(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:u,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_gradient_mix_range:[1,1],u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(m?null:r.lut).toArray01(),u_zbias_factor:_,u_tile_to_meter:Fd(t.tileID.canonical,0),u_ground_shadow_factor:d}},t.e6=xt,t.e7=Mf,t.e8=Rd,t.e9=Pp,t.eA=function(e,t){var o=2*Math.acos(t[3]),s=Math.sin(o/2);return s>r?(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s):(e[0]=1,e[1]=0,e[2]=0),o},t.eB=AT,t.eC=Oy,t.eD=My,t.eE=[1,1,1],t.eF=Rb,t.eG=fe,t.eH=function(e,t,r,o){var s=t[0],l=t[1],c=t[2],h=t[3];return e[0]=s+o*(r[0]-s),e[1]=l+o*(r[1]-l),e[2]=c+o*(r[2]-c),e[3]=h+o*(r[3]-h),e},t.eI=Ly,t.eJ=nl,t.eK=yl,t.eL=function(e,t,r,s,l,c,h,u,d,p,f,m,_,v,E,P){var C=new o(16);return C[0]=e,C[1]=t,C[2]=r,C[3]=s,C[4]=l,C[5]=c,C[6]=h,C[7]=u,C[8]=d,C[9]=p,C[10]=f,C[11]=m,C[12]=_,C[13]=v,C[14]=E,C[15]=P,C},t.eM=bd,t.eN=ml,t.eO=fl,t.eP=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Je(1/0,1/0),max:new Je(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(e,t=!1){const r=T_(new Je(0,0),new Je(Ao,Ao),e),o=[];if(t&&!b_(r,this._globalClipBounds))return o;for(const t of this._activeRegions){if(t.hiddenByOverlap)continue;if(!b_(r,t))continue;const s=S_(t.min,t.max,e);o.push({min:s.min,max:s.max,sourceId:this._sourceIds[t.priority],footprint:t.footprint,footprintTileId:t.tileId,order:t.order,clipMask:t.clipMask,clipScope:t.clipScope})}return o}setSources(e){this._setSources(e.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const t=[];for(const r of e.cache.getVisibleCoordinates()){const o=e.cache.getTile(r).buckets[e.layer];o&&o.updateFootprints(r.toUnwrapped(),t)}return t},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(e){const t=e.getFootprints();if(0===t.length)return;const r=e.getOrder(),o=e.getClipMask(),s=e.getClipScope();for(const e of t){if(!e.footprint)continue;const t=T_(e.footprint.min,e.footprint.max,e.id);this._activeRegions.push({min:t.min,max:t.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:e.id,footprint:e.footprint,order:r,clipMask:o,clipScope:s})}this._sourceIds.push(e.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,t)=>e.priority-t.priority||x_(e.min,t.min)||x_(e.max,t.max)||e.order-t.order||e.clipMask-t.clipMask||function(e,t){const r=(e,t)=>e+t;return e.length-t.length||e.reduce(r,"").localeCompare(t.reduce(r,""))}(e.clipScope,t.clipScope)));let e=this._activeRegions.length!==this._prevRegions.length;if(!e){let t=0;for(;!e&&t!==this._activeRegions.length;){const r=this._activeRegions[t],o=this._prevRegions[t];e=r.priority!==o.priority||!v_(r,o)||r.order!==o.order||r.clipMask!==o.clipMask||!Qe(r.clipScope,o.clipScope),this._activeRegions[t].hiddenByOverlap=o.hiddenByOverlap,++t}}if(e){++this._updateTime;for(const e of this._activeRegions)e.order!==__&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,e.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,e.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,e.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,e.max.y));const e=e=>{const t=this._activeRegions;if(e>=t.length)return e;const r=t[e].priority;for(;e<t.length&&t[e].priority===r;)++e;return e};if(this._sourceIds.length>1){let t=0,r=e(t);for(;t!==r;){let o=t;const s=t;for(;o!==r;){const e=this._activeRegions[o];e.hiddenByOverlap=!1;for(let t=0;t<s;t++){const r=this._activeRegions[t];if(!r.hiddenByOverlap&&e.order===__&&b_(e,r)&&(e.hiddenByOverlap=E_(e.footprint,e.tileId,r.footprint,r.tileId),e.hiddenByOverlap))break}++o}t=r,r=e(t)}}}}_setSources(e){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let t=e.length-1;t>=0;t--)this._addSource(e[t]);this._computeReplacement()}},t.eQ=__,t.eR=class{constructor(e){this._createGrid(e),this._createPoles(e)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const e of this._poleSegments)e.destroy();for(const e of this._gridSegments)e.withSkirts.destroy(),e.withoutSkirts.destroy()}_fillGridMeshWithLods(e,t){const r=new No,o=new ll,s=[],l=e+1+2,c=t[0]+1,h=t[0]+1+(1+t.length),u=(e,t,r)=>{let o=e===l-1?e-2:0===e?e:e-1;return o+=r?24575:0,[o,t]};for(let e=0;e<l;++e)r.emplaceBack(...u(e,0,!0));for(let e=0;e<c;++e)for(let t=0;t<l;++t)r.emplaceBack(...u(t,e,(0===t||t===l-1)&&!0));for(let e=0;e<t.length;++e){const o=t[e];for(let e=0;e<l;++e)r.emplaceBack(...u(e,o,!0))}for(let e=0;e<t.length;++e){const c=o.length,u=t[e]+1+2,d=new ll;for(let r=0;r<u-1;r++){const s=r===u-2,c=s?l*(h-t.length+e-r):l;for(let e=0;e<l-1;e++){const t=r*l+e;0===r||s||0===e||e===l-2?(d.emplaceBack(t+1,t,t+c),d.emplaceBack(t+c,t+c+1,t+1)):(o.emplaceBack(t+1,t,t+c),o.emplaceBack(t+c,t+c+1,t+1))}}const p=Ol.simpleSegment(0,c,r.length,o.length-c);for(let e=0;e<d.uint16.length;e+=3)o.emplaceBack(d.uint16[e],d.uint16[e+1],d.uint16[e+2]);const f=Ol.simpleSegment(0,c,r.length,o.length-c);s.push({withoutSkirts:p,withSkirts:f})}return{vertices:r,indices:o,segments:s}}_createGrid(e){const t=this._fillGridMeshWithLods(pd,fd);this._gridSegments=t.segments,this._gridBuffer=e.createVertexBuffer(t.vertices,Dp.members),this._gridIndexBuffer=e.createIndexBuffer(t.indices,!0)}_createPoles(e){const t=new ll;for(let e=0;e<=pd;e++)t.emplaceBack(0,e+1,e+2);this._poleIndexBuffer=e.createIndexBuffer(t,!0);const r=new pl,o=new pl,s=new pl,l=new pl;this._poleSegments=[];for(let e=0,t=0;e<5;e++){const c=360/(1<<e);r.emplaceBack(0,-dd,0,.5,0),o.emplaceBack(0,-dd,0,.5,1),s.emplaceBack(0,-dd,0,.5,.5),l.emplaceBack(0,-dd,0,.5,.5);for(let e=0;e<=pd;e++){let t=e/pd,h=0;const u=Ar(0,c,t),[d,p,f]=gd(af,hf,u,dd);r.emplaceBack(d,p,f,t,h),o.emplaceBack(d,p,f,t,1-h);const m=it(u);t=.5+.5*Math.sin(m),h=.5+.5*Math.cos(m),s.emplaceBack(d,p,f,t,h),l.emplaceBack(d,p,f,t,1-h)}this._poleSegments.push(Ol.simpleSegment(t,0,66,64)),t+=66}this._poleNorthVertexBuffer=e.createVertexBuffer(r,Rp,!1),this._poleSouthVertexBuffer=e.createVertexBuffer(o,Rp,!1),this._texturedPoleNorthVertexBuffer=e.createVertexBuffer(s,Rp,!1),this._texturedPoleSouthVertexBuffer=e.createVertexBuffer(l,Rp,!1)}getGridBuffers(e,t){return[this._gridBuffer,this._gridIndexBuffer,t?this._gridSegments[e].withSkirts:this._gridSegments[e].withoutSkirts]}getPoleBuffers(e,t){return[t?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,t?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[e]]}},t.eS=g_,t.eT=at,t.eU=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},t.eV=lt,t.eW=Od,t.eX=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},t.eY=de,t.eZ=yd,t.e_=ee,t.ea=mf,t.eb=og,t.ec=B_,t.ed=450,t.ee=7,t.ef=Ld,t.eg=function(e,t){if(e===t){var r=t[1],o=t[2],s=t[3],l=t[6],c=t[7],h=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=o,e[9]=l,e[11]=t[14],e[12]=s,e[13]=c,e[14]=h}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},t.eh=aT,t.ei=Uu,t.ej=wl,t.ek=256,t.el=Qp,t.em=Wo,t.en=P,t.eo=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},t.ep=pl,t.eq=ac,t.er=dl,t.es=function(e,t,r,o,s){return ct((e-t)/(r-t)*(s-o)+o,o,s)},t.et=Ie,t.eu=function(e,t){var r=t[0],o=t[1],s=t[2],l=t[3],c=t[4],h=t[5],u=t[6],d=t[7],p=t[8],f=p*c-h*d,m=-p*l+h*u,_=d*l-c*u,v=r*f+o*m+s*_;return v?(e[0]=f*(v=1/v),e[1]=(-p*o+s*d)*v,e[2]=(h*o-s*c)*v,e[3]=m*v,e[4]=(p*r-s*u)*v,e[5]=(-h*r+s*l)*v,e[6]=_*v,e[7]=(-d*r+o*u)*v,e[8]=(c*r-o*l)*v,e):null},t.ev=2,t.ew=te,t.ex=ve,t.ey=D,t.ez=function(e,t){var r=new o(3);D(r,t);var s=1/r[0],l=1/r[1],c=1/r[2],h=t[0]*s,u=t[1]*l,d=t[2]*c,p=t[4]*s,f=t[5]*l,m=t[6]*c,_=t[8]*s,v=t[9]*l,E=t[10]*c,P=h+f+E,C=0;return P>0?(C=2*Math.sqrt(P+1),e[3]=.25*C,e[0]=(m-v)/C,e[1]=(_-d)/C,e[2]=(u-p)/C):h>f&&h>E?(C=2*Math.sqrt(1+h-f-E),e[3]=(m-v)/C,e[0]=.25*C,e[1]=(u+p)/C,e[2]=(_+d)/C):f>E?(C=2*Math.sqrt(1+f-h-E),e[3]=(_-d)/C,e[0]=(u+p)/C,e[1]=.25*C,e[2]=(m+v)/C):(C=2*Math.sqrt(1+E-h-f),e[3]=(u-p)/C,e[0]=(_+d)/C,e[1]=(m+v)/C,e[2]=.25*C),e},t.f=function(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(Number("0x"+t)))))},t.f0=function([e,t,r]){const o=Math.hypot(e,t,r),s=Math.atan2(e,r),l=.5*Math.PI-Math.acos(-t/o);return new Bu(rt(s),rt(l))},t.f1=ge,t.f2=Sy,t.f3=function(e){const t=e.navigator?e.navigator.userAgent:null;return!!function(e){if(null==Bt){const t=e.navigator?e.navigator.userAgent:null;Bt=!!e.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return Bt}(e)&&!(!t||!(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},t.f4=function(e,t){ai=e,li=t},t.f5=of,t.f6=nf,t.f7=function(e){const t=[0,0,0],r=p(new Float64Array(16));return m(r,e.pixelMatrix,e.globeMatrix),se(t,t,r),new Je(t[0],t[1])},t.f8=function(){const e=Sg;e&&(e.isPreloaded()&&1===e.numActive()?(e.release(Tg),Sg=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},t.f9=function(){Eg().acquire(Tg)},t.fA=r_,t.fB=Qu,t.fC=function(e){let t=0;if(new Uint32Array(e,0,1)[0]!==ry){const r=new Uint32Array(e,0,7),[,,o,s,l,c]=r;t=r.byteLength+s+l+c+l,(o!==e.byteLength||t>=e.byteLength)&&Et("Invalid b3dm header information.")}return cy(e,t)},t.fD=function(e,t){const r=Yy(e);for(const e of r){for(const t of e.meshes)Jy(t);e.lights&&(e.lightMeshIndex=e.meshes.length,e.meshes.push(ex(e.lights,t)))}return r},t.fE=$b,t.fF=Dt,t.fG=Gf,t.fH=au,t.fI=Zh,t.fJ=function(e){pi(),null!=hi&&hi.then((t=>{t.keys().then((r=>{for(let o=0;o<r.length-e;o++)t.delete(r[o]).catch((e=>Et(e.message)))})).catch((e=>Et(e.message)))})).catch((e=>Et(e.message)))},t.fa=nu,t.fb=function(e,t,r=!1){if(Jh===Zh.deferred||Jh===Zh.loading||Jh===Zh.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");Qh=ri.resolveURL(e),Jh=Zh.deferred,Yh=t,eu(),r||ou()},t.fc=function(e){Rg=ri.resolveURL(e),Dg||(Dg=new Zf(Eg(),new ir)),Dg.broadcast("setMeshoptUrl",Rg)},t.fd=kg,t.fe=function(e){Pg=ri.resolveURL(e),Dg||(Dg=new Zf(Eg(),new ir)),Dg.broadcast("setDracoUrl",Pg)},t.ff=Bg,t.fg=bg,t.fh=function(e){const t=di();if(!t)return;const r=t.delete(si);e&&r.then((()=>e())).catch(e)},t.fi=Hf,t.fj=ih,t.fk=qh,t.fl=2,t.fm=Y_,t.fn=J_,t.fo=Wy,t.fp=Yd,t.fq="hd_road_elevation",t.fr=Mc,t.fs=bt,t.ft=kp,t.fu=mb,t.fv=1,t.fw=function(e,t,r,o,s,l,c,h=1,u,d,p,f){e.createArrays(),e.tilePixelRatio=Ao/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const m=e.layers[0].layout,_=e.layers[0]._unevaluatedLayout._values,v={};v.scaleFactor=h,v.textSizeScaleRange=m.get("text-size-scale-range"),v.iconSizeScaleRange=m.get("icon-size-scale-range");const[E,P]=v.textSizeScaleRange,[C,R]=v.iconSizeScaleRange;v.textScaleFactor=ct(v.scaleFactor,E,P),v.iconScaleFactor=ct(v.scaleFactor,C,R);const z=_["text-size"],D=_["icon-size"];if("composite"===e.textSizeData.kind){const{minZoom:t,maxZoom:r}=e.textSizeData;v.compositeTextSizes=[z.possiblyEvaluate(new Ja(t,{worldview:p}),l),z.possiblyEvaluate(new Ja(r,{worldview:p}),l)]}if("composite"===e.iconSizeData.kind){const{minZoom:t,maxZoom:r}=e.iconSizeData;v.compositeIconSizes=[D.possiblyEvaluate(new Ja(t,{worldview:p}),l,f),D.possiblyEvaluate(new Ja(r,{worldview:p}),l,f)]}v.layoutTextSize=z.possiblyEvaluate(new Ja(c+1,{worldview:p}),l),v.layoutIconSize=D.possiblyEvaluate(new Ja(c+1,{worldview:p}),l,f),v.textMaxSize=z.possiblyEvaluate(new Ja(18,{worldview:p}),l);const O=m.get("symbol-placement"),F="map"===m.get("text-rotation-alignment")&&"point"!==O,B=m.get("text-size");let k=!1;const V=[];for(const c of e.features){const h=m.get("text-font").evaluate(c,{},l).join(","),E=B.evaluate(c,{},l)*v.textScaleFactor,P=v.layoutTextSize.evaluate(c,{},l)*v.textScaleFactor,C=v.layoutIconSize.evaluate(c,{},l,f)*v.iconScaleFactor,R={horizontal:{},vertical:void 0},z=c.text;let D,N=[0,0];if(z){const o=z.toString(),d=m.get("text-letter-spacing").evaluate(c,{},l)*iv,p=m.get("text-line-height").evaluate(c,{},l)*iv,f=Fh(o)?d:0,_=m.get("text-anchor").evaluate(c,{},l),v=m.get("text-variable-anchor");if(!v){const e=m.get("text-radial-offset").evaluate(c,{},l);if(e)N=Zb(_,[e*iv,jb]);else{const e=m.get("text-offset").evaluate(c,{},l);N=[e[0]*iv,e[1]*iv]}}let C=F?"center":m.get("text-justify").evaluate(c,{},l);const D="point"===O,B=D?m.get("text-max-width").evaluate(c,{},l)*iv:1/0,k=l=>{e.allowVerticalPlacement&&Oh(o)&&(R.vertical=Pv(z,t,r,s,h,B,p,_,l,f,N,Mv.vertical,!0,P,E,u))};if(!F&&v){const e="auto"===C?v.map((e=>lw(e))):[C];let o=!1;for(let l=0;l<e.length;l++){const c=e[l];if(!R.horizontal[c])if(o)R.horizontal[c]=R.horizontal[0];else{const e=Pv(z,t,r,s,h,B,p,"center",c,f,N,Mv.horizontal,!1,P,E,u);e&&(R.horizontal[c]=e,o=1===e.positionedLines.length)}}k("left")}else{if("auto"===C&&(C=lw(_)),D||m.get("text-writing-mode").indexOf("horizontal")>=0||!Oh(o)){const e=Pv(z,t,r,s,h,B,p,_,C,f,N,Mv.horizontal,!1,P,E,u);e&&(R.horizontal[C]=e)}k(D?"left":C)}}let U,j,$,q,H,Z,Y=!1;const J=m.get("icon-text-fit").evaluate(c,{},l);if(c.icon&&c.icon.hasPrimary()){const t=rw(c.icon,e.iconSizeData,_["icon-size"],l,e.zoom,c,u,v.iconScaleFactor,p,f);U=t.iconPrimary,$=t.iconSecondary;const r=U.toString();if(j=o.get(r),j&&(H=m.get("icon-offset").evaluate(c,{},l),Z=m.get("icon-anchor").evaluate(c,{},l),D=Wv(s.get(r),$?s.get($.toString()):void 0,H,Z),Y=j.sdf,void 0===e.sdfIcons?e.sdfIcons=j.sdf:e.sdfIcons!==j.sdf&&Et("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(j.pixelRatio!==e.pixelRatio||0!==m.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0)),$){const e=$.toString();q=o.get(e)}}k=k||!(!c.icon||!c.icon.hasSecondary());const Q=_w(R.horizontal)||R.vertical;e.iconsInText||(e.iconsInText=!!Q&&Q.iconsInText);const K=P*v.textScaleFactor/iv,{defaultShapedIcon:ee,verticallyShapedIcon:te}=cw(e,D,m,c,l,R,K,H,J);"none"!==J&&D&&(Xv(D)||Yv(D))&&(tw(0,j,U,D,ee,J,d,o,s),tw(0,q,$,D,ee,J,d,o,s),te&&(tw(0,j,U,D,te,J,d,o,s),tw(0,q,$,D,te,J,d,o,s))),D=ee;const{iconBBox:ie,iconVerticalBBox:re,textBBox:ne,textVerticalBBox:oe}=Xb(e,D,te,m,c,l,C,H,v,s,Z,R,P,N,f);V.push({feature:c,shapedTextOrientations:R,shapedText:Q,shapedIcon:D,iconPrimary:U,iconSecondary:$,iconOffset:H,iconAnchor:Z,verticallyShapedIcon:te,layoutTextSize:P,layoutIconSize:C,textOffset:N,isSDFIcon:Y,iconTextFit:J,iconCollisionBounds:ie,iconVerticalCollisionBounds:re,textCollisionBounds:ne,textVerticalCollisionBounds:oe})}return{featureData:V,sizes:v,hasAnySecondaryIcon:k,textAlongLine:F,symbolPlacement:O}},t.fx=Px,t.fy=function(e,t,r,o,s,l,c,h,u,d){e.iconAtlasPositions=d.iconPositions;const{featureData:p,hasAnySecondaryIcon:f,sizes:m,textAlongLine:_,symbolPlacement:v}=t;for(const t of p){const{shapedIcon:r,verticallyShapedIcon:l,feature:p,shapedTextOrientations:E,shapedText:P,layoutTextSize:C,textOffset:R,isSDFIcon:z,iconPrimary:D,iconSecondary:O,iconTextFit:F,iconOffset:B,iconCollisionBounds:k,iconVerticalCollisionBounds:V,textCollisionBounds:N}=t;ow(r,d.iconPositions,D,O),ow(l,d.iconPositions,D,O),sw(E,d.iconPositions),nw(D,O,d.iconPositions),(P||r)&&uw(e,p,E,r,l,u,m,C,0,R,z,o,s,c,h,f,F,B,_,v,k,V,N)}r&&e.generateCollisionDebugBuffers(l,e.collisionBoxArray,m.textScaleFactor)},t.fz=ic,t.g=function(e,t){return Fi(Object.assign(e,{method:"GET"}),t)},t.h=function(e){return 0===e.indexOf("mapbox:")},t.i=function(e){return qt.API_STYLE_REGEX.test(e)&&!Wt(e)},t.j=Ht,t.k=mi,t.l=function(e){return decodeURIComponent(atob(e).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},t.m=function(e,t){return Fi(Object.assign(e,{type:"json"}),t)},t.n=ar,t.o=ri,t.p=function(e,t){return Fi(Object.assign(e,{method:"POST"}),t)},t.q=Xh,t.r=ii,t.s=function(e){try{const t=self[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch(e){return!1}},t.t=function(){return Ig||(Ig=new Hf("ImageRasterizer")),Ig},t.u=function(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()},t.v=function(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},t.w=Et,t.x=$w,t.y=er,t.z=tr}));s(["./shared"],(function(t){function r(e){const t=e?e.url.toString():void 0;return t?performance.getEntriesByName(t):[]}function o(e){if("number"==typeof e||"boolean"==typeof e||"string"==typeof e||null==e)return JSON.stringify(e);if(Array.isArray(e)){let t="[";for(const r of e)t+=`${o(r)},`;return`${t}]`}let t="{";for(const r of Object.keys(e).sort())t+=`${r}:${o(e[r])},`;return`${t}}`}function s(e){let r="";for(const s of t.bx)r+=`/${o(e[s])}`;return r}function l(e,t){return function e(r){return"string"==typeof r&&r===t||(Array.isArray(r)?r.some(e):!(!r||"object"!=typeof r)&&Object.values(r).some(e))}(e)}class n{constructor(e){this.keyCache={},this._layers={},this._layerConfigs={},e&&this.replace(e)}replace(e,t){this._layerConfigs={},this._layers={},this.update(e,[],t)}update(e,r,c){this._options=c;for(const r of e)this._layerConfigs[r.id]=r,(this._layers[r.id]=t.du(r,this.scope,null,this._options)).compileFilter(c),this.keyCache[r.id]&&delete this.keyCache[r.id];for(const e of r)delete this.keyCache[e],delete this._layerConfigs[e],delete this._layers[e];this.familiesBySource={};const h=function(e,t){const r={};for(let c=0;c<e.length;c++){const h=e[c];let u=t&&t[h.id];u||("symbol"===h.type?u=h.id:(u=s(h),"line"===h.type&&h.paint&&l(h.paint["line-width"],"line-progress")&&(u+=`/${o(h.paint["line-width"])}`))),t&&(t[h.id]=u);let d=r[u];d||(d=r[u]=[]),d.push(h)}const c=[];for(const e in r)c.push(r[e]);return c}(Object.values(this._layerConfigs),this.keyCache);for(const e of h){const t=e.map((e=>this._layers[e.id])),r=t[0];if("none"===r.visibility)continue;const o=r.source||"";let s=this.familiesBySource[o];s||(s=this.familiesBySource[o]={});const l=r.sourceLayer||"_geojsonTileLayer";let c=s[l];c||(c=s[l]=[]),c.push(t)}}}const c=1*t.fl;class a{constructor(e){const r={},o=[];for(const t in e){const s=e[t],l=r[t]={};for(const e in s.glyphs){const t=s.glyphs[+e];if(!t||0===t.bitmap.width||0===t.bitmap.height)continue;const r=t.metrics.localGlyph?c:1,h={x:0,y:0,w:t.bitmap.width+2*r,h:t.bitmap.height+2*r};o.push(h),l[e]=h}}const{w:s,h:l}=t.G(o),h=new t.fk({width:s||1,height:l||1});for(const o in e){const s=e[o];for(const e in s.glyphs){const l=s.glyphs[+e];if(!l||0===l.bitmap.width||0===l.bitmap.height)continue;const u=r[o][e],d=l.metrics.localGlyph?c:1;t.fk.copy(l.bitmap,h,{x:0,y:0},{x:u.x+d,y:u.y+d},l.bitmap)}}this.image=h,this.positions=r}}function h(e,t,r){e[t]?r&&(e[t].center=r):e[t]={floorIds:new Set,center:r||[0,0],floors:{}}}function u(e,t,r,o){for(const s of t)h(e,s),e[s].floors[r]=o,e[s].floorIds.add(r)}function d(e){return{id:e.properties.id.toString(),center:e.properties.center.toString().split(";").map(Number)}}function p(e){return{id:e.properties.id.toString(),isDefault:!!e.properties.is_default&&e.properties.is_default,connections:e.properties.connected_floor_ids?new Set(e.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:e.properties.conflicted_floor_ids?new Set(e.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:e.properties.building_ids?new Set(e.properties.building_ids.toString().split(";")):new Set,name:e.properties.name.toString(),zIndex:e.properties.z_index}}function f(e,t){return t.every((t=>e.properties&&null!=e.properties[t]))}function m(e){return f(e,["type","id","name"])&&"building"===e.properties.type}function _(e){return f(e,["type","id","name","z_index"])&&"floor"===e.properties.type}t.fj(a,"GlyphAtlas");class g{constructor(e){this.tileID=new t.aQ(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.lut=e.lut,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.scope=e.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.request&&e.request.collectResourceTiming,this.promoteId=e.promoteId,this.isSymbolTile=e.isSymbolTile,this.tileTransform=t.aZ(e.tileID.canonical,e.projection),this.projection=e.projection,this.worldview=e.worldview,this.localizableLayerIds=e.localizableLayerIds,this.brightness=e.brightness,this.extraShadowCaster=!!e.extraShadowCaster,this.tessellationStep=e.tessellationStep,this.scaleFactor=e.scaleFactor,this.worldview=e.worldview,this.indoor=e.indoor}parse(e,r,o,s,l,c){this.status="parsing",this.data=e,this.collisionBoxArray=new t.b3;const f=new t.fm(Object.keys(e.layers).sort()),E=new t.fn(this.tileID,this.promoteId);E.bucketLayerIDs=[];const P={},C=new t.fo(256,256),R={featureIndex:E,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:C,availableImages:o,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const r=this.indoor.indoorState.activeFloorsVisible,o=function(e,r,o){const s=function(e,r){if(!e)return t.w("No source layers defined in indoor specification"),r;if(0===e.size)return r;const o=e.difference(r);for(const e of o)t.w(`Missing source layer required in indoor specification: ${e}`);return r.intersection(r)}(r.sourceLayers,new Set(Object.keys(e.layers))),l=r.indoorState,c=function(e,r,o,s){const l=new Set,c=new Set,f=new Set,v=new Map,E={},P=e=>{const t=v.get(e)||new Set;for(const r of l)if((v.get(r)||new Set).has(e)||t.has(r))return!0;return!1};for(const o of r){const r=e.layers[o];if(r)for(let e=0;e<r.length;e++){const t=r.feature(e);if(m(t)){const{id:e,center:r}=d(t);h(E,e,r),l.add(e)}else if(_(t)){const{id:e,isDefault:r,connections:o,conflicts:h,buildings:d,name:m,zIndex:_}=p(t);u(E,d,e,{name:m,zIndex:_}),v.set(e,h),(e===s||o.has(s))&&l.add(e),c.add(e),r&&f.add(e)}}else t.w(`indoor source layer not found: ${o}`)}if(o)for(const e of o)c.has(e)&&(P(e)||l.add(e));for(const e of f)l.has(e)||P(e)||l.add(e);return{buildings:E,activeFloors:l}}(e,s,l.lastActiveFloors,l.selectedFloorId);return o.send("setIndoorData",c),c}(e,this.indoor,l);R.activeFloors=r?o.activeFloors:void 0}const z=[],D=r.familiesBySource[this.source];for(const r in D){const l=e.layers[r];if(!l)continue;let c=!1,h=!1,u=!1;for(const e of D[r])"symbol"===e[0].type?c=!0:h=!0,e[0].is3D()&&"model"!==e[0].type&&(u=!0);if(this.extraShadowCaster&&!u)continue;if(!0===this.isSymbolTile&&!c)continue;if(!1===this.isSymbolTile&&!h)continue;1===l.version&&t.w(`Vector tile source "${this.source}" layer "${r}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const d=f.encode(r),p=[],m=this.localizableLayerIds&&this.localizableLayerIds.has(r);let _=!1;for(let e=0,o=0;e<l.length;e++){const s=l.feature(e),c=E.getId(s,r),h=s.properties?s.properties.worldview:null;if(m&&this.worldview&&"string"==typeof h)if("all"===h)s.properties.$localized=!0;else{if(!h.split(",").includes(this.worldview))continue;s.properties.$localized=!0,s.properties.worldview=this.worldview}!_&&s.properties&&s.properties.hasOwnProperty(t.fp)&&(_=!0),p.push({feature:s,id:c,index:o,sourceLayerIndex:d}),o++}_&&!R.elevationFeatures&&e.layers.hasOwnProperty(t.fq)&&(R.elevationFeatures=t.fr.parseFrom(e.layers[t.fq],this.canonical));for(const e of D[r]){const r=e[0];if(this.extraShadowCaster&&(!r.is3D()||"model"===r.type))continue;if(void 0!==this.isSymbolTile&&"symbol"===r.type!==this.isSymbolTile)continue;if(r.minzoom&&this.zoom<Math.floor(r.minzoom))continue;if(r.maxzoom&&this.zoom>=r.maxzoom)continue;if("none"===r.visibility)continue;v(e,this.zoom,R.brightness,o,this.worldview);const l=P[r.id]=r.createBucket({index:E.bucketLayerIDs.length,layers:e,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:d,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:s,worldview:this.worldview,localizable:m,availableImages:o});E.bucketLayerIDs.push(e.map((e=>t.B(e.id,e.scope))));let c=l.prepare?l.prepare():null;null!=c?(c=c.then((()=>l.populate(p,R,this.tileID.canonical,this.tileTransform))),z.push(c)):l.populate(p,R,this.tileID.canonical,this.tileTransform)}}const O=()=>{let r,s,h,u,d,p;C.trim();const m={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},_=()=>{if(r)return this.status="done",c(r);if(this.extraShadowCaster)this.status="done",c(null,{buckets:Object.values(P).filter((e=>!e.isEmpty())),featureIndex:E,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:R.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(s&&h&&u){const e=new a(s),r=new Map;for(const[e,o]of h.entries()){const{imagePosition:s}=t.fu(e,o,t.fv);r.set(e,s)}const c={};for(const l in P){const u=P[l];u instanceof t.b4&&(v(u.layers,this.zoom,R.brightness,o,this.worldview),c[l]=t.fw(u,s,e.positions,h,r,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,d,this.worldview,o))}const f={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(l,h,d,(()=>{f.iconsPending=!1,z(c,e,f)})),this.rasterizeIfNeeded(l,u,p,(()=>{f.patternsPending=!1,z(c,e,f)}))}},z=(e,r,s,l)=>{if(s.iconsPending||s.patternsPending)return;const d=new t.fx(h,u,this.lut);for(const r in P){const s=P[r];if(r in e)t.fy(s,e[r],this.showCollisionBoxes,o,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,h,d);else if(s.hasPattern&&(s instanceof t.ba||s instanceof t.bb||s instanceof t.ea)){v(s.layers,this.zoom,R.brightness,o,this.worldview);const e=Object.fromEntries(d.patternPositions);s.addFeatures(R,this.tileID.canonical,e,o,this.tileTransform,this.brightness)}}this.status="done",c(null,{buckets:Object.values(P).filter((e=>!e.isEmpty())),featureIndex:E,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:r.image,lineAtlas:C,imageAtlas:d,brightness:R.brightness})};if(!this.extraShadowCaster){const e=t.fs(R.glyphDependencies,(e=>Object.keys(e).map(Number)));Object.keys(e).length?l.send("getGlyphs",{uid:this.uid,stacks:e},((e,t)=>{r||(r=e,s=t,_())}),void 0,!1,m):s={};const o=Array.from(R.iconDependencies.keys()).map((e=>t.I.parse(e)));o.length?l.send("getImages",{images:o,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((e,t)=>{r||(r=e,h=new Map,d=this.updateImageMapAndGetImageTaskQueue(h,t,R.iconDependencies),_())}),void 0,!1,m):(h=new Map,d=new Map);const c=Array.from(R.patternDependencies.keys()).map((e=>t.I.parse(e)));c.length?l.send("getImages",{images:c,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((e,t)=>{r||(r=e,u=new Map,p=this.updateImageMapAndGetImageTaskQueue(u,t,R.patternDependencies),_())}),void 0,!1,m):(u=new Map,p=new Map)}if(R.elevationFeatures&&R.elevationFeatures.length>0){const r=[];for(const e of Object.values(P))if(e instanceof t.bb){const t=e.getUnevaluatedPortalGraph();t&&r.push(t)}const o=t.ft.evaluate(r);for(const r of Object.values(P))if(r instanceof t.bb){const t=e.layers[f.decode(r.sourceLayerIndex)];r.setEvaluatedPortalGraph(o,t,this.tileID.canonical,R.availableImages,R.brightness)}}_()};z.length>0?Promise.allSettled(z).then(O).catch(c):O()}updateParameters(e){this.scaleFactor=e.scaleFactor,this.showCollisionBoxes=e.showCollisionBoxes,this.projection=e.projection,this.brightness=e.brightness,this.tileTransform=t.aZ(e.tileID.canonical,e.projection),this.extraShadowCaster=e.extraShadowCaster,this.lut=e.lut,this.worldview=e.worldview,this.indoor=e.indoor}rasterizeIfNeeded(e,t,r,o){Array.from(t.values()).some((e=>e.usvg))?this.rasterize(e,t,r,o):o()}updateImageMapAndGetImageTaskQueue(e,t,r){const o=new Map;for(const s of t.keys()){const l=r.get(s)||[];for(const r of l){const s=r.toString(),l=t.get(r.id.toString());l.usvg?o.has(s)||(o.set(s,r),e.set(s,Object.assign({},l))):e.set(s,l)}}return o}rasterize(e,t,r,o){this.rasterizeTask=e.send("rasterizeImages",{scope:this.scope,tasks:r},((e,r)=>{if(!e)for(const[e,o]of r.entries()){const r=Object.assign(t.get(e),{data:o});t.set(e,r)}o()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function v(e,r,o,s,l){const c=new t.ac(r,{brightness:o,worldview:l});for(const t of e)t.recalculate(c,s)}class y extends t.E{constructor(e,r,o,s,l,c,h){super(),this.actor=e,this.layerIndex=r,this.availableImages=o,this.availableModels=s,this.loadVectorData=c||t.aL,this.loading={},this.loaded={},this.deduped=new t.aK(e.scheduler),this.isSpriteLoaded=l,this.scheduler=e.scheduler,this.brightness=h}loadTile(e,o){const s=e.uid,l=e&&e.request,c=l&&l.collectResourceTiming,h=this.loading[s]=new g(e);h.abort=this.loadVectorData(e,((u,d)=>{const p=!this.loading[s];if(delete this.loading[s],h.cancelRasterize(),p||u||!d)return h.status="done",p||(this.loaded[s]=h),o(u);const f=d.rawData,m={},_=t.aM(d.responseHeaders);_&&_.expires&&(m.expires=_.expires),_&&_.cacheControl&&(m.cacheControl=_.cacheControl),h.vectorTile=d.vectorTile||new t.fz(new t.bt(f));const v=()=>{h.parse(h.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((e,t)=>{if(e||!t)return o(e);const s={};if(c){const e=r(l);e.length>0&&(s.resourceTiming=JSON.parse(JSON.stringify(e)))}o(null,Object.assign({rawTileData:f.slice(0),responseHeaders:d.responseHeaders},t,m,s))}))};this.isSpriteLoaded?v():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(v,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):v()})),this.loaded=this.loaded||{},this.loaded[s]=h}))}reloadTile(e,t){const r=this.loaded,o=e.uid;if(r&&r[o]){const s=r[o];s.updateParameters(e);const l=(e,r)=>{const o=s.reloadCallback;o&&(delete s.reloadCallback,s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,o)),t(e,r)};"parsing"===s.status?s.reloadCallback=l:"done"===s.status&&(s.vectorTile?s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,l):l())}else t(null,void 0)}abortTile(e,t){const r=e.uid,o=this.loading[r];o&&(o.abort&&o.abort(),delete this.loading[r]),t()}removeTile(e,t){const r=this.loaded,o=e.uid;r&&r[o]&&delete r[o],t()}}class w{loadTile(e,r){const{uid:o,encoding:s,rawImageData:l,padding:c}=e,h=ImageBitmap&&l instanceof ImageBitmap?this.getImageData(l,c):l;r(null,new t.fA(o,h,s,c<1))}reloadTile(e,t){t(null,null)}abortTile(e,t){t()}removeTile(e,t){t()}getImageData(e,t){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(e.width,e.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=e.width,this.offscreenCanvas.height=e.height,this.offscreenCanvasContext.drawImage(e,0,0,e.width,e.height);const r=this.offscreenCanvasContext.getImageData(-t,-t,e.width+2*t,e.height+2*t);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),r}}t.bs.setPbf(t.bt);class b{constructor(e){this._mrt=new t.bs(e.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=e.uid,this.tileID=e.tileID,this.source=e.source}parse(e,r){const o=this._mrt;this.status="parsing",this._entireBuffer=e;try{o.parseHeader(e),this._isHeaderLoaded=!0;const s=[];for(const r in o.layers){const l=o.getLayer(r),c=l.getDataRange(l.getBandList()),h=o.createDecodingTask(c),u=e.slice(c.firstByte,c.lastByte+1),d=t.bs.performDecoding(u,h).then((e=>h.complete(null,e))).catch((e=>h.complete(e,null)));s.push(d)}Promise.allSettled(s).then((()=>r(null,o))).catch((e=>r(e)))}catch(e){r(e)}}}class x{constructor(e){this.actor=e,this.loading={},this.loaded={}}loadTile(e,r){const o=e.uid,s=e.request,l=this.loading[o]=new b(e),{cancel:c}=t.bu(s,((e,t,s)=>{const c=!this.loading[o];if(delete this.loading[o],c||e||!t)return l.status="done",c||(this.loaded[o]=l),r(e);l.parse(t,((e,t)=>{if(e||!t)return r(e);r(null,t,s)})),this.loaded[o]=l}));l.abort=c}reloadTile(e,t){t(null,void 0)}abortTile(e,t){const r=e.uid,o=this.loading[r];o&&(o.abort&&o.abort(),delete this.loading[r]),t()}removeTile(e,t){const r=e.uid;this.loaded[r]&&delete this.loaded[r],t()}decodeRasterArray(e,r){t.bs.performDecoding(e.buffer,e.task).then((e=>r(null,e))).catch((e=>r(e)))}}const E=t.fB.prototype.toGeoJSON;class I{constructor(e){this._feature=e,this.extent=t.al,this.type=e.type,this.properties=e.tags,"id"in e&&!isNaN(e.id)&&(this.id=parseInt(e.id,10))}loadGeometry(){if(1===this._feature.type){const e=[];for(const r of this._feature.geometry)e.push([new t.P(r[0],r[1])]);return e}{const e=[];for(const r of this._feature.geometry){const o=[];for(const e of r)o.push(new t.P(e[0],e[1]));e.push(o)}return e}}toGeoJSON(e,t,r){return E.call(this,e,t,r)}}class S{constructor(e,r){this.name=e,this.extent=t.al,this.length=r.length,this._jsonFeatures=r}feature(e){return new I(this._jsonFeatures[e])}}class M{constructor(e){this.layers={},this.extent=t.al;for(const t of Object.keys(e))this.layers[t]=new S(t,e[t])}}const P=64/4096;class T{constructor(){this.features=new Map}clear(){this.features.clear()}load(e=[],t){for(const r of e){const e=r.id;if(null==e)continue;let o=this.features.get(e);o&&this.updateCache(o,t),r.geometry?(o=R(r),this.updateCache(o,t),this.features.set(e,o)):this.features.delete(e),this.updateCache(o,t)}}updateCache(e,t){for(const{canonical:r,uid:o}of Object.values(t)){const{z:s,x:l,y:c}=r;C(e,Math.pow(2,s),l,c)&&delete t[o]}}getTile(e,t,r){const o=Math.pow(2,e),s=[];for(const e of this.features.values())C(e,o,t,r)&&s.push(F(e,o,t,r));return{features:s}}getFeatures(){return[...this.features.values()]}}function C({minX:e,minY:t,maxX:r,maxY:o},s,l,c){return e<(l+1+P)/s&&t<(c+1+P)/s&&r>(l-P)/s&&o>(c-P)/s}function R(e){const{id:t,geometry:r,properties:o}=e;if(!r)return;if("GeometryCollection"===r.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:s,coordinates:l}=r,c={id:t,type:1,geometry:[],tags:o,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},h=c.geometry;if("Point"===s)z(l,h,c);else if("MultiPoint"===s)for(const e of l)z(e,h,c);else if("LineString"===s)c.type=2,D(l,h,c);else if("MultiLineString"===s)c.type=2,O(l,h,c);else if("Polygon"===s)c.type=3,O(l,h,c,!0);else{if("MultiPolygon"!==s)throw new Error("Input data is not a valid GeoJSON object.");c.type=3;for(const e of l)O(e,h,c,!0)}return c}function z([e,r],o,s){const l=t.aF(e);let c=t.aJ(r);c=c<0?0:c>1?1:c,o.push(l,c),s.minX=Math.min(s.minX,l),s.minY=Math.min(s.minY,c),s.maxX=Math.max(s.maxX,l),s.maxY=Math.max(s.maxY,c)}function D(e,t,r,o=!1,s=!1){const l=[];for(const t of e)z(t,l,r);t.push(l),o&&function(e,t){let r=0;for(let t=0,o=e.length,s=o-2;t<o;s=t,t+=2)r+=(e[t]-e[s])*(e[t+1]+e[s+1]);if(r>0===t)for(let t=0,r=e.length;t<r/2;t+=2){const o=e[t],s=e[t+1];e[t]=e[r-2-t],e[t+1]=e[r-1-t],e[r-2-t]=o,e[r-1-t]=s}}(l,s)}function O(e,t,r,o=!1){for(let s=0;s<e.length;s++)D(e[s],t,r,o,0===s)}function F(e,r,o,s){const{id:l,type:c,geometry:h,tags:u}=e,d=[];if(1===c)!function(e,r,o,s,l){for(let c=0;c<e.length;c+=2){const h=Math.round(t.al*(e[c+0]*r-o)),u=Math.round(t.al*(e[c+1]*r-s));l.push([h,u])}}(h,r,o,s,d);else if(2===c)for(const e of h)B(e,r,o,s,d);else if(3===c)for(const e of h)k(e,r,o,s,d);return{id:l,type:c,geometry:d,tags:u}}function B(e,r,o,s,l){const c=-128,h=t.al+128;let u;for(let d=0;d<e.length-2;d+=2){let p=Math.round(t.al*(e[d+0]*r-o)),f=Math.round(t.al*(e[d+1]*r-s)),m=Math.round(t.al*(e[d+2]*r-o)),_=Math.round(t.al*(e[d+3]*r-s));const v=m-p,E=_-f;p<c&&m<c||(p<c?(f+=Math.round(E*((c-p)/v)),p=c):m<c&&(_=f+Math.round(E*((c-p)/v)),m=c),f<c&&_<c||(f<c?(p+=Math.round(v*((c-f)/E)),f=c):_<c&&(m=p+Math.round(v*((c-f)/E)),_=c),p>=h&&m>=h||(p>=h?(f+=Math.round(E*((h-p)/v)),p=h):m>=h&&(_=f+Math.round(E*((h-p)/v)),m=h),f>=h&&_>=h||(f>=h?(p+=Math.round(v*((h-f)/E)),f=h):_>=h&&(m=p+Math.round(v*((h-f)/E)),_=h),u&&p===u[u.length-1][0]&&f===u[u.length-1][1]||(u=[[p,f]],l.push(u)),u.push([m,_])))))}}function k(e,r,o,s,l){const c=(o-P)/r,h=(s-P)/r,u=(o+1+P)/r,d=(s+1+P)/r;function p(e,t){let r=0;return e<c?r|=1:e>u&&(r|=2),t<h?r|=4:t>d&&(r|=8),r}let f=[];for(let t=1;t<=8;t*=2){let r=e[e.length-2],o=e[e.length-1],s=!(p(r,o)&t);for(let l=0;l<e.length;l+=2){const m=e[l],_=e[l+1],v=!(p(m,_)&t);v!==s&&(8&t?f.push(r+(m-r)*(d-o)/(_-o),d):4&t?f.push(r+(m-r)*(h-o)/(_-o),h):2&t?f.push(u,o+(_-o)*(u-r)/(m-r)):1&t&&f.push(c,o+(_-o)*(c-r)/(m-r))),v&&f.push(m,_),r=m,o=_,s=v}if(!(e=f).length||8===t)break;f=[]}const m=[];for(let e=0;e<f.length;e+=2)m.push([Math.round(t.al*(f[e]*r-o)),Math.round(t.al*(f[e+1]*r-s))]);m.length&&l.push(m)}function V({name:e,features:r},o){o.writeStringField(1,e),o.writeVarintField(5,t.al);const s=new Map,l=new Map,c={keys:s,values:l,feature:null};for(const e of r)c.feature=e,o.writeMessage(2,N,c);for(const e of s.keys())o.writeStringField(3,e);for(const e of l.keys())o.writeMessage(4,H,e)}function N(e,t){const r=e.feature;void 0!==r.id&&Number.isSafeInteger(+r.id)&&t.writeVarintField(1,+r.id),r.tags&&t.writeMessage(2,U,e),t.writeVarintField(3,r.type),t.writeMessage(4,q,r)}function U({keys:e,values:t,feature:r},o){for(const s of Object.keys(r.tags)){let l=r.tags[s];if(null===l)continue;let c=e.get(s);void 0===c&&(c=e.size,e.set(s,c)),o.writeVarint(c);const h=typeof l;"string"!==h&&"boolean"!==h&&"number"!==h&&(l=JSON.stringify(l));let u=t.get(l);void 0===u&&(u=t.size,t.set(l,u)),o.writeVarint(u)}}function j(e,t){return(t<<3)+(7&e)}function $(e){return e<<1^e>>31}function q(e,t){const{geometry:r,type:o}=e;let s=0,l=0;if(1===o){t.writeVarint(j(1,r.length));for(const e of r){const r=e[0]-s,o=e[1]-l;t.writeVarint($(r)),t.writeVarint($(o)),s+=r,l+=o}}else for(const e of r){if(0===e.length)continue;t.writeVarint(j(1,1));const r=e.length-(3===o?1:0);for(let o=0;o<r;o++){1===o&&t.writeVarint(j(2,r-1));const c=e[o][0]-s,h=e[o][1]-l;t.writeVarint($(c)),t.writeVarint($(h)),s+=c,l+=h}3===o&&t.writeVarint(j(7,1))}}function H(e,t){const r=typeof e;"string"===r?t.writeStringField(1,e):"boolean"===r?t.writeBooleanField(7,e):"number"===r&&(e%1!=0?t.writeDoubleField(3,e):e<0?t.writeSVarintField(6,e):t.writeVarintField(5,e))}const Z={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},Y=Math.fround||(J=new Float32Array(1),e=>(J[0]=+e,J[0]));var J;class G{constructor(e){this.options=Object.assign(Object.create(Z),e),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){const{log:t,minZoom:r,maxZoom:o}=this.options;t&&console.time("total time");const s=`prepare ${e.length} points`;t&&console.time(s),this.points=e;const l=[];for(let t=0;t<e.length;t++){const r=e[t];if(!r.geometry)continue;const[o,s]=r.geometry.coordinates,c=Y(ee(o)),h=Y(te(s));l.push(c,h,1/0,t,-1,1),this.options.reduce&&l.push(0)}let c=this.trees[o+1]=this._createTree(l);t&&console.timeEnd(s);for(let e=o;e>=r;e--){const r=+Date.now();c=this.trees[e]=this._createTree(this._cluster(c,e)),t&&console.log("z%d: %d clusters in %dms",e,c.numItems,+Date.now()-r)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let r=((e[0]+180)%360+360)%360-180;const o=Math.max(-90,Math.min(90,e[1]));let s=180===e[2]?180:((e[2]+180)%360+360)%360-180;const l=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)r=-180,s=180;else if(r>s){const e=this.getClusters([r,o,180,l],t),c=this.getClusters([-180,o,s,l],t);return e.concat(c)}const c=this.trees[this._limitZoom(t)],h=c.range(ee(r),te(l),ee(s),te(o)),u=c.data,d=[];for(const e of h){const t=this.stride*e;d.push(u[t+5]>1?Q(u,t,this.clusterProps):this.points[u[t+3]])}return d}getChildren(e){const t=this._getOriginId(e),r=this._getOriginZoom(e),o="No cluster with the specified id.",s=this.trees[r];if(!s)throw new Error(o);const l=s.data;if(t*this.stride>=l.length)throw new Error(o);const c=this.options.radius/(this.options.extent*Math.pow(2,r-1)),h=s.within(l[t*this.stride],l[t*this.stride+1],c),u=[];for(const t of h){const r=t*this.stride;l[r+4]===e&&u.push(l[r+5]>1?Q(l,r,this.clusterProps):this.points[l[r+3]])}if(0===u.length)throw new Error(o);return u}getLeaves(e,t,r){const o=[];return this._appendLeaves(o,e,t=t||10,r=r||0,0),o}getTile(e,t,r){const o=this.trees[this._limitZoom(e)],s=Math.pow(2,e),{extent:l,radius:c}=this.options,h=c/l,u=(r-h)/s,d=(r+1+h)/s,p={features:[]};return this._addTileFeatures(o.range((t-h)/s,u,(t+1+h)/s,d),o.data,t,r,s,p),0===t&&this._addTileFeatures(o.range(1-h/s,u,1,d),o.data,s,r,s,p),t===s-1&&this._addTileFeatures(o.range(0,u,h/s,d),o.data,-1,r,s,p),p.features.length?p:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const r=this.getChildren(e);if(t++,1!==r.length)break;e=r[0].properties.cluster_id}return t}_appendLeaves(e,t,r,o,s){const l=this.getChildren(t);for(const t of l){const l=t.properties;if(l&&l.cluster?s+l.point_count<=o?s+=l.point_count:s=this._appendLeaves(e,l.cluster_id,r,o,s):s<o?s++:e.push(t),e.length===r)break}return s}_createTree(e){const r=new t.c4(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let t=0;t<e.length;t+=this.stride)r.add(e[t],e[t+1]);return r.finish(),r.data=e,r}_addTileFeatures(e,t,r,o,s,l){for(const c of e){const e=c*this.stride,h=t[e+5]>1;let u,d,p;if(h)u=K(t,e,this.clusterProps),d=t[e],p=t[e+1];else{const r=this.points[t[e+3]];u=r.properties;const[o,s]=r.geometry.coordinates;d=ee(o),p=te(s)}const f={type:1,geometry:[[Math.round(this.options.extent*(d*s-r)),Math.round(this.options.extent*(p*s-o))]],tags:u};let m;m=h||this.options.generateId?t[e+3]:this.points[t[e+3]].id,void 0!==m&&(f.id=m),l.features.push(f)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const{radius:r,extent:o,reduce:s,minPoints:l}=this.options,c=r/(o*Math.pow(2,t)),h=e.data,u=[],d=this.stride;for(let r=0;r<h.length;r+=d){if(h[r+2]<=t)continue;h[r+2]=t;const o=h[r],p=h[r+1],f=e.within(h[r],h[r+1],c),m=h[r+5];let _=m;for(const e of f){const r=e*d;h[r+2]>t&&(_+=h[r+5])}if(_>m&&_>=l){let e,l=o*m,c=p*m,v=-1;const E=(r/d<<5)+(t+1)+this.points.length;for(const o of f){const u=o*d;if(h[u+2]<=t)continue;h[u+2]=t;const p=h[u+5];l+=h[u]*p,c+=h[u+1]*p,h[u+4]=E,s&&(e||(e=this._map(h,r,!0),v=this.clusterProps.length,this.clusterProps.push(e)),s(e,this._map(h,u)))}h[r+4]=E,u.push(l/_,c/_,1/0,E,-1,_),s&&u.push(v)}else{for(let e=0;e<d;e++)u.push(h[r+e]);if(_>1)for(const e of f){const r=e*d;if(!(h[r+2]<=t)){h[r+2]=t;for(let e=0;e<d;e++)u.push(h[r+e])}}}}return u}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,r){if(e[t+5]>1){const o=this.clusterProps[e[t+6]];return r?Object.assign({},o):o}const o=this.points[e[t+3]].properties,s=this.options.map(o);return r&&s===o?Object.assign({},s):s}}function Q(e,t,r){return{type:"Feature",id:e[t+3],properties:K(e,t,r),geometry:{type:"Point",coordinates:[(o=e[t],360*(o-.5)),ie(e[t+1])]}};var o}function K(e,t,r){const o=e[t+5],s=o>=1e4?`${Math.round(o/1e3)}k`:o>=1e3?Math.round(o/100)/10+"k":o,l=e[t+6],c=-1===l?{}:Object.assign({},r[l]);return Object.assign(c,{cluster:!0,cluster_id:e[t+3],point_count:o,point_count_abbreviated:s})}function ee(e){return e/360+.5}function te(e){const t=Math.sin(e*Math.PI/180),r=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return r<0?0:r>1?1:r}function ie(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}function re(e,t,r,o){let s=o;const l=t+(r-t>>1);let c,h=r-t;const u=e[t],d=e[t+1],p=e[r],f=e[r+1];for(let o=t+3;o<r;o+=3){const t=ne(e[o],e[o+1],u,d,p,f);if(t>s)c=o,s=t;else if(t===s){const e=Math.abs(o-l);e<h&&(c=o,h=e)}}s>o&&(c-t>3&&re(e,t,c,o),e[c+2]=s,r-c>3&&re(e,c,r,o))}function ne(e,t,r,o,s,l){let c=s-r,h=l-o;if(0!==c||0!==h){const u=((e-r)*c+(t-o)*h)/(c*c+h*h);u>1?(r=s,o=l):u>0&&(r+=c*u,o+=h*u)}return c=e-r,h=t-o,c*c+h*h}function oe(e,t,r,o){const s={id:e??null,type:t,geometry:r,tags:o,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===t||"MultiPoint"===t||"LineString"===t)se(s,r);else if("Polygon"===t)se(s,r[0]);else if("MultiLineString"===t)for(const e of r)se(s,e);else if("MultiPolygon"===t)for(const e of r)se(s,e[0]);return s}function se(e,t){for(let r=0;r<t.length;r+=3)e.minX=Math.min(e.minX,t[r]),e.minY=Math.min(e.minY,t[r+1]),e.maxX=Math.max(e.maxX,t[r]),e.maxY=Math.max(e.maxY,t[r+1])}function ae(e,t,r,o){if(!t.geometry)return;const s=t.geometry.coordinates;if(s&&0===s.length)return;const l=t.geometry.type,c=Math.pow(r.tolerance/((1<<r.maxZoom)*r.extent),2);let h=[],u=t.id;if(r.promoteId?u=t.properties[r.promoteId]:r.generateId&&(u=o||0),"Point"===l)le(s,h);else if("MultiPoint"===l)for(const e of s)le(e,h);else if("LineString"===l)ce(s,h,c,!1);else if("MultiLineString"===l){if(r.lineMetrics){for(const r of s)h=[],ce(r,h,c,!1),e.push(oe(u,"LineString",h,t.properties));return}he(s,h,c,!1)}else if("Polygon"===l)he(s,h,c,!0);else{if("MultiPolygon"!==l){if("GeometryCollection"===l){for(const s of t.geometry.geometries)ae(e,{id:u,geometry:s,properties:t.properties},r,o);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const e of s){const t=[];he(e,t,c,!0),h.push(t)}}e.push(oe(u,l,h,t.properties))}function le(e,t){t.push(ue(e[0]),de(e[1]),0)}function ce(e,t,r,o){let s,l,c=0;for(let r=0;r<e.length;r++){const h=ue(e[r][0]),u=de(e[r][1]);t.push(h,u,0),r>0&&(c+=o?(s*u-h*l)/2:Math.sqrt(Math.pow(h-s,2)+Math.pow(u-l,2))),s=h,l=u}const h=t.length-3;t[2]=1,re(t,0,h,r),t[h+2]=1,t.size=Math.abs(c),t.start=0,t.end=t.size}function he(e,t,r,o){for(let s=0;s<e.length;s++){const l=[];ce(e[s],l,r,o),t.push(l)}}function ue(e){return e/360+.5}function de(e){const t=Math.sin(e*Math.PI/180),r=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return r<0?0:r>1?1:r}function pe(e,t,r,o,s,l,c,h){if(o/=t,l>=(r/=t)&&c<o)return e;if(c<r||l>=o)return null;const u=[];for(const t of e){const e=t.geometry;let l=t.type;const c=0===s?t.minX:t.minY,d=0===s?t.maxX:t.maxY;if(c>=r&&d<o){u.push(t);continue}if(d<r||c>=o)continue;let p=[];if("Point"===l||"MultiPoint"===l)fe(e,p,r,o,s);else if("LineString"===l)me(e,p,r,o,s,!1,h.lineMetrics);else if("MultiLineString"===l)ye(e,p,r,o,s,!1);else if("Polygon"===l)ye(e,p,r,o,s,!0);else if("MultiPolygon"===l)for(const t of e){const e=[];ye(t,e,r,o,s,!0),e.length&&p.push(e)}if(p.length){if(h.lineMetrics&&"LineString"===l){for(const e of p)u.push(oe(t.id,l,e,t.tags));continue}"LineString"!==l&&"MultiLineString"!==l||(1===p.length?(l="LineString",p=p[0]):l="MultiLineString"),"Point"!==l&&"MultiPoint"!==l||(l=3===p.length?"Point":"MultiPoint"),u.push(oe(t.id,l,p,t.tags))}}return u.length?u:null}function fe(e,t,r,o,s){for(let l=0;l<e.length;l+=3){const c=e[l+s];c>=r&&c<=o&&xe(t,e[l],e[l+1],e[l+2])}}function me(e,t,r,o,s,l,c){let h=ge(e);const u=0===s?ve:be;let d,p,f=e.start;for(let m=0;m<e.length-3;m+=3){const _=e[m],v=e[m+1],E=e[m+2],P=e[m+3],C=e[m+4],R=0===s?_:v,z=0===s?P:C;let D=!1;c&&(d=Math.sqrt(Math.pow(_-P,2)+Math.pow(v-C,2))),R<r?z>r&&(p=u(h,_,v,P,C,r),c&&(h.start=f+d*p)):R>o?z<o&&(p=u(h,_,v,P,C,o),c&&(h.start=f+d*p)):xe(h,_,v,E),z<r&&R>=r&&(p=u(h,_,v,P,C,r),D=!0),z>o&&R<=o&&(p=u(h,_,v,P,C,o),D=!0),!l&&D&&(c&&(h.end=f+d*p),t.push(h),h=ge(e)),c&&(f+=d)}let m=e.length-3;const _=e[m],v=e[m+1],E=0===s?_:v;E>=r&&E<=o&&xe(h,_,v,e[m+2]),m=h.length-3,l&&m>=3&&(h[m]!==h[0]||h[m+1]!==h[1])&&xe(h,h[0],h[1],h[2]),h.length&&t.push(h)}function ge(e){const t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t}function ye(e,t,r,o,s,l){for(const c of e)me(c,t,r,o,s,l,!1)}function xe(e,t,r,o){e.push(t,r,o)}function ve(e,t,r,o,s,l){const c=(l-t)/(o-t);return xe(e,l,r+(s-r)*c,1),c}function be(e,t,r,o,s,l){const c=(l-r)/(s-r);return xe(e,t+(o-t)*c,l,1),c}function we(e,t){const r=[];for(let o=0;o<e.length;o++){const s=e[o],l=s.type;let c;if("Point"===l||"MultiPoint"===l||"LineString"===l)c=Ie(s.geometry,t);else if("MultiLineString"===l||"Polygon"===l){c=[];for(const e of s.geometry)c.push(Ie(e,t))}else if("MultiPolygon"===l){c=[];for(const e of s.geometry){const r=[];for(const o of e)r.push(Ie(o,t));c.push(r)}}r.push(oe(s.id,l,c,s.tags))}return r}function Ie(e,t){const r=[];r.size=e.size,void 0!==e.start&&(r.start=e.start,r.end=e.end);for(let o=0;o<e.length;o+=3)r.push(e[o]+t,e[o+1],e[o+2]);return r}function Ee(e,t){if(e.transformed)return e;const r=1<<e.z,o=e.x,s=e.y;for(const l of e.features){const e=l.geometry,c=l.type;if(l.geometry=[],1===c)for(let c=0;c<e.length;c+=2)l.geometry.push(Ae(e[c],e[c+1],t,r,o,s));else for(let c=0;c<e.length;c++){const h=[];for(let l=0;l<e[c].length;l+=2)h.push(Ae(e[c][l],e[c][l+1],t,r,o,s));l.geometry.push(h)}}return e.transformed=!0,e}function Ae(e,t,r,o,s,l){return[Math.round(r*(e*o-s)),Math.round(r*(t*o-l))]}function Me(e,t,r,o,s){const l=t===s.maxZoom?0:s.tolerance/((1<<t)*s.extent),c={features:[],numPoints:0,numSimplified:0,numFeatures:e.length,source:null,x:r,y:o,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const t of e)Pe(c,t,l,s);return c}function Pe(e,t,r,o){const s=t.geometry,l=t.type,c=[];if(e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),"Point"===l||"MultiPoint"===l)for(let t=0;t<s.length;t+=3)c.push(s[t],s[t+1]),e.numPoints++,e.numSimplified++;else if("LineString"===l)Ce(c,s,e,r,!1,!1);else if("MultiLineString"===l||"Polygon"===l)for(let t=0;t<s.length;t++)Ce(c,s[t],e,r,"Polygon"===l,0===t);else if("MultiPolygon"===l)for(let t=0;t<s.length;t++){const o=s[t];for(let t=0;t<o.length;t++)Ce(c,o[t],e,r,!0,0===t)}if(c.length){let r=t.tags||null;if("LineString"===l&&o.lineMetrics){r={};for(const e in t.tags)r[e]=t.tags[e];r.mapbox_clip_start=s.start/s.size,r.mapbox_clip_end=s.end/s.size}const h={geometry:c,type:"Polygon"===l||"MultiPolygon"===l?3:"LineString"===l||"MultiLineString"===l?2:1,tags:r};null!==t.id&&(h.id=t.id),e.features.push(h)}}function Ce(e,t,r,o,s,l){const c=o*o;if(o>0&&t.size<(s?c:o))return void(r.numPoints+=t.length/3);const h=[];for(let e=0;e<t.length;e+=3)(0===o||t[e+2]>c)&&(r.numSimplified++,h.push(t[e],t[e+1])),r.numPoints++;s&&function(e,t){let r=0;for(let t=0,o=e.length,s=o-2;t<o;s=t,t+=2)r+=(e[t]-e[s])*(e[t+1]+e[s+1]);if(r>0===t)for(let t=0,r=e.length;t<r/2;t+=2){const o=e[t],s=e[t+1];e[t]=e[r-2-t],e[t+1]=e[r-1-t],e[r-2-t]=o,e[r-1-t]=s}}(h,l),e.push(h)}const ze={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Se{constructor(e,t){const r=(t=this.options=function(e,t){for(const r in t)e[r]=t[r];return e}(Object.create(ze),t)).debug;if(r&&console.time("preprocess data"),t.maxZoom<0||t.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(t.promoteId&&t.generateId)throw new Error("promoteId and generateId cannot be used together.");let o=function(e,t){const r=[];if("FeatureCollection"===e.type)for(let o=0;o<e.features.length;o++)ae(r,e.features[o],t,o);else ae(r,"Feature"===e.type?e:{geometry:e},t);return r}(e,t);this.tiles={},this.tileCoords=[],r&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",t.indexMaxZoom,t.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),o=function(e,t){const r=t.buffer/t.extent;let o=e;const s=pe(e,1,-1-r,r,0,-1,2,t),l=pe(e,1,1-r,2+r,0,-1,2,t);return(s||l)&&(o=pe(e,1,-r,1+r,0,-1,2,t)||[],s&&(o=we(s,1).concat(o)),l&&(o=o.concat(we(l,-1)))),o}(o,t),o.length&&this.splitTile(o,0,0,0),r&&(o.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(e,t,r,o,s,l,c){const h=[e,t,r,o],u=this.options,d=u.debug;for(;h.length;){o=h.pop(),r=h.pop(),t=h.pop(),e=h.pop();const p=1<<t,f=De(t,r,o);let m=this.tiles[f];if(!m&&(d>1&&console.time("creation"),m=this.tiles[f]=Me(e,t,r,o,u),this.tileCoords.push({z:t,x:r,y:o}),d)){d>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",t,r,o,m.numFeatures,m.numPoints,m.numSimplified),console.timeEnd("creation"));const e=`z${t}`;this.stats[e]=(this.stats[e]||0)+1,this.total++}if(m.source=e,null==s){if(t===u.indexMaxZoom||m.numPoints<=u.indexMaxPoints)continue}else{if(t===u.maxZoom||t===s)continue;if(null!=s){const e=s-t;if(r!==l>>e||o!==c>>e)continue}}if(m.source=null,0===e.length)continue;d>1&&console.time("clipping");const _=.5*u.buffer/u.extent,v=.5-_,E=.5+_,P=1+_;let C=null,R=null,z=null,D=null,O=pe(e,p,r-_,r+E,0,m.minX,m.maxX,u),F=pe(e,p,r+v,r+P,0,m.minX,m.maxX,u);e=null,O&&(C=pe(O,p,o-_,o+E,1,m.minY,m.maxY,u),R=pe(O,p,o+v,o+P,1,m.minY,m.maxY,u),O=null),F&&(z=pe(F,p,o-_,o+E,1,m.minY,m.maxY,u),D=pe(F,p,o+v,o+P,1,m.minY,m.maxY,u),F=null),d>1&&console.timeEnd("clipping"),h.push(C||[],t+1,2*r,2*o),h.push(R||[],t+1,2*r,2*o+1),h.push(z||[],t+1,2*r+1,2*o),h.push(D||[],t+1,2*r+1,2*o+1)}}getTile(e,t,r){e=+e,t=+t,r=+r;const o=this.options,{extent:s,debug:l}=o;if(e<0||e>24)return null;const c=1<<e,h=De(e,t=t+c&c-1,r);if(this.tiles[h])return Ee(this.tiles[h],s);l>1&&console.log("drilling down to z%d-%d-%d",e,t,r);let u,d=e,p=t,f=r;for(;!u&&d>0;)d--,p>>=1,f>>=1,u=this.tiles[De(d,p,f)];return u&&u.source?(l>1&&(console.log("found parent tile z%d-%d-%d",d,p,f),console.time("drilling down")),this.splitTile(u.source,d,p,f,e,t,r),l>1&&console.timeEnd("drilling down"),this.tiles[h]?Ee(this.tiles[h],s):null):null}}function De(e,t,r){return 32*((1<<e)*r+t)+e}function Oe(r,o){const s=r.tileID.canonical;if(!(this||e)._geoJSONIndex)return void o(null,null);const l=(this||e)._geoJSONIndex.getTile(s.z,s.x,s.y);if(!l)return void o(null,null);const c=e=>e.tags&&"3d_elevation_id"in e.tags&&"source"in e.tags&&"elevation"===e.tags.source,h=l.features.filter((e=>c(e)));let u={_geojsonTileLayer:l.features};h.length>0&&(u={_geojsonTileLayer:l.features.filter((e=>!c(e))),hd_road_elevation:h});const d=new M(u),p=function(e){const r=new t.bt;for(const t of Object.keys(e))r.writeMessage(3,V,{name:t,features:e[t]});return r.finish()}(u).buffer;o(null,{vectorTile:d,rawData:p})}class Te extends y{constructor(e,t,r,o,s,l,c){super(e,t,r,o,s,Oe,c),l&&(this.loadGeoJSON=l),this._dynamicIndex=new T}loadData(e,o){const s=e&&e.request,l=s&&s.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(e,((c,h)=>{if(c||!h)return o(c);if("object"!=typeof h)return o(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));{try{if(e.filter){const r=t.U(e.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===r.result)throw new Error(r.value.map((e=>`${e.key}: ${e.message}`)).join(", "));h.features=h.features.filter((e=>r.value.evaluate({zoom:0},e)))}e.dynamic?("Feature"===h.type&&(h={type:"FeatureCollection",features:[h]}),e.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(h.features,this.loaded),e.cluster&&(h.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=e.cluster?new G(function({superclusterOptions:e,clusterProperties:r}){if(!r||!e)return e;const o={},s={},l={accumulated:null,zoom:0},c={properties:null},h=Object.keys(r);for(const e of h){const[l,c]=r[e],h=t.U(c),u=t.U("string"==typeof l?[l,["accumulated"],["get",e]]:l);o[e]=h.value,s[e]=u.value}return e.map=e=>{c.properties=e;const t={};for(const e of h)t[e]=o[e].evaluate(l,c);return t},e.reduce=(e,t)=>{c.properties=t;for(const t of h)l.accumulated=e[t],e[t]=s[t].evaluate(l,c)},e}(e)).load(h.features):e.dynamic?this._dynamicIndex:function(e,t){return new Se(e,t)}(h,e.geojsonVtOptions)}catch(e){return o(e)}const c={};if(l){const t=r(s);t&&(c.resourceTiming={},c.resourceTiming[e.source]=JSON.parse(JSON.stringify(t)))}o(null,c)}}))}reloadTile(e,t){const r=this.loaded;return r&&r[e.uid]?e.partial?t(null,void 0):super.reloadTile(e,t):this.loadTile(e,t)}loadGeoJSON(e,r){if(e.request)t.m(e.request,r);else{if("string"!=typeof e.data)return r(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));setTimeout((()=>{try{return r(null,JSON.parse(e.data))}catch(t){return r(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`))}}),0)}}getClusterExpansionZoom(e,t){try{t(null,this._geoJSONIndex.getClusterExpansionZoom(e.clusterId))}catch(e){t(e)}}getClusterChildren(e,t){try{t(null,this._geoJSONIndex.getChildren(e.clusterId))}catch(e){t(e)}}getClusterLeaves(e,t){try{t(null,this._geoJSONIndex.getLeaves(e.clusterId,e.limit,e.offset))}catch(e){t(e)}}}class _e{constructor(e,r,o){this.tileID=new t.aQ(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=e.projection,this.brightness=r,this.worldview=o}parse(e,r,o,s){this.status="parsing";const l=new t.aQ(o.tileID.overscaledZ,o.tileID.wrap,o.tileID.canonical.z,o.tileID.canonical.x,o.tileID.canonical.y),c=[],h=r.familiesBySource[o.source],u=new t.fn(l,o.promoteId);u.bucketLayerIDs=[],u.is3DTile=!0,t.fC(e).then((e=>{if(!e)return s(new Error("Could not parse tile"));const r=e.json.extensionsUsed&&e.json.extensionsUsed.includes("MAPBOX_mesh_features")||e.json.asset.extras&&e.json.asset.extras.MAPBOX_mesh_features,d=e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression"),p=new t.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const s in h)for(const f of h[s]){const s=f[0];u.bucketLayerIDs.push(f.map((e=>t.B(e.id,e.scope)))),s.recalculate(p,[]);const h=t.fD(e,1/t.d7(o.tileID.canonical)),m=new t.fE(f,h,l,r,d,this.brightness,u,this.worldview);r||(m.needsUpload=!0),c.push(m),m.evaluate(s)}this.status="done",s(null,{buckets:c,featureIndex:u,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((e=>s(new Error(e.message))))}}class ke{constructor(e,t,r,o,s,l,c,h){this.actor=e,this.layerIndex=t,this.availableImages=r,this.availableModels=o,this.brightness=c,this.loading={},this.loaded={},this.worldview=h}loadTile(e,r){const o=e.uid,s=this.loading[o]=new _e(e,this.brightness,this.worldview);t.bu(e.request,((t,l)=>{const c=!this.loading[o];return delete this.loading[o],c||t?(s.status="done",c||(this.loaded[o]=s),r(t)):l&&0!==l.byteLength?void s.parse(l,this.layerIndex,e,((e,t)=>{s.status="done",this.loaded=this.loaded||{},this.loaded[o]=s,e||!t?r(e):r(null,t)})):(s.status="done",this.loaded[o]=s,r())}))}reloadTile(e,t){const r=this.loaded,o=e.uid;if(r&&r[o]){const s=r[o];s.projection=e.projection,s.brightness=e.brightness;const l=(r,o)=>{s.reloadCallback&&(delete s.reloadCallback,this.loadTile(e,t)),t(r,o)};"parsing"===s.status?s.reloadCallback=l:"done"===s.status&&this.loadTile(e,t)}}abortTile(e,t){const r=e.uid;this.loading[r]&&delete this.loading[r],t()}removeTile(e,t){const r=this.loaded,o=e.uid;r&&r[o]&&delete r[o],t()}}class Le{constructor(e){this.self=e,this.actor=new t.fG(e,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new t.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=t.cm({name:"mercator"}),this.workerSourceTypes={vector:y,geojson:Te,"raster-dem":w,"raster-array":x,"batched-model":ke},this.workerSources={},this.self.registerWorkerSource=(e,t)=>{if(this.workerSourceTypes[e])throw new Error(`Worker source with name "${e}" already registered.`);this.workerSourceTypes[e]=t},this.self.registerRTLTextPlugin=e=>{if(t.fH.isParsed())throw new Error("RTL text plugin already registered.");t.fH.setState({pluginStatus:t.fI.parsed,pluginURL:t.fH.getPluginURL()}),t.fH.applyArabicShaping=e.applyArabicShaping,t.fH.processBidirectionalText=e.processBidirectionalText,t.fH.processStyledBidirectionalText=e.processStyledBidirectionalText;for(const e of this.rtlPluginParsingListeners)e(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(e,t,r){delete this.layerIndexes[e],delete this.availableImages[e],delete this.availableModels[e],delete this.workerSources[e],r()}checkIfReady(e,t,r){r()}setReferrer(e,t){this.referrer=t}spriteLoaded(e,r){this.isSpriteLoaded[e]||(this.isSpriteLoaded[e]={});const{scope:o,isLoaded:s}=r;if(this.isSpriteLoaded[e][o]=s,this.workerSources[e]&&this.workerSources[e][o])for(const r in this.workerSources[e][o]){const l=this.workerSources[e][o][r];for(const e in l){const r=l[e];r instanceof y&&(r.isSpriteLoaded=s,r.fire(new t.z("isSpriteLoaded")))}}}setImages(e,t,r){this.availableImages[e]||(this.availableImages[e]={});const{scope:o,images:s}=t;if(this.availableImages[e][o]=s,this.workerSources[e]&&this.workerSources[e][o]){for(const t in this.workerSources[e][o]){const r=this.workerSources[e][o][t];for(const e in r)r[e].availableImages=s}r()}else r()}setModels(e,{scope:t,models:r},o){if(this.availableModels[e]||(this.availableModels[e]={}),this.availableModels[e][t]=r,this.workerSources[e]&&this.workerSources[e][t]){for(const o in this.workerSources[e][t]){const s=this.workerSources[e][t][o];for(const e in s)s[e].availableModels=r}o()}else o()}setProjection(e,r){this.projections[e]=t.cm(r)}setBrightness(e,t,r){this.brightness=t,r()}setWorldview(e,t,r){this.worldview=t,r()}setLayers(e,t,r){this.getLayerIndex(e,t.scope).replace(t.layers,t.options),r()}updateLayers(e,t,r){this.getLayerIndex(e,t.scope).update(t.layers,t.removedIds,t.options),r()}loadTile(e,t,r){t.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,t.type,t.source,t.scope).loadTile(t,r)}decodeRasterArray(e,t,r){this.getWorkerSource(e,t.type,t.source,t.scope).decodeRasterArray(t,r)}reloadTile(e,t,r){t.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,t.type,t.source,t.scope).reloadTile(t,r)}abortTile(e,t,r){this.getWorkerSource(e,t.type,t.source,t.scope).abortTile(t,r)}removeTile(e,t,r){this.getWorkerSource(e,t.type,t.source,t.scope).removeTile(t,r)}removeSource(e,t,r){if(!(this.workerSources[e]&&this.workerSources[e][t.scope]&&this.workerSources[e][t.scope][t.type]&&this.workerSources[e][t.scope][t.type][t.source]))return;const o=this.workerSources[e][t.scope][t.type][t.source];delete this.workerSources[e][t.scope][t.type][t.source],void 0!==o.removeSource?o.removeSource(t,r):r()}loadWorkerSource(e,t,r){try{this.self.importScripts(t.url),r()}catch(e){r(e)}}syncRTLPluginState(e,r,o){if(t.fH.isParsed())o(null,!0);else if(t.fH.isParsing())this.rtlPluginParsingListeners.push(o);else try{t.fH.setState(r);const e=t.fH.getPluginURL();!t.fH.isLoaded()||t.fH.isParsed()||t.fH.isParsing()||null==e||(t.fH.setState({pluginStatus:t.fI.parsing,pluginURL:t.fH.getPluginURL()}),this.self.importScripts(e),t.fH.isParsed()?o(null,!0):this.rtlPluginParsingListeners.push(o))}catch(e){o(e)}}setDracoUrl(e,t){this.dracoUrl=t}getAvailableImages(e,t){this.availableImages[e]||(this.availableImages[e]={});let r=this.availableImages[e][t];return r||(r=[]),r}getAvailableModels(e,t){this.availableModels[e]||(this.availableModels[e]={});let r=this.availableModels[e][t];return r||(r={}),r}getLayerIndex(e,t){this.layerIndexes[e]||(this.layerIndexes[e]={});let r=this.layerIndexes[e][t];return r||(r=this.layerIndexes[e][t]=new n,r.scope=t),r}getWorkerSource(e,t,r,o){const s=this.workerSources;return s[e]||(s[e]={}),s[e][o]||(s[e][o]={}),s[e][o][t]||(s[e][o][t]={}),this.isSpriteLoaded[e]||(this.isSpriteLoaded[e]={}),s[e][o][t][r]||(s[e][o][t][r]=new this.workerSourceTypes[t]({send:(t,r,o,s,l,c)=>this.actor.send(t,r,o,e,l,c),scheduler:this.actor.scheduler},this.getLayerIndex(e,o),this.getAvailableImages(e,o),this.getAvailableModels(e,o),this.isSpriteLoaded[e][o],void 0,this.brightness,this.worldview)),s[e][o][t][r]}rasterizeImagesWorker(e,t,r){const o=new Map;for(const[r,{image:s,imageVariant:l}]of t.tasks.entries()){const c=this.imageRasterizer.rasterize(l,s,t.scope,e);o.set(r,c)}r(void 0,o)}removeRasterizedImages(e,t,r){this.imageRasterizer.removeImagesFromCacheByIds(t.imageIds,t.scope,e),r()}enforceCacheSizeLimit(e,r){t.fJ(r)}getWorkerPerformanceMetrics(e,t,r){r(void 0,void 0)}}return t.fF(self)&&(self.worker=new Le(self)),Le}));s(["./shared"],(function(e){var t="3.18.1";const r={create:"create",load:"load",fullLoad:"fullLoad"},o={mark(e){performance.mark(e)},measure(e,t,r){performance.measure(e,t,r)}};function s(t){const r=t.name.split("?")[0];return e.a(r)&&r.includes("mapbox-gl.js")?"javascript":e.a(r)&&r.includes("mapbox-gl.css")?"css":e.b(r)?"fontRange":e.c(r)?"sprite":e.i(r)?"style":e.d(r)?"tilejson":"other"}var l,c={},h=function(){if(l)return c;function e(e){return!t(e)}function t(t){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var e,t,r=new Blob([""],{type:"text/javascript"}),o=URL.createObjectURL(r);try{t=new Worker(o),e=!0}catch(t){e=!1}return t&&t.terminate(),URL.revokeObjectURL(o),e}()?function(){var e=document.createElement("canvas");e.width=e.height=1;var t=e.getContext("2d");if(!t)return!1;var r=t.getImageData(0,0,1,1);return r&&r.width===e.width}()?(void 0===r[o=t&&t.failIfMajorPerformanceCaveat]&&(r[o]=function(t){var r,o=function(t){var r=document.createElement("canvas"),o=Object.create(e.webGLContextAttributes);return o.failIfMajorPerformanceCaveat=t,r.getContext("webgl2",o)}(t);if(!o)return!1;try{r=o.createShader(o.VERTEX_SHADER)}catch(e){return!1}return!(!r||o.isContextLost())&&(o.shaderSource(r,"void main() {}"),o.compileShader(r),!0===o.getShaderParameter(r,o.COMPILE_STATUS))}(o)),r[o]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var o}l=1,c.supported=e,c.notSupportedReason=t;var r={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},c}();function u(e,t,r){const o=document.createElement(e);return null!=t&&(o.className=t),r&&r.appendChild(o),o}function d(e,t,r){const o=document.createElementNS("http://www.w3.org/2000/svg",e);for(const e of Object.keys(t))o.setAttributeNS(null,e,String(t[e]));return r&&r.appendChild(o),o}const p="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,f=p&&void 0!==p.userSelect?"userSelect":"WebkitUserSelect";let m;function _(){p&&f&&(m=p[f],p[f]="none")}function v(){p&&f&&(p[f]=m)}function E(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",E,!0)}function P(){window.addEventListener("click",E,!0),window.setTimeout((()=>{window.removeEventListener("click",E,!0)}),0)}function C(e,t){const r=e.getBoundingClientRect();return D(e,r,t)}function R(e,t){const r=e.getBoundingClientRect(),o=[];for(let s=0;s<t.length;s++)o.push(D(e,r,t[s]));return o}function z(e){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===e.button&&e.ctrlKey?0:e.button}function D(t,r,o){const s=t.offsetWidth===r.width?1:t.offsetWidth/r.width;return new e.P((o.clientX-r.left)*s,(o.clientY-r.top)*s)}const O="01",F="NO_ACCESS_TOKEN";class T{constructor(e,t,r){this._transformRequestFn=e,this._customAccessToken=t,this._silenceAuthErrors=!!r,this._createSkuToken()}_createSkuToken(){const e=function(){let e="";for(let t=0;t<10;t++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",O,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(e,t){return this._transformRequestFn&&this._transformRequestFn(e,t)||{url:e}}normalizeStyleURL(r,o){if(!e.h(r))return r;const s=k(r);return s.params.push(`sdk=js-${t}`),s.path=`/styles/v1${s.path}`,this._makeAPIURL(s,this._customAccessToken||o)}normalizeGlyphsURL(t,r){if(!e.h(t))return t;const o=k(t);return o.path=`/fonts/v1${o.path}`,this._makeAPIURL(o,this._customAccessToken||r)}normalizeModelURL(t,r){if(!e.h(t))return t;const o=k(t);return o.path=`/models/v1${o.path}`,this._makeAPIURL(o,this._customAccessToken||r)}normalizeSourceURL(t,r,o,s){if(!e.h(t))return t;const l=k(t);return l.path=`/v4/${l.authority}.json`,l.params.push("secure"),o&&l.params.push(`language=${o}`),s&&l.params.push(`worldview=${s}`),this._makeAPIURL(l,this._customAccessToken||r)}normalizeIconsetURL(t,r){const o=k(t);return e.h(t)?(o.path=`/styles/v1${o.path}/iconset.pbf`,this._makeAPIURL(o,this._customAccessToken||r)):V(o)}normalizeSpriteURL(t,r,o,s){const l=k(t);return e.h(t)?(l.path=`/styles/v1${l.path}/sprite${r}${o}`,this._makeAPIURL(l,this._customAccessToken||s)):(l.path+=`${r}${o}`,V(l))}normalizeTileURL(t,r,o){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!e.h(t))return t;const s=k(t);s.path=s.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||o&&"raster"!==s.authority&&512===o?"@2x":""}${e.k.supported?".webp":"$1"}`),"raster"===s.authority?s.path=`/${e.e.RASTER_URL_PREFIX}${s.path}`:"rasterarrays"===s.authority?s.path=`/${e.e.RASTERARRAYS_URL_PREFIX}${s.path}`:"3dtiles"===s.authority?s.path=`/${e.e.TILES3D_URL_PREFIX}${s.path}`:(s.path=s.path.replace(/^.+\/v4\//,"/"),s.path=`/${e.e.TILE_URL_VERSION}${s.path}`);const l=this._customAccessToken||function(e){for(const t of e){const e=t.match(/^access_token=(.*)$/);if(e)return e[1]}return null}(s.params)||e.e.ACCESS_TOKEN;return e.e.REQUIRE_ACCESS_TOKEN&&l&&this._skuToken&&s.params.push(`sku=${this._skuToken}`),this._makeAPIURL(s,l)}canonicalizeTileURL(t,r){const o=k(t);if(!o.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!o.path.match(/\.[\w]+$/))return t;let s="mapbox://";o.path.match(/^\/raster\/v1\//)?s+=`raster/${o.path.replace(`/${e.e.RASTER_URL_PREFIX}/`,"")}`:o.path.match(/^\/rasterarrays\/v1\//)?s+=`rasterarrays/${o.path.replace(`/${e.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:s+=`tiles/${o.path.replace(`/${e.e.TILE_URL_VERSION}/`,"")}`;let l=o.params;return r&&(l=l.filter((e=>!e.match(/^access_token=/)))),l.length&&(s+=`?${l.join("&")}`),s}canonicalizeTileset(t,r){const o=!!r&&e.h(r),s=[];for(const r of t.tiles||[])e.j(r)?s.push(this.canonicalizeTileURL(r,o)):s.push(r);return s}_makeAPIURL(t,r){const o="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",s=k(e.e.API_URL);if(t.protocol=s.protocol,t.authority=s.authority,"http"===t.protocol){const e=t.params.indexOf("secure");e>=0&&t.params.splice(e,1)}if("/"!==s.path&&(t.path=`${s.path}${t.path}`),!e.e.REQUIRE_ACCESS_TOKEN)return V(t);if(r=r||e.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${o}`);if("s"===r[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${o}`)}return t.params=t.params.filter((e=>-1===e.indexOf("access_token"))),t.params.push(`access_token=${r||""}`),V(t)}}const B=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function k(e){const t=e.match(B);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function V(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const N="mapbox.eventData";function U(t){if(!t)return null;const r=t.split(".");if(!r||3!==r.length)return null;try{return JSON.parse(e.l(r[1]))}catch(e){return null}}class A{constructor(e){this.type=e,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const r=U(e.e.ACCESS_TOKEN);let o="";return o=r&&r.u?e.f(r.u):e.e.ACCESS_TOKEN||"",t?`${N}.${t}:${o}`:`${N}:${o}`}fetchEventData(){const t=e.s("localStorage"),r=this.getStorageKey(),o=this.getStorageKey("uuid"),s=this.getStorageKey("uuidTimestamp");if(t)try{const e=localStorage.getItem(r);e&&(this.eventData=JSON.parse(e));const t=localStorage.getItem(o);t&&(this.anonId=t);const l=localStorage.getItem(s);l&&(this.anonIdTimestamp=Number(l));const c=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<c)&&this.refreshUUID()}catch(t){e.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=e.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=e.s("localStorage"),r=this.getStorageKey(),o=this.getStorageKey("uuid"),s=this.getStorageKey("uuidTimestamp"),l=this.anonId,c=this.anonIdTimestamp;if(t&&l)try{localStorage.setItem(o,l),Object.keys(this.eventData).length>=1&&localStorage.setItem(r,JSON.stringify(this.eventData)),c&&localStorage.setItem(s,c.toString())}catch(t){e.w("Unable to write to LocalStorage")}}processRequests(e){}postEvent(t,r,o,s){if(!e.e.EVENTS_URL)return;const l=k(e.e.EVENTS_URL);l.params.push(`access_token=${s||e.e.ACCESS_TOKEN||""}`);const c={event:this.type,created:new Date(t).toISOString()},h=r?Object.assign(c,r):c,u={url:V(l),headers:{"Content-Type":"text/plain"},body:JSON.stringify([h])};this.pendingRequest=e.p(u,(e=>{this.pendingRequest=null,o(e),this.saveEventData(),this.processRequests(s)}))}queueRequest(e,t){this.queue.push(e),this.processRequests(t)}}class L extends A{constructor(e){super("metrics"),e&&(this.data=e)}postMetricsEvent(t){if(!e.e.EVENTS_URL||!t&&!e.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),e.v(this.anonId)||this.refreshUUID();const r=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:r},t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,payload:r}=this.queue.shift();this.postEvent(t,r,(()=>{}),e)}}const j=new class extends A{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(t,r){e.e.EVENTS_URL&&e.e.ACCESS_TOKEN&&Array.isArray(t)&&t.some((t=>e.h(t)||e.j(t)))&&this.queueRequest(Date.now(),r)}processRequests(r){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const o=U(e.e.ACCESS_TOKEN),s=o?o.u:e.e.ACCESS_TOKEN;let l=s!==this.eventData.tokenU;e.v(this.anonId)||(this.refreshUUID(),l=!0);const c=this.queue.shift();if(this.eventData.lastSuccess){const e=new Date(this.eventData.lastSuccess),t=new Date(c),r=(c-this.eventData.lastSuccess)/864e5;l=l||r>=1||r<-1||e.getDate()!==t.getDate()}else l=!0;l?this.postEvent(c,{sdkIdentifier:"mapbox-gl-js",sdkVersion:t,skuId:O,"enabled.telemetry":!1,userId:this.anonId},(e=>{e||(this.eventData.lastSuccess=c,this.eventData.tokenU=s)}),r):this.processRequests()}},$=j.postTurnstileEvent.bind(j),q=new class extends A{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,r,o,s){this.skuToken=r,this.errorCb=s,e.e.EVENTS_URL&&(o||e.e.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},o):this.errorCb(new Error(F)))}processRequests(r){if(this.pendingRequest||0===this.queue.length)return;const{id:o,timestamp:s}=this.queue.shift();o&&this.success[o]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),e.v(this.anonId)||this.refreshUUID(),this.postEvent(s,{sdkIdentifier:"mapbox-gl-js",sdkVersion:t,skuId:O,skuToken:this.skuToken,userId:this.anonId},(e=>{e?this.errorCb(e):o&&(this.success[o]=!0)}),r))}remove(){this.errorCb=null}},H=q.postMapLoadEvent.bind(q),Z=new class extends A{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(t){let r=this.mapInstanceIdMap.get(t);return r||(r=e.u(),this.mapInstanceIdMap.set(t,r)),r}getEventId(e){const t=this.eventIdPerMapInstanceMap.get(e)||0;return this.eventIdPerMapInstanceMap.set(e,t+1),t}postStyleLoadEvent(t,r){const{map:o,style:s,importedStyles:l}=r;if(!e.e.EVENTS_URL||!t&&!e.e.ACCESS_TOKEN)return;const c=this.getMapInstanceId(o),h={mapInstanceId:c,eventId:this.getEventId(c),style:s};l.length&&(h.importedStyles=l),this.queueRequest({timestamp:Date.now(),payload:h},t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,payload:r}=this.queue.shift();this.postEvent(t,r,(()=>{}),e)}},Y=Z.postStyleLoadEvent.bind(Z),J=new L({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),Q=J.postMetricsEvent.bind(J),K=new L({attributes:[{name:"maps/js/layer-animations/runtime-appearances"}]}),ee=K.postMetricsEvent.bind(K),te=new class extends A{constructor(){super("gljs.performance")}postPerformanceEvent(t,r){e.e.EVENTS_URL&&(t||e.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:r},t)}processRequests(o){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:l,performanceData:c}=this.queue.shift(),h=function(o){const l=performance.getEntriesByType("resource"),c=performance.getEntriesByType("mark"),h=function(e){const t={};if(e)for(const r in e)if("other"!==r)for(const o of e[r]){const e=`${r}ResolveRangeMin`,s=`${r}ResolveRangeMax`,l=`${r}RequestCount`,c=`${r}RequestCachedCount`;t[e]=Math.min(t[e]||1/0,o.startTime),t[s]=Math.max(t[s]||-1/0,o.responseEnd);const h=e=>{void 0===t[e]&&(t[e]=0),++t[e]};void 0!==o.transferSize&&0===o.transferSize&&h(c),h(l)}return t}(function(e,t){const r={};if(e)for(const o of e){const e=t(o);void 0===r[e]&&(r[e]=[]),r[e].push(o)}return r}(l,s)),u=window.devicePixelRatio,d=navigator.connection||navigator.mozConnection||navigator.webkitConnection,p=d?d.effectiveType:void 0,f={counters:[],metadata:[],attributes:[]},m=(e,t,r)=>{null!=r&&e.push({name:t,value:r.toString()})};for(const e in h)m(f.counters,e,h[e]);if(o.interactionRange[0]!==1/0&&o.interactionRange[1]!==-1/0&&(m(f.counters,"interactionRangeMin",o.interactionRange[0]),m(f.counters,"interactionRangeMax",o.interactionRange[1])),c)for(const e of Object.values(r)){const t=c.find((t=>t.name===e));t&&m(f.counters,e,t.startTime)}return m(f.counters,"visibilityHidden",o.visibilityHidden),m(f.attributes,"style",function(t){if(t)for(const r of t){const t=r.name.split("?")[0];if(e.i(t)){const e=t.split("/").slice(-2);if(2===e.length)return`mapbox://styles/${e[0]}/${e[1]}`}}}(l)),m(f.attributes,"terrainEnabled",o.terrainEnabled?"true":"false"),m(f.attributes,"fogEnabled",o.fogEnabled?"true":"false"),m(f.attributes,"projection",o.projection),m(f.attributes,"zoom",o.zoom),m(f.metadata,"devicePixelRatio",u),m(f.metadata,"connectionEffectiveType",p),m(f.metadata,"navigatorUserAgent",navigator.userAgent),m(f.metadata,"screenWidth",window.screen.width),m(f.metadata,"screenHeight",window.screen.height),m(f.metadata,"windowWidth",window.innerWidth),m(f.metadata,"windowHeight",window.innerHeight),m(f.metadata,"mapWidth",o.width/u),m(f.metadata,"mapHeight",o.height/u),m(f.metadata,"webglRenderer",o.renderer),m(f.metadata,"webglVendor",o.vendor),m(f.metadata,"sdkVersion",t),m(f.metadata,"sdkIdentifier","mapbox-gl-js"),f}(c);for(const e of h.metadata);for(const e of h.counters);for(const e of h.attributes);this.postEvent(l,h,(()=>{}),o)}},ie=te.postPerformanceEvent.bind(te),re=new class extends A{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,r,o,s){if(!e.e.API_URL||!e.e.SESSION_PATH)return;const l=k(e.e.API_URL+e.e.SESSION_PATH);l.params.push(`sku=${r||""}`),l.params.push(`access_token=${s||e.e.ACCESS_TOKEN||""}`);const c={url:V(l),headers:{"Content-Type":"text/plain"}};this.pendingRequest=e.g(c,(e=>{this.pendingRequest=null,o(e),this.saveEventData(),this.processRequests(s)}))}getSessionAPI(t,r,o,s){this.skuToken=r,this.errorCb=s,e.e.SESSION_PATH&&e.e.API_URL&&(o||e.e.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},o):this.errorCb(new Error(F)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||this.getSession(r,this.skuToken,(e=>{e?this.errorCb(e):t&&(this.success[t]=!0)}),e)}remove(){this.errorCb=null}},ne=re.getSessionAPI.bind(re),oe=new Set;function se(e,t){t?oe.add(e):oe.delete(e)}class W{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(e,t){this._updatedSourceCaches[e]=t,this.setDirty()}discardSourceCacheUpdate(e){delete this._updatedSourceCaches[e]}updateLayer(e){const t=e.scope;this._updatedLayers[t]=this._updatedLayers[t]||new Set,this._updatedLayers[t].add(e.id),this.setDirty()}removeLayer(e){const t=e.scope;this._removedLayers[t]=this._removedLayers[t]||{},this._updatedLayers[t]=this._updatedLayers[t]||new Set,this._removedLayers[t][e.id]=e,this._updatedLayers[t].delete(e.id),this._updatedPaintProps.delete(e.fqid),this.setDirty()}getRemovedLayer(e){return this._removedLayers[e.scope]?this._removedLayers[e.scope][e.id]:null}discardLayerRemoval(e){this._removedLayers[e.scope]&&delete this._removedLayers[e.scope][e.id]}getLayerUpdatesByScope(){const e={};for(const t in this._updatedLayers)e[t]=e[t]||{},e[t].updatedIds=Array.from(this._updatedLayers[t].values());for(const t in this._removedLayers)e[t]=e[t]||{},e[t].removedIds=Object.keys(this._removedLayers[t]);return e}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(e){this._updatedPaintProps.add(e.fqid),this.setDirty()}getUpdatedImages(e){return this._updatedImages[e]?Array.from(this._updatedImages[e].values()):[]}updateImage(t,r){this._updatedImages[r]=this._updatedImages[r]||new Set,this._updatedImages[r].add(e.I.toString(t)),this.setDirty()}resetUpdatedImages(e){this._updatedImages[e]&&this._updatedImages[e].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function ae(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class X extends e.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,"raster"!==t&&e.r()&&(this.imageRasterizerDispatcher=new e.D(e.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new e.q({width:1,height:1}))}removeScope(e){this.loaded.delete(e),this.imageProviders.delete(e),this.images.delete(e),this.updatedImages.delete(e),this.callbackDispatchedThisFrame.delete(e),this.patterns.delete(e),this.atlasImage.delete(e);const t=this.atlasTexture.get(e);t&&(t.destroy(),this.atlasTexture.delete(e))}addImageProvider(e,t){this.imageProviders.has(t)||this.imageProviders.set(t,new Map),this.imageProviders.get(t).set(e.id,e)}removeImageProvider(e,t){this.imageProviders.has(t)&&this.imageProviders.get(t).delete(e)}getPendingImageProviders(){const e=[];for(const t of this.imageProviders.values())for(const r of t.values())r.hasPendingRequests()&&e.push(r);return e}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new e.x),this._imageRasterizer}isLoaded(){for(const e of this.loaded.keys())if(!this.loaded.get(e))return!1;return!0}setLoaded(e,t){if(this.loaded.get(t)!==e&&(this.loaded.set(t,e),e)){for(const{ids:e,callback:r}of this.requestors)this._notify(e,t,r);this.requestors=[]}}hasImage(e,t){return!!this.getImage(e,t)}getImage(e,t){return this.images.get(t).get(e.toString())}addImage(e,t,r){this._validate(e,r)&&this.images.get(t).set(e.toString(),r)}_validate(t,r){let o=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),o=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),o=!1),this._validateContent(r.content,r)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "content" value`))),o=!1),o}_validateStretch(e,t){if(!e)return!0;let r=0;for(const o of e){if(o[0]<r||o[1]<o[0]||t<o[1])return!1;r=o[1]}return!0}_validateContent(e,t){if(!e)return!0;if(4!==e.length)return!1;if(!t.usvg){if(e[0]<0||t.data.width<e[0])return!1;if(e[1]<0||t.data.height<e[1])return!1;if(e[2]<0||t.data.width<e[2])return!1;if(e[3]<0||t.data.height<e[3])return!1}return!(e[2]<e[0]||e[3]<e[1])}updateImage(e,t,r){const o=this.images.get(t).get(e.toString());r.version=o.version+1,this.images.get(t).set(e.toString(),r),this.updatedImages.get(t).add(e),this.removeFromImageRasterizerCache(e,t)}clearUpdatedImages(e){this.updatedImages.get(e).clear()}removeFromImageRasterizerCache(t,r){"raster"!==this.spriteFormat&&(e.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:r}):this.imageRasterizer.removeImagesFromCacheByIds([t],r))}removeImage(e,t){const r=this.images.get(t),o=r.get(e.toString());r.delete(e.toString()),this.patterns.get(t).delete(e.toString()),this.removeFromImageRasterizerCache(e,t),o.userImage&&o.userImage.onRemove&&o.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((t=>e.I.from(t)))}getImages(e,t,r){const o=[],s=[],l=this.imageProviders.get(t);for(const r of e){if(!r.iconsetId){o.push(r);continue}const e=l.get(r.iconsetId);e&&(this.getImage(r,t)?s.push(r):e.addPendingRequest(r))}if(0===o.length)return void this._notify(s,t,r);let c=!0;const h=!!this.loaded.get(t),u=this.images.get(t);if(!h)for(const e of o)u.has(e.toString())||(c=!1);h||c?this._notify(o,t,r):this.requestors.push({ids:o,scope:t,callback:r})}rasterizeImages(e,t){const r=new Map,{tasks:o,scope:s}=e;for(const[e,t]of o.entries()){const o=this.getImage(t.id,s);o&&r.set(e,{image:o,imageVariant:t})}this._rasterizeImages(s,r,t)}_rasterizeImages(t,r,o){if(e.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:r,scope:t},o);else{const e=new Map;for(const[o,{image:s,imageVariant:l}]of r.entries())e.set(o,this.imageRasterizer.rasterize(l,s,t,0));o(void 0,e)}}getUpdatedImages(e){return this.updatedImages.get(e)||new Set}_notify(t,r,o){const s=this.images.get(r),l=new Map;for(const r of t){if(!s.get(r.toString())){if(r.iconsetId)continue;this.fire(new e.z("styleimagemissing",{id:r.name}))}const t=s.get(r.toString());if(!t){e.w(`Image "${r.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const o={data:t.usvg?null:t.data.clone(),pixelRatio:t.pixelRatio,sdf:t.sdf,usvg:t.usvg,version:t.version,stretchX:t.stretchX,stretchY:t.stretchY,content:t.content,hasRenderCallback:Boolean(t.userImage&&t.userImage.render)};t.usvg&&Object.assign(o,{width:t.icon.usvg_tree.width,height:t.icon.usvg_tree.height}),l.set(e.I.toString(r),o)}o(null,l)}getPixelSize(e){const{width:t,height:r}=this.atlasImage.get(e);return{width:t,height:r}}getPattern(t,r,o){const s=t.toString(),l=this.patterns.get(r),c=l.get(s),h=this.getImage(t,r);if(!h)return null;if(c){if(c.position.version===h.version)return c.position;c.position.version=h.version}else{if(h.usvg&&!h.data){const l=this.getPatternInFlightId(s,r);if(this.patternsInFlight.has(l))return null;this.patternsInFlight.add(l);const c=new e.A(t).scaleSelf(e.o.devicePixelRatio),u=new Map([[c.toString(),{image:h,imageVariant:c}]]);return this._rasterizeImages(r,u,((e,t)=>this.storePatternImage(c,r,h,o,t))),null}this.storePattern(t,r,h)}return this._updatePatternAtlas(r,o),l.get(s).position}getPatternInFlightId(t,r){return e.B(t,r)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(e,t,r,o,s){const l=e.toString(),c=s?s.get(l):void 0;c&&(r.data=c,this.storePattern(e.id,t,r),this._updatePatternAtlas(t,o),this.patternsInFlight.delete(this.getPatternInFlightId(e.id.toString(),t)))}storePattern(t,r,o){const s={w:o.data.width+2*e.C,h:o.data.height+2*e.C,x:0,y:0},l=new e.F(s,o,e.C);this.patterns.get(r).set(t.toString(),{bin:s,position:l})}destroyAtlasTextures(){for(const e of this.atlasTexture.values())e&&e.destroy();this.atlasTexture.clear()}bind(t,r){const o=t.gl;let s=this.atlasTexture.get(r);s?this.dirty&&(s.update(this.atlasImage.get(r)),this.dirty=!1):(s=new e.T(t,this.atlasImage.get(r),o.RGBA8),this.atlasTexture.set(r,s)),s.bind(o.LINEAR,o.CLAMP_TO_EDGE)}_updatePatternAtlas(t,r){const o=this.patterns.get(t),s=Array.from(o.values()).map((({bin:e})=>e)),{w:l,h:c}=e.G(s),h=this.atlasImage.get(t);h.resize({width:l||1,height:c||1});const u=this.images.get(t);for(const[t,{bin:s,position:l}]of o.entries()){let o=l.padding;const c=s.x+o,d=s.y+o,p=u.get(t).data,f=p.width,m=p.height;o=o>1?o-1:o,e.q.copy(p,h,{x:0,y:0},{x:c,y:d},{width:f,height:m},r),e.q.copy(p,h,{x:0,y:m-o},{x:c,y:d-o},{width:f,height:o},r),e.q.copy(p,h,{x:0,y:0},{x:c,y:d+m},{width:f,height:o},r),e.q.copy(p,h,{x:f-o,y:0},{x:c-o,y:d},{width:o,height:m},r),e.q.copy(p,h,{x:0,y:0},{x:c+f,y:d},{width:o,height:m},r),e.q.copy(p,h,{x:f-o,y:m-o},{x:c-o,y:d-o},{width:o,height:o},r),e.q.copy(p,h,{x:0,y:m-o},{x:c+f,y:d-o},{width:o,height:o},r),e.q.copy(p,h,{x:0,y:0},{x:c+f,y:d+m},{width:o,height:o},r),e.q.copy(p,h,{x:f-o,y:0},{x:c-o,y:d+m},{width:o,height:o},r)}this.dirty=!0}beginFrame(){for(const e of this.images.keys())this.callbackDispatchedThisFrame.set(e,new Set)}dispatchRenderCallbacks(e,t){const r=this.images.get(t);for(const o of e){if(this.callbackDispatchedThisFrame.get(t).has(o.toString()))continue;this.callbackDispatchedThisFrame.get(t).add(o.toString());const e=r.get(o.toString());ae(e)&&this.updateImage(o,t,e)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function le(t){const r=t.value,o=t.valueSpec,s=t.style,l=t.styleSpec,c=t.key,h=t.arrayElementValidator||Oe;if(!Array.isArray(r))return[new e.V(c,r,`array expected, ${e.K(r)} found`)];if(o.length&&r.length!==o.length)return[new e.V(c,r,`array length ${o.length} expected, length ${r.length} found`)];if(o["min-length"]&&r.length<o["min-length"])return[new e.V(c,r,`array length at least ${o["min-length"]} expected, length ${r.length} found`)];let u={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};l.$version<7&&(u.function=o.function),e.H(o.value)&&(u=o.value);let d=[];for(let e=0;e<r.length;e++)d=d.concat(h({array:r,arrayIndex:e,value:r[e],valueSpec:u,style:s,styleSpec:l,key:`${c}[${e}]`},!0));return d}function ce(t){const r=t.key,o=t.value,s=t.valueSpec;if(!e.L(o))return[new e.V(r,o,`number expected, ${e.K(o)} found`)];if(o!=o)return[new e.V(r,o,"number expected, NaN found")];if("minimum"in s){let l=s.minimum;if(Array.isArray(s.minimum)&&(l=s.minimum[t.arrayIndex]),o<l)return[new e.V(r,o,`${o} is less than the minimum value ${l}`)]}if("maximum"in s){let l=s.maximum;if(Array.isArray(s.maximum)&&(l=s.maximum[t.arrayIndex]),o>l)return[new e.V(r,o,`${o} is greater than the maximum value ${l}`)]}return[]}function he(t){const r=t.key,o=t.value;if(!e.H(o))return[new e.V(r,o,`object expected, ${e.K(o)} found`)];const s=t.valueSpec,l=e.J(o.type);let c,h,u,d={};const p="categorical"!==l&&void 0===o.property,f=!p,m=function(t){const r=t.stops;return Array.isArray(r)&&Array.isArray(r[0])&&e.H(r[0][0])}(o),_=Fe({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(t){if("identity"===l)return[new e.V(t.key,t.value,'identity function may not have a "stops" property')];let r=[];const o=t.value;return r=r.concat(le({key:t.key,value:o,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:v})),Array.isArray(o)&&0===o.length&&r.push(new e.V(t.key,o,"array must have at least one stop")),r},default:function(e){return Oe({key:e.key,value:e.value,valueSpec:s,style:e.style,styleSpec:e.styleSpec})}}});return"identity"===l&&p&&_.push(new e.V(t.key,t.value,'missing required property "property"')),"identity"===l||o.stops||_.push(new e.V(t.key,t.value,'missing required property "stops"')),"exponential"===l&&s.expression&&!e.M(s)&&_.push(new e.V(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(f&&!e.N(s)?_.push(new e.V(t.key,t.value,"property functions not supported")):p&&!e.O(s)&&_.push(new e.V(t.key,t.value,"zoom functions not supported"))),"categorical"!==l&&!m||void 0!==o.property||_.push(new e.V(t.key,t.value,'"property" property is required')),_;function v(t){let r=[];const o=t.value,l=t.key;if(!Array.isArray(o))return[new e.V(l,o,`array expected, ${e.K(o)} found`)];if(2!==o.length)return[new e.V(l,o,`array length 2 expected, length ${o.length} found`)];if(m){if(!e.H(o[0]))return[new e.V(l,o,`object expected, ${e.K(o[0])} found`)];const s=o[0];if(void 0===s.zoom)return[new e.V(l,o,"object stop key must have zoom")];if(void 0===s.value)return[new e.V(l,o,"object stop key must have value")];const c=e.J(s.zoom);if("number"!=typeof c)return[new e.V(l,s.zoom,"stop zoom values must be numbers")];if(u&&u>c)return[new e.V(l,s.zoom,"stop zoom values must appear in ascending order")];c!==u&&(u=c,h=void 0,d={}),r=r.concat(Fe({key:`${l}[0]`,value:o[0],valueSpec:{zoom:{}},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{zoom:ce,value:E}}))}else r=r.concat(E({key:`${l}[0]`,value:o[0],style:t.style,styleSpec:t.styleSpec},o));return e.Q(e.S(o[1]))?r.concat([new e.V(`${l}[1]`,o[1],"expressions are not allowed in function stops.")]):r.concat(Oe({key:`${l}[1]`,value:o[1],valueSpec:s,style:t.style,styleSpec:t.styleSpec}))}function E(t,r){const o=e.K(t.value),u=e.J(t.value),p=null!==t.value?t.value:r;if(c){if(o!==c)return[new e.V(t.key,p,`${o} stop domain type must match previous stop domain type ${c}`)]}else c=o;if("number"!==o&&"string"!==o&&"boolean"!==o&&"number"!=typeof u&&"string"!=typeof u&&"boolean"!=typeof u)return[new e.V(t.key,p,"stop domain value must be a number, string, or boolean")];if("number"!==o&&"categorical"!==l){let r=`number expected, ${o} found`;return e.N(s)&&void 0===l&&(r+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new e.V(t.key,p,r)]}return"categorical"!==l||"number"!==o||"number"==typeof u&&isFinite(u)&&Math.floor(u)===u?"categorical"!==l&&"number"===o&&"number"==typeof u&&"number"==typeof h&&void 0!==h&&u<h?[new e.V(t.key,p,"stop domain values must appear in ascending order")]:(h=u,"categorical"===l&&u in d?[new e.V(t.key,p,"stop domain values must be unique")]:(d[u]=!0,[])):[new e.V(t.key,p,`integer expected, found ${String(u)}`)]}}function ue(t){const r=("property"===t.expressionContext?e.W:e.U)(e.S(t.value),t.valueSpec);if("error"===r.result)return r.value.map((r=>new e.V(`${t.key}${r.key}`,t.value,r.message)));const o=r.value.expression||r.value._styleExpression.expression;if("property"===t.expressionContext&&"text-font"===t.propertyKey&&!o.outputDefined())return[new e.V(t.key,t.value,`Invalid data expression for "${t.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===t.expressionContext&&"layout"===t.propertyType&&!e.Z(o))return[new e.V(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===t.expressionContext)return de(o,t);if("appearance"===t.expressionContext)return pe(o,t);if(t.expressionContext&&0===t.expressionContext.indexOf("cluster")){if(!e.X(o,["zoom","feature-state"]))return[new e.V(t.key,t.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===t.expressionContext&&!e.Y(o))return[new e.V(t.key,t.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function de(t,r){const o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(r.valueSpec&&r.valueSpec.expression)for(const e of r.valueSpec.expression.parameters)o.delete(e);if(0===o.size)return[];const s=[];return t instanceof e._&&o.has(t.name)?[new e.V(r.key,r.value,`["${t.name}"] expression is not supported in a filter for a ${r.object.type} layer with id: ${r.object.id}`)]:(t.eachChild((e=>{s.push(...de(e,r))})),s)}function pe(t,r){const o=new Set;if(r.valueSpec&&r.valueSpec.expression)for(const e of r.valueSpec.expression.parameters)o.add(e);if(0===o.size)return[];const s=[];return t instanceof e._&&!o.has(t.name)?[new e.V(r.key,r.value,`["${t.name}"] is not an allowed parameter`)]:(t.eachChild((e=>{s.push(...pe(e,r))})),s)}function fe(t){const r=t.key,o=t.value,s=t.valueSpec,l=[];return Array.isArray(s.values)?-1===s.values.indexOf(e.J(o))&&l.push(new e.V(r,o,`expected one of [${s.values.join(", ")}], ${JSON.stringify(o)} found`)):-1===Object.keys(s.values).indexOf(e.J(o))&&l.push(new e.V(r,o,`expected one of [${Object.keys(s.values).join(", ")}], ${JSON.stringify(o)} found`)),l}function me(t){return e.a2(e.S(t.value))?ue(Object.assign({},t,{expressionContext:"filter",valueSpec:t.styleSpec[`filter_${t.layerType||"fill"}`]})):ge(t)}function ge(t){const r=t.value,o=t.key;if(!Array.isArray(r))return[new e.V(o,r,`array expected, ${e.K(r)} found`)];if(r.length<1)return[new e.V(o,r,"filter array must have at least 1 element")];const s=t.styleSpec;let l=fe({key:`${o}[0]`,value:r[0],valueSpec:s.filter_operator});const c=()=>{r.length>=2&&(e.a0(r[1])||l.push(new e.V(`${o}[1]`,r[1],`string expected, ${e.K(r[1])} found`)));for(let t=2;t<r.length;t++)"$type"===e.J(r[1])?l=l.concat(fe({key:`${o}[${t}]`,value:r[t],valueSpec:s.geometry_type})):e.a0(r[t])||e.L(r[t])||e.$(r[t])||l.push(new e.V(`${o}[${t}]`,r[t],`string, number, or boolean expected, ${e.K(r[t])} found.`))};switch(e.J(r[0])){case"<":case"<=":case">":case">=":r.length>=2&&"$type"===e.J(r[1])&&l.push(new e.V(o,r,`"$type" cannot be use with operator "${r[0]}"`)),3!==r.length&&l.push(new e.V(o,r,`filter array for operator "${r[0]}" must have 3 elements`)),c();break;case"==":case"!=":3!==r.length&&l.push(new e.V(o,r,`filter array for operator "${r[0]}" must have 3 elements`)),c();break;case"in":case"!in":c();break;case"any":case"all":case"none":for(let e=1;e<r.length;e++)l=l.concat(ge({key:`${o}[${e}]`,value:r[e],style:t.style,styleSpec:t.styleSpec}));break;case"has":case"!has":2!==r.length?l.push(new e.V(o,r,`filter array for "${r[0]}" operator must have 2 elements`)):e.a0(r[1])||l.push(new e.V(`${o}[1]`,r[1],`string expected, ${e.K(r[1])} found`))}return l}function ye(t,r){const o=t.key,s=t.style,l=t.layer,c=t.styleSpec,h=t.value,u=t.objectKey,d=c[`${r}_${t.layerType}`];if(!d)return[];const p=u.match(/^(.*)-use-theme$/);if(p&&d[p[1]])return e.Q(e.S(h))?[].concat(Oe({key:o,value:h,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:s,styleSpec:c,expressionContext:"property",propertyType:r,propertyKey:u})):Oe({key:o,value:h,valueSpec:{type:"string"},style:s,styleSpec:c});const f=u.match(/^(.*)-transition$/);if("paint"===r&&f&&d[f[1]]&&d[f[1]].transition)return Oe({key:o,value:h,valueSpec:c.transition,style:s,styleSpec:c});const m=t.valueSpec||d[u];if(!m)return[new e.a3(o,h,`unknown property "${u}"`)];let _;if(e.a0(h)&&e.N(m)&&!m.tokens&&(_=/^{([^}]+)}$/.exec(h))){const t=`\`{ "type": "identity", "property": ${_?JSON.stringify(_[1]):'"_"'} }\``;return[new e.V(o,h,`"${u}" does not support interpolation syntax\nUse an identity property function instead: ${t}.`)]}const v=[];if("symbol"===t.layerType)"text-field"!==u||!s||s.glyphs||s.imports||v.push(new e.V(o,h,'use of "text-field" requires a style "glyphs" property')),"text-font"===u&&e.a4(e.S(h))&&"identity"===e.J(h.type)&&v.push(new e.V(o,h,'"text-font" does not support identity functions'));else if("model"===t.layerType&&"paint"===r&&l&&l.layout&&l.layout.hasOwnProperty("model-id")&&e.N(m)&&(e.a5(m)||e.O(m))){const t=e.W(e.S(h),m).value,r="expression"in t&&t.expression||"_styleExpression"in t&&t._styleExpression&&t._styleExpression.expression;r&&!e.X(r,["measure-light"])&&("model-emissive-strength"===u&&e.Y(r)&&e.Z(r)||v.push(new e.V(o,h,`${u} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return v.concat(Oe({key:t.key,value:h,valueSpec:m,style:s,styleSpec:c,expressionContext:"property",propertyType:r,propertyKey:u}))}function xe(e){return ye(e,"paint")}function ve(e){return ye(e,"layout")}function be(t){let r=[];const o=t.value,s=t.key,l=t.style,c=t.styleSpec;if(!e.H(o))return[new e.V(s,o,"object expected")];o.type||o.ref||r.push(new e.V(s,o,'either "type" or "ref" is required'));let h=e.J(o.type);const u=e.J(o.ref);if(o.id){const c=e.J(o.id);for(let h=0;h<t.arrayIndex;h++){const t=l.layers[h];e.J(t.id)===c&&r.push(new e.V(s,o.id,`duplicate layer id "${c}", previously used at line ${t.id.__line__}`))}}if("ref"in o){let t;["type","source","source-layer","filter","layout"].forEach((t=>{t in o&&r.push(new e.V(s,o[t],`"${t}" is prohibited for ref layers`))})),l.layers.forEach((r=>{e.J(r.id)===u&&(t=r)})),t?t.ref?r.push(new e.V(s,o.ref,"ref cannot reference another ref layer")):h=e.J(t.type):"string"==typeof u&&r.push(new e.V(s,o.ref,`ref layer "${u}" not found`))}else if("background"!==h&&"sky"!==h&&"slot"!==h)if(o.source)if(e.a0(o.source)){const t=l.sources&&l.sources[o.source],c=t&&e.J(t.type);t?"vector"===c&&"raster"===h?r.push(new e.V(s,o.source,`layer "${o.id}" requires a raster source`)):"raster"===c&&"raster"!==h?r.push(new e.V(s,o.source,`layer "${o.id}" requires a vector source`)):"vector"!==c||o["source-layer"]?"raster-dem"===c&&"hillshade"!==h?r.push(new e.V(s,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==c||["raster","raster-particle"].includes(h)?"line"===h&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&"geojson"===c&&!t.lineMetrics?r.push(new e.V(s,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):"raster-particle"===h&&"raster-array"!==c&&r.push(new e.V(s,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):r.push(new e.V(s,o.source,"raster-array source can only be used with layer type 'raster'.")):r.push(new e.V(s,o,`layer "${o.id}" must specify a "source-layer"`)):r.push(new e.V(s,o.source,`source "${o.source}" not found`))}else r.push(new e.V(`${s}.source`,o.source,'"source" must be a string'));else r.push(new e.V(s,o,'missing required property "source"'));return r=r.concat(Fe({key:s,value:o,valueSpec:c.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Oe({key:`${s}.type`,value:o.type,valueSpec:c.layer.type,style:t.style,styleSpec:t.styleSpec,object:o,objectKey:"type"}),filter:e=>me(Object.assign({layerType:h},e)),layout:e=>Fe({layer:o,key:e.key,value:e.value,valueSpec:{},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>ve(Object.assign({layerType:h},e))}}),paint:e=>Fe({layer:o,key:e.key,value:e.value,valueSpec:{},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>xe(Object.assign({layerType:h,layer:o},e))}}),appearances(t){const r=le({key:t.key,value:t.value,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:t=>function(t){const{key:r,layer:o,layerType:s}=t,l=e.J(t.value),c=e.J(l.name),h=e.J(l.condition),u=Fe({key:r,value:l,valueSpec:t.styleSpec.appearance,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{condition:t=>function(t){const r=[];return r.push(...ue({key:t.key,value:t.object.condition,valueSpec:e.a6.appearance.condition,expressionContext:"appearance"})),r}(Object.assign({layer:o,layerType:s},t)),properties:t=>function(t){const r=[],{styleSpec:o,layer:s,layerType:l}=t,c=o[`paint_${l}`],h=o[`layout_${l}`],u=t.object[t.objectKey];for(const o in u){const d=o in c?"paint":o in h?"layout":void 0;if(!d){r.push(new e.V(t.key,o,`unknown property "${o}" for layer type "${l}"`));continue}const p=Object.assign({},t,{key:`${t.key}.${o}`,object:u,objectKey:o,layer:s,layerType:l,value:u[o],valueSpec:"paint"===d?c[o]:h[o]});r.push(...ye(p,d))}return r}(Object.assign({layer:o,layerType:s},t))}});return"hidden"!==c&&void 0===h&&u.push(new e.V(t.key,"name",'Appearance with name different than "hidden" must have a condition')),u}(Object.assign({layerType:h,layer:o},t))}),s=Array.isArray(t.value)?t.value:[],l=new Set;return s.forEach(((s,c)=>{const h=e.J(s.name);if(h)if(l.has(h)){const s=e.J(o.id);r.push(new e.V(t.key,h,`Duplicated appearance name "${h}" for layer "${s}"`))}else l.add(h)})),r}}})),r}function we({key:t,value:r}){return e.a0(r)?[]:[new e.V(t,r,`string expected, ${e.K(r)} found`)]}const Ie={promoteId:function t({key:r,value:o}){if(e.a0(o))return we({key:r,value:o});if(Array.isArray(o)){const t=[],s=e.S(o),l=e.U(s);return"error"===l.result&&l.value.forEach((o=>{t.push(new e.V(`${r}${o.key}`,null,`${o.message}`))})),e.X(l.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||t.push(new e.V(`${r}`,null,"promoteId expression should be only feature dependent")),t}if(!e.H(o))return[new e.V(r,o,`string, expression or object expected, "${e.K(o)}" found`)];const s=[];for(const e in o)s.push(...t({key:`${r}.${e}`,value:o[e]}));return s}};function Ee(t){const r=t.value,o=t.key,s=t.styleSpec,l=t.style;if(!e.H(r))return[new e.V(o,r,`object expected, ${e.K(r)} found`)];if(!("type"in r))return[new e.V(o,r,'"type" is required')];const c=e.J(r.type);let h=[];switch(["vector","raster","raster-dem","raster-array"].includes(c)&&("url"in r||"tiles"in r||h.push(new e.a3(o,r,'Either "url" or "tiles" is required.'))),c){case"vector":case"raster":case"raster-dem":case"raster-array":return h=h.concat(Fe({key:o,value:r,valueSpec:s[`source_${c.replace("-","_")}`],style:t.style,styleSpec:s,objectElementValidators:Ie})),h;case"geojson":if(h=Fe({key:o,value:r,valueSpec:s.source_geojson,style:l,styleSpec:s,objectElementValidators:Ie}),"cluster"in r&&"clusterProperties"in r){if(!e.H(r.clusterProperties))return[new e.V(`${o}.clusterProperties`,r,`object expected, ${e.K(r)} found`)];for(const t in r.clusterProperties){const s=r.clusterProperties[t];if(!Array.isArray(s))return[new e.V(`${o}.clusterProperties.${t}`,s,"array expected")];const[l,c]=s,u="string"==typeof l?[l,["accumulated"],["get",t]]:l;h.push(...ue({key:`${o}.${t}.map`,value:c,expressionContext:"cluster-map"})),h.push(...ue({key:`${o}.${t}.reduce`,value:u,expressionContext:"cluster-reduce"}))}}return h;case"video":return Fe({key:o,value:r,valueSpec:s.source_video,style:l,styleSpec:s});case"image":return Fe({key:o,value:r,valueSpec:s.source_image,style:l,styleSpec:s});case"canvas":return[new e.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return fe({key:`${o}.type`,value:r.type,valueSpec:{values:Ae(s)}})}}function Ae(e){return e.source.reduce(((t,r)=>{const o=e[r];return"enum"===o.type.type&&(t=t.concat(Object.keys(o.type.values||{}))),t}),[])}function Me(t){const r=t.value,o=t.styleSpec,s=o.light,l=t.style;if(void 0===r)return[];if(!e.H(r))return[new e.V("light",r,`object expected, ${e.K(r)} found`)];let c=[];for(const t in r){const h=t.match(/^(.*)-transition$/),u=t.match(/^(.*)-use-theme$/);c=c.concat(u&&s[u[1]]?Oe({key:t,value:r[t],valueSpec:{type:"string"},style:l,styleSpec:o}):h&&s[h[1]]&&s[h[1]].transition?Oe({key:t,value:r[t],valueSpec:o.transition,style:l,styleSpec:o}):s[t]?Oe({key:t,value:r[t],valueSpec:s[t],style:l,styleSpec:o}):[new e.V(t,r[t],`unknown property "${t}"`)])}return c}function Pe(t){const r=t.value;if(!r)return[];const o=t.key;if(!e.H(r))return[new e.V(o,r,`object expected, ${e.K(r)} found`)];let s=[];const l=t.styleSpec,c=l["light-3d"],h=t.style,u=t.style.lights;for(const t of["type","id"])if(!(t in r))return s=s.concat([new e.V(o,r,`missing property "${t}"`)]),s;if(!e.a0(r.type))return s=s.concat([new e.V(`${o}.type`,r.type,"string expected")]),s;if(u)for(let l=0;l<t.arrayIndex;l++){const t=e.J(r.type),c=u[l];e.J(c.type)===t&&s.push(new e.V(o,r.id,`duplicate light type "${r.type}", previously defined at line ${c.id.__line__}`))}const d=`properties_light_${r.type}`;if(!(d in l))return s=s.concat([new e.V(`${o}.type`,r,`Invalid light type ${r.type}`)]),s;const p=l[d];for(const o in r)if("properties"===o){const c=r[o];if(!e.H(c))return s=s.concat([new e.V("properties",c,`object expected, ${e.K(c)} found`)]),s;for(const u in c){const d=u.match(/^(.*)-transition$/),f=u.match(/^(.*)-use-theme$/);s=s.concat(f&&p[f[1]]?Oe({key:o,value:c[u],valueSpec:{type:"string"},style:h,styleSpec:l}):d&&p[d[1]]&&p[d[1]].transition?Oe({key:o,value:r[o],valueSpec:l.transition,style:h,styleSpec:l}):p[u]?Oe({key:u,value:c[u],valueSpec:p[u],style:h,styleSpec:l}):[new e.a3(t.key,c[u],`unknown property "${u}"`)])}}else s=s.concat(c[o]?Oe({key:o,value:r[o],valueSpec:c[o],style:h,styleSpec:l}):[new e.a3(o,r[o],`unknown property "${o}"`)]);return s}function Ce(t){const r=t.value,o=t.key,s=t.style,l=t.styleSpec,c=l.terrain;if(null==r)return[];if(!e.H(r))return[new e.V("terrain",r,`object expected, ${e.K(r)} found`)];let h=[];for(const t in r){const o=t.match(/^(.*)-transition$/),u=t.match(/^(.*)-use-theme$/);h=h.concat(u&&c[u[1]]?Oe({key:t,value:r[t],valueSpec:{type:"string"},style:s,styleSpec:l}):o&&c[o[1]]&&c[o[1]].transition?Oe({key:t,value:r[t],valueSpec:l.transition,style:s,styleSpec:l}):c[t]?Oe({key:t,value:r[t],valueSpec:c[t],style:s,styleSpec:l}):[new e.a3(t,r[t],`unknown property "${t}"`)])}if(r.source)if(e.a0(r.source)){const t=s.sources&&s.sources[r.source],l=t&&e.J(t.type);t?"raster-dem"!==l&&h.push(new e.V(`${o}.source`,r.source,`terrain cannot be used with a source of type ${l}, it only be used with a "raster-dem" source type`)):h.push(new e.V(`${o}.source`,r.source,`source "${r.source}" not found`))}else h.push(new e.V(`${o}.source`,r.source,"source must be a string"));else h.push(new e.V(o,r,'terrain is missing required property "source"'));return h}function ze(t){const r=t.value,o=t.style,s=t.styleSpec,l=s.fog;if(void 0===r)return[];if(!e.H(r))return[new e.V("fog",r,`object expected, ${e.K(r)} found`)];let c=[];for(const t in r){const h=t.match(/^(.*)-transition$/),u=t.match(/^(.*)-use-theme$/);c=c.concat(u&&l[u[1]]?Oe({key:t,value:r[t],valueSpec:{type:"string"},style:o,styleSpec:s}):h&&l[h[1]]&&l[h[1]].transition?Oe({key:t,value:r[t],valueSpec:s.transition,style:o,styleSpec:s}):l[t]?Oe({key:t,value:r[t],valueSpec:l[t],style:o,styleSpec:s}):[new e.a3(t,r[t],`unknown property "${t}"`)])}return c}const De={"*":()=>[],array:le,boolean:function(t){const r=t.value,o=t.key;return e.$(r)?[]:[new e.V(o,r,`boolean expected, ${e.K(r)} found`)]},number:ce,color:function({key:t,value:r}){return e.a0(r)?null===e.a1.parseCSSColor(r)?[new e.V(t,r,`color expected, "${r}" found`)]:[]:[new e.V(t,r,`color expected, ${e.K(r)} found`)]},enum:fe,filter:me,function:he,layer:be,object:Fe,source:Ee,model:e.a7,light:Me,"light-3d":Pe,terrain:Ce,fog:ze,string:we,formatted:function(e){return 0===we(e).length?[]:ue(e)},resolvedImage:function(e){return 0===we(e).length?[]:ue(e)},projection:function(t){const r=t.value,o=t.styleSpec,s=o.projection,l=t.style;if(e.H(r)){let e=[];for(const t in r)e=e.concat(Oe({key:t,value:r[t],valueSpec:s[t],style:l,styleSpec:o}));return e}return e.a0(r)?[]:[new e.V("projection",r,`object or string expected, ${e.K(r)} found`)]},import:function(t){const r=t.key,{value:o,styleSpec:s}=t;if(!e.H(o))return[new e.V(r,o,"import must be an object")];const{data:l,...c}=o;Object.defineProperty(c,"__line__",{value:o.__line__,enumerable:!1});let h=Fe(Object.assign({},t,{value:c,valueSpec:s.import}));return""===e.J(c.id)&&h.push(new e.V(`${t.key}.id`,c,"import id can't be an empty string")),l&&(h=h.concat(Ve(l,s,{key:`${t.key}.data`}))),h},iconset:function(t){const r=t.value,o=t.key,s=t.styleSpec,l=t.style;if(!e.H(r))return[new e.V(o,r,"object expected")];if(!r.type)return[new e.V(o,r,'"type" is required')];const c=e.J(r.type);let h=[];if(h=h.concat(Fe({key:o,value:r,valueSpec:s[`iconset_${c}`],style:l,styleSpec:s})),function(e,t){return!("source"!==e||!t.source)}(c,r)){const t=l.sources&&l.sources[r.source],s=t&&e.J(t.type);t?"raster-array"!==s&&h.push(new e.V(o,r.source,`iconset cannot be used with a source of type ${String(s)}, it only be used with a "raster-array" source type`)):h.push(new e.V(o,r.source,`source "${r.source}" not found`))}return h}};function Oe(t,r=!1){const o=t.value,s=t.valueSpec,l=t.styleSpec;if(s.expression){if(e.a4(e.J(o)))return he(t);if(e.Q(e.S(o)))return ue(t)}if(s.type&&De[s.type]){const e=De[s.type](t);return!0===r&&e.length>0&&Array.isArray(t.value)?ue(t):e}return Fe(Object.assign({},t,{valueSpec:s.type?l[s.type]:s}))}function Fe(t){const r=t.key,o=t.value,s=t.valueSpec||{},l=t.objectElementValidators||{},c=t.style,h=t.styleSpec;if(!e.H(o))return[new e.V(r,o,`object expected, ${e.K(o)} found`)];let u=[];for(const t in o){const d=t.split(".")[0];let p;l[d]?p=l[d]:s[d]?p=Oe:l["*"]?p=l["*"]:s["*"]&&(p=Oe),p?u=u.concat(p({key:(r?`${r}.`:r)+t,value:o[t],valueSpec:s[d]||s["*"],style:c,styleSpec:h,object:o,objectKey:t},o)):u.push(new e.a3(r,o[t],`unknown property "${t}"`))}for(const t in s){if(l[t])continue;const c=s[t];c.required&&void 0===c.default&&void 0===o[t]&&u.push(new e.V(r,o,`missing required property "${t}"`))}return u}function Be({key:t,value:r}){const o=we({key:t,value:r});if(o.length)return o;const s=r;return-1===s.indexOf("{fontstack}")&&o.push(new e.V(t,r,'"glyphs" url must include a "{fontstack}" token')),-1===s.indexOf("{range}")&&o.push(new e.V(t,r,'"glyphs" url must include a "{range}" token')),o}function Ve(t,r=e.a6,o={}){return Fe({key:o.key||"",value:t,valueSpec:Object.assign(r.$root,{"*":{type:"*"}}),styleSpec:r,style:t,objectElementValidators:{glyphs:Be}})}function Ue(t,r=e.a6){return it(Ve(t,r))}const je=e=>it(Ee(e)),Ge=e=>it(Me(e)),qe=e=>it(Pe(e)),He=e=>it(Ce(e)),We=e=>it(ze(e)),Ze=t=>it(function(t){const r=t.value,o=t.style,s=t.styleSpec,l=s.snow;if(void 0===r)return[];if(!e.H(r))return[new e.V("snow",r,`object expected, ${e.K(r)} found`)];let c=[];for(const t in r){const h=t.match(/^(.*)-transition$/);c=c.concat(h&&l[h[1]]&&l[h[1]].transition?Oe({key:t,value:r[t],valueSpec:s.transition,style:o,styleSpec:s}):l[t]?Oe({key:t,value:r[t],valueSpec:l[t],style:o,styleSpec:s}):[new e.a3(t,r[t],`unknown property "${t}"`)])}return c}(t)),Xe=t=>it(function(t){const r=t.value,o=t.style,s=t.styleSpec,l=s.rain;if(void 0===r)return[];if(!e.H(r))return[new e.V("rain",r,`object expected, ${e.K(r)} found`)];let c=[];for(const t in r){const h=t.match(/^(.*)-transition$/);c=c.concat(h&&l[h[1]]&&l[h[1]].transition?Oe({key:t,value:r[t],valueSpec:s.transition,style:o,styleSpec:s}):l[t]?Oe({key:t,value:r[t],valueSpec:l[t],style:o,styleSpec:s}):[new e.a3(t,r[t],`unknown property "${t}"`)])}return c}(t)),Ye=e=>it(be(e)),Je=e=>it(me(e)),Qe=e=>it(xe(e)),Ke=e=>it(ve(e)),tt=t=>it(e.a7(t));function it(e){return e.slice().sort(((e,t)=>e.line&&t.line?e.line-t.line:0))}function rt(t,r){let o=!1;if(r&&r.length)for(const s of r)s instanceof e.a3?e.w(s.message):(t.fire(new e.y(new Error(s.message))),o=!0);return o}const nt=e.a6.light;let ot;class Ne extends e.E{constructor(t,r="flat"){super(),this._transitionable=new e.a8(ot||(ot=new e.a9({anchor:new e.aa(nt.anchor),position:new e.ab(nt.position),color:new e.aa(nt.color),intensity:new e.aa(nt.intensity)}))),this.setLight(t,r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,t,r={}){this._validate(Ge,e,r)||(this._transitionable.setTransitionOrValue(e),this.id=t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,r,o){return(!o||!1!==o.validate)&&rt(this,t.call(Ue,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}}const at=e.a6.terrain;let lt=class extends e.E{constructor(t,r,o,s,l){super(),this.scope=o,this._transitionable=new e.a8(new e.a9({source:new e.aa(at.source),exaggeration:new e.aa(at.exaggeration)}),o,s),this._transitionable.setTransitionOrValue(t,s),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=r,this.worldview=l}get(){return this._transitionable.serialize()}set(e,t){this._transitionable.setTransitionOrValue(e,t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}getExaggeration(t){return this._transitioning.possiblyEvaluate(new e.ac(t,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const t=this._transitionable._values.exaggeration;if(!t)return null;const r=t.value.expression;if(!r)return null;let o=-1,s=-1,l=1;for(const t of r.zoomStops)l=r.evaluate(new e.ac(t,{worldview:this.worldview})),l>.01?(o=t,s=-1):s=t;return l<.01&&o>0&&s>o?[o,s]:null}isZoomDependent(){const t=this._transitionable._values.exaggeration;return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof e.ad}};const ct=.05;function ft(t,r,o,s){const l=e.ah(45,65,o),[c,h]=mt(t,s);let u=1-Math.min(1,Math.exp((r-c)/(h-c)*-6));return u*=u*u,u=Math.min(1,1.00747*u),u*l*t.alpha}function mt(e,t){const r=.5/Math.tan(.5*t);return[e.range[0]+r,e.range[1]+r]}function _t(t,r,o,s,l){const c=e.af([],[r,o,s],l.mercatorFogMatrix);return ft(t,e.ag(c),l.pitch,l._fov)}function gt(t,r,o,s,l,c,h){const u=[[o,s,0],[l,s,0],[l,c,0],[o,c,0]];let d=Number.MAX_VALUE,p=-Number.MAX_VALUE;for(const t of u){const o=e.af([],t,r),s=e.ag(o);d=Math.min(d,s),p=Math.max(p,s)}return[ft(t,d,h.pitch,h._fov),ft(t,p,h.pitch,h._fov)]}const yt=e.a6.fog;class $e extends e.E{constructor(t,r,o,s){super();const l=new e.a9({range:new e.aa(yt.range),color:new e.aa(yt.color),"color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new e.aa(yt["high-color"]),"high-color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new e.aa(yt["space-color"]),"space-color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new e.aa(yt["horizon-blend"]),"star-intensity":new e.aa(yt["star-intensity"]),"vertical-range":new e.aa(yt["vertical-range"])});this._transitionable=new e.a8(l,o,new Map(s)),this.set(t,s),this._transitioning=this._transitionable.untransitioned(),this._transform=r,this.properties=new e.ai(l),this.scope=o}get state(){const t=this._transform,r="globe"===t.projection.name,o=e.aj(t.zoom),s=this.properties.get("range"),l=[.5,3];return{range:r?[e.ak(l[0],s[0],o),e.ak(l[1],s[1],o)]:s,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,t,r={}){if(this._validate(We,e,r))return;const o=Object.assign({},e);for(const e of Object.keys(yt))void 0===o[e]&&(o[e]=yt[e].default);this._options=o,this._transitionable.setTransitionOrValue(this._options,t)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const r=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:e.ah(45,65,t))*r.a}getOpacityAtLatLng(t,r){return this._transform.projection.supportsFog?function(t,r,o){const s=e.ae.fromLngLat(r),l=o.elevation?o.elevation.getAtPointOrZero(s):0;return _t(t,s.x,s.y,l,o)}(this.state,t,r):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const r=this._transform.calculateFogTileMatrix(t.toUnwrapped());return gt(this.state,r,0,0,e.al,e.al,this._transform)}getOpacityForBounds(e,t,r,o,s){return this._transform.projection.supportsFog?gt(this.state,e,t,r,o,s,this._transform):[1,1]}getFovAdjustedRange(e){return this._transform.projection.supportsFog?mt(this.state,e):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const r=[4,5,6,7];for(const o of r){const r=t.points[o];let s;if(r[2]>=0)s=r;else{const l=t.points[o-4];s=e.am(l,r,l[2]/(l[2]-r[2]))}if(_t(this.state,s[0],s[1],0,this._transform)>=ct)return!0}return!1}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,r,o){return(!o||!1!==o.validate)&&rt(this,t.call(Ue,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}}let xt,vt,bt,wt=class extends e.E{constructor(t,r,o,s){super();const l=xt||(xt=new e.a9({density:new e.aa(e.a6.snow.density),intensity:new e.aa(e.a6.snow.intensity),color:new e.aa(e.a6.snow.color),opacity:new e.aa(e.a6.snow.opacity),vignette:new e.aa(e.a6.snow.vignette),"vignette-color":new e.aa(e.a6.snow["vignette-color"]),"center-thinning":new e.aa(e.a6.snow["center-thinning"]),direction:new e.aa(e.a6.snow.direction),"flake-size":new e.aa(e.a6.snow["flake-size"])}));this._transitionable=new e.a8(l,o,new Map(s)),this.set(t,s),this._transitioning=this._transitionable.untransitioned(),this.properties=new e.ai(l),this.scope=o}get state(){const t=this.properties.get("opacity"),r=this.properties.get("color"),o=this.properties.get("direction"),s=e.an(o[0]),l=-Math.max(e.an(o[1]),.01),c=[Math.cos(s)*Math.cos(l),Math.sin(s)*Math.cos(l),Math.sin(l)],h=this.properties.get("vignette"),u=this.properties.get("vignette-color");return u.a=h,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new e.ao(r.r,r.g,r.b,r.a*t),direction:c,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:u}}get(){return this._transitionable.serialize()}set(t,r,o={}){if(this._validate(Ze,t,o))return;const s=Object.assign({},t),l=e.a6.snow;for(const e of Object.keys(l))void 0===s[e]&&(s[e]=l[e].default);this._options=s,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,r,o){return(!o||!1!==o.validate)&&rt(this,t.call(Ue,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}},Tt=class extends e.E{constructor(t,r,o,s){super();const l=vt||(vt=new e.a9({density:new e.aa(e.a6.rain.density),intensity:new e.aa(e.a6.rain.intensity),color:new e.aa(e.a6.rain.color),opacity:new e.aa(e.a6.rain.opacity),vignette:new e.aa(e.a6.rain.vignette),"vignette-color":new e.aa(e.a6.rain["vignette-color"]),"center-thinning":new e.aa(e.a6.rain["center-thinning"]),direction:new e.aa(e.a6.rain.direction),"droplet-size":new e.aa(e.a6.rain["droplet-size"]),"distortion-strength":new e.aa(e.a6.rain["distortion-strength"])}));this._transitionable=new e.a8(l,o,new Map(s)),this.set(t,s),this._transitioning=this._transitionable.untransitioned(),this.properties=new e.ai(l),this.scope=o}get state(){const t=this.properties.get("opacity"),r=this.properties.get("color"),o=this.properties.get("direction"),s=e.an(o[0]),l=-Math.max(e.an(o[1]),.01),c=[Math.cos(s)*Math.cos(l),Math.sin(s)*Math.cos(l),Math.sin(l)],h=this.properties.get("vignette-color");return h.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new e.ao(r.r,r.g,r.b,r.a*t),direction:c,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:h}}get(){return this._transitionable.serialize()}set(t,r,o={}){if(this._validate(Xe,t,o))return;const s=Object.assign({},t),l=e.a6.rain;for(const e of Object.keys(l))void 0===s[e]&&(s[e]=l[e].default);this._options=s,this._transitionable.setTransitionOrValue(this._options,r)}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,r,o){return(!o||!1!==o.validate)&&rt(this,t.call(Ue,Object.assign({value:r,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}};class et extends e.E{constructor(t,r,o,s){super(),this.scope=o,this._options=t,this.properties=new e.ai(r),this._transitionable=new e.a8(r,o,new Map(s)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(e){this._transitionable.setTransitionOrValue(this._options.properties,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(e,t){this._options=e,this._transitionable.setTransitionOrValue(e.properties,t)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const St=()=>bt||(bt=new e.a9({color:new e.aa(e.a6.properties_light_ambient.color),"color-use-theme":new e.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new e.aa(e.a6.properties_light_ambient.intensity)}));let It;const Et=()=>It||(It=new e.a9({direction:new e.ap(e.a6.properties_light_directional.direction),color:new e.aa(e.a6.properties_light_directional.color),"color-use-theme":new e.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new e.aa(e.a6.properties_light_directional.intensity),"cast-shadows":new e.aa(e.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new e.aa(e.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new e.aa(e.a6.properties_light_directional["shadow-intensity"]),"shadow-draw-before-layer":new e.aa(e.a6.properties_light_directional["shadow-draw-before-layer"])}));class st{constructor(e,t,r){this.screenBounds=e,this.cameraPoint=r.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=t,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,r)}static createFromScreenPoints(t,r){let o,s;if(t instanceof e.P||"number"==typeof t[0]){const l=e.P.convert(t);o=[l],s=r.isPointAboveHorizon(l)}else{const l=e.P.convert(t[0]),c=e.P.convert(t[1]),h=l.add(c)._div(2);o=[l,c],s=e.aq(l,c).every((e=>r.isPointAboveHorizon(e)))&&r.isPointAboveHorizon(h)}return new st(o,s,r)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(t){return e.aq(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const r=this.screenBounds[0],o=1===this.screenBounds.length?this.screenBounds[0].add(new e.P(1,1)):this.screenBounds[1],s=e.aq(r,o,0,!1);return this.cameraPoint.y>o.y&&(this.cameraPoint.x>r.x&&this.cameraPoint.x<o.x?s.splice(3,0,this.cameraPoint):this.cameraPoint.x>=o.x?s[2]=this.cameraPoint:this.cameraPoint.x<=r.x&&(s[3]=this.cameraPoint)),e.ar(s,t)}bufferedCameraGeometryGlobe(t){const r=this.screenBounds[0],o=1===this.screenBounds.length?this.screenBounds[0].add(new e.P(1,1)):this.screenBounds[1],s=e.aq(r,o,t),l=this.cameraPoint.clone();switch(3*((l.y>r.y)+(l.y>o.y))+((l.x>r.x)+(l.x>o.x))){case 0:s[0]=l,s[4]=l.clone();break;case 1:s.splice(1,0,l);break;case 2:s[1]=l;break;case 3:s.splice(4,0,l);break;case 5:s.splice(2,0,l);break;case 6:s[3]=l;break;case 7:s.splice(3,0,l);break;case 8:s[2]=l}return s}containsTile(t,r,o,s=0){const l=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/r._pixelsPerMercatorPixel+1,c=o?this._bufferedCameraMercator(l,r):this._bufferedScreenMercator(l,r);let h=t.tileID.wrap+(c.unwrapped?s:0);const u=c.polygon.map((r=>e.as(t.tileTransform,r,h)));if(!e.at(u,0,0,e.al,e.al))return;h=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?s:0);const d=this.screenGeometryMercator.polygon.map((r=>e.au(t.tileTransform,r,h))),p=d.map((t=>new e.P(t[0],t[1]))),f=r.getFreeCameraOptions().position||new e.ae(0,0,0),m=e.au(t.tileTransform,f,h),_=d.map((t=>{const r=e.av(t,t,m);return e.aw(r,r),new e.ax(m,r)})),v=e.ay(t,1,r.zoom)*r._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:p,tilespaceRays:_,bufferedTilespaceGeometry:u,bufferedTilespaceBounds:(E=e.az(u),E.min.x=e.aA(E.min.x,0,e.al),E.min.y=e.aA(E.min.y,0,e.al),E.max.x=e.aA(E.max.x,0,e.al),E.max.y=e.aA(E.max.y,0,e.al),E),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:v};var E}_bufferedScreenMercator(e,t){const r=Rt(e);if(this._screenRaycastCache[r])return this._screenRaycastCache[r];{let o;return o="globe"===t.projection.name?this._projectAndResample(this.bufferedScreenGeometry(e),t):{polygon:this.bufferedScreenGeometry(e).map((e=>t.pointCoordinate3D(e))),unwrapped:!0},this._screenRaycastCache[r]=o,o}}_bufferedCameraMercator(e,t){const r=Rt(e);if(this._cameraRaycastCache[r])return this._cameraRaycastCache[r];{let o;return o="globe"===t.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(e),t):{polygon:this.bufferedCameraGeometry(e).map((e=>t.pointCoordinate3D(e))),unwrapped:!0},this._cameraRaycastCache[r]=o,o}}_projectAndResample(t,r){const o=function(t,r){const o=e.aB([],r.pixelMatrix,r.globeMatrix),s=[0,-e.aD,0,1],l=[0,e.aD,0,1],c=[0,0,0,1];e.aC(s,s,o),e.aC(l,l,o),e.aC(c,c,o);const h=new e.P(s[0]/s[3],s[1]/s[3]),u=new e.P(l[0]/l[3],l[1]/l[3]),d=e.aE(t,h)&&s[3]<c[3],p=e.aE(t,u)&&l[3]<c[3];if(!d&&!p)return null;const f=function(e,t,r){for(let o=1;o<e.length;o++){const s=Ct(t.pointCoordinate3D(e[o-1]).x),l=Ct(t.pointCoordinate3D(e[o]).x);if(r<0){if(s<l)return{idx:o,t:-s/(l-1-s)}}else if(l<s)return{idx:o,t:(1-s)/(l+1-s)}}return null}(t,r,d?-1:1);if(!f)return null;const{idx:m,t:_}=f;let v=m>1?At(t.slice(0,m),r):[],E=m<t.length?At(t.slice(m),r):[];v=v.map((t=>new e.P(Ct(t.x),t.y))),E=E.map((t=>new e.P(Ct(t.x),t.y)));const P=[...v];0===P.length&&P.push(E[E.length-1]);const C=e.ak(P[P.length-1].y,(0===E.length?v[0]:E[0]).y,_);let R;return R=d?[new e.P(0,C),new e.P(0,0),new e.P(1,0),new e.P(1,C)]:[new e.P(1,C),new e.P(1,1),new e.P(0,1),new e.P(0,C)],P.push(...R),0===E.length?P.push(v[0]):P.push(...E),{polygon:P.map((t=>new e.ae(t.x,t.y))),unwrapped:!1}}(t,r);if(o)return o;const s=function(t,r){let o=!1,s=-1/0,l=0;for(let e=0;e<t.length-1;e++)t[e].x>s&&(s=t[e].x,l=e);for(let e=0;e<t.length-1;e++){const r=(l+e)%(t.length-1),s=t[r],c=t[r+1];Math.abs(s.x-c.x)>.5&&(s.x<c.x?(s.x+=1,0===r&&(t[t.length-1].x+=1)):(c.x+=1,r+1===t.length-1&&(t[0].x+=1)),o=!0)}const c=e.aF(r.center.lng);return o&&c<Math.abs(c-1)&&t.forEach((e=>{e.x-=1})),{polygon:t,unwrapped:o}}(At(t,r).map((t=>new e.P(Ct(t.x),t.y))),r);return{polygon:s.polygon.map((t=>new e.ae(t.x,t.y))),unwrapped:s.unwrapped}}}function At(t,r){return e.aG(t,(e=>{const t=r.pointCoordinate3D(e);e.x=t.x,e.y=t.y}),1/256)}function Ct(e){return e<0?1+e%1:e%1}function Rt(e){return 100*e|0}function Dt(t,r,o,s,l){const c=function(o,s){if(o)return l(o);if(s){if(t.url&&s.tiles&&t.tiles&&delete t.tiles,s.variants){if(!Array.isArray(s.variants))return l(new Error("variants must be an array"));for(const e of s.variants){if(null==e||"object"!=typeof e||e.constructor!==Object)return l(new Error("variant must be an object"));if(!Array.isArray(e.capabilities))return l(new Error("capabilities must be an array"));if(1===e.capabilities.length&&"meshopt"===e.capabilities[0]){s=Object.assign(s,e);break}}}const o=e.aH(Object.assign({},s,t),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);o.tiles=r.canonicalizeTileset(o,t.url),l(null,o)}},h=function(e,t,r){if(!e)return null;if(!t&&!r)return e;r=r||e.worldview_default;const o=Object.values(e.language||{});if(0===o.length)return null;const s=Object.values(e.worldview||{});if(0===s.length)return null;const l=o.every((e=>e===t)),c=s.every((e=>e===r));return l&&c?e:t in(e.language_options||{})||r in(e.worldview_options||{})?null:e.language_options&&e.worldview_options?e:null}(t.data,o,s);return h?e.o.frame((()=>c(null,h))):t.url?e.m(r.transformRequest(r.normalizeSourceURL(t.url,null,o,s),e.R.Source),c):e.o.frame((()=>{const{data:e,...r}=t;c(null,r)}))}function Lt(t,r){const o=Math.pow(2,r.z),s=Math.floor(e.aF(t.getWest())*o),l=Math.floor(e.aJ(t.getNorth())*o),c=Math.ceil(e.aF(t.getEast())*o),h=Math.ceil(e.aJ(t.getSouth())*o);return r.x>=s&&r.x<c&&r.y>=l&&r.y<h}class ht{constructor(t,r,o){this.bounds=t?e.aI.convert(this.validateBounds(t)):null,this.minzoom=r||0,this.maxzoom=o||24}validateBounds(e){return Array.isArray(e)&&4===e.length?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const r of t)this.extraBounds.push(e.aI.convert(this.validateBounds(r)))}}contains(e){if(e.z>this.maxzoom||e.z<this.minzoom)return!1;if(this.bounds&&!Lt(this.bounds,e))return!1;if(!this.extraBounds)return!0;for(const t of this.extraBounds)if(Lt(t,e))return!0;return!1}static fromTileJSON(e){if(!e.bounds&&!e.extra_bounds)return null;const t=new ht(e.bounds,e.minzoom,e.maxzoom);return t.addExtraBounds(e.extra_bounds),t}}class dt extends e.E{constructor(t,r,o,s){if(super(),this.id=t,this.dispatcher=o,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,e.aH(r,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},r),this._collectResourceTiming=!!r.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(s),this._tileWorkers={},this._deduped=new e.aK}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=Dt(this._options,this.map._requestManager,r,o,((s,l)=>{if(this._tileJSONRequest=null,this._loaded=!0,s)r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),o&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new e.y(s));else if(l){if(Object.assign(this,l),this.hasWorldviews=!!l.worldview_options,l.worldview_default&&(this.worldviewDefault=l.worldview_default),l.vector_layers){this.vectorLayers=l.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const e of l.vector_layers)this.vectorLayerIds.push(e.id),l.worldview&&l.worldview[e.source]&&this.localizableLayerIds.add(e.id)}this.tileBounds=ht.fromTileJSON(l),$(l.tiles,this.map._requestManager._customAccessToken),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(s)}))}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,r){const o=t.tileID.canonical.url(this.tiles,this.scheme),s=this.map._requestManager.normalizeTileURL(o),l=this.map._requestManager.transformRequest(s,e.R.Tile),c=this.map.style?this.map.style.getLut(this.scope):null,h=c?{image:c.image.clone()}:null,u={request:l,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:h,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:e.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.getIndoorTileOptions(this.id,this.scope)};if(this.hasWorldviews&&e.h(o)&&(u.localizableLayerIds=this.localizableLayerIds),u.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=r:t.request=t.actor.send("reloadTile",u,d.bind(this));else if(t.actor=this._tileWorkers[s]=this._tileWorkers[s]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",u,d.bind(this),void 0,!0);else{const r=e.aL.call({deduped:this._deduped},u,((r,o)=>{if(r||!o)d.call(this,r);else{const r=e.aM(o.responseHeaders);u.data={rawData:o.rawData.slice(0),expires:r.expires,cacheControl:r.cacheControl},t.actor&&t.actor.send("loadTile",u,d.bind(this),void 0,!0)}}),!0);t.request={cancel:r}}function d(o,s){return delete t.request,t.aborted?r(null):o&&o instanceof e.aN&&404!==o.status?r(o):(s&&s.resourceTiming&&(t.resourceTiming=s.resourceTiming),this.map._refreshExpiredTiles&&s&&t.setExpiryData(s),t.loadVectorData(s,this.map.painter),e.aO(this.dispatcher),r(null,s),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,t){e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ut extends e.E{constructor(t,r,o,s){super(),this.id=t,this.dispatcher=o,this.setEventedParent(s),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},r),Object.assign(this,e.aH(r,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const r=this.map.getWorldview();this._tileJSONRequest=Dt(this._options,this.map._requestManager,null,r,((r,o)=>{this._tileJSONRequest=null,this._loaded=!0,r?this.fire(new e.y(r)):o&&(Object.assign(this,o),o.raster_layers&&(this.rasterLayers=o.raster_layers,this.rasterLayerIds=this.rasterLayers.map((e=>e.id))),this.tileBounds=ht.fromTileJSON(o),$(o.tiles),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(r)}))}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(t,r){const o=e.o.devicePixelRatio>=2,s=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),o,this.tileSize);t.request=e.n(this.map._requestManager.transformRequest(s,e.R.Tile),((o,s,l)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(o)return t.state="errored",r(o);if(!s)return r(null);const c=e.aM(l);this.map._refreshExpiredTiles&&t.setExpiryData(c),t.setTexture(s,this.map.painter),t.state="loaded",e.aO(this.dispatcher),r(null)}))}abortTile(e,t){e.request&&(e.request.cancel(),delete e.request),t&&t()}unloadTile(t,r){t.texture&&t.texture instanceof e.T?(t.destroy(!1),t.texture&&t.texture instanceof e.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),r&&r()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Bt([t,r],o,s,{scaled:l=!0}={}){const{tileSize:c,buffer:h}=s,{x:u,y:d,z:p}=o;if(!isFinite(u)||!isFinite(d)||!isFinite(p))throw new Error("Invalid MRT header");const f=2**p,m=f*e.aF(t),_=f*e.aJ(r);return function([e,t],r,{scaled:o=!0}={}){if(!r)throw new Error("bandView is undefined");const{data:s,tileSize:l,buffer:c,offset:h,scale:u,dimension:d}=r;if(e<-c||e>l+c||t<-c||t>l+c)throw new Error(`Point (${e}, ${t}) out of bounds for tileSize=${l}, buffer=${c}`);const p=(t+c)*(l+2*c)+(e+c);if(4294967295===new Uint32Array(s.buffer)[p])return null;let f=[];f=o?[]:new(0,r.data.constructor)(d);for(let e=0;e<d;e++)f[e]=Math.round(1e12*(s[d*p+e]*u+h))/1e12;return f}([Math.min(Math.max(-h,Math.floor((m-u)*c)),c-1+h),Math.min(Math.max(-h,Math.floor((_-d)*c)),c-1+h)],s,{scaled:l})}class pt extends ut{constructor(e,t,r,o){super(e,t,r,o),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},t)}triggerRepaint(e){const t=this.map.painter._terrain,r=this.map.style.getSourceCache(this.id);t&&t.enabled&&r&&t._clearRenderCacheForTile(r.id,e.tileID),this.map.triggerRepaint()}loadTile(t,r){const o=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),s=this.map._requestManager.transformRequest(o,e.R.Tile),l={request:s,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=s,t.actor||(t.actor=this.dispatcher.getActor());const c=(o,s,l)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(o){if("AbortError"===o.name)return;return t.state="errored",r(o)}if(this.map._refreshExpiredTiles&&s){const r=e.aM(l);t.setExpiryData(r)}if(this.partial&&"expired"!==t.state)t.state="empty";else if(!this.partial){if(!s)return r(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=s}r(null)};t.request=this.partial?t.fetchHeader(void 0,c.bind(this)):t.actor.send("loadTile",l,c.bind(this),void 0,!0)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,t){const r=e.texturePerLayer;if(e.flushAllQueues(),r.size){e.destroy(!1);for(const e of r.values())this.map.painter.saveTileTexture(e)}else e.destroy()}prepareTile(t,r,o,s){t._isHeaderLoaded&&("empty"!==t.state&&(t.state="reloading"),t.fetchBandForRender(r,o,s,((r,s)=>{if(r)return t.state="errored",this.fire(new e.y(r)),void this.triggerRepaint(t);s&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(o,s,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(e){if(!this.rasterLayers)return 0;const t=this.rasterLayers.find((({id:t})=>t===e)),r=t&&t.fields,o=r&&r.bands&&r.bands;return o?o[0]:0}getTextureDescriptor(t,r,o){if(!t)return;const s=r.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!s)return;let l=null;r instanceof e.aR?l=r.paint.get("raster-array-band"):r instanceof e.aS&&(l=r.paint.get("raster-particle-array-band"));const c=l||this.getInitialBand(s);if(null==c)return;if(!t.textureDescriptorPerLayer.get(r.id))return void this.prepareTile(t,s,r.id,c);if(t.updateNeeded(r.id,c)&&!o)return;const h=t.textureDescriptorPerLayer.get(r.id);return Object.assign({},h,{texture:t.texturePerLayer.get(r.id)})}getImages(t,r){const o=new Map;for(const s of t)for(const t of r){const[r,l]=t.split("/"),c=s.getLayer(r);if(!c)continue;if(!c.hasBand(l)||!c.hasDataForBand(l))continue;const{bytes:h,tileSize:u,buffer:d}=c.getBandView(l),p=u+2*d,f={data:new e.q({width:p,height:p},h),pixelRatio:2,sdf:!1,usvg:!1,version:0};o.set(t,f)}return o}queryRasterArrayValueByBandId(t,r,o){const s=r._mrt;return new Promise((l=>{const c={},h=new Set;for(const[u,d]of Object.entries(s.layers)){if(o.layerName&&u!==o.layerName)continue;const p={};c[u]=p;for(const{bands:f}of d.dataIndex)for(const m of f)o.bands&&!o.bands.includes(m)||(h.add(e.B(u,m)),r.fetchBand(u,null,m,(r=>{e.o.frame((()=>{p[m]=r?null:Bt([t.lng,t.lat],s,d.getBandView(m)),h.delete(e.B(u,m)),0===h.size&&l(c)}))}),!1))}0===h.size&&l(c)}))}_loadTileForQuery(t,r){if(this._loadTileLoaded[t.uid])return void r(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(r);this._loadTilePending[t.uid]=[r];const o=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),s=this.map._requestManager.transformRequest(o,e.R.Tile);t.actor.send("loadTile",{request:s,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},((r,o,s)=>{if(r)return this._loadTilePending[t.uid].forEach((e=>e(r,null))),void delete this._loadTilePending[t.uid];if(!o)return this._loadTilePending[t.uid].forEach((e=>e(null,null))),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&o){const r=e.aM(s);t.setExpiryData(r)}t._mrt=o,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach((e=>e(null,o))),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]}),void 0,!0)}queryRasterArrayValueByAllBands(e,t,r){return new Promise(((o,s)=>{this._loadTileForQuery(t,((l,c)=>{l?s(l):o(c?this.queryRasterArrayValueByBandId(e,t,r):null)}))}))}queryRasterArrayValue(t,r){const o=e.aT.convert(t),s=this.findLoadedParent(o);return s&&s._mrt?r.bands||!this.partial?this.queryRasterArrayValueByBandId(o,s,r):this.queryRasterArrayValueByAllBands(o,s,r):Promise.resolve(null)}findLoadedParent(t){const r=e.ae.fromLngLat(t,this.map.transform.tileSize),o=this.maxzoom+1,s=1<<o,l=Math.floor(r.x),c=Math.floor((r.x-l)*s),h=Math.floor(r.y*s),u=this.map.style.getSourceCache(this.id),d=new e.aQ(o,l,o,c,h);return u.findLoadedParent(d,this.minzoom)}}const kt={vector:dt,raster:ut,"raster-dem":class extends ut{constructor(e,t,r,o){super(e,t,r,o),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(t,r){const o=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(e,o){e&&(t.state="errored",r(e)),o&&(t.dem=o,t.dem.onDeserialize(),t.needsHillshadePrepare=!0,t.needsDEMTextureUpload=!0,t.state="loaded",r(null))}t.request=e.n(this.map._requestManager.transformRequest(o,e.R.Tile),function(o,l,c){if(delete t.request,t.aborted)t.state="unloaded",r(null);else if(o)t.state="errored",r(o);else if(l){const r=e.aM(c);this.map._refreshExpiredTiles&&t.setExpiryData(r);const o=ImageBitmap&&l instanceof ImageBitmap&&e.r(),h=1-(l.width-e.aP(l.width))/2;h<1||t.neighboringTiles||(t.neighboringTiles=this._getNeighboringTiles(t.tileID));const u=o?l:e.o.getImageData(l,h),d={uid:t.uid,tileID:t.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:u,encoding:this.encoding,padding:h};t.actor&&"expired"!==t.state||(t.actor=this.dispatcher.getActor(),t.actor.send("loadTile",d,s.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(t){const r=t.canonical,o=Math.pow(2,r.z),s=(r.x-1+o)%o,l=0===r.x?t.wrap-1:t.wrap,c=(r.x+1+o)%o,h=r.x+1===o?t.wrap+1:t.wrap,u={};return u[new e.aQ(t.overscaledZ,l,r.z,s,r.y).key]={backfilled:!1},u[new e.aQ(t.overscaledZ,h,r.z,c,r.y).key]={backfilled:!1},r.y>0&&(u[new e.aQ(t.overscaledZ,l,r.z,s,r.y-1).key]={backfilled:!1},u[new e.aQ(t.overscaledZ,t.wrap,r.z,r.x,r.y-1).key]={backfilled:!1},u[new e.aQ(t.overscaledZ,h,r.z,c,r.y-1).key]={backfilled:!1}),r.y+1<o&&(u[new e.aQ(t.overscaledZ,l,r.z,s,r.y+1).key]={backfilled:!1},u[new e.aQ(t.overscaledZ,t.wrap,r.z,r.x,r.y+1).key]={backfilled:!1},u[new e.aQ(t.overscaledZ,h,r.z,c,r.y+1).key]={backfilled:!1}),u}},"raster-array":pt,geojson:class extends e.E{constructor(t,r,o,s){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(s),this._data=r.data,this._options=Object.assign({},r),this._collectResourceTiming=r.collectResourceTiming,void 0!==r.maxzoom&&(this.maxzoom=r.maxzoom),void 0!==r.minzoom&&(this.minzoom=r.minzoom),r.type&&(this.type=r.type),r.attribution&&(this.attribution=r.attribution),this.promoteId=r.promoteId;const l=e.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:r.cluster||!1,geojsonVtOptions:{buffer:(void 0!==r.buffer?r.buffer:128)*l,tolerance:(void 0!==r.tolerance?r.tolerance:.375)*l,extent:e.al,maxZoom:this.maxzoom,lineMetrics:r.lineMetrics||!1,generateId:r.generateId||!1},superclusterOptions:{maxZoom:void 0!==r.clusterMaxZoom?r.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,r.clusterMinPoints||2),extent:e.al,radius:(void 0!==r.clusterRadius?r.clusterRadius:50)*l,log:!1,generateId:r.generateId||!1},clusterProperties:r.clusterProperties,filter:r.filter,dynamic:r.dynamic},r.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}updateData(t){if(!this._options.dynamic)return this.fire(new e.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof t&&("Feature"===t.type&&(t={type:"FeatureCollection",features:[t]}),"FeatureCollection"!==t.type))return this.fire(new e.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof t&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const e=new Map;for(const t of this._data.features)e.set(t.id,t);for(const r of t.features)e.set(r.id,r);this._data.features=[...e.values()]}else this._data=t;return this._updateWorkerData(!0),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,r,o){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:r},o),this}_updateWorkerData(t=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new e.z("dataloading",{dataType:"source"})),this._loaded=!1;const r=Object.assign({append:t},this.workerOptions);r.scope=this.scope;const o=this._data;"string"==typeof o?(r.request=this.map._requestManager.transformRequest(e.o.resolveURL(o),e.R.Source),r.request.collectResourceTiming=this._collectResourceTiming):r.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,r,((r,o)=>{if(this._loaded=!0,this._pendingLoad=null,r)this.fire(new e.y(r));else{const r={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&o&&o.resourceTiming&&o.resourceTiming[this.id]&&(r.resourceTiming=o.resourceTiming[this.id]),t&&(this._partialReload=!0),this.fire(new e.z("data",r)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(t),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const t=e.B(this.id,this.scope);this.map.style.clearSource(t),this._updateWorkerData()}loadTile(t,r){const o=t.actor?"reloadTile":"loadTile";t.actor=this.actor;const s=this.map.style?this.map.style.getLut(this.scope):null,l=s?{image:s.image.clone()}:null,c=this._partialReload,h={type:this.type,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:l,scope:this.scope,pixelRatio:e.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:c,worldview:this.map.getWorldview(),indoor:this.map.getIndoorTileOptions(this.id,this.scope)};t.request=this.actor.send(o,h,((e,s)=>c&&!s?(t.state="loaded",r(null)):(delete t.request,t.destroy(!1),t.aborted?r(null):e?r(e):(t.loadVectorData(s,this.map.painter,"reloadTile"===o),r(null)))),void 0,"loadTile"===o)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e,t){this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}onRemove(e){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends e.aU{constructor(e,t,r,o){super(e,t,r,o),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const t=this.options;this.urls=[];for(const r of t.urls)this.urls.push(this.map._requestManager.transformRequest(r,e.R.Source).url);e.aV(this.urls,((t,r)=>{this._loaded=!0,t?this.fire(new e.y(t)):r&&(this.video=r,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const r=this.video.seekable;t<r.start(0)||t>r.end(0)?this.fire(new e.y(new e.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${r.start(0)} and ${r.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const t=this.map.painter.context,r=t.gl;this.texture?this.video.paused||(this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),r.texSubImage2D(r.TEXTURE_2D,0,0,0,r.RGBA,r.UNSIGNED_BYTE,this.video)):(this.texture=new e.T(t,this.video,r.RGBA8),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(t)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:e.aU,model:e.aX,"batched-model":class extends e.E{constructor(e,t,r,o){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=r,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(o)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=Dt(this._options,this.map._requestManager,r,o,((s,l)=>{this._tileJSONRequest=null,this._loaded=!0,s?(r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),o&&2!==o.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new e.y(s))):l&&(Object.assign(this,l),l.bounds&&(this.tileBounds=new ht(l.bounds,this.minzoom,this.maxzoom)),$(l.tiles,this.map._requestManager._customAccessToken),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(s)}))}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(t,r){const o=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),s={request:this.map._requestManager.transformRequest(o,e.R.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:e.o.devicePixelRatio,promoteId:this.promoteId};if(t.actor&&"expired"!==t.state)if("loading"===t.state)t.reloadCallback=r;else{if(t.buckets){const e=Object.values(t.buckets);for(const t of e)t.dirty=!0;return void(t.state="loaded")}t.request=t.actor.send("reloadTile",s,l.bind(this))}else t.actor=this.dispatcher.getActor(),t.request=t.actor.send("loadTile",s,l.bind(this),void 0,!0);function l(e,o){return t.aborted?r(null):e&&404!==e.status?r(e):(this.map._refreshExpiredTiles&&o&&t.setExpiryData(o),t.loadModelData(o,this.map.painter),t.state="loaded",void r(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends e.aU{constructor(t,r,o,s){super(t,r,o,s),r.coordinates?Array.isArray(r.coordinates)&&4===r.coordinates.length&&!r.coordinates.some((e=>!Array.isArray(e)||2!==e.length||e.some((e=>"number"!=typeof e))))||this.fire(new e.y(new e.V(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new e.y(new e.V(`sources.${t}`,null,'missing required property "coordinates"'))),r.animate&&"boolean"!=typeof r.animate&&this.fire(new e.y(new e.V(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),r.canvas?"string"==typeof r.canvas||r.canvas instanceof HTMLCanvasElement||this.fire(new e.y(new e.V(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new e.y(new e.V(`sources.${t}`,null,'missing required property "canvas"'))),this.options=r,this.animate=void 0===r.animate||r.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new e.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(e){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const r=this.map.painter.context;this.texture?!t&&!this._playing||this.texture instanceof e.aW||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new e.T(r,this.canvas,r.gl.RGBA8,{premultiply:!0}),this._prepareData(r)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends e.E{constructor(t,r,o,s){super(),this.id=t,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=r,this.setEventedParent(s),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new e.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new e.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ht(this._implementation.bounds,this.minzoom,this.maxzoom)),r.update=this._update.bind(this),r.clearTiles=this._clearTiles.bind(this),r.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,e.aH(r,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return e.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(t){this.map=t,this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(t),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:r,z:o}=e.canonical;return this._implementation.hasTile({x:t,y:r,z:o})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:r,y:o,z:s}=e.tileID.canonical,l=new AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:r,y:o,z:s},{signal:l.signal})).then(function(r){return delete e.request,e.aborted?(e.state="unloaded",t(null)):void 0===r?(e.state="errored",t(null)):null===r?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):function(e){return e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof ImageBitmap||e instanceof HTMLImageElement}(r)?(this.loadTileData(e,r),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((r=>{"AbortError"!==r.name&&(e.state="errored",t(r))})),e.request.cancel=()=>l.abort()}loadTileData(e,t){e.setTexture(t,this.map.painter)}unloadTile(t,r){if(t.texture&&t.texture instanceof e.T?(t.destroy(!1),t.texture&&t.texture instanceof e.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),this._implementation.unloadTile){const{x:e,y:r,z:o}=t.tileID.canonical;this._implementation.unloadTile({x:e,y:r,z:o})}r&&r()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z})))}_clearTiles(){const t=e.B(this.id,this.scope);this.map.style.clearSource(t)}_update(){this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}}},Vt=function(t,r,o,s){const l=new kt[r.type](t,r,o,s);if(l.id!==t)throw new Error(`Expected Source id to be ${t} instead of ${l.id}`);return e.aY(["load","abort","unload","serialize","prepare"],l),l};function Nt(e,t,r=""){return`${r}:${t.id||""}:${t.layer.id}:${function(e){if("layerId"in e)return`layer:${e.layerId}`;{const{featuresetId:t,importId:r}=e;return`featureset:${t}${r?`:import:${r}`:""}`}}(e.target)}`}function jt(e,t,r,o=""){if(e.uniqueFeatureID){const s=Nt(e,t,o);if(r.has(s))return!0;r.add(s)}return!1}function Gt(e,t,r,o,s=!1,l=void 0){const c=t.sourceCache.transform,h=t.sourceCache.tilesIn(e,t.has3DLayers,s);h.sort(Ht);const u=[];for(const e of h){const h=e.tile.queryRenderedFeatures(t,e,r,o,c,s,l);Object.keys(h).length&&u.push({wrappedTileID:e.tile.tileID.wrapped().key,queryResults:h})}for(const r in t.layers){const s=t.layers[r];if(s.styleLayer){const r=s.styleLayer.queryRenderedFeatures(e,t.sourceCache,o);Object.keys(r).length&&u.push({wrappedTileID:0,queryResults:r})}}return 0===u.length?{}:function(e){const t={},r={};for(const o of e){const e=o.queryResults,s=o.wrappedTileID,l=r[s]=r[s]||{};for(const r in e){const o=e[r],s=l[r]=l[r]||{},c=t[r]=t[r]||[];for(const e of o)s[e.featureIndex]||(s[e.featureIndex]=!0,c.push(e))}}return t}(u)}function $t(e,t,r,o,s,l){const c={},h=o.queryRenderedSymbols(e),u=[];for(const e of Object.keys(h).map(Number))u.push(s[e]);u.sort(Ht);for(const e of u){const o=e.featureIndex.lookupSymbolFeatures(h[e.bucketInstanceId],e.bucketIndex,e.sourceLayerIndex,t,r,l);for(const t in o){const r=c[t]=c[t]||[],s=o[t];s.sort(((t,r)=>{const o=e.featureSortOrder;if(o){const e=o.indexOf(t.featureIndex);return o.indexOf(r.featureIndex)-e}return r.featureIndex-t.featureIndex}));for(const e of s)r.push(e)}}return c}function qt(e,t){const r=e.getRenderableIds().map((t=>e.getTileByID(t))),o=[],s={};for(let e=0;e<r.length;e++){const l=r[e],c=l.tileID.canonical.key;s[c]||(s[c]=!0,l.querySourceFeatures(o,t))}return o}function Ht(e,t){const r=e.tileID,o=t.tileID;return r.overscaledZ-o.overscaledZ||r.canonical.y-o.canonical.y||r.wrap-o.wrap||r.canonical.x-o.canonical.x}function Wt(e,t){const r={};if(!t)return r;for(const o of e){const e=o.layerIds.map((e=>t.getLayer(e))).filter(Boolean);if(0!==e.length){o.layers=e,o.stateDependentLayerIds&&(o.stateDependentLayers=o.stateDependentLayerIds.map((t=>e.filter((e=>e.id===t))[0])));for(const t of e)r[t.fqid]=o}}return r}const Zt=32,Xt=33,Yt=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,r=0,o=0,s=0,l=0,c=0,h=0;for(1&t?s=l=c=Zt:r=o=h=Zt;(t>>=1)>1;){const e=r+s>>1,u=o+l>>1;1&t?(s=r,l=o,r=c,o=h):(r=s,o=l,s=c,l=h),c=e,h=u}const u=4*e;Yt[u+0]=r,Yt[u+1]=o,Yt[u+2]=s,Yt[u+3]=l}const Jt=new Uint16Array(2178),Qt=new Uint8Array(1089),Kt=new Uint16Array(1089);function ii(e){return 0===e?-.03125:32===e?.03125:0}const ri=(()=>({type:2,extent:e.al,loadGeometry:()=>[[new e.P(0,0),new e.P(e.al+1,0),new e.P(e.al+1,e.al+1),new e.P(0,e.al+1),new e.P(0,0)]]}))();class Pt{constructor(t,r,o,s,l,c){this.tileID=t,this.uid=e.b2(),this.uses=0,this.tileSize=r,this.tileZoom=o,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=l,s&&s.style&&(this._lastUpdatedBrightness=s.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",s&&s.transform&&(this.projection=s.transform.projection),this.worldview=c,this._hasAppearances=null}registerFadeDuration(t){const r=t+this.timeAdded;r<e.o.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=e.aZ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,r,o){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Wt(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const t in this.buckets){const r=this.buckets[t];if(r instanceof e.b4){if(this.hasSymbolBuckets=!0,!o)break;r.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const t in this.buckets){const r=this.buckets[t];if(r instanceof e.b4&&r.hasRTLText){this.hasRTLText=!0,e.b5();break}}this.queryPadding=0;for(const e in this.buckets){const t=this.buckets[e],o=r.style.getOwnLayer(e);if(!o)continue;const s=o.queryRadius(t);this.queryPadding=Math.max(this.queryPadding,s)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new e.b3}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(e,t,r){e&&(e.resourceTiming&&(this.resourceTiming=e.resourceTiming),this.buckets=Object.assign({},this.buckets,Wt(e.buckets,t.style)),e.featureIndex&&(this.latestFeatureIndex=e.featureIndex))}getBucket(e){return this.buckets[e.fqid]}upload(t,r){for(const e in this.buckets){const o=this.buckets[e];if(o.uploadPending()){let e={},s=[],l={zoom:0,pitch:0,brightness:0,worldview:""};if(r){if(r.style){s=r.style.listImages();const t=o.layers[0],l=t.sourceLayer||"_geojsonTileLayer",c=r.style.getLayerSourceCache(t);c&&(e=c._state.getState(l,void 0))}l={zoom:r.transform.zoom||0,pitch:r.transform.pitch||0,brightness:r.style.getBrightness()||0,worldview:r.worldview||""}}o.upload(t,this.tileID.canonical,e,s,l)}}const o=t.gl,s=this.imageAtlas;s&&!s.uploaded&&(this.imageAtlasTexture=new e.T(t,s.image,o.RGBA8,{useMipmap:!!s.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new e.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new e.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(e,t,r){if(this.imageAtlas&&this.imageAtlasTexture&&t){const o=t.style.getLut(r);this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,r,o)}if(!t||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const o=t.style.getBrightness();null===this._hasAppearances&&(this._hasAppearances=this.hasAppearances(t)),(this._lastUpdatedBrightness||o||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&o&&Math.abs(this._lastUpdatedBrightness-o)<.001||(this.updateBuckets(t,this._lastUpdatedBrightness!==o),this._lastUpdatedBrightness=o))}evaluateQueryRenderedFeaturePadding(){let e=0;for(const t in this.buckets){const r=this.buckets[t];r.evaluateQueryRenderedFeaturePadding&&(e=Math.max(e,r.evaluateQueryRenderedFeaturePadding()))}return e}queryRenderedFeatures(t,r,o,s,l,c,h){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const u=this.evaluateQueryRenderedFeaturePadding(),d=function(t,r){const o=e.bq([],[.5*t.width,.5*-t.height,1]);return e.br(o,o,[1,-1,0]),e.aB(o,o,t.calculateProjMatrix(r.toUnwrapped())),Float32Array.from(o)}(l,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:r,pixelPosMatrix:d,transform:s,availableImages:o,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:u,scope:h})}querySourceFeatures(t,r){const o=this.latestFeatureIndex;if(!o||!o.rawTileData)return;const s=o.loadVTLayers(),l=r?r.sourceLayer:"",c=s._geojsonTileLayer||s[l];if(!c)return;const h=e.b6(r&&r.filter),{z:u,x:d,y:p}=this.tileID.canonical,f={z:u,x:d,y:p};for(let r=0;r<c.length;r++){const s=c.feature(r);if(h.needGeometry){const t=e.b7(s,!0);if(!h.filter(new e.ac(this.tileID.overscaledZ,{worldview:this.worldview}),t,this.tileID.canonical))continue}else if(!h.filter(new e.ac(this.tileID.overscaledZ,{worldview:this.worldview}),s))continue;const m=o.getId(s,l),_=new e.b8(s,u,d,p,m);_.tile=f,t.push(_)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const r=e.b9(t.cacheControl);r["max-age"]&&(this.expirationTime=Date.now()+1e3*r["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const e=Date.now();let t=!1;if(this.expirationTime>e)t=!1;else if(r)if(this.expirationTime<r)t=!0;else{const o=this.expirationTime-r;o?this.expirationTime=e+Math.max(o,3e4):t=!0}else t=!0;t?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(e){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&e&&this.updateBuckets(e)}hasAppearances(e){for(const t in this.buckets)if(e.style.hasLayer(t)&&this.buckets[t].layers.some((e=>e.appearances&&e.appearances.length>0)))return!0;return!1}updateBuckets(t,r){if(!this.latestFeatureIndex)return;if(!t.style)return;const o=t.style.listImages(),s=t.style.getBrightness();for(const l in this.buckets){if(!t.style.hasLayer(l))continue;const c=this.buckets[l],h=c.layers[0],u=h.sourceLayer||"_geojsonTileLayer",d=t.style.getLayerSourceCache(h);let p={};d&&(p=d._state.getState(u,void 0));const f=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},m=Object.keys(p).length>0&&!r;c.hasAppearances=c.layers.some((e=>e.appearances&&e.appearances.length>0));const _=m?c.stateDependentLayers:c.layers;if(m&&0!==c.stateDependentLayers.length||r){const e=this.latestFeatureIndex.loadVTLayers();c.update(p,e[u],o,f,_,r,s)}if(m&&0!==c.stateDependentLayers.length||r||c.hasAppearances){const e={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};c.updateAppearances(this.tileID.canonical,p,o,e,t.imageManager)}(c instanceof e.ba||c instanceof e.bb)&&t._terrain&&t._terrain.enabled&&d&&c.uploadPending()&&t._terrain._clearRenderCacheForTile(d.id,this.tileID);const v=t&&t.style&&t.style.getOwnLayer(l);v&&(this.queryPadding=Math.max(this.queryPadding,v.queryRadius(c)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<e.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=e.o.now()+t}setTexture(t,r){const o=r.context,s=o.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture&&this.texture instanceof e.T?this.texture.update(t):(this.texture=new e.T(o,t,s.RGBA8,{useMipmap:!0}),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE))}setDependencies(e,t){const r={};for(const e of t)r[e]=!0;this.dependencies[e]=r}hasDependency(e,t){for(const r of e){const e=this.dependencies[r];if(e)for(const r of t)if(e[r])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,r){if(!r||"mercator"===r.name||this._tileDebugBuffer)return;const o=e.bc(ri,this.tileID.canonical,this.tileTransform)[0],s=new e.bd,l=new e.be;for(let e=0;e<o.length;e++){const{x:t,y:r}=o[e];s.emplaceBack(t,r),l.emplaceBack(e)}l.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(l),this._tileDebugBuffer=t.createVertexBuffer(s,e.bf.members),this._tileDebugSegments=e.bg.simpleSegment(0,0,s.length,l.length)}_makeTileBoundsBuffers(t,r){if(this._tileBoundsBuffer||!r||"mercator"===r.name)return;const o=e.bc(ri,this.tileID.canonical,this.tileTransform)[0];let s,l;if(this.isRaster){const t=function(t,r){const o=e.aZ(t,r),s=Math.pow(2,t.z);for(let l=0;l<Xt;l++)for(let c=0;c<Xt;c++){const h=e.a_((t.x+(c+ii(c))/Zt)/s),u=e.a$((t.y+(l+ii(l))/Zt)/s),d=r.project(h,u),p=l*Xt+c;Jt[2*p+0]=Math.round((d.x*o.scale-o.x)*e.al),Jt[2*p+1]=Math.round((d.y*o.scale-o.y)*e.al)}Qt.fill(0),Kt.fill(0);for(let e=2045;e>=0;e--){const t=4*e,r=Yt[t+0],o=Yt[t+1],s=Yt[t+2],l=Yt[t+3],c=r+s>>1,h=o+l>>1,u=c+h-o,d=h+r-c,p=o*Xt+r,f=l*Xt+s,m=h*Xt+c,_=Math.hypot((Jt[2*p+0]+Jt[2*f+0])/2-Jt[2*m+0],(Jt[2*p+1]+Jt[2*f+1])/2-Jt[2*m+1])>=16;Qt[m]=Qt[m]||(_?1:0),e<1022&&(Qt[m]=Qt[m]||Qt[(o+d>>1)*Xt+(r+u>>1)]||Qt[(l+d>>1)*Xt+(s+u>>1)])}const l=new e.b1,c=new e.b0;let h=0;function u(t,r){const o=r*Xt+t;return 0===Kt[o]&&(l.emplaceBack(Jt[2*o+0],Jt[2*o+1],t*e.al/Zt,r*e.al/Zt),Kt[o]=++h),Kt[o]-1}function d(e,t,r,o,s,l){const h=e+r>>1,p=t+o>>1;if(Math.abs(e-s)+Math.abs(t-l)>1&&Qt[p*Xt+h])d(s,l,e,t,h,p),d(r,o,s,l,h,p);else{const h=u(e,t),d=u(r,o),p=u(s,l);c.emplaceBack(h,d,p)}}return d(0,0,Zt,Zt,Zt,0),d(Zt,Zt,0,0,0,Zt),{vertices:l,indices:c}}(this.tileID.canonical,r);s=t.vertices,l=t.indices}else{s=new e.b1,l=new e.b0;for(const{x:e,y:t}of o)s.emplaceBack(e,t,0,0);const t=e.bh(s.int16.subarray(0,4*s.length),void 0,4);for(let e=0;e<t.length;e+=3)l.emplaceBack(t[e],t[e+1],t[e+2])}this._tileBoundsBuffer=t.createVertexBuffer(s,e.bi.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(l),this._tileBoundsSegments=e.bg.simpleSegment(0,0,s.length,l.length)}_makeGlobeTileDebugBuffers(t,r){const o=r.projection;if(!o||"globe"!==o.name||r.freezeTileCoverage)return;const s=this.tileID.canonical,l=e.bj(s,r),c=e.bk(l),h=e.aj(r.zoom);let u;h>0&&(u=e.bl(new Float64Array(16),r.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,s,r,c,u,h),this._makeGlobeTileDebugTextBuffer(t,s,r,c,u,h)}_globePoint(t,r,o,s,l,c,h){let u=e.bm(t,r,o);if(c){const l=1<<o.z,d=e.aF(s.center.lng),p=e.aJ(s.center.lat),f=(o.x+.5)/l-d;let m=0;f>.5?m=-1:f<-.5&&(m=1);let _=(t/e.al+o.x)/l+m,v=(r/e.al+o.y)/l;_=(_-d)*s._pixelsPerMercatorPixel+d,v=(v-p)*s._pixelsPerMercatorPixel+p;const E=[_*s.worldSize,v*s.worldSize,0];e.af(E,E,c),u=e.bn(u,E,h)}return e.af(u,u,l)}_makeGlobeTileDebugBorderBuffer(t,r,o,s,l,c){const h=new e.bd,u=new e.be,d=new e.bo,p=(e,t,p,f,m)=>{const _=(p-e)/(m-1),v=(f-t)/(m-1),E=h.length;for(let p=0;p<m;p++){const f=e+p*_,m=t+p*v;h.emplaceBack(f,m);const P=this._globePoint(f,m,r,o,s,l,c);d.emplaceBack(P[0],P[1],P[2]),u.emplaceBack(E+p)}},f=e.al;p(0,0,f,0,16),p(f,0,f,f,16),p(f,f,0,f,16),p(0,f,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(u),this._tileDebugBuffer=t.createVertexBuffer(h,e.bf.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(d,e.bp.members),this._tileDebugSegments=e.bg.simpleSegment(0,0,h.length,u.length)}_makeGlobeTileDebugTextBuffer(t,r,o,s,l,c){const h=e.al/4,u=new e.bd,d=new e.b0,p=new e.bo,f=25;d.reserve(32),u.reserve(f),p.reserve(f);const m=(e,t)=>f*e+t;for(let e=0;e<f;e++){const t=e*h;for(let e=0;e<f;e++){const d=e*h;u.emplaceBack(d,t);const f=this._globePoint(d,t,r,o,s,l,c);p.emplaceBack(f[0],f[1],f[2])}}for(let e=0;e<4;e++)for(let t=0;t<4;t++){const r=m(e,t),o=m(e,t+1),s=m(e+1,t),l=m(e+1,t+1);d.emplaceBack(r,o,s),d.emplaceBack(s,o,l)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(d),this._tileDebugTextBuffer=t.createVertexBuffer(u,e.bf.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(p,e.bp.members),this._tileDebugTextSegments=e.bg.simpleSegment(0,0,f,32)}destroy(t=!0){for(const e in this.buckets)this.buckets[e].destroy(t);this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),t&&this.texture&&this.texture instanceof e.T&&(this.texture.destroy(),delete this.texture),this.emissiveTexture&&this.emissiveTexture instanceof e.T&&(this.emissiveTexture.destroy(),delete this.emissiveTexture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}e.bs.setPbf(e.bt);class Ot extends Pt{constructor(e,t,r,o,s){super(e,t,r,o,s),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(e){return this._mrt&&this._mrt.getLayer(e)}setTexturePerLayer(t,r,o){const s=o.context,l=s.gl;let c=this.texturePerLayer.get(t)||o.getTileTexture(r.width);c&&c instanceof e.T?c.update(r,{premultiply:!1}):c=new e.T(s,r,l.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,c)}flushQueues(e){const t=this._workQueuePerLayer.get(e)||[],r=this._fetchQueuePerLayer.get(e)||[];for(;t.length;)t.pop()();for(;r.length;)r.pop()()}flushAllQueues(){for(const e of this._workQueuePerLayer.keys()){const t=this._workQueuePerLayer.get(e)||[];for(;t.length;)t.pop()()}for(const e of this._fetchQueuePerLayer.keys()){const t=this._fetchQueuePerLayer.get(e)||[];for(;t.length;)t.pop()()}}fetchHeader(t=16384,r){const o=this._mrt=new e.bs(30),s=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=e.bu(s,((e,s,l)=>{if(e)r(e);else try{const e=o.getHeaderLength(s);if(e>t)return void(this.request=this.fetchHeader(e,r));o.parseHeader(s),this._isHeaderLoaded=!0;let c=0;for(const e of Object.values(o.layers))c=Math.max(c,e.dataIndex[e.dataIndex.length-1].lastByte);s.byteLength>=c&&(this.entireBuffer=s),r(null,this.entireBuffer||s,l)}catch(e){r(e)}})),this.request}fetchBandForRender(e,t,r,o){this.fetchBand(e,t,r,(s=>{if(s)return void o(s);this.updateTextureDescriptor(e,t,r);const l=this.textureDescriptorPerLayer.get(t);o(null,l?l.img:null)}))}fetchBand(t,r,o,s,l=!0){const c=this._mrt;if(!this._isHeaderLoaded||!c)return void s(new Error("Tile header is not ready"));const h=this.actor;if(!h)return void s(new Error("Can't fetch tile band without an actor"));let u;const d=e.B(String(o),e.B(this.tileID.key,t));let p=this._taskQueue.get(d);p?p.add(s):(p=new Set,p.add(s),this._taskQueue.set(d,p));const f=(e,t)=>{u.complete(e,t),e?s(e):(p.forEach((e=>e(null,t))),this._taskQueue.delete(d))},m=(e,t)=>{if(e)return s(e);const o=h.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:t,task:u},f,void 0,!0);if(null!==r){const e=this._workQueuePerLayer.get(r)||[];e.push((()=>{o&&o.cancel(),u.cancel()})),this._workQueuePerLayer.has(r)||this._workQueuePerLayer.set(r,e)}};let _;try{_=c.getLayer(t)}catch(e){if("reloading"===this.state)return;throw e}if(!_)return void s(new Error(`Unknown sourceLayer "${t}"`));if(_.hasDataForBand(o))return p.forEach((e=>e(null,null))),void this._taskQueue.delete(d);const v=_.getDataRange([o]);if(u=c.createDecodingTask(v),!u||u.tasks.length)if(null!==r&&this.flushQueues(r),this.entireBuffer)m(null,this.entireBuffer.slice(v.firstByte,v.lastByte+1));else{const t=Object.assign({},this.requestParams,{headers:{Range:`bytes=${v.firstByte}-${v.lastByte}`}}),o=e.bu(t,m);if(null!==r){const e=this._fetchQueuePerLayer.get(r)||[];e.push((()=>{o.cancel(),u.cancel()})),this._fetchQueuePerLayer.has(r)||this._fetchQueuePerLayer.set(r,e)}}}updateNeeded(e,t){return(!this.textureDescriptorPerLayer.get(e)||this.textureDescriptorPerLayer.get(e).band!==t||this.refreshedUponExpiration)&&"errored"!==this.state}updateTextureDescriptor(t,r,o){if(!this._mrt)return;const s=this._mrt.getLayer(t);if(!s||!s.hasBand(o)||!s.hasDataForBand(o))return;const{bytes:l,tileSize:c,buffer:h,offset:u,scale:d}=s.getBandView(o),p=c+2*h,f=new e.q({width:p,height:p},l),m=this.texturePerLayer.get(r);m&&m instanceof e.T&&m.update(f,{premultiply:!1}),this.textureDescriptorPerLayer.set(r,{layer:t,band:o,img:f,buffer:h,offset:u,tileSize:c,format:s.pixelFormat,mix:[d,256*d,65536*d,16777216*d]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const t of this.texturePerLayer.values())t&&t instanceof e.T&&t.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class zt{constructor(e,t){this.max=e,this.onRemove=t,this.reset()}reset(){for(const e in this.data)for(const t of this.data[e])t.timeout&&clearTimeout(t.timeout),this.onRemove(t.value);return this.data={},this.order=[],this}add(e,t,r){const o=e.wrapped().key;void 0===this.data[o]&&(this.data[o]=[]);const s={value:t,timeout:void 0};if(void 0!==r&&(s.timeout=setTimeout((()=>{this.remove(e,s)}),r)),this.data[o].push(s),this.order.push(o),this.order.length>this.max){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const t=this.data[e].shift();return t.timeout&&clearTimeout(t.timeout),0===this.data[e].length&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),t.value}getByKey(e){const t=this.data[e];return t?t[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,t){if(!this.has(e))return this;const r=e.wrapped().key,o=void 0===t?0:this.data[r].indexOf(t),s=this.data[r][o];return this.data[r].splice(o,1),s.timeout&&clearTimeout(s.timeout),0===this.data[r].length&&delete this.data[r],this.onRemove(s.value),this.order.splice(this.order.indexOf(r),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}filter(e){const t=[];for(const r in this.data)for(const o of this.data[r])e(o.value)||t.push(o);for(const e of t)this.remove(e.value.tileID,e)}}class Mt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,t,r){const o=String(t);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][o]=this.stateChanges[e][o]||{},Object.assign(this.stateChanges[e][o],r),null===this.deletedStates[e]){this.deletedStates[e]={};for(const t in this.state[e])t!==o&&(this.deletedStates[e][t]=null)}else if(this.deletedStates[e]&&null===this.deletedStates[e][o]){this.deletedStates[e][o]={};for(const t in this.state[e][o])r[t]||(this.deletedStates[e][o][t]=null)}else for(const t in r)this.deletedStates[e]&&this.deletedStates[e][o]&&null===this.deletedStates[e][o][t]&&delete this.deletedStates[e][o][t]}removeFeatureState(e,t,r){if(null===this.deletedStates[e])return;const o=String(t);if(this.deletedStates[e]=this.deletedStates[e]||{},r&&void 0!==t)null!==this.deletedStates[e][o]&&(this.deletedStates[e][o]=this.deletedStates[e][o]||{},this.deletedStates[e][o][r]=null);else if(void 0!==t)if(this.stateChanges[e]&&this.stateChanges[e][o])for(r in this.deletedStates[e][o]={},this.stateChanges[e][o])this.deletedStates[e][o][r]=null;else this.deletedStates[e][o]=null;else this.deletedStates[e]=null}getState(e,t){const r=this.state[e]||{},o=this.stateChanges[e]||{},s=this.deletedStates[e];if(null===s)return{};if(void 0!==t){const e=String(t),l=Object.assign({},r[e],o[e]);if(s){const e=s[t];if(null===e)return{};for(const t in e)delete l[t]}return l}const l=Object.assign({},r,o);if(s)for(const e in s)delete l[e];return l}initializeTileState(e,t){e.refreshFeatureState(t)}coalesceChanges(e,t){const r={};for(const e in this.stateChanges){this.state[e]=this.state[e]||{};const t={};for(const r in this.stateChanges[e])this.state[e][r]||(this.state[e][r]={}),Object.assign(this.state[e][r],this.stateChanges[e][r]),t[r]=this.state[e][r];r[e]=t}for(const e in this.deletedStates){this.state[e]=this.state[e]||{};const t={};if(null===this.deletedStates[e])for(const r in this.state[e])t[r]={},this.state[e][r]={};else for(const r in this.deletedStates[e]){if(null===this.deletedStates[e][r])this.state[e][r]={};else if(this.state[e][r])for(const t of Object.keys(this.deletedStates[e][r]))delete this.state[e][r][t];t[r]=this.state[e][r]}r[e]=r[e]||{},Object.assign(r[e],t)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(r).length)for(const r in e)e[r].refreshFeatureState(t)}}class Ft extends e.E{constructor(e,t,r){super(),this.id=e,this._onlySymbols=r,t.on("data",(e=>{"source"===e.dataType&&"metadata"===e.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),t.on("error",(()=>{this._sourceErrored=!0})),this._source=t,this._tiles={},this._cache=new zt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=t.minTileCacheSize,this._maxTileCacheSize=t.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Mt,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(e){this.map=e,this._minTileCacheSize=void 0===this._minTileCacheSize&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const e in this._tiles)if(!this._tiles[e].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,t){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,t)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const t in this._tiles){const r=this._tiles[t];r.upload(e,this.map?this.map.painter:void 0),r.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((e=>e.tileID)).sort(ni).map((e=>e.key))}getRenderableIds(t,r){const o=[];for(const e in this._tiles)this._isIdRenderable(+e,t,r)&&o.push(this._tiles[e]);return t?o.sort(((t,r)=>{const o=t.tileID,s=r.tileID,l=new e.P(o.canonical.x,o.canonical.y)._rotate(this.transform.angle),c=new e.P(s.canonical.x,s.canonical.y)._rotate(this.transform.angle);return o.overscaledZ-s.overscaledZ||c.y-l.y||c.x-l.x})).map((e=>e.tileID.key)):o.map((e=>e.tileID)).sort(ni).map((e=>e.key))}hasRenderableParent(e){const t=this.findLoadedParent(e,0);return!!t&&this._isIdRenderable(t.tileID.key)}_isIdRenderable(e,t,r){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(t||!this._tiles[e].holdingForFade())&&(r||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)"errored"!==this._tiles[e].state&&this._reloadTile(+e,"reloading")}}_reloadTile(e,t){const r=this._tiles[e];r&&("loading"!==r.state&&(r.state=t),this._loadTile(r,this._tileLoaded.bind(this,r,e,t)))}_tileLoaded(t,r,o,s,l){if(s){if(t.state="errored",404!==s.status)this._source.fire(new e.y(s,{tile:t}));else{if(this._source.fire(new e.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const e=this.map.painter.terrain;this.update(this.transform,e.getScaledDemTileSize(),!0),e.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=e.o.now(),"expired"===o&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let c=new Map;l&&l.responseHeaders&&(c=l.responseHeaders),this._source.fire(new e.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:c}))}_backfillDEM(e){const t=this.getRenderableIds();for(let o=0;o<t.length;o++){const s=t[o];if(e.neighboringTiles&&e.neighboringTiles[s]){const t=this.getTileByID(s);r(e,t),r(t,e)}}function r(e,t){if(!e.dem||e.dem.borderReady)return;e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0;let r=t.tileID.canonical.x-e.tileID.canonical.x;const o=t.tileID.canonical.y-e.tileID.canonical.y,s=Math.pow(2,e.tileID.canonical.z),l=t.tileID.key;0===r&&0===o||Math.abs(o)>1||(Math.abs(r)>1&&(1===Math.abs(r+s)?r+=s:1===Math.abs(r-s)&&(r-=s)),t.dem&&e.dem&&(e.dem.backfillBorder(t.dem,r,o),e.neighboringTiles&&e.neighboringTiles[l]&&(e.neighboringTiles[l].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,t,r,o){for(const s in this._tiles){let l=this._tiles[s];if(o[s]||!l.hasData()||l.tileID.overscaledZ<=t||l.tileID.overscaledZ>r)continue;let c=l.tileID;for(;l&&l.tileID.overscaledZ>t+1;){const e=l.tileID.scaledTo(l.tileID.overscaledZ-1);l=this._tiles[e.key],l&&l.hasData()&&(c=e)}let h=c;for(;h.overscaledZ>t;)if(h=h.scaledTo(h.overscaledZ-1),e[h.key]){o[c.key]=c;break}}}findLoadedParent(e,t){if(e.key in this._loadedParentTiles){const r=this._loadedParentTiles[e.key];return r&&r.tileID.overscaledZ>=t?r:null}for(let r=e.overscaledZ-1;r>=t;r--){const t=e.scaledTo(r),o=this._getLoadedTile(t);if(o)return o}}_getLoadedTile(e){const t=this._tiles[e.key];return t&&t.hasData()?t:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,t){t=t||this._source.tileSize;const r=Math.ceil(e.width/t)+1,o=Math.ceil(e.height/t)+1,s=Math.floor(r*o*5),l="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,s):s,c="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,l):l;this._cache.setMaxSize(c)}handleWrapJump(e){const t=Math.round((e-(void 0===this._prevLng?e:this._prevLng))/360);if(this._prevLng=e,t){const e={};for(const r in this._tiles){const o=this._tiles[r];o.tileID=o.tileID.unwrapTo(o.tileID.wrap+t),e[o.tileID.key]=o}this._tiles=e;for(const e in this._timers)clearTimeout(this._timers[e]),delete this._timers[e];for(const e in this._tiles)this._setTileReloadTimer(+e,this._tiles[e])}}update(t,r,o,s,l){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!o)return;this.updateCacheSize(t,r),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const c="batched-model"===this._source.type;let h,u=this._source.maxzoom;const d=this.map&&this.map.painter?this.map.painter._terrain:null;if(d&&d.sourceCache===this&&d.attenuationRange()){const e=d.attenuationRange()[0],t=Math.floor(e)-Math.log2(d.getDemUpscale());u>t&&(u=t)}if(this.used||this.usedForTerrain){if(this._source.tileID)h=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((t=>new e.aQ(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y)));else if(0!==this.tileCoverLift){const s=t.clone();s.tileCoverLift=this.tileCoverLift,h=s.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:u,roundZoom:this._source.roundZoom&&!o,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:c}),this._source.minzoom<=1&&"globe"===t.projection.name&&(h.push(new e.aQ(1,0,1,0,0)),h.push(new e.aQ(1,0,1,1,0)),h.push(new e.aQ(1,0,1,0,1)),h.push(new e.aQ(1,0,1,1,1)))}else if(h=t.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:u,roundZoom:this._source.roundZoom&&!o,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:c}),this._source.hasTile){const e=this._source.hasTile.bind(this._source);h=h.filter((t=>e(t)))}}else h=[];if(h.length>0&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!oi(this._source.type)){const e=t.coveringZoomLevel({tileSize:r||this._source.tileSize,roundZoom:this._source.roundZoom&&!o}),u=Math.min(e,this._source.maxzoom);if(c){const e=t.extendTileCover(h,u);for(const t of e)h.push(t)}else if(l){const e=t.extendTileCoverToNearPlane(h,this.transform.getFrustum(u),u);for(const t of e)h.push(t)}else if(this.castsShadows&&s){const e=t.extendTileCover(h,u,s,16);for(const t of e)this._shadowCasterTiles[t.key]=!0,h.push(t)}}const p=this._updateRetainedTiles(h);if(oi(this._source.type)&&0!==h.length){const t={},r={},o=Object.keys(p);for(const s of o){const o=p[s],l=this._tiles[s];if(!l||l.fadeEndTime&&l.fadeEndTime<=e.o.now())continue;const c=this.findLoadedParent(o,Math.max(o.overscaledZ-Ft.maxOverzooming,this._source.minzoom));c&&(this._addTile(c.tileID),t[c.tileID.key]=c.tileID),r[s]=o}const s=h[h.length-1].overscaledZ;for(const e in this._tiles){const t=this._tiles[e];if(p[e]||!t.hasData())continue;let o=t.tileID;for(;o.overscaledZ>s;){o=o.scaledTo(o.overscaledZ-1);const s=this._tiles[o.key];if(s&&s.hasData()&&r[o.key]){p[e]=t.tileID;break}}}for(const e in t)p[e]||(this._coveredTiles[e]=!0,p[e]=t[e])}for(const e in p)this._tiles[e].clearFadeHold();const f=e.bv(this._tiles,p);for(const e of f){const t=this._tiles[e];t.hasSymbolBuckets&&!t.holdingForFade()?t.setHoldDuration(this.map._fadeDuration):t.hasSymbolBuckets&&!t.symbolFadeFinished()||this._removeTile(+e)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const t={};if(0===e.length)return t;const r={},o=e.reduce(((e,t)=>Math.min(e,t.overscaledZ)),1/0),s=e[0].overscaledZ,l=Math.max(s-Ft.maxOverzooming,this._source.minzoom),c=Math.max(s+Ft.maxUnderzooming,this._source.minzoom),h={};for(const r of e){const e=this._addTile(r);t[r.key]=r,e.hasData()||o<this._source.maxzoom&&(h[r.key]=r)}this._retainLoadedChildren(h,o,c,t);for(const o of e){let e=this._tiles[o.key];if(e.hasData())continue;if(o.canonical.z>=this._source.maxzoom){const e=o.children(this._source.maxzoom)[0],r=this.getTile(e);if(r&&r.hasData()){t[e.key]=e;continue}}else{const e=o.children(this._source.maxzoom);if(t[e[0].key]&&t[e[1].key]&&t[e[2].key]&&t[e[3].key])continue}let s=e.wasRequested();for(let c=o.overscaledZ-1;c>=l;--c){const l=o.scaledTo(c);if(r[l.key])break;if(r[l.key]=!0,e=this.getTile(l),!e&&s&&(e=this._addTile(l)),e&&(t[l.key]=l,s=e.wasRequested(),e.hasData()))break}}return t}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const t=[];let r,o=this._tiles[e].tileID;for(;o.overscaledZ>0;){if(o.key in this._loadedParentTiles){r=this._loadedParentTiles[o.key];break}t.push(o.key);const e=o.scaledTo(o.overscaledZ-1);if(r=this._getLoadedTile(e),r)break;o=e}for(const e of t)this._loadedParentTiles[e]=r}}_addTile(t){let r=this._tiles[t.key];if(r)return!0!==r.isExtraShadowCaster||!!this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const o=Boolean(r);if(!o){const e=this.map?this.map.painter:null,o=this._source.tileSize*t.overscaleFactor();r="raster-array"===this._source.type?new Ot(t,o,this.transform.tileZoom,e,this._isRaster):new Pt(t,o,this.transform.tileZoom,e,this._isRaster,this._source.worldview),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))}return r.uses++,this._tiles[t.key]=r,o||this._source.fire(new e.z("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r}_setTileReloadTimer(e,t){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const r=t.getExpiryTimeout();r&&(this._timers[e]=setTimeout((()=>{this._reloadTile(e,"expired"),delete this._timers[e]}),r))}_removeTile(e){const t=this._tiles[e];t&&(t.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||(t.hasData()&&"reloading"!==t.state||"empty"===t.state?this._cache.add(t.tileID,t,t.getExpiryTimeout()):(t.aborted=!0,this._abortTile(t),this._unloadTile(t))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,r,o){const s=[],l=this.transform;if(!l)return s;const c="globe"===l.projection.name,h=e.aF(l.center.lng);for(const u in this._tiles){const d=this._tiles[u];if(o&&d.clearQueryDebugViz(),d.holdingForFade())continue;let p;if(c){const t=d.tileID.canonical;if(0===t.z){const r=[Math.abs(e.aA(h,...si(t,-1))-h),Math.abs(e.aA(h,...si(t,1))-h)];p=[0,2*r.indexOf(Math.min(...r))-1]}else{const r=[Math.abs(e.aA(h,...si(t,-1))-h),Math.abs(e.aA(h,...si(t,0))-h),Math.abs(e.aA(h,...si(t,1))-h)];p=[r.indexOf(Math.min(...r))-1]}}else p=[0];for(const e of p){const o=t.containsTile(d,l,r,e);o&&s.push(o)}}return s}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,t){const r=this.getRenderableIds(e,t).map((e=>this._tiles[e].tileID)),o="globe"===this.transform.projection.name;for(const e of r)e.projMatrix=this.transform.calculateProjMatrix(e.toUnwrapped()),e.expandedProjMatrix=o?this.transform.calculateProjMatrix(e.toUnwrapped(),!1,!0):e.projMatrix;return r}sortCoordinatesByDistance(e){const t=e.slice(),r=this.transform._camera.position,o=this.transform._camera.forward(),s={};for(const e of t){const t=1/(1<<e.canonical.z);s[e.key]=((e.canonical.x+.5)*t+e.wrap-r[0])*o[0]+((e.canonical.y+.5)*t-r[1])*o[1]-r[2]*o[2]}return t.sort(((e,t)=>s[e.key]-s[t.key])),t}hasTransition(){if(this._source.hasTransition())return!0;if(oi(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(void 0!==r.fadeEndTime&&r.fadeEndTime>=e.o.now())return!0}return!1}setFeatureState(e,t,r){this._state.updateState(e=e||"_geojsonTileLayer",t,r)}removeFeatureState(e,t,r){this._state.removeFeatureState(e=e||"_geojsonTileLayer",t,r)}getFeatureState(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t)}setDependencies(e,t,r){const o=this._tiles[e];o&&o.setDependencies(t,r)}reloadTilesForDependencies(e,t){for(const r in this._tiles)this._tiles[r].hasDependency(e,t)&&this._reloadTile(+r,"reloading");this._cache.filter((r=>!r.hasDependency(e,t)))}_preloadTiles(t,r){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(t,r))};return void this._source.on("data",e)}const o=new Map,s=Array.isArray(t)?t:[t],l=this.map.painter.terrain,c=this.usedForTerrain&&l?l.getScaledDemTileSize():this._source.tileSize;for(const e of s){const t=e.coveringTiles({tileSize:c,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const e of t)o.set(e.key,e);this.usedForTerrain&&e.updateElevation(!1)}const h=Array.from(o.values());e.bw(h,((e,t)=>{const r=new Pt(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(r,(e=>{"raster-dem"===this._source.type&&r.dem&&this._backfillDEM(r),t(e,r)}))}),r)}}function ni(e,t){const r=Math.abs(2*e.wrap)-+(e.wrap<0),o=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||o-r||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function oi(e){return"raster"===e||"image"===e||"video"===e||"custom"===e}function si(e,t){const r=1<<e.z;return[e.x/r+t,(e.x+1)/r+t]}Ft.maxOverzooming=10,Ft.maxUnderzooming=3;class Ut{constructor(e){this.style=e,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const e=!1,t=!1;for(const r in this.style._mergedLayers){const o=this.style._mergedLayers[r];if("fill-extrusion"===o.type||"building"===o.type)this.layers.push({layer:o,visible:e,visibilityChanged:t});else if("model"===o.type){const r=this.style.getLayerSource(o);r&&"batched-model"===r.type&&this.layers.push({layer:o,visible:e,visibilityChanged:t})}}}onNewFrame(e){this.layersGotHidden=!1;for(const t of this.layers){const r=t.layer;let o=!1;"fill-extrusion"===r.type?o=!r.isHidden(e)&&r.paint.get("fill-extrusion-opacity")>0:"building"===r.type?o=!r.isHidden(e)&&r.paint.get("building-opacity")>0:"model"===r.type&&(o=!r.isHidden(e)&&r.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!o&&t.visible,t.visible=o}}updateZOffset(e,t){this.currentBuildingBuckets=[];for(const e of this.layers){const r=e.layer,o=this.style.getLayerSourceCache(r);let s=1;"fill-extrusion"===r.type?s=e.visible?r.paint.get("fill-extrusion-vertical-scale"):0:"building"===r.type&&(s=e.visible?r.paint.get("building-vertical-scale"):0);let l=o?o.getTile(t):null;if(!l&&o)for(const e in o._tiles){const r=o._tiles[e];if(t.canonical.isChildOf(r.tileID.canonical)){l=r;break}}this.currentBuildingBuckets.push({bucket:l?l.getBucket(r):null,tileID:l?l.tileID:t,verticalScale:s})}e.hasAnyZOffset=!1;let r=!1;for(let o=0;o<e.symbolInstances.length;o++){const s=e.symbolInstances.get(o),l=s.zOffset,c=this._getHeightAtTileOffset(t,s.tileAnchorX,s.tileAnchorY);s.zOffset=c!==Number.NEGATIVE_INFINITY?c:l,r||l===s.zOffset||(r=!0),e.hasAnyZOffset||0===s.zOffset||(e.hasAnyZOffset=!0)}r&&(e.zOffsetBuffersNeedUpload=!0,e.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,r,o,s){let l=r,c=o;if(t.canonical.z!==s.canonical.z){const h=s.canonical,u=1/(1<<t.canonical.z-h.z);l=(r+t.canonical.x*e.al)*u-h.x*e.al|0,c=(o+t.canonical.y*e.al)*u-h.y*e.al|0}return{tileX:l,tileY:c}}_getHeightAtTileOffset(e,t,r){let o,s;for(let l=0;l<this.layers.length;++l){const c=this.layers[l].layer;if("fill-extrusion"!==c.type&&"building"!==c.type)continue;const{bucket:h,tileID:u,verticalScale:d}=this.currentBuildingBuckets[l];if(!h)continue;const{tileX:p,tileY:f}=this._mapCoordToOverlappingTile(e,t,r,u),m=h.getHeightAtTileCoord(p,f);m&&void 0!==m.height&&(m.hidden?o=m.height:s=Math.max(m.height*d,s||0))}if(void 0!==s)return s;for(let s=0;s<this.layers.length;++s){const l=this.layers[s];if("model"!==l.layer.type||!l.visible)continue;const{bucket:c,tileID:h}=this.currentBuildingBuckets[s];if(!c)continue;const{tileX:u,tileY:d}=this._mapCoordToOverlappingTile(e,t,r,h),p=c.getHeightAtTileCoord(u,d);if(p&&!p.hidden)return void 0===p.height&&void 0!==o?Math.min(p.maxHeight,o)*p.verticalScale:p.height?p.height*p.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function ai(t,r){const o={};for(const e in t)"ref"!==e&&(o[e]=t[e]);return e.bx.forEach((e=>{e in r&&(o[e]=r[e])})),o}function li(e){e=e.slice();const t=Object.create(null);for(let r=0;r<e.length;r++)t[e[r].id]=e[r];for(let r=0;r<e.length;r++)"ref"in e[r]&&(e[r]=ai(e[r],t[e[r].ref]));return e}const ci={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function hi(e,t,r){r.push({command:ci.addSource,args:[e,t[e]]})}function ui(e,t,r){t.push({command:ci.removeSource,args:[e]}),r[e]=!0}function di(e,t,r,o){ui(e,r,o),hi(e,t,r)}function pi(t,r,o){let s;for(s in t[o])if(t[o].hasOwnProperty(s)&&"data"!==s&&!e.by(t[o][s],r[o][s]))return!1;for(s in r[o])if(r[o].hasOwnProperty(s)&&"data"!==s&&!e.by(t[o][s],r[o][s]))return!1;return!0}function fi(t,r,o,s,l,c){let h;for(h in r=r||{},t=t||{})t.hasOwnProperty(h)&&(e.by(t[h],r[h])||o.push({command:c,args:[s,h,r[h],l]}));for(h in r)r.hasOwnProperty(h)&&!t.hasOwnProperty(h)&&(e.by(t[h],r[h])||o.push({command:c,args:[s,h,r[h],l]}))}function mi(e){return e.id}function _i(e,t){return e[t.id]=t,e}function gi(t,r,o){const s=r.createTileMatrix(t,t.worldSize,o.toUnwrapped());return e.aB(new Float32Array(16),t.projMatrix,s)}function vi(e,t,r){if(t.projection.name===r.projection.name)return e.projMatrix;const o=r.clone();return o.setProjection(t.projection),gi(o,t.getProjection(),e)}function Pi(e,t,r){return t.name===r.projection.name?e.projMatrix:gi(r,t,e)}class ei{constructor(e,t){this.reset(e,t)}reset(e,t){this.points=e||[],this._distances=[0];for(let e=1;e<this.points.length;e++)this._distances[e]=this._distances[e-1]+this.points[e].dist(this.points[e-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(t||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=e.aA(t,0,1);let r=1,o=this._distances[r];const s=t*this.paddedLength+this.padding;for(;o<s&&r<this._distances.length;)o=this._distances[++r];const l=r-1,c=this._distances[l],h=o-c,u=h>0?(s-c)/h:0;return this.points[l].mult(1-u).add(this.points[r].mult(u))}}class ti{constructor(e,t,r){const o=this.boxCells=[],s=this.circleCells=[];this.xCellCount=Math.ceil(e/r),this.yCellCount=Math.ceil(t/r);for(let e=0;e<this.xCellCount*this.yCellCount;e++)o.push([]),s.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=t,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/t,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,t,r,o,s){this._forEachCell(t,r,o,s,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(s)}insertCircle(e,t,r,o){this._forEachCell(t-o,r-o,t+o,r+o,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(t),this.circles.push(r),this.circles.push(o)}_insertBoxCell(e,t,r,o,s,l){this.boxCells[s].push(l)}_insertCircleCell(e,t,r,o,s,l){this.circleCells[s].push(l)}_query(e,t,r,o,s,l){if(r<0||e>this.width||o<0||t>this.height)return!s&&[];const c=[];if(e<=0&&t<=0&&this.width<=r&&this.height<=o){if(s)return!0;for(let e=0;e<this.boxKeys.length;e++)c.push({key:this.boxKeys[e],x1:this.bboxes[4*e],y1:this.bboxes[4*e+1],x2:this.bboxes[4*e+2],y2:this.bboxes[4*e+3]});for(let e=0;e<this.circleKeys.length;e++){const t=this.circles[3*e],r=this.circles[3*e+1],o=this.circles[3*e+2];c.push({key:this.circleKeys[e],x1:t-o,y1:r-o,x2:t+o,y2:r+o})}return l?c.filter(l):c}return this._forEachCell(e,t,r,o,this._queryCell,c,{hitTest:s,seenUids:{box:{},circle:{}}},l),s?c.length>0:c}_queryCircle(e,t,r,o,s){const l=e-r,c=e+r,h=t-r,u=t+r;if(c<0||l>this.width||u<0||h>this.height)return!o&&[];const d=[];return this._forEachCell(l,h,c,u,this._queryCellCircle,d,{hitTest:o,circle:{x:e,y:t,radius:r},seenUids:{box:{},circle:{}}},s),o?d.length>0:d}query(e,t,r,o,s){return this._query(e,t,r,o,!1,s)}hitTest(e,t,r,o,s){return this._query(e,t,r,o,!0,s)}hitTestCircle(e,t,r,o){return this._queryCircle(e,t,r,!0,o)}_queryCell(e,t,r,o,s,l,c,h){const u=c.seenUids,d=this.boxCells[s];if(null!==d){const s=this.bboxes;for(const p of d)if(!u.box[p]){u.box[p]=!0;const d=4*p;if(e<=s[d+2]&&t<=s[d+3]&&r>=s[d+0]&&o>=s[d+1]&&(!h||h(this.boxKeys[p]))){if(c.hitTest)return l.push(!0),!0;l.push({key:this.boxKeys[p],x1:s[d],y1:s[d+1],x2:s[d+2],y2:s[d+3]})}}}const p=this.circleCells[s];if(null!==p){const s=this.circles;for(const d of p)if(!u.circle[d]){u.circle[d]=!0;const p=3*d;if(this._circleAndRectCollide(s[p],s[p+1],s[p+2],e,t,r,o)&&(!h||h(this.circleKeys[d]))){if(c.hitTest)return l.push(!0),!0;{const e=s[p],t=s[p+1],r=s[p+2];l.push({key:this.circleKeys[d],x1:e-r,y1:t-r,x2:e+r,y2:t+r})}}}}}_queryCellCircle(e,t,r,o,s,l,c,h){const u=c.circle,d=c.seenUids,p=this.boxCells[s];if(null!==p){const e=this.bboxes;for(const t of p)if(!d.box[t]){d.box[t]=!0;const r=4*t;if(this._circleAndRectCollide(u.x,u.y,u.radius,e[r+0],e[r+1],e[r+2],e[r+3])&&(!h||h(this.boxKeys[t])))return l.push(!0),!0}}const f=this.circleCells[s];if(null!==f){const e=this.circles;for(const t of f)if(!d.circle[t]){d.circle[t]=!0;const r=3*t;if(this._circlesCollide(e[r],e[r+1],e[r+2],u.x,u.y,u.radius)&&(!h||h(this.circleKeys[t])))return l.push(!0),!0}}}_forEachCell(e,t,r,o,s,l,c,h){const u=this._convertToXCellCoord(e),d=this._convertToYCellCoord(t),p=this._convertToXCellCoord(r),f=this._convertToYCellCoord(o);for(let m=u;m<=p;m++)for(let u=d;u<=f;u++)if(s.call(this,e,t,r,o,this.xCellCount*u+m,l,c,h))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,t,r,o,s,l){const c=o-e,h=s-t,u=r+l;return u*u>c*c+h*h}_circleAndRectCollide(e,t,r,o,s,l,c){const h=(l-o)/2,u=Math.abs(e-(o+h));if(u>h+r)return!1;const d=(c-s)/2,p=Math.abs(t-(s+d));if(p>d+r)return!1;if(u<=h||p<=d)return!0;const f=u-h,m=p-d;return f*f+m*m<=r*r}}const Ci=Math.tan(85*Math.PI/180);function Di(t,r,o,s,l,c,h){const u=e.bC();if(o)if("globe"===c.name){const t=e.bD(l,r);e.aB(u,u,t)}else{const t=e.bE([],h);u[0]=t[0],u[1]=t[1],u[4]=t[2],u[5]=t[3],s||e.bB(u,u,l.angle)}else e.aB(u,l.labelPlaneMatrix,t);return u}function Li(e,t,r,o,s,l,c){const h=Di(e,t,r,o,s,l,c);return"globe"===l.name&&r||(h[2]=h[6]=h[10]=h[14]=0),h}function Oi(t,r,o,s,l,c,h){if(o){if("globe"===c.name){const u=Di(t,r,o,s,l,c,h);return e.bl(u,u),e.aB(u,t,u),u}{const r=e.bz(t),o=e.bA([]);return o[0]=h[0],o[1]=h[1],o[4]=h[2],o[5]=h[3],e.aB(r,r,o),s||e.bB(r,r,-l.angle),r}}return l.glCoordMatrix}function Fi(t,r,o,s){const l=[t,r,o,1];o?e.aC(l,l,s):_r(l,l,s);const c=l[3];return l[0]/=c,l[1]/=c,l[2]/=c,l}function Bi(e,t){return Math.min(.5+e/t*.5,1.5)}function ki(e,t){const r=e[0]/e[3],o=e[1]/e[3];return r>=-t[0]&&r<=t[0]&&o>=-t[1]&&o<=t[1]}function ji(t,r,o,s,l,c,h,u,d,p,f=1){const m=o.transform,_=s?t.textSizeData:t.iconSizeData,v=e.bK(_,o.transform.zoom,f),E="globe"===m.projection.name,P=[256/o.width*2+1,256/o.height*2+1],C=s?t.text.dynamicLayoutVertexArray:t.icon.dynamicLayoutVertexArray;C.clear();let R=null;E&&(R=s?t.text.globeExtVertexArray:t.icon.globeExtVertexArray);const z=t.lineVertexArray,D=s?t.text.placedSymbolArray:t.icon.placedSymbolArray,O=o.transform.width/o.transform.height;let F,B=!1;for(let s=0;s<D.length;s++){const f=D.get(s),{numGlyphs:E,writingMode:k}=f;if(k!==e.bL.vertical||B||F===e.bL.horizontal||(B=!0),F=k,(f.hidden||k===e.bL.vertical)&&!B){mr(E,C);continue}B=!1;const V=new e.P(f.tileAnchorX,f.tileAnchorY),N="road"===t.elevationType,U=!!m.elevation||N;let{x:j,y:$,z:q}=m.projection.projectTilePoint(V.x,V.y,p.canonical),H=null;if(U){const e=N?t.getElevationFeatureForText(s):null;H={getElevation:d,elevation:m.elevation,elevationFeature:e};const[r,o,l]=d(V,m.elevation,e);j+=r,$+=o,q+=l}const Z=[j,$,q,1];if(e.aC(Z,Z,r),!ki(Z,P)){mr(E,C);continue}const Y=Z[3],J=Bi(o.transform.getCameraToCenterDistance(m.projection),Y),Q=e.bM(_,v,f),K=h?Q/J:Q*J,ee=Fi(j,$,q,l);if(ee[3]<=0){mr(E,C);continue}let te={};const ie=e.an(t.layers[0].layout.get("text-max-angle")),re=Math.cos(ie),ne=h?null:H,oe=ar(f,K,!1,u,r,l,c,t.glyphOffsetArray,z,C,R,ee,V,te,O,ne,m.projection,p,h,re);B=oe.useVertical,ne&&oe.needsFlipping&&(te={}),(oe.notEnoughRoom||B||oe.needsFlipping&&ar(f,K,!0,u,r,l,c,t.glyphOffsetArray,z,C,R,ee,V,te,O,ne,m.projection,p,h,re).notEnoughRoom)&&mr(E,C)}s?(t.text.dynamicLayoutVertexBuffer.updateData(C),R&&t.text.globeExtVertexBuffer&&t.text.globeExtVertexBuffer.updateData(R)):(t.icon.dynamicLayoutVertexBuffer.updateData(C),R&&t.icon.globeExtVertexBuffer&&t.icon.globeExtVertexBuffer.updateData(R))}function Zi(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P){const{lineStartIndex:C,glyphStartIndex:R,segment:z}=h,D=R+h.numGlyphs,O=C+h.lineLength,F=t.getoffsetX(R),B=t.getoffsetX(D-1),k=fr(e*F,r,o,s,l,c,z,C,O,u,d,p,f,m,!0,_,v,E,P);if(!k)return null;const V=fr(e*B,r,o,s,l,c,z,C,O,u,d,p,f,m,!0,_,v,E,P);return V?{first:k,last:V}:null}function Xi(t,r,o,s){return t===e.bL.horizontal&&Math.abs(s)>Math.abs(o)?{useVertical:!0}:t===e.bL.vertical?s>0?{needsFlipping:!0}:null:0!==r&&function(e,t){return 0===e||Math.abs(t/e)>Ci}(o,s)?1===r?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function ar(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D){const O=r/24,F=t.lineOffsetX*O,B=t.lineOffsetY*O,{lineStartIndex:k,glyphStartIndex:V,numGlyphs:N,segment:U,writingMode:j,flipState:$}=t,q=k+t.lineLength,H=t=>{if(f){const[r,o,s]=t.up,l=p.length;e.bN(f,l+0,r,o,s),e.bN(f,l+1,r,o,s),e.bN(f,l+2,r,o,s),e.bN(f,l+3,r,o,s)}const[r,o,s]=t.point;e.bO(p,r,o,s,t.angle)};if(N>1){const e=Zi(O,u,F,B,o,m,_,t,d,c,v,P,!1,C,R,z,D);if(!e)return{notEnoughRoom:!0};if(s&&!o){let[r,o,s]=e.first.point,[l,c,u]=e.last.point;[r,o]=Fi(r,o,s,h),[l,c]=Fi(l,c,u,h);const d=Xi(j,$,(l-r)*E,c-o);if(t.flipState=d&&d.needsFlipping?1:2,d)return d}H(e.first);for(let e=V+1;e<V+N-1;e++){const t=fr(O*u.getoffsetX(e),F,B,o,m,_,U,k,q,d,c,v,P,!1,!1,C,R,z,D);if(!t)return p.length-=4*(e-V),{notEnoughRoom:!0};H(t)}H(e.last)}else{if(s&&!o){const r=Fi(_.x,_.y,0,l),o=k+U+1,s=new e.P(d.getx(o),d.gety(o)),c=Fi(s.x,s.y,0,l),h=c[3]>0?c:dr(_,s,r,1,l,void 0,C,R.canonical),u=Xi(j,$,(h[0]-r[0])*E,h[1]-r[1]);if(t.flipState=u&&u.needsFlipping?1:2,u)return u}const r=fr(O*u.getoffsetX(V),F,B,o,m,_,U,k,q,d,c,v,P,!1,!1,C,R,z,D);if(!r)return{notEnoughRoom:!0};H(r)}return{}}function lr(e,t,r,o,s){const{x:l,y:c,z:h}=o.projectTilePoint(e.x,e.y,t);if(!s)return Fi(l,c,h,r);const[u,d,p]=s.getElevation(e,s.elevation,s.elevationFeature);return Fi(l+u,c+d,h+p,r)}function dr(t,r,o,s,l,c,h,u){const d=lr(t.sub(r)._unit()._add(t),u,l,h,c);return e.av(d,o,d),e.aw(d,d),e.bH(d,o,d,s)}function fr(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z){const D=s?t-r:t+r;let O=D>0?1:-1,F=0;s&&(O*=-1,F=Math.PI),O<0&&(F+=Math.PI);let B=u+h+(O>0?0:1)|0,k=l,V=l,N=0,U=0;const j=Math.abs(D),$=[],q=[];let H=c,Z=H,Y=e.bF([]);const J=()=>dr(Z,H,V,j-N+1,f,_,P,C.canonical);for(;N+U<=j;){if(B+=O,B<u||B>=d)return null;if(V=k,Z=H,$.push(V),v&&q.push(Z),H=new e.P(p.getx(B),p.gety(B)),k=m[B],!k){const e=lr(H,C.canonical,f,P,_);k=e[3]>0?m[B]=e:J()}N+=U;const t=e.av([],k,V),r=e.bG(V,k);if(o&&r>0&&U>0&&e.bJ(Y,t)/(U*r)<z)return null;U=r,Y=t}E&&_&&(m[B]&&(k=J(),U=e.bG(V,k),Y=e.av([],k,V)),m[B]=k);const Q=(j-N)/U,K=H.sub(Z)._mult(Q)._add(Z),ee=e.bH([],V,Y,Q);let te=[0,0,1],ie=Y[0],re=Y[1];if(R&&(te=P.upVector(C.canonical,K.x,K.y),0!==te[0]||0!==te[1]||1!==te[2])){const t=[te[2],0,-te[0]],r=e.bI([],te,t);e.aw(t,t),e.aw(r,r),ie=e.bJ(Y,t),re=e.bJ(Y,r)}if(o){const t=e.bI([],te,Y);e.aw(t,t),e.bH(ee,ee,t,o*O)}const ne=F+Math.atan2(re,ie);return $.push(ee),v&&q.push(K),{point:ee,angle:ne,path:$,tilePath:q,up:te}}function mr(e,t){const r=t.length,o=r+4*e;t.resize(o),t.float32.fill(-1/0,4*r,4*o)}function _r(e,t,r){const o=t[0],s=t[1];return e[0]=r[0]*o+r[4]*s+r[12],e[1]=r[1]*o+r[5]*s+r[13],e[3]=r[3]*o+r[7]*s+r[15],e}const xr=100;class yi{constructor(e,t,r=new ti(e.width+200,e.height+200,25),o=new ti(e.width+200,e.height+200,25)){this.transform=e,this.grid=r,this.ignoredGrid=o,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+xr,this.screenBottomBoundary=e.height+xr,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=t}placeCollisionBox(t,r,o,s,l,c,h,u,d,p,f){let m=o.projectedAnchorX,_=o.projectedAnchorY,v=o.projectedAnchorZ;const E=o.tileAnchorX,P=o.tileAnchorY,C=o.elevation,R=o.tileID,z=t.getProjection();if(C&&R){const[e,t,r]=z.upVector(R.canonical,o.tileAnchorX,o.tileAnchorY),s=z.upVectorScale(R.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;m+=e*C*s,_+=t*C*s,v+=r*C*s}const D="globe"===t.projection.name,O="globe"===t.projection.name?e.aj(this.transform.zoom):0;if(R&&D&&O<1&&!c){const t=1<<R.canonical.z,r=e.bP(E,P);e.bQ(r,r,1/e.al),e.bR(r,r,e.bP(R.canonical.x,R.canonical.y)),e.bQ(r,r,1/t),e.bS(r,r,e.bP(s[0],s[1])),r[0]=e.bT(r[0],-.5,.5),e.bQ(r,r,e.al);const o=e.bU(r[0],r[1],e.al/(2*Math.PI),1);e.aC(o,o,l),m=e.ak(m,o[0],O),_=e.ak(_,o[1],O),v=e.ak(v,o[2],O)}const F=this.projectAndGetPerspectiveRatio(p,m,_,v,o.tileID,"globe"===z.name||!!C||this.transform.pitch>0,z),B=d*F.perspectiveRatio,k=(o.x1*r+h.x-o.padding)*B+F.point.x,V=(o.y1*r+h.y-o.padding)*B+F.point.y,N=(o.x2*r+h.x+o.padding)*B+F.point.x,U=(o.y2*r+h.y+o.padding)*B+F.point.y,j=F.perspectiveRatio<=.55||F.occluded;return!this.isInsideGrid(k,V,N,U)||!u&&this.grid.hitTest(k,V,N,U,f)||j?{box:[],offscreen:!1,occluded:F.occluded}:{box:[k,V,N,U],offscreen:this.isOffscreen(k,V,N,U),occluded:!1}}placeCollisionCircles(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P){const C=[],R=this.transform.elevation,z=t.getProjection(),D="road"===t.elevationType,O=!!R||D,F=e.bV.getAtTileOffsetFunc(P,this.transform.center.lat,this.transform.worldSize,z),B=new e.P(o.tileAnchorX,o.tileAnchorY),k=new e.P(o.tileAnchorX,o.tileAnchorY);let{x:V,y:N,z:U}=z.projectTilePoint(k.x,k.y,P.canonical),j=null;if(O){const e=D?t.getElevationFeatureForText(s):null;j={getElevation:F,elevation:R,elevationFeature:e};const[r,o,l]=F(B,R,e);V+=r,N+=o,U+=l}const $="globe"===z.name,q=this.projectAndGetPerspectiveRatio(u,V,N,U,P,$||!!R||this.transform.pitch>0,z),{perspectiveRatio:H}=q,Z=(m?h/H:h*H)/e.bY,Y=Fi(V,N,U,d),J=o.lineOffsetX*Z,Q=o.lineOffsetY*Z,K=e.an(t.layers[0].layout.get("text-max-angle")),ee=Math.cos(K),te=q.signedDistanceFromCamera>0?Zi(Z,c,J,Q,D&&1===o.flipState,Y,k,o,l,d,{},O&&!m?j:null,m&&O,z,P,m,ee):null;let ie=!1,re=!1,ne=!0;if(te&&!q.occluded){const t=.5*v*H+E,o=new e.P(-100,-100),s=new e.P(this.screenRightBoundary,this.screenBottomBoundary),l=new ei,{first:c,last:h}=te,u=c.path.length;let d=[];for(let e=u-1;e>=1;e--)d.push(c.path[e]);for(let e=1;e<h.path.length;e++)d.push(h.path[e]);const m=2.5*t;p&&(d=d.map((([e,t,r],o)=>(O&&!$&&(r=F(o<u-1?c.tilePath[u-1-o]:h.tilePath[o-u+2],R,j.elevationFeature)[2]),Fi(e,t,r,p)))),d.some((e=>e[3]<=0))&&(d=[]));let P=[];if(d.length>0){let t=1/0,r=-1/0,l=1/0,c=-1/0;for(const e of d)t=Math.min(t,e[0]),l=Math.min(l,e[1]),r=Math.max(r,e[0]),c=Math.max(c,e[1]);r>=o.x&&t<=s.x&&c>=o.y&&l<=s.y&&(P=[d.map((t=>new e.P(t[0],t[1])))],(t<o.x||r>s.x||l<o.y||c>s.y)&&(P=e.bW(P,o.x,o.y,s.x,s.y)))}for(const e of P){l.reset(e,.25*t);let o=0;o=l.length<=.5*t?1:Math.ceil(l.paddedLength/m)+1;for(let e=0;e<o;e++){const s=e/Math.max(o-1,1),c=l.lerp(s),h=c.x+xr,u=c.y+xr;C.push(h,u,t,0);const d=h-t,p=u-t,m=h+t,v=u+t;if(ne=ne&&this.isOffscreen(d,p,m,v),re=re||this.isInsideGrid(d,p,m,v),!r&&this.grid.hitTestCircle(h,u,t,_)&&(ie=!0,!f))return{circles:[],offscreen:!1,collisionDetected:ie,occluded:!1}}}}return{circles:!f&&ie||!re?[]:C,offscreen:ne,collisionDetected:ie,occluded:q.occluded}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const r=[];let o=1/0,s=1/0,l=-1/0,c=-1/0;for(const h of t){const t=new e.P(h.x+xr,h.y+xr);o=Math.min(o,t.x),s=Math.min(s,t.y),l=Math.max(l,t.x),c=Math.max(c,t.y),r.push(t)}const h=this.grid.query(o,s,l,c).concat(this.ignoredGrid.query(o,s,l,c)),u={},d={};for(const t of h){const o=t.key;if(void 0===u[o.bucketInstanceId]&&(u[o.bucketInstanceId]={}),u[o.bucketInstanceId][o.featureIndex])continue;const s=[new e.P(t.x1,t.y1),new e.P(t.x2,t.y1),new e.P(t.x2,t.y2),new e.P(t.x1,t.y2)];e.bX(r,s)&&(u[o.bucketInstanceId][o.featureIndex]=!0,void 0===d[o.bucketInstanceId]&&(d[o.bucketInstanceId]=[]),d[o.bucketInstanceId].push(o.featureIndex))}return d}insertCollisionBox(e,t,r,o,s){(t?this.ignoredGrid:this.grid).insert({bucketInstanceId:r,featureIndex:o,collisionGroupID:s},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,t,r,o,s){const l=t?this.ignoredGrid:this.grid,c={bucketInstanceId:r,featureIndex:o,collisionGroupID:s};for(let t=0;t<e.length;t+=4)l.insertCircle(c,e[t],e[t+1],e[t+2])}projectAndGetPerspectiveRatio(t,r,o,s,l,c,h){const u=[r,o,s,1];let d=!1;if(s||this.transform.pitch>0){if(e.aC(u,u,t),this.fogState&&l&&"globe"!==h.name){const t=function(t,r,o,s,l,c){const h=c.calculateFogTileMatrix(l),u=[r,o,s];return e.af(u,u,h),ft(t,e.ag(u),c.pitch,c._fov)}(this.fogState,r,o,s,l.toUnwrapped(),this.transform);d=t>.9}}else _r(u,u,t);const p=u[3];return{point:new e.P((u[0]/p+1)/2*this.transform.width+xr,(-u[1]/p+1)/2*this.transform.height+xr),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(h)/p*.5,1.5),signedDistanceFromCamera:p,occluded:c&&u[2]>p||d}}isOffscreen(e,t,r,o){return r<xr||e>=this.screenRightBoundary||o<xr||t>this.screenBottomBoundary}isInsideGrid(e,t,r,o){return r>=0&&e<this.gridRightBoundary&&o>=0&&t<this.gridBottomBoundary}getViewportMatrix(){const t=e.bA([]);return e.br(t,t,[-100,-100,0]),t}}class xi{constructor(e,t,r,o){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?t:-t))):o&&r?1:0,this.placed=r}isHidden(){return 0===this.opacity&&!this.placed}}class bi{constructor(e,t,r,o,s,l=!1){this.text=new xi(e?e.text:null,t,r,s),this.icon=new xi(e?e.icon:null,t,o,s),this.clipped=l}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class wi{constructor(e,t,r,o=!1){this.text=e,this.icon=t,this.skipFade=r,this.clipped=o}}class Ti{constructor(){this.invProjMatrix=e.bC(),this.viewportMatrix=e.bC(),this.circles=[]}}class Ei{constructor(e,t,r,o,s){this.bucketInstanceId=e,this.featureIndex=t,this.sourceLayerIndex=r,this.bucketIndex=o,this.tileID=s}}class Si{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const t=++this.maxGroupID;this.collisionGroups[e]={ID:t,predicate:e=>e.collisionGroupID===t}}return this.collisionGroups[e]}}function vr(t,r,o,s,l){const{horizontalAlign:c,verticalAlign:h}=e.c1(t),u=-(c-.5)*r,d=-(h-.5)*o,p=e.c2(t,s);return new e.P(u+p[0]*l,d+p[1]*l)}function br(t,r,o,s,l){const c=new e.P(t,r);return o&&c._rotate(s?l:-l),c}class Ri{constructor(e,t,r,o,s,l){this.transform=e.clone(),this.projection=e.projection.name,this.collisionIndex=new yi(this.transform,s),this.buildingIndex=l,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=t,this.retainedQueryData={},this.collisionGroups=new Si(r),this.collisionCircleArrays={},this.prevPlacement=o,o&&(o.prevPlacement=void 0),this.placedOrientations={},this.lastReplacementSourceUpdateTime=0}getBucketParts(t,r,o,s,l=1){const c=o.getBucket(r),h=o.latestFeatureIndex;if(!c||!h||r.fqid!==c.layerIds[0])return;const u=c.layers[0].layout,d=c.layers[0].paint,p=o.collisionBoxArray,f=Math.pow(2,this.transform.zoom-o.tileID.overscaledZ),m=o.tileSize/e.al,_=o.tileID.toUnwrapped();this.transform.setProjection(c.projection);const v=(E=o.tileID,P=c.getProjection(),C=this.transform,P.name===this.projection?C.calculateProjMatrix(E.toUnwrapped()):gi(C,P,E));var E,P,C;const R="map"===u.get("text-pitch-alignment"),z="map"===u.get("text-rotation-alignment");r.compileFilter(r.options);const D=r.dynamicFilter(),O=r.dynamicFilterNeedsFeature(),F=this.transform.calculatePixelsToTileUnitsMatrix(o),B=Li(v,o.tileID.canonical,R,z,this.transform,c.getProjection(),F);let k=null;const V=c.getProjection().createInversionMatrix(this.transform,o.tileID.canonical);if(R){const t=Oi(v,o.tileID.canonical,R,z,this.transform,c.getProjection(),F);k=e.aB([],this.transform.labelPlaneMatrix,t)}let N=null;D&&o.latestFeatureIndex&&(N={unwrappedTileID:_,dynamicFilter:D,dynamicFilterNeedsFeature:O}),this.retainedQueryData[c.bucketInstanceId]=new Ei(c.bucketInstanceId,h,c.sourceLayerIndex,c.index,o.tileID);const[U,j]=c.layers[0].layout.get("text-size-scale-range"),$=e.aA(l,U,j),[q,H]=u.get("icon-size-scale-range"),Z=e.aA(l,q,H),Y={bucket:c,layout:u,paint:d,posMatrix:v,invMatrix:V,mercatorCenter:[e.aF(this.transform.center.lng),e.aJ(this.transform.center.lat)],textLabelPlaneMatrix:B,labelToScreenMatrix:k,clippingData:N,scale:f,textPixelRatio:m,holdingForFade:o.holdingForFade(),collisionBoxArray:p,partiallyEvaluatedTextSize:e.bK(c.textSizeData,this.transform.zoom,$),partiallyEvaluatedIconSize:e.bK(c.iconSizeData,this.transform.zoom,Z),collisionGroup:this.collisionGroups.get(c.sourceID),latestFeatureIndex:o.latestFeatureIndex};if(s)for(const e of c.sortKeyRanges){const{sortKey:r,symbolInstanceStart:o,symbolInstanceEnd:s}=e;t.push({sortKey:r,symbolInstanceStart:o,symbolInstanceEnd:s,parameters:Y})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:c.symbolInstances.length,parameters:Y})}attemptAnchorPlacement(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D){const{textOffset0:O,textOffset1:F,crossTileID:B}=v,k=[O,F],V=vr(e,l,c,k,h),N=this.collisionIndex.placeCollisionBox(P,h,t,r,o,s,br(V.x,V.y,u,d,this.transform.angle),_,p,f,m.predicate);if(R){const e=P.getSymbolInstanceIconSize(D,this.transform.zoom,v.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(P,e,R,r,o,s,br(V.x,V.y,u,d,this.transform.angle),_,p,f,m.predicate).box.length)return}if(N.box.length>0){let t;return this.prevPlacement&&this.prevPlacement.variableOffsets[B]&&this.prevPlacement.placements[B]&&this.prevPlacement.placements[B].text&&(t=this.prevPlacement.variableOffsets[B].anchor),this.variableOffsets[B]={textOffset:k,width:l,height:c,anchor:e,textScale:h,prevAnchor:t},this.markUsedJustification(P,e,v,C),P.allowVerticalPlacement&&(this.markUsedOrientation(P,C,v),this.placedOrientations[B]=C),{shift:V,placedGlyphBoxes:N}}}placeLayerBucketPart(t,r,o,s,l=1){const{bucket:c,layout:h,paint:u,posMatrix:d,textLabelPlaneMatrix:p,labelToScreenMatrix:f,clippingData:m,textPixelRatio:_,mercatorCenter:v,invMatrix:E,holdingForFade:P,collisionBoxArray:C,partiallyEvaluatedTextSize:R,partiallyEvaluatedIconSize:z,collisionGroup:D,latestFeatureIndex:O}=t.parameters,F=h.get("text-optional"),B=h.get("icon-optional"),k=h.get("text-allow-overlap"),V=h.get("icon-allow-overlap"),N="map"===h.get("text-rotation-alignment"),U="map"===h.get("icon-rotation-alignment"),j="map"===h.get("text-pitch-alignment"),$=u.get("symbol-z-offset"),q="sea"===h.get("symbol-elevation-reference"),H=h.get("symbol-placement"),[Z,Y]=h.get("text-size-scale-range"),[J,Q]=h.get("icon-size-scale-range"),K=e.aA(l,Z,Y),ee=e.aA(l,J,Q),te=h.get("text-variable-anchor"),ie=N&&"point"!==H,re=U&&"point"!==H,ne=te&&c.hasTextData(),oe=c.hasIconTextFit()&&ne&&c.hasIconData();this.transform.setProjection(c.projection);const se=ne||ie,ae=re||oe;let le=k&&(V||!c.hasIconData()||B),ce=V&&(k||!c.hasTextData()||F);const he=!$.isConstant();!c.collisionArrays&&C&&c.deserializeCollisionBoxes(C),o&&s&&c.updateCollisionDebugBuffers(this.transform.zoom,C,K,ee);const ue=(t,s,l)=>{const{crossTileID:u,numVerticalGlyphVertices:C}=t;let U=null;if(m&&m.dynamicFilterNeedsFeature||he){const e=this.retainedQueryData[c.bucketInstanceId];U=O.loadFeature({featureIndex:t.featureIndex,bucketIndex:e.bucketIndex,sourceLayerIndex:e.sourceLayerIndex,layoutVertexArrayOffset:0});const r=U.properties?U.properties.worldview:null;if(c.localizable&&c.worldview&&"string"==typeof r)if("all"===r)U.properties.$localized=!0;else{if(!r.split(",").includes(c.worldview))return;U.properties.$localized=!0,U.properties.worldview=c.worldview}}if(m&&!(0,m.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:c.worldview},U,this.retainedQueryData[c.bucketInstanceId].tileID.canonical,new e.P(t.tileAnchorX,t.tileAnchorY),this.transform.calculateDistanceTileData(m.unwrappedTileID)))return this.placements[u]=new wi(!1,!1,!1,!0),void r.add(u);const H=$.evaluate(U,{});if(r.has(u))return;if(P)return void(this.placements[u]=new wi(!1,!1,!1));let Z=!1,Y=!1,J=!0,Q=!1,K=!1,ee=null,ie={box:null,offscreen:null,occluded:null},re={box:null},ne=null,oe=null,ue=null,de=0,pe=0,fe=0;l.textFeatureIndex?de=l.textFeatureIndex:t.useRuntimeCollisionCircles&&(de=t.featureIndex),l.verticalTextFeatureIndex&&(pe=l.verticalTextFeatureIndex);const me=c.elevationFeatures?c.elevationFeatures[t.elevationFeatureIndex]:void 0,ge=r=>{r.tileID=this.retainedQueryData[c.bucketInstanceId].tileID;const o=this.transform.elevation;r.elevation=q?H:H+e.bV.getAtTileOffset(r.tileID,new e.P(r.tileAnchorX,r.tileAnchorY),o,me),r.elevation+=t.zOffset},ye=l.textBox;if(ye){ge(ye);const r=r=>{let o=e.bL.horizontal;if(c.allowVerticalPlacement&&!r&&this.prevPlacement){const e=this.prevPlacement.placedOrientations[u];e&&(this.placedOrientations[u]=e,o=e,this.markUsedOrientation(c,o,t))}return o},o=(t,r)=>{if(c.allowVerticalPlacement&&C>0&&l.verticalTextBox){for(const o of c.writingModes)if(o===e.bL.vertical?(ie=r(),re=ie):ie=t(),ie&&ie.box&&ie.box.length)break}else ie=t()};if(te){let h=te;if(this.prevPlacement&&this.prevPlacement.variableOffsets[u]){const e=this.prevPlacement.variableOffsets[u];h.indexOf(e.anchor)>0&&(h=h.filter((t=>t!==e.anchor)),h.unshift(e.anchor))}const p=(e,r,o)=>{const l=c.getSymbolInstanceTextSize(R,t,this.transform.zoom,s),u=(e.x2-e.x1)*l+2*e.padding,p=(e.y2-e.y1)*l+2*e.padding,f=t.hasIconTextFit&&!V?r:null;f&&ge(f);let m={box:[],offscreen:!1,occluded:!1};const P=k?2*h.length:h.length;for(let r=0;r<P;++r){const P=this.attemptAnchorPlacement(h[r%h.length],e,v,E,se,u,p,l,N,j,_,d,D,r>=h.length,t,s,c,o,f,R,z);if(P&&(m=P.placedGlyphBoxes,m&&m.box&&m.box.length)){Z=!0,ee=P.shift;break}}return m};o((()=>p(ye,l.iconBox,e.bL.horizontal)),(()=>{const t=l.verticalTextBox;return t&&ge(t),c.allowVerticalPlacement&&!(ie&&ie.box&&ie.box.length)&&C>0&&t?p(t,l.verticalIconBox,e.bL.vertical):{box:null,offscreen:null,occluded:null}})),ie&&(Z=ie.box,J=ie.offscreen,Q=ie.occluded);const f=r(!(!ie||!ie.box));if(!Z&&this.prevPlacement){const e=this.prevPlacement.variableOffsets[u];e&&(this.variableOffsets[u]=e,this.markUsedJustification(c,e.anchor,t,f))}}else{const h=(r,o)=>{const l=c.getSymbolInstanceTextSize(R,t,this.transform.zoom,s),h=this.collisionIndex.placeCollisionBox(c,l,r,v,E,se,new e.P(0,0),k,_,d,D.predicate);return h&&h.box&&h.box.length&&(this.markUsedOrientation(c,o,t),this.placedOrientations[u]=o),h};o((()=>h(ye,e.bL.horizontal)),(()=>{const t=l.verticalTextBox;return c.allowVerticalPlacement&&C>0&&t?(ge(t),h(t,e.bL.vertical)):{box:null,offscreen:null,occluded:null}})),r(!!(ie&&ie.box&&ie.box.length))}}if(ne=ie,Z=ne&&ne.box&&ne.box.length>0,J=ne&&ne.offscreen,Q=ne&&ne.occluded,t.useRuntimeCollisionCircles){const r=t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex,s=c.text.placedSymbolArray.get(r),l=e.bM(c.textSizeData,R,s),u=h.get("text-padding");oe=this.collisionIndex.placeCollisionCircles(c,k,s,r,c.lineVertexArray,c.glyphOffsetArray,l,d,p,f,o,j,D.predicate,t.collisionCircleDiameter*l/e.bY,u,this.retainedQueryData[c.bucketInstanceId].tileID),Z=k||oe.circles.length>0&&!oe.collisionDetected,J=J&&oe.offscreen,Q=oe.occluded}if(l.iconFeatureIndex&&(fe=l.iconFeatureIndex),l.iconBox){const r=r=>{ge(r);const o=t.hasIconTextFit&&ee?br(ee.x,ee.y,N,j,this.transform.angle):new e.P(0,0),s=c.getSymbolInstanceIconSize(z,this.transform.zoom,t.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(c,s,r,v,E,ae,o,V,_,d,D.predicate)};re&&re.box&&re.box.length&&l.verticalIconBox?(ue=r(l.verticalIconBox),Y=ue.box.length>0):(ue=r(l.iconBox),Y=ue.box.length>0),J=J&&ue.offscreen,K=ue.occluded}const xe=F||0===t.numHorizontalGlyphVertices&&0===C,ve=B||0===t.numIconVertices;if(xe||ve?ve?xe||(Y=Y&&Z):Z=Y&&Z:Y=Z=Y&&Z,Z&&ne&&ne.box&&this.collisionIndex.insertCollisionBox(ne.box,h.get("text-ignore-placement"),c.bucketInstanceId,re&&re.box&&pe?pe:de,D.ID),Y&&ue&&this.collisionIndex.insertCollisionBox(ue.box,h.get("icon-ignore-placement"),c.bucketInstanceId,fe,D.ID),oe&&(Z&&this.collisionIndex.insertCollisionCircles(oe.circles,h.get("text-ignore-placement"),c.bucketInstanceId,de,D.ID),o)){const e=c.bucketInstanceId;let t=this.collisionCircleArrays[e];void 0===t&&(t=this.collisionCircleArrays[e]=new Ti);for(let e=0;e<oe.circles.length;e+=4)t.circles.push(oe.circles[e+0]),t.circles.push(oe.circles[e+1]),t.circles.push(oe.circles[e+2]),t.circles.push(oe.collisionDetected?1:0)}const be="globe"!==c.projection.name;le=le&&(be||!Q),ce=ce&&(be||!K),this.placements[u]=new wi(Z||le,Y||ce,J||c.justReloaded),r.add(u)},de=this.retainedQueryData[c.bucketInstanceId].tileID;if("offset"===c.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(c,de),"road"===c.elevationType&&c.updateRoadElevation(de.canonical),c.updateZOffset(),c.sortFeaturesByY){const t=c.getSortedSymbolIndexes(this.transform.angle);for(let e=t.length-1;e>=0;--e){const r=t[e];ue(c.symbolInstances.get(r),r,c.collisionArrays[r])}c.hasAnyZOffset&&e.w(`${c.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(c.hasAnyZOffset){const e=c.getSortedIndexesByZOffset();for(let t=0;t<e.length;++t){const r=e[t];ue(c.symbolInstances.get(r),r,c.collisionArrays[r])}}else for(let e=t.symbolInstanceStart;e<t.symbolInstanceEnd;e++)ue(c.symbolInstances.get(e),e,c.collisionArrays[e]);if(o&&c.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[c.bucketInstanceId];e.bl(t.invProjMatrix,d),t.viewportMatrix=this.collisionIndex.getViewportMatrix()}c.justReloaded=!1}markUsedJustification(t,r,o,s){const{leftJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:c,rightJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:u,crossTileID:d}=o,p=e.c3(r),f=s===e.bL.vertical?u:"left"===p?l:"center"===p?c:"right"===p?h:-1;l>=0&&(t.text.placedSymbolArray.get(l).crossTileID=f>=0&&l!==f?0:d),c>=0&&(t.text.placedSymbolArray.get(c).crossTileID=f>=0&&c!==f?0:d),h>=0&&(t.text.placedSymbolArray.get(h).crossTileID=f>=0&&h!==f?0:d),u>=0&&(t.text.placedSymbolArray.get(u).crossTileID=f>=0&&u!==f?0:d)}markUsedOrientation(t,r,o){const s=r===e.bL.horizontal||r===e.bL.horizontalOnly?r:0,l=r===e.bL.vertical?r:0,{leftJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:h,rightJustifiedTextSymbolIndex:u,verticalPlacedTextSymbolIndex:d}=o,p=t.text.placedSymbolArray;c>=0&&(p.get(c).placedOrientation=s),h>=0&&(p.get(h).placedOrientation=s),u>=0&&(p.get(u).placedOrientation=s),d>=0&&(p.get(d).placedOrientation=l)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const t=this.prevPlacement;let r=!1;this.prevZoomAdjustment=t?t.zoomAdjustment(this.transform.zoom):0;const o=t?t.symbolFadeChange(e):1,s=t?t.opacities:{},l=t?t.variableOffsets:{},c=t?t.placedOrientations:{};for(const e in this.placements){const t=this.placements[e],l=s[e];l?(this.opacities[e]=new bi(l,o,t.text,t.icon,null,t.clipped),r=r||t.text!==l.text.placed||t.icon!==l.icon.placed):(this.opacities[e]=new bi(null,o,t.text,t.icon,t.skipFade,t.clipped),r=r||t.text||t.icon)}for(const e in s){const t=s[e];if(!this.opacities[e]){const s=new bi(t,o,!1,!1);s.isHidden()||(this.opacities[e]=s,r=r||t.text.placed||t.icon.placed)}}for(const e in l)this.variableOffsets[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.variableOffsets[e]=l[e]);for(const e in c)this.placedOrientations[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.placedOrientations[e]=c[e]);r?this.lastPlacementChangeTime=e:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=t?t.lastPlacementChangeTime:e)}updateLayerOpacities(e,t,r,o){o&&(this.lastReplacementSourceUpdateTime=o.updateTime);const s=new Set;for(const l of t){const t=l.getBucket(e);t&&l.latestFeatureIndex&&e.fqid===t.layerIds[0]&&(this.updateBucketOpacities(t,s,l,l.collisionBoxArray,r,o,l.tileID,e.scope),"offset"===t.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(t,l.tileID),"road"===t.elevationType&&t.updateRoadElevation(l.tileID.canonical),t.updateZOffset())}}updateBucketOpacities(t,r,o,s,l,c,h,u){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const d=t.layers[0].layout,p=t.layers[0].paint,f=!!t.layers[0].dynamicFilter(),m=new bi(null,0,!1,!1,!0),_=d.get("text-allow-overlap"),v=d.get("icon-allow-overlap"),E=d.get("text-variable-anchor"),P="map"===d.get("text-rotation-alignment"),C="map"===d.get("text-pitch-alignment"),R=p.get("symbol-z-offset"),z="sea"===d.get("symbol-elevation-reference"),D=!R.isConstant(),O=new bi(null,0,_&&(v||!t.hasIconData()||d.get("icon-optional")),v&&(_||!t.hasTextData()||d.get("text-optional")),!0);!t.collisionArrays&&s&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(s);const F=(e,t,r)=>{for(let o=0;o<t/4;o++)e.opacityVertexArray.emplaceBack(r)};let B=0;c&&t.updateReplacement(h,c);for(let s=0;s<t.symbolInstances.length;s++){const d=t.symbolInstances.get(s),{numHorizontalGlyphVertices:p,numVerticalGlyphVertices:_,crossTileID:v,numIconVertices:k,tileAnchorX:V,tileAnchorY:N}=d;let U=null;const j=this.retainedQueryData[t.bucketInstanceId];D&&d&&j&&(U=o.latestFeatureIndex.loadFeature({featureIndex:d.featureIndex,bucketIndex:j.bucketIndex,sourceLayerIndex:j.sourceLayerIndex,layoutVertexArrayOffset:0}));const $=R.evaluate(U,{}),q=r.has(v);let H=this.opacities[v];q?H=m:H||(H=O,this.opacities[v]=H),r.add(v);const Z=p>0||_>0,Y=k>0,J=this.placedOrientations[v],Q=J===e.bL.vertical,K=J===e.bL.horizontal||J===e.bL.horizontalOnly;!Z&&!Y||H.isHidden()||B++;let ee=!1;if((Z||Y)&&c)for(const r of t.activeReplacements){if(e.bZ(r,l,e.b_.Symbol,u))continue;if(r.min.x>V||V>r.max.x||r.min.y>N||N>r.max.y)continue;const t=e.b$(V,N,h.canonical,r.footprintTileId.canonical);if(ee=e.c0(t,r.footprint),ee)break}if(Z){const e=ee?Fr:zr(H.text);F(t.text,p,Q?Fr:e),F(t.text,_,K?Fr:e);const r=H.text.isHidden(),{leftJustifiedTextSymbolIndex:o,centerJustifiedTextSymbolIndex:s,rightJustifiedTextSymbolIndex:l,verticalPlacedTextSymbolIndex:c}=d,h=t.text.placedSymbolArray,u=r||Q?1:0;o>=0&&(h.get(o).hidden=u),s>=0&&(h.get(s).hidden=u),l>=0&&(h.get(l).hidden=u),c>=0&&(h.get(c).hidden=r||K?1:0);const f=this.variableOffsets[v];f&&this.markUsedJustification(t,f.anchor,d,J);const m=this.placedOrientations[v];m&&(this.markUsedJustification(t,"left",d,m),this.markUsedOrientation(t,m,d))}if(Y){const e=ee?Fr:zr(H.icon),{placedIconSymbolIndex:r,verticalPlacedIconSymbolIndex:o}=d,s=t.icon.placedSymbolArray,l=H.icon.isHidden()?1:0;r>=0&&(F(t.icon,k,Q?Fr:e),s.get(r).hidden=l),o>=0&&(F(t.icon,d.numVerticalIconVertices,K?Fr:e),s.get(o).hidden=l)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const r=t.collisionArrays[s];if(r){let o=new e.P(0,0),s=!0;if(r.textBox||r.verticalTextBox){if(E){const e=this.variableOffsets[v];e?(o=vr(e.anchor,e.width,e.height,e.textOffset,e.textScale),P&&o._rotate(C?this.transform.angle:-this.transform.angle)):s=!1}f&&(s=!H.clipped),r.textBox&&wr(t.textCollisionBox.collisionVertexArray,H.text.placed,!s||Q,$,z,o.x,o.y),r.verticalTextBox&&wr(t.textCollisionBox.collisionVertexArray,H.text.placed,!s||K,$,z,o.x,o.y)}const l=s&&Boolean(!K&&r.verticalIconBox);r.iconBox&&wr(t.iconCollisionBox.collisionVertexArray,H.icon.placed,l,$,z,d.hasIconTextFit?o.x:0,d.hasIconTextFit?o.y:0),r.verticalIconBox&&wr(t.iconCollisionBox.collisionVertexArray,H.icon.placed,!l,$,z,d.hasIconTextFit?o.x:0,d.hasIconTextFit?o.y:0)}}}if(t.fullyClipped=0===B,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=e.invProjMatrix,t.placementViewportMatrix=e.viewportMatrix,t.collisionCircleArray=e.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(e){return 0===this.fadeDuration?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,t){const r=this.zoomAtLastRecencyCheck===t?1-this.zoomAdjustment(t):1;return this.zoomAtLastRecencyCheck=t,this.commitTime+this.fadeDuration*r>e}isStale(){return this.stale}setStale(){this.stale=!0}}function wr(e,t,r,o,s,l,c){e.emplaceBack(t?1:0,r?1:0,l||0,c||0,o,s?1:0),e.emplaceBack(t?1:0,r?1:0,l||0,c||0,o,s?1:0),e.emplaceBack(t?1:0,r?1:0,l||0,c||0,o,s?1:0),e.emplaceBack(t?1:0,r?1:0,l||0,c||0,o,s?1:0)}const Tr=Math.pow(2,25),Sr=Math.pow(2,24),Ir=Math.pow(2,17),Er=Math.pow(2,16),Ar=Math.pow(2,9),Mr=Math.pow(2,8),Pr=Math.pow(2,1);function zr(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,r=Math.floor(127*e.opacity);return r*Tr+t*Sr+r*Ir+t*Er+r*Ar+t*Mr+r*Pr+t}const Fr=0;class Ni{constructor(e){this._sortAcrossTiles="viewport-y"!==e.layout.get("symbol-z-order")&&void 0!==e.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(e,t,r,o,s,l){const c=this._bucketParts;for(;this._currentTileIndex<e.length;)if(t.getBucketParts(c,o,e[this._currentTileIndex],this._sortAcrossTiles,l),this._currentTileIndex++,s())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,c.sort(((e,t)=>e.sortKey-t.sortKey)));this._currentPartIndex<c.length;){const e=c[this._currentPartIndex];if(t.placeLayerBucketPart(e,this._seenCrossTileIDs,r,0===e.symbolInstanceStart,l),this._currentPartIndex++,s())return!0}return!1}}class Ui{startNewPlacement(e,t,r,o,s,l,c,h){return this.placement=new Ri(e,o,s,l,c,h),this._currentPlacementIndex=t.length-1,this._forceFullPlacement=!1,this._showCollisionBoxes=r,this._fadeDuration=o,this._done=!1,this._inProgressLayer=null,this}requestFullPlacement(){this._forceFullPlacement=!0}isFullPlacementRequested(){return this._forceFullPlacement}setStale(){this.placement&&(this.placement.stale=!0)}isStale(){return!!this.placement&&this.placement.stale}isDone(){return this._done}continuePlacement(t,r,o,s,l){const c=e.o.now(),h=()=>{const t=e.o.now()-c;return!this.isFullPlacementRequested()&&0!==this._fadeDuration&&t>2};for(;this._currentPlacementIndex>=0;){const c=r[t[this._currentPlacementIndex]],u=this.placement.collisionIndex.transform.zoom;if("symbol"===c.type&&"none"!==c.visibility&&(!c.minzoom||c.minzoom<=u)&&(!c.maxzoom||c.maxzoom>u)){const t=c,r=t.layout.get("symbol-z-elevate"),u=void 0!==t.layout.get("symbol-sort-key").constantOr(1),d=t.layout.get("symbol-z-order"),p="viewport-y"===d||"auto"===d&&!("viewport-y"!==d&&u),f=t.layout.get("text-allow-overlap")||t.layout.get("icon-allow-overlap")||t.layout.get("text-ignore-placement")||t.layout.get("icon-ignore-placement"),m=p&&f,_=this._inProgressLayer=this._inProgressLayer||new Ni(t),v=e.B(c.source,c.scope);if(_.continuePlacement(r||m?s[v]:o[v],this.placement,this._showCollisionBoxes,c,h,l))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._forceFullPlacement=!1,this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const Br=512/e.al/2;class Vi{constructor(t,r,o){this.tileID=t,this.bucketInstanceId=o,this.index=new e.c4(r.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const s=t.canonical.x*e.al,l=t.canonical.y*e.al;for(let e=0;e<r.length;e++){const{key:t,crossTileID:o,tileAnchorX:c,tileAnchorY:h}=r.get(e),u=Math.floor((s+c)*Br),d=Math.floor((l+h)*Br);this.index.add(u,d),this.keys.push(t),this.crossTileIDs.push(o)}this.index.finish()}findMatches(t,r,o){const s=this.tileID.canonical.z<r.canonical.z?1:Math.pow(2,this.tileID.canonical.z-r.canonical.z),l=Br/Math.pow(2,r.canonical.z-this.tileID.canonical.z),c=r.canonical.x*e.al,h=r.canonical.y*e.al;for(let e=0;e<t.length;e++){const r=t.get(e);if(r.crossTileID)continue;const{key:u,tileAnchorX:d,tileAnchorY:p}=r,f=Math.floor((c+d)*l),m=Math.floor((h+p)*l),_=this.index.range(f-s,m-s,f+s,m+s).sort(((e,t)=>e-t));for(const e of _){const t=this.crossTileIDs[e];if(this.keys[e]===u&&!o.has(t)){o.add(t),r.crossTileID=t;break}}}}}class Gi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Hi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const t=Math.round((e-this.lng)/360);if(0!==t)for(const e in this.indexes){const r=this.indexes[e],o={};for(const e in r){const s=r[e];s.tileID=s.tileID.unwrapTo(s.tileID.wrap+t),o[s.tileID.key]=s}this.indexes[e]=o}this.lng=e}addBucket(e,t,r){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===t.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let e=0;e<t.symbolInstances.length;e++)t.symbolInstances.get(e).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]=new Set);const o=this.usedCrossTileIDs[e.overscaledZ];for(const r in this.indexes){const s=this.indexes[r];if(Number(r)>e.overscaledZ)for(const r in s){const l=s[r];l.tileID.isChildOf(e)&&l.findMatches(t.symbolInstances,e,o)}else{const l=s[e.scaledTo(Number(r)).key];l&&l.findMatches(t.symbolInstances,e,o)}}for(let e=0;e<t.symbolInstances.length;e++){const s=t.symbolInstances.get(e);s.crossTileID||(s.crossTileID=r.generate(),o.add(s.crossTileID))}return void 0===this.indexes[e.overscaledZ]&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Vi(e,t.symbolInstances,t.bucketInstanceId),!0}removeBucketCrossTileIDs(e,t){for(const r of t.crossTileIDs)this.usedCrossTileIDs[e].delete(r)}removeStaleBuckets(e){let t=!1;for(const r in this.indexes){const o=this.indexes[r];for(const s in o)e[o[s].bucketInstanceId]||(this.removeBucketCrossTileIDs(r,o[s]),delete o[s],t=!0)}return t}}class qi{constructor(){this.layerIndexes={},this.crossTileIDs=new Gi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,t,r,o){let s=this.layerIndexes[e.fqid];void 0===s&&(s=this.layerIndexes[e.fqid]=new Hi);let l=!1;const c={};"globe"!==o.name&&s.handleWrapJump(r);for(const r of t){const t=r.getBucket(e);t&&e.fqid===t.layerIds[0]&&(t.bucketInstanceId||(t.bucketInstanceId=++this.maxBucketInstanceId),s.addBucket(r.tileID,t,this.crossTileIDs)&&(l=!0),c[t.bucketInstanceId]=!0)}return s.removeStaleBuckets(c)&&(l=!0),l}pruneUnusedLayers(e){const t={};e.forEach((e=>{t[e]=!0}));for(const e in this.layerIndexes)t[e]||delete this.layerIndexes[e]}}const kr=771;class Wi{constructor(e,t,r,o){this.blendFunction=e,this.blendColor=t.toNonPremultipliedRenderColor(null),this.mask=r,this.blendEquation=o}}Wi.Replace=[1,0,1,0],Wi.disabled=new Wi(Wi.Replace,e.ao.transparent,[!1,!1,!1,!1]),Wi.unblended=new Wi(Wi.Replace,e.ao.transparent,[!0,!0,!0,!0]),Wi.alphaBlended=new Wi([1,kr,1,kr],e.ao.transparent,[!0,!0,!0,!0]),Wi.alphaBlendedNonPremultiplied=new Wi([770,kr,770,kr],e.ao.transparent,[!0,!0,!0,!0]),Wi.multiply=new Wi([774,0,774,0],e.ao.transparent,[!0,!0,!0,!0]),Wi.additive=new Wi([1,1,1,1],e.ao.transparent,[!0,!0,!0,!0]);class $i{constructor(e,t,r){this.func=e,this.mask=t,this.range=r}}$i.ReadOnly=!1,$i.ReadWrite=!0,$i.disabled=new $i(519,$i.ReadOnly,[0,1]);const Vr=7680;class Yi{constructor(e,t,r,o,s,l){this.test=e,this.ref=t,this.mask=r,this.fail=o,this.depthFail=s,this.pass=l}}Yi.disabled=new Yi({func:519,mask:0},0,0,Vr,Vr,Vr);const Nr=1029,Ur=2305;class Qi{constructor(e,t,r){this.enable=e,this.mode=t,this.frontFace=r}}function jr(t,r){const o=e.ca(t,3);e.cc(t,r),e.cg(t,3,o)}function Gr(t,r){const o=e.c7([]);return e.c8(o,o,-r),e.c9(o,o,-t),o}function Xr(t,r){const o=[t[0],t[1],0],s=[r[0],r[1],0];if(e.ag(o)>=1e-15){const t=e.aw([],o);e.c5(s,t,e.bJ(s,t)),r[0]=s[0],r[1]=s[1]}const l=e.bI([],r,t);if(e.c6(l)<1e-15)return null;const c=Math.atan2(-l[1],l[0]);return Gr(Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2]),c)}Qi.disabled=new Qi(!1,Nr,Ur),Qi.backCCW=new Qi(!0,Nr,Ur),Qi.backCW=new Qi(!0,Nr,2304),Qi.frontCW=new Qi(!0,1028,2304),Qi.frontCCW=new Qi(!0,1028,Ur);class oo{constructor(e,t){this.position=e,this.orientation=t}get position(){return this._position}set position(t){if(t){const r=t instanceof e.ae?t:new e.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(r.x=e.bT(r.x,0,1)),this._position=r}else this._position=null}lookAtPoint(t,r,o){if(this.orientation=null,!this.position)return;const s=this.position,l=o||(this._elevation?this._elevation.getAtPointOrZero(e.ae.fromLngLat(t)):0),c=e.ae.fromLngLat(t,l),h=[c.x-s.x,c.y-s.y,c.z-s.z];r||(r=[0,0,1]),r[2]=Math.abs(r[2]),this.orientation=Xr(h,r)}setPitchBearing(t,r){this.orientation=Gr(e.an(t),e.an(-r))}}class so{constructor(t,r){this._transform=e.bA([]),this.orientation=r,this.position=t}get mercatorPosition(){const t=this.position;return new e.ae(t[0],t[1],t[2])}get position(){const t=e.ca(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var r;t&&e.cg(this._transform,3,[(r=t)[0],r[1],r[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||e.c7([]),t&&jr(this._transform,this._orientation)}getPitchBearing(){const e=this.forward(),t=this.right();return{bearing:Math.atan2(-t[1],t[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])}}setPitchBearing(e,t){this._orientation=Gr(e,t),jr(this._transform,this._orientation)}forward(){const t=e.ca(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=e.ca(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=e.ca(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,r){const o=new Float64Array(16);return e.bl(o,this.getWorldToCamera(t,r)),o}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,r,o){const s=this.position;e.c5(s,s,-t);const l=new Float64Array(16);return e.bq(l,[o,o,o]),e.br(l,l,s),l[10]*=r,l}getWorldToCamera(t,r){const o=new Float64Array(16),s=new Float64Array(4),l=this.position;return e.cb(s,this._orientation),e.c5(l,l,-t),e.cc(o,s),e.br(o,o,l),o[1]*=-1,o[5]*=-1,o[9]*=-1,o[13]*=-1,o[8]*=r,o[9]*=r,o[10]*=r,o[11]*=r,o}getCameraToClipPerspective(t,r,o,s){const l=new Float64Array(16);return e.cd(l,t,r,o,s),l}getCameraToClipOrthographic(t,r,o,s,l,c){const h=new Float64Array(16);return e.ce(h,t,r,o,s,l,c),h}getDistanceToElevation(t,r=!1){const o=0===t?0:e.cf(t,r?e.a$(this.position[1]):this.position[1]),s=this.forward();return(o-this.position[2])/s[2]}clone(){return new so([...this.position],[...this.orientation])}}const Qr=(e,t)=>({u_matrix:e,u_ground_shadow_factor:t});class no{constructor(e=0,t=0,r=0,o=0){if(isNaN(e)||e<0||isNaN(t)||t<0||isNaN(r)||r<0||isNaN(o)||o<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=t,this.left=r,this.right=o}interpolate(t,r,o){return null!=r.top&&null!=t.top&&(this.top=e.ak(t.top,r.top,o)),null!=r.bottom&&null!=t.bottom&&(this.bottom=e.ak(t.bottom,r.bottom,o)),null!=r.left&&null!=t.left&&(this.left=e.ak(t.left,r.left,o)),null!=r.right&&null!=t.right&&(this.right=e.ak(t.right,r.right,o)),this}getCenter(t,r){const o=e.aA((this.left+t-this.right)/2,0,t),s=e.aA((this.top+r-this.bottom)/2,0,r);return new e.P(o,s)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new no(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const en=15;class lo{constructor(t,r,o,s,l,c,h){this.tileSize=512,this._renderWorldCopies=void 0===l||l,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=o??0,this._maxPitch=s??60,this.setProjection(c),this.setMaxBounds(h),this.width=0,this.height=0,this._center=new e.aT(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new no,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new so,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const e=new lo(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,e.tileSize=this.tileSize,e.mercatorFromTransition=this.mercatorFromTransition,e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._seaLevelZoom=this._seaLevelZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e.frustumCorners=this.frustumCorners,e._allowWorldUnderZoom=this._allowWorldUnderZoom,e}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<en}get elevation(){return this._elevation}set elevation(e){this._elevation!==e&&(this._elevation=e,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(e,t=!1){const r=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||r)&&this._updateCameraOnTerrain(),(e||r)&&this._constrainCamera(t),this._calcMatrices()}getProjection(){return e.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const r=this.projection?this.getProjection():void 0;this.projection=e.cm(this.projectionOptions);const o=this.getProjection(),s=!e.by(r,o);return s&&this._calcMatrices(),this.mercatorFromTransition=!1,s}setOrthographicProjectionAtLowPitch(e){return this._orthographicProjectionAtLowPitch!==e&&(this._orthographicProjectionAtLowPitch=e,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=e.cm({name:"mercator"});const r=t!==this.projection.name;return r&&this._calcMatrices(),r}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(e){void 0===e?e=!0:null===e&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get cameraWorldSize(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return e.cf(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new e.P(this.width,this.height)}get bearing(){return e.bT(this.rotation,-180,180)}set bearing(e){this.rotation=e}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const r=-t*Math.PI/180;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=e.cn(),e.co(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=e.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=e.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const e=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/e)}get averageElevation(){return this._averageElevation}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(e){const t=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==t&&(this._unmodified=!1,this._setZoom(t),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(e){this._tileCoverLift!==e&&(this._tileCoverLift=e)}_updateCameraOnTerrain(){const e=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,t=this.elevation&&e===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||e===Number.NEGATIVE_INFINITY&&(!t||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const r=this._elevation;t||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&r.exaggeration()&&this._centerAltitudeValidForExaggeration!==r.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*r.exaggeration(),this._centerAltitudeValidForExaggeration=r.exaggeration()):(this._centerAltitude=e||0,this._centerAltitudeValidForExaggeration=r.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(void 0===this._centerAltitudeValidForExaggeration)return;const e=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(e)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,r=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],o=this.horizonLineFromTop();let s=0,l=0;for(let c=0;c<r.length;c++){const h=new e.P(r[c][0]*this.width,o+r[c][1]*(this.height-o)),u=t.pointCoordinate(h);if(!u)continue;const d=1/Math.hypot(u[0]-this._camera.position[0],u[1]-this._camera.position[1]);s+=u[3]*d,l+=d}return 0===l?NaN:s/l}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const e=this._seaLevelZoom,t=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),r=this.pixelsPerMeter/this.worldSize*t,o=this._mercatorZfromZoom(e),s=this._mercatorZfromZoom(this._maxZoom),l=Math.max(o-r,s);this._setZoom(this._zoomFromMercatorZ(l))}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}equals(e){const t=this.elevation,r=e.elevation,o=null!=t!=(null!=r)||t&&r&&t.exaggeration()!==r.exaggeration();return this.width===e.width&&this.height===e.height&&this.center.lng===e.center.lng&&this.center.lat===e.center.lat&&this.zoom===e.zoom&&this.bearing===e.bearing&&this.pitch===e.pitch&&this.fov===e.fov&&this.projection.name===e.projection.name&&this._edgeInsets.equals(e.padding)&&!o}computeZoomRelativeTo(t){const r=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let o;o=t.z<this._camera.position[2]?[r.x,r.y,r.z]:[t.x,t.y,t.z];const s=e.ag(e.av([],this._camera.position,o));return e.aA(this._zoomFromMercatorZ(s),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height)return;if(!t.position&&!t.orientation)return;this._updateCameraState();let r=!1;if(t.orientation&&!e.cp(t.orientation,this._camera.orientation)&&(r=this._setCameraOrientation(t.orientation)),t.position){const o=[t.position.x,t.position.y,t.position.z];e.cq(o,this._camera.position)||(this._setCameraPosition(o),r=!0)}r&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,r=new oo;return r.position=new e.ae(t[0],t[1],t[2]),r.orientation=this._camera.orientation,r._elevation=this.elevation,r._renderWorldCopies=this.renderWorldCopies,r}_setCameraOrientation(t){if(!e.cr(t))return!1;e.cs(t,t);const r=e.ct([],[0,0,-1],t),o=e.ct([],[0,-1,0],t);if(o[2]<0)return!1;const s=Xr(r,o);return!!s&&(this._camera.orientation=s,!0)}_setCameraPosition(t){const r=this.zoomScale(this.minZoom)*this.tileSize,o=this.zoomScale(this.maxZoom)*this.tileSize,s=this.cameraToCenterDistance;t[2]=e.aA(t[2],s/o,s/r),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,t,r){this._unmodified=!1,this._edgeInsets.interpolate(e,t,r),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const t=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,t)}getVisibleUnwrappedCoordinates(t){const r=[new e.cu(0,t)];if(this.renderWorldCopies){const o=this.pointCoordinate(new e.P(0,0)),s=this.pointCoordinate(new e.P(this.width,0)),l=this.pointCoordinate(new e.P(this.width,this.height)),c=this.pointCoordinate(new e.P(0,this.height)),h=Math.floor(Math.min(o.x,s.x,l.x,c.x)),u=Math.floor(Math.max(o.x,s.x,l.x,c.x)),d=1;for(let o=h-d;o<=u+d;o++)0!==o&&r.push(new e.cu(o,t))}return r}isLODDisabled(e){return(!e||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,r,o,s){let l=[];const c=null!=o,h=!c;if(h&&this.zoom<r)return l;if(c&&0===o[0]&&0===o[1])return l;const u=new Set,d=(t,r,o,s,c)=>{const h=e.cY(r,t,o,s,c);u.has(h)||(l.push(new e.aQ(t,r,o,s,c)),u.add(h))};for(let e=0;e<t.length;e++){const l=t[e];if(h&&l.canonical.z!==r)continue;if(c&&void 0!==s&&s>l.canonical.z)continue;const u=l.canonical,p=l.overscaledZ,f=l.wrap,m=1<<u.z,_=u.x+1<m,v=u.x>0,E=u.y+1<m,P=u.y>0,C=l.wrap-(v?0:1),R=l.wrap+(_?0:1),z=v?u.x-1:m-1,D=_?u.x+1:0;if(c)o[0]<0?(d(p,R,u.z,D,u.y),o[1]<0&&E&&(d(p,f,u.z,u.x,u.y+1),d(p,R,u.z,D,u.y+1)),o[1]>0&&P&&(d(p,f,u.z,u.x,u.y-1),d(p,R,u.z,D,u.y-1))):o[0]>0?(d(p,C,u.z,z,u.y),o[1]<0&&E&&(d(p,f,u.z,u.x,u.y+1),d(p,C,u.z,z,u.y+1)),o[1]>0&&P&&(d(p,f,u.z,u.x,u.y-1),d(p,C,u.z,z,u.y-1))):o[1]<0&&E?d(p,f,u.z,u.x,u.y+1):P&&d(p,f,u.z,u.x,u.y-1);else{const e=l.visibleQuadrants;1&e&&(d(p,C,u.z,z,u.y),P&&(d(p,f,u.z,u.x,u.y-1),d(p,C,u.z,z,u.y-1))),2&e&&(d(p,R,u.z,D,u.y),P&&(d(p,f,u.z,u.x,u.y-1),d(p,R,u.z,D,u.y-1))),4&e&&(d(p,C,u.z,z,u.y),E&&(d(p,f,u.z,u.x,u.y+1),d(p,C,u.z,z,u.y+1))),8&e&&(d(p,R,u.z,D,u.y),E&&(d(p,f,u.z,u.x,u.y+1),d(p,R,u.z,D,u.y+1)))}}const p=[];for(const e of l)l.some((t=>e.isChildOf(t)))||p.push(e);if(l=p.filter((e=>!t.some((t=>!!(e.overscaledZ<r&&t.isChildOf(e))||e.equals(t)||e.isChildOf(t))))),h){const e=1<<r,t="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),o=[e*t.x,e*t.y],s=4,c=s*s;l=l.filter((e=>{const t=e.canonical.x+.5-o[0],r=e.canonical.y+.5-o[1];return t*t+r*r<c}))}return l}extendTileCoverToNearPlane(t,r,o){const s=[],l=new Set;for(const e of t)l.add(e.key);const c=(t,r,o,c,h)=>{const u=e.cY(r,t,o,c,h);l.has(u)||(s.push(new e.aQ(t,r,o,c,h)),l.add(u))},h=t.reduce(((e,t)=>Math.max(e,t.overscaledZ)),o),u=1<<o,d=[new e.P(0,0),new e.P(e.al,0),new e.P(e.al,e.al),new e.P(0,e.al)],p=new e.P(0,0),f=new e.P(0,0),m=(t,r)=>{const s=Math.floor(t[0]),l=Math.floor(t[1]),m=(t[0]-s)*e.al,_=(t[1]-l)*e.al,v=Math.floor(r[0]),E=Math.floor(r[1]),P=(r[0]-v)*e.al,C=(r[1]-E)*e.al;for(let t=-1;t<=1;t++){const r=s+t;if(!(r<0||r>=u)){p.x=m-t*e.al,f.x=P-(r-v)*e.al;for(let t=-1;t<=1;t++){const s=l+t;p.y=_-t*e.al,f.y=C-(s-E)*e.al,e.cZ(p,f,d)&&c(h,0,o,r,s)}}}},_=r.points,v=_[e.cv],E=_[e.cw],P=this._projectToGround(v,_[e.cx]),C=this._projectToGround(E,_[e.cy]);return m(v,P),m(E,C),s}_projectToGround(t,r){return e.cz(e.cA(),t,r,t[2]/(t[2]-r[2]))}coveringTiles(t){let r=this.coveringZoomLevel(t);const o=r,s=this.elevation&&this.elevation.exaggeration(),l=s&&!t.isTerrainDEM,c="mercator"===this.projection.name;if(void 0!==t.minzoom&&r<t.minzoom)return[];void 0!==t.maxzoom&&r>t.maxzoom&&(r=t.maxzoom);const h=this.locationCoordinate(this.center),u=this.center.lat,d=1<<r,p=[d*h.x,d*h.y,0],f="globe"===this.projection.name,m=!f,_=e.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,m),v=f?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),E=d*e.cf(1,this.center.lat),P=this._camera.position[2]/e.cf(1,this.center.lat),C=[d*v.x,d*v.y,P*(m?1:E)],R=f||s,z=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),D=this.isLODDisabled(!0)?r:0;let O;if(this._elevation&&t.isTerrainDEM)O=1e4*this._elevation.exaggeration();else if(this._elevation){const e=this._elevation.getMinMaxForVisibleTiles();O=e?e.max:this._centerAltitude}else O=this._centerAltitude;const F=t.isTerrainDEM?-O:this._elevation?this._elevation.getMinElevationBelowMSL():0,B=this.projection.isReprojectedInTileSpace?e.cC(this):1,k=t=>{const r=1/4e4,o=new e.ae(t.x+r,t.y,t.z),s=new e.ae(t.x,t.y+r,t.z),l=t.toLngLat(),c=o.toLngLat(),h=s.toLngLat(),u=this.locationCoordinate(l),d=this.locationCoordinate(c),p=this.locationCoordinate(h),f=Math.hypot(d.x-u.x,d.y-u.y),m=Math.hypot(p.x-u.x,p.y-u.y);return Math.sqrt(f*m)*B/r},V=t=>{const r=O,o=F;return{aabb:e.cF(this,d,0,0,0,t,o,r,this.projection),zoom:0,x:0,y:0,minZ:o,maxZ:r,wrap:t,fullyVisible:!1}},N=[];let U=[];const j=r,$=t.reparseOverscaled?o:r,q=(P-this._centerAltitude)*E,H=e=>{if(!this._elevation||!e.tileID||!c)return;const t=this._elevation.getMinMaxForTile(e.tileID),r=e.aabb;t?(r.min[2]=t.min,r.max[2]=t.max,r.center[2]=(r.min[2]+r.max[2])/2):(e.shouldSplit=Y(e),e.shouldSplit||(r.min[2]=r.max[2]=r.center[2]=this._centerAltitude))},Z=(e,t)=>{if(.707*t<e)return 1;const r=t/e;return r/(1.4144271570014144+(Math.pow(1.1,r-1.4144271570014144+1)-1)/(1.1-1)-1)},Y=t=>{if(t.zoom<D)return!0;if(t.zoom===j)return!1;if(null!=t.shouldSplit)return t.shouldSplit;const r=t.aabb.distanceX(C),s=t.aabb.distanceY(C);let h=q,d=1;if(f){h=t.aabb.distanceZ(C);const r=Math.pow(2,t.zoom),o=e.a$((t.y+1)/r),s=e.a$(t.y/r),l=Math.min(Math.max(u,o),s),c=e.d1(l)/e.d1(u);if(d=l===u?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,c/this._mercatorScaleRatio),this.zoom<=e.c_&&t.zoom===j-1&&c>=.9)return!0}else if(l&&(h=t.aabb.distanceZ(C)*E),this.projection.isReprojectedInTileSpace&&o<=5){const r=Math.pow(2,t.zoom),o=k(new e.ae((t.x+.5)/r,(t.y+.5)/r));d=o>.85?1:o}if(!c&&!f){const e=Math.sqrt(r*r+s*s+h*h);let o=(1<<j-t.zoom)*z*d;return o*=Z(Math.max(h,q),e),e<o}let m=Number.MAX_VALUE,_=0;const v=t.aabb.getCorners(),P=[];for(const t of v){e.av(P,t,C),f||(l?P[2]*=E:P[2]=q);const r=e.bJ(P,this._camera.forward());r<m&&(m=r,_=Math.abs(P[2]))}let R=(1<<j-t.zoom)*z*d;if(R*=Z(Math.max(_,q),m),m<R)return!0;const O=t.aabb.closestPoint(p);return O[0]===p[0]&&O[1]===p[1]};if(this.renderWorldCopies)for(let e=1;e<=3;e++)N.push(V(-e)),N.push(V(e));for(N.push(V(0));N.length>0;){const o=N.pop(),s=o.x,h=o.y;let u=o.fullyVisible;const m=()=>"globe"===this.projection.name&&(0===o.y||o.y===(1<<o.zoom)-1);if(!u){let t=R?o.aabb.intersects(_):o.aabb.intersectsFlat(_);if(0===t&&m()){const r=new e.cD(o.zoom,s,h);t=e.cE(this,d,r,!0).intersects(_)}if(0===t)continue;u=2===t}if(o.zoom!==j&&Y(o))for(let t=0;t<4;t++){const r=(s<<1)+t%2,p=(h<<1)+(t>>1),m={aabb:c?o.aabb.quadrant(t):e.cF(this,d,o.zoom+1,r,p,o.wrap,o.minZ,o.maxZ,this.projection),zoom:o.zoom+1,x:r,y:p,wrap:o.wrap,fullyVisible:u,tileID:void 0,shouldSplit:void 0,minZ:o.minZ,maxZ:o.maxZ};l&&!f&&(m.tileID=new e.aQ(o.zoom+1===j?$:o.zoom+1,o.wrap,o.zoom+1,r,p),H(m)),N.push(m)}else{const l=o.zoom===j?$:o.zoom;if(t.minzoom&&t.minzoom>l)continue;let c=0;if(!u){let r=R?o.aabb.intersectsPrecise(_):o.aabb.intersectsPreciseFlat(_);if(0===r&&m()){const t=new e.cD(o.zoom,s,h);r=e.cE(this,d,t,!0).intersectsPrecise(_)}if(0===r)continue;if(t.calculateQuadrantVisibility)if(_.containsPoint(o.aabb.center))c=15;else for(let e=0;e<4;e++)0!==o.aabb.quadrant(e).intersects(_)&&(c|=1<<e)}const f=p[0]-(.5+s+(o.wrap<<o.zoom))*(1<<r-o.zoom),v=p[1]-.5-h,E=o.tileID?o.tileID:new e.aQ(l,o.wrap,o.zoom,s,h);t.calculateQuadrantVisibility&&(E.visibleQuadrants=c),U.push({tileID:E,distanceSq:f*f+v*v})}}if(this.fogCullDistSq){const r=this.fogCullDistSq,o=this.horizonLineFromTop();U=U.filter((s=>{const l=[0,0,0,1],c=[e.al,e.al,0,1],h=this.calculateFogTileMatrix(s.tileID.toUnwrapped());e.aC(l,l,h),e.aC(c,c,h);const u=e.cG([],l,c),d=e.cH([],l,c),p=e.c$(u,d);if(0===p)return!0;let f=!1;const m=this._elevation;if(m&&p>r&&0!==o){const r=this.calculateProjMatrix(s.tileID.toUnwrapped());let l;t.isTerrainDEM||(l=m.getMinMaxForTile(s.tileID)),l||(l={min:F,max:O});const c=e.cI(this.rotation),h=[c[0]*e.al,c[1]*e.al,l.max];e.af(h,h,r),f=(1-h[1])*this.height*.5<o}return p<r||f}))}return U.sort(((e,t)=>e.distanceSq-t.distanceSq)).map((e=>e.tileID))}resize(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log2(e)}project(t){const r=e.aA(t.lat,-e.cJ,e.cJ),o=this.projection.project(t.lng,r);return new e.P(o.x*this.worldSize,o.y*this.worldSize)}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/e.cf(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,r){let o,s;const l=this.centerPoint;if("globe"===this.projection.name){const e=this.worldSize;o=(r.x-l.x)/e,s=(r.y-l.y)/e}else{const e=this.pointCoordinate(r),t=this.pointCoordinate(l);o=e.x-t.x,s=e.y-t.y}const c=this.locationCoordinate(t);this.setLocation(new e.ae(c.x-o,c.y-s))}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(e,t){return this.projection.locationPoint(this,e,t)}locationPoint3D(e,t){return this.projection.locationPoint(this,e,t,!0)}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e))}pointLocation3D(e,t){return this.coordinateLocation(this.pointCoordinate3D(e,t))}locationCoordinate(t,r){const o=r?e.cf(r,t.lat):void 0,s=this.projection.project(t.lng,t.lat);return new e.ae(s.x,s.y,o)}coordinateLocation(e){return this.projection.unproject(e.x,e.y)}pointRayIntersection(t,r){const o=null!=r?r:this._centerAltitude,s=[t.x,t.y,0,1],l=[t.x,t.y,1,1];e.aC(s,s,this.pixelMatrixInverse),e.aC(l,l,this.pixelMatrixInverse);const c=l[3];e.cK(s,s,1/s[3]),e.cK(l,l,1/c);const h=s[2],u=l[2];return{p0:s,p1:l,t:h===u?0:(o-h)/(u-h)}}screenPointToMercatorRay(t){const r=[t.x,t.y,0,1],o=[t.x,t.y,1,1];return e.aC(r,r,this.pixelMatrixInverse),e.aC(o,o,this.pixelMatrixInverse),e.cK(r,r,1/r[3]),e.cK(o,o,1/o[3]),r[2]=e.cf(r[2],this._center.lat)*this.worldSize,o[2]=e.cf(o[2],this._center.lat)*this.worldSize,e.cK(r,r,1/this.worldSize),e.cK(o,o,1/this.worldSize),new e.ax([r[0],r[1],r[2]],e.aw([],e.av([],o,r)))}rayIntersectionCoordinate(t){const{p0:r,p1:o,t:s}=t,l=e.cf(r[2],this._center.lat),c=e.cf(o[2],this._center.lat);return new e.ae(e.ak(r[0],o[0],s)/this.worldSize,e.ak(r[1],o[1],s)/this.worldSize,e.ak(l,c,s))}pointCoordinate(e,t=this._centerAltitude){return this.projection.pointCoordinate(this,e.x,e.y,t)}pointCoordinate3D(t,r){if(!this.elevation)return this.pointCoordinate(t,r);let o=this.projection.pointCoordinate3D(this,t.x,t.y);if(o)return new e.ae(o[0],o[1],o[2]);let s=0,l=this.horizonLineFromTop();if(t.y>l)return this.pointCoordinate(t,r);const c=.02*l,h=t.clone();for(let t=0;t<10&&l-s>c;t++){h.y=e.ak(s,l,.66);const t=this.projection.pointCoordinate3D(this,h.x,h.y);t?(l=h.y,o=t):s=h.y}return o?new e.ae(o[0],o[1],o[2]):this.pointCoordinate(t)}isPointAboveHorizon(e){return this.projection.isPointAboveHorizon(this,e)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=e.cL)return!this.isPointAboveHorizon(t);const r=this.pointCoordinate(t);return r.y>=0&&r.y<=1}_coordinatePoint(t,r){const o=r&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,s=[t.x*this.worldSize,t.y*this.worldSize,o+t.toAltitude(),1];return e.aC(s,s,this.pixelMatrix),s[3]>0?new e.P(s[0]/s[3],s[1]/s[3]):new e.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:r}=this._edgeInsets,o=this.height-this._edgeInsets.bottom,s=this.width-this._edgeInsets.right,l=this.pointLocation3D(new e.P(r,t)),c=this.pointLocation3D(new e.P(s,t)),h=this.pointLocation3D(new e.P(s,o)),u=this.pointLocation3D(new e.P(r,o));let d=Math.min(l.lng,c.lng,h.lng,u.lng),p=Math.max(l.lng,c.lng,h.lng,u.lng),f=Math.min(l.lat,c.lat,h.lat,u.lat),m=Math.max(l.lat,c.lat,h.lat,u.lat);const _=Math.pow(2,-this.zoom)/16*270,v="globe"===this.projection.name?1:4,E=(t,r,o,s,l)=>{const c=(t+o)/2,h=(r+s)/2,u=new e.P(c,h),{lng:P,lat:C}=this.pointLocation3D(u),R=Math.max(0,d-P,f-C,P-p,C-m);d=Math.min(d,P),p=Math.max(p,P),f=Math.min(f,C),m=Math.max(m,C),(l<v||R>_)&&(E(t,r,c,h,l+1),E(c,h,o,s,l+1))};if(E(r,t,s,t,1),E(s,t,s,o,1),E(s,o,r,o,1),E(r,o,r,t,1),"globe"===this.projection.name){const[t,r]=e.cM(this);t?(m=90,p=180,d=-180):r&&(f=-90,p=180,d=-180)}return new e.aI(new e.aT(d,f),new e.aT(p,m))}_getBoundsRectangular(t,r){const{top:o,left:s}=this._edgeInsets,l=this.height-this._edgeInsets.bottom,c=this.width-this._edgeInsets.right,h=new e.P(s,o),u=new e.P(c,o),d=new e.P(c,l),p=new e.P(s,l);let f=this.pointCoordinate(h,t),m=this.pointCoordinate(u,t);const _=this.pointCoordinate(d,r),v=this.pointCoordinate(p,r),E=(e,t)=>(t.y-e.y)/(t.x-e.x);return f.y>1&&m.y>=0?f=new e.ae((1-v.y)/E(v,f)+v.x,1):f.y<0&&m.y<=1&&(f=new e.ae(-v.y/E(v,f)+v.x,0)),m.y>1&&f.y>=0?m=new e.ae((1-_.y)/E(_,m)+_.x,1):m.y<0&&f.y<=1&&(m=new e.ae(-_.y/E(_,m)+_.x,0)),(new e.aI).extend(this.coordinateLocation(f)).extend(this.coordinateLocation(m)).extend(this.coordinateLocation(v)).extend(this.coordinateLocation(_))}_getBoundsRectangularTerrain(){const e=this.elevation;if(!e.visibleDemTiles.length||e.isUsingMockSource())return this._getBoundsRectangular(0,0);const t=e.visibleDemTiles.reduce(((e,t)=>{if(t.dem){const r=t.dem.tree;e.min=Math.min(e.min,r.minimums[0]),e.max=Math.max(e.max,r.maximums[0])}return e}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(t.min*e.exaggeration(),t.max*e.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(e=!0){const t=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,r=this.height/2-t*(1-this._horizonShift);return e?Math.max(0,r):r}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-e.cJ,this.maxLat=e.cJ,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=e.aF(this.minLng)*this.tileSize,this.worldMaxX=e.aF(this.maxLng)*this.tileSize,this.worldMinY=e.aJ(this.maxLat)*this.tileSize,this.worldMaxY=e.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(e,t){return this.projection.createTileMatrix(this,t,e)}calculateDistanceTileData(t){const r=t.key,o=this._distanceTileDataCache;if(o[r])return o[r];const s=t.canonical,l=1/this.height,c=this.cameraWorldSize,h=c/this.zoomScale(s.z),u=(s.x+Math.pow(2,s.z)*t.wrap)*h,d=s.y*h,p=this.point;p.x*=c/this.worldSize,p.y*=c/this.worldSize;const f=this.angle,m=Math.sin(-f),_=-Math.cos(-f);return o[r]={bearing:[m,_],center:[(p.x-u)*l,(p.y-d)*l],scale:h/e.al*l},o[r]}calculateFogTileMatrix(t){const r=t.key,o=this._fogTileMatrixCache;if(o[r])return o[r];const s=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return e.aB(s,this.worldToFogMatrix,s),o[r]=new Float32Array(s),o[r]}calculateProjMatrix(t,r=!1,o=!1){const s=t.key;let l;if(l=o?this._expandedProjMatrixCache:r?this._alignedProjMatrixCache:this._projMatrixCache,l[s])return l[s];const c=this.calculatePosMatrix(t,this.worldSize);let h;return h=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:o?this.expandedFarZProjMatrix:r?this.alignedProjMatrix:this.projMatrix,e.aB(c,h,c),l[s]=new Float32Array(c),l[s]}calculatePixelsToTileUnitsMatrix(t){const r=t.tileID.key,o=this._pixelsToTileUnitsCache;if(o[r])return o[r];const s=e.cN(t,this);return o[r]=s,o[r]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const t=1/this.worldSize,r=e.bq([],[t,t,t]);return e.aB(r,r,this.globeMatrix),r}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const t=this._elevation;this._updateCameraState();const r=e.cf(1,this._center.lat)*this.worldSize,o=this._computeCameraPosition(r),s=this._camera.forward(),l=e.cf(1,this._center.lat);o[2]/=l,s[2]/=l,e.aw(s,s);const c=t.raycast(o,s,t.exaggeration());if(c){const t=e.bH([],o,s,c),r=new e.ae(t[0],t[1],e.cf(t[2],e.a$(t[1]))),h=(r.z+e.ag([r.x-o[0],r.y-o[1],r.z-o[2]*l]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(h),this._centerAltitude=r.toAltitude(),this._center=this.coordinateLocation(r),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const r=this._elevation,o=e.cf(1,this._center.lat)*this.worldSize,s=this._computeCameraPosition(o),l=r.getAtPointOrZero(new e.ae(...s)),c=this.pixelsPerMeter/this.worldSize*l,h=this._minimumHeightOverTerrain(),u=s[2]-c;if(u<=h)if(u<0||t){const t=this.locationCoordinate(this._center,this._centerAltitude),r=[s[0],s[1],t.z-s[2]],o=e.ag(r);r[2]-=(h-u)/this._pixelsPerMercatorPixel;const l=e.ag(r);if(0===l)return;e.c5(r,r,o/l*this._pixelsPerMercatorPixel),this._camera.position=[s[0],s[1],t.z*this._pixelsPerMercatorPixel-r[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const r=this.center;return r.lat=e.aA(r.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(r.lng=e.aA(r.lng,this.minLng,this.maxLng)),this.center=r,void(this._constraining=!1)}const r=this._unmodified,{x:o,y:s}=this.point;let l=0,c=o,h=s;const u=this.width/2,d=this.height/2,p=this.worldMinY*this.scale,f=this.worldMaxY*this.scale;if(s-d<p&&(h=p+d),s+d>f&&(h=f-d),f-p<this.height&&(l=Math.max(l,this.height/(f-p)),h=(f+p)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const e=this.worldMinX*this.scale,t=this.worldMaxX*this.scale,r=this.worldSize/2-(e+t)/2;c=(o+r+this.worldSize)%this.worldSize-r,c-u<e&&(c=e+u),c+u>t&&(c=t-u),t-e<this.width&&(l=Math.max(l,this.width/(t-e)),c=(t+e)/2)}c===o&&h===s||this._allowWorldUnderZoom||(this.center=this.unproject(new e.P(c,h))),l&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(l)),this._constrainCamera(),this._unmodified=r,this._constraining=!1}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r="globe"===this.projection.name,o=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=e.cf(1,this.center.lat)/e.cf(1,e.d2));const s=e.cO(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,s),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const l="meters"===this.projection.zAxisUnit?o:1,c=this._camera.getWorldToCamera(this.worldSize,l);let h;const u=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(u[8]=2*-t.x/this.width,u[9]=2*t.y/this.height,this.isOrthographic){let r=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),o=r*this.aspect,s=-o,l=-r;o-=t.x,s-=t.x,r+=t.y,l+=t.y,h=this._camera.getCameraToClipOrthographic(s,o,l,r,this._nearZ,this._farZ),((t,r,o,s)=>{for(let l=0;l<16;l++)t[l]=e.ak(r[l],o[l],s)})(h,h,u,e.d0(this.pitch>=en?1:this.pitch/en))}else h=u;const d=e.cP([],u,c);let p=e.cP([],h,c);if(this.projection.isReprojectedInTileSpace){const t=this.locationCoordinate(this.center),r=e.bA([]);e.br(r,r,[t.x*this.worldSize,t.y*this.worldSize,0]),e.aB(r,r,e.cQ(this)),e.br(r,r,[-t.x*this.worldSize,-t.y*this.worldSize,0]),e.aB(p,p,r),e.aB(d,d,r),this.inverseAdjustmentMatrix=e.cR(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=e.cS([],p,[this.worldSize,this.worldSize,this.worldSize/l,1]),this.projMatrix=p,this.invProjMatrix=e.bl(new Float64Array(16),this.projMatrix),r){const r=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);r[8]=2*-t.x/this.width,r[9]=2*t.y/this.height,this.expandedFarZProjMatrix=e.cP([],r,c)}else this.expandedFarZProjMatrix=this.projMatrix;const f=e.bl([],h);this.frustumCorners=e.cT.fromInvProjectionMatrix(f,this.horizonLineFromTop(),this.height),this.cameraFrustum=e.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!r);const m=new Float32Array(16);e.bA(m),e.cS(m,m,[1,-1,1]),e.cU(m,m,this._pitch),e.bB(m,m,this.angle);const _=e.cd(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=e.bz(_);const v=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;_[8]=2*-t.x/this.width,_[9]=2*(t.y+v)/this.height,this.skyboxMatrix=e.aB(m,_,m);const E=this.point,P=E.x,C=E.y,R=this.width%2/2,z=this.height%2/2,D=Math.cos(this.angle),O=Math.sin(this.angle),F=P-Math.round(P)+D*R+O*z,B=C-Math.round(C)+D*z+O*R,k=new Float64Array(p);if(e.br(k,k,[F>.5?F-1:F,B>.5?B-1:B,0]),this.alignedProjMatrix=k,p=e.bC(),e.cS(p,p,[this.width/2,-this.height/2,1]),e.br(p,p,[1,-1,0]),this.labelPlaneMatrix=p,p=e.bC(),e.cS(p,p,[1,-1,1]),e.br(p,p,[-1,-1,0]),e.cS(p,p,[2/this.width,2/this.height,1]),this.glCoordMatrix=p,this.pixelMatrix=e.aB(new Float64Array(16),this.labelPlaneMatrix,d),this._calcFogMatrices(),this._distanceTileDataCache={},p=e.bl(new Float64Array(16),this.pixelMatrix),!p)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=p,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=e.cV(this);const t=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=e.af(t,t,c),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=p;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,r=this.cameraPixelsPerMeter,o=this._camera.position,s=1/this.height/this._pixelsPerMercatorPixel,l=[t,t,r];e.c5(l,l,s),e.c5(o,o,-1),e.cW(o,o,l);const c=e.bC();e.br(c,c,o),e.cS(c,c,l),this.mercatorFogMatrix=c,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,r,s)}_computeCameraPosition(e){const t=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,r=this._camera.forward(),o=this.point,s=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*t-e/this.worldSize*this._centerAltitude;return[o.x/this.worldSize-r[0]*s,o.y/this.worldSize-r[1]*s,e/this.worldSize*this._centerAltitude-r[2]*s]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const r=this._maxCameraBoundsDistance()*Math.cos(this._pitch),o=this._camera.position[2],s=t[2];let l=1;this.projection.wrap&&(this.center=this.center.wrap()),s>0&&(l=Math.min((r-o)/s,1)),this._camera.position=e.bH([],this._camera.position,t,l),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,r=this._camera.forward(),{pitch:o,bearing:s}=this._camera.getPitchBearing(),l=e.cf(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,c=this._mercatorZfromZoom(this._maxZoom)*Math.cos(e.an(this._maxPitch)),h=Math.max((t[2]-l)/Math.cos(o),c),u=this._zoomFromMercatorZ(h);e.bH(t,t,r,h),this._pitch=e.aA(o,e.an(this.minPitch),e.an(this.maxPitch)),this.angle=e.bT(s,-Math.PI,Math.PI),this._setZoom(e.aA(u,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new e.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e)}_minimumHeightOverTerrain(){const e=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(e)}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,e)*this.tileSize))}zoomFromMercatorZAdjusted(t){let r=0,o=e.cL,s=0,l=1/0;for(;o-r>1e-6&&o>r;){const e=r+.5*(o-r),c=this.tileSize*Math.pow(2,e),h=this.getCameraToCenterDistance(this.projection,e,c),u=this.scaleZoom(h/(Math.max(0,t)*this.tileSize)),d=Math.abs(e-u);d<l&&(l=d,s=e),e<u?r=e:o=e}return s}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(e.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,r){const o=Math.min(t.x,r.x),s=Math.max(t.x,r.x),l=Math.min(t.y,r.y),c=Math.max(t.y,r.y);if(l<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const h=[new e.P(o,l),new e.P(s,c),new e.P(o,c),new e.P(s,l)],u=this.renderWorldCopies?-3:0,d=this.renderWorldCopies?4:1;for(const e of h){const t=this.pointRayIntersection(e);if(t.t<0)return!0;const r=this.rayIntersectionCoordinate(t);if(r.x<u||r.y<0||r.x>d||r.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+e.cX(this.fovAboveCenter)>88||this.anyCornerOffEdge(new e.P(0,0),new e.P(this.width,this.height))}zoomDeltaToMovement(t,r){const o=e.ag(e.av([],this._camera.position,t)),s=this._zoomFromMercatorZ(o)+r;return o-this._mercatorZfromZoom(s)}getCameraPoint(){if("globe"===this.projection.name){const t=function([t,r,o],s){const l=[t,r,o,1];e.aC(l,l,s);const c=l[3]=Math.max(l[3],1e-6);return l[0]/=c,l[1]/=c,l[2]/=c,l}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new e.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new e.P(0,t))}}getCameraToCenterDistance(t,r=this.zoom,o=this.worldSize){const s=e.cO(t,r,this.width,this.height,1024),l=t.pixelSpaceConversion(this.center.lat,o,s);let c=.5/Math.tan(.5*this._fov)*this.height*l;return this.isOrthographic&&(c=e.ak(1,c,e.d0(this.pitch>=en?1:this.pitch/en))),c}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&e.aB(t,t,this.globeMatrix),t}getFrustum(t){return e.cB.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,"meters"===this.projection.zAxisUnit)}}const tn=(t,r)=>{if(r>0&&t.terrain&&e.w("Cutoff is currently disabled on terrain"),r<=0||t.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const o=t.transform,s=Math.max(Math.abs(o._zoom-(t.minCutoffZoom-1)),1),l=o.isLODDisabled(!1)?e.ah(60,45,o.pitch):e.ah(30,15,o.pitch),c=o._farZ-o._nearZ,h=r*o.height,u=((1-(d=l))*o.cameraToCenterDistance+d*(o._farZ+h))*s;var d;return{shouldRenderCutoff:l<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(u-o._nearZ)/c,(u-h-o._nearZ)/c]}}},nn=2048;class uo{constructor(e,t){this.aabb=e,this.lastCascade=t}}class _o{add(e,t){const r=this.receivers[e.key];void 0!==r?(r.aabb.min[0]=Math.min(r.aabb.min[0],t.min[0]),r.aabb.min[1]=Math.min(r.aabb.min[1],t.min[1]),r.aabb.min[2]=Math.min(r.aabb.min[2],t.min[2]),r.aabb.max[0]=Math.max(r.aabb.max[0],t.max[0]),r.aabb.max[1]=Math.max(r.aabb.max[1],t.max[1]),r.aabb.max[2]=Math.max(r.aabb.max[2],t.max[2])):this.receivers[e.key]=new uo(t,null)}clear(){this.receivers={}}get(e){return this.receivers[e.key]}computeRequiredCascades(t,r,o){const s=e.d9.fromPoints(t.points);let l=0;for(const t in this.receivers){const c=this.receivers[t];if(!c)continue;if(!s.intersectsAabb(c.aabb))continue;c.aabb.min=s.closestPoint(c.aabb.min),c.aabb.max=s.closestPoint(c.aabb.max);const h=c.aabb.getCorners();for(let t=0;t<o.length;t++){let s=!0;for(const l of h){const c=[l[0]*r,l[1]*r,l[2]];if(e.af(c,c,o[t].matrix),c[0]<-1||c[0]>1||c[1]<-1||c[1]>1){s=!1;break}}if(c.lastCascade=t,l=Math.max(l,t),s)break}}return l+1}}class po{constructor(e){this.painter=e,this._enabled=!1,this._drawShadowAfterLayer=-1,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new _o,this._depthMode=new $i(e.context.gl.LEQUAL,$i.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1}destroy(){for(const e of this._cascades)e.texture.destroy(),e.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,r){const o=this.painter;if(this._enabled=!1,this._drawShadowAfterLayer=-1,this._receivers.clear(),!r||!r.properties)return;const s=r.properties.get("shadow-intensity"),l=r.properties.get("shadow-draw-before-layer");if(!r.shadowsEnabled()||s<=0)return;let c=-1,h=0;for(const e of o.style.order){const r=o.style._mergedLayers[e];r.hasShadowPass()&&!r.isHidden(t.zoom)&&(c=h),l&&l===e&&(this._drawShadowAfterLayer=h>0?h-1:0),h+=1}if(this._enabled=c>=0,!this.enabled)return;this._drawShadowAfterLayer<0&&(this._drawShadowAfterLayer=c);const u=o.context,d=nn,p=nn;if(0===this._cascades.length||nn!==this._cascades[0].texture.size[0]){this._cascades=[];for(let t=0;t<2;++t){const t=o._shadowMapDebug,r=u.gl,s=u.createFramebuffer(d,p,t?1:0,"texture"),l=new e.T(u,{width:d,height:p,data:null},r.DEPTH_COMPONENT16);if(s.depthAttachment.set(l.texture),t){const t=new e.T(u,{width:d,height:p,data:null},r.RGBA8);s.colorAttachment0.set(t.texture)}this._cascades.push({framebuffer:s,texture:l,matrix:[],far:0,boundingSphereRadius:0,frustum:new e.cB,scale:0})}}this.shadowDirection=cn(r);let f=0;if(t.elevation){const e=t.elevation,r=[1e4,-1e4];e.visibleDemTiles.filter((e=>e.dem)).forEach((e=>{const t=e.dem.tree;r[0]=Math.min(r[0],t.minimums[0]),r[1]=Math.max(r[1],t.maximums[0])})),1e4!==r[0]&&(f=(r[1]-r[0])*e.exaggeration())}const m=1.5*t.cameraToCenterDistance,_=3*m,v=new Float64Array(16);for(let r=0;r<this._cascades.length;++r){const o=this._cascades[r];let s=t.height/50,l=1;0===r?l=m:(s=m,l=_);const[c,h]=dn(t,this.shadowDirection,s,l,nn,f);o.scale=t.scale,o.matrix=c,o.boundingSphereRadius=h,e.bl(v,o.matrix),o.frustum=e.cB.fromInvProjectionMatrix(v,1,0,!0),o.far=l}const E=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[E].far,this._cascades[E].far],this._uniformValues.u_shadow_intensity=s,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=nn,this._uniformValues.u_shadowmap_0=11,this._uniformValues.u_shadowmap_1=12,this._groundShadowTiles=o.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const P=o.transform.elevation;for(const e of this._groundShadowTiles){let t={min:0,max:0};if(P){const r=P.getMinMaxForTile(e);r&&(t=r)}this.addShadowReceiver(e.toUnwrapped(),t.min,t.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(e){this._enabled=e}drawShadowPass(t,r){if(!this.enabled)return;const o=this.painter,s=o.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(o.transform.getFrustum(0),o.transform.worldSize,this._cascades),s.viewport.set([0,0,nn,nn]);for(let l=0;l<this._numCascadesToRender;++l){o.currentShadowCascade=l,s.bindFramebuffer.set(this._cascades[l].framebuffer.framebuffer),s.clear({color:e.ao.white,depth:1});for(const e of t.order){const s=t._mergedLayers[e];if(!s.hasShadowPass()||s.isHidden(o.transform.zoom))continue;const l=t.getLayerSourceCache(s),c=l?r[l.id]:void 0;("model"===s.type||c&&c.length)&&o.renderLayer(o,l,s,c)}}o.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const e=this.painter,t=e.style,r=e.context,o=r.gl,s=t.directionalLight,l=t.ambientLight;if(!s||!l)return;const c=[],h=tn(e,e.longestCutoffRange);h.shouldRenderCutoff&&c.push("RENDER_CUTOFF"),c.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&c.push("NORMAL_OFFSET");const u=hn(t,s,l),d=new $i(o.LEQUAL,$i.ReadOnly,e.depthRangeFor3D),p=new Yi({func:o.EQUAL,mask:255},0,255,o.KEEP,o.KEEP,o.KEEP);for(const t of this._groundShadowTiles){const s=t.toUnwrapped(),l=e.isTileAffectedByFog(t),f=e.getOrCreateProgram("groundShadow",{defines:c,overrideFog:l});this.setupShadows(s,f),e.uploadCommonUniforms(r,f,s,null,h);const m=Qr(e.transform.calculateProjMatrix(s),u);f.draw(e,o.TRIANGLES,d,p,Wi.multiply,Qi.disabled,m,"ground_shadow",e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments,null,e.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Wi.unblended:Wi.disabled}getShadowPassDepthMode(){return this._depthMode}getGroundShadowLayerIndex(){return this._drawShadowAfterLayer}calculateShadowPassMatrixFromTile(t){const r=this.painter.transform,o=r.calculatePosMatrix(t,r.worldSize);return e.aB(o,this._cascades[this.painter.currentShadowCascade].matrix,o),Float32Array.from(o)}calculateShadowPassMatrixFromMatrix(t){const r=e.bz(t);return e.aB(r,this._cascades[this.painter.currentShadowCascade].matrix,t),r}setupShadows(t,r,o){if(!this.enabled)return;const s=this.painter.transform,l=this.painter.context,c=l.gl,h=this._uniformValues,u=new Float64Array(16),d=s.calculatePosMatrix(t,s.worldSize);for(let t=0;t<this._cascades.length;t++)e.aB(u,this._cascades[t].matrix,d),h[0===t?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(u),l.activeTexture.set(c.TEXTURE0+11+t),this._cascades[t].texture.bindExtraParam(c.LINEAR,c.LINEAR,c.CLAMP_TO_EDGE,c.CLAMP_TO_EDGE,c.GREATER);if(this.useNormalOffset=!!o,this.useNormalOffset){const r=e.d7(t.canonical),l=2/s.tileSize*e.al/nn,c=l*this._cascades[0].boundingSphereRadius,u=l*this._cascades[this._cascades.length-1].boundingSphereRadius,d=("vector-tile"===o?1:3)*function(t){const r=e.aA((t-22)/-22,0,1);return.125*(1-r)+4*r}(s.zoom);h.u_shadow_normal_offset=[r,c*d,u*d],h.u_shadow_bias=[1e-4,.0012,.012]}else h.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(l,h)}setupShadowsFromMatrix(t,r,o=!1){if(!this.enabled)return;const s=this.painter.context,l=s.gl,c=this._uniformValues,h=new Float64Array(16);for(let r=0;r<2;r++)e.aB(h,this._cascades[r].matrix,t),c[0===r?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(h),s.activeTexture.set(l.TEXTURE0+11+r),this._cascades[r].texture.bindExtraParam(l.LINEAR,l.LINEAR,l.CLAMP_TO_EDGE,l.CLAMP_TO_EDGE,l.GREATER);this.useNormalOffset=o,o?(c.u_shadow_normal_offset=[1,3,3],c.u_shadow_bias=[6e-5,.0012,.012]):c.u_shadow_bias=[36e-5,.0012,.012],r.setShadowUniformValues(s,c)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,r,o,s){if(s[2]>=0)return{};const l=function(t,r,o){const s=o/(1<<t.canonical.z);return new e.d9([t.canonical.x*s+t.wrap*o,t.canonical.y*s+t.wrap*o,0],[(t.canonical.x+1)*s+t.wrap*o,(t.canonical.y+1)*s+t.wrap*o,r])}(t,r,o).getCorners(),c=r/-s[2];s[0]<0?(e.d8(l[0],l[0],[s[0]*c,0,0]),e.d8(l[3],l[3],[s[0]*c,0,0])):s[0]>0&&(e.d8(l[1],l[1],[s[0]*c,0,0]),e.d8(l[2],l[2],[s[0]*c,0,0])),s[1]<0?(e.d8(l[0],l[0],[0,s[1]*c,0]),e.d8(l[1],l[1],[0,s[1]*c,0])):s[1]>0&&(e.d8(l[2],l[2],[0,s[1]*c,0]),e.d8(l[3],l[3],[0,s[1]*c,0]));const h={};return h.vertices=l,h.planes=[on(l[1],l[0],l[4]),on(l[2],l[1],l[5]),on(l[3],l[2],l[6]),on(l[0],l[3],l[7])],h}addShadowReceiver(t,r,o){this._receivers.add(t,e.d9.fromTileIdAndHeight(t,r,o))}getMaxCascadeForTile(e){const t=this._receivers.get(e);return t&&t.lastCascade?t.lastCascade:0}}function on(t,r,o){const s=e.av([],o,r),l=e.av([],t,r),c=e.bI([],s,l),h=e.ag(c);return 0===h?[0,0,1,0]:(e.c5(c,c,1/h),[c[0],c[1],c[2],-e.bJ(c,r)])}function cn(t){const r=t.properties.get("direction"),o=e.d4(r.x,r.y,r.z);o[2]=e.aA(o[2],0,75);const s=e.d6([o[0],o[1],o[2]]);return e.d5(s.x,s.y,s.z)}function hn(t,r,o){const s="none"===r.properties.get("color-use-theme"),l=r.properties.get("color"),c=r.properties.get("intensity"),h=r.properties.get("direction"),u=[h.x,h.y,h.z],d="none"===o.properties.get("color-use-theme"),p=o.properties.get("color"),f=o.properties.get("intensity"),m=Math.max(e.bJ([0,0,1],u),0),_=[0,0,0];e.c5(_,p.toPremultipliedRenderColor(d?null:t.getLut(r.scope)).toArray01Linear().slice(0,3),f);const v=[0,0,0];return e.c5(v,l.toPremultipliedRenderColor(s?null:t.getLut(o.scope)).toArray01Linear().slice(0,3),m*c),e.db([_[0]>0?_[0]/(_[0]+v[0]):0,_[1]>0?_[1]/(_[1]+v[1]):0,_[2]>0?_[2]/(_[2]+v[2]):0])}function dn(t,r,o,s,l,c){const h=t.zoom,u=t.scale,d=t.worldSize,p=1/d,f=t.aspect,m=Math.sqrt(1+f*f)*Math.tan(.5*t.fovX),_=m*m,v=s-o,E=s+o;let P,C;_>v/E?(P=s,C=s*m):(P=.5*E*(1+_),C=.5*Math.sqrt(v*v+2*(s*s+o*o)*_+E*E*_*_));const R=t.projection.pixelsPerMeter(t.center.lat,d),z=t._camera.getCameraToWorldMercator(),D=[0,0,-P*p];e.af(D,D,z);let O=C*p;const F=function(r){return r[0]/=u,r[1]/=u,r[2]=e.cf(r[2],t._center.lat),r},B=t._edgeInsets;if(!(0===B.left&&0===B.top&&0===B.right&&0===B.bottom||B.left===B.right&&B.top===B.bottom)){const r=t._camera.getWorldToCamera(t.worldSize,"meters"===t.projection.zAxisUnit?R:1),l=t._camera.getCameraToClipPerspective(t._fov,t.width/t.height,o,s);l[8]=2*-t.centerOffset.x/t.width,l[9]=2*t.centerOffset.y/t.height;const c=new Float64Array(16);e.cP(c,l,r);const u=new Float64Array(16);e.bl(u,c);const p=e.cB.fromInvProjectionMatrix(u,d,h,!0);for(const t of p.points){const r=F(t);O=Math.max(O,e.c6(e.da([],D,r)))}}O*=l/(l-1);const k=Math.acos(r[2]),V=Math.atan2(-r[0],-r[1]),N=new so;N.position=D,N.setPitchBearing(k,V);const U=N.getWorldToCamera(d,R),j=O*d,$=Math.min(t._mercatorZfromZoom(17)*d*-2,-2*j),q=N.getCameraToClipOrthographic(-j,j,-j,j,$,(j+c*R)/r[2]),H=new Float64Array(16);e.aB(H,q,U);const Z=e.d5(Math.floor(1e6*D[0])/1e6*d,Math.floor(1e6*D[1])/1e6*d,0),Y=.5*l,J=[0,0,0];e.af(J,Z,H),e.c5(J,J,Y);const Q=[Math.floor(J[0]),Math.floor(J[1]),Math.floor(J[2])],K=[0,0,0];e.av(K,J,Q),e.c5(K,K,-1/Y);const ee=new Float64Array(16);return e.bA(ee),e.br(ee,ee,K),e.aB(H,ee,H),[H,j]}class yo extends e.E{constructor(e){super(),this.requestManager=e,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,r){return e.dc(this.requestManager.transformRequest(r,e.R.Model).url).then((o=>{if(!o)return;const s=e.dd(o),l=new e.de(t,r,void 0,void 0,s);return l.computeBoundsAndApplyParent(),l})).catch((o=>{if(o&&404===o.status)return null;this.fire(new e.y(new Error(`Could not load model ${t} from ${r}: ${o.message}`)))}))}load(t,r,o={forceReload:!1}){this.models[r]||(this.models[r]={});const s=Object.keys(t),l=[],c=[];for(const e of s){const s=t[e];this.hasURLBeenRequested(s)&&!o.forceReload||(this.modelByURL[s]={modelId:e,scope:r},l.push(this.loadModel(e,s)),c.push(e)),this.models[r][e]||(this.models[r][e]={model:null,numReferences:1})}this.numModelsLoading[r]=(this.numModelsLoading[r]||0)+c.length,Promise.allSettled(l).then((t=>{for(let e=0;e<t.length;e++){const{status:o}=t[e];if("rejected"===o)continue;const{value:s}=t[e];this.models[r][c[e]]||(this.models[r][c[e]]={model:null,numReferences:1}),this.models[r][c[e]].model=s}this.numModelsLoading[r]-=c.length,this.fire(new e.z("data",{dataType:"style"}))})).catch((t=>{this.fire(new e.y(new Error(`Could not load models: ${t.message}`)))}))}isLoaded(){for(const e in this.numModelsLoading)if(this.numModelsLoading[e]>0)return!1;return!0}hasModel(e,t,r={exactIdMatch:!1}){return!!(r.exactIdMatch?this.getModel(e,t):this.getModelByURL(this.modelUris[t][e]))}getModel(e,t){return this.models[t]||(this.models[t]={}),this.models[t][e]?this.models[t][e].model:void 0}getModelByURL(e){if(!e)return null;const t=this.modelByURL[e];return t?this.models[t.scope][t.modelId].model:null}hasModelBeenAdded(e,t){return this.models[t]&&void 0!==this.models[t][e]}getModelURIs(e){return this.modelUris[e]||{}}addModel(e,t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const o=this.requestManager.normalizeModelURL(t);if((this.hasModel(e,r,{exactIdMatch:!0})||this.hasModelBeenAdded(e,r))&&this.modelUris[r][e]===o)this.models[r][e].numReferences++;else if(this.hasURLBeenRequested(o)){const{scope:e,modelId:t}=this.modelByURL[o];this.models[e][t].numReferences++}else this.modelUris[r][e]=o,this.load({[e]:this.modelUris[r][e]},r)}addModelURLs(e,t){this.models[t]||(this.models[t]={}),this.modelUris[t]||(this.modelUris[t]={});const r=this.modelUris[t];for(const t in e)r[t]=this.requestManager.normalizeModelURL(e[t])}reloadModels(e){this.load(this.modelUris[e],e,{forceReload:!0})}addModelsFromBucket(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const o={};for(const s of t)this.hasModel(s,r,{exactIdMatch:!0})||this.hasURLBeenRequested(s)?this.models[r][s].numReferences++:this.modelUris[r][s]&&!this.hasURLBeenRequested(s)?o[s]=this.modelUris[r][s]:!this.hasURLBeenRequested(s)&&e.df(s,!1)&&(this.modelUris[r][s]=this.requestManager.normalizeModelURL(s),o[s]=this.modelUris[r][s]);this.load(o,r)}hasURLBeenRequested(e){return void 0!==this.modelByURL[e]}removeModel(e,t,r=!1,o=!1){if(this.models[t]&&this.models[t][e]&&(this.models[t][e].numReferences--,0===this.models[t][e].numReferences||o)){const o=this.modelUris[t][e];r||delete this.modelUris[t][e],delete this.modelByURL[o];const s=this.models[t][e].model;if(!s)return;delete this.models[t][e],s.destroy()}}destroy(){for(const e of Object.keys(this.models))for(const t of Object.keys(this.models[e])){const r=this.models[e][t].model;delete this.models[e][t],r&&r.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(e){return this.models[e]||(this.models[e]={}),Object.keys(this.models[e])}upload(e,t){this.models[t]||(this.models[t]={});for(const r in this.models[t])this.models[t][r].model&&this.models[t][r].model.upload(e.context)}}const pn=e.a6.colorTheme,fn=new e.a9({data:new e.aa(pn.data)});function mn(t){if(!t.metadata||!t.metadata.content_area)return;const r=e.o.devicePixelRatio,{left:o,top:s,width:l,height:c}=t.metadata.content_area,h=o*r,u=s*r;return[h,u,h+l*r,u+c*r]}function _n(t){if(t)return t.map((([t,r])=>[t*e.o.devicePixelRatio,r*e.o.devicePixelRatio]))}class Eo{constructor(e,t,r){this.id=e,this.scope=t,this.sourceCache=r,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(e){this.missingRequests.has(e.name)||this.pendingRequests.has(e.name)||this.pendingRequests.add(e.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const r=this.sourceCache.getVisibleCoordinates();if(0===r.length)return t;const o=this.sourceCache.getSource();if(!(o instanceof pt))return t;const s=r.map((e=>this.sourceCache.getTile(e))),l=o.getImages(s,Array.from(this.pendingRequests));for(const[r,o]of l)t.set(e.I.from({name:r,iconsetId:this.id}),o),this.pendingRequests.delete(r);for(const e of this.pendingRequests)this.missingRequests.add(e);return this.pendingRequests.clear(),t}}class So{constructor(){e.aY(["_onIndoorUpdate"],this)}onAdd(e){return this._map=e,this._container=u("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.style&&this._map.style.indoorManager.on("selector-update",(e=>this._onIndoorUpdate(e))),this._container}_createButton(e,t){const r=u("button",e,this._container);return r.type="button",r.addEventListener("click",t),r}_createSeparator(){return u("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(e,t){this._map&&(e.setAttribute("aria-label",t),e.textContent=t)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.style&&(this._map.style.indoorManager.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(e){if(!e||!e.floors)return this._model=e,void(this._container.style.display="none");const t=this._model;this._model=e,this._container.style.display="inline-block",this._container.style.borderRadius="8px",t&&Array.from(this._container.children).forEach((e=>e.remove())),e.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(e.floors,e.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const e=this._createButton("mapboxgl-ctrl-buildings-toggle",(()=>{const e=this._map;this._model&&e&&e._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)}));u("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&e.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(e),this._createSeparator()}_updateBuildingsButtonState(){const e=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");e&&this._model&&(this._model.activeFloorsVisible?e.classList.remove("mapboxgl-ctrl-level-button-selected"):e.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(e,t){for(let r=0;r<e.length;r++){const o=e[r],s=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(o.id)})),l=(o.name||"").trim(),c=o.zIndex.toString(),h=l?Array.from(l).slice(0,3).join(""):c;this._setButtonTitle(s,h),this._model&&o.id===this._model.selectedFloorId&&t&&s.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(s),r<e.length-1&&this._createSeparator()}}}class Io extends e.E{constructor(t){super(),this._style=t,this._buildings={},this._indoorControl=null,this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},e.aY(["_updateUI"],this),this._style.on("style.load",(()=>{this._style.isIndoorEnabled()&&(this._style.map.on("load",this._updateUI),this._style.map.on("move",this._updateUI),this._style.map.on("idle",this._updateUI),this._updateUI())}))}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null,this._removeIndoorControl()}selectFloor(e){e===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=e,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(e){this._activeFloorsVisible=e,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(e){for(const[t,r]of Object.entries(e.buildings))if(this._buildings[t])for(const e of r.floorIds)this._buildings[t].floors[e]||(this._buildings[t].floors[e]=r.floors[e]);else this._buildings[t]=r;for(const t of e.activeFloors)this._activeFloors.add(t);this._updateIndoorSelector()}getIndoorTileOptions(e,t){const r=this._style.getIndoorSourceLayers(e,t);return r&&this._indoorState?{sourceLayers:r,indoorState:this._indoorState}:null}_addIndoorControl(){this._indoorControl||(this._indoorControl=new So,this._style.map.addControl(this._indoorControl,"right"))}_removeIndoorControl(){this._indoorControl&&(this._indoorControl.onRemove(),this._indoorControl=null)}_updateUI(){const t=this._style.map.transform,r=function(t,r,o,s){let l=null,c=Number.MAX_SAFE_INTEGER;if(s<16)return null;for(const[s,h]of Object.entries(t)){const t=h.center;if(t){const h=r.distanceTo(e.aT.convert(t));h<c&&o.contains(t)&&(c=h,l=s)}}return l}(this._buildings,t.center,t.getBounds(),t.zoom);r!==this._closestBuildingId&&(this._closestBuildingId=r,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,r=this._closestBuildingId,o=r&&t?t[r]:void 0;if(!o)return this._removeIndoorControl(),void this.fire(new e.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));this._addIndoorControl();let s=null;for(const e of o.floorIds)if(this._activeFloors&&this._activeFloors.has(e)){s=e;break}const l=Array.from(o.floorIds).map((e=>({id:e,name:o.floors[e].name,zIndex:o.floors[e].zIndex}))).sort(((e,t)=>t.zIndex-e.zIndex)).filter(((e,t,r)=>0===t||e.zIndex!==r[t-1].zIndex));this.fire(new e.z("selector-update",{selectedFloorId:s,activeFloorsVisible:this._activeFloorsVisible,floors:l}))}_updateActiveFloors(){const e=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:e,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}const gn=(e,t)=>rt(e,t&&t.filter((e=>"source.canvas"!==e.identifier))),yn=e.aH(ci,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),xn=e.aH(ci,["setCenter","setZoom","setBearing","setPitch"]),vn=new Set(["background","sky","slot","custom"]),bn={version:8,layers:[],sources:{}},wn={duration:300,delay:0};class Oo extends e.E{constructor(t,r={}){super(),this.map=t,this.scope=r.scope||"",this.globalId=null,this.fragments=[],this.importDepth=r.importDepth||0,this.importsCache=r.importsCache||new Map,this.resolvedImports=r.resolvedImports||new Set,this.transition=Object.assign({},wn),this._buildingIndex=new Ut(this),this.crossTileSymbolIndex=new qi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=r.styleChanges||new W,this._hasDataDrivenEmissive=!1,this.indoorManager=new Io(this),this.dispatcher=r.dispatcher?r.dispatcher:new e.D(e.dh(),this),r.imageManager?this.imageManager=r.imageManager:(this.imageManager=new X(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=r.glyphManager?r.glyphManager:new e.di(t._requestManager,r.localFontFamily?e.dj.all:r.localIdeographFontFamily?e.dj.ideographs:e.dj.none,r.localFontFamily||r.localIdeographFontFamily),r.modelManager?this.modelManager=r.modelManager:(this.modelManager=new yo(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=r.configOptions?r.configOptions:new Map,this._configDependentLayers=r.configDependentLayers?r.configDependentLayers:new Set,this._indoorDependentLayers=r.indoorDependentLayers?r.indoorDependentLayers:new Set,this._config=r.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:r.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=r.initialConfig,this.dispatcher.broadcast("setReferrer",e.dk());const o=this;this._rtlTextPluginCallback=Oo.registerForPluginStateChange((t=>{o.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:t.pluginStatus,pluginURL:t.pluginURL},((t,r)=>{if(e.dl(t),r&&r.every((e=>e)))for(const e in o._sourceCaches){const t=o._sourceCaches[e],r=t.getSource().type;"vector"!==r&&"geojson"!==r||t.reload()}}))})),this.on("data",(e=>{if("source"!==e.dataType||"metadata"!==e.sourceDataType)return;const t=this.getOwnSource(e.sourceId);if(t&&t.vectorLayerIds)for(const e in this._layers){const r=this._layers[e];r.source===t.id&&this._validateLayer(r)}}))}load(e){return e?("string"==typeof e?this.loadURL(e):this.loadJSON(e),this):this}_getGlobalId(t){if(!t)return null;if("string"==typeof t){if(e.h(t))return t;const r=e.dm(t);if(!r.startsWith("http"))try{return new URL(r,location.href).toString()}catch(e){return r}return r}return`json://${e.dn(JSON.stringify(t))}`}_diffStyle(t,r,o){this.globalId=this._getGlobalId(t);const s=(e,t)=>{try{t(null,this.setState(e,o))}catch(e){t(e,!1)}};if("string"==typeof t){const o=this.map._requestManager.normalizeStyleURL(t),l=this.map._requestManager.transformRequest(o,e.R.Style);e.m(l,((t,o)=>{t?this.fire(new e.y(t)):o&&s(o,r)}))}else"object"==typeof t&&s(t,r)}loadURL(t,r={}){this.fire(new e.z("dataloading",{dataType:"style"}));const o="boolean"==typeof r.validate?r.validate:!e.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,r.accessToken),this.resolvedImports.add(t);const s=this.importsCache.get(t);if(s)return this._load(s,o);const l=this.map._requestManager.transformRequest(t,e.R.Style);this._request=e.m(l,((r,s)=>{if(this._request=null,r)this.fire(new e.y(r));else if(s)return this.importsCache.set(t,s),this._load(s,o)}))}loadJSON(t,r={}){this.fire(new e.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=e.o.frame((()=>{this._request=null,this._load(t,!1!==r.validate)}))}loadEmpty(){this.fire(new e.z("dataloading",{dataType:"style"})),this._load(bn,!1)}_loadImports(t,r,o){if(this.importDepth>=4)return e.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const s=[];for(const e of t){const t=this._createFragmentStyle(e),l=new Promise((e=>{t.once("style.import.load",e),t.once("error",e)})).then((()=>this.mergeAll()));if(s.push(l),this.resolvedImports.has(e.url)){t.loadEmpty();continue}const c=e.data||this.importsCache.get(e.url);c?(t.loadJSON(c,{validate:r}),this._isInternalStyle(c)&&(t.globalId=null)):e.url?t.loadURL(e.url,{validate:r}):t.loadEmpty();const h={style:t,id:e.id,config:e.config};if(o){const e=this.fragments.findIndex((({id:e})=>e===o));this.fragments=this.fragments.slice(0,e).concat(h).concat(this.fragments.slice(e))}else this.fragments.push(h)}return Promise.allSettled(s)}getImportGlobalIds(e=this,t=new Set){for(const r of e.fragments)r.style.globalId&&t.add(r.style.globalId),this.getImportGlobalIds(r.style,t);return[...t.values()]}_createFragmentStyle(t){const r=this.scope?e.B(t.id,this.scope):t.id;let o;const s=this._initialConfig&&this._initialConfig[r];(t.config||s)&&(o=Object.assign({},t.config,s));const l=new Oo(this.map,{scope:r,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:o,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return l.setEventedParent(this.map,{style:l}),l}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(e){return this.isRootStyle()&&(e.fragment||!!e.schema&&!1!==e.fragment)}_load(t,r){if(this._isInternalStyle(t)){const e=Object.assign({},bn,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(e,r)}if(this.updateConfig(this._config,t.schema),r&&gn(this,Ue(t)))return;this._loaded=!0,this.stylesheet=e.dp(t);const o=()=>{for(const e in t.sources)this.addSource(e,t.sources[e],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const e in t.iconsets)this.addIconset(e,t.iconsets[e]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const o=li(this.stylesheet.layers);if(this._order=o.map((e=>e.id)),this.stylesheet.light&&e.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const e=this.stylesheet.lights[0];this.light=new Ne(e.properties,e.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ne(this.stylesheet.light)),this._layers={};for(const t of o){const r=e.du(t,this.scope,this._styleColorTheme.lut,this.options);0!==r.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(r.fqid),r.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(r.fqid),this._hasAppearances=this._hasAppearances||0!==r.getAppearances().length,r.setEventedParent(this,{layer:{id:r.id}}),this._layers[r.id]=r;const o=this.getOwnLayerSourceCache(r),s=!!this.directionalLight&&this.directionalLight.shadowsEnabled();o&&r.canCastShadows()&&s&&(o.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const s=this.stylesheet.terrain;s&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(s,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new e.z("data",{dataType:"style"}));const l=this.isRootStyle();t.imports?this._loadImports(t.imports,r).then((()=>{this._reloadImports(),this.fire(new e.z(l?"style.load":"style.import.load"))})).catch((t=>{this.fire(new e.y(new Error("Failed to load imports",t))),this.fire(new e.z(l?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new e.z(l?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const s=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(s){const t=this._evaluateColorThemeData(s);this._loadColorTheme(t).then((()=>{o()})).catch((t=>{e.w(`Couldn't load color theme from the stylesheet: ${t}`),o()}))}else this._styleColorTheme.lut=null,o()}isRootStyle(){return 0===this.importDepth}hasAppearances(){return this._hasAppearances||this.fragments.some((e=>e.style.hasAppearances()))}mergeAll(){let e,t,r,o,s,l,c,h,u,d;const p={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((f=>{if(f.stylesheet){if(null!=f.light&&(e=f.light),f.stylesheet.lights)for(const e of f.stylesheet.lights)"ambient"===e.type&&null!=f.ambientLight&&(t=f.ambientLight),"directional"===e.type&&null!=f.directionalLight&&(r=f.directionalLight);o=this._prioritizeTerrain(o,f.terrain,f.stylesheet.terrain),f.stylesheet.fog&&null!=f.fog&&(s=f.fog),f.stylesheet.snow&&null!=f.snow&&(l=f.snow),f.stylesheet.rain&&null!=f.rain&&(c=f.rain),null!=f.stylesheet.camera&&(d=f.stylesheet.camera),null!=f.stylesheet.projection&&(h=f.stylesheet.projection),null!=f.stylesheet.transition&&(u=f.stylesheet.transition),p[f.scope]=f._styleColorTheme}})),this.light=e,this.ambientLight=t,this.directionalLight=r,this.fog=s,this.snow=l,this.rain=c,this._styleColorThemeForScope=p,null===o?delete this.terrain:this.terrain=o,this.camera=d||{"camera-projection":"perspective"},this.projection=h||{name:"mercator"},this.transition=Object.assign({},wn,u),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(e){const t=r=>{for(const e of r.fragments)t(e.style);e(r)};t(this)}_prioritizeTerrain(e,t,r){const o=e&&0===e.drapeRenderMode;return null===r?t&&0===t.drapeRenderMode?t:o?e:null:null!=t&&(!e||o||t&&1===t.drapeRenderMode)?t:e}mergeTerrain(){let e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((t=>{e=this._prioritizeTerrain(e,t.terrain,t.stylesheet.terrain)})),null===e?delete this.terrain:this.terrain=e}mergeProjection(){let e;this.forEachFragmentStyle((t=>{null!=t.stylesheet.projection&&(e=t.stylesheet.projection)})),this.projection=e||{name:"mercator"}}mergeSources(){const t={},r={},o={};this.forEachFragmentStyle((s=>{for(const r in s._sourceCaches){const o=e.B(r,s.scope);t[o]=s._sourceCaches[r]}for(const t in s._otherSourceCaches){const o=e.B(t,s.scope);r[o]=s._otherSourceCaches[t]}for(const t in s._symbolSourceCaches){const r=e.B(t,s.scope);o[r]=s._symbolSourceCaches[t]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=r,this._mergedSymbolSourceCaches=o}mergeIndoor(){this.forEachFragmentStyle((t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const r of Object.values(t.stylesheet.indoor)){const o=r,s=e.B(o.sourceId,t.scope);this._mergedIndoor[s]=new Set(o.sourceLayers||[])}}))}mergeLayers(){const t={},r=[],o={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((o=>{for(const s of o._order){const l=o._layers[s];if("slot"===l.type){const r=e.dq(s);if(t[r])continue;t[r]=[]}l.slot&&t[l.slot]?t[l.slot].push(l):r.push(l)}})),this._mergedOrder=[];let s=-1;const l=(r=[])=>{for(const c of r)if("slot"===c.type){const r=e.dq(c.id);t[r]&&l(t[r]),this._mergedSlots.push(r)}else{const t=e.B(c.id,c.scope);this._mergedOrder.push(t),o[t]=c,c.is3D(!!this.terrain)&&(this._has3DLayers=!0,s=this._mergedOrder.length-1),"circle"===c.type&&(this._hasCircleLayers=!0),"symbol"===c.type&&(this._hasSymbolLayers=!0),"clip"===c.type&&(this._clipLayerPresent=!0)}};if(l(r),this._has3DLayers){const e={};for(let t=0;t<this._mergedOrder.length;++t){const r=this._mergedOrder[t];e[r]=t===s?1:t<s?o[r].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort(((t,r)=>e[t]-e[r]))}this._mergedLayers=o,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged(),this._updateDataDrivenEmissiveStrength()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(e){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,e),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(t,r,o){const s=Object.assign({},r);for(const e of Object.keys(pn))void 0===s[e]&&(s[e]=pn[e].default);const l=new e.a8(fn,t,new Map(o));return l.setTransitionOrValue(s,o),l.untransitioned().possiblyEvaluate(new e.ac(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const r=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((o,s)=>{const l="data:image/png;base64,";if(!t||0===t.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void o();let c=t;c.startsWith(l)||(c=l+c);const h=e.I.from("mapbox-reserved-lut"),u=new Image;u.src=c,u.onerror=()=>{this._styleColorTheme.lutLoading=!1,s(new Error("Failed to load image data"))},u.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==r)return void o();this._styleColorTheme.lutLoading=!1;const{width:l,height:c,data:d}=e.o.getImageData(u);if(c>32)return void s(new Error("The height of the image must be less than or equal to 32 pixels."));if(l!==c*c)return void s(new Error("The width of the image must be equal to the height squared."));this.getImage(h)&&this.removeImage(h),this.addImage(h,{data:new e.q({width:l,height:c},d),pixelRatio:1,sdf:!1,usvg:!1,version:0});const p=this.imageManager.getImage(h,this.scope);p?(this._styleColorTheme.lut={image:p.data,data:t},o()):s(new Error("Missing LUT image."))}}))}getLut(e){const t=this._styleColorThemeForScope[e];return t?t.lut:null}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(t,r,o){let s,l,c;const h=e.o.devicePixelRatio>1?"@2x":"";let u=e.m(r.transformRequest(r.normalizeSpriteURL(t,h,".json"),e.R.SpriteJSON),((e,t)=>{u=null,c||(c=e,s=t,p())})),d=e.n(r.transformRequest(r.normalizeSpriteURL(t,h,".png"),e.R.SpriteImage),((e,t)=>{d=null,c||(c=e,l=t,p())}));function p(){if(c)o(c);else if(s&&l){const t=e.o.getImageData(l),r={};for(const o in s){const{width:l,height:c,x:h,y:u,sdf:d,pixelRatio:p,stretchX:f,stretchY:m,content:_}=s[o],v=new e.q({width:l,height:c});e.q.copy(t,v,{x:h,y:u},{x:0,y:0},{width:l,height:c},null),r[o]={data:v,pixelRatio:void 0!==p?p:1,sdf:void 0!==d&&d,stretchX:f,stretchY:m,content:_,usvg:!1,version:0}}o(null,r)}}return{cancel(){u&&(u.cancel(),u=null),d&&(d.cancel(),d=null)}}}(t,this.map._requestManager,((t,r)=>{if(this._spriteRequest=null,t)this.fire(new e.y(t));else if(r){const t=new Map;for(const o in r)t.set(e.I.from(o),r[o]);this.addImages(t)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new e.z("data",{dataType:"style"}))}))}addIconset(t,r){if("sprite"===r.type)return void this._loadSprite(r.url);const o=this.getOwnSourceCache(r.source);if(!o)return void this.fire(new e.y(new Error(`Source "${r.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const s=o.getSource();if("raster-array"!==s.type)return void this.fire(new e.y(new Error(`Source "${r.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));s.partial=!1;const l=new Eo(t,this.scope,o);this.imageManager.addImageProvider(l,this.scope)}removeIconset(e){this.imageManager.removeImageProvider(e,this.scope)}_loadIconset(t){if(!e.h(t)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(t);const r="auto"===this.map._spriteFormat;var o,s;this._spriteRequest=(s=(o,s)=>{if(this._spriteRequest=null,o)r?this._loadSprite(t):this.fire(new e.y(o));else if(s){const t=new Map;for(const r in s)t.set(e.I.from(r),s[r]);this.addImages(t)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new e.z("data",{dataType:"style"}))},e.bu((o=this.map._requestManager).transformRequest(o.normalizeIconsetURL(t),e.R.Iconset),((t,r)=>{if(t)return void s(t);const o={},l=e.dg(new e.bt(r));for(const t of l.icons){const r={version:1,pixelRatio:e.o.devicePixelRatio,content:mn(t),stretchX:t.metadata?_n(t.metadata.stretch_x_areas):void 0,stretchY:t.metadata?_n(t.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:t};o[t.name]=r}s(null,o)})))}_validateLayer(t){const r=this.getOwnSource(t.source);if(!r)return;const o=t.sourceLayer;o&&("geojson"===r.type||r.vectorLayerIds&&-1===r.vectorLayerIds.indexOf(o))&&this.fire(new e.y(new Error(`Source layer "${o}" does not exist on source "${r.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(this.imageManager.hasPatternsInFlight())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:e}of this.fragments)if(!e.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((e,t)=>{const r=this.fragments[t];return r&&r.style&&(e.data=r.style.serialize()),e}))}_serializeSources(){const e={};for(const t in this._sourceCaches){const r=this._sourceCaches[t].getSource();e[r.id]||(e[r.id]=r.serialize())}return e}_serializeLayers(e){const t=[];for(const r of e){const e=this._layers[r];e&&"custom"!==e.type&&t.push(e.serialize())}return t}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}_updateDataDrivenEmissiveStrength(){for(const e in this._mergedLayers){const t=this._mergedLayers[e];if(t._transitionablePaint&&t._transitionablePaint._values){const e=t._transitionablePaint._values["line-emissive-strength"];if(e&&e.value&&e.value.isDataDriven())return void(this._hasDataDrivenEmissive=!0)}}this._hasDataDrivenEmissive=!1}hasDataDrivenEmissiveStrength(){return this._hasDataDrivenEmissive}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(e){return e?this.order:this._mergedOrder}isLayerDraped(e){return!!this.terrain&&e.isDraped(this.getLayerSourceCache(e))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const r=this.getOwnLayer(t);if(r)return r;this.fire(new e.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const r=this.getOwnSource(t);if(r)return r;this.fire(new e.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(e,t){const r=this.map.painter;if(r)for(let o=e.minzoom||0;o<(e.maxzoom||25.5);o++){const o=e.getProgramIds();if(o)for(const s of o){const o=e.getDefaultProgramParams(s,t.zoom,this._styleColorTheme.lut);o&&(r.style=this,this.fog&&(r._fogVisible=!0,o.overrideFog=!0,r.getOrCreateProgram(s,o)),r._fogVisible=!1,o.overrideFog=!1,r.getOrCreateProgram(s,o),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(o.overrideRtt=!0,r.getOrCreateProgram(s,o)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const r=this.calculateLightsBrightness();t.brightness=r||0,r!==this._brightness&&(this._brightness=r,this.dispatcher.broadcast("setBrightness",r)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const o=this._changes.isDirty();let s=!1;if(this._changes.isDirty()){const e=this._changes.getLayerUpdatesByScope();for(const t in e){const{updatedIds:r,removedIds:o}=e[t];(r||o)&&(this._updateWorkerLayers(t,r,o),s=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const l={};for(const e in this._mergedSourceCaches){const t=this._mergedSourceCaches[e];l[e]=t.used,t.used=!1,t.tileCoverLift=0}for(const e of this._mergedOrder){const r=this._mergedLayers[e];if("none"!==r.visibility&&r.recalculate(t,this._availableImages),!r.isHidden(t.zoom)){const e=this.getLayerSourceCache(r);e&&(e.used=!0,e.tileCoverLift=Math.max(e.tileCoverLift,r.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(r,t)})):this.precompilePrograms(r,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&s&&this.mergeLayers();const c=this.imageManager.getPendingImageProviders();for(const e of c)e.sourceCache.used=!0;for(const t in l){const r=this._mergedSourceCaches[t];l[t]!==r.used&&r.getSource().fire(new e.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:r.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),o&&this.fire(new e.z("data",{dataType:"style"}))}updateImageProviders(){const e=this.imageManager.getPendingImageProviders();for(const t of e){const e=t.resolvePendingRequests(),r=this.getFragmentStyle(t.scope);r&&r.addImages(e)}}_updateTilesForChangedImages(){const e={};for(const t in this._mergedSourceCaches){const r=this._mergedSourceCaches[t].getSource().scope;e[r]=e[r]||this._changes.getUpdatedImages(r),0!==e[r].length&&this._mergedSourceCaches[t].reloadTilesForDependencies(["icons","patterns"],e[r])}for(const t in e)this._changes.resetUpdatedImages(t)}_updateWorkerLayers(e,t,r){const o=this.getFragmentStyle(e);o&&this.dispatcher.broadcast("updateLayers",{layers:t?o._serializeLayers(t):[],scope:e,removedIds:r||[],options:o.options})}setState(t,r){if(this._checkLoaded(),gn(this,Ue(t)))return!1;(t=e.dp(t)).layers=li(t.layers);const o=function(t,r){if(!t)return[{command:ci.setStyle,args:[r]}];let o=[];try{if(!e.by(t.version,r.version))return[{command:ci.setStyle,args:[r]}];if(e.by(t.center,r.center)||o.push({command:ci.setCenter,args:[r.center]}),e.by(t.zoom,r.zoom)||o.push({command:ci.setZoom,args:[r.zoom]}),e.by(t.bearing,r.bearing)||o.push({command:ci.setBearing,args:[r.bearing]}),e.by(t.pitch,r.pitch)||o.push({command:ci.setPitch,args:[r.pitch]}),e.by(t.sprite,r.sprite)||o.push({command:ci.setSprite,args:[r.sprite]}),e.by(t.glyphs,r.glyphs)||o.push({command:ci.setGlyphs,args:[r.glyphs]}),e.by(t.imports,r.imports)||function(t=[],r=[],o){r=r||[];const s=(t=t||[]).map(mi),l=r.map(mi),c=t.reduce(_i,{}),h=r.reduce(_i,{}),u=s.slice();let d,p,f,m;for(d=0,p=0;d<s.length;d++)f=s[d],h.hasOwnProperty(f)?p++:(o.push({command:ci.removeImport,args:[f]}),u.splice(u.indexOf(f,p),1));for(d=0,p=0;d<l.length;d++)f=l[l.length-1-d],u[u.length-1-d]!==f&&(c.hasOwnProperty(f)?(o.push({command:ci.removeImport,args:[f]}),u.splice(u.lastIndexOf(f,u.length-p),1)):p++,m=u[u.length-d],o.push({command:ci.addImport,args:[h[f],m]}),u.splice(u.length-d,0,f));for(const t of r){const r=c[t.id];r&&(delete r.data,e.by(r,t)||o.push({command:ci.updateImport,args:[t.id,t]}))}}(t.imports,r.imports,o),e.by(t.transition,r.transition)||o.push({command:ci.setTransition,args:[r.transition]}),e.by(t.light,r.light)||o.push({command:ci.setLight,args:[r.light]}),e.by(t.fog,r.fog)||o.push({command:ci.setFog,args:[r.fog]}),e.by(t.snow,r.snow)||o.push({command:ci.setSnow,args:[r.snow]}),e.by(t.rain,r.rain)||o.push({command:ci.setRain,args:[r.rain]}),e.by(t.projection,r.projection)||o.push({command:ci.setProjection,args:[r.projection]}),e.by(t.lights,r.lights)||o.push({command:ci.setLights,args:[r.lights]}),e.by(t.camera,r.camera)||o.push({command:ci.setCamera,args:[r.camera]}),e.by(t.iconsets,r.iconsets)||function(t,r,o){let s;for(s in r=r||{},t=t||{})t.hasOwnProperty(s)&&(r.hasOwnProperty(s)||o.push({command:ci.removeIconset,args:[s]}));for(s in r){if(!r.hasOwnProperty(s))continue;const l=r[s];t.hasOwnProperty(s)?e.by(t[s],l)||(o.push({command:ci.removeIconset,args:[s]}),o.push({command:ci.addIconset,args:[s,l]})):o.push({command:ci.addIconset,args:[s,l]})}}(t.iconsets,r.iconsets,o),!e.by(t["color-theme"],r["color-theme"]))return[{command:ci.setStyle,args:[r]}];const s={},l=[];!function(t,r,o,s){let l;for(l in r=r||{},t=t||{})t.hasOwnProperty(l)&&(r.hasOwnProperty(l)||ui(l,o,s));for(l in r){if(!r.hasOwnProperty(l))continue;const c=r[l];t.hasOwnProperty(l)?e.by(t[l],c)||("geojson"===t[l].type&&"geojson"===c.type&&pi(t,r,l)?o.push({command:ci.setGeoJSONSourceData,args:[l,c.data]}):di(l,r,o,s)):hi(l,r,o)}}(t.sources,r.sources,l,s);const c=[];t.layers&&t.layers.forEach((e=>{e.source&&s[e.source]?o.push({command:ci.removeLayer,args:[e.id]}):c.push(e)}));let h=t.terrain;h&&s[h.source]&&(o.push({command:ci.setTerrain,args:[void 0]}),h=void 0),o=o.concat(l),e.by(h,r.terrain)||o.push({command:ci.setTerrain,args:[r.terrain]}),function(t,r,o){r=r||[];const s=(t=t||[]).map(mi),l=r.map(mi),c=t.reduce(_i,{}),h=r.reduce(_i,{}),u=s.slice(),d=Object.create(null);let p,f,m,_,v,E,P;for(p=0,f=0;p<s.length;p++)m=s[p],h.hasOwnProperty(m)?f++:(o.push({command:ci.removeLayer,args:[m]}),u.splice(u.indexOf(m,f),1));for(p=0,f=0;p<l.length;p++)m=l[l.length-1-p],u[u.length-1-p]!==m&&(c.hasOwnProperty(m)?(o.push({command:ci.removeLayer,args:[m]}),u.splice(u.lastIndexOf(m,u.length-f),1)):f++,E=u[u.length-p],o.push({command:ci.addLayer,args:[h[m],E]}),u.splice(u.length-p,0,m),d[m]=!0);for(p=0;p<l.length;p++)if(m=l[p],_=c[m],v=h[m],!d[m]&&!e.by(_,v))if(e.by(_.source,v.source)&&e.by(_["source-layer"],v["source-layer"])&&e.by(_.type,v.type)){for(P in fi(_.layout,v.layout,o,m,null,ci.setLayoutProperty),fi(_.paint,v.paint,o,m,null,ci.setPaintProperty),e.by(_.slot,v.slot)||o.push({command:ci.setSlot,args:[m,v.slot]}),e.by(_.filter,v.filter)||o.push({command:ci.setFilter,args:[m,v.filter]}),e.by(_.minzoom,v.minzoom)&&e.by(_.maxzoom,v.maxzoom)||o.push({command:ci.setLayerZoomRange,args:[m,v.minzoom,v.maxzoom]}),_)_.hasOwnProperty(P)&&"layout"!==P&&"paint"!==P&&"filter"!==P&&"metadata"!==P&&"minzoom"!==P&&"maxzoom"!==P&&"slot"!==P&&(0===P.indexOf("paint.")?fi(_[P],v[P],o,m,P.slice(6),ci.setPaintProperty):e.by(_[P],v[P])||o.push({command:ci.setLayerProperty,args:[m,P,v[P]]}));for(P in v)v.hasOwnProperty(P)&&!_.hasOwnProperty(P)&&"layout"!==P&&"paint"!==P&&"filter"!==P&&"metadata"!==P&&"minzoom"!==P&&"maxzoom"!==P&&"slot"!==P&&(0===P.indexOf("paint.")?fi(_[P],v[P],o,m,P.slice(6),ci.setPaintProperty):e.by(_[P],v[P])||o.push({command:ci.setLayerProperty,args:[m,P,v[P]]}))}else o.push({command:ci.removeLayer,args:[m]}),E=u[u.lastIndexOf(m)+1],o.push({command:ci.addLayer,args:[v,E]})}(c,r.layers,o)}catch(e){console.warn("Unable to compute style diff:",e),o=[{command:ci.setStyle,args:[r]}]}return o}(this.serialize(),t).filter((e=>!(e.command in xn)));if(0===o.length)return!1;const s=o.filter((e=>!(e.command in yn)));if(s.length>0)throw new Error(`Unimplemented: ${s.map((e=>e.command)).join(", ")}.`);const l=[];return o.forEach((e=>{l.push(this[e.command](...e.args))})),r&&Promise.all(l).then(r).catch(r),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(0===t.size)return this;for(const[r,o]of t.entries()){if(this.getImage(r))return this.fire(new e.y(new Error(`An image with the name "${r.name}" already exists.`)));this.imageManager.addImage(r,this.scope,o),this._changes.updateImage(r,this.scope)}return this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this}addImage(t,r){return this.getImage(t)?this.fire(new e.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,r),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this)}updateImage(t,r,o=!1){this.imageManager.updateImage(t,this.scope,r),o&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})))}getImage(e){return this.imageManager.getImage(e,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this):this.fire(new e.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}getActualScope(){return this._importedAsBasemap?"basemap":this.scope}addModelURLs(t){return this.modelManager.addModelURLs(t,this.getActualScope()),this._updateWorkerModels(),this.fire(new e.z("data",{dataType:"style"})),this}addModel(t,r,o={}){return this._checkLoaded(),this._validate(tt,`models.${t}`,r,null,o)||(this.modelManager.addModel(t,r,this.getActualScope()),this.fire(new e.z("data",{dataType:"style"}))),this}hasModel(e){return this.modelManager.hasModel(e,this.getActualScope())}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.getActualScope(),!1,!0),this.fire(new e.z("data",{dataType:"style"})),this):this.fire(new e.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.getActualScope())}addSource(t,r,o={}){if(this._checkLoaded(),void 0!==this.getOwnSource(t))throw new Error(`There is already a source with ID "${t}".`);if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(je,`sources.${t}`,r,null,o))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const s=Vt(t,r,this.dispatcher,this);s.scope=this.scope,s.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(s.id),source:s.serialize(),sourceId:s.id})));const l=t=>{const r=(t?"symbol:":"other:")+s.id,o=e.B(r,this.scope),l=this._sourceCaches[r]=new Ft(o,s,t);(t?this._symbolSourceCaches:this._otherSourceCaches)[s.id]=l,l.onAdd(this.map)};l(!1),"vector"!==r.type&&"geojson"!==r.type||l(!0),s.onAdd&&s.onAdd(this.map),o.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const r=this.getOwnSource(t);if(!r)throw new Error("There is no source with this ID");for(const r in this._layers)if(this._layers[r].source===t)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while layer "${r}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const r=Object.entries(this.stylesheet.iconsets).find((([e,r])=>"source"===r.type&&r.source===t));if(r)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while iconset "${r[0]}" is using it.`)))}const o=this.getOwnSourceCaches(t);for(const t of o){const r=e.dq(t.id);delete this._sourceCaches[r],this._changes.discardSourceCacheUpdate(t.id),t.fire(new e.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:t.getSource().id})),t.setEventedParent(null),t.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),r.setEventedParent(null),r.onRemove&&r.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(e,t){this._checkLoaded(),this.getOwnSource(e).setData(t),this._changes.setDirty()}getOwnSource(e){const t=this.getOwnSourceCache(e);return t&&t.getSource()}getOwnSources(){const e=[];for(const t in this._otherSourceCaches){const r=this.getOwnSourceCache(t);r&&e.push(r.getSource())}return e}areTilesLoaded(){const e=this._mergedSourceCaches;for(const t in e){const r=e[t]._tiles;for(const e in r){const t=r[e];if("loaded"!==t.state&&"errored"!==t.state)return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const r=this._getTransitionParameters();for(const e of t){if(this._validate(qe,"lights",e))return;switch(e.type){case"ambient":if(this.ambientLight){const t=this.ambientLight;t.set(e),t.updateTransitions(r)}else this.ambientLight=new et(e,St(),this.scope,this.options);break;case"directional":if(this.directionalLight){const t=this.directionalLight;t.set(e),t.updateTransitions(r)}else this.directionalLight=new et(e,Et(),this.scope,this.options)}}const o=Object.assign(r,{worldview:this.map.getWorldview()}),s=new e.ac(this.z||0,o);this.ambientLight&&this.ambientLight.recalculate(s),this.directionalLight&&this.directionalLight.recalculate(s),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,r=this.ambientLight;if(!t||!r)return;const o=e=>.2126*(e[0]<=.03928?e[0]/12.92:Math.pow((e[0]+.055)/1.055,2.4))+.7152*(e[1]<=.03928?e[1]/12.92:Math.pow((e[1]+.055)/1.055,2.4))+.0722*(e[2]<=.03928?e[2]/12.92:Math.pow((e[2]+.055)/1.055,2.4)),s=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),l=t.properties.get("intensity"),c=t.properties.get("direction"),h=1-e.d4(c.x,c.y,c.z)[2]/90,u=o(s)*l*h,d=r.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=r.properties.get("intensity"),f=o(d)*p;return Number(((u+f)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const e=[];return this.directionalLight&&e.push(this.directionalLight.get()),this.ambientLight&&e.push(this.ambientLight.get()),e}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(null==t||""===t&&this.isRootStyle())return this;if(e.dr(t)){const r=e.ds(t),o=this.fragments.find((({id:e})=>e===r));if(!o)return;const s=e.dq(t);return o.style.getFragmentStyle(s)}{const e=this.fragments.find((({id:e})=>e===t));return e?e.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const r={},o=(e,t="")=>`${e}::${t}`;this._featuresetSelectors={};for(const s in t){const l=this._featuresetSelectors[s]=[];for(const c of t[s].selectors){if(c.featureNamespace){const t=this.getOwnLayer(c.layer);if(!t){e.w(`Layer is undefined for selector: ${c.layer}`);continue}const l=o(t.source,t.sourceLayer);if(l in r&&r[l]!==c.featureNamespace){e.w(`"featureNamespace ${c.featureNamespace} of featureset ${s}'s selector is not associated to the same source, skip this selector`);continue}r[l]=c.featureNamespace}let t;if(c.properties)for(const r in c.properties){const o=e.U(c.properties[r]);"success"===o.result&&(t=t||{},t[r]=o.value)}l.push({layerId:c.layer,namespace:c.featureNamespace,properties:t,uniqueFeatureID:c._uniqueFeatureID})}}}getFeaturesetDescriptors(e){const t=this.getFragmentStyle(e);if(!t||!t.stylesheet.featuresets)return[];const r=[];for(const e in t.stylesheet.featuresets)r.push({featuresetId:e,importId:t.scope?t.scope:void 0});return r}getFeaturesetLayers(t,r){const o=this.getFragmentStyle(r),s=o.stylesheet.featuresets;if(!s||!s[t])return this.fire(new e.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const l=[];for(const e of s[t].selectors){const t=o.getOwnLayer(e.layer);t&&l.push(t)}return l}getConfigProperty(t,r){const o=this.getFragmentStyle(t);if(!o)return null;const s=e.B(r,o.scope),l=o.options.get(s),c=l?l.value||l.default:null;return c?c.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,r){const o=e.B(t,r);return this._mergedIndoor[o]}setIndoorData(e,t){this.indoorManager.setIndoorData(t)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,r,o){const s=this.getFragmentStyle(t);if(!s)return;const l=s.stylesheet.schema;if(!l||!l[r])return;const c=e.U(o);if("success"!==c.result)return void gn(this,c.value);const h=c.value.expression,u=e.B(r,s.scope),d=s.options.get(u);if(!d)return;let p;const{minValue:f,maxValue:m,stepValue:_,type:v,values:E}=l[r],P=e.U(l[r].default);"success"===P.result&&(p=P.value.expression),p?(this.options.set(u,Object.assign({},d,{value:h,default:p,minValue:f,maxValue:m,stepValue:_,type:v,values:E})),this.updateConfigDependencies(r)):this.fire(new e.y(new Error(`No schema defined for the config option "${r}" in the "${t}" fragment.`)))}getConfig(t){const r=this.getFragmentStyle(t);if(!r)return null;const o=r.stylesheet.schema;if(!o)return null;const s={};for(const t in o){const o=e.B(t,r.scope),l=r.options.get(o),c=l?l.value||l.default:null;s[t]=c?c.serialize():null}return s}setConfig(e,t){const r=this.getFragmentStyle(e);r&&(r.updateConfig(t,r.stylesheet.schema),this.updateConfigDependencies())}getSchema(e){const t=this.getFragmentStyle(e);return t?t.stylesheet.schema:null}setSchema(e,t){const r=this.getFragmentStyle(e);r&&(r.stylesheet.schema=t,r.updateConfig(r._config,t),this.updateConfigDependencies())}updateConfig(t,r){if(this._config=t,t||r)if(r)for(const o in r){let s,l;const c=e.U(r[o].default);if("success"===c.result&&(s=c.value.expression),t&&void 0!==t[o]){const r=e.U(t[o]);"success"===r.result&&(l=r.value.expression)}const{minValue:h,maxValue:u,stepValue:d,type:p,values:f}=r[o];if(s){const t=e.B(o,this.scope);this.options.set(t,{default:s,value:l,minValue:h,maxValue:u,stepValue:d,type:p,values:f})}else this.fire(new e.y(new Error(`No schema defined for config option "${o}".`)))}else this.fire(new e.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(e,t=()=>!0){for(const r of e){const e=this.getLayer(r);e&&t(e)&&(e.possiblyEvaluateVisibility(),this._updateLayer(e),this._changes.setDirty())}}updateConfigDependencies(e){this._updateLayers(this._configDependentLayers,(t=>!e||t.expressionDependencies.configDependencies.has(e))),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((e=>{const t=e._styleColorTheme.colorThemeOverride?e._styleColorTheme.colorThemeOverride:e._styleColorTheme.colorTheme;if(t){const r=e._evaluateColorThemeData(t);(!e._styleColorTheme.lut&&""!==r||e._styleColorTheme.lut&&r!==e._styleColorTheme.lut.data)&&e.setColorTheme(t)}})),this._changes.setDirty()}addLayer(t,r,o={}){this._checkLoaded();const s=t.id;if(this._layers[s])return void this.fire(new e.y(new Error(`Layer with id "${s}" already exists on this map`)));let l;if("custom"===t.type){if(gn(this,e.dt(t)))return;l=e.du(t,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof t.source&&(this.addSource(s,t.source),t=e.dp(t),t=Object.assign(t,{source:s})),this._validate(Ye,`layers.${s}`,t,{arrayIndex:-1},o))return;l=e.du(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(l),l.setEventedParent(this,{layer:{id:s}})}const c=e.B(l.source,l.scope);0!==l.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(c),l.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(c);let h=this._order.length;if(r){const t=this._order.indexOf(r);if(-1===t)return void this.fire(new e.y(new Error(`Layer with id "${r}" does not exist on this map.`)));l.slot&&l.slot!==this._layers[r].slot?e.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`):h=t}this._order.splice(h,0,s),this._handleLayerOrderChange(),this._layers[s]=l;const u=this.getOwnLayerSourceCache(l),d=!!this.directionalLight&&this.directionalLight.shadowsEnabled();u&&l.canCastShadows()&&d&&(u.castsShadows=!0);const p=this._changes.getRemovedLayer(l);if(p&&l.source&&u&&"custom"!==l.type){this._changes.discardLayerRemoval(l);const t=e.B(l.source,l.scope);p.type!==l.type?this._changes.updateSourceCache(t,"clear"):(this._changes.updateSourceCache(t,"reload"),u.pause())}this._updateLayer(l),l.onAdd&&l.onAdd(this.map),l.scope=this.scope,this.mergeLayers()}moveLayer(t,r){this._checkLoaded();const o=this._checkLayer(t);if(!o)return;if(t===r)return;const s=this._order.indexOf(t);this._order.splice(s,1);let l=this._order.length;if(r){const t=this._order.indexOf(r);if(-1===t)return void this.fire(new e.y(new Error(`Layer with id "${r}" does not exist on this map.`)));o.slot&&o.slot!==this._layers[r].slot?e.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`):l=t}this._order.splice(l,0,t),this._changes.setDirty(),this._handleLayerOrderChange(),this.mergeLayers()}removeLayer(e){this._checkLoaded();const t=this._checkLayer(e);if(!t)return;t.setEventedParent(null);const r=this._order.indexOf(e);this._order.splice(r,1),delete this._layers[e],this._changes.setDirty(),this._handleLayerOrderChange(),this._configDependentLayers.delete(t.fqid),this._indoorDependentLayers.delete(t.fqid),this._changes.removeLayer(t);const o=this.getOwnLayerSourceCache(t);if(o&&o.castsShadows){let e=!1;for(const r in this._layers)if(this._layers[r].source===t.source&&this._layers[r].canCastShadows()){e=!0;break}o.castsShadows=e}t.onRemove&&t.onRemove(this.map),this.mergeLayers()}getOwnLayer(e){return this._layers[e]}hasLayer(e){return e in this._mergedLayers}hasLayerType(e){for(const t in this._layers)if(this._layers[t].type===e)return!0;return!1}setLayerZoomRange(e,t,r){this._checkLoaded();const o=this._checkLayer(e);o&&(o.minzoom===t&&o.maxzoom===r||(null!=t&&(o.minzoom=t),null!=r&&(o.maxzoom=r),this._updateLayer(o)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(e,t){this._checkLoaded();const r=this._checkLayer(e);r&&r.slot!==t&&(r.slot=t,this._updateLayer(r))}setFilter(t,r,o={}){this._checkLoaded();const s=this._checkLayer(t);if(s&&!e.by(s.filter,r))return null==r?(s.filter=void 0,void this._updateLayer(s)):void(this._validate(Je,`layers.${s.id}.filter`,r,{layerType:s.type},o)||(s.filter=e.dp(r),this._updateLayer(s)))}getFilter(t){const r=this._checkLayer(t);if(r)return e.dp(r.filter)}setLayoutProperty(t,r,o,s={}){this._checkLoaded();const l=this._checkLayer(t);if(l&&!e.by(l.getLayoutProperty(r),o)){if(null!=o&&(!s||!1!==s.validate)&&gn(l,Ke.call(Ue,{key:`layers.${t}.layout.${r}`,layerType:l.type,objectKey:r,value:o,styleSpec:e.a6,style:{glyphs:!0,sprite:!0}})))return;l.setLayoutProperty(r,o),0!==l.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(l.fqid),l.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(l.fqid),this._updateLayer(l)}}setLayerProperty(e,t,r,o={}){this._checkLoaded();const s=this._checkLayer(e);s&&("appearances"===t?(s.setAppearances(r),this._changes.setDirty()):s.isPaintProperty(t)?this.setPaintProperty(e,t,r,o):this.setLayoutProperty(e,t,r,o))}getLayoutProperty(e,t){const r=this._checkLayer(e);if(r)return r.getLayoutProperty(t)}setPaintProperty(t,r,o,s={}){this._checkLoaded();const l=this._checkLayer(t);if(!l)return;if(e.by(l.getPaintProperty(r),o))return;if(null!=o&&(!s||!1!==s.validate)&&gn(l,Qe.call(Ue,{key:`layers.${t}.paint.${r}`,layerType:l.type,objectKey:r,value:o,styleSpec:e.a6})))return;const c=l.setPaintProperty(r,o);0!==l.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(l.fqid),l.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(l.fqid),c&&this._updateLayer(l),this._changes.updatePaintProperties(l)}getPaintProperty(e,t){const r=this._checkLayer(e);if(r)return r.getPaintProperty(t)}setFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:e,importId:o}=t.target,s=this.getFragmentStyle(o),l=s.getFeaturesetLayers(e);for(const{source:e,sourceLayer:o}of l)s.setFeatureState({id:t.id,source:e,sourceLayer:o},r)}else if("layerId"in t.target){const{layerId:e}=t.target,o=this.getLayer(e);this.setFeatureState({id:t.id,source:o.source,sourceLayer:o.sourceLayer},r)}return}const o=t.source,s=t.sourceLayer,l=this._checkSource(o);if(!l)return;const c=l.type;if("geojson"===c&&s)return void this.fire(new e.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===c&&!s)return void this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new e.y(new Error("The feature id parameter must be provided.")));const h=this.getOwnSourceCaches(o);for(const e of h)e.setFeatureState(s,t.id,r)}removeFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:e,importId:o}=t.target,s=this.getFragmentStyle(o),l=s.getFeaturesetLayers(e);for(const{source:e,sourceLayer:o}of l)s.removeFeatureState({id:t.id,source:e,sourceLayer:o},r)}else if("layerId"in t.target){const{layerId:e}=t.target,o=this.getLayer(e);this.removeFeatureState({id:t.id,source:o.source,sourceLayer:o.sourceLayer},r)}return}const o=t.source,s=this._checkSource(o);if(!s)return;const l=s.type,c="vector"===l?t.sourceLayer:void 0;if("vector"===l&&!c)return void this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(r&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new e.y(new Error("A feature id is required to remove its specific state property.")));const h=this.getOwnSourceCaches(o);for(const e of h)e.removeFeatureState(c,t.id,r)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let r;if("featuresetId"in t.target){const{featuresetId:o,importId:s}=t.target,l=this.getFragmentStyle(s),c=l.getFeaturesetLayers(o);for(const{source:o,sourceLayer:s}of c){const c=l.getFeatureState({id:t.id,source:o,sourceLayer:s});if(c&&!r)r=c;else if(!e.by(r,c))return void this.fire(new e.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:e}=t.target,o=this.getLayer(e);r=this.getFeatureState({id:t.id,source:o.source,sourceLayer:o.sourceLayer})}return r}const r=t.source,o=t.sourceLayer,s=this._checkSource(r);if(s){if("vector"!==s.type||o)return void 0===t.id&&this.fire(new e.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(r)[0].getFeatureState(o,t.id);this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(e){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,e),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),r=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return e.dv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,featuresets:this.stylesheet.featuresets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:r,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,indoor:this.stylesheet.indoor,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(e=>void 0!==e))}_updateFilteredLayers(e){for(const t of Object.values(this._mergedLayers))e(t)&&this._updateLayer(t)}_updateLayer(t){this._changes.updateLayer(t);const r=this.getLayerSourceCache(t),o=e.B(t.source,t.scope),s=this._changes.getUpdatedSourceCaches();t.source&&!s[o]&&r&&"raster"!==r.getSource().type&&(this._changes.updateSourceCache(o,"reload"),r.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(e){const t=e=>this._mergedLayers[e].is3D(!!this.terrain),r=this.order,o={},s=[];for(let l=r.length-1;l>=0;l--){const c=r[l];if(t(c)){o[c]=l;for(const t of e){const e=t[c];if(e)for(const t of e)s.push(t)}}}s.sort(((e,t)=>t.intersectionZ-e.intersectionZ));const l=[];for(let c=r.length-1;c>=0;c--){const h=r[c];if(t(h))for(let e=s.length-1;e>=0;e--){const t=s[e].feature;if(t.layer&&o[t.layer.id]<c)break;l.push(t),s.pop()}else for(const t of e){const e=t[h];if(e)for(const t of e)l.push(t.feature)}}return l}queryRasterValue(t,r,o){const s=this.getOwnSource(t);return s?"raster-array"!==s.type?(this.fire(new e.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):s.queryRasterArrayValue(r,o):(this.fire(new e.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,r,o){let s;r&&!Array.isArray(r)&&r.filter&&(this._validate(Je,"queryRenderedFeatures.filter",r.filter,null,r),s=e.b6(r.filter));const l={},c=e=>{if(vn.has(e.type))return;const t=this.getOwnLayerSourceCache(e),r=l[t.id]=l[t.id]||{sourceCache:t,layers:{},has3DLayers:!1};e.is3D(!!this.terrain)&&(r.has3DLayers=!0),r.layers[e.fqid]=r.layers[e.fqid]||{styleLayer:e,targets:[]},r.layers[e.fqid].targets.push({filter:s})};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new e.y(new Error("parameters.layers must be an Array."))),[];for(const t of r.layers){const r=this._layers[t];if(!r)return this.fire(new e.y(new Error(`The layer '${t}' does not exist in the map's style and cannot be queried for features.`))),[];c(r)}}else for(const e in this._layers)c(this._layers[e]);const h=this._queryRenderedFeatures(t,l,o),u=this._flattenAndSortRenderedFeatures(h),d=[];for(const t of u)e.dw(t.layer.id)===this.scope&&d.push(t);return d}queryRenderedFeatureset(t,r,o){let s;r&&!Array.isArray(r)&&r.filter&&(this._validate(Je,"queryRenderedFeatures.filter",r.filter,null,r),s=e.b6(r.filter));const l="mock",c=[];if(r&&r.target)c.push(Object.assign({},r,{targetId:l,filter:s}));else{const e=this.getFeaturesetDescriptors();for(const t of e)c.push({targetId:l,filter:s,target:t});for(const{style:e}of this.fragments){const t=e.getFeaturesetDescriptors();for(const e of t)c.push({targetId:l,filter:s,target:e})}}const h=this.queryRenderedTargets(t,c,o),u=[],d=new Set;for(const t of h)for(const r of t.variants[l])jt(r,t,d)||u.push(new e.dx(t,r));return u}queryRenderedTargets(t,r,o){const s={},l=(e,t,r,o)=>{const l=s[t.id]=s[t.id]||{sourceCache:t,layers:{},has3DLayers:!1};if(l.layers[e.fqid]=l.layers[e.fqid]||{styleLayer:e,targets:[]},e.is3D(!!this.terrain)&&(l.has3DLayers=!0),!o)return r.uniqueFeatureID=!1,void l.layers[e.fqid].targets.push(r);l.layers[e.fqid].targets.push(Object.assign({},r,{namespace:o.namespace,properties:o.properties,uniqueFeatureID:o.uniqueFeatureID}))};for(const t of r)if("featuresetId"in t.target){const{featuresetId:r,importId:o}=t.target,s=this.getFragmentStyle(o);if(!s||!s._featuresetSelectors)continue;const c=s._featuresetSelectors[r];if(!c){this.fire(new e.y(new Error(`The featureset '${r}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const e of c){const r=s.getOwnLayer(e.layerId);r&&!vn.has(r.type)&&l(r,s.getOwnLayerSourceCache(r),t,e)}}else if("layerId"in t.target){const{layerId:e}=t.target,r=this.getLayer(e);if(!r||vn.has(r.type))continue;l(r,this.getLayerSourceCache(r),t)}const c=this._queryRenderedFeatures(t,s,o);return this._flattenAndSortRenderedFeatures(c)}_queryRenderedFeatures(e,t,r){const o=[],s=!!this.map._showQueryGeometry,l=st.createFromScreenPoints(e,r);for(const e in t){const c=Gt(l,t[e],this._availableImages,r,s,this.getActualScope());Object.keys(c).length&&o.push(c)}if(this.placement)for(const e in t){if(!t[e].sourceCache._onlySymbols)continue;const r=$t(l.screenGeometry,t[e],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(r).length&&o.push(r)}return o}querySourceFeatures(e,t){const r=t&&t.filter;r&&this._validate(Je,"querySourceFeatures.filter",r,null,t);let o=[];const s=this.getOwnSourceCaches(e);for(const e of s)o=o.concat(qt(e,t));return o}addSourceType(e,t,r){return Oo.getSourceType(e)?r(new Error(`A source type called "${e}" already exists.`)):(Oo.setSourceType(e,t),t.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:t.workerSourceURL},r):r(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,r,o={}){this._checkLoaded();const s=this.light.getLight();let l=!1;for(const r in t)if(!e.by(t[r],s[r])){l=!0;break}if(!l)return;const c=this._getTransitionParameters();this.light.setLight(t,r,o),this.light.updateTransitions(c)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=e.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&e.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,r=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===r&&delete this.terrain,null===t?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let o=t;const s=!("source"in t)||null==t.source;if(1===r){if(this.disableElevatedTerrain)return;if("source"in o&&"object"==typeof o.source){const t="terrain-dem-src";this.addSource(t,o.source),o=e.dp(o),o=Object.assign(o,{source:t})}const t=Object.assign({},o),r={};if(this.terrain&&s){t.source=this.terrain.get().source;const e=this.terrain?this.getFragmentStyle(this.terrain.scope):null;e&&(r.style=e.serialize())}if(this._validate(He,"terrain",t,r))return}if(!this.terrain||this.terrain.scope!==this.scope&&!s||this.terrain&&r!==this.terrain.drapeRenderMode){if(!o)return;this._createTerrain(o,r),this.fire(new e.z("data",{dataType:"style"}))}else{const r=this.terrain,s=r.get();for(const t of Object.keys(e.a6.terrain))!o.hasOwnProperty(t)&&e.a6.terrain[t].default&&(o[t]=e.a6.terrain[t].default);for(const o in t)if(!e.by(t[o],s[o])){r.set(t,this.options),this.stylesheet.terrain=t;const o=this._getTransitionParameters({duration:0});r.updateTransitions(o),this.fire(new e.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){const t=this.fog=new $e(e,this.map.transform,this.scope,this.options);this.stylesheet.fog=t.get();const r=this._getTransitionParameters({duration:0});t.updateTransitions(r)}_createSnow(e){const t=this.snow=new wt(e,this.map.transform,this.scope,this.options);this.stylesheet.snow=t.get();const r=this._getTransitionParameters({duration:0});t.updateTransitions(r)}_createRain(e){const t=this.rain=new Tt(e,this.map.transform,this.scope,this.options);this.stylesheet.rain=t.get();const r=this._getTransitionParameters({duration:0});t.updateTransitions(r)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const e of this.map._markers)e._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const r=this.fog;if(!e.by(r.get(),t)){r.set(t,this.options),this.stylesheet.fog=r.get();const e=this._getTransitionParameters({duration:0});r.updateTransitions(e)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const r=this.snow;if(!e.by(r.get(),t)){r.set(t,this.options),this.stylesheet.snow=r.get();const e=this._getTransitionParameters({duration:0});r.updateTransitions(e)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const r=this.rain;if(!e.by(r.get(),t)){r.set(t,this.options),this.stylesheet.rain=r.get();const e=this._getTransitionParameters({duration:0});r.updateTransitions(e)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const e in this._layers)this._layers[e].lut=this._styleColorTheme.lut;for(const e in this._sourceCaches)this._sourceCaches[e].clearTiles()},r=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!r)return this._styleColorTheme.lut=null,void t();const o=this._evaluateColorThemeData(r);this._loadColorTheme(o).then((()=>{this.fire(new e.z("colorthemeset")),t()})).catch((t=>{e.w(`Couldn't set color theme: ${t}`)}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&e.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(e,t){const r=this.getFragmentStyle(e);r&&(r._styleColorTheme.colorThemeOverride=t,r._reloadColorTheme())}_getTransitionParameters(t){return{now:e.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const e=[],t=[];for(const r of this._mergedOrder)this.isLayerDraped(this._mergedLayers[r])?e.push(r):t.push(r);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...t)}_createTerrain(e,t){const r=this.terrain=new lt(e,t,this.scope,this.options,this.map.getWorldview());1===t&&(this.stylesheet.terrain=e),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const o=this._getTransitionParameters({duration:0});r.updateTransitions(o)}_force3DLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"fill-extrusion"===t.type&&this._updateLayer(t)}}_forceSymbolLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"symbol"===t.type&&this._updateLayer(t)}}_validate(t,r,o,s,l={}){if(l&&!1===l.validate)return!1;const c=Object.assign({},this.serialize());return gn(this,t.call(Ue,Object.assign({key:r,style:c,value:o,styleSpec:e.a6},s)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),e.dy.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._mergedLayers)this._mergedLayers[e].setEventedParent(null);for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles(),this._mergedSourceCaches[e].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.indoorManager.destroy(),this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(e){const t=this.getSourceCaches(e);for(const e of t)e.clearTiles()}clearSources(){for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles()}clearLayers(){for(const e in this._mergedLayers){const t=this._mergedLayers[e];t._clear&&t._clear()}}reloadSource(e){const t=this.getSourceCaches(e);for(const e of t)e.resume(),e.reload()}reloadSources(){for(const e of this.getSources())e.reload&&e.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((e=>{e.modelManager.reloadModels(e.scope)}))}updateSources(e){let t;this.directionalLight&&(t=cn(this.directionalLight));const r=new Set,o=new Set;for(const e in this._mergedLayers){const t=this._mergedLayers[e];"building"===t.type&&r.add(t.source),t.hasElevation()&&!o.has(t.source)&&o.add(t.source)}for(const s in this._mergedSourceCaches){const l=this._mergedSourceCaches[s],c=o.has(l._source.id);r.has(l._source.id)&&(l._source.reparseOverscaled=!1),l.update(e,void 0,void 0,t,c)}}_generateCollisionBoxes(){for(const e in this._sourceCaches){const t=this._sourceCaches[e];t.resume(),t.reload()}}_handleLayerOrderChange(){this._requestFullLabelPlacement(),this.fire(new e.z("neworder"))}_requestFullLabelPlacement(){this.pauseablePlacement||(this.pauseablePlacement=new Ui),this.pauseablePlacement.requestFullPlacement()}_setLabelPlacementStale(){this.placement&&this.placement.setStale()}_updatePlacement(t,r,o,s,l){this.pauseablePlacement||(this.pauseablePlacement=new Ui);let c=!1,h=!1;const u={},d={};for(const r of this._mergedOrder){const o=this._mergedLayers[r];if("symbol"!==o.type)continue;const s=e.B(o.source,o.scope);let l=u[s];if(!l){const e=this.getLayerSourceCache(o);if(!e)continue;const t=e.getRenderableIds(!0).map((t=>e.getTileByID(t)));d[s]=t.slice(),l=u[s]=t.sort(((e,t)=>t.tileID.overscaledZ-e.tileID.overscaledZ||(e.tileID.isLessThan(t.tileID)?-1:1)))}const h=this.crossTileSymbolIndex.addLayer(o,l,t.center.lng,t.projection);c=c||h}this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder);const p=Boolean(this.placement&&!t.equals(this.placement.transform)),f=Boolean(this.placement&&(0!==this.placement.lastReplacementSourceUpdateTime&&!l||this.placement.lastReplacementSourceUpdateTime!==l.updateTime)),m=p||f||c,_=(m||this.pauseablePlacement.isStale())&&0===o,v=this.pauseablePlacement.isDone()&&!this.placement.stillRecent(e.o.now(),t.zoom)&&0!==o;if((this.pauseablePlacement.isFullPlacementRequested()||!this.pauseablePlacement.placement||_||v)&&(this.pauseablePlacement=this.pauseablePlacement.startNewPlacement(t,this._mergedOrder,r,o,s,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null,this._buildingIndex)),this.pauseablePlacement.isDone()?m&&0!==o&&this.pauseablePlacement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,u,d,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(e.o.now()),h=!0),c&&this.pauseablePlacement.setStale()),h||c){this._buildingIndex.onNewFrame(t.zoom);for(let t=0;t<this._mergedOrder.length;t++){const r=this._mergedLayers[this._mergedOrder[t]];if("symbol"!==r.type)continue;if("none"===r.visibility)continue;const o=this.isLayerClipped(r);this.placement.updateLayerOpacities(r,u[e.B(r.source,r.scope)],t,o?l:null)}}return!this.pauseablePlacement.isDone()||this.placement.isStale()||this.placement.hasTransitions(e.o.now())}_releaseSymbolFadeTiles(){for(const e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles()}addImport(t,r){this._checkLoaded();const o=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==o.findIndex((({id:e})=>e===t.id)))return void this.fire(new e.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!r)return o.push(t),this._loadImports([t],!0);const s=o.findIndex((({id:e})=>e===r));return-1===s&&this.fire(new e.y(new Error(`Import with id "${r}" does not exist on this map.`))),this.stylesheet.imports=o.slice(0,s).concat(t).concat(o.slice(s)),this._loadImports([t],!0,r)}updateImport(t,r){this._checkLoaded();const o=this.stylesheet.imports||[],s=this.getImportIndex(t);return-1===s?this:"string"==typeof r?(this.setImportUrl(t,r),this):(r.url&&r.url!==o[s].url&&this.setImportUrl(t,r.url),e.by(r.config,o[s].config)||this.setImportConfig(t,r.config,r.data.schema),e.by(r.data,o[s].data)||this.setImportData(t,r.data),this)}moveImport(e,t){this._checkLoaded();let r=this.stylesheet.imports||[];const o=this.getImportIndex(e);if(-1===o)return this;const s=this.getImportIndex(t);if(-1===s)return this;const l=r[o],c=this.fragments[o];return r=r.filter((({id:t})=>t!==e)),this.fragments=this.fragments.filter((({id:t})=>t!==e)),this.stylesheet.imports=r.slice(0,s).concat(l).concat(r.slice(s)),this.fragments=this.fragments.slice(0,s).concat(c).concat(this.fragments.slice(s)),this.mergeLayers(),this}setImportUrl(e,t){this._checkLoaded();const r=this.stylesheet.imports||[],o=this.getImportIndex(e);if(-1===o)return this;r[o].url=t;const s=this.fragments[o];return s.style=this._createFragmentStyle(r[o]),s.style.on("style.import.load",(()=>this.mergeAll())),s.style.loadURL(t),this}setImportData(e,t){this._checkLoaded();const r=this.getImportIndex(e),o=this.stylesheet.imports||[];return-1===r?this:t?(this.fragments[r].style.setState(t),this._reloadImports(),this):(delete o[r].data,this.setImportUrl(e,o[r].url))}setImportConfig(e,t,r){this._checkLoaded();const o=this.getImportIndex(e),s=this.stylesheet.imports||[];if(-1===o)return this;t?s[o].config=t:delete s[o].config;const l=this.fragments[o];r&&l.style.stylesheet&&(l.style.stylesheet.schema=r);const c=l.style.stylesheet&&l.style.stylesheet.schema;return l.config=t,l.style.updateConfig(t,c),this.updateConfigDependencies(),this}removeImport(e){this._checkLoaded();const t=this.stylesheet.imports||[],r=this.getImportIndex(e);-1!==r&&(t.splice(r,1),this.fragments[r].style._remove(),this.fragments.splice(r,1),this._reloadImports())}getImportIndex(t){const r=(this.stylesheet.imports||[]).findIndex((e=>e.id===t));return-1===r&&this.fire(new e.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),r}getLayer(e){return this._mergedLayers[e]}getSources(){const e=[];for(const t in this._mergedOtherSourceCaches){const r=this._mergedOtherSourceCaches[t];r&&e.push(r.getSource())}return e}getSource(e,t){const r=this.getSourceCache(e,t);return r&&r.getSource()}getLayerSource(e){const t=this.getLayerSourceCache(e);return t&&t.getSource()}getSourceCache(t,r){const o=e.B(t,r);return this._mergedOtherSourceCaches[o]}getLayerSourceCache(t){const r=e.B(t.source,t.scope);return"symbol"===t.type?this._mergedSymbolSourceCaches[r]:this._mergedOtherSourceCaches[r]}getSourceCaches(e){if(null==e)return Object.values(this._mergedSourceCaches);const t=[];return this._mergedOtherSourceCaches[e]&&t.push(this._mergedOtherSourceCaches[e]),this._mergedSymbolSourceCaches[e]&&t.push(this._mergedSymbolSourceCaches[e]),t}updateSourceCaches(){const e=this._changes.getUpdatedSourceCaches();for(const t in e){const r=e[t];"reload"===r?this.reloadSource(t):"clear"===r&&this.clearSource(t)}}updateLayers(e){const t=this._changes.getUpdatedPaintProperties();for(const r of t){const t=this.getLayer(r);t&&t.updateTransitions(e)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(e){this.stylesheet.glyphs=e,this.glyphManager.setURL(e)}getImages(t,r,o){this.imageManager.getImages(r.images,r.scope,o),this._updateTilesForChangedImages();const s=t=>{if(t){const o=r.images.map((t=>e.I.toString(t)));t.setDependencies(r.tileID.key,r.type,o)}},l=e.B(r.source,r.scope);s(this._mergedOtherSourceCaches[l]),s(this._mergedSymbolSourceCaches[l]),r.images.some((e=>e.iconsetId))&&this.fire(new e.z("data",{dataType:"style"}))}rasterizeImages(e,t,r){this.imageManager.rasterizeImages(t,r)}getGlyphs(e,t,r){this.glyphManager.getGlyphs(t.stacks,r)}getResource(t,r,o){return e.dz(r,o)}getOwnSourceCache(e){return this._otherSourceCaches[e]}getOwnLayerSourceCache(e){return"symbol"===e.type?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source]}getOwnSourceCaches(e){const t=[];return this._otherSourceCaches[e]&&t.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&t.push(this._symbolSourceCaches[e]),t}_isSourceCacheLoaded(t){const r=this.getOwnSourceCaches(t);return 0===r.length?(this.fire(new e.y(new Error(`There is no source with ID '${t}'`))),!1):r.every((e=>e.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(e,t){if(!this._clipLayerPresent&&"fill-extrusion"!==e.type&&"building"!==e.type)return!1;const r="fill-extrusion"===e.type&&("building"===e.sourceLayer||"procedural_buildings"===e.sourceLayer),o="building"===e.type;if(e.is3D(!!this.terrain)){if(r||o||t&&"batched-model"===t.type)return!0;if("model"===e.type)return!0}else if("symbol"===e.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((e=>{e.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Oo.getSourceType=function(e){return kt[e]},Oo.setSourceType=function(e,t){kt[e]=t},Oo.registerForPluginStateChange=e.dA;var Tn="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Sn="\n#ifdef DUAL_SOURCE_BLENDING\nlayout(location=0,index=0) out vec4 glFragColor;layout(location=0,index=1) out vec4 glFragColorSrc1;\n#else\nlayout(location=0) out vec4 glFragColor;\n#endif\n#ifdef USE_MRT1\nlayout(location=1) out vec4 out_Target1;\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",En="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib\n#define DECLARE_MATERIAL_TABLE_INFO\n#endif",An="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Mn="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nint NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nhighp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif",Pn="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Cn="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",zn="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Dn="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Ln="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif",On="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Fn=/#include\s+"([^"]+)"/g,Bn=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,kn=/\b[A-Za-z_][A-Za-z0-9_]*\b/g,Un=new Set(["ifdef","ifndef","elif","if","defined"]),jn=new Set;co(Tn,jn),co(En,jn),co(Sn,jn);const Gn={"_prelude_fog.vertex.glsl":Pn,"_prelude_terrain.vertex.glsl":Mn,"_prelude_shadow.vertex.glsl":Ln,"_prelude_material_table.vertex.glsl":"#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define MATERIAL_TABLE_DEBUG 0\nuniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;\n#if MATERIAL_TABLE_DEBUG\nvec4 colorDebug;\n#endif\n};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { \nif (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; \n}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { \niRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;\n#if MATERIAL_TABLE_DEBUG\nconst vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;\n#endif\nuint offset=0u;\n#if MATERIAL_TABLE_DEBUG\nbool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}\n#endif\noffset++;\n#if MATERIAL_TABLE_DEBUG\nuint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}\n#endif\noffset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}\n#endif\nuint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding)\n{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}\n#endif\noffset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}\n#endif\ninfo.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)\n{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)\n#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));\n#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;\n#endif","_prelude_fog.fragment.glsl":Cn,"_prelude_shadow.fragment.glsl":On,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif","_prelude_raster_array.glsl":zn,"_prelude_raster_particle.glsl":Dn},Hn={};ho("",Mn),ho(Cn,Pn),ho(On,Ln),ho(zn,""),ho(Dn,"");const Zn=ho(Sn,En),Yn=Tn,Jn=["\n#if defined(GL_EXT_blend_func_extended) && defined(DUAL_SOURCE_BLENDING)\n#extension GL_EXT_blend_func_extended : require\n#endif","precision mediump float;",Yn,Zn.fragmentSource].join("\n"),Qn=["precision highp float;",Yn,Zn.vertexSource].join("\n");var Kn={background:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;uniform mediump float u_emissive_strength;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform mediump float u_emissive_strength;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\n#ifdef FLOOD_LIGHT\nin highp float v_flood_radius;in float v_has_flood_light;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\n#else\nshadowed_lighting_factor=dot(xy_flipped_normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);\n#ifdef FLOOD_LIGHT\nfloat flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);\n#endif\ncolor.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#ifdef FLOOD_LIGHT\nout highp float v_flood_radius;out float v_has_flood_light;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\n#ifdef FLOOD_LIGHT\nv_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);\n#endif\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;float depth_offset=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);float height=a_centroid_3.z;depth_offset=min(1000.0,height)*0.0000002;}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);gl_Position.z-=depth_offset*gl_Position.w;}'),buildingBloom:ho("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\n#ifdef RENDER_CUTOFF\nopacity*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}"),buildingDepth:ho("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:ho("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ho('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:ho("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ho("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:ho("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ho("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:ho("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:ho("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#else\n#ifdef FEATURE_CUTOUT\napply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);\n#endif\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:ho("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:ho('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:ho("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\n#ifdef USE_MRT1\nout_Target1=vec4(1.0-texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size)).a,0.0,0.0,0.0);\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:ho("precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform highp vec2 u_trim_gradient_mix_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef VARIABLE_LINE_WIDTH\nin float stub_side;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float side_z_offset\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\n#pragma mapbox: define lowp float emissive_strength\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float side_z_offset\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\n#pragma mapbox: initialize lowp float emissive_strength\nfloat dist=length(v_normal)*v_width2.s;\n#ifdef VARIABLE_LINE_WIDTH\nblur=mix(blur,0.0,stub_side);\n#endif\nfloat blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef VARIABLE_LINE_WIDTH\nalpha=mix(alpha,1.0,stub_side);\n#endif\nalpha=side_z_offset > 0.0 ? 1.0-alpha : alpha;\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);highp float gradient_trim_color_mix_factor=0.0;\n#ifdef RENDER_LINE_GRADIENT\ngradient_trim_color_mix_factor=smoothstep(u_trim_gradient_mix_range.x,u_trim_gradient_mix_range.y,line_progress);\n#endif\nhighp vec4 trim_color=mix(u_trim_color,out_color,gradient_trim_color_mix_factor);out_color=mix(u_trim_gradient_mix_range.x < 1.0 ? color : out_color,trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\n#ifndef VARIABLE_LINE_WIDTH\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef DUAL_SOURCE_BLENDING\nglFragColorSrc1=vec4(vec3(0.0),emissive_strength);\n#else\n#ifdef USE_MRT1\nout_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef VARIABLE_LINE_WIDTH\nout float stub_side;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float side_z_offset\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float side_z_offset\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\n#pragma mapbox: initialize lowp float emissive_strength\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;offset=-1.0*offset*u_width_scale;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nbool left=normal.y==1.0;float left_width=a_z_offset_width.y;float right_width=a_z_offset_width.z;halfwidth=(u_width_scale*(left ? left_width : right_width))/2.0;a_z_offset+=left ? side_z_offset : 0.0;v_normal=side_z_offset > 0.0 && left ? vec2(0.0) : v_normal;offset=border_width > 0.0 ? (left_width+right_width)*u_width_scale*0.5 : offset;halfwidth=border_width > 0.0 ? border_width*u_width_scale*0.5 : halfwidth;bool zero_right_width=border_width==0.0 && right_width==0.0;stub_side=zero_right_width ?-normal.y : 0.0;v_normal=!left && zero_right_width ? vec2(0.0) : v_normal;ANTIALIASING=!left && zero_right_width ? 0.0 : ANTIALIASING;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\nfloat inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef DUAL_SOURCE_BLENDING\nglFragColorSrc1=vec4(vec3(0.0),emissive_strength);\n#else\n#ifdef USE_MRT1\nout_Target1=vec4(emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize lowp float emissive_strength\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n#ifdef USE_MRT1\nout_Target1=vec4(u_emissive_strength*glFragColor.a,0.0,0.0,glFragColor.a);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:ho("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:ho("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:ho('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:ho('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#define USING_APPEARANCE 1.0\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance==USING_APPEARANCE) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\n#ifdef Z_TEST_OCCLUSION\nout_fade_opacity*=occlusion_opacity;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nuniform sampler2D u_image1;uniform float u_emissive_texture_available;\n#endif\nin vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nfloat emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;vec3 unlit_base=image_color.rgb*(1.0-emissive_strength);vec3 emissive_base=image_color.rgb*emissive_strength;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nfloat emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : image_color.a;color.rgb=mix(color.rgb,image_color.rgb,emissive_strength);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:ho("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:ho('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',An),skyboxGradient:ho('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',An),skyboxCapture:ho("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nuniform sampler2D u_image1;uniform float u_emissive_texture_available;\n#endif\nuniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nfloat emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : raster.a;raster=apply_lighting_with_emission_ground(raster,emissive_strength);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nfloat emissive_strength=u_emissive_texture_available > 0.5 ? texture(u_image1,v_pos0).r : color.a;color=apply_lighting_with_emission_ground(color,emissive_strength);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:ho('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:ho('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;\n#ifdef DITHERED_DISCARD\nuniform float u_dithered_discard_threshold;\n#endif\nuniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef FLIP_Y\ncoord.y=1.0-coord.y;\n#endif\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef DITHERED_DISCARD\nif (abs(u_dithered_discard_threshold) < 1.0) {float ditherValue=fract(52.9829189*fract(0.06711056*gl_FragCoord.x+0.00583715*gl_FragCoord.y));float compareValue=mix(1.0-ditherValue,ditherValue,step(0.0,u_dithered_discard_threshold));if (abs(u_dithered_discard_threshold) < compareValue) {discard;}}\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#ifdef CLIP_ZERO_TO_ONE\nv_depth=-1.0+2.0*v_depth; \n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:ho("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:ho("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:ho("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:ho("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:ho("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:ho("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function co(e,t){const r=e.split("\n");for(let e of r){if(e=e.trimStart(),"#"!==e[0])continue;if(!e.includes("if"))continue;if(e.startsWith("#endif"))continue;const r=e.match(kn);if(r)for(const e of r)Un.has(e)||t.add(e)}}function ho(e,t){const r=new Set,o=[],s=[];e=e.replace(Fn,((e,t)=>(s.push(t),""))),t=t.replace(Fn,((e,t)=>(o.push(t),"")));let l=new Set(jn);co(e,l),co(t,l);for(const e of[...o,...s])Hn[e]||(Hn[e]=new Set,co(Gn[e],Hn[e])),l=new Set([...l,...Hn[e]]);return{fragmentSource:e=e.replace(Bn,((e,t,o,s,l)=>(r.add(l),"define"===t?`\n#ifndef HAS_UNIFORM_u_${l}\nin ${o} ${s} ${l};\n#else\nuniform ${o} ${s} u_${l};\n#endif\n`:"initialize"===t?`\n#ifdef HAS_UNIFORM_u_${l}\n    ${o} ${s} ${l} = u_${l};\n#endif\n`:"define-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${l}\n    in ${o} ${s} ${l};\n#endif\n`:"initialize-attribute"===t?"":void 0))),vertexSource:t=t.replace(Bn,((e,t,o,s,l)=>{const c=`MATERIAL_ATTRIBUTE_OFFSET_${l}`,h="float"===s?"vec2":s,u=`GET_ATTRIBUTE_${h}(a_${l}, materialInfo, ${c})`,d=l.match(/color/)?"color":h;return"define-attribute-vertex-shader-only"===t?`\n#ifdef HAS_ATTRIBUTE_a_${l}\nin ${o} ${s} a_${l};\n#endif\n`:r.has(l)?"define"===t?`\n#ifndef HAS_UNIFORM_u_${l}\nuniform lowp float u_${l}_t;\n    #if !defined(${c})\n        in ${o} ${h} a_${l};\n    #endif\nout ${o} ${s} ${l};\n#else\nuniform ${o} ${s} u_${l};\n#endif\n`:"initialize"===t?"vec4"===d?`\n#ifndef HAS_UNIFORM_u_${l}\n    ${l} = a_${l};\n#else\n    ${o} ${s} ${l} = u_${l};\n#endif\n`:`\n#if !defined(HAS_UNIFORM_u_${l})\n    #ifdef ${c}\n        ${l} = unpack_mix_${d}(${u}, u_${l}_t);\n    #else\n        ${l} = unpack_mix_${d}(a_${l}, u_${l}_t);\n    #endif\n#else\n    ${o} ${s} ${l} = u_${l};\n#endif\n`:"define-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${l}\n    in ${o} ${s} a_${l};\n    out ${o} ${s} ${l};\n#endif\n`:"initialize-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${l}\n    ${l} = a_${l};\n#endif\n`:void 0:"define"===t?`\n#ifndef HAS_UNIFORM_u_${l}\nuniform lowp float u_${l}_t;\n    #if !defined(${c})\n        in ${o} ${h} a_${l};\n    #endif\n#else\nuniform ${o} ${s} u_${l};\n#endif\n`:"define-instanced"===t?"mat4"===d?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${l}0;\nin vec4 a_${l}1;\nin vec4 a_${l}2;\nin vec4 a_${l}3;\n#else\nuniform ${o} ${s} u_${l};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${o} ${h} a_${l};\n#else\nuniform ${o} ${s} u_${l};\n#endif\n`:"initialize-attribute-custom"===t?`\n#ifdef HAS_ATTRIBUTE_a_${l}\n    ${o} ${s} ${l} = a_${l};\n#endif\n`:"vec4"===d?`\n#ifndef HAS_UNIFORM_u_${l}\n    #ifdef ${c}\n        ${o} ${s} ${l} = ${u};\n    #else\n        ${o} ${s} ${l} = a_${l};\n    #endif\n#else\n    ${o} ${s} ${l} = u_${l};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${l}\n    #ifdef ${c}\n        ${o} ${s} ${l} = unpack_mix_${d}(${u}, u_${l}_t);\n    #else\n        ${o} ${s} ${l} = unpack_mix_${d}(a_${l}, u_${l}_t);\n    #endif\n#else\n    ${o} ${s} ${l} = u_${l};\n#endif\n`})),usedDefines:l,vertexIncludes:o,fragmentIncludes:s}}class rs{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(e,t,r,o,s,l,c,h){this.context=e;let u=this.boundPaintVertexBuffers.length!==o.length;for(let e=0;!u&&e<o.length;e++)this.boundPaintVertexBuffers[e]!==o[e]&&(u=!0);let d=this.boundDynamicVertexBuffers.length!==c.length;for(let e=0;!d&&e<c.length;e++)this.boundDynamicVertexBuffers[e]!==c[e]&&(d=!0);if(!this.vao||this.boundProgram!==t||this.boundLayoutVertexBuffer!==r||u||d||this.boundIndexBuffer!==s||this.boundVertexOffset!==l)this.freshBind(t,r,o,s,l,c,h);else{e.bindVertexArrayOES.set(this.vao);for(const r of c)r&&(r.bind(),h&&r.instanceCount&&r.setVertexAttribDivisor(e.gl,t,h));s&&s.dynamicDraw&&s.bind()}}freshBind(e,t,r,o,s,l,c){const h=this.context,u=h.gl;this.vao&&this.destroy(),this.vao=h.gl.createVertexArray(),h.bindVertexArrayOES.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=t,this.boundPaintVertexBuffers=r,this.boundIndexBuffer=o,this.boundVertexOffset=s,this.boundDynamicVertexBuffers=l,t.enableAttributes(u,e),t.bind(),t.setVertexAttribPointers(u,e,s);for(const t of r)t.enableAttributes(u,e),t.bind(),t.setVertexAttribPointers(u,e,s);for(const t of l)t&&(t.enableAttributes(u,e),t.bind(),t.setVertexAttribPointers(u,e,s),c&&t.instanceCount&&t.setVertexAttribDivisor(u,e,c));o&&o.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function fo(t,r){const o=Math.pow(2,r.canonical.z),s=r.canonical.y;return[new e.ae(0,s/o).toLngLat().lat,new e.ae(0,(s+1)/o).toLngLat().lat]}function mo(t,r,o,s,l,c,h){const u=t.context,d=u.gl,p=o.hillshadeFBO;if(!p)return;t.prepareDrawTile();const f=t.isTileAffectedByFog(r),m=[];t.terrain&&t.terrain.renderingToTexture&&"mrt-fallback"===t.emissiveMode&&m.push("USE_MRT1");const _=t.getOrCreateProgram("hillshade",{overrideFog:f,defines:m});u.activeTexture.set(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,p.colorAttachment0.get());const v=((t,r,o,s)=>{const l=o.paint.get("hillshade-shadow-color"),c="none"===o.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),h=o.paint.get("hillshade-highlight-color"),u="none"===o.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),d=o.paint.get("hillshade-accent-color"),p="none"===o.paint.get("hillshade-accent-color-use-theme").constantOr("default"),f=o.paint.get("hillshade-emissive-strength");let m=e.an(o.paint.get("hillshade-illumination-direction"));if("viewport"===o.paint.get("hillshade-illumination-anchor"))m-=t.transform.angle;else if(t.style&&t.style.enable3dLights()&&t.style.directionalLight){const r=t.style.directionalLight.properties.get("direction"),o=e.d4(r.x,r.y,r.z);m=e.an(o[1])}const _=!t.options.moving;return{u_matrix:s||t.transform.calculateProjMatrix(r.tileID.toUnwrapped(),_),u_image:0,u_latrange:fo(0,r.tileID),u_light:[o.paint.get("hillshade-exaggeration"),m],u_shadow:l.toPremultipliedRenderColor(c?null:o.lut),u_highlight:h.toPremultipliedRenderColor(u?null:o.lut),u_emissive_strength:f,u_accent:d.toPremultipliedRenderColor(p?null:o.lut)}})(t,o,s,t.terrain?r.projMatrix:null);t.uploadCommonUniforms(u,_,r.toUnwrapped());const{tileBoundsBuffer:E,tileBoundsIndexBuffer:P,tileBoundsSegments:C}=t.getTileBoundsBuffers(o);_.draw(t,d.TRIANGLES,l,c,h,Qi.disabled,v,s.id,E,P,C)}function go(t,r,o){if(!r.needsDEMTextureUpload)return;const s=t.context,l=s.gl;s.pixelStoreUnpackPremultiplyAlpha.set(!1),r.demTexture=r.demTexture||t.getTileTexture(o.stride);const c=o.getPixels();r.demTexture?r.demTexture.update(c,{premultiply:!1}):r.demTexture=new e.T(s,c,l.R32F,{premultiply:!1}),r.needsDEMTextureUpload=!1}function xo(t,r,o){const s=t.context,l=s.gl;if(!r.dem)return;const c=r.dem;if(s.activeTexture.set(l.TEXTURE1),go(t,r,c),!r.demTexture)return;r.demTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE);const h=c.dim;s.activeTexture.set(l.TEXTURE0);let u=r.hillshadeFBO;if(!u){const t=new e.T(s,{width:h,height:h,data:null},l.RGBA8);t.bind(l.LINEAR,l.CLAMP_TO_EDGE),u=r.hillshadeFBO=s.createFramebuffer(h,h,1,"renderbuffer"),u.colorAttachment0.set(t.texture)}s.bindFramebuffer.set(u.framebuffer),s.viewport.set([0,0,h,h]);const{tileBoundsBuffer:d,tileBoundsIndexBuffer:p,tileBoundsSegments:f}=t.getMercatorTileBoundsBuffers(),m=[];t.linearFloatFilteringSupported()&&m.push("TERRAIN_DEM_FLOAT_FORMAT"),t.terrain&&t.terrain.renderingToTexture&&"mrt-fallback"===t.emissiveMode&&m.push("USE_MRT1"),t.getOrCreateProgram("hillshadePrepare",{defines:m}).draw(t,l.TRIANGLES,$i.disabled,Yi.disabled,Wi.unblended,Qi.disabled,((t,r)=>{const o=r.stride,s=e.bC();return e.ce(s,0,e.al,-e.al,0,0,1),e.br(s,s,[0,-e.al,0]),{u_matrix:s,u_image:1,u_dimension:[o,o],u_zoom:t.overscaledZ}})(r.tileID,c),o.id,d,p,f),r.needsHillshadePrepare=!1}class hs{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ds extends hs{getDefault(){return e.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class us extends hs{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class _s extends hs{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class ps extends hs{getDefault(){return[!0,!0,!0,!0]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class fs extends hs{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class ms extends hs{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class gs extends hs{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const t=this.current;(e.func!==t.func||e.ref!==t.ref||e.mask!==t.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class vs extends hs{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class ys extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.current=e,this.dirty=!1}}class xs extends hs{getDefault(){return[0,1]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class bs extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.current=e,this.dirty=!1}}class ws extends hs{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class Ts extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.current=e,this.dirty=!1}}class Es extends hs{getDefault(){const e=this.gl;return[e.ONE,e.ZERO,e.ONE,e.ZERO]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.blendFuncSeparate(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Ss extends hs{getDefault(){return e.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Is extends hs{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(e,e),this.current=e,this.dirty=!1)}}class Cs extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this.current=e,this.dirty=!1}}class Rs extends hs{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class As extends hs{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}let vo=class extends hs{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class Ds extends hs{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class Ps extends hs{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Os extends hs{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class zs extends hs{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Ms extends hs{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindTexture(t.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class Fs extends hs{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Bs extends hs{getDefault(){return null}set(e){const t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class ks extends hs{getDefault(){return null}set(e){this.gl&&(e!==this.current||this.dirty)&&(this.gl.bindVertexArray(e),this.current=e,this.dirty=!1)}}class Ns extends hs{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Us extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class js extends hs{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class Vs extends hs{constructor(e,t){super(e),this.context=e,this.parent=t}getDefault(){return null}}class Gs extends Vs{constructor(e,t,r=0){super(e,t),this.attachmentPoint=e.gl.COLOR_ATTACHMENT0+r}setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,this.attachmentPoint,t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Hs extends Vs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,this.attachment(),t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class qs extends Vs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,this.attachment(),t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Zs extends Hs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const bo=(e,t,r,o)=>({u_matrix:e,u_image0:0,u_image1:1,u_skirt_height:t,u_ground_shadow_factor:r,u_emissive_texture_available:o}),wo=(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(o),u_merc_matrix:r,u_zoom_transition:s,u_merc_center:l,u_image0:0,u_image1:1,u_frustum_tl:c,u_frustum_tr:h,u_frustum_br:u,u_frustum_bl:d,u_globe_pos:p,u_globe_radius:f,u_viewport:m,u_grid_matrix:P?Float32Array.from(P):new Float32Array(9),u_skirt_height:_,u_far_z_cutoff:v,u_emissive_texture_available:E});function Ao(e,t){return null!=e&&null!=t&&!(!e.hasData()||!t.hasData())&&null!=e.demTexture&&null!=t.demTexture&&e.tileID.key!==t.tileID.key}const Mo=new class{constructor(){this.operations={}}newMorphing(e,t,r,o,s){if(e in this.operations){const t=this.operations[e];t.to.tileID.key!==r.tileID.key&&(t.queued=r)}else this.operations[e]={startTime:o,phase:0,duration:s,from:t,to:r,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const r=this.operations[t];for(r.phase=(e-r.startTime)/r.duration;r.phase>=1||!this._validOp(r);)if(!this._nextOp(r,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},Po={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ro(e,t,r){if(0===t)return 0;const o=t<1&&514===r?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*o}function zo(e,t){const r=1<<e.z;return!t&&(0===e.x||e.x===r-1)||0===e.y||e.y===r-1}function Do(e,t){if(!e.style||!e.style.enable3dLights())return;const r=e.context,o=r.gl;r.activeTexture.set(o.TEXTURE1),t?t.bind(o.LINEAR,o.CLAMP_TO_EDGE):e.emptyTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE)}const Bo=e=>({u_matrix:e});function ko(t,r,o,s,l){if(l>0){const c=e.o.now(),h=(c-t.timeAdded)/l,u=r?(c-r.timeAdded)/l:-1,d=o.getSource(),p=s.coveringZoomLevel({tileSize:d.tileSize,roundZoom:d.roundZoom}),f=!r||Math.abs(r.tileID.overscaledZ-p)>Math.abs(t.tileID.overscaledZ-p),m=f&&t.refreshedUponExpiration?1:e.aA(f?h:1-u,0,1);return r?{opacity:1,mix:1-m,isFading:h<1}:{opacity:m,mix:0,isFading:h<1}}return{opacity:1,mix:0,isFading:!1}}class or extends Ft{constructor(e){const t=Vt("mock-dem",{type:"raster-dem",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("mock-dem",t,!1),t.setEventedParent(this),this._sourceLoaded=!0}_loadTile(e,t){e.state="loaded",t(null)}}class sr extends Ft{constructor(e){const t=Vt("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("proxy",t,!1),t.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,t,r){if(e.freezeTileCoverage)return;this.transform=e;const o=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((t,r)=>{if(t[r.key]="",!this._tiles[r.key]){const t=new Pt(r,this._source.tileSize*r.overscaleFactor(),e.tileZoom,void 0,void 0,this._source.worldview);t.state="loaded",this._tiles[r.key]=t}return t}),{});for(const e in this._tiles)e in o||(this.freeFBO(e),this._tiles[e].unloadVectorData(),delete this._tiles[e])}freeFBO(e){const t=this.proxyCachedFBO[e];if(void 0!==t){const r=Object.values(t);this.renderCachePool.push(...r),delete this.proxyCachedFBO[e]}}deallocRenderCache(){this.renderCache.forEach((e=>e.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class rr extends e.aQ{constructor(e,t,r){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=t,this.projMatrix=r}}class nr extends e.bV{constructor(t,r){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[o,s,l]=function(){const t=new e.bd,r=new e.b0,o=131;t.reserve(17161),r.reserve(33800);const s=e.al/128,l=e.al+s/2,c=l+s;for(let r=-s;r<c;r+=s)for(let o=-s;o<c;o+=s){const s=o<0||o>l||r<0||r>l?24575:0,c=e.aA(Math.round(o),0,e.al),h=e.aA(Math.round(r),0,e.al);t.emplaceBack(c+s,h)}const h=(e,t)=>{const s=t*o+e;r.emplaceBack(s+1,s,s+o),r.emplaceBack(s+o,s+o+1,s+1)};for(let e=1;e<129;e++)for(let t=1;t<129;t++)h(t,e);return[0,129].forEach((e=>{for(let t=0;t<130;t++)h(t,e),h(e,t)})),[t,r,32768]}(),c=t.context;this.gridBuffer=c.createVertexBuffer(o,e.bf.members),this.gridIndexBuffer=c.createIndexBuffer(s),this.gridSegments=e.bg.simpleSegment(0,0,o.length,s.length),this.gridNoSkirtSegments=e.bg.simpleSegment(0,0,o.length,l),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new sr(r.map),this.orthoMatrix=e.bC(),e.ce(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,e.al,0,e.al,0,1);const h=c.gl;this._overlapStencilMode=new Yi({func:h.GEQUAL,mask:255},0,255,h.KEEP,h.KEEP,h.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=r,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new or(r.map),this._pendingGroundEffectLayers=[],this._emissiveTexture=!1}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),this._style=e,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,r,o){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const s=t.terrain.properties,l=0===t.terrain.drapeRenderMode,c=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=e.o.now();const h=t.terrain&&t.terrain.scope,u=s.get("source"),d=l?this._mockSourceCache:t.getSourceCache(u,h);if(!d)return void e.w(`Couldn't find terrain source "${u}".`);if(this.sourceCache=d,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=c?this.calculateExaggeration(r):s.get("exaggeration"),!r.projection.requiresDraping&&c&&0===this._exaggeration)return void this._disable();this.enabled=!0;const p=()=>{this.sourceCache.used&&e.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const t=this.getScaledDemTileSize();this.sourceCache.update(r,t,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,p(),this._initializing=!0),p(),r.updateElevation(!0,o),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(r),this._emptyDEMTextureDirty=!0,this._previousZoom=r.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const r=this._previousCameraAltitude,o=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=o;const s=null!=r?o-r:Number.MAX_VALUE;if(Math.abs(s)<2)return this._exaggeration;const l=t.zoom,c=this._style.terrain;if(!this._previousUpdateTimestamp)return c.getExaggeration(l);let h=l-this._previousZoom;const u=this._previousUpdateTimestamp;let d=l;null!=this._evaluationZoom&&(d=this._evaluationZoom,Math.abs(l-d)>.5&&(h=.5*(l-d+h)),h*s<0&&(d+=h)),this._evaluationZoom=d;const p=c.getExaggeration(d),f=p===c.getExaggeration(Math.max(0,d-.1));if(f&&Math.abs(p-this._exaggeration)<.01)return p;let m=Math.min(.1,.00375*(this._updateTimestamp-u));return(f||p<.1||Math.abs(h)<1e-4)&&(m=Math.min(.2,4*m)),e.ak(this._exaggeration,p,m)}resetTileLookupCache(e){this._findCoveringTileCache[e]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(e){"source"===e.dataType&&e.coord?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):"style"===e.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const e in this._style._mergedSourceCaches)this._style._mergedSourceCaches[e].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((e=>e.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const e=2*this.proxySourceCache.getSource().tileSize;return[e,e]}set useVertexMorphing(e){this._useVertexMorphing=e}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const r=this.proxySourceCache,o=this.painter.transform;this._initializing&&(this._initializing=0===o._centerAltitude&&-1===this.getAtPointOrZero(e.ae.fromLngLat(o.center),-1),this._emptyDEMTextureDirty=!this._initializing);const s=this.proxyCoords=r.getIds().map((e=>{const t=r.getTileByID(e).tileID;return t.projMatrix=o.calculateProjMatrix(t.toUnwrapped()),t}));!function(t,r){const o=r.transform.pointCoordinate(r.transform.getCameraPoint()),s=new e.P(o.x,o.y);t.sort(((t,r)=>{if(r.overscaledZ-t.overscaledZ)return r.overscaledZ-t.overscaledZ;const o=new e.P(t.canonical.x+(1<<t.canonical.z)*t.wrap,t.canonical.y),l=new e.P(r.canonical.x+(1<<r.canonical.z)*r.wrap,r.canonical.y),c=s.mult(1<<t.canonical.z);return c.x-=.5,c.y-=.5,c.distSqr(o)-c.distSqr(l)}))}(s,this.painter);const l=this.proxyToSource||{};this.proxyToSource={},s.forEach((e=>{this.proxyToSource[e.key]={}})),this.terrainTileForTile={};const c=this._style._mergedSourceCaches;for(const e in c){const r=c[e];if(!r.used)continue;if(r!==this.sourceCache&&this.resetTileLookupCache(r.id),this._setupProxiedCoordsForOrtho(r,t[e],l),r.usedForTerrain)continue;const o=t[e];r.getSource().reparseOverscaled&&this._assignTerrainTiles(o)}this.proxiedCoords[r.id]=s.map((e=>new rr(e,e.key,this.orthoMatrix))),this._assignTerrainTiles(s),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(l),this.renderingToTexture=!1;const h={};this._visibleDemTiles=[];for(const e of this.proxyCoords){const t=this.terrainTileForTile[e.key];if(!t)continue;const r=t.tileID.key;r in h||(this._visibleDemTiles.push(t),h[r]=r)}}_assignTerrainTiles(e){this._initializing||e.forEach((e=>{if(this.terrainTileForTile[e.key])return;const t=this._findTileCoveringTileID(e,this.sourceCache);t&&(this.terrainTileForTile[e.key]=t)}))}_prepareDEMTextures(){const e=this.painter.context,t=e.gl;for(const r in this.terrainTileForTile){const o=this.terrainTileForTile[r],s=o.dem;!s||o.demTexture&&!o.needsDEMTextureUpload||(e.activeTexture.set(t.TEXTURE1),go(this.painter,o,s))}}_prepareDemTileUniforms(e,t,r,o){if(!t||null==t.demTexture)return!1;const s=e.tileID.canonical,l=Math.pow(2,t.tileID.canonical.z-s.z),c=o||"";return r[`u_dem_tl${c}`]=[s.x*l%1,s.y*l%1],r[`u_dem_scale${c}`]=l,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let e=0;const t=this._visibleDemTiles.reduce(((t,r)=>{if(!r.dem)return t;const o=r.dem.tree.minimums[0];return o>0&&e++,t+o}),0);return e?t/e:0}_updateEmptyDEMTexture(){const t=this.painter.context,r=t.gl;t.activeTexture.set(r.TEXTURE2);const o=this._getLoadedAreaMinimum(),s=new e.dL({width:1,height:1},new Float32Array([o]));this._emptyDEMTextureDirty=!1;let l=this._emptyDEMTexture;return l?l.update(s,{premultiply:!1}):l=this._emptyDEMTexture=new e.T(t,s,r.R32F,{premultiply:!1}),l}setupElevationDraw(t,r,o){const s=this.painter.context,l=s.gl,c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};c.u_exaggeration=this.exaggeration();let h=null,u=null,d=1;if(o&&o.morphing&&this._useVertexMorphing){const e=o.morphing.srcDemTile,r=o.morphing.dstDemTile;d=o.morphing.phase,e&&r&&(this._prepareDemTileUniforms(t,e,c,"_prev")&&(u=e),this._prepareDemTileUniforms(t,r,c)&&(h=r))}const p=e=>e&&e.demTexture&&this.painter.linearFloatFilteringSupported()?l.LINEAR:l.NEAREST;let f=null;var m;if(this.enabled?u&&h?(f=h.demTexture,s.activeTexture.set(l.TEXTURE4),u.demTexture.bind(p(u),l.CLAMP_TO_EDGE),c.u_dem_lerp=d):(h=this.terrainTileForTile[t.tileID.key],f=this._prepareDemTileUniforms(t,h,c)?h.demTexture:this.emptyDEMTexture):f=this.emptyDEMTexture,s.activeTexture.set(l.TEXTURE2),f&&(c.u_dem_size=1===(m=f).size[0]?1:m.size[0]-2,f.bind(p(h),l.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(o&&o.useDepthForOcclusion,r,c),o&&o.useMeterToDem&&h){const t=(1<<h.tileID.canonical.z)*e.cf(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;c.u_meter_to_dem=t}if(o&&o.labelPlaneMatrixInv&&(c.u_label_plane_matrix_inv=o.labelPlaneMatrixInv),r.setTerrainUniformValues(s,c),"globe"===this.painter.transform.projection.name){const e=this.globeUniformValues(this.painter.transform,t.tileID.canonical,o&&o.useDenormalizedUpVectorScale);r.setGlobeUniformValues(s,e)}}globeUniformValues(t,r,o){const s=t.projection;return{u_tile_tl_up:s.upVector(r,0,0),u_tile_tr_up:s.upVector(r,e.al,0),u_tile_br_up:s.upVector(r,e.al,e.al),u_tile_bl_up:s.upVector(r,0,e.al),u_tile_up_scale:o?e.dM(1):s.upVectorScale(r,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const r=this.painter,o=this.painter.context;0!==t.length&&(o.bindFramebuffer.set(null),o.viewport.set([0,0,r.width,r.height]),r.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(t,r,o,s,l){if("globe"===t.transform.projection.name)!function(t,r,o,s,l){const c=t.context,h=c.gl;let u,d;const p=t.transform,f=e.dE(t,c,p),m=(e,r)=>{if(d===r)return;const o=[Po[r],"PROJECTION_GLOBE_VIEW"];f&&o.push("CUSTOM_ANTIALIASING");const s=t.isTileAffectedByFog(e);u=t.getOrCreateProgram("globeRaster",{defines:o,overrideFog:s}),d=r},_=t.colorModeForRenderPass(),v=new $i(h.LEQUAL,$i.ReadWrite,t.depthRangeFor3D);Mo.update(l);const E=e.dF(p),P=[e.aF(p.center.lng),e.aJ(p.center.lat)],C=t.globeSharedBuffers,R=[p.width*e.o.devicePixelRatio,p.height*e.o.devicePixelRatio],z=Float32Array.from(p.globeMatrix),D={useDenormalizedUpVectorScale:!0};{const p=t.transform,f=Ro(p.zoom,r.exaggeration(),r.sourceCache._source.tileSize);d=-1;const O=h.TRIANGLES;for(const d of s){const s=o.getTile(d),F=Yi.disabled,B=r.prevTerrainTileForTile[d.key],k=r.terrainTileForTile[d.key];Ao(B,k)&&Mo.newMorphing(d.key,B,k,l,250),Do(t,s.emissiveTexture),c.activeTexture.set(h.TEXTURE0),s.texture&&s.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE);const V=Mo.getMorphValuesForProxy(d.key),N=V?1:0;V&&Object.assign(D,{morphing:{srcDemTile:V.from,dstDemTile:V.to,phase:e.dD(V.phase)}});const U=e.dG(d.canonical),j=e.dH(U.getCenter().lat),$=e.dI(d.canonical,U,j,p.worldSize/p._pixelsPerMercatorPixel),q=e.bk(e.dJ(d.canonical)),H="mrt-fallback"===t.emissiveMode?1:0,Z=wo(p.expandedFarZProjMatrix,z,E,q,e.aj(p.zoom),P,p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.globeCenterInViewSpace,p.globeRadius,R,f,p._farZ,H,$);if(m(d,N),u&&(r.setupElevationDraw(s,u,D),t.uploadCommonUniforms(c,u,d.toUnwrapped()),C)){const[e,r,o]=C.getGridBuffers(j,0!==f);u.draw(t,O,v,F,_,Qi.backCCW,Z,"globe_raster",e,r,o)}}}if(C&&(t.renderDefaultNorthPole||t.renderDefaultSouthPole)){const l=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];f&&l.push("CUSTOM_ANTIALIASING"),u=t.getOrCreateProgram("globeRaster",{defines:l});for(const l of s){const{x:s,y:d,z:f}=l.canonical,m=0===d,E=d===(1<<f)-1,[z,O,F,B]=C.getPoleBuffers(f,!1);if(B&&(m||E)){const d=o.getTile(l);Do(t,d.emissiveTexture),c.activeTexture.set(h.TEXTURE0),d.texture&&d.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE);let C=e.dK(f,s,p);const k=e.bk(e.dJ(l.canonical)),V="mrt-fallback"===t.emissiveMode?1:0,N=(e,r)=>e.draw(t,h.TRIANGLES,v,Yi.disabled,_,Qi.disabled,wo(p.expandedFarZProjMatrix,C,C,k,0,P,p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.globeCenterInViewSpace,p.globeRadius,R,0,p._farZ,V),"globe_pole_raster",r,F,B);r.setupElevationDraw(d,u,D),t.uploadCommonUniforms(c,u,l.toUnwrapped()),m&&t.renderDefaultNorthPole&&N(u,z),E&&t.renderDefaultSouthPole&&(C=e.cS(e.bC(),C,[1,-1,1]),N(u,O))}}}}(t,r,o,s,l);else{const c=t.context,h=c.gl;let u,d;const p=t.shadowRenderer,f=tn(t,t.longestCutoffRange),m=e=>{if(d===e)return;const r=[];r.push(Po[e]),f.shouldRenderCutoff&&r.push("RENDER_CUTOFF"),p&&(r.push("RENDER_SHADOWS","DEPTH_TEXTURE"),p.useNormalOffset&&r.push("NORMAL_OFFSET")),u=t.getOrCreateProgram("terrainRaster",{defines:r}),d=e},_=t.colorModeForRenderPass(),v=new $i(h.LEQUAL,$i.ReadWrite,t.depthRangeFor3D);Mo.update(l);const E=t.transform,P=Ro(E.zoom,r.exaggeration(),r.sourceCache._source.tileSize);let C=[0,0,0];if(p){const e=t.style.directionalLight,r=t.style.ambientLight;e&&r&&(C=hn(t.style,e,r))}{d=-1;const R=h.TRIANGLES,[z,D]=[r.gridIndexBuffer,r.gridSegments];for(const d of s){const s=o.getTile(d),O=Yi.disabled,F=r.prevTerrainTileForTile[d.key],B=r.terrainTileForTile[d.key];Ao(F,B)&&Mo.newMorphing(d.key,F,B,l,250),Do(t,s.emissiveTexture),c.activeTexture.set(h.TEXTURE0),s.texture&&s.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE);const k=Mo.getMorphValuesForProxy(d.key),V=k?1:0;let N;k&&(N={morphing:{srcDemTile:k.from,dstDemTile:k.to,phase:e.dD(k.phase)}});const U="mrt-fallback"===t.emissiveMode?1:0,j=bo(d.projMatrix,zo(d.canonical,E.renderWorldCopies)?P/10:P,C,U);if(m(V),!u)continue;r.setupElevationDraw(s,u,N);const $=d.toUnwrapped();p&&p.setupShadows($,u),t.uploadCommonUniforms(c,u,$,null,f),u.draw(t,R,v,O,_,Qi.backCCW,j,"terrain_raster",r.gridBuffer,z,D)}}}}(r,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,r.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const r=this.painter,o=this.painter.context,s=this.proxySourceCache,l=this.proxiedCoords[s.id],c=this._drapedRenderBatches.shift(),h=r.style.order,u=[];this._updateFBOs("mrt-fallback"===r.emissiveMode);let d=0;for(const p of l){const l=s.getTileByID(p.proxyTileKey),f=s.proxyCachedFBO[p.key]?s.proxyCachedFBO[p.key][t]:void 0,m=void 0!==f?s.renderCache[f]:this.pool[d++],_=void 0!==f;if(l.texture=m.tex,l.emissiveTexture=m.emissiveTex,_&&!m.dirty){u.push(l.tileID);continue}o.bindFramebuffer.set(m.fb.framebuffer);const v=o.gl;let E;v.drawBuffers("mrt-fallback"===r.emissiveMode?[v.COLOR_ATTACHMENT0,v.COLOR_ATTACHMENT1]:[v.COLOR_ATTACHMENT0]),this.renderedToTile=!1,m.dirty&&(o.clear({color:e.ao.transparent,stencil:0}),m.dirty=!1);for(let e=c.start;e<=c.end;++e){const t=r.style._mergedLayers[h[e]];if(t.isHidden(r.transform.zoom))continue;const s=r.style.getLayerSourceCache(t),l=s?this.proxyToSource[p.key][s.id]:[p];if(!l)continue;const c=l;o.viewport.set([0,0,m.fb.width,m.fb.height]),E!==(s?s.id:null)&&(this._setupStencil(m,l,t,s),E=s?s.id:null),r.renderLayer(r,s,t,c)}if(v.drawBuffers([v.COLOR_ATTACHMENT0]),0===this._drapedRenderBatches.length)for(const e of this._pendingGroundEffectLayers){const t=r.style._mergedLayers[h[e]];if(t.isHidden(r.transform.zoom))continue;const s=r.style.getLayerSourceCache(t),l=s?this.proxyToSource[p.key][s.id]:[p];if(!l)continue;const c=l;o.viewport.set([0,0,m.fb.width,m.fb.height]),E!==(s?s.id:null)&&(this._setupStencil(m,l,t,s),E=s?s.id:null),r.renderLayer(r,s,t,c)}this.renderedToTile?(m.dirty=!0,u.push(l.tileID)):_||--d,5===d&&(d=0,this.renderToBackBuffer(u))}return this.renderToBackBuffer(u),this.renderingToTexture=!1,o.bindFramebuffer.set(null),o.viewport.set([0,0,r.width,r.height]),c.end+1}postRender(){}isLayerOrderingCorrect(e){const t=e.order.length;let r=-1,o=t;for(let s=0;s<t;++s)this._style.isLayerDraped(e._mergedLayers[e.order[s]])?r=Math.max(r,s):o=Math.min(o,s);return o>r}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter((e=>e.dem)).forEach((t=>{e=Math.min(e,t.dem.tree.minimums[0])})),0===e?e:(e-30)*this._exaggeration}raycast(e,t,r){if(!this._visibleDemTiles)return null;const o=this._visibleDemTiles.filter((e=>e.dem)).map((o=>{const s=o.tileID,l=1<<s.overscaledZ,{x:c,y:h}=s.canonical,u=c/l,d=(c+1)/l,p=h/l,f=(h+1)/l;return{minx:u,miny:p,maxx:d,maxy:f,t:o.dem.tree.raycastRoot(u,p,d,f,e,t,r),tile:o}}));o.sort(((e,t)=>(null!==e.t?e.t:Number.MAX_VALUE)-(null!==t.t?t.t:Number.MAX_VALUE)));for(const s of o){if(null==s.t)return null;const o=s.tile.dem.tree.raycast(s.minx,s.miny,s.maxx,s.maxy,e,t,r);if(null!=o)return o}return null}_createFBO(){const t=this.painter.context,r=t.gl,o=this.drapeBufferSize;t.activeTexture.set(r.TEXTURE0);const s=new e.T(t,{width:o[0],height:o[1],data:null},r.RGBA8);s.bind(r.LINEAR,r.CLAMP_TO_EDGE);const l=t.createFramebuffer(o[0],o[1],1,null);let c;return l.colorAttachment0.set(s.texture),this._emissiveTexture&&(c=new e.T(t,{width:o[0],height:o[1],data:null},r.R8),c.bind(r.LINEAR,r.CLAMP_TO_EDGE),l.createColorAttachment(t,1),l.colorAttachment1.set(c.texture)),l.depthAttachment=new Zs(t,l.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,o[0],o[1]),this._stencilRef=0,l.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):l.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&r.texParameterf(r.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:l,tex:s,emissiveTex:c,dirty:!1}}_updateFBOs(e){if(this._emissiveTexture!==e){for(const t of this.pool)this._updateFBO(t,e);for(const t of this.proxySourceCache.renderCache)this._updateFBO(t,e);this._emissiveTexture=e}}_updateFBO(t,r){const o=t.fb,s=this.painter.context,l=s.gl,c=this.drapeBufferSize;if(r){const r=new e.T(s,{width:c[0],height:c[1],data:null},l.R8);r.bind(l.LINEAR,l.CLAMP_TO_EDGE),t.emissiveTex=r,o.createColorAttachment(s,1),o.colorAttachment1.set(r.texture)}else t.emissiveTex=void 0,o.removeColorAttachment(s,1);t.dirty=!0}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const e in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[e].hasTransition())return!0;return this._style.order.some((e=>{const t=this._style._mergedLayers[e],r=t.isHidden(this.painter.transform.zoom);return"hillshade"===t.type||"custom"===t.type?!r&&t.shouldRedrape():!r&&t.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const e of this._style.getSources())if(e instanceof dt){t=!0;break}if(!t)return;const r={};for(let t=0;t<this._style.order.length;++t){const o=this._style._mergedLayers[this._style.order[t]],s=this._style.getLayerSourceCache(o);if(!s||r[s.id])continue;if(o.isHidden(this.painter.transform.zoom)||"line"!==o.type)continue;const l=o.widthExpression(),c=o.emissiveStrengthExpression();if(l instanceof e.ad||c instanceof e.ad){r[s.id]=!0;for(const e of this.proxyCoords){const t=this.proxyToSource[e.key][s.id];if(t)for(const e of t)this._clearRenderCacheForTile(s.id,e)}}}}_clearRasterLayersFromRenderCache(){let e=!1;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t]._source instanceof ut){e=!0;break}if(!e)return;const t={};for(let e=0;e<this._style.order.length;++e){const r=this._style._mergedLayers[this._style.order[e]],o=this._style.getLayerSourceCache(r);if(!o||t[o.id])continue;if(r.isHidden(this.painter.transform.zoom)||"raster"!==r.type)continue;const s=r.paint.get("raster-fade-duration");for(const e of this.proxyCoords){const t=this.proxyToSource[e.key][o.id];if(t)for(const e of t){const t=ko(o.getTile(e),o.findLoadedParent(e,0),o,this.painter.transform,s);(1!==t.opacity||0!==t.mix)&&this._clearRenderCacheForTile(o.id,e)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,r=t.length;if(0===r)return;const o=[];this._pendingGroundEffectLayers=[];let s,l=0,c=this._style._mergedLayers[t[l]];for(;!this._style.isLayerDraped(c)&&c.isHidden(this.painter.transform.zoom)&&++l<r;)c=this._style._mergedLayers[t[l]];for(;l<r;++l){const e=this._style._mergedLayers[t[l]];e.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(e)?void 0===s&&(s=l):("fill-extrusion"===e.type&&this._pendingGroundEffectLayers.push(l),void 0!==s&&(o.push({start:s,end:l-1}),s=void 0)))}if(void 0!==s&&o.push({start:s,end:l-1}),0!==o.length){const t=o[o.length-1];this._pendingGroundEffectLayers.every((e=>e>t.end))||e.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=o}_setupRenderCache(e){const t=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,t.renderCache.length>t.renderCachePool.length){const e=Object.values(t.proxyCachedFBO);t.proxyCachedFBO={};for(let r=0;r<e.length;++r){const o=Object.values(e[r]);t.renderCachePool.push(...o)}}return}this._clearRasterLayersFromRenderCache();const r=this.proxyCoords,o=this._tilesDirty;for(let s=r.length-1;s>=0;s--){const l=r[s];if(t.getTileByID(l.key),void 0!==t.proxyCachedFBO[l.key]){const r=e[l.key],s=this.proxyToSource[l.key];let c=0;for(const e in s){const t=s[e],l=r[e];if(!l||l.length!==t.length||t.some(((t,r)=>t!==l[r]||o[e]&&o[e].hasOwnProperty(t.key)))){c=-1;break}++c}for(const e in t.proxyCachedFBO[l.key])t.renderCache[t.proxyCachedFBO[l.key][e]].dirty=c<0||c!==Object.values(r).length}}const s=[...this._drapedRenderBatches];s.sort(((e,t)=>t.end-t.start-(e.end-e.start)));for(const e of s)for(const o of r){if(t.proxyCachedFBO[o.key])continue;let r=t.renderCachePool.pop();void 0===r&&t.renderCache.length<50&&(r=t.renderCache.length,t.renderCache.push(this._createFBO())),void 0!==r&&(t.proxyCachedFBO[o.key]={},t.proxyCachedFBO[o.key][e.start]=r,t.renderCache[r].dirty=!0)}this._tilesDirty={}}_setupStencil(e,t,r,o){if(!o||!this._sourceTilesOverlap[o.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const s=this.painter.context,l=s.gl;if(t.length<=1)return void(this._overlapStencilType=!1);let c;if(r.isTileClipped())c=t.length,this._overlapStencilMode.test={func:l.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(t[0].overscaledZ>t[t.length-1].overscaledZ))return void(this._overlapStencilType=!1);c=1,this._overlapStencilMode.test={func:l.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+c>255&&(s.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=c,this._overlapStencilMode.ref=this._stencilRef,r.isTileClipped()&&this._renderTileClippingMasks(t,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):Yi.disabled}_renderTileClippingMasks(e,t){const r=this.painter,o=this.painter.context,s=o.gl;r._tileClippingMaskIDs={},o.setColorMode(Wi.disabled),o.setDepthMode($i.disabled);const l=r.getOrCreateProgram("clippingMask");for(const o of e){const e=r._tileClippingMaskIDs[o.key]=--t;l.draw(r,s.TRIANGLES,$i.disabled,new Yi({func:s.ALWAYS,mask:0},e,255,s.KEEP,s.KEEP,s.REPLACE),Wi.disabled,Qi.disabled,Bo(o.projMatrix),"$clipping",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments)}}pointCoordinate(t){const r=this.painter.transform;if(t.x<0||t.x>r.width||t.y<0||t.y>r.height)return null;const o=[t.x,t.y,1,1];e.aC(o,o,r.pixelMatrixInverse),e.cK(o,o,1/o[3]),o[0]/=r.worldSize,o[1]/=r.worldSize;const s=r._camera.position,l=e.cf(1,r.center.lat),c=[s[0],s[1],s[2]/l,0],h=e.da([],o.slice(0,3),c);e.aw(h,h);const u=this.raycast(c,h,this._exaggeration);return null!==u&&u?(e.bH(c,c,h,u),c[3]=c[2],c[2]*=l,c):null}_setupProxiedCoordsForOrtho(t,r,o){if(t.getSource()instanceof e.aU)return this._setupProxiedCoordsForImageSource(t,r,o);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const s=this.proxiedCoords[t.id]=[],l=this.proxyCoords;for(let e=0;e<l.length;e++){const r=l[e],c=this._findTileCoveringTileID(r,t);if(c){const e=this._createProxiedId(r,c,o[r.key]&&o[r.key][t.id]);s.push(e),this.proxyToSource[r.key][t.id]=[e]}}let c=!1;const h=new Set;for(let e=0;e<r.length;e++){const l=t.getTile(r[e]);if(!l||!l.hasData())continue;const u=this._findTileCoveringTileID(l.tileID,this.proxySourceCache);if(u&&u.tileID.canonical.z!==l.tileID.canonical.z){const e=this.proxyToSource[u.tileID.key][t.id],r=this._createProxiedId(u.tileID,l,o[u.tileID.key]&&o[u.tileID.key][t.id]);e?e.splice(e.length-1,0,r):this.proxyToSource[u.tileID.key][t.id]=[r];const d=this.proxyToSource[u.tileID.key][t.id];h.has(d)||h.add(d),s.push(r),c=!0}}if(this._sourceTilesOverlap[t.id]=c,c&&this._debugParams.sortTilesHiZFirst)for(const e of h)e.sort(((e,t)=>t.overscaledZ-e.overscaledZ))}_setupProxiedCoordsForImageSource(t,r,o){if(!t.getSource().loaded())return;const s=this.proxiedCoords[t.id]=[],l=this.proxyCoords,c=t.getSource(),h=c.tileID;if(!h)return;const u=new e.P(h.x,h.y)._div(1<<h.z),d=c.coordinates.map(e.ae.fromLngLat).reduce(((e,t)=>(e.min.x=Math.min(e.min.x,t.x-u.x),e.min.y=Math.min(e.min.y,t.y-u.y),e.max.x=Math.max(e.max.x,t.x-u.x),e.max.y=Math.max(e.max.y,t.y-u.y),e)),{min:new e.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new e.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),p=(t,r)=>{const o=t.wrap+t.canonical.x/(1<<t.canonical.z),s=t.canonical.y/(1<<t.canonical.z),l=e.al/(1<<t.canonical.z),c=r.wrap+r.canonical.x/(1<<r.canonical.z),h=r.canonical.y/(1<<r.canonical.z);return o+l<c+d.min.x||o>c+d.max.x||s+l<h+d.min.y||s>h+d.max.y};for(let e=0;e<l.length;e++){const c=l[e];for(let e=0;e<r.length;e++){const l=t.getTile(r[e]);if(!l||!l.hasData())continue;if(p(c,l.tileID))continue;const h=this._createProxiedId(c,l,o[c.key]&&o[c.key][t.id]),u=this.proxyToSource[c.key][t.id];u?u.push(h):this.proxyToSource[c.key][t.id]=[h],s.push(h)}}}_createProxiedId(t,r,o){let s=this.orthoMatrix;if(o){const e=o.find((e=>e.key===r.tileID.key));if(e)return e}if(r.tileID.key!==t.key){const o=t.canonical.z-r.tileID.canonical.z;let l,c,h;s=e.bC();const u=r.tileID.wrap-t.wrap<<t.overscaledZ;o>0?(l=e.al>>o,c=l*((r.tileID.canonical.x<<o)-t.canonical.x+u),h=l*((r.tileID.canonical.y<<o)-t.canonical.y)):(l=e.al<<-o,c=e.al*(r.tileID.canonical.x-(t.canonical.x+u<<-o)),h=e.al*(r.tileID.canonical.y-(t.canonical.y<<-o))),e.ce(s,0,l,0,l,0,1),e.br(s,s,[c,h,0])}return new rr(r.tileID,t.key,s)}_findTileCoveringTileID(t,r){let o=r.getTile(t);if(o&&o.hasData())return o;const s=this._findCoveringTileCache[r.id],l=s[t.key];if(o=l?r.getTileByID(l):null,o&&o.hasData()||null===l)return o;let c=o?o.tileID:t,h=c.overscaledZ;const u=r.getSource().minzoom,d=[];if(!l){const s=r.getSource().maxzoom;if(t.canonical.z>=s){const o=t.canonical.z-s;r.getSource().reparseOverscaled?(h=Math.max(t.canonical.z+2,r.transform.tileZoom),c=new e.aQ(h,t.wrap,s,t.canonical.x>>o,t.canonical.y>>o)):0!==o&&(h=s,c=new e.aQ(h,t.wrap,s,t.canonical.x>>o,t.canonical.y>>o))}c.key!==t.key&&(d.push(c.key),o=r.getTile(c))}const p=e=>{d.forEach((t=>{s[t]=e})),d.length=0};for(h-=1;h>=u&&(!o||!o.hasData());h--){o&&p(o.tileID.key);const e=c.calculateScaledKey(h);if(o=r.getTileByID(e),o&&o.hasData())break;const t=s[e];if(null===t)break;void 0===t?d.push(e):o=r.getTileByID(t)}return p(o?o.tileID.key:null),o&&o.hasData()?o:null}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(e,t){let r=this._tilesDirty[e];r||(r=this._tilesDirty[e]={}),r[t.key]=!0}}function Vo(t,r,o){const s=function(t,r,o){const s=e.bJ(r,t),l=e.bJ(o,[.2126,.7152,.0722]),c=(e,t,r)=>(1-r)*e+r*t,h=c(1-.3*Math.min(l,1),1,Math.min(s+1,1));return c(.92,1,Math.asin(e.aA(r[2],-1,1))/Math.PI+.5)*h}(t,[0,0,1],r),l=[0,0,0];e.c5(l,o.slice(0,3),s);const c=[0,0,0];e.c5(c,r.slice(0,3),t[2]);const h=[0,0,0];return e.d8(h,l,c),e.db(h)}const Uo=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],os=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","building","buildingBloom","elevatedStructures","model","symbol"];class hr{static cacheKey(e,t,r,o){const s=[t];o&&s.push(o.cacheKey);for(const t of r)e.usedDefines.has(t)&&s.push(t);return s.join("/")}constructor(t,r,o,s,l,c){const h=t.gl;this.program=h.createProgram(),this.configuration=s,this.name=r,this.fixedDefines=[...c];const u=`#version 300 es\n${(s?s.defines():[]).concat(c.map((e=>`#define ${e}`))).join("\n")}`,d=[u,Jn];for(const e of o.fragmentIncludes)d.push(Gn[e]);d.push(o.fragmentSource);const p=d.join("\n"),f=[u,Qn];for(const e of o.vertexIncludes)f.push(Gn[e]);this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&o.vertexSource.includes("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&f.push("uniform int u_instanceID;"),f.push(o.vertexSource);let m=f.join("\n");this.forceManualRenderingForInstanceIDShaders&&(m=m.replaceAll("gl_InstanceID","u_instanceID"));const _=h.createShader(h.FRAGMENT_SHADER);if(h.isContextLost())return void(this.failedToCreate=!0);h.shaderSource(_,p),h.compileShader(_),h.attachShader(this.program,_);const v=h.createShader(h.VERTEX_SHADER);h.isContextLost()?this.failedToCreate=!0:(h.shaderSource(v,m),h.compileShader(v),h.attachShader(this.program,v),this.attributes={},h.linkProgram(this.program),h.deleteShader(v),h.deleteShader(_),this.fixedUniforms=l(t),this.fixedUniformsEntries=Object.entries(this.fixedUniforms),this.binderUniforms=s?s.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(t=>({u_instanceID:new e.ch(t)}))(t)),(c.includes("TERRAIN")||r.includes("symbol")||r.includes("circle"))&&(this.terrainUniforms=(t=>({u_dem:new e.ch(t),u_dem_prev:new e.ch(t),u_dem_tl:new e.ck(t),u_dem_scale:new e.cj(t),u_dem_tl_prev:new e.ck(t),u_dem_scale_prev:new e.cj(t),u_dem_size:new e.cj(t),u_dem_lerp:new e.cj(t),u_exaggeration:new e.cj(t),u_depth:new e.ch(t),u_depth_size_inv:new e.ck(t),u_depth_range_unpack:new e.ck(t),u_occluder_half_size:new e.cj(t),u_occlusion_depth_offset:new e.cj(t),u_meter_to_dem:new e.cj(t),u_label_plane_matrix_inv:new e.cl(t)}))(t)),c.includes("GLOBE")&&(this.globeUniforms=(t=>({u_tile_tl_up:new e.ci(t),u_tile_tr_up:new e.ci(t),u_tile_br_up:new e.ci(t),u_tile_bl_up:new e.ci(t),u_tile_up_scale:new e.cj(t)}))(t)),c.includes("FOG")&&(this.fogUniforms=(t=>({u_fog_matrix:new e.cl(t),u_fog_range:new e.ck(t),u_fog_color:new e.d3(t),u_fog_horizon_blend:new e.cj(t),u_fog_vertical_limit:new e.ck(t),u_fog_temporal_offset:new e.cj(t),u_frustum_tl:new e.ci(t),u_frustum_tr:new e.ci(t),u_frustum_br:new e.ci(t),u_frustum_bl:new e.ci(t),u_globe_pos:new e.ci(t),u_globe_radius:new e.cj(t),u_globe_transition:new e.cj(t),u_is_globe:new e.ch(t),u_viewport:new e.ck(t)}))(t)),c.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(t=>({u_cutoff_params:new e.d3(t)}))(t)),c.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(t=>({u_lighting_ambient_color:new e.ci(t),u_lighting_directional_dir:new e.ci(t),u_lighting_directional_color:new e.ci(t),u_ground_radiance:new e.ci(t)}))(t)),c.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(t=>({u_light_matrix_0:new e.cl(t),u_light_matrix_1:new e.cl(t),u_fade_range:new e.ck(t),u_shadow_normal_offset:new e.ci(t),u_shadow_intensity:new e.cj(t),u_shadow_texel_size:new e.cj(t),u_shadow_map_resolution:new e.cj(t),u_shadow_direction:new e.ci(t),u_shadow_bias:new e.ci(t),u_shadowmap_0:new e.ch(t),u_shadowmap_1:new e.ch(t)}))(t)))}getAttributeLocation(e,t){let r=this.attributes[t];return void 0===r&&(r=this.attributes[t]=e.getAttribLocation(this.program,t)),r}setTerrainUniformValues(e,t){if(!this.terrainUniforms)return;const r=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)r[e]&&r[e].set(this.program,e,t[e])}}setGlobeUniformValues(e,t){if(!this.globeUniforms)return;const r=this.globeUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)r[e]&&r[e].set(this.program,e,t[e])}}setFogUniformValues(e,t){if(!this.fogUniforms)return;const r=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)r[e].set(this.program,e,t[e])}}setCutoffUniformValues(e,t){if(!this.cutoffUniforms)return;const r=this.cutoffUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)r[e].set(this.program,e,t[e])}}setLightsUniformValues(e,t){if(!this.lightsUniforms)return;const r=this.lightsUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)r[e].set(this.program,e,t[e])}}setShadowUniformValues(e,t){if(this.failedToCreate||!this.shadowUniforms)return;const r=this.shadowUniforms;e.program.set(this.program);for(const e in t)r[e].set(this.program,e,t[e])}_drawDebugWireframe(t,r,o,s,l,c,h,u,d,p){const f=t.options.wireframe;if(!1===f.terrain&&!1===f.layers2D&&!1===f.layers3D)return;const m=t.context;if(!(()=>!(!f.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!f.layers2D||t._terrain&&t._terrain.renderingToTexture||!Uo.includes(this.name))||!(!f.layers3D||!os.includes(this.name)))())return;const _=m.gl,v=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,l,m);if(!v)return;const E=[...this.fixedDefines,"DEBUG_WIREFRAME"],P=t.getOrCreateProgram(this.name,{config:this.configuration,defines:E});m.program.set(P.program);const C=(e,t,r)=>{if(t[e]&&r[e])for(const o in t[e])r[e][o]&&r[e][o].set(r.program,o,t[e][o].current)};d&&d.setUniforms(P.program,m,P.binderUniforms,h,{zoom:u}),C("fixedUniforms",this,P),C("terrainUniforms",this,P),C("globeUniforms",this,P),C("fogUniforms",this,P),C("lightsUniforms",this,P),C("shadowUniforms",this,P),v.bind(),m.setColorMode(new Wi([_.ONE,_.ONE_MINUS_SRC_ALPHA,_.ZERO,_.ONE],e.ao.transparent,[!0,!0,!0,!1])),m.setDepthMode(new $i(r.func===_.LESS?_.LEQUAL:r.func,$i.ReadOnly,r.range)),m.setStencilMode(Yi.disabled);const R=3*c.primitiveLength*2,z=3*c.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const e=p||1;for(let t=0;t<e;++t)P.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",t),_.drawElements(_.LINES,R,_.UNSIGNED_SHORT,z)}else p&&p>1?_.drawElementsInstanced(_.LINES,R,_.UNSIGNED_SHORT,z,p):_.drawElements(_.LINES,R,_.UNSIGNED_SHORT,z);l.bind(),m.program.set(this.program),m.setDepthMode(r),m.setStencilMode(o),m.setColorMode(s)}checkUniforms(e,t,r){if(this.fixedDefines.includes(t))for(const o of Object.keys(r))if(!r[o].initialized)throw new Error(`Program '${this.name}', from draw '${e}': uniform ${o} not set but required by ${t} being defined`)}draw(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E){const P=e.context,C=P.gl;if(this.failedToCreate)return;P.program.set(this.program),P.setDepthMode(r),P.setStencilMode(o),P.setColorMode(s),P.setCullFace(l);for(const[e,t]of this.fixedUniformsEntries)t.set(this.program,e,c[e]);_&&_.setUniforms(this.program,P,this.binderUniforms,f,{zoom:m});const R={[C.POINTS]:1,[C.LINES]:2,[C.TRIANGLES]:3,[C.LINE_STRIP]:1}[t];this.checkUniforms(h,"RENDER_SHADOWS",this.shadowUniforms);const z=v||[],D=_?_.getPaintVertexBuffers():[],O=t===C.TRIANGLES&&d,F=E&&E>0?1:void 0;for(const l of p.get()){const c=l.vaos||(l.vaos={});if((c[h]||(c[h]=new rs)).bind(P,this,u,D,d,l.vertexOffset,z,F),this.forceManualRenderingForInstanceIDShaders){const e=E||1;for(let r=0;r<e;++r)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",r),d?C.drawElements(t,l.primitiveLength*R,C.UNSIGNED_SHORT,l.primitiveOffset*R*2):C.drawArrays(t,l.vertexOffset,l.vertexLength)}else E&&E>1?C.drawElementsInstanced(t,l.primitiveLength*R,C.UNSIGNED_SHORT,l.primitiveOffset*R*2,E):d?C.drawElements(t,l.primitiveLength*R,C.UNSIGNED_SHORT,l.primitiveOffset*R*2):C.drawArrays(t,l.vertexOffset,l.vertexLength);O&&this._drawDebugWireframe(e,r,o,s,d,l,f,m,_,E)}}}function ss(t,r,o=0){const s=Math.pow(2,r.tileID.overscaledZ),l=r.tileSize*Math.pow(2,t.transform.tileZoom)/s,c=l*(r.tileID.canonical.x+r.tileID.wrap*s),h=l*r.tileID.canonical.y;return{u_image:0,u_texsize:r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/e.ay(r,1,t.transform.tileZoom),u_pixel_coord_upper:[c>>16,h>>16],u_pixel_coord_lower:[65535&c,65535&h],u_pattern_transition:o}}const as={terrain:0,flat:1},ls=e.bC(),cs=(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R)=>{const z=r.style.light,D=z.properties.get("position"),O=[D.x,D.y,D.z],F=e.dO();"viewport"===z.properties.get("anchor")&&(e.dP(F,-r.transform.angle),e.dQ(O,O,F));const B=z.properties.get("color").toPremultipliedRenderColor(null),k=r.transform,V={u_matrix:t,u_lightpos:O,u_lightintensity:z.properties.get("intensity"),u_lightcolor:[B.r,B.g,B.b],u_vertical_gradient:+o,u_opacity:s,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ls,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:as[p],u_base_type:as[f],u_ao:l,u_edge_radius:c,u_width_scale:h,u_flood_light_color:E,u_vertical_scale:P,u_flood_light_intensity:C,u_ground_shadow_factor:R};return"globe"===k.projection.name&&(V.u_tile_id=[u.canonical.x,u.canonical.y,1<<u.canonical.z],V.u_zoom_transition=m,V.u_inv_rot_matrix=v,V.u_merc_center=_,V.u_up_dir=k.projection.upVector(new e.cD(0,0,0),_[0]*e.al,_[1]*e.al),V.u_height_lift=d),V},Ls=(e,t,r,o,s,l)=>({u_matrix:e,u_edge_radius:t,u_width_scale:r,u_vertical_scale:o,u_height_type:as[s],u_base_type:as[l]}),Ws=(e,t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C)=>{const R=cs(e,t,r,o,s,l,c,h,d,p,f,m,_,v,E,P,1,[0,0,0]),z={u_height_factor:-Math.pow(2,h.overscaledZ)/u.tileSize/8};return Object.assign(R,ss(t,u,C),z)},Ys=(e,t,r)=>({u_matrix:e,u_emissive_strength:t,u_ground_shadow_factor:r}),Js=(e,t,r,o,s,l=0)=>Object.assign(Ys(e,t,s),ss(r,o,l)),Qs=(e,t,r,o)=>({u_matrix:e,u_world:r,u_emissive_strength:t,u_ground_shadow_factor:o}),Ks=(e,t,r,o,s,l,c=0)=>Object.assign(Js(e,t,r,o,l,c),{u_world:s}),ea=(e,t)=>({u_matrix:e,u_depth_bias:t}),ta=(e,t)=>({u_matrix:e,u_ground_shadow_factor:t}),ia=(e,t,r,o,s)=>({u_matrix:e,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:r,u_height_scale:o,u_reset_depth:s}),ra=(e,t,r,o,s,l,c,h,u)=>({u_matrix:e,u_normal_matrix:t,u_opacity:r,u_faux_facade_ao_intensity:o,u_camera_pos:s,u_tile_to_meter:l,u_facade_emissive_chance:c,u_flood_light_color:h,u_flood_light_intensity:u}),na=e=>({u_matrix:e}),oa=e=>({u_matrix:e}),sa=(t,r,o,s,l,c,h,u)=>{const d=e.al/c.tileSize;return{u_matrix:t,u_inv_rot_matrix:r,u_camera_to_center_distance:o.getCameraToCenterDistance(u),u_extrude_scale:[o.pixelsToGLUnits[0]/d,o.pixelsToGLUnits[1]/d],u_zoom_transition:s,u_tile_id:h,u_merc_center:l}},aa=(e,t,r,o)=>({u_matrix:e,u_inv_matrix:t,u_camera_to_center_distance:r.getCameraToCenterDistance(o),u_viewport_size:[r.width,r.height]}),la=(e,t,r=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:r}),ca=e.bC(),ha=(t,r,o,s,l,c,h)=>{const u=t.transform,d="globe"===u.projection.name,p=d?e.dR(u.zoom,r.canonical)*u._pixelsPerMercatorPixel:e.ay(o,1,c),f={u_matrix:r.projMatrix,u_extrude_scale:p,u_intensity:h,u_inv_rot_matrix:ca,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(d){f.u_inv_rot_matrix=s,f.u_merc_center=l,f.u_tile_id=[r.canonical.x,r.canonical.y,1<<r.canonical.z],f.u_zoom_transition=e.aj(u.zoom);const t=l[0]*e.al,o=l[1]*e.al;f.u_up_dir=u.projection.upVector(new e.cD(0,0,0),t,o)}return f};function ua(e,[t,r,o,s],[l,c]){if(l===c)return[0,0,0,0];const h=255*(e-1)/(e*(c-l));return[t*h,r*h,o*h,s*h]}function da(e,t,[r,o]){return r===o?0:.5/e+(t-r)*(e-1)/(e*(o-r))}const ma=(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O)=>({u_matrix:t,u_normalize_matrix:r,u_globe_matrix:o,u_merc_matrix:s,u_grid_matrix:l,u_tl_parent:c,u_scale_parent:p,u_fade_t:f.mix,u_opacity:f.opacity*m.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:m.paint.get("raster-brightness-min"),u_brightness_high:m.paint.get("raster-brightness-max"),u_saturation_factor:e.dT(m.paint.get("raster-saturation")),u_contrast_factor:e.dS(m.paint.get("raster-contrast")),u_spin_weights:va(m.paint.get("raster-hue-rotate")),u_perspective_transform:_,u_raster_elevation:v,u_zoom_transition:h,u_merc_center:u,u_cutoff_params:d,u_colorization_mix:ua(e.dU,P,R),u_colorization_offset:da(e.dU,C,R),u_color_ramp:E,u_texture_offset:[D/(z+2*D),z/(z+2*D)],u_texture_res:[z+2*D,z+2*D],u_emissive_strength:O});function va(e){e*=Math.PI/180;const t=Math.sin(e),r=Math.cos(e);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}const ba=.05,wa=(e,t,r,o,s,l,c,h,u,d,p,f)=>({u_matrix:e,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:o,u_grid_matrix:s,u_tl_parent:l,u_scale_parent:d,u_fade_t:p.mix,u_opacity:p.opacity,u_image0:0,u_image1:1,u_raster_elevation:f,u_zoom_transition:c,u_merc_center:h,u_cutoff_params:u}),Ta=(e,t,r,o,s,l,c,h,u,d)=>({u_particle_texture:e,u_particle_texture_side_len:t,u_tile_offset:r,u_velocity:o,u_color_ramp:l,u_velocity_res:s,u_max_speed:c,u_uv_offset:h,u_data_scale:[255*u[0],255*u[1]],u_data_offset:d,u_particle_pos_scale:1.1,u_particle_pos_offset:[ba,ba]}),Ia=(e,t,r,o,s,l,c,h,u,d)=>({u_particle_texture:e,u_particle_texture_side_len:t,u_velocity:r,u_velocity_res:o,u_max_speed:s,u_speed_factor:l,u_reset_rate:c,u_rand_seed:Math.random(),u_uv_offset:h,u_data_scale:[255*u[0],255*u[1]],u_data_offset:d,u_particle_pos_scale:1.1,u_particle_pos_offset:[ba,ba]}),Aa=e.bC(),Ma=(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D,O,F,B,k)=>{const V=l.transform,N={u_is_size_zoom_constant:+("constant"===t||"source"===t),u_is_size_feature_constant:+("constant"===t||"camera"===t),u_size_t:r?r.uSizeT:0,u_size:r?r.uSize:0,u_camera_to_center_distance:V.getCameraToCenterDistance(z),u_rotate_symbol:+o,u_aspect_ratio:V.width/V.height,u_fade_change:l.options.fadeDuration?l.symbolFadeChange:1,u_matrix:c,u_label_plane_matrix:h,u_coord_matrix:u,u_is_text:+p,u_elevation_from_sea:d?1:0,u_pitch_with_map:+s,u_texsize:f,u_texsize_icon:m,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Aa,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Aa,u_up_vector:[0,-1,0],u_color_adj_mat:F,u_icon_transition:B||0,u_gamma_scale:s?l.transform.getCameraToCenterDistance(z)*Math.cos(l.terrain?0:l.transform._pitch):1,u_device_pixel_ratio:e.o.devicePixelRatio,u_is_halo:1,u_scale_factor:k||1,u_ground_shadow_factor:D,u_inv_matrix:e.bl(e.bC(),h),u_normal_scale:O,u_lutTexture:10};return"globe"===z.name&&(N.u_tile_id=[v.canonical.x,v.canonical.y,1<<v.canonical.z],N.u_zoom_transition=E,N.u_inv_rot_matrix=C,N.u_merc_center=P,N.u_camera_forward=V._camera.forward(),N.u_ecef_origin=e.dV(V.globeMatrix,v.toUnwrapped()),N.u_tile_matrix=Float32Array.from(V.globeMatrix),N.u_up_vector=R),N},Ra=(e,t,r,o)=>({u_matrix:e,u_emissive_strength:t,u_opacity:r,u_color:o}),Da=(t,r,o,s,l,c,h,u,d)=>Object.assign(function(t,r,o,s,l,c){const{width:h,height:u}=s.imageManager.getPixelSize(r),d=Math.pow(2,c.tileID.overscaledZ),p=c.tileSize*Math.pow(2,s.transform.tileZoom)/d,f=p*(c.tileID.canonical.x+c.tileID.wrap*d),m=p*c.tileID.canonical.y;return{u_image:0,u_pattern_tl:o.tl,u_pattern_br:o.br,u_texsize:[h,u],u_pattern_size:o.displaySize,u_pattern_units_to_pixels:l?[s.transform.width,-1*s.transform.height]:[1/e.ay(c,1,s.transform.tileZoom),1/e.ay(c,1,s.transform.tileZoom)],u_pixel_coord_upper:[f>>16,m>>16],u_pixel_coord_lower:[65535&f,65535&m]}}(0,c,h,s,u,d),{u_matrix:t,u_emissive_strength:r,u_opacity:o}),La=new Float32Array(e.bA([])),Oa=(t,r,o,s,l,c,h,u,d,p,f,m,_,v=[0,0,0],E,P,C)=>{const R=l.style.light,z=R.properties.get("position"),D=[-z.x,-z.y,z.z],O=e.dO();"viewport"===R.properties.get("anchor")&&(e.dP(O,-l.transform.angle),e.dQ(D,D,O));const F="MASK"===f.alphaMode,B=R.properties.get("color").toNonPremultipliedRenderColor(null),k=_.paint.get("model-ambient-occlusion-intensity"),V=_.paint.get("model-color").constantOr(e.ao.white).toNonPremultipliedRenderColor(null);return V.a=_.paint.get("model-color-mix-intensity").constantOr(0),C&&(V.r=C[0],V.g=C[1],V.b=C[2],V.a=C[3]),P&&(V.r=P.color.r,V.g=P.color.g,V.b=P.color.b,V.a=P.colorMix,m=P.emissionStrength,c*=P.opacity),{u_matrix:t,u_lighting_matrix:r,u_normal_matrix:o,u_node_matrix:s||La,u_lightpos:D,u_lightintensity:R.properties.get("intensity"),u_lightcolor:[B.r,B.g,B.b],u_camera_pos:v,u_opacity:c,u_baseTextureIsAlpha:0,u_alphaMask:+F,u_alphaCutoff:f.alphaCutoff,u_baseColorFactor:h.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:u.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:d,u_roughnessFactor:p,u_baseColorTexture:5,u_metallicRoughnessTexture:6,u_normalTexture:7,u_occlusionTexture:8,u_emissionTexture:9,u_lutTexture:10,u_color_mix:V.toArray01(),u_aoIntensity:k,u_emissive_strength:m,u_occlusionTextureTransform:E||[0,0,0,0]}},Fa=(e,t=La,r=La)=>({u_matrix:e,u_instance:t,u_node_matrix:r}),Ba={fillExtrusion:t=>({u_matrix:new e.cl(t),u_lightpos:new e.ci(t),u_lightintensity:new e.cj(t),u_lightcolor:new e.ci(t),u_vertical_gradient:new e.cj(t),u_opacity:new e.cj(t),u_edge_radius:new e.cj(t),u_width_scale:new e.cj(t),u_ao:new e.ck(t),u_height_type:new e.ch(t),u_base_type:new e.ch(t),u_tile_id:new e.ci(t),u_zoom_transition:new e.cj(t),u_inv_rot_matrix:new e.cl(t),u_merc_center:new e.ck(t),u_up_dir:new e.ci(t),u_height_lift:new e.cj(t),u_flood_light_color:new e.ci(t),u_vertical_scale:new e.cj(t),u_flood_light_intensity:new e.cj(t),u_ground_shadow_factor:new e.ci(t)}),fillExtrusionDepth:t=>({u_matrix:new e.cl(t),u_edge_radius:new e.cj(t),u_width_scale:new e.cj(t),u_vertical_scale:new e.cj(t),u_height_type:new e.ch(t),u_base_type:new e.ch(t)}),fillExtrusionPattern:t=>({u_matrix:new e.cl(t),u_lightpos:new e.ci(t),u_lightintensity:new e.cj(t),u_lightcolor:new e.ci(t),u_vertical_gradient:new e.cj(t),u_height_factor:new e.cj(t),u_edge_radius:new e.cj(t),u_width_scale:new e.cj(t),u_ao:new e.ck(t),u_height_type:new e.ch(t),u_base_type:new e.ch(t),u_tile_id:new e.ci(t),u_zoom_transition:new e.cj(t),u_inv_rot_matrix:new e.cl(t),u_merc_center:new e.ck(t),u_up_dir:new e.ci(t),u_height_lift:new e.cj(t),u_image:new e.ch(t),u_texsize:new e.ck(t),u_pixel_coord_upper:new e.ck(t),u_pixel_coord_lower:new e.ck(t),u_tile_units_to_pixels:new e.cj(t),u_opacity:new e.cj(t),u_pattern_transition:new e.cj(t)}),fillExtrusionGroundEffect:t=>({u_matrix:new e.cl(t),u_opacity:new e.cj(t),u_ao_pass:new e.cj(t),u_meter_to_tile:new e.cj(t),u_ao:new e.ck(t),u_flood_light_intensity:new e.cj(t),u_flood_light_color:new e.ci(t),u_attenuation:new e.cj(t),u_edge_radius:new e.cj(t),u_fb:new e.ch(t),u_fb_size:new e.cj(t),u_dynamic_offset:new e.cj(t)}),fill:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_ground_shadow_factor:new e.ci(t)}),fillPattern:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_image:new e.ch(t),u_texsize:new e.ck(t),u_pixel_coord_upper:new e.ck(t),u_pixel_coord_lower:new e.ck(t),u_tile_units_to_pixels:new e.cj(t),u_ground_shadow_factor:new e.ci(t),u_pattern_transition:new e.cj(t)}),fillOutline:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_world:new e.ck(t),u_ground_shadow_factor:new e.ci(t)}),fillOutlinePattern:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_world:new e.ck(t),u_image:new e.ch(t),u_texsize:new e.ck(t),u_pixel_coord_upper:new e.ck(t),u_pixel_coord_lower:new e.ck(t),u_tile_units_to_pixels:new e.cj(t),u_ground_shadow_factor:new e.ci(t),u_pattern_transition:new e.cj(t)}),building:t=>({u_matrix:new e.cl(t),u_normal_matrix:new e.cl(t),u_opacity:new e.cj(t),u_faux_facade_ao_intensity:new e.cj(t),u_camera_pos:new e.ci(t),u_tile_to_meter:new e.cj(t),u_facade_emissive_chance:new e.cj(t),u_flood_light_color:new e.ci(t),u_flood_light_intensity:new e.cj(t)}),buildingBloom:t=>({u_matrix:new e.cl(t)}),buildingDepth:t=>({u_matrix:new e.cl(t)}),elevatedStructuresDepth:t=>({u_matrix:new e.cl(t),u_depth_bias:new e.cj(t)}),elevatedStructures:t=>({u_matrix:new e.cl(t),u_ground_shadow_factor:new e.ci(t)}),elevatedStructuresDepthReconstruct:t=>({u_matrix:new e.cl(t),u_camera_pos:new e.ci(t),u_depth_bias:new e.cj(t),u_height_scale:new e.cj(t),u_reset_depth:new e.cj(t)}),circle:e.dY,collisionBox:t=>({u_matrix:new e.cl(t),u_inv_rot_matrix:new e.cl(t),u_camera_to_center_distance:new e.cj(t),u_extrude_scale:new e.ck(t),u_zoom_transition:new e.cj(t),u_merc_center:new e.ck(t),u_tile_id:new e.ci(t)}),collisionCircle:t=>({u_matrix:new e.cl(t),u_inv_matrix:new e.cl(t),u_camera_to_center_distance:new e.cj(t),u_viewport_size:new e.ck(t)}),debug:t=>({u_color:new e.dB(t),u_matrix:new e.cl(t),u_overlay:new e.ch(t),u_overlay_scale:new e.cj(t)}),clippingMask:t=>({u_matrix:new e.cl(t)}),heatmap:t=>({u_extrude_scale:new e.cj(t),u_intensity:new e.cj(t),u_matrix:new e.cl(t),u_inv_rot_matrix:new e.cl(t),u_merc_center:new e.ck(t),u_tile_id:new e.ci(t),u_zoom_transition:new e.cj(t),u_up_dir:new e.ci(t)}),heatmapTexture:t=>({u_image:new e.ch(t),u_color_ramp:new e.ch(t),u_opacity:new e.cj(t)}),hillshade:t=>({u_matrix:new e.cl(t),u_image:new e.ch(t),u_latrange:new e.ck(t),u_light:new e.ck(t),u_shadow:new e.dB(t),u_highlight:new e.dB(t),u_emissive_strength:new e.cj(t),u_accent:new e.dB(t)}),hillshadePrepare:t=>({u_matrix:new e.cl(t),u_image:new e.ch(t),u_dimension:new e.ck(t),u_zoom:new e.cj(t)}),line:e.dX,linePattern:e.dW,raster:t=>({u_matrix:new e.cl(t),u_normalize_matrix:new e.cl(t),u_globe_matrix:new e.cl(t),u_merc_matrix:new e.cl(t),u_grid_matrix:new e.dC(t),u_tl_parent:new e.ck(t),u_scale_parent:new e.cj(t),u_fade_t:new e.cj(t),u_opacity:new e.cj(t),u_image0:new e.ch(t),u_image1:new e.ch(t),u_brightness_low:new e.cj(t),u_brightness_high:new e.cj(t),u_saturation_factor:new e.cj(t),u_contrast_factor:new e.cj(t),u_spin_weights:new e.ci(t),u_perspective_transform:new e.ck(t),u_raster_elevation:new e.cj(t),u_zoom_transition:new e.cj(t),u_merc_center:new e.ck(t),u_cutoff_params:new e.d3(t),u_colorization_mix:new e.d3(t),u_colorization_offset:new e.cj(t),u_color_ramp:new e.ch(t),u_texture_offset:new e.ck(t),u_texture_res:new e.ck(t),u_emissive_strength:new e.cj(t)}),rasterParticle:t=>({u_matrix:new e.cl(t),u_normalize_matrix:new e.cl(t),u_globe_matrix:new e.cl(t),u_merc_matrix:new e.cl(t),u_grid_matrix:new e.dC(t),u_tl_parent:new e.ck(t),u_scale_parent:new e.cj(t),u_fade_t:new e.cj(t),u_opacity:new e.cj(t),u_image0:new e.ch(t),u_image1:new e.ch(t),u_raster_elevation:new e.cj(t),u_zoom_transition:new e.cj(t),u_merc_center:new e.ck(t),u_cutoff_params:new e.d3(t)}),rasterParticleTexture:t=>({u_texture:new e.ch(t),u_opacity:new e.cj(t)}),rasterParticleDraw:t=>({u_particle_texture:new e.ch(t),u_particle_texture_side_len:new e.cj(t),u_tile_offset:new e.ck(t),u_velocity:new e.ch(t),u_color_ramp:new e.ch(t),u_velocity_res:new e.ck(t),u_max_speed:new e.cj(t),u_uv_offset:new e.ck(t),u_data_scale:new e.ck(t),u_data_offset:new e.cj(t),u_particle_pos_scale:new e.cj(t),u_particle_pos_offset:new e.ck(t)}),rasterParticleUpdate:t=>({u_particle_texture:new e.ch(t),u_particle_texture_side_len:new e.cj(t),u_velocity:new e.ch(t),u_velocity_res:new e.ck(t),u_max_speed:new e.cj(t),u_speed_factor:new e.cj(t),u_reset_rate:new e.cj(t),u_rand_seed:new e.cj(t),u_uv_offset:new e.ck(t),u_data_scale:new e.ck(t),u_data_offset:new e.cj(t),u_particle_pos_scale:new e.cj(t),u_particle_pos_offset:new e.ck(t)}),symbol:t=>({u_is_size_zoom_constant:new e.ch(t),u_is_size_feature_constant:new e.ch(t),u_size_t:new e.cj(t),u_size:new e.cj(t),u_camera_to_center_distance:new e.cj(t),u_rotate_symbol:new e.ch(t),u_aspect_ratio:new e.cj(t),u_fade_change:new e.cj(t),u_matrix:new e.cl(t),u_label_plane_matrix:new e.cl(t),u_coord_matrix:new e.cl(t),u_is_text:new e.ch(t),u_elevation_from_sea:new e.ch(t),u_pitch_with_map:new e.ch(t),u_texsize:new e.ck(t),u_texsize_icon:new e.ck(t),u_texture:new e.ch(t),u_texture_icon:new e.ch(t),u_gamma_scale:new e.cj(t),u_device_pixel_ratio:new e.cj(t),u_tile_id:new e.ci(t),u_zoom_transition:new e.cj(t),u_inv_rot_matrix:new e.cl(t),u_merc_center:new e.ck(t),u_camera_forward:new e.ci(t),u_tile_matrix:new e.cl(t),u_up_vector:new e.ci(t),u_ecef_origin:new e.ci(t),u_is_halo:new e.ch(t),u_icon_transition:new e.cj(t),u_color_adj_mat:new e.cl(t),u_scale_factor:new e.cj(t),u_ground_shadow_factor:new e.ci(t),u_inv_matrix:new e.cl(t),u_normal_scale:new e.cj(t),u_lutTexture:new e.ch(t)}),background:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_opacity:new e.cj(t),u_color:new e.dB(t)}),backgroundPattern:t=>({u_matrix:new e.cl(t),u_emissive_strength:new e.cj(t),u_opacity:new e.cj(t),u_image:new e.ch(t),u_pattern_tl:new e.ck(t),u_pattern_br:new e.ck(t),u_texsize:new e.ck(t),u_pattern_size:new e.ck(t),u_pixel_coord_upper:new e.ck(t),u_pixel_coord_lower:new e.ck(t),u_pattern_units_to_pixels:new e.ck(t)}),terrainRaster:t=>({u_matrix:new e.cl(t),u_image0:new e.ch(t),u_image1:new e.ch(t),u_skirt_height:new e.cj(t),u_ground_shadow_factor:new e.ci(t),u_emissive_texture_available:new e.cj(t)}),skybox:t=>({u_matrix:new e.cl(t),u_sun_direction:new e.ci(t),u_cubemap:new e.ch(t),u_opacity:new e.cj(t),u_temporal_offset:new e.cj(t)}),skyboxGradient:t=>({u_matrix:new e.cl(t),u_color_ramp:new e.ch(t),u_center_direction:new e.ci(t),u_radius:new e.cj(t),u_opacity:new e.cj(t),u_temporal_offset:new e.cj(t)}),skyboxCapture:t=>({u_matrix_3f:new e.dC(t),u_sun_direction:new e.ci(t),u_sun_intensity:new e.cj(t),u_color_tint_r:new e.d3(t),u_color_tint_m:new e.d3(t),u_luminance:new e.cj(t)}),globeRaster:t=>({u_proj_matrix:new e.cl(t),u_globe_matrix:new e.cl(t),u_normalize_matrix:new e.cl(t),u_merc_matrix:new e.cl(t),u_zoom_transition:new e.cj(t),u_merc_center:new e.ck(t),u_image0:new e.ch(t),u_image1:new e.ch(t),u_grid_matrix:new e.dC(t),u_skirt_height:new e.cj(t),u_far_z_cutoff:new e.cj(t),u_frustum_tl:new e.ci(t),u_frustum_tr:new e.ci(t),u_frustum_br:new e.ci(t),u_frustum_bl:new e.ci(t),u_globe_pos:new e.ci(t),u_globe_radius:new e.cj(t),u_viewport:new e.ck(t),u_emissive_texture_available:new e.cj(t)}),globeAtmosphere:t=>({u_frustum_tl:new e.ci(t),u_frustum_tr:new e.ci(t),u_frustum_br:new e.ci(t),u_frustum_bl:new e.ci(t),u_horizon:new e.cj(t),u_transition:new e.cj(t),u_fadeout_range:new e.cj(t),u_atmosphere_fog_color:new e.d3(t),u_high_color:new e.d3(t),u_space_color:new e.d3(t),u_temporal_offset:new e.cj(t),u_horizon_angle:new e.cj(t)}),model:t=>({u_matrix:new e.cl(t),u_lighting_matrix:new e.cl(t),u_normal_matrix:new e.cl(t),u_node_matrix:new e.cl(t),u_lightpos:new e.ci(t),u_lightintensity:new e.cj(t),u_lightcolor:new e.ci(t),u_camera_pos:new e.ci(t),u_opacity:new e.cj(t),u_baseColorFactor:new e.d3(t),u_emissiveFactor:new e.d3(t),u_metallicFactor:new e.cj(t),u_roughnessFactor:new e.cj(t),u_baseTextureIsAlpha:new e.ch(t),u_alphaMask:new e.ch(t),u_alphaCutoff:new e.cj(t),u_baseColorTexture:new e.ch(t),u_metallicRoughnessTexture:new e.ch(t),u_normalTexture:new e.ch(t),u_occlusionTexture:new e.ch(t),u_emissionTexture:new e.ch(t),u_lutTexture:new e.ch(t),u_color_mix:new e.d3(t),u_aoIntensity:new e.cj(t),u_emissive_strength:new e.cj(t),u_occlusionTextureTransform:new e.d3(t)}),modelDepth:t=>({u_matrix:new e.cl(t),u_instance:new e.cl(t),u_node_matrix:new e.cl(t)}),groundShadow:t=>({u_matrix:new e.cl(t),u_ground_shadow_factor:new e.ci(t)}),stars:t=>({u_matrix:new e.cl(t),u_up:new e.ci(t),u_right:new e.ci(t),u_intensity_multiplier:new e.cj(t)}),snowParticle:t=>({u_modelview:new e.cl(t),u_projection:new e.cl(t),u_time:new e.cj(t),u_cam_pos:new e.ci(t),u_velocityConeAperture:new e.cj(t),u_velocity:new e.cj(t),u_horizontalOscillationRadius:new e.cj(t),u_horizontalOscillationRate:new e.cj(t),u_boxSize:new e.cj(t),u_billboardSize:new e.cj(t),u_simpleShapeParameters:new e.ck(t),u_screenSize:new e.ck(t),u_thinningCenterPos:new e.ck(t),u_thinningShape:new e.ci(t),u_thinningAffectedRatio:new e.cj(t),u_thinningParticleOffset:new e.cj(t),u_particleColor:new e.d3(t),u_direction:new e.ci(t)}),rainParticle:t=>({u_modelview:new e.cl(t),u_projection:new e.cl(t),u_time:new e.cj(t),u_cam_pos:new e.ci(t),u_texScreen:new e.ch(t),u_velocityConeAperture:new e.cj(t),u_velocity:new e.cj(t),u_boxSize:new e.cj(t),u_rainDropletSize:new e.ck(t),u_distortionStrength:new e.cj(t),u_rainDirection:new e.ci(t),u_color:new e.d3(t),u_screenSize:new e.ck(t),u_thinningCenterPos:new e.ck(t),u_thinningShape:new e.ci(t),u_thinningAffectedRatio:new e.cj(t),u_thinningParticleOffset:new e.cj(t),u_shapeDirectionalPower:new e.cj(t),u_shapeNormalPower:new e.cj(t),u_mode:new e.cj(t)}),vignette:t=>({u_vignetteShape:new e.ci(t),u_vignetteColor:new e.d3(t)}),occlusion:t=>({u_matrix:new e.cl(t),u_anchorPos:new e.ci(t),u_screenSizePx:new e.ck(t),u_occluderSizePx:new e.ck(t),u_color:new e.d3(t)})};class $r{constructor(e,t,r,o){this.id=$r.uniqueIdxCounter,$r.uniqueIdxCounter++,this.context=e;const s=e.gl;this.buffer=s.createBuffer(),this.dynamicDraw=Boolean(r),this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?s.DYNAMIC_DRAW:s.STATIC_DRAW),this.dynamicDraw||o||t.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=$r.uniqueIdxCounter,$r.uniqueIdxCounter++;const t=this.context.gl;this.context.unbindVAO(),this.bind(),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}$r.uniqueIdxCounter=0;const ka={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Yr{constructor(e,t,r,o,s,l){this.length=t.length,this.attributes=r,this.itemSize=t.bytesPerElement,this.dynamicDraw=o,this.instanceCount=l,this.context=e;const c=e.gl;this.buffer=c.createBuffer(),e.bindVertexBuffer.set(this.buffer),c.bufferData(c.ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?c.DYNAMIC_DRAW:c.STATIC_DRAW),this.dynamicDraw||s||t.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){const t=this.context.gl;this.bind(),t.bufferSubData(t.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,t){for(let r=0;r<this.attributes.length;r++){const o=t.getAttributeLocation(e,this.attributes[r].name);-1!==o&&e.enableVertexAttribArray(o)}}setVertexAttribPointers(e,t,r){for(let o=0;o<this.attributes.length;o++){const s=this.attributes[o],l=t.getAttributeLocation(e,s.name);-1!==l&&e.vertexAttribPointer(l,s.components,e[ka[s.type]],!1,this.itemSize,s.offset+this.itemSize*(r||0))}}setVertexAttribDivisor(e,t,r){for(let o=0;o<this.attributes.length;o++){const s=t.getAttributeLocation(e,this.attributes[o].name);-1!==s&&this.instanceCount&&this.instanceCount>0&&e.vertexAttribDivisor(s,r)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Kr{constructor(e,t,r,o,s){this.context=e,this.width=t,this.height=r;const l=this.framebuffer=e.gl.createFramebuffer();o>0&&(this.colorAttachment0=new Gs(e,l,0)),o>1&&(this.colorAttachment1=new Gs(e,l,1)),s&&(this.depthAttachmentType=s,this.depthAttachment="renderbuffer"===s?new Hs(e,l):new qs(e,l))}createColorAttachment(e,t){0===t?this.colorAttachment0=new Gs(e,this.framebuffer,0):1===t&&(this.colorAttachment1=new Gs(e,this.framebuffer,1))}removeColorAttachment(e,t){const r=this.context.gl;let o;0===t?(o=this.colorAttachment0.get(),this.colorAttachment0=void 0):1===t&&(o=this.colorAttachment1.get(),this.colorAttachment1=void 0),o&&r.deleteTexture(o)}destroy(){const e=this.context.gl;if(this.colorAttachment0){const t=this.colorAttachment0.get();t&&e.deleteTexture(t)}if(this.colorAttachment1){const t=this.colorAttachment1.get();t&&e.deleteTexture(t)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const t=this.depthAttachment.get();t&&e.deleteRenderbuffer(t)}else{const t=this.depthAttachment.get();t&&e.deleteTexture(t)}e.deleteFramebuffer(this.framebuffer)}}class Jr{constructor(e,t){this.gl=e,this.clearColor=new ds(this),this.clearDepth=new us(this),this.clearStencil=new _s(this),this.colorMask=new ps(this),this.depthMask=new fs(this),this.stencilMask=new ms(this),this.stencilFunc=new gs(this),this.stencilOp=new vs(this),this.stencilTest=new ys(this),this.depthRange=new xs(this),this.depthTest=new bs(this),this.depthFunc=new ws(this),this.blend=new Ts(this),this.blendFunc=new Es(this),this.blendColor=new Ss(this),this.blendEquation=new Is(this),this.cullFace=new Cs(this),this.cullFaceSide=new Rs(this),this.frontFace=new As(this),this.program=new vo(this),this.activeTexture=new Ds(this),this.viewport=new Ps(this),this.bindFramebuffer=new Os(this),this.bindRenderbuffer=new zs(this),this.bindTexture=new Ms(this),this.bindVertexBuffer=new Fs(this),this.bindElementBuffer=new Bs(this),this.bindVertexArrayOES=new ks(this),this.pixelStoreUnpack=new Ns(this),this.pixelStoreUnpackPremultiplyAlpha=new Us(this),this.pixelStoreUnpackFlipY=new js(this),this.options=t?Object.assign({},t):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=e.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=e.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=e.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=t&&!!t.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=e.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.extBlendFuncExtended=e.getExtension("WEBGL_blend_func_extended")}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,t,r){return new $r(this,e,t,r)}createVertexBuffer(e,t,r,o,s){return new Yr(this,e,t,r,o,s)}createRenderbuffer(e,t,r){const o=this.gl,s=o.createRenderbuffer();return this.bindRenderbuffer.set(s),o.renderbufferStorage(o.RENDERBUFFER,e,t,r),this.bindRenderbuffer.set(null),s}createFramebuffer(e,t,r,o){return new Kr(this,e,t,r,o)}clear({color:e,depth:t,stencil:r,colorMask:o}){const s=this.gl;let l=0;e&&(l|=s.COLOR_BUFFER_BIT,this.clearColor.set(e.toNonPremultipliedRenderColor(null)),this.colorMask.set(o||[!0,!0,!0,!0])),void 0!==t&&(l|=s.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(t),this.depthMask.set(!0)),void 0!==r&&(l|=s.STENCIL_BUFFER_BIT,this.clearStencil.set(r),this.stencilMask.set(255)),s.clear(l)}setCullFace(e){!1===e.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(t){e.by(t.blendFunction,Wi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Va;function Na(t,r,o,s,l,c,h){const u=t.context,d=u.gl,p=t.transform,f=[e.aF(p.center.lng),e.aJ(p.center.lat)],m=o.layout.get("symbol-placement"),_=o.layout.get("text-variable-anchor"),v="map"===o.layout.get("icon-rotation-alignment"),E="map"===o.layout.get("text-rotation-alignment"),P="point"!==m,C=[];let R=0,z=0;for(let u=0;u<s.length;u++){const m=s[u],D=r.getTile(m),O=D.getBucket(o);if(!O)continue;const F=O.getProjection().createInversionMatrix(p,m.canonical),B=[],k=vi(m,O,p),V=!h&&v&&P,N=h&&E&&P,U=_&&O.hasTextData(),j=O.hasIconTextFit()&&U&&O.hasIconData(),$=V||N||h&&U||j,q="globe"===O.projection.name,H=q?e.aj(p.zoom):0;q&&(B.push("PROJECTION_GLOBE_VIEW"),$&&B.push("PROJECTED_POS_ON_VIEWPORT"));const Z=t.getOrCreateProgram("collisionBox",{defines:B});let Y=k;0===l[0]&&0===l[1]||(Y=t.translatePosMatrix(k,D,l,c));const J=h?O.textCollisionBox:O.iconCollisionBox,Q=O.collisionCircleArray;if(Q.length>0){const t=e.bC(),r=Y;e.cP(t,O.placementInvProjMatrix,p.glCoordMatrix),e.cP(t,t,O.placementViewportMatrix),C.push({circleArray:Q,circleOffset:z,transform:r,invTransform:t,projection:O.getProjection()}),R+=Q.length/4,z=R}if(!J)continue;t.terrain&&t.terrain.setupElevationDraw(D,Z);const K=q?[m.canonical.x,m.canonical.y,1<<m.canonical.z]:[0,0,0];Z.draw(t,d.LINES,$i.disabled,Yi.disabled,t.colorModeForRenderPass(),Qi.disabled,sa(Y,F,p,H,f,D,K,O.getProjection()),o.id,J.layoutVertexBuffer,J.indexBuffer,J.segments,null,p.zoom,null,[J.collisionVertexBuffer,J.collisionVertexBufferExt])}if(!h||!C.length)return;const D=t.getOrCreateProgram("collisionCircle"),O=new e.dZ;O.resize(4*R),O._trim();let F=0;for(const e of C)for(let t=0;t<e.circleArray.length/4;t++){const r=4*t,o=e.circleArray[r+0],s=e.circleArray[r+1],l=e.circleArray[r+2],c=e.circleArray[r+3];O.emplace(F++,o,s,l,c,0),O.emplace(F++,o,s,l,c,1),O.emplace(F++,o,s,l,c,2),O.emplace(F++,o,s,l,c,3)}(!Va||Va.length<2*R)&&(Va=function(t){const r=2*t,o=new e.b0;o.resize(r),o._trim();for(let e=0;e<r;e++){const t=6*e;o.uint16[t+0]=4*e+0,o.uint16[t+1]=4*e+1,o.uint16[t+2]=4*e+2,o.uint16[t+3]=4*e+2,o.uint16[t+4]=4*e+3,o.uint16[t+5]=4*e+0}return o}(R));const B=u.createIndexBuffer(Va,!0),k=u.createVertexBuffer(O,e.d_.members,!0);for(const r of C){const s=aa(r.transform,r.invTransform,p,r.projection);D.draw(t,d.TRIANGLES,$i.disabled,Yi.disabled,t.colorModeForRenderPass(),Qi.disabled,s,o.id,k,B,e.bg.simpleSegment(0,2*r.circleOffset,r.circleArray.length,r.circleArray.length/2),null,p.zoom)}k.destroy(),B.destroy()}const Ua=e.bC();function Ga(t){const r=t._camera.getWorldToCamera(t.worldSize,1),o=e.aB([],r,t.globeMatrix);e.bl(o,o);const s=[0,0,0],l=[0,1,0,0];return e.aC(l,l,o),s[0]=l[0],s[1]=l[1],s[2]=l[2],e.aw(s,s),s}function Ya({width:t,height:r,anchor:o,textOffset:s,textScale:l},c){const{horizontalAlign:h,verticalAlign:u}=e.c1(o),d=-(h-.5)*t,p=-(u-.5)*r,f=e.c2(o,s);return new e.P((d/l+f[0])*c,(p/l+f[1])*c)}function Ul(t,r,o,s,l,c,h,u,d,p){const f=t.text.placedSymbolArray,m=t.text.dynamicLayoutVertexArray,_=t.icon.dynamicLayoutVertexArray,v={},E=t.getProjection(),P=Pi(h,E,l),C=l.elevation,R=E.upVectorScale(h.canonical,l.center.lat,l.worldSize).metersToTile;m.clear();for(let _=0;_<f.length;_++){const z=f.get(_),{tileAnchorX:D,tileAnchorY:O,numGlyphs:F}=z,B=z.hidden||!z.crossTileID||t.allowVerticalPlacement&&!z.placedOrientation?null:s[z.crossTileID];if(B){let s=0,f=0,k=0;const V="road"===t.elevationType;if(C||V){const r=V?t.getElevationFeatureForText(_):null,o=e.bV.getAtTileOffset(h,new e.P(D,O),C,r),[l,c,u]=E.upVector(h.canonical,D,O);s=o*l*R,f=o*c*R,k=o*u*R}let[N,U,j,$]=Fi(z.projectedAnchorX+s,z.projectedAnchorY+f,z.projectedAnchorZ+k,o?P:c);const q=Bi(l.getCameraToCenterDistance(E),$);let H=e.bM(t.textSizeData,d,z)*q/e.bY;o&&(H*=t.tilePixelRatio/u);const Z=Ya(B,H);o?(({x:N,y:U,z:j}=E.projectTilePoint(D+Z.x,O+Z.y,h.canonical)),[N,U,j]=Fi(N+s,U+f,j+k,c)):(r&&Z._rotate(-l.angle),N+=Z.x,U+=Z.y,j=0);const Y=t.allowVerticalPlacement&&z.placedOrientation===e.bL.vertical?Math.PI/2:0;for(let t=0;t<F;t++)e.bO(m,N,U,j,Y);p&&z.associatedIconIndex>=0&&(v[z.associatedIconIndex]={x:N,y:U,z:j,angle:Y})}else mr(F,m)}if(p){_.clear();const r=t.icon.placedSymbolArray;for(let t=0;t<r.length;t++){const o=r.get(t),{numGlyphs:s}=o,l=v[t];if(o.hidden||!l)mr(s,_);else{const{x:t,y:r,z:o,angle:c}=l;for(let l=0;l<s;l++)e.bO(_,t,r,o,c)}}t.icon.dynamicLayoutVertexBuffer.updateData(_)}t.text.dynamicLayoutVertexBuffer.updateData(m)}function Gl(t,r,o,s,l,c,h={}){const u=o.paint.get("icon-translate"),d=o.paint.get("text-translate"),p=o.paint.get("icon-translate-anchor"),f=o.paint.get("text-translate-anchor"),m=o.layout.get("icon-rotation-alignment"),_=o.layout.get("text-rotation-alignment"),v=o.layout.get("icon-pitch-alignment"),E=o.layout.get("text-pitch-alignment"),P=o.layout.get("icon-keep-upright"),C=o.layout.get("text-keep-upright"),R=o.paint.get("icon-color-saturation"),z=o.paint.get("icon-color-contrast"),D=o.paint.get("icon-color-brightness-min"),O=o.paint.get("icon-color-brightness-max"),F="sea"===o.layout.get("symbol-elevation-reference"),B="none"===o.layout.get("icon-image-use-theme"),k=t.context,V=k.gl,N=t.transform,U="map"===m,j="map"===_,$="map"===v,q="map"===E,H=void 0!==o.layout.get("symbol-sort-key").constantOr(1);let Z=!1;const Y=t.depthModeForSublayer(0,$i.ReadOnly),J=new $i(t.context.gl.LEQUAL,$i.ReadOnly,t.depthRangeFor3D),Q=[e.aF(N.center.lng),e.aJ(N.center.lat)],K=o.layout.get("text-variable-anchor"),ee="globe"===N.projection.name,te=[],ie=[0,-1,0];for(const l of s){const s=r.getTile(l),c=s.getBucket(o);if(!c)continue;if("mercator"===c.projection.name&&ee)continue;if(c.fullyClipped)continue;const m="globe"===c.projection.name,_=m?e.aj(N.zoom):0,v=Pi(l,c.getProjection(),N),E=N.calculatePixelsToTileUnitsMatrix(s),re=K&&c.hasTextData(),ne=c.hasIconTextFit()&&re&&c.hasIconData(),oe=c.getProjection().createInversionMatrix(N,l.canonical),se=(1<<s.tileID.canonical.z)*e.al/t.transform.worldSize,ae=e=>{let r=[0,0,0];if(e){const e=t.style.directionalLight,o=t.style.ambientLight;e&&o&&(r=hn(t.style,e,o))}return r},le=e=>{N.depthOcclusionForSymbolsAndCircles&&(o.hasOcclusionOpacityProperties||t.terrain)&&(e.push("DEPTH_D24"),e.push("DEPTH_OCCLUSION"))},ce=r=>{o.lut&&!B&&(o.lut.texture||(o.lut.texture=new e.d$(t.context,o.lut.image,[o.lut.image.height,o.lut.image.height,o.lut.image.height],k.gl.RGBA8)),k.activeTexture.set(k.gl.TEXTURE0+10),o.lut.texture&&o.lut.texture.bind(k.gl.LINEAR,k.gl.CLAMP_TO_EDGE),r.push("APPLY_LUT_ON_GPU"))},he=()=>{const r=U&&"point"!==o.layout.get("symbol-placement"),h=[];le(h),ce(h);const d=r||ne,f="road"===c.elevationType,C=t.shadowRenderer,B=f&&$&&!!C&&C.enabled,k=ae(B),j=f&&$&&!t.terrain?J:Y,q=o.paint.get("icon-image-cross-fade");t.terrainRenderModeElevated()&&$&&h.push("PITCH_WITH_MAP_TERRAIN"),m&&(h.push("PROJECTION_GLOBE_VIEW"),d&&h.push("PROJECTED_POS_ON_VIEWPORT")),q>0&&c.hasAnySecondaryIcon&&h.push("ICON_TRANSITION"),!c.icon.zOffsetVertexBuffer||f&&t.terrain||h.push("Z_OFFSET"),0===R&&0===z&&0===D&&1===O||h.push("COLOR_ADJUSTMENT"),c.sdfIcons&&h.push("RENDER_SDF"),B&&h.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),f&&$&&!t.terrain&&c.icon.orientationVertexBuffer&&h.push("ELEVATED_ROADS");const H=c.icon.programConfigurations.get(o.id),Z=t.getOrCreateProgram("symbol",{config:H,defines:h}),K=s.imageAtlasTexture?s.imageAtlasTexture.size:[0,0],te=c.iconSizeData,re=e.bK(te,N.zoom),he=$||!N.isOrthographic,ue=Di(v,s.tileID.canonical,$,U,N,c.getProjection(),E),de=Oi(v,s.tileID.canonical,$,U,N,c.getProjection(),E),pe=t.translatePosMatrix(de,s,u,p,!0),fe=t.translatePosMatrix(v,s,u,p),me=d?Ua:ue,ge=U&&!$&&!r;let ye=ie;!ee&&!N.mercatorFromTransition||U||(ye=Ga(N));const xe=m?ye:ie,ve=o.getColorAdjustmentMatrix(R,z,D,O),be=Ma(te.kind,re,ge,$,t,fe,me,pe,F,!1,K,[0,0],0,l,_,Q,oe,xe,c.getProjection(),k,se,ve,q,null),we=s.imageAtlasTexture?s.imageAtlasTexture:null,Ie=1!==o.layout.get("icon-size").constantOr(0)||c.iconsNeedLinear,Ee=c.sdfIcons||t.options.rotating||t.options.zooming||Ie||he?V.LINEAR:V.NEAREST,Ae=c.sdfIcons&&0!==o.paint.get("icon-halo-width").constantOr(1),Me=t.terrain&&$&&r?e.bl(e.bC(),ue):Ua;if(r&&c.icon){const r=e.bV.getAtTileOffsetFunc(l,N.center.lat,N.worldSize,c.getProjection()),h=Li(v,s.tileID.canonical,$,U,N,c.getProjection(),E),u=o.layout.get("icon-size-scale-range"),d=e.aA(t.scaleFactor,u[0],u[1]);ji(c,v,t,!1,h,de,$,P,r,l,d)}return{program:Z,buffers:c.icon,uniformValues:be,atlasTexture:we,atlasTextureIcon:null,atlasInterpolation:Ee,atlasInterpolationIcon:null,isSDF:c.sdfIcons,hasHalo:Ae,depthMode:j,tile:s,renderWithShadows:B,labelPlaneMatrixInv:Me}},ue=()=>{const r=j&&"point"!==o.layout.get("symbol-placement"),h=[],u=r||K||ne,p="road"===c.elevationType,P=t.shadowRenderer,R=p&&q&&!!P&&P.enabled,z=ae(R),D=p&&q&&!t.terrain?J:Y;t.terrainRenderModeElevated()&&q&&h.push("PITCH_WITH_MAP_TERRAIN"),m&&(h.push("PROJECTION_GLOBE_VIEW"),u&&h.push("PROJECTED_POS_ON_VIEWPORT")),!c.text.zOffsetVertexBuffer||p&&t.terrain||h.push("Z_OFFSET"),c.iconsInText&&h.push("RENDER_TEXT_AND_SYMBOL"),h.push("RENDER_SDF"),R&&h.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),p&&q&&!t.terrain&&c.text.orientationVertexBuffer&&h.push("ELEVATED_ROADS"),le(h);const O=c.text.programConfigurations.get(o.id),B=t.getOrCreateProgram("symbol",{config:O,defines:h});let k,U=[0,0],$=null;const H=c.textSizeData;c.iconsInText&&(U=s.imageAtlasTexture?s.imageAtlasTexture.size:[0,0],$=s.imageAtlasTexture?s.imageAtlasTexture:null,k=q||!N.isOrthographic||t.options.rotating||t.options.zooming||"composite"===H.kind||"camera"===H.kind?V.LINEAR:V.NEAREST);const Z=s.glyphAtlasTexture?s.glyphAtlasTexture.size:[0,0],te=o.layout.get("text-size-scale-range"),re=e.aA(t.scaleFactor,te[0],te[1]),ce=e.bK(H,N.zoom,re),he=Di(v,s.tileID.canonical,q,j,N,c.getProjection(),E),ue=Oi(v,s.tileID.canonical,q,j,N,c.getProjection(),E),de=t.translatePosMatrix(ue,s,d,f,!0),pe=t.translatePosMatrix(v,s,d,f),fe=u?Ua:he,me=j&&!q&&!r;let ge=ie;!ee&&!N.mercatorFromTransition||j||(ge=Ga(N));const ye=Ma(H.kind,ce,me,q,t,pe,fe,de,F,!0,Z,U,0,l,_,Q,oe,m?ge:ie,c.getProjection(),z,se,null,null,re),xe=s.glyphAtlasTexture?s.glyphAtlasTexture:null,ve=V.LINEAR,be=0!==o.paint.get("text-halo-width").constantOr(1),we=t.terrain&&q&&r?e.bl(e.bC(),he):Ua;if(r&&c.text){const r=e.bV.getAtTileOffsetFunc(l,N.center.lat,N.worldSize,c.getProjection()),o=Li(v,s.tileID.canonical,q,j,N,c.getProjection(),E);ji(c,v,t,!0,o,ue,q,C,r,l,re)}return{program:B,buffers:c.text,uniformValues:ye,atlasTexture:xe,atlasTextureIcon:$,atlasInterpolation:ve,atlasInterpolationIcon:k,isSDF:!0,hasHalo:be,depthMode:D,tile:s,renderWithShadows:R,labelPlaneMatrixInv:we}},de=c.icon.segments.get().length,pe=c.text.segments.get().length,fe=de&&!h.onlyText?he():null,me=pe&&!h.onlyIcons?ue():null,ge=o.paint.get("icon-opacity").constantOr(1),ye=o.paint.get("text-opacity").constantOr(1);if(H&&c.canOverlap){Z=!0;const t=ge&&!h.onlyText?c.icon.segments.get():[],r=ye&&!h.onlyIcons?c.text.segments.get():[];for(const r of t)te.push({segments:new e.bg([r]),sortKey:r.sortKey,state:fe});for(const t of r)te.push({segments:new e.bg([t]),sortKey:t.sortKey,state:me})}else h.onlyText||te.push({segments:ge?c.icon.segments:new e.bg([]),sortKey:0,state:fe}),h.onlyIcons||te.push({segments:ye?c.text.segments:new e.bg([]),sortKey:0,state:me})}Z&&te.sort(((e,t)=>e.sortKey-t.sortKey));for(const e of te){const r=e.state;if(r)if(t.terrain?t.terrain.setupElevationDraw(r.tile,r.program,{useDepthForOcclusion:N.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:r.labelPlaneMatrixInv}):t.setupDepthForOcclusion(N.depthOcclusionForSymbolsAndCircles,r.program),k.activeTexture.set(V.TEXTURE0),r.atlasTexture&&r.atlasTexture.bind(r.atlasInterpolation,V.CLAMP_TO_EDGE,!0),r.atlasTextureIcon&&(k.activeTexture.set(V.TEXTURE1),r.atlasTextureIcon&&r.atlasTextureIcon.bind(r.atlasInterpolationIcon,V.CLAMP_TO_EDGE,!0)),r.renderWithShadows&&t.shadowRenderer.setupShadows(r.tile.tileID.toUnwrapped(),r.program,"vector-tile"),t.uploadCommonLightUniforms(t.context,r.program),r.hasHalo){const s=r.uniformValues;s.u_is_halo=1,ql(r.buffers,e.segments,o,t,r.program,r.depthMode,l,c,s,2),s.u_is_halo=0}else{if(r.isSDF){const s=r.uniformValues;r.hasHalo&&(s.u_is_halo=1,ql(r.buffers,e.segments,o,t,r.program,r.depthMode,l,c,s,1)),s.u_is_halo=0}ql(r.buffers,e.segments,o,t,r.program,r.depthMode,l,c,r.uniformValues,1)}}}function ql(e,t,r,o,s,l,c,h,u,d){const p=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer,e.zOffsetVertexBuffer,e.orientationVertexBuffer];s.draw(o,o.context.gl.TRIANGLES,l,c,h,Qi.disabled,u,r.id,e.layoutVertexBuffer,e.indexBuffer,t,r.paint,o.transform.zoom,e.programConfigurations.get(r.id),p,d)}function Hl(t,r){const o=1<<t.canonical.z,s=(r.x*o-t.canonical.x-t.wrap*o)*e.al,l=(r.y*o-t.canonical.y)*e.al,c=e.e8(r.z,r.y);return e.d5(s,l,c)}function Xl(t,r,o,s,l){if(!o.layout||"none"===o.layout.get("fill-elevation-reference")||0===o.paint.get("fill-opacity").constantOr(1))return;const c=t.context.gl,h=new $i(t.context.gl.LEQUAL,$i.ReadWrite,t.depthRangeFor3D),u=new $i(t.context.gl.GREATER,$i.ReadWrite,t.depthRangeFor3D),d=function(t){let r=.01;return t.isOrthographic&&(r=e.ak(1e-4,r,e.d0(t.pitch>=en?1:t.pitch/en))),2*r}(t.transform),p=t.transform.getFreeCameraOptions().position,f="elevatedStructuresDepthReconstruct",m=t.getOrCreateProgram(f,{defines:["DEPTH_RECONSTRUCTION"]}),_=t.getOrCreateProgram(f);for(const e of s){const s=r.getTile(e),f=s.getBucket(o);if(!f)continue;const v=f.elevatedStructures;if(!v)continue;const E=f.elevationBufferData.heightRange,P=Hl(e.toUnwrapped(),p),C=t.translatePosMatrix(e.projMatrix,s,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor"));let R,z,D,O;if("initialize"===l){if(!E||E.min>=1||0===v.depthSegments.segments[0].primitiveLength)continue;R=ia(C,P,d,1,0),z=h,D=v.depthSegments,O=m}else if("reset"===l){if(!E||E.min>=0||0===v.maskSegments.segments[0].primitiveLength)continue;R=ia(C,P,0,0,1),z=u,D=v.maskSegments,O=m}else if("geometry"===l){if(0===v.depthSegments.segments[0].primitiveLength)continue;R=ia(C,P,d,1,0),z=h,D=v.depthSegments,O=_}O.draw(t,c.TRIANGLES,z,Yi.disabled,Wi.disabled,Qi.disabled,R,o.id,v.vertexBuffer,v.indexBuffer,D,o.paint,t.transform.zoom)}}function ec(t,r,o,s){const{painter:l,sourceCache:c,layer:h,coords:u,colorMode:d,elevationType:p,terrainEnabled:f,pass:m}=t,_=l.context.gl,v=h.paint.get("fill-pattern"),E=h.paint.get("fill-pattern-cross-fade"),P=v.constantOr(null);let C=p;"road"!==p||r&&!f||(C="none");const R="road"===C,z=t.painter.shadowRenderer,D=R&&!!z&&z.enabled,O=new $i(l.context.gl.LEQUAL,$i.ReadOnly,l.depthRangeFor3D);let F=[0,0,0];if(D){const e=l.style.directionalLight,t=l.style.ambientLight;e&&t&&(F=hn(l.style,e,t))}const B=v&&v.constantOr(1),k=l.terrain&&l.terrain.renderingToTexture,V=(t,m)=>{let v,C,V,N,U;m?(v=B&&!h.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",V=_.LINES):(v=B?"fillPattern":"fill",V=_.TRIANGLES);for(const j of u){const u=c.getTile(j);if(B&&!u.patternsLoaded())continue;const $=u.getBucket(h);if(!$)continue;const q=r?$.elevationBufferData:$.bufferData;if(q.isEmpty())continue;l.prepareDrawTile();const H=q.programConfigurations.get(h.id),Z=l.isTileAffectedByFog(j),Y=[],J=[];R&&(Y.push("ELEVATED_ROADS"),J.push(q.elevatedLayoutVertexBuffer)),D&&Y.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),k&&o&&Y.push("USE_MRT1"),B&&(l.context.activeTexture.set(_.TEXTURE0),u.imageAtlasTexture&&u.imageAtlasTexture.bind(_.LINEAR,_.CLAMP_TO_EDGE),H.updatePaintBuffers());let Q=!1;if(P&&u.imageAtlas){const t=u.imageAtlas,r=e.e3.from(P),o=r.getPrimary().scaleSelf(e.o.devicePixelRatio).toString(),s=r.getSecondary(),l=t.patternPositions.get(o),c=s?t.patternPositions.get(s.scaleSelf(e.o.devicePixelRatio).toString()):null;Q=!!l&&!!c,l&&H.setConstantPatternPositions(l,c)}E>0&&(Q||H.getPatternTransitionVertexBuffer("fill-pattern"))&&Y.push("FILL_PATTERN_TRANSITION");const K=l.getOrCreateProgram(v,{config:H,overrideFog:Z,defines:Y}),ee=l.translatePosMatrix(j.projMatrix,u,h.paint.get("fill-translate"),h.paint.get("fill-translate-anchor"));D&&z.setupShadows(u.tileID.toUnwrapped(),K,"vector-tile");const te=h.paint.get("fill-emissive-strength");if(m){N=q.lineIndexBuffer,U=q.lineSegments;const e=l.terrain&&l.terrain.renderingToTexture?l.terrain.drapeBufferSize:[_.drawingBufferWidth,_.drawingBufferHeight];C="fillOutlinePattern"===v&&B?Ks(ee,te,l,u,e,F,E):Qs(ee,te,e,F)}else N=q.indexBuffer,U=q.triangleSegments,C=B?Js(ee,te,l,u,F,E):Ys(ee,te,F);l.uploadCommonUniforms(l.context,K,j.toUnwrapped());let ie=t;("road"===p&&!f||"offset"===p)&&(ie=O),K.draw(l,V,ie,s||l.stencilModeForClipping(j),d,Qi.disabled,C,h.id,q.layoutVertexBuffer,N,U,h.paint,l.transform.zoom,H,J)}};l.renderPass===m&&V(l.depthModeForSublayer(1,"opaque"===l.renderPass?$i.ReadWrite:$i.ReadOnly),!1),"none"===C&&"translucent"===l.renderPass&&h.paint.get("fill-antialias")&&V(l.depthModeForSublayer(h.getPaintProperty("fill-outline-color")?2:0,$i.ReadOnly),!0)}function tc(t,r,o,s,l,c,h,u){o.resetLayerRenderingStats(t);const d=t.context,p=d.gl,f=t.transform,m=o.paint.get("fill-extrusion-pattern"),_=o.paint.get("fill-extrusion-pattern-cross-fade"),v=m.constantOr(null),E=m.constantOr(1),P=o.paint.get("fill-extrusion-opacity"),C=t.style.enable3dLights(),R=o.paint.get(C&&!E?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),R],D=o.layout.get("fill-extrusion-edge-radius"),O=D>0&&!o.paint.get("fill-extrusion-rounded-roof"),F=O?0:D,B="globe"===f.projection.name?e.eb():0,k="globe"===f.projection.name,V=k?e.aj(f.zoom):0,N=[e.aF(f.center.lng),e.aJ(f.center.lat)],U="none"===o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),j=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(U?null:o.lut).toArray01().slice(0,3),$=o.paint.get("fill-extrusion-flood-light-intensity"),q=o.paint.get("fill-extrusion-vertical-scale"),H=0!==o.paint.get("fill-extrusion-line-width").constantOr(1),Z=o.paint.get("fill-extrusion-height-alignment"),Y=o.paint.get("fill-extrusion-base-alignment"),J=tn(t,o.paint.get("fill-extrusion-cutoff-fade-range")),Q=[];let K;k&&Q.push("PROJECTION_GLOBE_VIEW"),z[0]>0&&Q.push("FAUX_AO"),O&&Q.push("ZERO_ROOF_RADIUS"),u&&Q.push("HAS_CENTROID"),$>0&&Q.push("FLOOD_LIGHT"),J.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),H&&Q.push("RENDER_WALL_MODE");const ee="shadow"===t.renderPass,te=t.shadowRenderer,ie=ee&&!!te,re=ee?Qi.disabled:Qi.backCCW;t.shadowRenderer&&(t.shadowRenderer.useNormalOffset=!0);let ne=[0,0,0];if(te){const e=t.style.directionalLight,r=t.style.ambientLight;e&&r&&(ne=hn(t.style,e,r)),ee||(Q.push("RENDER_SHADOWS","DEPTH_TEXTURE"),te.useNormalOffset&&Q.push("NORMAL_OFFSET")),K=Q.concat(["SHADOWS_SINGLE_CASCADE"])}const oe=ie?"fillExtrusionDepth":E?"fillExtrusionPattern":"fillExtrusion",se=o.getLayerRenderingStats();for(const m of s){const s=r.getTile(m),C=s.getBucket(o);if(!C||C.projection.name!==f.projection.name)continue;let R=!1;te&&(R=0===te.getMaxCascadeForTile(m.toUnwrapped()));const D=t.isTileAffectedByFog(m),O=C.programConfigurations.get(o.id);let U=!1;if(v&&s.imageAtlas){const t=s.imageAtlas,r=e.e3.from(v),o=r.getPrimary().scaleSelf(e.o.devicePixelRatio).toString(),l=r.getSecondary(),c=t.patternPositions.get(o),h=l?t.patternPositions.get(l.scaleSelf(e.o.devicePixelRatio).toString()):null;U=!!c&&!!h,c&&O.setConstantPatternPositions(c,h)}_>0&&(U||O.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&Q.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ie=t.getOrCreateProgram(oe,{config:O,defines:R?K:Q,overrideFog:D});if(t.terrain&&t.terrain.setupElevationDraw(s,ie,{useMeterToDem:!0}),!C.centroidVertexBuffer){const e=ie.getAttributeLocation(p,"a_centroid_pos");-1!==e&&p.vertexAttrib2f(e,0,0)}!ee&&te&&te.setupShadows(s.tileID.toUnwrapped(),ie,"vector-tile"),E&&(t.context.activeTexture.set(p.TEXTURE0),s.imageAtlasTexture&&s.imageAtlasTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE),O.updatePaintBuffers());const ae=o.paint.get("fill-extrusion-vertical-gradient"),le=1/C.tileToMeter;let ce;if(ee&&te){if(hc(s.tileID,C.maxHeight,t))continue;const e=te.calculateShadowPassMatrixFromTile(s.tileID.toUnwrapped());ce=Ls(e,F,le,q,Z,Y)}else{const e=t.translatePosMatrix(m.expandedProjMatrix,s,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),r=f.projection.createInversionMatrix(f,m.canonical);ce=E?Ws(e,t,ae,P,z,F,le,m,s,B,Z,Y,V,N,r,j,q,_):cs(e,t,ae,P,z,F,le,m,B,Z,Y,V,N,r,j,q,$,ne)}t.uploadCommonUniforms(d,ie,m.toUnwrapped(),null,J);let he=C.segments;if("mercator"===f.projection.name&&!ee&&(he=C.getVisibleSegments(s.tileID,t.terrain,t.transform.getFrustum(0)),!he.get().length))continue;if(se)if(ee)for(const e of he.get())se.numRenderedVerticesInShadowPass+=e.primitiveLength;else for(const e of he.get())se.numRenderedVerticesInTransparentPass+=e.primitiveLength;const ue=[];(t.terrain||u)&&ue.push(C.centroidVertexBuffer),k&&ue.push(C.layoutVertexExtBuffer),H&&ue.push(C.wallVertexBuffer),ie.draw(t,d.gl.TRIANGLES,l,c,h,re,ce,o.id,C.layoutVertexBuffer,C.indexBuffer,he,o.paint,t.transform.zoom,O,ue)}t.shadowRenderer&&(t.shadowRenderer.useNormalOffset=!1)}class un{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function nc(t,r,o,s,l,c,h,u,d,p,f,m,_,v,E,P,C,R,z,D){const O=r.context,F=O.gl,B=r.transform,k=r.transform.zoom,V=[],N=t.translate,U=t.translateAnchor,j=t.edgeRadius,$=tn(r,t.cutoffFadeRange);"clear"===f?(V.push("CLEAR_SUBPASS"),D&&(V.push("CLEAR_FROM_TEXTURE"),O.activeTexture.set(F.TEXTURE0),D.bind(F.LINEAR,F.CLAMP_TO_EDGE))):"sdf"===f?V.push("SDF_SUBPASS"):"emissive"===f&&(V.push("USE_MRT1"),O.activeTexture.set(F.TEXTURE0),D.bind(F.LINEAR,F.CLAMP_TO_EDGE)),R&&V.push("HAS_CENTROID"),$.shouldRenderCutoff&&V.push("RENDER_CUTOFF");const q=(e,t,o,l,f)=>{let z=V;null!=t.groundRadiusBuffer&&(z=V.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const F=t.programConfigurations.get(s.id),B=r.isTileAffectedByFog(e),N=r.getOrCreateProgram("fillExtrusionGroundEffect",{config:F,defines:z,overrideFog:B}),U=((e,t,r,o,s,l,c,h,u,d,p)=>({u_matrix:t,u_opacity:r,u_ao_pass:o?1:0,u_meter_to_tile:s,u_ao:l,u_flood_light_intensity:c,u_flood_light_color:h,u_attenuation:u,u_edge_radius:d,u_fb:0,u_fb_size:p,u_dynamic_offset:1}))(0,l,m,p,f,[_,v*f],E,P,C,k>=17?0:j*f,D?D.size[0]:0),q=[];R&&q.push(t.hiddenByLandmarkVertexBuffer),null!=t.groundRadiusBuffer&&q.push(t.groundRadiusBuffer),r.uploadCommonUniforms(O,N,e.toUnwrapped(),null,$),N.draw(r,O.gl.TRIANGLES,c,h,u,d,U,s.id,t.vertexBuffer,t.indexBuffer,o,s.paint,k,F,q)};for(const t of l){const l=o.getTile(t),c=l.getBucket(s);if(!c||c.projection.name!==B.projection.name||!c.groundEffect||c.groundEffect&&!c.groundEffect.hasData())continue;const h=c.groundEffect,u=1/c.tileToMeter;{const e=r.translatePosMatrix(t.projMatrix,l,N,U),o=h.getDefaultSegment();q(t,h,o,e,u)}if(z)for(let c=0;c<4;c++){const h=e.e9[c](t),d=o.getTile(h);if(!d)continue;const p=d.getBucket(s);if(!p||p.projection.name!==B.projection.name||!p.groundEffect||p.groundEffect&&!p.groundEffect.hasData())continue;const f=p.groundEffect;let m,_;0===c?(m=[-e.al,0,0],_=1):1===c?(m=[e.al,0,0],_=0):2===c?(m=[0,-e.al,0],_=3):(m=[0,e.al,0],_=2);const v=f.regionSegments[_];if(!v)continue;const E=new Float32Array(16);e.br(E,t.projMatrix,m),q(t,f,v,r.translatePosMatrix(E,l,N,U),u)}}}function oc(t,r,o,s,l,c,h){0===s.centroidVertexArray.length&&s.createCentroidsBuffer();const u=c?c.findDEMTileFor(o):null;if(!(u&&u.dem||h))return;c&&u&&u.dem&&s.selfDEMTileTimestamp!==u.dem._timestamp&&(s.borderDoneWithNeighborZ=[-1,-1,-1,-1],s.selfDEMTileTimestamp=u.dem._timestamp);const d=(t,r)=>{(t.flags|r.flags)&e.ec?(t.flags|=e.ec,r.flags|=e.ec):(t.flags&=~e.ec,r.flags&=~e.ec)},p=t=>new e.P(Math.ceil((t+e.ed)*e.ee),0),f=e=>{const t=r.getSource().minzoom,o=e=>{const t=r.getTileByID(e);if(t&&t.hasData())return t.getBucket(l)},s=[0,-1,1];for(const r of s){if(e.overscaledZ+r<t)continue;const s=o(e.calculateScaledKey(e.overscaledZ+r));if(s)return s}},m=[0,0,0],_=(t,r)=>(m[0]=Math.min(t.min.y,r.min.y),m[1]=Math.max(t.max.y,r.max.y),m[2]=e.al-r.min.x>t.max.x?r.min.x-e.al:t.max.x,m),v=(t,r)=>(m[0]=Math.min(t.min.x,r.min.x),m[1]=Math.max(t.max.x,r.max.x),m[2]=e.al-r.min.y>t.max.y?r.min.y-e.al:t.max.y,m),E=[(e,t)=>_(e,t),(e,t)=>_(t,e),(e,t)=>v(e,t),(e,t)=>v(t,e)],P=(t,r,s,l,h,d,p)=>{if(!c)return 0;const f=[[d?s:t,d?t:s,0],[d?s:r,d?r:s,0]],m=p<0?e.al+p:p,_=[d?m:(t+r)/2,d?(t+r)/2:m,0];return 0===s&&p<0||0!==s&&p>0?c.getForTilePoints(h,[_],!0,l):f.push(_),c.getForTilePoints(o,f,!0,u),Math.max(f[0][2],f[1][2],_[2])/c.exaggeration()};for(let t=0;t<4;t++){const r=s.borderFeatureIndices[t];if(0===r.length)continue;const l=e.e9[t](o),u=f(l);if(!(u&&u instanceof e.ea))continue;const m=c?c.findDEMTileFor(l):null;if(!(m&&m.dem||h))continue;if(c&&m&&m.dem&&s.borderDEMTileTimestamp[t]!==m.dem._timestamp&&(s.borderDoneWithNeighborZ[t]=-1,s.borderDEMTileTimestamp[t]=m.dem._timestamp),s.borderDoneWithNeighborZ[t]===u.canonical.z)continue;0===u.centroidVertexArray.length&&u.createCentroidsBuffer();const _=(t<2?1:5)-t,v=u.borderDoneWithNeighborZ[_]!==s.canonical.z,C=u.borderFeatureIndices[_];let R=0;if(s.canonical.z!==u.canonical.z){for(const e of r)s.showCentroid(s.featuresOnBorder[e]);if(v)for(const e of C)u.showCentroid(u.featuresOnBorder[e]);s.borderDoneWithNeighborZ[t]=u.canonical.z,u.borderDoneWithNeighborZ[_]=s.canonical.z}for(const o of r){const r=s.featuresOnBorder[o],c=s.centroidData[r.centroidDataIndex],f=r.borders[t];let v;for(;R<C.length;){v=u.featuresOnBorder[C[R]];const e=v.borders[_];if(e[1]>f[0]+3||e[0]>f[0]-3)break;u.showCentroid(v),R++}if(v&&R<C.length){const o=R;let z=0;for(;!(v.borders[_][0]>f[1]-3)&&(z++,++R!==C.length);)v=u.featuresOnBorder[C[R]];v=u.featuresOnBorder[C[o]];let D=!1;if(z>=1){const e=v.borders[_];Math.abs(f[0]-e[0])<3&&Math.abs(f[1]-e[1])<3&&(z=1,D=!0,R=o+1)}else if(0===z){s.showCentroid(r);continue}const O=u.centroidData[v.centroidDataIndex];h&&D&&d(c,O);const F=r.intersectsCount()>1||v.intersectsCount()>1;if(z>1)R=o,c.centroidXY=O.centroidXY=new e.P(0,0);else if(m&&m.dem&&!F){const r=E[t](c,O),o=t%2?e.al-1:0,s=P(r[0],Math.min(e.al-1,r[1]),o,m,l,t<2,r[2]);c.centroidXY=O.centroidXY=p(s)}else F?c.centroidXY=O.centroidXY=new e.P(0,0):(c.centroidXY=s.encodeBorderCentroid(r),O.centroidXY=u.encodeBorderCentroid(v));s.writeCentroidToBuffer(c),u.writeCentroidToBuffer(O)}else s.showCentroid(r)}s.borderDoneWithNeighborZ[t]=u.canonical.z,u.borderDoneWithNeighborZ[_]=s.canonical.z}(s.needsCentroidUpdate||!s.centroidVertexBuffer&&0!==s.centroidVertexArray.length)&&s.uploadCentroid(t)}const sc=[1,0,0],ac=[0,1,0],cc=[0,0,1];function hc(t,r,o){const s=o.transform,l=o.shadowRenderer;if(!l)return!0;const c=t.toUnwrapped(),h=s.tileSize*l._cascades[o.currentShadowCascade].scale;let u=r;if(s.elevation){const e=s.elevation.getMinMaxForTile(t);e&&(u+=e.max)}const d=[...l.shadowDirection];d[2]=-d[2];const p=l.computeSimplifiedTileShadowVolume(c,u,h,d);if(!p)return!1;const f=[sc,ac,cc,d,[d[0],0,d[2]],[0,d[1],d[2]]],m="globe"===s.projection.name,_=s.scaleZoom(h),v=e.cB.fromInvProjectionMatrix(s.invProjMatrix,s.worldSize,_,!m),E=l.getCurrentCascadeFrustum();return 0===v.intersectsPrecise(p.vertices,p.planes,f)||0===E.intersectsPrecise(p.vertices,p.planes,f)}function gc(t){const{painter:r,source:o,layer:s,coords:l}=t;let c=t.defines;const h=r.context,u="shadow"===r.renderPass,d="light-beam"===r.renderPass,p=r.shadowRenderer,f=e.ef(r.transform.center.lat,r.transform.zoom),m=tn(r,s.paint.get("building-cutoff-fade-range"));m.shouldRenderCutoff&&(c=c.concat("RENDER_CUTOFF")),t.floodLightIntensity>0&&(c=c.concat("FLOOD_LIGHT"));for(const _ of l){const l=o.getTile(_),v=l.getBucket(s);if(!v)continue;p&&0===p.getMaxCascadeForTile(_.toUnwrapped())&&(c=c.concat("SHADOWS_SINGLE_CASCADE"));const E=v.programConfigurations.get(s.id);let P,C,R,z=r.translatePosMatrix(_.expandedProjMatrix,l,[0,0],"map");if(z=e.cS(e.bC(),z,[1,1,t.verticalScale]),u&&p){if(hc(l.tileID,v.maxHeight*f,r))continue;let o=p.calculateShadowPassMatrixFromTile(l.tileID.toUnwrapped());o=e.cS(e.bC(),o,[1,1,t.verticalScale]),R=oa(o),P=C=r.getOrCreateProgram("buildingDepth",{config:E,defines:c,overrideFog:!1})}else if(d)P=C=r.getOrCreateProgram("buildingBloom",{config:E,defines:c,overrideFog:!1}),R=na(z);else{const o=r.transform.calculatePosMatrix(_.toUnwrapped(),r.transform.worldSize);e.cS(o,o,[1,1,t.verticalScale]);const s=e.bC();e.cS(s,o,[1,-1,1/f]),e.bl(s,s),e.eg(s,s);const l=r.transform.getFreeCameraOptions().position,h=1<<_.canonical.z;if(R=ra(z,s,t.opacity,t.facadeAOIntensity,[((l.x-_.wrap)*h-_.canonical.x)*e.al,(l.y*h-_.canonical.y)*e.al,l.z*h*e.al],v.tileToMeter,t.facadeEmissiveChance,t.floodLightColor,t.floodLightIntensity),C=r.getOrCreateProgram("building",{config:E,defines:c,overrideFog:!1}),!0===t.depthOnly)P=C;else{const e=c.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);P=r.getOrCreateProgram("building",{config:E,defines:e,overrideFog:!1})}p&&(p.setupShadowsFromMatrix(o,C,!0),P!==C&&p.setupShadowsFromMatrix(o,P,!0))}const D=(e,o)=>{if(d){const l=e.entranceBloom;o.draw(r,h.gl.TRIANGLES,t.depthMode,Yi.disabled,t.blendMode,Qi.disabled,R,s.id,l.layoutVertexBuffer,l.indexBuffer,l.segmentsBucket,s.paint,r.transform.zoom,E,[l.layoutAttenuationBuffer,l.layoutColorBuffer])}else{const l=e.segmentsBucket;let c=[e.layoutNormalBuffer,e.layoutCentroidBuffer,e.layoutColorBuffer,e.layoutFloodLightDataBuffer];e.layoutFacadePaintBuffer&&(c=c.concat([e.layoutFacadeDataBuffer,e.layoutFacadeVerticalRangeBuffer,e.layoutFacadePaintBuffer])),o.draw(r,h.gl.TRIANGLES,t.depthMode,Yi.disabled,t.blendMode,u?Qi.disabled:Qi.backCW,R,s.id,e.layoutVertexBuffer,e.indexBuffer,l,s.paint,r.transform.zoom,E,c)}};r.uploadCommonUniforms(h,C,_.toUnwrapped(),null,m),v.buildingWithoutFacade&&D(v.buildingWithoutFacade,C),v.buildingWithFacade&&(P!==C&&r.uploadCommonUniforms(h,P,_.toUnwrapped(),null,m),D(v.buildingWithFacade,P))}}function yc(t,r,o,s,l,c,h,u,d,p,f,m,_){const v=t.context.gl,E=t.depthModeForSublayer(1,$i.ReadOnly,v.LEQUAL,!0),P=.1*(1-(C=f))+3*C;var C;const R=t._showOverdrawInspector,z=m,D=new un;R||nc(D,t,r,o,s,E,new Yi({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),new Wi([v.ONE,v.ONE,v.ONE,v.ONE],e.ao.transparent,[!1,!1,!1,!0],v.MIN),Qi.disabled,l,"sdf",c,h,u,d,p,P,z,!1);{const f=R?Yi.disabled:new Yi({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),m=R?t.colorModeForRenderPass():new Wi([v.ONE_MINUS_DST_ALPHA,v.DST_ALPHA,v.ONE,v.ONE],e.ao.transparent,[!0,!0,!0,!0]);nc(D,t,r,o,s,E,f,m,Qi.disabled,l,"color",c,h,u,d,p,P,z,!1)}}function xc(t){return[t[0]*e.eh,t[1]*e.eh,t[2]*e.eh,0]}function vc(t,r,o,s,l,c,h,u,d){const p=s.getSource(),f=o.globeSharedBuffers;if(!f)return;let m,_,v;if(r&&(m=s.getTile(r)),p instanceof e.aU?(_=p.texture,v=e.dK(0,0,o.transform)):m&&r&&(_=m.texture,v=e.dK(r.canonical.z,r.canonical.x,o.transform)),!_||!v)return;t||(v=e.cS(e.bC(),v,[1,-1,1]));const E=o.context,P=E.gl,C="nearest"===l.paint.get("raster-resampling")?P.NEAREST:P.LINEAR,R=o.colorModeForDrapableLayerRenderPass(c),z=h.defines;z.push("GLOBE_POLES");const D=new $i(P.LEQUAL,$i.ReadWrite,o.depthRangeFor3D),O=Float32Array.from(o.transform.expandedFarZProjMatrix),F=Float32Array.from(e.bk(e.dJ(new e.cD(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),E.activeTexture.set(P.TEXTURE0),_.bind(C,P.CLAMP_TO_EDGE),E.activeTexture.set(P.TEXTURE1),_.bind(C,P.CLAMP_TO_EDGE),"useMipmap"in _&&E.extTextureFilterAnisotropic&&o.transform.pitch>20&&P.texParameterf(P.TEXTURE_2D,E.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,E.extTextureFilterAnisotropicMax);const[B,k,V,N]=r?f.getPoleBuffers(r.canonical.z,!1):f.getPoleBuffers(0,!0),U=l.paint.get("raster-elevation");let j;t?(j=B,o.renderDefaultNorthPole=0!==U):(j=k,o.renderDefaultSouthPole=0!==U);const $=xc(h.mix),q=((e,t,r,o,s,l,c,h,u,d,p,f,m)=>ma(e,t,r,new Float32Array(16),new Float32Array(9),[0,0],o,[0,0],[0,0,0,0],1,{opacity:1,mix:0},l,[0,0]||[0,0],h,2,d,p,f,1,0,m))(O,F,v,e.aj(o.transform.zoom),0,l,0,U,0,$,h.offset,h.range,c),H=o.getOrCreateProgram("raster",{defines:z});o.uploadCommonUniforms(E,H,null),H.draw(o,P.TRIANGLES,D,d,R,u,q,l.id,j,V,N)}function Tc(e){if(e.isOrthographic)return[0,0,0,0];const t=e._nearZ,r=e.projection.farthestPixelDistance(e),o=r-t,s=.2*e.height,l=t+s;return[t,r,(l-s-t)/o,(l-t)/o]}function Ec(e,t,r,o){if(e)return t instanceof pt&&e instanceof Ot?t.getTextureDescriptor(e,r,!0):{texture:e.texture,mix:xc(o.mix),offset:o.offset,buffer:0,tileSize:1}}var Pc=e.ei([{name:"a_index",type:"Int16",components:1}]);class In{constructor(t,r,o,s){const l={width:o[0],height:o[1],data:null},c=t.gl;this.targetColorTexture=new e.T(t,l,c.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new e.T(t,l,c.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(r,s),this.lastInvalidatedAt=0}updateParticleTexture(t,r){if(this.particleTextureDimension===r.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const o=this.context.gl,s=r.width*r.height;this.particleTexture0=new e.T(this.context,r,o.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new e.T(this.context,r,o.RGBA8,{premultiply:!1,useMipmap:!1});const l=new e.ej;l.reserve(s);for(let e=0;e<s;e++)l.emplaceBack(e);this.particleIndexBuffer=this.context.createVertexBuffer(l,Pc.members,!0),this.particleSegment=e.bg.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=r.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=e.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Cc(t,r,o){if(!t)return null;const s=r.getTextureDescriptor(t,o,!0);if(!s)return null;let{texture:l,mix:c,offset:h,tileSize:u,buffer:d,format:p}=s;if(!l||!p)return null;let f=!1;return"uint32"===p&&(f=!0,c[3]=0,c=ua(e.ek,c,[0,o.paint.get("raster-particle-max-speed")]),h=da(e.ek,h,[0,o.paint.get("raster-particle-max-speed")])),{texture:l,textureOffset:[d/(u+2*d),u/(u+2*d)],tileSize:u,scalarData:f,scale:c,offset:h,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[p]]}}function Rc(e){const t=e._nearZ,r=e.projection.farthestPixelDistance(e),o=r-t,s=.2*e.height,l=t+s;return[t,r,(l-s-t)/o,(l-t)/o]}const zc=new e.ao(1,0,0,1),Dc=new e.ao(0,1,0,1),Lc=new e.ao(0,0,1,1),Oc=new e.ao(1,0,1,1),Fc=new e.ao(0,1,1,1);function Bc(t,r,o,s,l,c){for(let h=0;h<o.length;h++)if(l){const l=1,u=.8,d=new e.ao(s.r*u,s.g*u,s.b*u,1);kc(t,r,o[h],s,-l,-l,c),kc(t,r,o[h],s,-l,l,c),kc(t,r,o[h],s,l,l,c),kc(t,r,o[h],s,l,-l,c),kc(t,r,o[h],d,0,0,c)}else kc(t,r,o[h],s,0,0,c)}function kc(t,r,o,s,l,c,h){const u=t.context,d=t.transform,p=u.gl,f="globe"===d.projection.name,m=f?["PROJECTION_GLOBE_VIEW"]:[];let _=e.bz(o.projMatrix);if(f&&e.aj(d.zoom)>0){const t=e.bj(o.canonical,d),r=e.el(t);_=e.aB(new Float32Array(16),d.globeMatrix,r),e.aB(_,d.projMatrix,_)}const v=e.bC();v[12]+=2*l/(e.o.devicePixelRatio*d.width),v[13]+=2*c/(e.o.devicePixelRatio*d.height),e.aB(_,v,_);const E=t.getOrCreateProgram("debug",{defines:m}),P=r.getTileByID(o.key);t.terrain&&t.terrain.setupElevationDraw(P,E);const C=$i.disabled,R=Yi.disabled,z=t.colorModeForRenderPass(),D="$debug";u.activeTexture.set(p.TEXTURE0),t.emptyTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE),f?P._makeGlobeTileDebugBuffers(t.context,d):P._makeDebugTileBoundsBuffers(t.context,d.projection);const O=P._tileDebugBuffer||t.debugBuffer,F=P._tileDebugIndexBuffer||t.debugIndexBuffer,B=P._tileDebugSegments||t.debugSegments;if(E.draw(t,p.LINE_STRIP,C,R,z,Qi.disabled,la(_,s.toPremultipliedRenderColor(null)),D,O,F,B,null,null,null,[P._globeTileDebugBorderBuffer]),h){const e=P.latestRawTileData,r=Math.floor((e&&e.byteLength||0)/1024);let s=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(s+=` => ${o.overscaledZ}`),s+=` ${P.state}`,s+=` ${r}kb`,function(e,t){e.initDebugOverlayCanvas();const r=e.debugOverlayCanvas,o=e.context.gl,s=e.debugOverlayCanvas.getContext("2d");s.clearRect(0,0,r.width,r.height),s.shadowColor="white",s.shadowBlur=2,s.lineWidth=1.5,s.strokeStyle="white",s.textBaseline="top",s.font="bold 36px Open Sans, sans-serif",s.fillText(t,5,5),s.strokeText(t,5,5),e.debugOverlayTexture.update(r),e.debugOverlayTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE)}(t,s)}const k=r.getTile(o).tileSize,V=512/Math.min(k,512)*(o.overscaledZ/d.zoom)*.5,N=P._tileDebugTextBuffer||t.debugBuffer,U=P._tileDebugTextIndexBuffer||t.quadTriangleIndexBuffer,j=P._tileDebugTextSegments||t.debugSegments;E.draw(t,p.TRIANGLES,C,R,Wi.alphaBlended,Qi.disabled,la(_,e.ao.transparent.toPremultipliedRenderColor(null),V),D,N,U,j,null,null,null,[P._globeTileDebugTextBuffer])}function Vc(e,t,r,o){Uc(e,0,t+r/2,e.transform.width,r,o)}function Nc(e,t,r,o){Uc(e,t-r/2,0,r,e.transform.height,o)}function Uc(t,r,o,s,l,c){const h=t.context,u=h.gl;u.enable(u.SCISSOR_TEST),u.scissor(r*e.o.devicePixelRatio,o*e.o.devicePixelRatio,s*e.o.devicePixelRatio,l*e.o.devicePixelRatio),h.clear({color:c}),u.disable(u.SCISSOR_TEST)}const jc=e.ei([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Gc}=jc;function $c(e,t,r,o){e.emplaceBack(t,r,o)}class Vn{constructor(t){this.vertexArray=new e.em,this.indices=new e.b0,$c(this.vertexArray,-1,-1,1),$c(this.vertexArray,1,-1,1),$c(this.vertexArray,-1,1,1),$c(this.vertexArray,1,1,1),$c(this.vertexArray,-1,-1,-1),$c(this.vertexArray,1,-1,-1),$c(this.vertexArray,-1,1,-1),$c(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Gc),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=e.bg.simpleSegment(0,0,36,12)}}function qc(t,r,o,s,l,c){const h=t.context.gl,u=r.paint.get("sky-atmosphere-color"),d=r.paint.get("sky-atmosphere-halo-color"),p=r.paint.get("sky-atmosphere-sun-intensity"),f=((e,t,r,o,s)=>({u_matrix_3f:e,u_sun_direction:t,u_sun_intensity:r,u_color_tint_r:[o.r,o.g,o.b,o.a],u_color_tint_m:[s.r,s.g,s.b,s.a],u_luminance:5e-5}))(e.eo(e.dO(),s),l,p,u.toPremultipliedRenderColor(null),d.toPremultipliedRenderColor(null));h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_CUBE_MAP_POSITIVE_X+c,r.skyboxTexture,0),o.draw(t,h.TRIANGLES,$i.disabled,Yi.disabled,Wi.unblended,Qi.frontCW,f,"skyboxCapture",r.skyboxGeometry.vertexBuffer,r.skyboxGeometry.indexBuffer,r.skyboxGeometry.segment)}const Hc=e.ei([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class qn{constructor(t){const r=new e.ep;r.emplaceBack(-1,1,1,0,0),r.emplaceBack(1,1,1,1,0),r.emplaceBack(1,-1,1,1,1),r.emplaceBack(-1,-1,1,0,1);const o=new e.b0;o.emplaceBack(0,1,2),o.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(r,Hc.members),this.indexBuffer=t.createIndexBuffer(o),this.segments=e.bg.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Wc=e.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Wn{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class $n{constructor(t){this.colorModeAlphaBlendedWriteRGB=new Wi([1,kr,1,kr],e.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Wi([1,0,1,0],e.ao.transparent,[!1,!1,!1,!0]),this.params=new Wn,this.updateNeeded=!0}update(t){const r=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new qn(r);const t=this.params.sizeRange,o=this.params.intensityRange,s=function(t){const r=e.eq(30),o=[];for(let s=0;s<t;++s){const t=2*Math.PI*r(),s=Math.acos(1-2*r())-.5*Math.PI;o.push(e.d5(Math.cos(s)*Math.cos(t),Math.cos(s)*Math.sin(t),Math.sin(s)))}return o}(this.params.starsCount),l=e.eq(300),c=new e.er,h=new e.b0;let u=0;for(let r=0;r<s.length;++r){const d=e.c5([],s[r],200),p=Math.max(0,1+.01*t*(1*l()-.5)),f=Math.max(0,1+.01*o*(1*l()-.5));c.emplaceBack(d[0],d[1],d[2],-1,-1,p,f),c.emplaceBack(d[0],d[1],d[2],1,-1,p,f),c.emplaceBack(d[0],d[1],d[2],1,1,p,f),c.emplaceBack(d[0],d[1],d[2],-1,1,p,f),h.emplaceBack(u+0,u+1,u+2),h.emplaceBack(u+0,u+2,u+3),u+=4}this.starsVx=r.createVertexBuffer(c,Wc.members),this.starsIdx=r.createIndexBuffer(h),this.starsSegments=e.bg.simpleSegment(0,0,c.length,h.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,r){const o=t.context,s=o.gl,l=t.transform,c=new $i(s.LEQUAL,$i.ReadOnly,[0,1]),h=e.aj(l.zoom),u=t.style.getLut(r.scope),d="none"===r.properties.get("color-use-theme"),p=r.properties.get("color").toNonPremultipliedRenderColor(d?null:u),f="none"===r.properties.get("high-color-use-theme"),m=r.properties.get("high-color").toNonPremultipliedRenderColor(f?null:u),_="none"===r.properties.get("space-color-use-theme"),v=r.properties.get("space-color").toNonPremultipliedRenderColor(_?null:u),E=5e-4,P=e.es(r.properties.get("horizon-blend"),0,1,E,.25),C=e.dE(t,o,l)&&P===E?l.worldSize/(2*Math.PI*1.025)-1:l.globeRadius,R=t.frameCounter/1e3%1,z=e.ag(l.globeCenterInViewSpace),D=Math.sqrt(Math.pow(z,2)-Math.pow(C,2)),O=Math.acos(D/z),F=e=>{const r="globe"===l.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];e&&r.push("ALPHA_PASS");const u=t.getOrCreateProgram("globeAtmosphere",{defines:r}),d=((e,t,r,o,s,l,c,h,u,d,p,f)=>({u_frustum_tl:e,u_frustum_tr:t,u_frustum_br:r,u_frustum_bl:o,u_horizon:s,u_transition:l,u_fadeout_range:c,u_atmosphere_fog_color:h.toArray01(),u_high_color:u.toArray01(),u_space_color:d.toArray01(),u_temporal_offset:p,u_horizon_angle:f}))(l.frustumCorners.TL,l.frustumCorners.TR,l.frustumCorners.BR,l.frustumCorners.BL,l.frustumCorners.horizon,h,P,p,m,v,R,O);t.uploadCommonUniforms(o,u);const f=this.atmosphereBuffer;f&&u.draw(t,s.TRIANGLES,c,Yi.disabled,e?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Qi.backCW,d,e?"atmosphere_glow_alpha":"atmosphere_glow",f.vertexBuffer,f.indexBuffer,f.segments)};F(!1),F(!0)}drawStars(t,r){const o=e.aA(r.properties.get("star-intensity"),0,1);if(0===o)return;const s=t.context,l=s.gl,c=t.transform,h=t.getOrCreateProgram("stars"),u=e.c7([]);e.c9(u,u,-c._pitch),e.c8(u,u,-c.angle),e.c9(u,u,e.an(c._center.lat)),e.et(u,u,-e.an(c._center.lng));const d=e.cc(new Float32Array(16),u),p=e.aB([],c.starsProjMatrix,d),f=e.eo([],d),m=e.eu([],f),_=[0,1,0];e.dQ(_,_,m),e.c5(_,_,this.params.sizeMultiplier);const v=[1,0,0];e.dQ(v,v,m),e.c5(v,v,this.params.sizeMultiplier);const E=(P=_,C=v,R=o,{u_matrix:Float32Array.from(p),u_up:P,u_right:C,u_intensity_multiplier:R});var P,C,R;t.uploadCommonUniforms(s,h),this.starsVx&&this.starsIdx&&h.draw(t,l.TRIANGLES,$i.disabled,Yi.disabled,this.colorModeAlphaBlendedWriteRGB,Qi.disabled,E,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Xn{constructor(){this.visibleTiles=[]}updateBorders(t,r){const o=[],s=[],l=t._getRenderableCoordinates(!1,!0);for(const e of l){const l=t.getTile(e);if(!l.hasData())continue;const c=l.getBucket(r);c&&(c.isEmpty()||(o.push(e.key),s.push({bucket:c,tileID:e.canonical})))}let c=o.length!==this.visibleTiles.length;if(!c){o.sort();for(let e=0;e<o.length;e++)if(o[e]!==this.visibleTiles[e]){c=!0;break}}if(!c)return;const h=new Set;this.visibleTiles=o,s.sort(((e,t)=>e.tileID.z-t.tileID.z||e.tileID.x-t.tileID.x||e.tileID.y-t.tileID.y));for(const t of s){const r=new Array,o=new Array,s=t.bucket;for(const e of s.featuresOnBorder)h.has(e.featureId)?o.push(e.footprintIndex):(h.add(e.featureId),r.push(e.footprintIndex));s.updateFootprintHiddenFlags(r,e.ev,!1),s.updateFootprintHiddenFlags(o,e.ev,!0)}}}function Zc(t,r){const o=[...t],s=r.cameraWorldSizeForFog/r.worldSize,l=e.bA([]);return e.cS(l,l,[s,s,1]),e.aB(o,l,o),e.aB(o,r.worldToFogMatrix,o),o}function Xc(t,r,o,s,l){const c=o.material,h=s.context,{baseColorTexture:u,metallicRoughnessTexture:d}=c.pbrMetallicRoughness,{normalTexture:p,occlusionTexture:f,emissionTexture:m}=c;function _(e,r,o){if(e&&(t.push(r),h.activeTexture.set(h.gl.TEXTURE0+o),e.gfxTexture)){const{minFilter:t,magFilter:r,wrapS:o,wrapT:s}=e.sampler;e.gfxTexture.bindExtraParam(t,r,o,s)}}_(u,"HAS_TEXTURE_u_baseColorTexture",5),_(d,"HAS_TEXTURE_u_metallicRoughnessTexture",6),_(p,"HAS_TEXTURE_u_normalTexture",7),_(f,"HAS_TEXTURE_u_occlusionTexture",8),_(m,"HAS_TEXTURE_u_emissionTexture",9),l&&(l.texture||(l.texture=new e.d$(s.context,l.image,[l.image.height,l.image.height,l.image.height],h.gl.RGBA8)),h.activeTexture.set(h.gl.TEXTURE0+10),l.texture&&l.texture.bind(h.gl.LINEAR,h.gl.CLAMP_TO_EDGE),t.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(t.push("HAS_ATTRIBUTE_a_uv_2f"),r.push(o.texcoordBuffer)),o.colorBuffer&&(t.push(12===o.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),r.push(o.colorBuffer)),o.normalBuffer&&(t.push("HAS_ATTRIBUTE_a_normal_3f"),r.push(o.normalBuffer)),o.pbrBuffer&&(t.push("HAS_ATTRIBUTE_a_pbr"),t.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),r.push(o.pbrBuffer)),"OPAQUE"!==c.alphaMode&&"MASK"!==c.alphaMode||t.push("UNPREMULT_TEXTURE_IN_SHADER"),c.defined||t.push("DIFFUSE_SHADED");const v=s.shadowRenderer;v&&(t.push("RENDER_SHADOWS","DEPTH_TEXTURE"),v.useNormalOffset&&t.push("NORMAL_OFFSET"))}function Qc(t,r,o,s,l,c){const h=t.modelOpacity,u=r.context,d=new $i(r.context.gl.LEQUAL,t.isLightMesh?$i.ReadOnly:$i.ReadWrite,r.depthRangeFor3D),p=r.transform,f=t.mesh,m=f.material,_=m.pbrMetallicRoughness,v=r.style.fog;let E;E="pixels"===r.transform.projection.zAxisUnit?[...t.nodeModelMatrix]:e.aB([],s.zScaleMatrix,t.nodeModelMatrix),e.aB(E,s.negCameraPosMatrix,E);const P=e.bl([],E);e.eg(P,P);const C="none"===o.paint.get("model-color-use-theme").constantOr("default"),R=o.paint.get("model-emissive-strength").constantOr(0),z=Oa(new Float32Array(t.worldViewProjection),new Float32Array(E),new Float32Array(P),null,r,h,_.baseColorFactor,m.emissiveFactor,_.metallicFactor,_.roughnessFactor,m,R,o,void 0,void 0,t.materialOverride,t.modelColor),D={defines:[]},O=[],F=r.shadowRenderer;F&&(F.useNormalOffset=!1),Xc(D.defines,O,f,r,C?null:o.lut);let B=null;if(v){const e=Zc(t.nodeModelMatrix,r.transform);if(B=new Float32Array(e),"globe"!==p.projection.name){const t=f.aabb.min,r=f.aabb.max,[o,s]=v.getOpacityForBounds(e,t[0],t[1],r[0],r[1]);D.overrideFog=o>=ct||s>=ct}}const k=tn(r,o.paint.get("model-cutoff-fade-range"));k.shouldRenderCutoff&&D.defines.push("RENDER_CUTOFF");const V=r.getOrCreateProgram("model",D);r.uploadCommonUniforms(u,V,null,B,k),"shadow"!==r.renderPass&&F&&F.setupShadowsFromMatrix(t.nodeModelMatrix,V),V.draw(r,u.gl.TRIANGLES,d,l,c,f.material.doubleSided?Qi.disabled:Qi.backCCW,z,o.id,f.vertexBuffer,f.indexBuffer,f.segments,o.paint,r.transform.zoom,void 0,O)}function eh(e,t){return e.style._importedAsBasemap?"basemap":t.scope}function th(t,r,o,s,l,c,h,u,d,p){const f=t.transform,m=!!r.isGeometryBloom&&r.isGeometryBloom;if(m&&"shadow"===t.renderPass)return;const _="globe"===f.projection.name?e.eD(o,f):[...o];e.aB(_,_,r.globalMatrix);const v=e.aB([],s,_);if(r.meshes)for(const t of r.meshes){const r=u.get(t.material.name);if(r&&r.opacity<=0)continue;if("BLEND"!==t.material.alphaMode){h.push({mesh:t,depth:0,modelIndex:l,worldViewProjection:v,nodeModelMatrix:_,isLightMesh:m,materialOverride:r,modelOpacity:d,modelColor:p});continue}const o=e.af([],t.centroid,v);!f.isOrthographic&&o[2]<=0||c.push({mesh:t,depth:o[2],modelIndex:l,worldViewProjection:v,nodeModelMatrix:_,isLightMesh:m,materialOverride:r,modelOpacity:d,modelColor:p})}if(r.children)for(const e of r.children)th(t,e,o,s,l,c,h,u,d,p)}function ih(e,t,r,o){const s=r.shadowRenderer;if(!s)return;const l=s.getShadowPassDepthMode(),c=s.getShadowPassColorMode(),h=s.calculateShadowPassMatrixFromMatrix(t),u=Fa(h);r.getOrCreateProgram("modelDepth",{defines:r._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(r,r.context.gl.TRIANGLES,l,Yi.disabled,c,Qi.disabled,u,o.id,e.vertexBuffer,e.indexBuffer,e.segments,o.paint,r.transform.zoom,void 0,void 0)}function rh(e,t,r,o,s,l){for(const c of s){const s=Object.assign({},o);s.part=c;const h={type:"Unknown",id:t,properties:s},u={orientation:e.paint.get("model-rotation").evaluate(h,r)};l.set(c,u)}}function nh(e,t,r,o,s,l){for(const c of s){const s=Object.assign({},o);s.part=c;const h={type:"Unknown",id:t,properties:s},u={color:e.paint.get("model-color").evaluate(h,r),colorMix:e.paint.get("model-color-mix-intensity").evaluate(h,r),opacity:e.paint.get("model-opacity").evaluate(h,r),emissionStrength:e.paint.get("model-emissive-strength").evaluate(h,r)};l.set(c,u)}}function oh(e,t,r,o,s){let l=!1;for(const r of o)1!==r.modelOpacity&&(Qc(r,e,t,s[r.modelIndex],Yi.disabled,Wi.disabled),l=!0);for(const r of o)Qc(r,e,t,s[r.modelIndex],1!==r.modelOpacity?e.stencilModeFor3D():Yi.disabled,e.colorModeForRenderPass());l&&e.resetStencilClippingMasks();const c=Wi.additive;for(const o of r)Qc(o,e,t,s[o.modelIndex],Yi.disabled,o.isLightMesh?c:e.colorModeForRenderPass())}function sh(t,r,o){const s=r.updateZoomBasedPaintProperties(),l=function(t,r,o){let s,l,c,h=t.terrain?t.terrain.exaggeration():0;if(t.terrain&&h>0){const r=t.terrain,l=r.findDEMTileFor(o);l&&l.dem?s=e.eF.create(r,o,l):h=0}if(0===h&&(r.terrainElevationMin=0,r.terrainElevationMax=0),h===r.validForExaggeration&&(0===h||s&&s._demTile&&s._demTile.tileID===r.validForDEMTile.id&&s._dem._timestamp===r.validForDEMTile.timestamp))return!1;for(const e in r.instancesPerModel){const t=r.instancesPerModel[e];for(let e=0;e<t.instancedDataArray.length;++e){const o=(s?h*s.getElevationAt(0|t.instancedDataArray.float32[16*e],0|t.instancedDataArray.float32[16*e+1],!0,!0):0)+t.instancesEvaluatedElevation[e];t.instancedDataArray.float32[16*e+6]=o,l=l?Math.min(r.terrainElevationMin,o):o,c=c?Math.max(r.terrainElevationMax,o):o}}return r.terrainElevationMin=l||0,r.terrainElevationMax=c||0,r.validForExaggeration=h,r.validForDEMTile=s&&s._demTile?{id:s._demTile.tileID,timestamp:s._dem._timestamp}:{id:void 0,timestamp:0},!0}(t,r,o);(s||l)&&(r.uploaded=!1,r.upload(t.context))}const ah={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new e.d9([0,0,0],[e.al,e.al,0])};function ch(t,r){const o=1<<t.canonical.z,s=r.getFreeCameraOptions().position,l=r.elevation,c=t.canonical.x/o,h=(t.canonical.x+1)/o,u=t.canonical.y/o,d=(t.canonical.y+1)/o;let p=r._centerAltitude;if(l){const e=l.getMinMaxForTile(t);e&&e.max>p&&(p=e.max)}const f=e.aA(s.x,c,h)-s.x,m=e.aA(s.y,u,d)-s.y,_=e.cf(p,r.center.lat)-s.z;return r._zoomFromMercatorZ(Math.sqrt(f*f+m*m+_*_))}function hh(e,t,r,o,s,l,c){const h=e.context,u="shadow"===e.renderPass,d=e.shadowRenderer,p=u&&d?d.getShadowPassDepthMode():new $i(h.gl.LEQUAL,$i.ReadWrite,e.depthRangeFor3D),f=e.isTileAffectedByFog(l),m="globe"===e.transform.projection.name;if(r.meshes)for(const _ of r.meshes){const v=m?[]:["MODEL_POSITION_ON_GPU"],E=[];let P,C,R;const z=!m&&o.instancedDataArray.length>20;z&&v.push("INSTANCED_ARRAYS");const D=tn(e,t.paint.get("model-cutoff-fade-range"));if(D.shouldRenderCutoff&&v.push("RENDER_CUTOFF"),u&&d)P=e.getOrCreateProgram("modelDepth",{defines:v}),C=Fa(c.shadowTileMatrix,c.shadowTileMatrix,Float32Array.from(r.globalMatrix)),R=d.getShadowPassColorMode();else{Xc(v,E,_,e,"none"===t.paint.get("model-color-use-theme").constantOr("default")?null:t.lut),P=e.getOrCreateProgram("model",{defines:v,overrideFog:f});const o=_.material,u=o.pbrMetallicRoughness,p=t.paint.get("model-opacity").constantOr(1),m=t.paint.get("model-emissive-strength").constantOr(0);C=Oa(l.expandedProjMatrix,Float32Array.from(r.globalMatrix),new Float32Array(16),null,e,p,u.baseColorFactor,o.emissiveFactor,u.metallicFactor,u.roughnessFactor,o,m,t,s),d&&(c.shadowUniformsInitialized?P.setShadowUniformValues(h,d.getShadowUniformValues()):(d.setupShadows(l.toUnwrapped(),P,"model-tile"),c.shadowUniformsInitialized=!0)),R=D.shouldRenderCutoff||p<1||"OPAQUE"!==o.alphaMode?Wi.alphaBlended:Wi.unblended}e.uploadCommonUniforms(h,P,l.toUnwrapped(),null,D);const O=_.material.doubleSided?Qi.disabled:Qi.backCCW;if(z)E.push(o.instancedDataBuffer),P.draw(e,h.gl.TRIANGLES,p,Yi.disabled,R,O,C,t.id,_.vertexBuffer,_.indexBuffer,_.segments,t.paint,e.transform.zoom,void 0,E,o.instancedDataArray.length);else{const r=u?"u_instance":"u_normal_matrix";for(let s=0;s<o.instancedDataArray.length;++s)C[r]=new Float32Array(o.instancedDataArray.arrayBuffer,64*s,16),P.draw(e,h.gl.TRIANGLES,p,Yi.disabled,R,O,C,t.id,_.vertexBuffer,_.indexBuffer,_.segments,t.paint,e.transform.zoom,void 0,E)}}if(r.children)for(const h of r.children)hh(e,t,h,o,s,l,c)}const uh=[1,-1,1];function dh(t,r,o,s){if(!o.modelManager)return!0;const l=o.modelManager;if(!o.shadowRenderer)return!0;const c=o.shadowRenderer,h=r.aabb;let u=!0,d=t.maxHeight;if(0===d){let e=0;for(const r in t.instancesPerModel){const t=l.getModel(r,s);t?e=Math.max(e,Math.max(Math.max(t.aabb.max[0],t.aabb.max[1]),t.aabb.max[2])):u=!1}d=t.maxScale*e*1.41+t.maxVerticalOffset,u&&(t.maxHeight=d)}h.max[2]=d,h.min[2]+=t.terrainElevationMin,h.max[2]+=t.terrainElevationMax,e.af(h.min,h.min,r.tileMatrix),e.af(h.max,h.max,r.tileMatrix);const p=h.intersects(c.getCurrentCascadeFrustum());return 0===o.currentShadowCascade&&(t.isInsideFirstShadowMapFrustum=2===p),0===p}function ph(t,r){const o=t.uniformValues.u_cutoff_params[0],s=t.uniformValues.u_cutoff_params[1],l=t.uniformValues.u_cutoff_params[2],c=t.uniformValues.u_cutoff_params[3];return s===o||c===l?1:e.aA(((r-o)/(s-o)-l)/(c-l),0,1)}function fh(t,r,o,s){if(r.pitch<20)return 1;const l=r.getWorldToCameraMatrix();e.aB(l,l,t);const c=e.bU(o.min[0],o.min[1],o.min[2],1);let h=e.aC(e.eG(),c,l),u=h,d=h;c[1]=o.max[1],h=e.aC(e.eG(),c,l),u=h[1]<u[1]?h:u,d=h[1]>d[1]?h:d,c[0]=o.max[0],h=e.aC(e.eG(),c,l),u=h[1]<u[1]?h:u,d=h[1]>d[1]?h:d,c[1]=o.min[1],h=e.aC(e.eG(),c,l),u=h[1]<u[1]?h:u,d=h[1]>d[1]?h:d;const p=e.aA(s[0],0,1),f=100*r.pixelsPerMeter*e.aA(s[1],0,1),m=e.aA(s[2],0,1),_=e.eH(e.eG(),u,d,p),v=Math.tan(.5*r.fovX),E=-_[2]*v;if(0===f)return _[1]<-Math.abs(E)?m:1;const P=(-Math.abs(E)-_[1])/f,C=(e,t,r)=>(1-r)*e+r*t,R=e.aA(C(1,m,P),m,1);return C(1,R,e.aA((r.pitch-20)/20,0,1))}class _a{}class pa{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,r,o){{const e=this._storage.get(r.id);if(e)return e.lastUsedFrameIdx=t,e.buf}const s=o.gl,l=s.getBufferParameter(s.ELEMENT_ARRAY_BUFFER,s.BUFFER_SIZE),c=new ArrayBuffer(l),h=new Int16Array(c);s.getBufferSubData(s.ELEMENT_ARRAY_BUFFER,0,new Int16Array(c));const u=new e.eJ;for(let e=0;e<l/2;e+=3){const t=h[e],r=h[e+1],o=h[e+2];u.emplaceBack(t,r),u.emplaceBack(r,o),u.emplaceBack(o,t)}const d=o.bindVertexArrayOES.current,p=new _a;return p.buf=new $r(o,u),p.lastUsedFrameIdx=t,this._storage.set(r.id,p),o.bindVertexArrayOES.set(d),p.buf}update(e){for(const[t,r]of this._storage)e-r.lastUsedFrameIdx>30&&(r.buf.destroy(),this._storage.delete(t))}destroy(){for(const[e,t]of this._storage)t.buf.destroy(),this._storage.delete(e)}}class fa{constructor(){this.occluderSize=30,this.depthOffset=-1e-4}}const mh=e.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class ga{constructor(e){this.revealStart=11,this.revealRange=2}}const _h=e.ei([{type:"Float32",name:"a_pos_2f",components:2}]);class ya{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,r){const o=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const r=new e.eK,o=new e.b0;r.emplaceBack(-1,-1),r.emplaceBack(1,-1),r.emplaceBack(1,1),r.emplaceBack(-1,1),o.emplaceBack(0,1,2),o.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(r,_h.members),this.vignetteIdx=t.context.createIndexBuffer(o)}const s=e.bg.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,o);const e={u_vignetteShape:(l={vignetteShape:[r.start,r.range,Math.pow(10,r.fadePower)],vignetteColor:[r.color.r,r.color.g,r.color.b,r.color.a*r.strength]}).vignetteShape,u_vignetteColor:l.vignetteColor};o.draw(t,t.context.gl.TRIANGLES,$i.disabled,Yi.disabled,Wi.alphaBlended,Qi.disabled,e,"vignette",this.vignetteVx,this.vignetteIdx,s)}var l}}class xa{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,r){const o=t.getFreeCameraOptions().position,s=o.toAltitude(),l=o.toLngLat(),c=e.an(l.lng),h=e.an(l.lat),u=t.pixelsPerMeter/r,d=c*e.eM,p=e.eM*Math.log(Math.tan(Math.PI/4+h/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const e=-this._offsetYPrev+p,t=-this._elevationPrev+s;this._accumulatedOffsetX+=(-this._offsetXPrev+d)*u,this._accumulatedOffsetY+=e*u,this._accumulatedElevation+=t*u,this._offsetXPrev=d,this._offsetYPrev=p,this._elevationPrev=s}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function gh(e,t){return[-(e[0]-Math.floor(e[0]/t)*t),-(e[1]-Math.floor(e[1]/t)*t),-(e[2]-Math.floor(e[2]/t)*t)]}function yh(t){const r=e.eq(1323123451230),o=[];for(let s=0;s<t;++s){const t=2*r()-1,s=2*r()-1,l=2*r()-1;o.push(e.d5(t,s,l))}return o}function xh(t,r,o,s,l){const c=e.aA((l-o)/(s-o),0,1);return(1-c)*t+c*r}class Ea{constructor(e){this._movement=new xa,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new ya,this._ppmScaleFactor=e}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,r){const o=t.transform;this._movement.update(o,this._ppmScaleFactor);const s=o.starsProjMatrix,l=e.c7([]);e.c9(l,l,e.an(90)-o._pitch),e.c8(l,l,-o.angle);const c=e.cc(new Float32Array(16),l),h=e.eL(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),u=e.eg([],h),d=e.aB([],u,c),p=Date.now()/1e3;return this._accumulatedTimeFromStart+=(p-this._prevTime)*r,this._prevTime=p,{projectionMatrix:s,modelviewMatrix:d}}}class Sa extends Ea{constructor(e){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new ga("Precipitation > Rain"),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const t=yh(this.particlesCount),o=new e.eN,s=new e.b0;let l=0;const c=e.eq(1323123451230);for(let e=0;e<t.length;++e){const r=t[e],h=[2*c()-1,c(),c(),c()];o.emplaceBack(r[0],r[1],r[2],-1,-1,...h),o.emplaceBack(r[0],r[1],r[2],1,-1,...h),o.emplaceBack(r[0],r[1],r[2],1,1,...h),o.emplaceBack(r[0],r[1],r[2],-1,1,...h),s.emplaceBack(l+0,l+1,l+2),s.emplaceBack(l+0,l+2,l+3),l+=4}this.particlesVx=r.createVertexBuffer(o,mh.members),this.particlesIdx=r.createIndexBuffer(s)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const r=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},o=t.transform.zoom;if(r.revealStart>o)return;const s=xh(0,1,r.revealStart,r.revealStart+r.revealRange,o);if(!this.particlesVx||!this.particlesIdx)return;const l=structuredClone(this._params);let c=[-l.direction.x,l.direction.y,-100];e.aw(c,c);const h=structuredClone(this._vignetteParams);h.strength*=s,l.overrideStyleParameters||(l.intensity=t.style.rain.state.density,l.timeFactor=t.style.rain.state.intensity,l.color=structuredClone(t.style.rain.state.color),c=structuredClone(t.style.rain.state.direction),l.screenThinning.intensity=t.style.rain.state.centerThinning,l.dropletSizeX=t.style.rain.state.dropletSize[0],l.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],l.distortionStrength=100*t.style.rain.state.distortionStrength,h.strength=1,h.color=structuredClone(t.style.rain.state.vignetteColor));const u=this.updateOnRender(t,l.timeFactor),d=t.context,p=d.gl,f=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new e.T(d,{width:t.width,height:t.height,data:null},p.RGBA8)),l.distortionStrength>0&&(d.activeTexture.set(p.TEXTURE0),this.screenTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE),p.copyTexSubImage2D(p.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const m=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(d,m),d.activeTexture.set(p.TEXTURE0),this.screenTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE);const _=[l.color.r,l.color.g,l.color.b,l.color.a],v=(r,o)=>{const s=gh(this._movement.getPosition(),r),h=l.dropletSizeX,d=l.dropletSizeX*l.dropletSizeYScale,v=t.width/2,E=t.height/2,P=xh(0,l.screenThinning.start,0,1,l.screenThinning.intensity),C=xh(.001,l.screenThinning.range,0,1,l.screenThinning.intensity),R=xh(0,l.screenThinning.particleOffset,0,1,l.screenThinning.intensity),z=(D={modelview:u.modelviewMatrix,projection:u.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:s,velocityConeAperture:l.velocityConeAperture,velocity:l.velocity,boxSize:r,rainDropletSize:[h,d],distortionStrength:l.distortionStrength,rainDirection:c,color:_,screenSize:[f.width,f.height],thinningCenterPos:[v,E],thinningShape:[P,C,Math.pow(10,l.screenThinning.fadePower)],thinningAffectedRatio:l.screenThinning.affectedRatio,thinningParticleOffset:R,shapeDirectionalPower:l.shapeDirPower,shapeNormalPower:l.shapeNormalPower,mode:o?0:1},{u_modelview:Float32Array.from(D.modelview),u_projection:Float32Array.from(D.projection),u_time:D.time,u_cam_pos:D.camPos,u_texScreen:0,u_velocityConeAperture:D.velocityConeAperture,u_velocity:D.velocity,u_boxSize:D.boxSize,u_rainDropletSize:D.rainDropletSize,u_distortionStrength:D.distortionStrength,u_rainDirection:D.rainDirection,u_color:D.color,u_screenSize:D.screenSize,u_thinningCenterPos:D.thinningCenterPos,u_thinningShape:D.thinningShape,u_thinningAffectedRatio:D.thinningAffectedRatio,u_thinningParticleOffset:D.thinningParticleOffset,u_shapeDirectionalPower:D.shapeDirectionalPower,u_shapeNormalPower:D.shapeNormalPower,u_mode:D.mode});var D;const O=Math.round(l.intensity*this.particlesCount),F=e.bg.simpleSegment(0,0,4*O,2*O);m.draw(t,p.TRIANGLES,$i.disabled,Yi.disabled,Wi.alphaBlended,Qi.disabled,z,"rain_particles",this.particlesVx,this.particlesIdx,F)};l.distortionStrength>0&&v(l.boxSize,!0),v(l.boxSize,!1),this._vignette.draw(t,h)}}const vh=e.ei([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Ca extends Ea{constructor(e){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new ga("Precipitation > Snow"),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const t=yh(this.particlesCount),o=new e.eO,s=new e.b0;let l=0;const c=e.eq(1323123451230);for(let e=0;e<t.length;++e){const r=t[e],h=c(),u=c(),d=c(),p=[e/t.length,h,u,d],f=[c(),c()];o.emplaceBack(r[0],r[1],r[2],-1,-1,...p,...f),o.emplaceBack(r[0],r[1],r[2],1,-1,...p,...f),o.emplaceBack(r[0],r[1],r[2],1,1,...p,...f),o.emplaceBack(r[0],r[1],r[2],-1,1,...p,...f),s.emplaceBack(l+0,l+1,l+2),s.emplaceBack(l+0,l+2,l+3),l+=4}this.particlesVx=r.createVertexBuffer(o,vh.members),this.particlesIdx=r.createIndexBuffer(s)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const r=structuredClone(this._params);let o=[-r.direction.x,r.direction.y,-100];e.aw(o,o);const s=structuredClone(this._vignetteParams),l=r.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(l.revealStart>c)return;const h=xh(0,1,l.revealStart,l.revealStart+l.revealRange,c);s.strength*=h,r.overrideStyleParameters||(r.intensity=t.style.snow.state.density,r.timeFactor=t.style.snow.state.intensity,r.color=structuredClone(t.style.snow.state.color),o=structuredClone(t.style.snow.state.direction),r.screenThinning.intensity=t.style.snow.state.centerThinning,r.billboardSize=2.79*t.style.snow.state.flakeSize,s.strength=1,s.color=structuredClone(t.style.snow.state.vignetteColor));const u=this.updateOnRender(t,r.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const d=t.context,p=d.gl,f=t.transform,m=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(d,m),((r,s,l)=>{const c=gh(this._movement.getPosition(),r),h=f.width/2,d=f.height/2,_=xh(0,l.screenThinning.start,0,1,l.screenThinning.intensity),v=xh(.001,l.screenThinning.range,0,1,l.screenThinning.intensity),E=xh(0,l.screenThinning.particleOffset,0,1,l.screenThinning.intensity),P=(C={modelview:u.modelviewMatrix,projection:u.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:c,velocityConeAperture:l.velocityConeAperture,velocity:l.velocity,horizontalOscillationRadius:l.horizontalOscillationRadius,horizontalOscillationRate:l.horizontalOscillationRate,boxSize:r,billboardSize:1*l.billboardSize,simpleShapeParameters:[l.shapeFadeStart,l.shapeFadePower],screenSize:[f.width,f.height],thinningCenterPos:[h,d],thinningShape:[_,v,Math.pow(10,l.screenThinning.fadePower)],thinningAffectedRatio:l.screenThinning.affectedRatio,thinningParticleOffset:E,color:[l.color.r,l.color.g,l.color.b,l.color.a],direction:o},{u_modelview:Float32Array.from(C.modelview),u_projection:Float32Array.from(C.projection),u_time:C.time,u_cam_pos:C.camPos,u_velocityConeAperture:C.velocityConeAperture,u_velocity:C.velocity,u_horizontalOscillationRadius:C.horizontalOscillationRadius,u_horizontalOscillationRate:C.horizontalOscillationRate,u_boxSize:C.boxSize,u_billboardSize:C.billboardSize,u_simpleShapeParameters:C.simpleShapeParameters,u_screenSize:C.screenSize,u_thinningCenterPos:C.thinningCenterPos,u_thinningShape:C.thinningShape,u_thinningAffectedRatio:C.thinningAffectedRatio,u_thinningParticleOffset:C.thinningParticleOffset,u_particleColor:C.color,u_direction:C.direction});var C;const R=Math.round(l.intensity*this.particlesCount),z=e.bg.simpleSegment(0,0,4*R,2*R);this.particlesVx&&this.particlesIdx&&m.draw(t,p.TRIANGLES,$i.disabled,Yi.disabled,Wi.alphaBlended,Qi.disabled,P,"snow_particles",this.particlesVx,this.particlesIdx,z)})(r.boxSize,0,r),this._vignette.draw(t,s)}}const bh={symbol:function(t,r,o,s,l){if("translucent"!==t.renderPass)return;const c=Yi.disabled,h=t.colorModeForRenderPass(),u=o.layout.get("text-variable-anchor"),d=o.layout.get("text-size-scale-range"),p=e.aA(t.scaleFactor,d[0],d[1]);u&&function(t,r,o,s,l,c,h,u){const d=r.transform,p="map"===l,f="map"===c;for(const r of t){const t=s.getTile(r),l=t.getBucket(o);if(!l||!l.text||!l.text.segments.get().length)continue;const c=e.bK(l.textSizeData,d.zoom,u),m=Pi(r,l.getProjection(),d),_=d.calculatePixelsToTileUnitsMatrix(t),v=Di(m,t.tileID.canonical,f,p,d,l.getProjection(),_),E=l.hasIconTextFit()&&l.hasIconData();c&&Ul(l,p,f,h,d,v,r,Math.pow(2,d.zoom-t.tileID.overscaledZ),c,E)}}(s,t,o,r,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),l,p);const f=0!==o.paint.get("icon-opacity").constantOr(1),m=0!==o.paint.get("text-opacity").constantOr(1);void 0!==o.layout.get("symbol-sort-key").constantOr(1)&&(f||m)?Gl(t,r,o,s,c,h):(f&&Gl(t,r,o,s,c,h,{onlyIcons:!0}),m&&Gl(t,r,o,s,c,h,{onlyText:!0})),r.map.showCollisionBoxes&&(Na(t,r,o,s,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),Na(t,r,o,s,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(t,r,o,s){if("translucent"!==t.renderPass)return;const l=o.paint.get("circle-opacity"),c=o.paint.get("circle-stroke-width"),h=o.paint.get("circle-stroke-opacity"),u=void 0!==o.layout.get("circle-sort-key").constantOr(1),d=o.paint.get("circle-emissive-strength");if(0===l.constantOr(1)&&(0===c.constantOr(1)||0===h.constantOr(1)))return;const p=t.context,f=p.gl,m=t.transform,_=!(!t.terrain||!t.terrain.enabled),v=o.layout.get("circle-elevation-reference"),E=t.depthModeForSublayer(0,$i.ReadOnly),P=new $i(t.context.gl.LEQUAL,$i.ReadOnly,t.depthRangeFor3D),C="none"===v||_?E:P,R=Yi.disabled,z=t.colorModeForDrapableLayerRenderPass(d),D="globe"===m.projection.name,O=[e.aF(m.center.lng),e.aJ(m.center.lat)],F=[];for(let l=0;l<s.length;l++){const c=s[l],h=r.getTile(c),d=h.getBucket(o);if(!d||d.projection.name!==m.projection.name)continue;const p=d.programConfigurations.get(o.id),f=d.layoutVertexBuffer,_=d.globeExtVertexBuffer,v=d.indexBuffer,E=e.e0(o),P=[_],C=t.isTileAffectedByFog(c);D&&E.push("PROJECTION_GLOBE_VIEW"),E.push("DEPTH_D24"),t.terrain&&m.depthOcclusionForSymbolsAndCircles&&E.push("DEPTH_OCCLUSION"),d.hasElevation&&!t.terrain&&(E.push("ELEVATED_ROADS"),P.push(d.elevatedLayoutVertexBuffer));const R=t.getOrCreateProgram("circle",{config:p,defines:E,overrideFog:C}),z=m.projection.createInversionMatrix(m,c.canonical),B={programConfiguration:p,program:R,layoutVertexBuffer:f,dynamicBuffers:P,indexBuffer:v,uniformValues:e.e1(t,c,h,z,O,o),tile:h};if(u){const t=d.segments.get();for(const r of t)F.push({segments:new e.bg([r]),sortKey:r.sortKey,state:B})}else F.push({segments:d.segments,sortKey:0,state:B})}u&&F.sort(((e,t)=>e.sortKey-t.sortKey));const B={useDepthForOcclusion:m.depthOcclusionForSymbolsAndCircles};for(const e of F){const{programConfiguration:r,program:s,layoutVertexBuffer:l,dynamicBuffers:c,indexBuffer:h,uniformValues:u,tile:d}=e.state,_=e.segments;t.terrain&&t.terrain.setupElevationDraw(d,s,B),t.uploadCommonUniforms(p,s,d.tileID.toUnwrapped()),s.draw(t,f.TRIANGLES,C,R,z,Qi.disabled,u,o.id,l,h,_,o.paint,m.zoom,r,c)}},heatmap:function(t,r,o,s){if(0!==o.paint.get("heatmap-opacity"))if("offscreen"===t.renderPass){const l=t.context,c=l.gl,h=Yi.disabled,u=new Wi([c.ONE,c.ONE,c.ONE,c.ONE],e.ao.transparent,[!0,!0,!0,!0]);!function(e,t,r,o){const s=e.gl,l=t.width*o,c=t.height*o;e.activeTexture.set(s.TEXTURE1),e.viewport.set([0,0,l,c]);let h=r.heatmapFbo;if(!h||h&&(h.width!==l||h.height!==c)){h&&h.destroy();const t=s.createTexture();s.bindTexture(s.TEXTURE_2D,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),h=r.heatmapFbo=e.createFramebuffer(l,c,1,null),function(e,t,r,o,s,l){const c=e.gl;c.texImage2D(c.TEXTURE_2D,0,e.extRenderToTextureHalfFloat?c.RGBA16F:c.RGBA,s,l,0,c.RGBA,e.extRenderToTextureHalfFloat?c.HALF_FLOAT:c.UNSIGNED_BYTE,null),o.colorAttachment0.set(r)}(e,0,t,h,l,c)}else s.bindTexture(s.TEXTURE_2D,h.colorAttachment0.get()),e.bindFramebuffer.set(h.framebuffer)}(l,t,o,"globe"===t.transform.projection.name?.5:.25),l.clear({color:e.ao.transparent});const d=t.transform,p="globe"===d.projection.name,f=p?["PROJECTION_GLOBE_VIEW"]:[],m=p?Qi.frontCCW:Qi.disabled,_=[e.aF(d.center.lng),e.aJ(d.center.lat)];for(let e=0;e<s.length;e++){const v=s[e];if(r.hasRenderableParent(v))continue;const E=r.getTile(v),P=E.getBucket(o);if(!P||P.projection.name!==d.projection.name)continue;const C=t.isTileAffectedByFog(v),R=P.programConfigurations.get(o.id),z=t.getOrCreateProgram("heatmap",{config:R,defines:f,overrideFog:C}),{zoom:D}=t.transform;t.terrain&&t.terrain.setupElevationDraw(E,z),t.uploadCommonUniforms(l,z,v.toUnwrapped());const O=d.projection.createInversionMatrix(d,v.canonical);z.draw(t,c.TRIANGLES,$i.disabled,h,u,m,ha(t,v,E,O,_,D,o.paint.get("heatmap-intensity")),o.id,P.layoutVertexBuffer,P.indexBuffer,P.segments,o.paint,t.transform.zoom,R,p?[P.globeExtVertexBuffer]:null)}l.viewport.set([0,0,t.width,t.height])}else"translucent"===t.renderPass&&(t.context.setColorMode(t.colorModeForRenderPass()),function(t,r){const o=t.context,s=o.gl,l=r.heatmapFbo;if(!l)return;o.activeTexture.set(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,l.colorAttachment0.get()),o.activeTexture.set(s.TEXTURE1);let c=r.colorRampTexture;c||(c=r.colorRampTexture=new e.T(o,r.colorRamp,s.RGBA8)),c.bind(s.LINEAR,s.CLAMP_TO_EDGE),t.getOrCreateProgram("heatmapTexture").draw(t,s.TRIANGLES,$i.disabled,Yi.disabled,t.colorModeForRenderPass(),Qi.disabled,((e,t)=>({u_image:0,u_color_ramp:1,u_opacity:t.paint.get("heatmap-opacity")}))(0,r),r.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments,r.paint,t.transform.zoom)}(t,o))},line:function(t,r,o,s){if("translucent"!==t.renderPass)return;const l=o.paint.get("line-opacity"),c=o.paint.get("line-width");if(0===l.constantOr(1)||0===c.constantOr(1))return;const h=o.paint.get("line-emissive-strength").isConstant(),u=o.paint.get("line-emissive-strength").constantOr(0),d=o.paint.get("line-occlusion-opacity"),p=o.layout.get("line-elevation-reference"),f="meters"===o.layout.get("line-width-unit"),m="sea"===p,_=!(!t.terrain||!t.terrain.enabled),v=t.context,E=v.gl;if(o.hasElevatedBuckets&&"globe"===t.transform.projection.name)return;const P=o.layout.get("line-cross-slope"),C=void 0!==P,R=P<1,z=t.colorModeForDrapableLayerRenderPass(h?u:null),D=t.terrain&&t.terrain.renderingToTexture,O=D?1:e.o.devicePixelRatio,F=o.paint.get("line-dasharray"),B=F.constantOr(1),k=o.layout.get("line-cap"),V=F.constantOr(null),N=k.constantOr(null),U=o.paint.get("line-pattern"),j=U.constantOr(1),$=o.paint.get("line-pattern-cross-fade"),q=U.constantOr(null),H=o.paint.get("line-opacity").constantOr(1);let Z=!j&&1!==H||t.depthOcclusion&&d>0&&d<1;const Y=o.paint.get("line-gradient"),J=j?"linePattern":"line",Q=e.e2(o);let K;if(D&&t.terrain&&t.terrain.clipOrMaskOverlapStencilType()&&(Z=!1),0!==d&&t.depthOcclusion){const t=o.paint._values["line-opacity"];t&&t.value&&"constant"===t.value.kind?K=t.value:e.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==c.value.kind&&!1===c.value.isLineProgressConstant&&Q.push("VARIABLE_LINE_WIDTH"),D&&("dual-source-blending"!==t.emissiveMode||h?"mrt-fallback"===t.emissiveMode&&Q.push("USE_MRT1"):Q.push("DUAL_SOURCE_BLENDING"));const ee=(s,l,c,h,u,p)=>{for(const _ of s){const s=r.getTile(_);if(j&&!s.patternsLoaded())continue;const P=s.getBucket(o);if(!P)continue;if("none"!==P.elevationType&&!u||"none"===P.elevationType&&u)continue;t.prepareDrawTile();const C=[...l],R=t.shadowRenderer,F="road"===P.elevationType&&!!R&&R.enabled;let k=[0,0,0];if(F){const e=t.style.directionalLight,r=t.style.ambientLight;e&&r&&(k=hn(t.style,e,r)),C.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const U=P.programConfigurations.get(o.id);let Q=!1;if(q&&s.imageAtlas){const t=e.e3.from(q),r=t.getPrimary().scaleSelf(O).toString(),o=s.imageAtlas.patternPositions.get(r),l=t.getSecondary(),c=l?s.imageAtlas.patternPositions.get(l.scaleSelf(O).toString()):null;Q=!!o&&!!c,o&&U.setConstantPatternPositions(o,c)}$>0&&(Q||U.getPatternTransitionVertexBuffer("line-pattern"))&&C.push("LINE_PATTERN_TRANSITION");const ee=t.isTileAffectedByFog(_),te=t.getOrCreateProgram(J,{config:U,defines:C,overrideFog:ee});if(!j&&V&&N&&s.lineAtlas){const e=s.lineAtlas.getDash(V,N);e&&U.setConstantPatternPositions(e)}F&&R.setupShadows(s.tileID.toUnwrapped(),te,"vector-tile");let[ie,re]=o.paint.get("line-trim-offset");if("round"===N||"square"===N){const e=1;ie!==re&&(0===ie&&(ie-=e),1===re&&(re+=e))}const ne=D?_.projMatrix:null,oe=f?1/P.tileToMeter/e.ay(s,1,t.transform.zoom):1,se=f?1/P.tileToMeter/e.ay(s,1,Math.floor(t.transform.zoom)):1,ae=j?e.e4(t,s,o,ne,O,oe,se,[ie,re],k,$):e.e5(t,s,o,ne,P.lineClipsArray.length,O,oe,se,[ie,re],k);if(Y){const s=P.gradients[o.id];let l=s.texture;if(o.gradientVersion!==s.version){let c=256;if(o.stepInterpolant){const o=r.getSource().maxzoom,s=_.canonical.z===o?Math.ceil(1<<t.transform.maxZoom-_.canonical.z):1;c=e.aA(e.e6(P.maxLineLength/e.al*1024*s),256,v.maxTextureSize)}s.gradient=e.e7({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:c,image:s.gradient||void 0,clips:P.lineClipsArray}),s.texture?s.texture.update(s.gradient):s.texture=new e.T(v,s.gradient,E.RGBA8),s.version=o.gradientVersion,l=s.texture}v.activeTexture.set(E.TEXTURE1),l.bind(o.stepInterpolant?E.NEAREST:E.LINEAR,E.CLAMP_TO_EDGE)}B&&(v.activeTexture.set(E.TEXTURE0),s.lineAtlasTexture&&s.lineAtlasTexture.bind(E.LINEAR,E.REPEAT),U.updatePaintBuffers()),j&&(v.activeTexture.set(E.TEXTURE0),s.imageAtlasTexture&&s.imageAtlasTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),U.updatePaintBuffers()),u&&!m&&t.terrain.setupElevationDraw(s,te),t.uploadCommonUniforms(v,te,_.toUnwrapped());const le=e=>{null!=K&&(K.value=H*d),te.draw(t,E.TRIANGLES,c,e,z,Qi.disabled,ae,o.id,P.layoutVertexBuffer,P.indexBuffer,P.segments,o.paint,t.transform.zoom,U,[P.layoutVertexBuffer2,P.patternVertexBuffer,P.zOffsetVertexBuffer]),null!=K&&(K.value=H)};if(Z&&!u){const e=t.stencilModeForClipping(_).ref;0===e&&D&&v.clear({stencil:0});const r={func:E.EQUAL,mask:255};ae.u_alpha_discard_threshold=.8,le(new Yi(r,e,255,E.KEEP,E.KEEP,E.INVERT)),ae.u_alpha_discard_threshold=0,le(new Yi(r,e,255,E.KEEP,E.KEEP,E.KEEP))}else ae.u_alpha_discard_threshold=Z&&u&&p?.8:0,le(u?h:t.stencilModeForClipping(_))}};let te=t.depthModeForSublayer(0,$i.ReadOnly);const ie=new $i(t.depthOcclusion?E.GREATER:E.LEQUAL,$i.ReadOnly,t.depthRangeFor3D);if(o.hasNonElevatedBuckets){const r=!D&&t.terrain;0!==d&&r?e.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):r?e.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):ee(s,Q,te,Yi.disabled,!1,!0)}if(o.hasElevatedBuckets){"hd-road-markup"===p?_||(te=ie,Q.push("ELEVATED_ROADS")):(Q.push("ELEVATED"),te=ie,C&&Q.push(R?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),m&&Q.push("ELEVATION_REFERENCE_SEA"));const e=Z?t.stencilModeFor3D():Yi.disabled;t.forceTerrainMode=!0,ee(s,Q,te,e,!0,!0),Z&&ee(s,Q,te,e,!0,!1),t.forceTerrainMode=!1}Z&&(t.resetStencilClippingMasks(),D&&v.clear({stencil:0})),0===d||t.depthOcclusion||D||t.layersWithOcclusionOpacity.push(t.currentLayer)},fill:function(t,r,o,s){const l=o.paint.get("fill-color"),c=o.paint.get("fill-opacity");if(0===c.constantOr(1))return;const h=o.paint.get("fill-emissive-strength"),u=t.colorModeForDrapableLayerRenderPass(h),d=o.paint.get("fill-pattern"),p=t.opaquePassEnabledForLayer()&&!d.constantOr(1)&&1===l.constantOr(e.ao.transparent).a&&1===c.constantOr(0)?"opaque":"translucent";let f="none";"none"!==o.layout.get("fill-elevation-reference")?f="road":0!==o.paint.get("fill-z-offset").constantOr(1)&&(f="offset");const m=!(!t.terrain||!t.terrain.enabled),_={painter:t,sourceCache:r,layer:o,coords:s,colorMode:u,elevationType:f,terrainEnabled:m,pass:p};if("shadow"===t.renderPass)return void(t.shadowRenderer&&"road"===f&&!m&&function(e){const{painter:t,sourceCache:r,layer:o,coords:s}=e,l=t.context.gl,c=e.painter.shadowRenderer;for(const e of s){const s=r.getTile(e),h=s.getBucket(o);if(!h)continue;const u=h.elevatedStructures;if(!u)continue;if(!u.shadowCasterSegments||0===u.shadowCasterSegments.segments[0].primitiveLength)continue;t.prepareDrawTile();const d=h.bufferData.programConfigurations.get(o.id),p=t.isTileAffectedByFog(e),f=t.getOrCreateProgram("elevatedStructuresDepth",{config:d,overrideFog:p}),m=c.calculateShadowPassMatrixFromTile(s.tileID.toUnwrapped());t.uploadCommonUniforms(t.context,f,e.toUnwrapped());const _=ea(m,0);f.draw(t,l.TRIANGLES,c.getShadowPassDepthMode(),Yi.disabled,c.getShadowPassColorMode(),Qi.disabled,_,o.id,u.vertexBuffer,u.indexBuffer,u.shadowCasterSegments,o.paint,t.transform.zoom,d)}}(_));const v="mrt-fallback"===t.emissiveMode;if("offset"!==f){if(ec(_,!1,v),"road"===f){const e=!m&&"translucent"===t.renderPass;e&&Xl(t,r,o,s,"geometry"),ec(_,!0,v,Yi.disabled),e&&function(e){const{painter:t,sourceCache:r,layer:o,coords:s,colorMode:l}=e,c=t.context.gl,h=e.painter.shadowRenderer,u=!!h&&h.enabled,d=new $i(t.context.gl.LEQUAL,$i.ReadOnly,t.depthRangeFor3D);let p=[0,0,0];if(u){const e=t.style.directionalLight,r=t.style.ambientLight;e&&r&&(p=hn(t.style,e,r))}const f=e=>{for(const f of s){const s=r.getTile(f),m=s.getBucket(o);if(!m)continue;const _=m.elevatedStructures;if(!_)continue;let v,E;if(e?(v=_.renderableBridgeSegments,E=_.bridgeProgramConfigurations.get(o.id)):(v=_.renderableTunnelSegments,E=_.tunnelProgramConfigurations.get(o.id)),!v||0===v.segments[0].primitiveLength)continue;E.updatePaintBuffers(),t.prepareDrawTile();const P=t.isTileAffectedByFog(f),C=[];u&&C.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const R=t.getOrCreateProgram("elevatedStructures",{config:E,overrideFog:P,defines:C}),z=t.translatePosMatrix(f.projMatrix,s,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor"));u&&h.setupShadows(s.tileID.toUnwrapped(),R,"vector-tile");const D=ta(z,p);t.uploadCommonUniforms(t.context,R,f.toUnwrapped()),R.draw(t,c.TRIANGLES,d,Yi.disabled,l,Qi.backCCW,D,o.id,_.vertexBuffer,_.indexBuffer,v,o.paint,t.transform.zoom,E,[_.vertexBufferNormal])}};f(!0),f(!1)}(_)}}else ec(_,!1,v,t.stencilModeFor3D())},"fill-extrusion":function(t,r,o,s){const l=o.paint.get("fill-extrusion-opacity"),c=t.context,h=c.gl,u=t.terrain,d=u&&u.renderingToTexture;if(0===l)return;const p="mrt-fallback"===t.emissiveMode,f=t.conflationActive&&t.style.isLayerClipped(o,r.getSource()),m=t.style.order.indexOf(o.fqid);if(f&&function(e,t,r,o,s){for(const l of o){const o=t.getTile(l).getBucket(r);o&&(o.updateReplacement(l,e.replacementSource,s),o.uploadCentroid(e.context))}}(t,r,o,s,m),u||f)for(const e of s){const s=r.getTile(e).getBucket(o);s&&oc(t.context,r,e,s,o,u,f)}if("shadow"===t.renderPass&&t.shadowRenderer){const c=t.shadowRenderer;if(u&&l<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof e.ad)return;const h=c.getShadowPassDepthMode(),d=c.getShadowPassColorMode();tc(t,r,o,s,h,Yi.disabled,d,f)}else if("translucent"===t.renderPass){const m=!o.paint.get("fill-extrusion-pattern").constantOr(1),_=o.paint.get("fill-extrusion-color").constantOr(e.ao.white);if(!d&&0!==_.a){const e=new $i(t.context.gl.LEQUAL,$i.ReadWrite,t.depthRangeFor3D);1===l&&m?tc(t,r,o,s,e,Yi.disabled,Wi.unblended,f):(tc(t,r,o,s,e,Yi.disabled,Wi.disabled,f),tc(t,r,o,s,e,t.stencilModeFor3D(),t.colorModeForRenderPass(),f),t.resetStencilClippingMasks())}if(t.style.enable3dLights()&&m&&(!u&&"globe"!==t.transform.projection.name||d)){const l=o.paint.get("fill-extrusion-opacity"),m=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),_=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),v=o.paint.get("fill-extrusion-flood-light-intensity"),E="none"===o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),P=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(E?null:o.lut).toArray01().slice(0,3),C=m>0&&_>0,R=v>0,z=(e,t,r)=>(1-r)*e+r*t,D=new un;D.translate=o.paint.get("fill-extrusion-translate"),D.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),D.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),D.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");const O=c=>{const u=t.depthModeForSublayer(1,$i.ReadOnly,h.LEQUAL,!0),d=o.paint.get(c?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),p=z(.1,3,d),E=t._showOverdrawInspector;if(!E){const d=new Yi({func:h.ALWAYS,mask:255},255,255,h.KEEP,h.KEEP,h.REPLACE),E=new Wi([h.ONE,h.ONE,h.ONE,h.ONE],e.ao.transparent,[!1,!1,!1,!0],h.MIN);nc(D,t,r,o,s,u,d,E,Qi.disabled,c,"sdf",l,m,_,v,P,p,f,!1)}{const d=E?Yi.disabled:new Yi({func:h.EQUAL,mask:255},255,255,h.KEEP,h.DECR,h.DECR),C=E?t.colorModeForRenderPass():new Wi([h.ONE_MINUS_DST_ALPHA,h.DST_ALPHA,h.ONE,h.ONE],e.ao.transparent,[!0,!0,!0,!0]);nc(D,t,r,o,s,u,d,C,Qi.disabled,c,"color",l,m,_,v,P,p,f,!1)}};if(d){const d=()=>{const t=u.drapeBufferSize[0],r=u.drapeBufferSize[1];let o=u.framebufferCopyTexture;return o&&(!o||o.size[0]===t&&o.size[1]===r)||(o&&o.destroy(),o=u.framebufferCopyTexture=new e.T(c,new e.q({width:t,height:r}),h.RGBA8)),o.bind(h.LINEAR,h.CLAMP_TO_EDGE),h.copyTexSubImage2D(h.TEXTURE_2D,0,0,0,0,0,t,r),o},E=(c,u,E)=>{const C=t.depthModeForSublayer(1,$i.ReadOnly,h.LEQUAL,!1),R=o.paint.get(c?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),O=z(.1,3,R);{const d=new Wi([h.ONE,h.ONE,h.ONE,h.ONE],e.ao.transparent,[!1,!1,!1,!0]);nc(D,t,r,o,s,C,Yi.disabled,d,Qi.disabled,c,"clear",l,m,_,v,P,O,f,u)}{const d=new Yi({func:h.ALWAYS,mask:255},255,255,h.KEEP,h.KEEP,h.REPLACE),p=new Wi([h.ONE,h.ONE,h.ONE,h.ONE],e.ao.transparent,[!1,!1,!1,!0],h.MIN);nc(D,t,r,o,s,C,d,p,Qi.disabled,c,"sdf",l,m,_,v,P,O,f,u)}p&&!c&&(E=d());{const d=c?h.ZERO:h.ONE_MINUS_DST_ALPHA,p=new Yi({func:h.EQUAL,mask:255},255,255,h.KEEP,h.DECR,h.DECR),E=new Wi([d,h.DST_ALPHA,h.ONE_MINUS_DST_ALPHA,h.ZERO],e.ao.transparent,[!0,!0,!0,!0]);nc(D,t,r,o,s,C,p,E,Qi.disabled,c,"color",l,m,_,v,P,O,f,u)}if(!p||c){const d=new Wi([h.ONE,h.ONE,h.ONE,c?h.ZERO:h.ONE],e.ao.transparent,[!1,!1,!1,!0],c?h.FUNC_ADD:h.MAX);nc(D,t,r,o,s,C,Yi.disabled,d,Qi.disabled,c,"clear",l,m,_,v,P,O,f,u,E)}else{h.drawBuffers([h.NONE,h.COLOR_ATTACHMENT1]);const d=new Yi({func:h.EQUAL,mask:255},254,255,h.KEEP,h.DECR,h.DECR),p=new Wi([h.ONE,h.ONE,h.ONE,h.ONE],e.ao.transparent,[!0,!1,!1,!1],h.MAX);nc(D,t,r,o,s,C,d,p,Qi.disabled,c,"emissive",l,m,_,v,P,O,f,u,E),h.drawBuffers([h.COLOR_ATTACHMENT0])}};if(C||R){let e;t.prepareDrawTile(),p&&!C||(e=d()),C&&E(!0,!1,e),R&&E(!1,!0,e)}}else C&&O(!0),R&&O(!1),(C||R)&&t.resetStencilClippingMasks()}}},building:function(e,t,r,o){e.currentLayer<e.firstLightBeamLayer&&(e.firstLightBeamLayer=e.currentLayer);const s=r.paint.get("building-ambient-occlusion-ground-intensity"),l=r.paint.get("building-ambient-occlusion-ground-radius"),c=r.paint.get("building-ambient-occlusion-ground-attenuation"),h=r.paint.get("building-opacity");if(h<=0)return;let u=s>0&&l>0,d=!0;const p=r.paint.get("building-vertical-scale");if(p<=0)return;e.shadowRenderer||(d=!1);const f=e.conflationActive&&e.style.isLayerClipped(r,t.getSource()),m=e.style.order.indexOf(r.fqid);if(function(e,t,r,o,s,l){for(const c of l){const l=t.getTile(c).getBucket(r);l&&(s&&l.updateReplacement(c,e.replacementSource,o),l.uploadUpdatedIndexBuffer(e.context))}}(e,t,r,m,f,o),function(e,t,r,o){for(const s of o){const o=t.getTile(s).getBucket(r);o&&o.needsEvaluation()&&o.uploadUpdatedColorBuffer(e.context)}}(e,t,r,o),r.resetLayerRenderingStats(e),e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0),"shadow"===e.renderPass&&e.shadowRenderer){const s=e.shadowRenderer,l=[],c=s.getShadowPassDepthMode();gc({painter:e,source:t,layer:r,coords:o,defines:l,blendMode:s.getShadowPassColorMode(),depthMode:c,opacity:h,verticalScale:p,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if("translucent"===e.renderPass){let m=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];d&&(m=m.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),e.shadowRenderer&&e.shadowRenderer.useNormalOffset&&(m=m.concat("NORMAL_OFFSET"));const _=r.paint.get("building-facade-emissive-chance"),v=r.paint.get("building-ambient-occlusion-intensity"),E=r.paint.get("building-flood-light-intensity"),P="none"===r.paint.get("building-flood-light-color-use-theme").constantOr("default"),C=r.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(P?null:r.lut).toArray01().slice(0,3),R=r.paint.get("building-flood-light-ground-attenuation"),z=E>0,D=new $i(e.context.gl.LEQUAL,$i.ReadWrite,e.depthRangeFor3D);h<1&&gc({painter:e,source:t,layer:r,coords:o,defines:m,blendMode:Wi.disabled,depthMode:D,opacity:h,verticalScale:p,facadeEmissiveChance:_,facadeAOIntensity:v,floodLightIntensity:E,floodLightColor:C,depthOnly:!0});const O=e.colorModeForRenderPass();gc({painter:e,source:t,layer:r,coords:o,defines:m,blendMode:O,depthMode:D,opacity:h,verticalScale:p,facadeEmissiveChance:_,facadeAOIntensity:v,floodLightIntensity:E,floodLightColor:C}),u&&yc(e,t,r,o,!0,h,s,l,E,C,c,f),z&&yc(e,t,r,o,!1,h,s,l,E,C,R,f)}else if("light-beam"===e.renderPass){const s=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],l=new $i(e.context.gl.LEQUAL,$i.ReadOnly,e.depthRangeFor3D);gc({painter:e,source:t,layer:r,coords:o,defines:s,blendMode:Wi.alphaBlended,depthMode:l,opacity:h,verticalScale:p,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1),e.resetStencilClippingMasks()},hillshade:function(e,t,r,o){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;if(e.style.disableElevatedTerrain)return;const s=e.context,l=e.terrain&&e.terrain.renderingToTexture,[c,h]="translucent"!==e.renderPass||l?[{},o]:e.stencilConfigForOverlap(o);for(const o of h){const s=t.getTile(o);if(s.needsHillshadePrepare&&"offscreen"===e.renderPass)xo(e,s,r);else if("translucent"===e.renderPass){const t=e.depthModeForSublayer(0,$i.ReadOnly),h=r.paint.get("hillshade-emissive-strength"),u=e.colorModeForDrapableLayerRenderPass(h),d=l&&e.terrain?e.terrain.stencilModeForRTTOverlap(o):c[o.overscaledZ];mo(e,o,s,r,t,d,u)}}s.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(t,r,o,s,l,c){if("translucent"!==t.renderPass)return;if(0===o.paint.get("raster-opacity"))return;const h="globe"===t.transform.projection.name,u=0!==o.paint.get("raster-elevation"),d=u&&h;if(t.renderElevatedRasterBackface&&!d)return;const p=t.context,f=p.gl,m=r.getSource(),_=function(t,r,o,s,l){const c=r.paint.get("raster-color"),h="raster-array"===t.type,u=[],d=r.paint.get("raster-resampling"),p=r.paint.get("raster-color-mix");let f=r.paint.get("raster-color-range");const m=[p[0],p[1],p[2],0],_=p[3];let v="nearest"===d?s.NEAREST:s.LINEAR;if(h&&(u.push("RASTER_ARRAY"),c||u.push("RASTER_COLOR"),"linear"===d&&u.push("RASTER_ARRAY_LINEAR"),v=s.NEAREST,!f&&t.rasterLayers)){const e=t.rasterLayers.find((({id:e})=>e===r.sourceLayer));e&&e.fields&&e.fields.range&&(f=e.fields.range)}if(f=f||[0,1],c){u.push("RASTER_COLOR"),o.activeTexture.set(s.TEXTURE2),r.updateColorRamp(f);let t=r.colorRampTexture;t||(t=r.colorRampTexture=new e.T(o,r.colorRamp,s.RGBA8)),t.bind(v,s.CLAMP_TO_EDGE)}return l&&u.push("USE_MRT1"),{mix:m,range:f,offset:_,defines:u,resampling:v}}(m,o,p,f,t.terrain&&t.terrain.renderingToTexture&&"mrt-fallback"===t.emissiveMode);if(m instanceof e.aU&&!s.length&&!h)return;const v=o.paint.get("raster-emissive-strength"),E=t.colorModeForDrapableLayerRenderPass(v),P=t.terrain&&t.terrain.renderingToTexture,C=!t.options.moving,R="nearest"===o.paint.get("raster-resampling")?f.NEAREST:f.LINEAR;if(m instanceof e.aU&&!s.length&&(m.onNorthPole||m.onSouthPole)){const e=u?t.stencilModeFor3D():Yi.disabled;return void vc(!!m.onNorthPole,null,t,r,o,v,_,Qi.disabled,e)}if(!s.length)return;const[z,D]=m instanceof e.aU||P?[{},s]:t.stencilConfigForOverlap(s),O=D[D.length-1].overscaledZ;d&&_.defines.push("PROJECTION_GLOBE_VIEW"),u&&_.defines.push("RENDER_CUTOFF");const F=(s,l,D)=>{for(const F of s){const s=F.toUnwrapped(),B=r.getTile(F);if(P&&(!B||!B.hasData()))continue;p.activeTexture.set(f.TEXTURE0);const k=Ec(B,m,o,_);if(!k||!k.texture)continue;const{texture:V,mix:N,offset:U,tileSize:j,buffer:$}=k;let q,H;P?(q=$i.disabled,H=F.projMatrix):u?(q=new $i(f.LEQUAL,$i.ReadWrite,t.depthRangeFor3D),H=h?Float32Array.from(t.transform.expandedFarZProjMatrix):t.transform.calculateProjMatrix(s,C)):(q=t.depthModeForSublayer(F.overscaledZ-O,1===o.paint.get("raster-opacity")?$i.ReadWrite:$i.ReadOnly,f.LESS),H=t.transform.calculateProjMatrix(s,C));const Z=t.terrain&&P?t.terrain.stencilModeForRTTOverlap(F):z[F.overscaledZ],Y=c?0:o.paint.get("raster-fade-duration");B.registerFadeDuration(Y);const J=r.findLoadedParent(F,0),Q=ko(B,J,r,t.transform,Y);let K,ee;!Q.isFading&&B.refreshedUponExpiration&&(B.refreshedUponExpiration=!1),t.terrain&&t.terrain.prepareDrawTile(),p.activeTexture.set(f.TEXTURE0),V.bind(R,f.CLAMP_TO_EDGE),p.activeTexture.set(f.TEXTURE1),J?(J.texture&&J.texture.bind(R,f.CLAMP_TO_EDGE),K=Math.pow(2,J.tileID.overscaledZ-B.tileID.overscaledZ),ee=[B.tileID.canonical.x*K%1,B.tileID.canonical.y*K%1]):V.bind(R,f.CLAMP_TO_EDGE),"useMipmap"in V&&p.extTextureFilterAnisotropic&&t.transform.pitch>20&&f.texParameterf(f.TEXTURE_2D,p.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,p.extTextureFilterAnisotropicMax);const te=t.transform;let ie;const re=u?Tc(te):[0,0,0,0];let ne,oe,se,ae,le,ce=0;if(d&&m instanceof e.aU&&m.coordinates.length>3)ne=Float32Array.from(e.bk(e.dJ(new e.cD(0,0,0)))),oe=Float32Array.from(te.globeMatrix),se=Float32Array.from(e.dF(te)),ae=[e.aF(te.center.lng),e.aJ(te.center.lat)],ie=m.elevatedGlobePerspectiveTransform,le=m.elevatedGlobeGridMatrix||new Float32Array(9);else if(d){const t=e.dG(F.canonical);ce=e.dH(t.getCenter().lat),ne=Float32Array.from(e.bk(e.dJ(F.canonical))),oe=Float32Array.from(te.globeMatrix),se=Float32Array.from(e.dF(te)),ae=[e.aF(te.center.lng),e.aJ(te.center.lat)],ie=[0,0],le=Float32Array.from(e.dI(F.canonical,t,ce,te.worldSize/te._pixelsPerMercatorPixel))}else ie=m instanceof e.aU?m.perspectiveTransform:[0,0],ne=new Float32Array(16),oe=new Float32Array(9),se=new Float32Array(16),ae=[0,0],le=new Float32Array(9);const he=ma(H,ne,oe,se,le,ee||[0,0],e.aj(t.transform.zoom),ae,re,K||1,Q,o,ie,u?o.paint.get("raster-elevation"):0,2,N,U,_.range,j,$,v),ue=t.isTileAffectedByFog(F),de=t.getOrCreateProgram("raster",{defines:_.defines,overrideFog:ue});if(t.uploadCommonUniforms(p,de,s),m instanceof e.aU){const r=m.elevatedGlobeVertexBuffer,s=m.elevatedGlobeIndexBuffer;if(P||!h)m.boundsBuffer&&m.boundsSegments&&de.draw(t,f.TRIANGLES,q,Yi.disabled,E,Qi.disabled,he,o.id,m.boundsBuffer,t.quadTriangleIndexBuffer,m.boundsSegments);else if(r&&s){const c=te.zoom<=e.c_?m.elevatedGlobeSegments:m.getSegmentsForLongitude(te.center.lng);c&&de.draw(t,f.TRIANGLES,q,Yi.disabled,E,l,he,o.id,r,s,c)}}else if(d){q=new $i(f.LEQUAL,$i.ReadOnly,t.depthRangeFor3D);const e=t.globeSharedBuffers;if(e){const[r,s,c]=e.getGridBuffers(ce,!1);de.draw(t,f.TRIANGLES,q,D||Z,t.colorModeForRenderPass(),l,he,o.id,r,s,c)}}else{const{tileBoundsBuffer:e,tileBoundsIndexBuffer:r,tileBoundsSegments:s}=t.getTileBoundsBuffers(B);de.draw(t,f.TRIANGLES,q,Z,E,Qi.disabled,he,o.id,e,r,s)}}if(!(m instanceof e.aU)&&d)for(const e of s){const s=e.canonical.y===(1<<e.canonical.z)-1;0===e.canonical.y&&vc(!0,e,t,r,o,v,_,l,D||Yi.disabled),s&&vc(!1,e,t,r,o,v,_,l===Qi.frontCW?Qi.backCW:Qi.frontCW,D||Yi.disabled)}};d?F(D,t.renderElevatedRasterBackface?Qi.backCW:Qi.frontCW,t.stencilModeFor3D()):F(D,Qi.disabled,void 0),t.resetStencilClippingMasks()},"raster-particle":function(t,r,o,s,l,c){"offscreen"===t.renderPass&&function(t,r,o,s){if(!s.length)return;const l=t.context,c=l.gl,h=r.getSource();if(!(h instanceof pt))return;const u=Math.ceil(Math.sqrt(o.paint.get("raster-particle-count")));let d=o.particlePositionRGBAImage;if(!d||d.width!==u){const t=function(e){const t=e*e,r=new Uint8Array(4*t),o=function(e){return e|=0,e=Math.imul(2747636419^e,2654435769),e=Math.imul(e^e>>>16,2654435769),((e=Math.imul(e^e>>>16,2654435769))>>>0)/4294967296},s=.9090909090909091;for(let e=0;e<t;e++){const t=s*(o(2*e+0)+ba),l=s*(o(2*e+1)+ba),c=255*t%1,h=255*l%1,u=c,d=l-h/255,p=h;r[4*e+0]=255*(t-c/255),r[4*e+1]=255*u,r[4*e+2]=255*d,r[4*e+3]=255*p}return r}(u);d=o.particlePositionRGBAImage=new e.q({width:u,height:u},t)}let p=o.particleFramebuffer;p?p.width!==u&&(p.destroy(),p=o.particleFramebuffer=l.createFramebuffer(u,u,1,null)):p=o.particleFramebuffer=l.createFramebuffer(u,u,1,null);const f=[];for(const e of s){const t=r.getTile(e);if(!(t instanceof Ot))continue;const s=Cc(t,h,o);if(!s)continue;const c=[t.tileSize,t.tileSize];let p=o.tileFramebuffer;p||(p=o.tileFramebuffer=l.createFramebuffer(c[0],c[1],1,null));let m=t.rasterParticleState;m||(m=t.rasterParticleState=new In(l,e,c,d));const _=m.update(o.lastInvalidatedAt);m.particleTextureDimension!==u&&m.updateParticleTexture(e,d);const v=m.targetColorTexture;m.targetColorTexture=m.backgroundColorTexture,m.backgroundColorTexture=v;const E=m.particleTexture0;m.particleTexture0=m.particleTexture1,m.particleTexture1=E,f.push([e,s,m,_])}if(0===f.length)return;const m=e.o.now(),_=o.previousDrawTimestamp?.001*(m-o.previousDrawTimestamp):.0167;if(o.previousDrawTimestamp=m,o.hasColorMap()){l.activeTexture.set(c.TEXTURE0+2);let t=o.colorRampTexture;t||(t=o.colorRampTexture=new e.T(l,o.colorRamp,c.RGBA8)),t.bind(c.LINEAR,c.CLAMP_TO_EDGE)}l.bindFramebuffer.set(o.tileFramebuffer.framebuffer),function(t,r,o){const s=t.context,l=s.gl,c=r.tileFramebuffer;s.activeTexture.set(l.TEXTURE0);const h={u_texture:0,u_opacity:1.05*(d=r.paint.get("raster-particle-fade-opacity-factor"))/(d+.05)},u=t.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var d;for(const d of o){const[,,o,p]=d;c.colorAttachment0.set(o.targetColorTexture.texture),s.viewport.set([0,0,c.width,c.height]),s.clear({color:e.ao.transparent}),p&&(o.backgroundColorTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE),u.draw(t,l.TRIANGLES,$i.disabled,Yi.disabled,Wi.alphaBlended,Qi.disabled,h,r.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments))}}(t,o,f),function(t,r,o,s){const l=t.context,c=l.gl,h=o.tileFramebuffer,u="globe"===t.transform.projection.name,d=o.paint.get("raster-particle-max-speed");for(const p of s){const[s,f,m]=p;l.activeTexture.set(c.TEXTURE0+0),f.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),h.colorAttachment0.set(m.targetColorTexture.texture);const _=t.getOrCreateProgram("rasterParticleDraw",{defines:f.defines,overrideFog:!1});l.activeTexture.set(c.TEXTURE0+1);const v=f.scalarData?[]:[0,1,2,3].map((t=>e.e9[t](s)));v.push(s);const E=s.canonical.x,P=s.canonical.y;for(const e of v){const l=r.getTile(u?e.wrapped():e);if(!l)continue;const h=l.rasterParticleState;if(!h)continue;const p=e.canonical.x+(1<<e.canonical.z)*(e.wrap-s.wrap),m=e.canonical.y;h.particleTexture0.bind(c.NEAREST,c.CLAMP_TO_EDGE);const v=Ta(1,h.particleTexture0.size[0],[p-E,m-P],0,f.texture.size,2,d,f.textureOffset,f.scale,f.offset);_.draw(t,c.POINTS,$i.disabled,Yi.disabled,Wi.alphaBlended,Qi.disabled,v,o.id,h.particleIndexBuffer,void 0,h.particleSegment)}}}(t,r,o,f),l.bindFramebuffer.set(o.particleFramebuffer.framebuffer),function(t,r,o,s){const l=t.context,c=l.gl,h=r.paint.get("raster-particle-max-speed"),u=s*r.paint.get("raster-particle-speed-factor")*.15,d=function(e){return Math.pow(e,6)}(.01+1*r.paint.get("raster-particle-reset-rate-factor")),p=r.particleFramebuffer;l.viewport.set([0,0,p.width,p.height]);for(const s of o){const[,o,f]=s;l.activeTexture.set(c.TEXTURE0+0),o.texture.bind(c.LINEAR,c.CLAMP_TO_EDGE),l.activeTexture.set(c.TEXTURE0+1);const m=f.particleTexture0;m.bind(c.NEAREST,c.CLAMP_TO_EDGE);const _=Ia(1,m.size[0],0,o.texture.size,h,u,d,o.textureOffset,o.scale,o.offset);p.colorAttachment0.set(f.particleTexture1.texture),l.clear({color:e.ao.transparent}),t.getOrCreateProgram("rasterParticleUpdate",{defines:o.defines}).draw(t,c.TRIANGLES,$i.disabled,Yi.disabled,Wi.unblended,Qi.disabled,_,r.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments)}}(t,o,f,_)}(t,r,o,s),"translucent"===t.renderPass&&(function(t,r,o,s){const l=t.context,c=l.gl,h=r.getSource().tileSize,u=5*(1-e.ah(e.cL,e.cL+1,t.transform.zoom))*h+o.paint.get("raster-particle-elevation"),d=!t.options.moving,p="globe"===t.transform.projection.name;if(!s.length)return;const[f,m]=t.stencilConfigForOverlap(s),_=[];p&&_.push("PROJECTION_GLOBE_VIEW");const v=t.stencilModeFor3D();for(const s of m){const h=s.toUnwrapped(),m=r.getTile(s);if(!m.rasterParticleState)continue;const E=m.rasterParticleState,P=100;m.registerFadeDuration(P);const C=r.findLoadedParent(s,0),R=ko(m,C,r,t.transform,P);let z,D;t.terrain&&t.terrain.prepareDrawTile(),l.activeTexture.set(c.TEXTURE0),E.targetColorTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),l.activeTexture.set(c.TEXTURE1),C&&C.rasterParticleState?(C.rasterParticleState.targetColorTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),z=Math.pow(2,C.tileID.overscaledZ-m.tileID.overscaledZ),D=[m.tileID.canonical.x*z%1,m.tileID.canonical.y*z%1]):E.targetColorTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE);const O=p?Float32Array.from(t.transform.expandedFarZProjMatrix):t.transform.calculateProjMatrix(h,d),F=t.transform,B=Rc(F),k=e.dG(s.canonical),V=e.dH(k.getCenter().lat);let N,U,j,$,q;p?(N=Float32Array.from(e.bk(e.dJ(s.canonical))),U=Float32Array.from(F.globeMatrix),j=Float32Array.from(e.dF(F)),$=[e.aF(F.center.lng),e.aJ(F.center.lat)],q=Float32Array.from(e.dI(s.canonical,k,V,F.worldSize/F._pixelsPerMercatorPixel))):(N=new Float32Array(16),U=new Float32Array(9),j=new Float32Array(16),$=[0,0],q=new Float32Array(9));const H=wa(O,N,U,j,q,D||[0,0],e.aj(t.transform.zoom),$,B,z||1,R,u),Z=t.isTileAffectedByFog(s),Y=t.getOrCreateProgram("rasterParticle",{defines:_,overrideFog:Z});if(t.uploadCommonUniforms(l,Y,h),p){const e=new $i(c.LEQUAL,$i.ReadOnly,t.depthRangeFor3D),r=0,s=t.globeSharedBuffers;if(s){const[l,h,u]=s.getGridBuffers(V,0!==r);Y.draw(t,c.TRIANGLES,e,v,Wi.alphaBlended,t.renderElevatedRasterBackface?Qi.frontCCW:Qi.backCCW,H,o.id,l,h,u)}}else{const e=t.depthModeForSublayer(0,$i.ReadOnly),r=f[s.overscaledZ],{tileBoundsBuffer:l,tileBoundsIndexBuffer:h,tileBoundsSegments:u}=t.getTileBoundsBuffers(m);Y.draw(t,c.TRIANGLES,e,r,Wi.alphaBlended,Qi.disabled,H,o.id,l,h,u)}}t.resetStencilClippingMasks()}(t,r,o,s),t.style.map.triggerRepaint())},background:function(t,r,o,s){const l=o.paint.get("background-color"),c="none"===o.paint.get("background-color-use-theme").constantOr("default"),h=o.paint.get("background-opacity"),u=o.paint.get("background-emissive-strength"),d="viewport"===o.paint.get("background-pitch-alignment");if(0===h)return;const p=t.context,f=p.gl,m=t.transform,_=m.tileSize,v=o.paint.get("background-pattern");let E;if(void 0!==v){if(null===v)return;if(E=t.imageManager.getPattern(e.I.from(v.toString()),o.scope,t.style.getLut(o.scope)),!E)return}const P=!v&&1===l.a&&1===h&&t.opaquePassEnabledForLayer()?"opaque":"translucent";if(t.renderPass!==P)return;const C=Yi.disabled,R=t.depthModeForSublayer(0,"opaque"===P?$i.ReadWrite:$i.ReadOnly),z=t.colorModeForDrapableLayerRenderPass(u),D=v?"backgroundPattern":"background";let O,F=s;F||(O=t.getBackgroundTiles(),F=Object.values(O).map((e=>e.tileID))),v&&(p.activeTexture.set(f.TEXTURE0),t.imageManager.bind(t.context,o.scope));const B=[];if(t.terrain&&t.terrain.renderingToTexture&&"mrt-fallback"===t.emissiveMode&&B.push("USE_MRT1"),d){const r=t.getOrCreateProgram(D,{overrideFog:!1,overrideRtt:!0,defines:B}),s=new Float32Array(e.bA([])),p=new e.aQ(0,0,0,0,0),m=v?Da(s,u,h,t,0,o.scope,E,d,{tileID:p,tileSize:_}):Ra(s,u,h,l.toPremultipliedRenderColor(c?null:o.lut));r.draw(t,f.TRIANGLES,R,C,z,Qi.disabled,m,o.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments)}else for(const e of F){const P=t.isTileAffectedByFog(e),F=t.getOrCreateProgram(D,{overrideFog:P,defines:B}),k=e.toUnwrapped(),V=s?e.projMatrix:t.transform.calculateProjMatrix(k);t.prepareDrawTile();const N=r?r.getTile(e):O?O[e.key]:new Pt(e,_,m.zoom,t),U=v?Da(V,u,h,t,0,o.scope,E,d,{tileID:e,tileSize:_}):Ra(V,u,h,l.toPremultipliedRenderColor(c?null:o.lut));t.uploadCommonUniforms(p,F,k);const{tileBoundsBuffer:j,tileBoundsIndexBuffer:$,tileBoundsSegments:q}=t.getTileBoundsBuffers(N);F.draw(t,f.TRIANGLES,R,C,z,Qi.disabled,U,o.id,j,$,q)}},sky:function(t,r,o){const s=t._atmosphere?e.aj(t.transform.zoom):1,l=o.paint.get("sky-opacity")*s;if(0===l)return;const c=t.context,h=o.paint.get("sky-type"),u=new $i(c.gl.LEQUAL,$i.ReadOnly,[0,1]),d=t.frameCounter/1e3%1;"atmosphere"===h?"offscreen"===t.renderPass?o.needsSkyboxCapture(t)&&(function(t,r){const o=t.context,s=o.gl;let l=r.skyboxFbo;if(!l){l=r.skyboxFbo=o.createFramebuffer(32,32,1,null),r.skyboxGeometry=new Vn(o),r.skyboxTexture=o.gl.createTexture(),s.bindTexture(s.TEXTURE_CUBE_MAP,r.skyboxTexture),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR);for(let e=0;e<6;++e)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,s.RGBA,32,32,0,s.RGBA,s.UNSIGNED_BYTE,null)}o.bindFramebuffer.set(l.framebuffer),o.viewport.set([0,0,32,32]);const c=r.getCenter(t,!0),h=t.getOrCreateProgram("skyboxCapture"),u=new Float64Array(16);e.bA(u),e.en(u,u,.5*-Math.PI),qc(t,r,h,u,c,0),e.bA(u),e.en(u,u,.5*Math.PI),qc(t,r,h,u,c,1),e.bA(u),e.cU(u,u,.5*-Math.PI),qc(t,r,h,u,c,2),e.bA(u),e.cU(u,u,.5*Math.PI),qc(t,r,h,u,c,3),e.bA(u),qc(t,r,h,u,c,4),e.bA(u),e.en(u,u,Math.PI),qc(t,r,h,u,c,5),o.viewport.set([0,0,t.width,t.height])}(t,o),o.markSkyboxValid(t)):"sky"===t.renderPass&&function(e,t,r,o,s){const l=e.context,c=l.gl,h=e.transform,u=e.getOrCreateProgram("skybox");l.activeTexture.set(c.TEXTURE0),c.bindTexture(c.TEXTURE_CUBE_MAP,t.skyboxTexture);const d=((e,t,r,o,s)=>({u_matrix:e,u_sun_direction:t,u_cubemap:0,u_opacity:o,u_temporal_offset:s}))(h.skyboxMatrix,t.getCenter(e,!1),0,o,s);e.uploadCommonUniforms(l,u),u.draw(e,c.TRIANGLES,r,Yi.disabled,e.colorModeForRenderPass(),Qi.backCW,d,"skybox",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}(t,o,u,l,d):"gradient"===h&&"sky"===t.renderPass&&function(t,r,o,s,l){const c=t.context,h=c.gl,u=t.transform,d=t.getOrCreateProgram("skyboxGradient");r.skyboxGeometry||(r.skyboxGeometry=new Vn(c)),c.activeTexture.set(h.TEXTURE0);let p=r.colorRampTexture;p||(p=r.colorRampTexture=new e.T(c,r.colorRamp,h.RGBA8)),p.bind(h.LINEAR,h.CLAMP_TO_EDGE);const f=((t,r,o,s,l)=>({u_matrix:t,u_color_ramp:0,u_center_direction:r,u_radius:e.an(o),u_opacity:s,u_temporal_offset:l}))(u.skyboxMatrix,r.getCenter(t,!1),r.paint.get("sky-gradient-radius"),s,l);t.uploadCommonUniforms(c,d),d.draw(t,h.TRIANGLES,o,Yi.disabled,t.colorModeForRenderPass(),Qi.backCW,f,"skyboxGradient",r.skyboxGeometry.vertexBuffer,r.skyboxGeometry.indexBuffer,r.skyboxGeometry.segment)}(t,o,u,l,d)},custom:function(t,r,o,s){const l=t.context,c=o.implementation;if(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes("custom")||t.terrain&&(t.terrain.renderingToTexture||"offscreen"===t.renderPass)&&o.isDraped(r)){if("offscreen"===t.renderPass){const r=c.prerender;if(r){if(t.setCustomLayerDefaults(),l.setColorMode(t.colorModeForRenderPass()),"globe"===t.transform.projection.name){const o=t.transform.pointMerc;r.call(c,l.gl,t.transform.customLayerMatrix(),t.transform.getProjection(),t.transform.globeToMercatorMatrix(),e.aj(t.transform.zoom),[o.x,o.y],t.transform.pixelsPerMeterRatio)}else r.call(c,l.gl,t.transform.customLayerMatrix());l.setDirty(),t.setBaseState()}}else if("translucent"===t.renderPass){if(t.terrain&&t.terrain.renderingToTexture){const e=c.renderToTile;if(e){const r=s[0].canonical,o={x:r.x+s[0].wrap*(c.wrapTileId?0:1<<r.z),y:r.y,z:r.z};l.setDepthMode($i.disabled),l.setStencilMode(Yi.disabled),l.setColorMode(t.colorModeForRenderPass()),t.setCustomLayerDefaults(),e.call(c,l.gl,o),l.setDirty(),t.setBaseState()}return}t.setCustomLayerDefaults(),l.setColorMode(t.colorModeForRenderPass()),l.setStencilMode(Yi.disabled);const r="3d"===c.renderingMode?new $i(t.context.gl.LEQUAL,$i.ReadWrite,t.depthRangeFor3D):t.depthModeForSublayer(0,$i.ReadOnly);if(l.setDepthMode(r),"globe"===t.transform.projection.name){const r=t.transform.pointMerc;c.render(l.gl,t.transform.customLayerMatrix(),t.transform.getProjection(),t.transform.globeToMercatorMatrix(),e.aj(t.transform.zoom),[r.x,r.y],t.transform.pixelsPerMeterRatio)}else c.render(l.gl,t.transform.customLayerMatrix());l.setDirty(),t.setBaseState(),l.bindFramebuffer.set(null)}}else e.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(t,r,o,s){if("opaque"===t.renderPass)return;const l=o.paint.get("model-opacity").constantOr(1),c=o.paint.get("model-elevation-reference"),h="ground"===c,u="ground"===c;if(0===l)return;const d=o.paint.get("model-cast-shadows");if("shadow"===t.renderPass){if(!d)return;if(t.terrain&&l<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof e.ad)return}const p=t.shadowRenderer,f=o.paint.get("model-receive-shadows");p&&(p.useNormalOffset=!0,f||(p.enabled=!1));const m=()=>{p&&(p.useNormalOffset=!0,f||(p.enabled=!0))},_=r.getSource();if("light-beam"===t.renderPass&&"batched-model"!==_.type)return;if("vector"===_.type||"geojson"===_.type)return function(t,r,o,s,l){const c=t.transform,h="globe"===c.projection.name,u=c.getFreeCameraOptions().position;if(!t.modelManager)return;const d=t.modelManager;o.modelManager=d;const p=t.shadowRenderer;if(!o._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const f=o._unevaluatedLayout._values["model-id"],m=Object.assign({},o.layout.get("model-id").parameters),_=t.style.order.indexOf(o.fqid),v=o.paint.get("model-opacity").constantOr(1);for(const E of s){const s=r.getTile(E).getBucket(o);if(!s||s.projection.name!==c.projection.name)continue;const P=s.getModelUris();if(P&&!s.modelsRequested&&(d.addModelsFromBucket(P,l),s.modelsRequested=!0),h)m.zoom=E.overscaledZ;else{const e=ch(E,c);m.zoom=e}const C=f.possiblyEvaluate(m);if(sh(t,s,E),ah.shadowUniformsInitialized=!1,ah.useSingleShadowCascade=!!p&&0===p.getMaxCascadeForTile(E.toUnwrapped()),"shadow"===t.renderPass&&p){if(1===t.currentShadowCascade&&s.isInsideFirstShadowMapFrustum)continue;const r=c.calculatePosMatrix(E.toUnwrapped(),c.worldSize);if(ah.tileMatrix.set(r),ah.shadowTileMatrix=Float32Array.from(p.calculateShadowPassMatrixFromMatrix(r)),ah.aabb.min=[0,0,0],ah.aabb.max[0]=ah.aabb.max[1]=e.al,ah.aabb.max[2]=0,dh(s,ah,t,o.scope))continue}const R=1<<E.canonical.z,z=[((u.x-E.wrap)*R-E.canonical.x)*e.al,(u.y*R-E.canonical.y)*e.al,u.z*R*e.al];t.conflationActive&&Object.keys(s.instancesPerModel).length>0&&t.style.isLayerClipped(o,r.getSource())&&s.updateReplacement(E,t.replacementSource,_,o.scope)&&(s.uploaded=!1,s.upload(t.context));let D=0;const O=new Array,F=new Array,B=new Array;for(let r in s.instancesPerModel){const c=s.instancesPerModel[r];c.features.length>0&&!h&&(r=C.evaluate(c.features[0].feature,{}));const p=d.getModel(r,l);if(p||d.hasURLBeenRequested(r)||s.modelUris.includes(r)||(s.modelUris.push(r),s.modelsRequested=!1),p&&p.uploaded)if(h){const r=e.c5([],[u.x,u.y,u.z],t.transform.worldSize);e.ew(r,r);for(let o=0;o<c.instancedDataArray.length;++o){const l=[0,0,0],h=[1,1,1],u=e.ex(),d=c.tileCoordinatesForInstance(o),f=c.transformForInstance(o);e.ey(h,f),e.ez(u,f),e.eA(l,u);const m=c.translationForInstance(o),_=new e.aT(0,0);e.eB(s.canonical,_,d.x,d.y);const E=e.bC();e.eC(E,p,t.transform,_,l,h,m,!0,!1,!1);const P=c.colorForInstance(o),C=e.bA([]),R=e.ef(_.lat,t.transform.zoom),z=e.bq([],[1,1,1/R]);e.br(C,C,r),B.push({zScaleMatrix:z,negCameraPosMatrix:C});for(const e of p.nodes)th(t,e,E,t.transform.expandedFarZProjMatrix,D,O,F,p.materialOverrides,v,P);++D}}else for(const e of p.nodes)hh(t,o,e,c,z,E,ah)}if(h)if("shadow"===t.renderPass){for(const e of F)ih(e.mesh,e.nodeModelMatrix,t,o);for(const e of O)ih(e.mesh,e.nodeModelMatrix,t,o)}else oh(t,o,O,F,B)}}(t,r,o,s,eh(t,o)),void m();if(!_.loaded())return;if("batched-model"===_.type)return function(t,r,o,s){o.resetLayerRenderingStats(t);const l=t.context,c=t.transform,h=t.style.fog,u=t.shadowRenderer;if("mercator"!==c.projection.name)return void e.w(`Drawing 3D landmark models for ${c.projection.name} projection is not yet implemented`);const d=t.transform.getFreeCameraOptions().position,p=e.c5([],[d.x,d.y,d.z],t.transform.worldSize),f=e.ew([],p),m=e.bA([]),_=e.ef(c.center.lat,c.zoom),v=e.bq([],[1,1,1/_]);e.br(m,m,f);const E=o.paint.get("model-opacity").constantOr(1),P=new $i(l.gl.LEQUAL,$i.ReadWrite,t.depthRangeFor3D),C=new $i(l.gl.LEQUAL,$i.ReadOnly,t.depthRangeFor3D),R=new e.d9([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),z="shadow"===t.renderPass,D=z&&u?u.getCurrentCascadeFrustum():c.getFrustum(c.scaleZoom(c.worldSize)),O=o.paint.get("model-front-cutoff"),F=O[2]<1,B=tn(t,o.paint.get("model-cutoff-fade-range")),k=o.getLayerRenderingStats();(function(e,t,r,o){const s=e.terrain?e.terrain.exaggeration():0,l=e.transform.zoom;for(const c of o){const o=t.getTile(c).getBucket(r);o&&(o.setFilter(r.filter),e.conflationActive&&o.updateReplacement(c,e.replacementSource),o.evaluateTransform(e,r),e.terrain&&s>0&&o.elevationUpdate(e.terrain,s,c,r.source),o.needsReEvaluation(e,l,r)&&o.evaluate(r))}})(t,r,o,s),function(){let d,f,V;F?(d=s.length-1,f=-1,V=-1):(d=0,f=s.length,V=1);const N=new Float64Array(16),U=e.cA(),j=new e.P(0,0);for(let $=d;$!==f;$+=V){const d=s[$],f=r.getTile(d).getBucket(o);if(!f||!f.uploaded)continue;let V=!1;u&&(V=0===u.getMaxCascadeForTile(d.toUnwrapped()));const q=c.calculatePosMatrix(d.toUnwrapped(),c.worldSize),H=f.modelTraits;!z&&F&&(e.bl(N,q),e.af(U,p,N),j.x=U[0],j.y=U[1]);const Z=[];f.setFilter(o.filter);for(const r of f.getNodesInfo()){if(r.hiddenByReplacement)continue;if(!r.node.meshes)continue;const o=r.node;let s=0;t.terrain&&o.elevation&&(s=o.elevation*t.terrain.exaggeration());const l=(()=>{const t=r.aabb;return R.min=[...t.min],R.max=[...t.max],R.min[2]+=s,R.max[2]+=s,e.af(R.min,R.min,q),e.af(R.max,R.max,q),R})(),h=r.evaluatedScale;if(h[0]<=1&&h[1]<=1&&h[2]<=1&&0===l.intersects(D))continue;if(!z&&F){const t=1/6;r.cameraCollisionOpacity=p[0]>l.min[0]&&p[0]<l.max[0]&&p[1]>l.min[1]&&p[1]<l.max[1]&&p[2]*_<l.max[2]&&o.footprint&&e.c0(j,o.footprint)?Math.max(r.cameraCollisionOpacity-t,0):Math.min(1,r.cameraCollisionOpacity+t)}const u=[...q],f=1/e.d7(d.canonical),m=o.anchor?o.anchor[0]:0,v=o.anchor?o.anchor[1]:0;e.br(u,u,[m*(h[0]-1)+r.evaluatedTranslation[0]*f,v*(h[1]-1)+r.evaluatedTranslation[1]*f,s+r.evaluatedTranslation[2]]),e.cq(h,e.eE)||e.cS(u,u,h);const P=e.aB([],u,o.globalMatrix),C=e.aB([],c.expandedFarZProjMatrix,P),k=e.aB([],c.expandedFarZProjMatrix,u),V=e.aC([],[m,v,s,1],C)[2];o.hidden=!1;let N=E;z||(F&&(N*=r.cameraCollisionOpacity,N*=fh(u,c,r.aabb,O)),N*=ph(B,V)),0!==N?Z.push({nodeInfo:r,depth:V,opacity:N,wvpForNode:C,wvpForTile:k,nodeModelMatrix:P,tileModelMatrix:u}):o.hidden=!0}z||Z.sort(((e,t)=>!F||1===e.opacity&&1===t.opacity?e.depth<t.depth?-1:1:1===e.opacity?-1:1===t.opacity?1:e.depth>t.depth?-1:1));for(const r of Z){const s=r.nodeInfo,d=s.node;let p=e.aB([],v,r.tileModelMatrix);e.aB(p,m,p);const f=e.bl([],p);e.eg(f,f),e.cS(f,f,uh),p=e.aB(p,p,d.globalMatrix);const _="light-beam"===t.renderPass,E="none"===o.paint.get("model-color-use-theme").constantOr("default"),R=H&e.eI.HasMapboxMeshFeatures,D=R?0:s.evaluatedRMEA[0][2];for(let e=0;e<d.meshes.length;++e){const m=d.meshes[e],v=e===d.lightMeshIndex;let O=r.wvpForNode;if(v){if(!_&&!t.terrain&&t.shadowRenderer){t.currentLayer<t.firstLightBeamLayer&&(t.firstLightBeamLayer=t.currentLayer);continue}O=r.wvpForTile}else if(_)continue;const F={defines:[]},B=[];if(!z&&u&&(u.useNormalOffset=!!m.normalBuffer),Xc(F.defines,B,m,t,E?null:o.lut),R||F.defines.push("DIFFUSE_SHADED"),V&&F.defines.push("SHADOWS_SINGLE_CASCADE"),k&&(z?k.numRenderedVerticesInShadowPass+=m.vertexArray.length:k.numRenderedVerticesInTransparentPass+=m.vertexArray.length),z){ih(m,r.nodeModelMatrix,t,o);continue}let N=null;if(h){const e=Zc(r.nodeModelMatrix,t.transform);if(N=new Float32Array(e),"globe"!==c.projection.name){const t=m.aabb.min,r=m.aabb.max,[o,s]=h.getOpacityForBounds(e,t[0],t[1],r[0],r[1]);F.overrideFog=o>=ct||s>=ct}}const U=m.material;let j;U.occlusionTexture&&U.occlusionTexture.offsetScale&&(j=U.occlusionTexture.offsetScale,F.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const $=t.getOrCreateProgram("model",F);!z&&u&&u.setupShadowsFromMatrix(r.tileModelMatrix,$,u.useNormalOffset),t.uploadCommonUniforms(l,$,null,N);const q=U.pbrMetallicRoughness;q.metallicFactor=.9,q.roughnessFactor=.5;const H=Oa(new Float32Array(O),new Float32Array(p),new Float32Array(f),new Float32Array(d.globalMatrix),t,r.opacity,q.baseColorFactor,U.emissiveFactor,q.metallicFactor,q.roughnessFactor,U,D,o,[0,0,0],j);!v&&(s.hasTranslucentParts||r.opacity<1)&&$.draw(t,l.gl.TRIANGLES,P,Yi.disabled,Wi.disabled,Qi.backCCW,H,o.id,m.vertexBuffer,m.indexBuffer,m.segments,o.paint,t.transform.zoom,void 0,B),$.draw(t,l.gl.TRIANGLES,v?C:P,Yi.disabled,v||r.opacity<1||s.hasTranslucentParts?Wi.alphaBlended:Wi.unblended,Qi.backCCW,H,o.id,m.vertexBuffer,m.indexBuffer,m.segments,o.paint,t.transform.zoom,void 0,B)}}}}()}(t,r,o,s),void m();if("model"!==_.type)return;const v=_.getModels(),E=[],P=t.transform.getFreeCameraOptions().position,C=e.c5([],[P.x,P.y,P.z],t.transform.worldSize);e.ew(C,C);const R=[],z=[];let D=0;for(const s of v){const l=r.getFeatureState("",s.id),c={type:"Unknown",id:s.id,properties:s.featureProperties},d=o.paint.get("model-rotation").evaluate(c,l),p=o.paint.get("model-scale").evaluate(c,l),f=o.paint.get("model-translation").evaluate(c,l),m=o.paint.get("model-opacity").evaluate(c,l);rh(o,s.id,l,s.featureProperties,s.nodeOverrideNames,s.nodeOverrides),nh(o,s.id,l,s.featureProperties,s.materialOverrideNames,s.materialOverrides),s.nodeOverrides.size>0&&s.computeBoundsAndApplyParent(),s.computeModelMatrix(t,d,p,f,u,h,!1);const _=e.bA([]),v=e.ef(s.position.lat,t.transform.zoom),P=e.bq([],[1,1,1/v]);e.br(_,_,C),E.push({zScaleMatrix:P,negCameraPosMatrix:_});for(const e of s.nodes)th(t,e,s.matrix,t.transform.expandedFarZProjMatrix,D,R,z,s.materialOverrides,m);D++}if(R.sort(((e,t)=>t.depth-e.depth)),"shadow"!==t.renderPass)oh(t,o,R,z,E),m();else{for(const e of z)ih(e.mesh,e.nodeModelMatrix,t,o);for(const e of R)ih(e.mesh,e.nodeModelMatrix,t,o);m()}}},wh={line:function(e,t,r){if(e.hasElevatedBuckets=!1,e.hasNonElevatedBuckets=!1,void 0!==e._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==e._unevaluatedLayout.getValue("line-z-offset")){if(t){const r=t.getVisibleCoordinates();for(const o of r){const r=t.getTile(o).getBucket(e);if(r&&("none"!==r.elevationType?e.hasElevatedBuckets=!0:e.hasNonElevatedBuckets=!0,e.hasElevatedBuckets&&e.hasNonElevatedBuckets))break}}}else e.hasNonElevatedBuckets=!0},model:function(e,t,r){const o=t.getSource();if(!o.loaded())return;if("vector"===o.type||"geojson"===o.type)return void(r.modelManager&&r.modelManager.upload(r,eh(r,e)));if("batched-model"===o.type)return;if("model"!==o.type)return;const s=o.getModels();for(const e of s)e.upload(r.context)},raster:function(e,t,r){const o=t.getSource();if(!(o instanceof pt&&o.loaded()))return;const s=e.sourceLayer||o.rasterLayerIds&&o.rasterLayerIds[0];if(!s)return;const l=e.paint.get("raster-array-band")||o.getInitialBand(s);if(null==l)return;const c=t.getIds().map((e=>t.getTileByID(e)));for(const t of c)t.updateNeeded(e.id,l)&&o.prepareTile(t,s,e.id,l)},"raster-particle":function(e,t,r){const o=t.getSource();if(!(o instanceof pt&&o.loaded()))return;const s=e.sourceLayer||o.rasterLayerIds&&o.rasterLayerIds[0];if(!s)return;const l=e.paint.get("raster-particle-array-band")||o.getInitialBand(s);if(null==l)return;const c=t.getIds().map((e=>t.getTileByID(e)));for(const t of c)t.updateNeeded(e.id,l)&&o.prepareTile(t,s,e.id,l)}},Th={fill:Xl},Sh={fill:function(e,t,r,o){if(!r.layout||"none"===r.layout.get("fill-elevation-reference")||0===r.paint.get("fill-opacity").constantOr(1))return;const s=e.context.gl,l=new $i(s.LEQUAL,$i.ReadOnly,e.depthRangeFor3D),c=new Yi({func:s.ALWAYS,mask:255},255,255,s.KEEP,s.KEEP,s.REPLACE),h=e.transform.getFreeCameraOptions().position,u=e.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const d of o){const o=t.getTile(d),p=o.getBucket(r);if(!p)continue;const f=p.elevatedStructures;if(!f||0===f.depthSegments.segments[0].primitiveLength)continue;const m=Hl(d.toUnwrapped(),h),_=e.translatePosMatrix(d.projMatrix,o,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor")),v=ia(_,m,0,1,0);u.draw(e,s.TRIANGLES,l,c,Wi.disabled,Qi.disabled,v,r.id,f.vertexBuffer,f.indexBuffer,f.depthSegments,r.paint,e.transform.zoom)}}};class Pa{constructor(t,r,o,s,l){this.context=new Jr(t,r),this.transform=o,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this._timeStamp=e.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const c=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const e of c)this._debugParams.enabledLayers[e]=!0;for(const e of c);this.occlusionParams=new fa,this.setup(),this.numSublayers=Ft.maxUnderzooming+Ft.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new e.eP,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new po(this),this._wireframeDebugCache=new pa,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const h=new e.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new e.T(this.context,h,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=s,this.worldview=l,this._forceEmissiveMode=!1,this.emissiveMode="constant"}updateTerrain(e,t){const r=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(r||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new nr(this,e));const o=this._terrain;this.transform.elevation=r?o:null,o.update(e,this.transform,t),this.transform.elevation&&!o.enabled&&(this.transform.elevation=null)}_updateFog(e){const t=e.fog;if(!t||"globe"===this.transform.projection.name||t.getOpacity(this.transform.pitch)<1||t.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[r,o]=t.getFovAdjustedRange(this.transform._fov);if(r>o)return void(this.transform.fogCullDistSq=null);const s=r+.78*(o-r);this.transform.fogCullDistSq=s*s}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(e){e&&!this._terrain&&(this._terrain=new nr(this,this.style)),this._forceTerrainMode=e}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,r){if(this.width=t*e.o.devicePixelRatio,this.height=r*e.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const e of this.style.order)this.style._mergedLayers[e].resize()}setup(){const t=this.context,r=new e.bd;r.emplaceBack(0,0),r.emplaceBack(e.al,0),r.emplaceBack(0,e.al),r.emplaceBack(e.al,e.al),this.tileExtentBuffer=t.createVertexBuffer(r,e.bf.members),this.tileExtentSegments=e.bg.simpleSegment(0,0,4,2);const o=new e.bd;o.emplaceBack(0,0),o.emplaceBack(e.al,0),o.emplaceBack(0,e.al),o.emplaceBack(e.al,e.al),this.debugBuffer=t.createVertexBuffer(o,e.bf.members),this.debugSegments=e.bg.simpleSegment(0,0,4,5);const s=new e.bd;s.emplaceBack(-1,-1),s.emplaceBack(1,-1),s.emplaceBack(-1,1),s.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(s,e.bf.members),this.viewportSegments=e.bg.simpleSegment(0,0,4,2);const l=new e.b1;l.emplaceBack(0,0,0,0),l.emplaceBack(e.al,0,e.al,0),l.emplaceBack(0,e.al,0,e.al),l.emplaceBack(e.al,e.al,e.al,e.al),this.mercatorBoundsBuffer=t.createVertexBuffer(l,e.bi.members),this.mercatorBoundsSegments=e.bg.simpleSegment(0,0,4,2);const c=new e.b0;c.emplaceBack(0,1,2),c.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(c);const h=new e.be;for(const e of[0,1,3,2,0])h.emplaceBack(e);this.debugIndexBuffer=t.createIndexBuffer(h),this.emptyTexture=new e.T(t,new e.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=e.bC();const u=this.context.gl;this.stencilClearMode=new Yi({func:u.ALWAYS,mask:0},0,255,u.ZERO,u.ZERO,u.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,e.TRIANGLES,$i.disabled,this.stencilClearMode,Wi.disabled,Qi.disabled,Bo(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,t,r){if(!t||this.currentStencilSource===t.id||!e.isTileClipped()||!r||0===r.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let e=!1;for(const t of r)if(void 0===this._tileClippingMaskIDs[t.key]){e=!0;break}if(!e)return}this.currentStencilSource=t.id;const o=this.context,s=o.gl;this.nextStencilID+r.length>256&&this.clearStencil(),o.setColorMode(Wi.disabled),o.setDepthMode($i.disabled);const l=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const e of r){const r=t.getTile(e),o=this._tileClippingMaskIDs[e.key]=this.nextStencilID++,{tileBoundsBuffer:c,tileBoundsIndexBuffer:h,tileBoundsSegments:u}=this.getTileBoundsBuffers(r);l.draw(this,s.TRIANGLES,$i.disabled,new Yi({func:s.ALWAYS,mask:0},o,255,s.KEEP,s.KEEP,s.REPLACE),Wi.disabled,Qi.disabled,Bo(e.projMatrix),"$clipping",c,h,u)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,t=this.context.gl;return new Yi({func:t.NOTEQUAL,mask:255},e,255,t.KEEP,t.KEEP,t.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const t=this.context.gl;return new Yi({func:t.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,t.KEEP,t.KEEP,t.REPLACE)}stencilConfigForOverlap(e){const t=this.context.gl,r=e.sort(((e,t)=>t.overscaledZ-e.overscaledZ)),o=r[r.length-1].overscaledZ,s=r[0].overscaledZ-o+1;if(s>1){this.currentStencilSource=void 0,this.nextStencilID+s>256&&this.clearStencil();const e={};for(let r=0;r<s;r++)e[r+o]=new Yi({func:t.GEQUAL,mask:255},r+this.nextStencilID,255,t.KEEP,t.KEEP,t.REPLACE);return this.nextStencilID+=s,[e,r]}return[{[o]:Yi.disabled},r]}colorModeForRenderPass(){const t=this.context.gl;if(this._showOverdrawInspector){const r=1/8;return new Wi([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new e.ao(r,r,r,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?Wi.unblended:Wi.alphaBlended}colorModeForDrapableLayerRenderPass(t){const r=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?null!=t&&"mrt-fallback"!==this.emissiveMode||"constant"===this.emissiveMode?new Wi([r.ONE,r.ONE_MINUS_SRC_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_SRC_ALPHA],new e.ao(0,0,0,null!=t?t:0),[!0,!0,!0,!0]):"dual-source-blending"===this.emissiveMode?new Wi([r.ONE,r.ONE_MINUS_SRC_ALPHA,this.context.extBlendFuncExtended.SRC1_ALPHA_WEBGL,r.ONE_MINUS_SRC_ALPHA],e.ao.transparent,[!0,!0,!0,!0]):this.colorModeForRenderPass():this.colorModeForRenderPass()}depthModeForSublayer(e,t,r,o=!1){if(this.depthOcclusion)return new $i(this.context.gl.GREATER,$i.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!o)return $i.disabled;const s=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new $i(r||this.context.gl.LEQUAL,t,[s,s])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,r=Math.ceil(this.width),o=Math.ceil(this.height),s=this.context.bindFramebuffer.get(),l=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===r&&this.depthFBO.height===o||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==r&&0!==o&&(this.depthFBO=new Kr(this.context,r,o,0,"texture"),this.depthTexture=new e.T(this.context,{width:r,height:o,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(s),t.bindTexture(t.TEXTURE_2D,l),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,r,o,0,0,r,o,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((e,t)=>e+t/this._fpsHistory.length),0))}render(t,r){const o=e.o.now();this._dt=o-this._timeStamp,this._timeStamp=o,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=r;const s=this.style._mergedLayers,l=!(!this.terrain||!this.terrain.enabled),c=()=>this.style._getOrder(l).filter((e=>{const t=s[e];return!(t.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[t.type]}));let h=c(),u=!1,d=!1,p=null,f=0,m=!1;for(const e of h){const t=s[e];"none"!==t.visibility&&("circle"===t.type?u=!0:"building"===t.type?(p=t,++f):"symbol"===t.type&&(t.hasOcclusionOpacityProperties?d=!0:u=!0))}this.updateEmissiveMode();let _=h.map((e=>s[e]));const v=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(e.o.now()),this.imageManager.beginFrame();for(const e in v){const t=v[e];t.used&&(t.prepare(this.context),t.getSource().usedInConflation&&++f)}let E=!1;for(const e of _)e.isHidden(this.transform.zoom)||("clip"===e.type&&(E=!0),this.prepareLayer(e));const P={},C={},R={},z={},D={};for(const e in v){const t=v[e];P[e]=t.getVisibleCoordinates(),C[e]=P[e].slice().reverse(),R[e]=t.getVisibleCoordinates(!0).reverse(),z[e]=t.getShadowCasterCoordinates(),D[e]=t.sortCoordinatesByDistance(P[e])}const O=e=>{const t=this.style.getLayerSourceCache(e);return t&&t.used?t.getSource():null};if(f||E||this._clippingActiveLastFrame){const t=[],r=[];let o=0;for(const e of _)this.isSourceForClippingOrConflation(e,O(e))&&(t.push(e),r.push(o)),o++;if(t&&(E||t.length>1)||this._clippingActiveLastFrame){E=!1;const o=[];for(let s=0;s<t.length;s++){const l=t[s],c=r[s],h=this.style.getLayerSourceCache(l);if(!h||!h.used||!h.getSource().usedInConflation&&"clip"!==l.type&&"building"!==l.type)continue;let u=e.eQ,d=e.b_.None;const p=[];let f=!0;if("building"===l.type)u=e.eS;else if("clip"===l.type)if(u=c,l.isHidden(this.transform.zoom))f=!1;else{if(!l.layout){f=!1;continue}for(const t of l.layout.get("clip-layer-types"))d|="model"===t?e.b_.Model:"symbol"===t?e.b_.Symbol:e.b_.FillExtrusion;for(const e of l.layout.get("clip-layer-scope"))p.push(e);E=!0}f&&o.push({layer:l.fqid,cache:h,order:u,clipMask:d,clipScope:p})}this.replacementSource.setSources(o),m=!0}}this._clippingActiveLastFrame=E,m||this.replacementSource.clear(),this.conflationActive=m,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let e=0;e<_.length;e++){const t=_[e];if("none"===t.visibility)continue;const r=t.cutoffRange();if(this.longestCutoffRange=Math.max(r,this.longestCutoffRange),r>0){const e=O(t);e&&(this.minCutoffZoom=Math.max(e.minzoom,this.minCutoffZoom)),t.minzoom&&(this.minCutoffZoom=Math.max(t.minzoom,this.minCutoffZoom))}t.is3D(l)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=e),this._lastOcclusionLayer=e)}const F=this.style&&this.style.fog;F?(this._fogVisible=0!==F.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=F.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(R),this.opaquePassCutoff=0,h=c(),_=h.map((e=>s[e])));const B=this._shadowRenderer;if(B){B.updateShadowParameters(this.transform,this.style.directionalLight);for(const e in v)for(const t of P[e]){let e={min:0,max:0};this.terrain&&(e=this.terrain.getMinMaxForTile(t)||e),B.addShadowReceiver(t.toUnwrapped(),e.min,e.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new e.eR(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new $n(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const k=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),V=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(k&&!this._snow&&(this._snow=new Ca(this)),!k&&this._snow&&(this._snow.destroy(),delete this._snow),V&&!this._rain&&(this._rain=new Sa(this)),!V&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),p){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Xn);const e=this.style.getLayerSourceCache(p);this.buildingTileBorderManager.updateBorders(e,p)}if(!oe.has(this.context.gl))return;this.renderPass="offscreen";for(const e of _){const r=t.getLayerSourceCache(e);if(!e.hasOffscreenPass()||e.isHidden(this.transform.zoom))continue;const o=r?C[r.id]:void 0;("custom"===e.type||"raster"===e.type||"raster-particle"===e.type||e.isSky()||o&&o.length)&&this.renderLayer(this,r,e,o)}this.depthRangeFor3D=[0,1-(_.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,z)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const N="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),U=(()=>{if(r.showOverdrawInspector)return e.ao.black;const t=this.style.fog;if(t&&this.transform.projection.supportsFog){const r=this.style.getLut(t.scope);if(!N){const o="none"===t.properties.get("color-use-theme"),s=t.properties.get("color").toNonPremultipliedRenderColor(o?null:r).toArray01();return new e.ao(...s)}if(N){const o="none"===t.properties.get("space-color-use-theme"),s=t.properties.get("space-color").toNonPremultipliedRenderColor(o?null:r).toArray01();return new e.ao(...s)}}return e.ao.transparent})();if(this.context.clear({color:U,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&N&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=h.length-1;this.currentLayer>=0;this.currentLayer--){const e=_[this.currentLayer],r=t.getLayerSourceCache(e);if(e.isSky())continue;const o=r?(e.is3D(l)?D:C)[r.id]:void 0;this._renderTileClippingMasks(e,r,o),this.renderLayer(this,r,e,o)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&N&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||e.aj(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<h.length;this.currentLayer++){const e=_[this.currentLayer],r=t.getLayerSourceCache(e);e.isSky()&&this.renderLayer(this,r,e,r?C[r.id]:void 0)}function j(e,t){let r;return t&&(r=("symbol"===e.type?R:e.is3D(l)?D:C)[t.id]),r}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<h.length;){const e=_[this.currentLayer];if("raster"===e.type||"raster-particle"===e.type){const r=t.getLayerSourceCache(e);this.renderLayer(this,r,e,j(e,r))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;const $=B?B.getGroundShadowLayerIndex():-1;let q=!1,H=-1;for(let e=0;e<h.length;++e){const t=_[e];t.isHidden(this.transform.zoom)||t.is3D(l)&&(H=e)}d&&-1===H&&(u=!0);let Z=!1;for(;this.currentLayer<h.length;){const e=_[this.currentLayer],r=t.getLayerSourceCache(e);if(e.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(e)){if(e.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!Z&&e.is3D(l)&&!l){const e=this.currentLayer,t=e=>{for(this.currentLayer=0;this.currentLayer<_.length;this.currentLayer++){const t=_[this.currentLayer];if(Th[t.type]){const r=this.style.getLayerSourceCache(t);Th[t.type](this,r,t,j(t,r),e)}}};t("initialize"),t("reset"),this.currentLayer=e,Z=!0}if(u&&!q&&this.terrain&&!this.transform.isOrthographic&&(q=!0,this.blitDepth()),d&&-1!==H&&this.currentLayer===H+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(e,r,r?P[r.id]:void 0),this.renderLayer(this,r,e,j(e,r)),!this.terrain&&B&&this.currentLayer===$){{this.clearStencil(),this.resetStencilClippingMasks();const e=this.currentLayer;for(this.currentLayer=0;this.currentLayer<_.length;this.currentLayer++){const e=_[this.currentLayer];if(Sh[e.type]){const t=this.style.getLayerSourceCache(e);Sh[e.type](this,t,e,j(e,t))}}this.currentLayer=e}if(B.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const e=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=e;this.currentLayer++){const e=_[this.currentLayer];if(!e.hasLightBeamPass())continue;const r=t.getLayerSourceCache(e);this.renderLayer(this,r,e,r?C[r.id]:void 0)}this.currentLayer=e,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const e=this.currentLayer;this.depthOcclusion=!0;for(const e of this.layersWithOcclusionOpacity){this.currentLayer=e;const r=_[this.currentLayer],o=t.getLayerSourceCache(r),s=o?C[o.id]:void 0;this.terrain||this._renderTileClippingMasks(r,o,o?P[o.id]:void 0),this.renderLayer(this,o,r,s)}this.depthOcclusion=!1,this.currentLayer=e,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let r=null;_.forEach((e=>{const o=t.getLayerSourceCache(e);o&&!e.isHidden(this.transform.zoom)&&o.getVisibleCoordinates().length&&(!r||r.getSource().maxzoom<o.getSource().maxzoom)&&(r=o)})),r&&this.options.showTileBoundaries&&Bc(this,r,r.getVisibleCoordinates(),e.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Bc(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new e.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(e){const t=e.transform.padding;Vc(e,e.transform.height-(t.top||0),3,zc),Vc(e,t.bottom||0,3,Dc),Nc(e,t.left||0,3,Lc),Nc(e,e.transform.width-(t.right||0),3,Oc);const r=e.transform.centerPoint;!function(e,t,r,o){Uc(e,t-1,r-10,2,20,o),Uc(e,t-10,r-1,20,2,o)}(e,r.x,e.transform.height-r.y,Fc)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),m||(this.conflationActive=!1)}prepareLayer(e){this.gpuTimingStart(e);const{unsupportedLayers:t}=this.transform.projection,r=!t||!t.includes(e.type);if(wh[e.type]&&(r||this.terrain&&"custom"===e.type)){const t=this.style.getLayerSourceCache(e);wh[e.type](e,t,this)}this.gpuTimingEnd()}renderLayer(e,t,r,o){r.isHidden(this.transform.zoom)||("background"===r.type||"sky"===r.type||"custom"===r.type||"model"===r.type||"raster"===r.type||"raster-particle"===r.type||o&&o.length)&&(this.id=r.id,this.gpuTimingStart(r),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(r.type)&&(!e.terrain||"custom"!==r.type)||"clip"===r.type||bh[r.type](e,t,r,o,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery,r=this.context.gl;let o=this.gpuTimers[e.id];o||(o=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:r.createQuery()}),o.calls++,r.beginQuery(t.TIME_ELAPSED_EXT,o.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const e=this.context.extTimerQuery,t=this.context.gl,r=t.createQuery();this.deferredRenderGpuTimeQueries.push(r),t.beginQuery(e.TIME_ELAPSED_EXT,r)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e}collectDeferredRenderGpuQueries(){const e=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],e}queryGpuTimers(e){const t={};for(const r in e){const o=e[r],s=this.context.extTimerQuery,l=s.getQueryParameter(o.query,this.context.gl.QUERY_RESULT)/1e6;s.deleteQueryEXT(o.query),t[r]=l}return t}queryGpuTimeDeferredRender(e){if(!this.options.gpuTimingDeferredRender)return 0;const t=this.context.gl;let r=0;for(const o of e)r+=t.getQueryParameter(o,t.QUERY_RESULT)/1e6,t.deleteQuery(o);return r}translatePosMatrix(t,r,o,s,l){if(!o[0]&&!o[1])return t;const c=l?"map"===s?this.transform.angle:0:"viewport"===s?-this.transform.angle:0;if(c){const e=Math.sin(c),t=Math.cos(c);o=[o[0]*t-o[1]*e,o[0]*e+o[1]*t]}const h=[l?o[0]:e.ay(r,o[0],this.transform.zoom),l?o[1]:e.ay(r,o[1],this.transform.zoom),0],u=new Float32Array(16);return e.br(u,t,h),u}saveTileTexture(e){if(e.context!==this.context)return;const t=e.size[0],r=this._tileTextures[t];r?r.push(e):this._tileTextures[t]=[e]}getTileTexture(e){const t=this._tileTextures[e];return t&&t.length>0?t.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(e,t,r){const o=void 0===r?this.terrain&&this.terrain.renderingToTexture:r,s=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===e||"terrainRaster"===e?(s.push("LIGHTING_3D_MODE"),s.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):o||s.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||s.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(s.push("TERRAIN"),this.linearFloatFilteringSupported()&&s.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&s.push("GLOBE"),!this._fogVisible||o||void 0!==t&&!t||s.push("FOG"),o&&s.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&s.push("OVERDRAW_INSPECTOR"),s}getOrCreateProgram(e,t){this.cache=this.cache||{};const r=t&&t.defines||[],o=t&&t.config,s=this.currentGlobalDefines(e,t&&t.overrideFog,t&&t.overrideRtt).concat(r),l=hr.cacheKey(Kn[e],e,s,o);return this.cache[l]||(this.cache[l]=new hr(this.context,e,Kn[e],o,Ba[e],s)),this.cache[l]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new e.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,r){if(this.style.enable3dLights()){const o=this.style.directionalLight,s=this.style.ambientLight;if(o&&s){const l=((t,r,o)=>{const s=t.properties.get("direction"),l="none"===t.properties.get("color-use-theme"),c=t.properties.get("color").toNonPremultipliedRenderColor(l?null:o.getLut(t.scope)).toArray01(),h=t.properties.get("intensity"),u="none"===r.properties.get("color-use-theme"),d=r.properties.get("color").toNonPremultipliedRenderColor(u?null:o.getLut(r.scope)).toArray01(),p=r.properties.get("intensity"),f=[s.x,s.y,s.z],m=e.dN(d,p),_=e.dN(c,h);return{u_lighting_ambient_color:m,u_lighting_directional_dir:f,u_lighting_directional_color:_,u_ground_radiance:Vo(f,_,m)}})(o,s,this.style);r.setLightsUniformValues(t,l)}}}uploadCommonUniforms(t,r,o,s,l){if(this.uploadCommonLightUniforms(t,r),this.terrain&&this.terrain.renderingToTexture)return;const c=this.style.fog;if(c){const l=c.getOpacity(this.transform.pitch),h=((t,r,o,s,l,c,h,u,d,p,f,m)=>{const _=t.transform,v="none"===r.properties.get("color-use-theme"),E=r.properties.get("color").toNonPremultipliedRenderColor(v?null:t.style.getLut(r.scope)).toArray01();E[3]=s;const P=t.frameCounter/1e3%1,[C,R]=r.properties.get("vertical-range");return{u_fog_matrix:o?_.calculateFogTileMatrix(o):m||t.identityMat,u_fog_range:r.getFovAdjustedRange(_._fov),u_fog_color:E,u_fog_horizon_blend:r.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(C,R),R],u_fog_temporal_offset:P,u_frustum_tl:l,u_frustum_tr:c,u_frustum_br:h,u_frustum_bl:u,u_globe_pos:d,u_globe_radius:p,u_viewport:f,u_globe_transition:e.aj(_.zoom),u_is_globe:+("globe"===_.projection.name)}})(this,c,o,l,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*e.o.devicePixelRatio,this.transform.height*e.o.devicePixelRatio],s);r.setFogUniformValues(t,h)}l&&r.setCutoffUniformValues(t,l.uniformValues)}setTileLoadedFlag(e){this.tileLoaded=e}saveCanvasCopy(){const e=this.canvasCopy();e&&(this.frameCopies.push(e),this.tileLoaded=!1)}canvasCopy(){const e=this.context.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),t}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const e=this.style&&this.style.fog;return!!e&&0!==e.getOpacity(this.transform.pitch)}getBackgroundTiles(){const e=this._backgroundTiles,t=this._backgroundTiles={},r=this.transform.coveringTiles({tileSize:512});for(const o of r)t[o.key]=e[o.key]||new Pt(o,512,this.transform.tileZoom,this,void 0,this.worldview);return t}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(e,t){return!(!e.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==e.type&&"building"!==e.type&&(e.minzoom&&e.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==e.sourceLayer&&"procedural_buildings"!==e.sourceLayer)&&(!t||"batched-model"!==t.type)))}isTileAffectedByFog(e){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let t=this._cachedTileFogOpacities[e.key];return t||(this._cachedTileFogOpacities[e.key]=t=this.style.fog.getOpacityForTile(e)),t[0]>=ct||t[1]>=ct}setupDepthForOcclusion(e,t,r){const o=this.context,s=o.gl,l=!!r;var c;r||(r={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),o.activeTexture.set(s.TEXTURE3),e&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),r.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],r.u_depth_range_unpack=[2/((c=this.depthRangeFor3D)[1]-c[0]),-1-2*c[0]/(c[1]-c[0])],r.u_occluder_half_size=.5*this.occlusionParams.occluderSize,r.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),o.activeTexture.set(s.TEXTURE0),l||t.setTerrainUniformValues(o,r)}updateEmissiveMode(){if(this._forceEmissiveMode)return;const e=this.style.hasDataDrivenEmissiveStrength();this.emissiveMode=e?this.context.extBlendFuncExtended?"dual-source-blending":"mrt-fallback":"constant"}}function Ih(e,t){let r=!1,o=null;const s=()=>{o=null,r&&(e(),o=setTimeout(s,t),r=!1)};return()=>(r=!0,o||s(),o)}class za{constructor(t){this._hashName=t&&encodeURIComponent(t),e.aY(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ih(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const e=this._map;if(!e)return"";const t=Eh(e);if(this._hashName){const e=this._hashName;let r=!1;const o=location.hash.slice(1).split("&").map((o=>{const s=o.split("=")[0];return s===e?(r=!0,`${s}=${t}`):o})).filter((e=>e));return r||o.push(`${e}=${t}`),`#${o.join("&")}`}return`#${t}`}_getCurrentHash(){const e=location.hash.replace("#","");if(this._hashName){let t;return e.split("&").map((e=>e.split("="))).forEach((e=>{e[0]===this._hashName&&(t=e)})),(t&&t[1]||"").split("/")}return e.split("/")}_onHashChange(){const e=this._map;if(!e)return!1;const t=this._getCurrentHash();if(t.length>=3&&!t.some((e=>isNaN(Number(e))))){const r=e.dragRotate.isEnabled()&&e.touchZoomRotate.isEnabled()?+(t[3]||0):e.getBearing();return e.jumpTo({center:[+t[2],+t[1]],zoom:+t[0],bearing:r,pitch:+(t[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Eh(e,t){const r=e.getCenter(),o=Math.round(100*e.getZoom())/100,s=Math.ceil((o*Math.LN2+Math.log(512/360/.5))/Math.LN10),l=Math.pow(10,s),c=Math.round(r.lng*l)/l,h=Math.round(r.lat*l)/l,u=e.getBearing(),d=e.getPitch();let p=t?`/${c}/${h}/${o}`:`${o}/${h}/${c}`;return(u||d)&&(p+="/"+Math.round(10*u)/10),d&&(p+=`/${Math.round(d)}`),p}const Ah={linearity:.3,easing:e.eT(0,0,.3,1)},Mh=Object.assign({deceleration:2500,maxSpeed:1400},Ah),Ph=Object.assign({deceleration:20,maxSpeed:1400},Ah),Ch=Object.assign({deceleration:1e3,maxSpeed:360},Ah),zh=Object.assign({deceleration:1e3,maxSpeed:90},Ah);class ja{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:e.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=e.o.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const r={zoom:0,bearing:0,pitch:0,pan:new e.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:e}of this._inertiaBuffer)r.zoom+=e.zoomDelta||0,r.bearing+=e.bearingDelta||0,r.pitch+=e.pitchDelta||0,e.panDelta&&r.pan._add(e.panDelta),e.around&&(r.around=e.around),e.pinchAround&&(r.pinchAround=e.pinchAround);const o=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,s={};if(r.pan.mag()){const e=Lh(r.pan.mag(),o,Object.assign({},Mh,t||{}));s.offset=r.pan.mult(e.amount/r.pan.mag()),s.center=this._map.transform.center,Dh(s,e)}if(r.zoom){const e=Lh(r.zoom,o,Ph);s.zoom=this._map.transform.zoom+e.amount,Dh(s,e)}if(r.bearing){const t=Lh(r.bearing,o,Ch);s.bearing=this._map.transform.bearing+e.aA(t.amount,-179,179),Dh(s,t)}if(r.pitch){const e=Lh(r.pitch,o,zh);s.pitch=this._map.transform.pitch+e.amount,Dh(s,e)}if(s.zoom||s.bearing){const e=void 0===r.pinchAround?r.around:r.pinchAround;s.around=e?this._map.unproject(e):this._map.getCenter()}return this.clear(),s.noMoveStart=!0,s}}function Dh(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function Lh(t,r,o){const{maxSpeed:s,linearity:l,deceleration:c}=o,h=e.aA(t*l/(r/1e3),-s,s),u=Math.abs(h)/(c*l);return{easing:o.easing,duration:1e3*u,amount:h*(u/2)}}class Ha extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,t,r,o={}){const s=C(t.getCanvasContainer(),r),l=t.unproject(s);super(e,Object.assign({point:s,lngLat:l,originalEvent:r},o)),this._defaultPrevented=!1,this.target=t}}class qa extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,o){const s="touchend"===t?o.changedTouches:o.touches,l=R(r.getCanvasContainer(),s),c=l.map((e=>r.unproject(e))),h=l.reduce(((e,t,r,o)=>e.add(t.div(o.length))),new e.P(0,0));super(t,{points:l,point:h,lngLats:c,lngLat:r.unproject(h),originalEvent:o}),this._defaultPrevented=!1}}class Za extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,t){super("wheel",{originalEvent:t}),this._defaultPrevented=!1}}class Wa{constructor(e,t){this._map=e,this._clickTolerance=t.clickTolerance}reset(){this._mousedownPos=void 0}wheel(e){return this._firePreventable(new Za(this._map,e))}mousedown(e,t){return this._mousedownPos=t,this._firePreventable(new Ha(e.type,this._map,e))}mouseup(e){this._map.fire(new Ha(e.type,this._map,e))}preclick(e){const t=new MouseEvent("preclick",e);this._map.fire(new Ha(t.type,this._map,t))}click(e,t){this._mousedownPos&&this._mousedownPos.dist(t)>=this._clickTolerance||(this.preclick(e),this._map.fire(new Ha(e.type,this._map,e)))}dblclick(e){return this._firePreventable(new Ha(e.type,this._map,e))}mouseover(e){this._map.fire(new Ha(e.type,this._map,e))}mouseout(e){this._map.fire(new Ha(e.type,this._map,e))}touchstart(e){return this._firePreventable(new qa(e.type,this._map,e))}touchmove(e){this._map.fire(new qa(e.type,this._map,e))}touchend(e){this._map.fire(new qa(e.type,this._map,e))}touchcancel(e){this._map.fire(new qa(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class $a{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(e){this._map.fire(new Ha(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Ha("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new Ha(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Xa{constructor(e,t){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=t.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,t){this.isEnabled()&&e.shiftKey&&0===e.button&&(_(),this._startPos=this._lastPos=t,this._active=!0)}mousemoveWindow(e,t){if(!this._active)return;const r=t,o=this._startPos,s=this._lastPos;if(!o||!s||s.equals(r)||!this._box&&r.dist(o)<this._clickTolerance)return;this._lastPos=r,this._box||(this._box=u("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const l=Math.min(o.x,r.x),c=Math.max(o.x,r.x),h=Math.min(o.y,r.y),d=Math.max(o.y,r.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${l}px,${h}px)`,this._box.style.width=c-l+"px",this._box.style.height=d-h+"px")}))}mouseupWindow(t,r){if(!this._active)return;const o=this._startPos,s=r;if(o&&0===t.button){if(this.reset(),P(),o.x!==s.x||o.y!==s.y)return this._map.fire(new e.z("boxzoomend",{originalEvent:t})),{cameraAnimation:e=>e.fitScreenCoordinates(o,s,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(e){this._active&&27===e.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",e))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),v(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new e.z(t,{originalEvent:r}))}}function Oh(e,t){const r={};for(let o=0;o<e.length;o++)r[e[o].identifier]=t[o];return r}class Ka{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,r,o){(this.centroid||o.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=t.timeStamp),o.length===this.numTouches&&(this.centroid=function(t){const r=new e.P(0,0);for(const e of t)r._add(e);return r.div(t.length)}(r),this.touches=Oh(o,r)))}touchmove(e,t,r){if(this.aborted||!this.centroid)return;const o=Oh(r,t);for(const e in this.touches){const t=o[e];(!t||t.dist(this.touches[e])>30)&&(this.aborted=!0)}}touchend(e,t,r){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),0===r.length){const e=!this.aborted&&this.centroid;if(this.reset(),e)return e}}}class Ja{constructor(e){this.singleTap=new Ka(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(e,t,r){this.singleTap.touchstart(e,t,r)}touchmove(e,t,r){this.singleTap.touchmove(e,t,r)}touchend(e,t,r){const o=this.singleTap.touchend(e,t,r);if(o){const t=e.timeStamp-this.lastTime<500,r=!this.lastTap||this.lastTap.dist(o)<30;if(t&&r||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=o,this.count===this.numTaps)return this.reset(),o}}}class Qa{constructor(){this._zoomIn=new Ja({numTouches:1,numTaps:2}),this._zoomOut=new Ja({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,t,r){this._zoomIn.touchstart(e,t,r),this._zoomOut.touchstart(e,t,r)}touchmove(e,t,r){this._zoomIn.touchmove(e,t,r),this._zoomOut.touchmove(e,t,r)}touchend(e,t,r){const o=this._zoomIn.touchend(e,t,r),s=this._zoomOut.touchend(e,t,r);return o?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()+1,around:t.unproject(o)},{originalEvent:e})}):s?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()-1,around:t.unproject(s)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Fh=0,Bh=2,kh={[Fh]:1,[Bh]:2},Vh={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class sl{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(e,t){return!1}_move(e,t){return{}}mousedown(e,t){if(this._lastPoint)return;const r=z(e);this._correctButton(e,r)&&(this._lastPoint=t,this._eventButton=r)}mousemoveWindow(e,t){const r=this._lastPoint;if(r)if(e.preventDefault(),null!=this._eventButton&&function(e,t){const r=kh[t];return void 0===e.buttons||(e.buttons&r)!==r}(e,this._eventButton))this.reset();else if(this._moved||!(t.dist(r)<this._clickTolerance))return this._moved=!0,this._lastPoint=t,this._move(r,t)}mouseupWindow(e){this._lastPoint&&z(e)===this._eventButton&&(this._moved&&P(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class rl extends sl{mousedown(e,t){super.mousedown(e,t),this._lastPoint&&(this._active=!0)}_correctButton(e,t){return 0===t&&!e.ctrlKey}_move(e,t){return{around:t,panDelta:t.sub(e)}}}class nl extends sl{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Vh[e.pitchRotateKey]:void 0}_correctButton(e,t){return this._pitchRotateKey?0===t&&e[this._pitchRotateKey]:0===t&&e.ctrlKey||2===t}_move(e,t){const r=.8*(t.x-e.x);if(r)return this._active=!0,{bearingDelta:r}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class al extends sl{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Vh[e.pitchRotateKey]:void 0}_correctButton(e,t){return this._pitchRotateKey?0===t&&e[this._pitchRotateKey]:0===t&&e.ctrlKey||2===t}_move(e,t){const r=-.5*(t.y-e.y);if(r)return this._active=!0,{pitchDelta:r}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class ll{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=r.clickTolerance||1,this.reset(),e.aY(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new e.P(0,0)}touchstart(e,t,r){return this._calculateTransform(e,t,r)}touchmove(t,r,o){if(this._active&&!(o.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===o.length&&!e.eU())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,r,o)}}touchend(e,t,r){this._calculateTransform(e,t,r),this._active&&r.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,o){o.length>0&&(this._active=!0);const s=Oh(o,r),l=new e.P(0,0),c=new e.P(0,0);let h=0;for(const e in s){const t=s[e],r=this._touches[e];r&&(l._add(t),c._add(t.sub(r)),h++,s[e]=t)}if(this._touches=s,h<this._minTouches||!c.mag())return;const u=c.div(h);return this._sum._add(u),this._sum.mag()<this._clickTolerance?void 0:{around:l.div(h),panDelta:u}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=u("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class cl{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(e){}_move(e,t,r){return{}}touchstart(e,t,r){this._firstTwoTouches||r.length<2||(this._firstTwoTouches=[r[0].identifier,r[1].identifier],this._start([t[0],t[1]]))}touchmove(e,t,r){const o=this._firstTwoTouches;if(!o)return;e.preventDefault();const[s,l]=o,c=Nh(r,t,s),h=Nh(r,t,l);if(!c||!h)return;const u=this._aroundCenter?null:c.add(h).div(2);return this._move([c,h],u,e)}touchend(e,t,r){if(!this._firstTwoTouches)return;const[o,s]=this._firstTwoTouches,l=Nh(r,t,o),c=Nh(r,t,s);l&&c||(this._active&&P(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Nh(e,t,r){for(let o=0;o<e.length;o++)if(e[o].identifier===r)return t[o]}function Uh(e,t){return Math.log2(e/t)}class ul extends cl{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,t){const r=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Uh(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Uh(this._distance,r),pinchAround:t}}}function jh(e,t){return 180*e.angleWith(t)/Math.PI}class pl extends cl{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,t){const r=this._vector;if(this._vector=e[0].sub(e[1]),r&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:jh(this._vector,r),pinchAround:t}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const t=25/(Math.PI*this._minDiameter)*360,r=this._startVector;if(!r)return!1;const o=jh(e,r);return Math.abs(o)<t}}function Gh(e){return Math.abs(e.y)>Math.abs(e.x)}class ml extends cl{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(e){this._lastPoints=e,Gh(e[0].sub(e[1]))&&(this._valid=!1)}_move(t,r,o){const s=this._lastPoints;if(!s)return;const l=t[0].sub(s[0]),c=t[1].sub(s[1]);return this._map._cooperativeGestures&&!e.eU()&&o.touches.length<3||(this._valid=this.gestureBeginsVertically(l,c,o.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(l.y+c.y)/2*-.5})}gestureBeginsVertically(e,t,r){if(void 0!==this._valid)return this._valid;const o=e.mag()>=2,s=t.mag()>=2;if(!o&&!s)return;if(!o||!s)return null==this._firstMove&&(this._firstMove=r),r-this._firstMove<100&&void 0;const l=e.y>0==t.y>0;return Gh(e)&&Gh(t)&&l}}const $h={panStep:100,bearingStep:15,pitchStep:10};class vl{constructor(){const e=$h;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let t=0,r=0,o=0,s=0,l=0;switch(e.keyCode){case 61:case 107:case 171:case 187:t=1;break;case 189:case 109:case 173:t=-1;break;case 37:e.shiftKey?r=-1:(e.preventDefault(),s=-1);break;case 39:e.shiftKey?r=1:(e.preventDefault(),s=1);break;case 38:e.shiftKey?o=1:(e.preventDefault(),l=-1);break;case 40:e.shiftKey?o=-1:(e.preventDefault(),l=1);break;default:return}return this._rotationDisabled&&(r=0,o=0),{cameraAnimation:c=>{const h=c.getZoom();c.easeTo({duration:300,easeId:"keyboardHandler",easing:Wh,zoom:t?Math.round(h)+t*(e.shiftKey?2:1):h,bearing:c.getBearing()+r*this._bearingStep,pitch:c.getPitch()+o*this._pitchStep,offset:[-s*this._panStep,-l*this._panStep],center:c.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Wh(e){return e*(2-e)}const Zh=4.000244140625,Yh=1/450;class wl{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Yh,e.aY(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||e.eU()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let r=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const o=e.o.now(),s=o-(this._lastWheelEventTime||0);this._lastWheelEventTime=o,0!==r&&r%Zh===0?this._type="wheel":0!==r&&Math.abs(r)<4?this._type="trackpad":s>400?(this._type=null,this._lastValue=r,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(s*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const t=C(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:t,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const t=this._map.transform;"wheel"===this._type&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const r=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const e="wheel"===this._type&&Math.abs(this._delta)>Zh?this._wheelZoomRate:this._defaultZoomRate;let o=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==o&&(o=1/o);const s=r(),l=Math.pow(2,s),c="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):l;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(c*o))),"wheel"===this._type&&(this._startZoom=s,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const o="number"==typeof this._targetZoom?this._targetZoom:r(),s=this._startZoom,l=this._easing;let c,h=!1;if("wheel"===this._type&&s&&l){const t=Math.min((e.o.now()-this._lastWheelEventTime)/200,1),r=l(t);c=e.ak(s,o,r),t<1?this._frameId||(this._frameId=!0):h=!0}else c=o,h=!0;this._active=!0,h&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let u=c-r();return u*this._lastDelta<0&&(u=0),{noInertia:!0,needsRenderFrame:!h,zoomDelta:u,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=e.eV;if(this._prevEase){const t=this._prevEase,o=(e.o.now()-t.start)/t.duration,s=t.easing(o+.01)-t.easing(o),l=.27/Math.sqrt(s*s+1e-4)*.01,c=Math.sqrt(.0729-l*l);r=e.eT(l,c,.25,1)}return this._prevEase={start:e.o.now(),duration:t,easing:r},r}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=u("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class Tl{constructor(e,t){this._clickZoom=e,this._tapZoom=t}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class El{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(e,t){return e.preventDefault(),{cameraAnimation:r=>{r.easeTo({duration:300,zoom:r.getZoom()+(e.shiftKey?-1:1),around:r.unproject(t)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Sl{constructor(){this._tap=new Ja({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(e,t,r){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?r.length>0&&(this._swipePoint=t[0],this._swipeTouch=r[0].identifier):this._tap.touchstart(e,t,r))}touchmove(e,t,r){if(this._tapTime){if(this._swipePoint){if(r[0].identifier!==this._swipeTouch)return;const o=t[0],s=o.y-this._swipePoint.y;return this._swipePoint=o,e.preventDefault(),this._active=!0,{zoomDelta:s/128}}}else this._tap.touchmove(e,t,r)}touchend(e,t,r){this._tapTime?this._swipePoint&&0===r.length&&this.reset():this._tap.touchend(e,t,r)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Il{constructor(e,t,r){this._el=e,this._mousePan=t,this._touchPan=r}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Cl{constructor(e,t,r){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=t,this._mousePitch=r}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Rl{constructor(e,t,r,o){this._el=e,this._touchZoom=t,this._touchRotate=r,this._tapDragZoom=o,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Jh=e=>e.zoom||e.drag||e.pitch||e.rotate;class Ll extends e.z{}class Dl{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,r){const o=e.av([],r,t);this.radius=e.ag(o[2]<0?e.eX([],o,this.constants):[o[0],o[1],0])}projectRay(t){e.eX(t,t,this.constants),e.aw(t,t),e.eY(t,t,this.constants);const r=e.c5([],t,this.radius);if(r[2]>0){const t=e.c5([],[0,0,1],e.bJ(r,[0,0,1])),o=e.c5([],e.aw([],[r[0],r[1],0]),this.radius),s=e.d8([],r,e.c5([],e.av([],e.d8([],o,t),r),2));r[0]=s[0],r[1]=s[1]}return r}}function Qh(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class Ol{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ja(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Dl,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(r),e.aY(["handleEvent","handleWindowEvent"],this);const o=this._el;this._listeners=[[o,"touchstart",{passive:!0}],[o,"touchmove",{passive:!1}],[o,"touchend",void 0],[o,"touchcancel",void 0],[o,"mousedown",void 0],[o,"mousemove",void 0],[o,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[o,"mouseover",void 0],[o,"mouseout",void 0],[o,"dblclick",void 0],[o,"click",void 0],[o,"keydown",{capture:!1}],[o,"keyup",void 0],[o,"wheel",{passive:!1}],[o,"contextmenu",void 0],[window,"blur",void 0]];for(const[e,t,r]of this._listeners){const o=e===document?this.handleWindowEvent:this.handleEvent;e.addEventListener(t,o,r)}}destroy(){for(const[e,t,r]of this._listeners){const o=e===document?this.handleWindowEvent:this.handleEvent;e.removeEventListener(t,o,r)}}_addDefaultHandlers(e){const t=this._map,r=t.getCanvasContainer();this._add("mapEvent",new Wa(t,e));const o=t.boxZoom=new Xa(t,e);this._add("boxZoom",o);const s=new Qa,l=new El;t.doubleClickZoom=new Tl(l,s),this._add("tapZoom",s),this._add("clickZoom",l);const c=new Sl;this._add("tapDragZoom",c);const h=t.touchPitch=new ml(t);this._add("touchPitch",h);const u=new nl(e),d=new al(e);t.dragRotate=new Cl(e,u,d),this._add("mouseRotate",u,["mousePitch"]),this._add("mousePitch",d,["mouseRotate"]);const p=new rl(e),f=new ll(t,e);t.dragPan=new Il(r,p,f),this._add("mousePan",p),this._add("touchPan",f,["touchZoom","touchRotate"]);const m=new pl,_=new ul;t.touchZoomRotate=new Rl(r,_,m,c),this._add("touchRotate",m,["touchPan","touchZoom"]),this._add("touchZoom",_,["touchPan","touchRotate"]),this._add("blockableMapEvent",new $a(t));const v=t.scrollZoom=new wl(t,this);this._add("scrollZoom",v,["mousePan"]);const E=t.keyboard=new vl;this._add("keyboard",E);for(const r of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[r]&&t[r].enable(e[r])}_add(e,t,r){this._handlers.push({handlerName:e,handler:t,allowed:r}),this._handlersById[e]=t}stop(e){if(!this._updatingCamera){for(const{handler:e}of this._handlers)e.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Jh(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(e,t,r){for(const o in e)if(o!==r&&(!t||t.indexOf(o)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){const t=[];for(const r of e)this._el.contains(r.target)&&t.push(r);return t}handleEvent(e,t){this._updatingCamera=!0;const r="renderFrame"===e.type,o=r?void 0:e,s={needsRenderFrame:!1},l={},c={},h=e.touches?this._getMapTouches(e.touches):void 0,u=h?R(this._el,h):r?void 0:C(this._el,e);for(const{handlerName:r,handler:d,allowed:p}of this._handlers){if(!d.isEnabled())continue;let f;this._blockedByActive(c,p,r)?d.reset():d[t||e.type]&&(f=d[t||e.type](e,u,h),this.mergeHandlerResult(s,l,f,r,o),f&&f.needsRenderFrame&&this._triggerRenderFrame()),(f||d.isActive())&&(c[r]=d)}const d={};for(const e in this._previousActiveHandlers)c[e]||(d[e]=o);this._previousActiveHandlers=c,(Object.keys(d).length||Qh(s))&&(this._changes.push([s,l,d]),this._triggerRenderFrame()),(Object.keys(c).length||Qh(s))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:p}=s;p&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],p(this._map))}mergeHandlerResult(e,t,r,o,s){if(!r)return;Object.assign(e,r);const l={handlerName:o,originalEvent:r.originalEvent||s};void 0!==r.zoomDelta&&(t.zoom=l),void 0!==r.panDelta&&(t.drag=l),void 0!==r.pitchDelta&&(t.pitch=l),void 0!==r.bearingDelta&&(t.rotate=l)}_applyChanges(){const t={},r={},o={};for(const[s,l,c]of this._changes)s.panDelta&&(t.panDelta=(t.panDelta||new e.P(0,0))._add(s.panDelta)),s.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+s.zoomDelta),s.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+s.bearingDelta),s.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+s.pitchDelta),void 0!==s.around&&(t.around=s.around),void 0!==s.aroundCoord&&(t.aroundCoord=s.aroundCoord),void 0!==s.pinchAround&&(t.pinchAround=s.pinchAround),s.noInertia&&(t.noInertia=s.noInertia),Object.assign(r,l),Object.assign(o,c);this._updateMapTransform(t,r,o),this._changes=[]}_updateMapTransform(t,r,o){const s=this._map,l=s.transform,c=e=>[e.x,e.y,e.z];if((()=>{const e=this._eventsInProgress.drag;return e&&!this._handlersById[e.handlerName].isActive()})()&&!Qh(t)){const e=l.zoom;l.cameraElevationReference="sea",null!=this._originalZoom&&l._orthographicProjectionAtLowPitch&&"globe"!==l.projection.name&&0===l.pitch?(l.cameraElevationReference="ground",l.zoom=this._originalZoom):(l.recenterOnTerrain(),l.cameraElevationReference="ground"),e!==l.zoom&&this._map._update(!0)}if(l._isCameraConstrained&&s._stop(!0),!Qh(t))return void this._fireEvents(r,o,!0);let{panDelta:h,zoomDelta:u,bearingDelta:d,pitchDelta:p,around:f,aroundCoord:m,pinchAround:_}=t;l._isCameraConstrained&&(u>0&&(u=0),l._isCameraConstrained=!1),void 0!==_&&(f=_),(u||(e=>r[e]&&!this._eventsInProgress[e])("drag"))&&f&&(this._dragOrigin=c(l.pointCoordinate3D(f)),this._originalZoom=l.zoom,this._trackingEllipsoid.setup(l._camera.position,this._dragOrigin)),l.cameraElevationReference="sea",s._stop(!0),f=f||s.transform.centerPoint,d&&(l.bearing+=d),p&&(l.pitch+=p),l._updateCameraState();const v=[0,0,0];if(h)if("mercator"===l.projection.name){const e=this._trackingEllipsoid.projectRay(l.screenPointToMercatorRay(f).dir),t=this._trackingEllipsoid.projectRay(l.screenPointToMercatorRay(f.sub(h)).dir);v[0]=t[0]-e[0],v[1]=t[1]-e[1]}else{const t=l.pointCoordinate(f);if("globe"===l.projection.name){h=h.rotate(-l.angle);const r=l._pixelsPerMercatorPixel/l.worldSize;v[0]=-h.x*e.eW(e.a$(t.y))*r,v[1]=-h.y*e.eW(l.center.lat)*r}else{const e=l.pointCoordinate(f.sub(h));t&&e&&(v[0]=e.x-t.x,v[1]=e.y-t.y)}}const E=l.zoom,P=[0,0,0];if(u){const t=c(m||l.pointCoordinate3D(f)),r={dir:e.aw([],e.av([],t,l._camera.position))};if(r.dir[2]<0){const o=l.zoomDeltaToMovement(t,u);e.c5(P,r.dir,o)}}const C=e.d8(v,v,P);l._translateCameraConstrained(C),u&&Math.abs(l.zoom-E)>1e-4&&l.recenterOnTerrain(),l.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,o,!0)}_fireEvents(t,r,o){const s=Jh(this._eventsInProgress),l=Jh(t),c={};for(const e in t){const{originalEvent:r}=t[e];this._eventsInProgress[e]||(c[`${e}start`]=r),this._eventsInProgress[e]=t[e]}!s&&l&&this._fireEvent("movestart",l.originalEvent);for(const e in c)this._fireEvent(e,c[e]);l&&this._fireEvent("move",l.originalEvent);for(const e in t){const{originalEvent:r}=t[e];this._fireEvent(e,r)}const h={};let u;for(const e in this._eventsInProgress){const{handlerName:t,originalEvent:o}=this._eventsInProgress[e];this._handlersById[t].isActive()||(delete this._eventsInProgress[e],u=r[t]||o,h[`${e}end`]=u)}for(const e in h)this._fireEvent(e,h[e]);const d=Jh(this._eventsInProgress);if(o&&(s||l)&&!d){this._updatingCamera=!0;const t=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),r=e=>0!==e&&-this._bearingSnap<e&&e<this._bearingSnap;t?(r(t.bearing||this._map.getBearing())&&(t.bearing=0),this._map.easeTo(t,{originalEvent:u})):(this._map.fire(new e.z("moveend",{originalEvent:u})),r(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new e.z(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((e=>{this._frameId=void 0,this.handleEvent(new Ll("renderFrame",{timeStamp:e})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Kh="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ml extends e.E{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,this._respectPrefersReducedMotion=!1!==r.respectPrefersReducedMotion,e.aY(["_renderFrameCallback"],this)}getCenter(){return new e.aT(this.transform.center.lng,this.transform.center.lat)}setCenter(e,t){return this.jumpTo({center:e},t)}panBy(t,r,o){return t=e.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},r),o)}panTo(e,t,r){return this.easeTo(Object.assign({center:e},t),r)}getZoom(){return this.transform.zoom}setZoom(e,t){return this.jumpTo({zoom:e},t),this}zoomTo(e,t,r){return this.easeTo(Object.assign({zoom:e},t),r)}zoomIn(e,t){return this.zoomTo(this.getZoom()+1,e,t),this}zoomOut(e,t){return this.zoomTo(this.getZoom()-1,e,t),this}getBearing(){return this.transform.bearing}setBearing(e,t){return this.jumpTo({bearing:e},t),this}getPadding(){return this.transform.padding}setPadding(e,t){return this.jumpTo({padding:e},t),this}rotateTo(e,t,r){return this.easeTo(Object.assign({bearing:e},t),r)}resetNorth(e,t){return this.rotateTo(0,Object.assign({duration:1e3},e),t),this}resetNorthPitch(e,t){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},e),t),this}snapToNorth(e,t){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,t):this}getPitch(){return this.transform.pitch}setPitch(e,t){return this.jumpTo({pitch:e},t),this}cameraForBounds(t,r){t=e.aI.convert(t);const o=r&&r.bearing||0,s=r&&r.pitch||0,l=t.getNorthWest(),c=t.getSouthEast();return this._cameraForBounds(this.transform,l,c,o,s,r)}_extendPadding(e){const t={top:0,right:0,bottom:0,left:0};return null==e?Object.assign({},t,this.transform.padding):"number"==typeof e?{top:e,bottom:e,right:e,left:e}:Object.assign({},t,e)}_extendCameraOptions(e){return(e=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding=this._extendPadding(e.padding),e}_minimumAABBFrustumDistance(e,t){const r=t.max[0]-t.min[0],o=t.max[1]-t.min[1];return r/o>e.aspect?r/(2*Math.tan(.5*e.fovX)*e.aspect):o/(2*Math.tan(.5*e.fovY)*e.aspect)}_cameraForBoundsOnGlobe(t,r,o,s,l,c){const h=t.clone(),u=this._extendCameraOptions(c);h.bearing=s,h.pitch=l;const d=e.aT.convert(r),p=e.aT.convert(o),f=.5*(d.lat+p.lat),m=.5*(d.lng+p.lng),_=e.eZ(f,m),v=e.aw([],_),E=e.aw([],e.bI([],v,[0,1,0])),P=e.bI([],E,v),C=[E[0],E[1],E[2],0,P[0],P[1],P[2],0,v[0],v[1],v[2],0,0,0,0,1],R=[_,e.eZ(d.lat,d.lng),e.eZ(p.lat,d.lng),e.eZ(p.lat,p.lng),e.eZ(d.lat,p.lng),e.eZ(f,d.lng),e.eZ(f,p.lng),e.eZ(d.lat,m),e.eZ(p.lat,m)];let z=e.d9.fromPoints(R.map((t=>[e.bJ(E,t),e.bJ(P,t),e.bJ(v,t)])));const D=e.af([],z.center,C);0===e.e_(D)&&e.e$(D,0,0,1),e.aw(D,D),e.c5(D,D,e.aD),h.center=e.f0(D);const O=h.getWorldToCameraMatrix(),F=e.bl(new Float64Array(16),O);z=e.d9.applyTransform(z,e.aB([],O,C));const B=this._extendAABB(z,h,u,s);if(!B)return void e.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");z=B,e.af(D,D,O);const k=.5*(z.max[2]-z.min[2]),V=this._minimumAABBFrustumDistance(h,z),N=e.c5([],[0,0,1],k),U=e.d8(N,D,N),j=V+(0===h.pitch?0:e.bG(D,U)),$=h.globeCenterInViewSpace,q=e.av([],D,[$[0],$[1],$[2]]);e.aw(q,q),e.c5(q,q,j);const H=e.d8([],D,q);e.af(H,H,F);const Z=e.eM/e.aD,Y=e.ag(H),J=e.cf(Math.max(Y*Z-e.eM,Number.EPSILON),0),Q=Math.min(h.zoomFromMercatorZAdjusted(J),u.maxZoom);return Q>.5*(e.c_+e.cL)?(h.setProjection({name:"mercator"}),h.zoom=Q,this._cameraForBounds(h,r,o,s,l,c)):{center:h.center,zoom:Q,bearing:s,pitch:l}}_extendAABB(t,r,o,s){const l=.5*((o.padding.left||0)+(o.padding.right||0)),c=.5*((o.padding.top||0)+(o.padding.bottom||0)),h=c,u=l,d=l,p=c,f=r.width-(u+d),m=r.height-(h+p),_=e.av([],t.max,t.min),v=Math.min(f/_[0],m/_[1]),E=Math.min(r.scaleZoom(r.scale*v),o.maxZoom);if(isNaN(E))return null;const P=r.scale/r.zoomScale(E),C=new e.d9([t.min[0]-u*P,t.min[1]-p*P,t.min[2]],[t.max[0]+d*P,t.max[1]+h*P,t.max[2]]),R=("number"==typeof o.offset.x&&"number"==typeof o.offset.y?new e.P(o.offset.x,o.offset.y):e.P.convert(o.offset)).rotate(-e.an(s));return C.center[0]-=R.x*P,C.center[1]+=R.y*P,C}queryTerrainElevation(t,r){const o=this.transform.elevation;return o?(r=Object.assign({},{exaggerated:!0},r),o.getAtPoint(e.ae.fromLngLat(t),null,r.exaggerated)):null}_cameraForBounds(t,r,o,s,l,c){if("globe"===t.projection.name)return this._cameraForBoundsOnGlobe(t,r,o,s,l,c);const h=t.clone(),u=this._extendCameraOptions(c);h.bearing=s,h.pitch=l;const d=e.aT.convert(r),p=e.aT.convert(o),f=new e.aT(d.lng,p.lat),m=new e.aT(p.lng,d.lat),_=h.project(d),v=h.project(p),E=this.queryTerrainElevation(d),P=this.queryTerrainElevation(p),C=this.queryTerrainElevation(f),R=this.queryTerrainElevation(m),z=[[_.x,_.y,Math.min(E||0,P||0,C||0,R||0)],[v.x,v.y,Math.max(E||0,P||0,C||0,R||0)]];let D=e.d9.fromPoints(z);const O=h.getWorldToCameraMatrix(),F=e.bl(new Float64Array(16),O);D=e.d9.applyTransform(D,O);const B=this._extendAABB(D,h,u,s);if(!B)return void e.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");D=B;const k=.5*e.av([],D.max,D.min)[2],V=this._minimumAABBFrustumDistance(h,D),N=[0,0,1,0];e.aC(N,N,O),e.f1(N,N);const U=e.c5([],N,V+k),j=e.d8([],D.center,U);e.af(D.center,D.center,F),e.af(j,j,F);const $=h.unproject(new e.P(D.center[0],D.center[1])),q=e.f2(h.projection,$),H=Math.pow(2,q),Z=Math.min(h._zoomFromMercatorZ(j[2]*h.pixelsPerMeter*H/h.worldSize),u.maxZoom);return h.mercatorFromTransition&&Z<.5*(e.c_+e.cL)?(h.setProjection({name:"globe"}),h.zoom=Z,this._cameraForBounds(h,r,o,s,l,c)):{center:$,zoom:Z,bearing:s,pitch:l}}fitBounds(e,t,r){const o=this.cameraForBounds(e,t);return this._fitInternal(o,t,r)}fitScreenCoordinates(t,r,o,s,l){const c=e.P.convert(t),h=e.P.convert(r),u=new e.P(Math.min(c.x,h.x),Math.min(c.y,h.y)),d=new e.P(Math.max(c.x,h.x),Math.max(c.y,h.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(c,h))return this;const p=this.transform.pointLocation3D(u),f=this.transform.pointLocation3D(d),m=this.transform.pointLocation3D(new e.P(u.x,d.y)),_=this.transform.pointLocation3D(new e.P(d.x,u.y)),v=[Math.min(p.lng,f.lng,m.lng,_.lng),Math.min(p.lat,f.lat,m.lat,_.lat)],E=[Math.max(p.lng,f.lng,m.lng,_.lng),Math.max(p.lat,f.lat,m.lat,_.lat)],P=s&&s.pitch?s.pitch:this.getPitch(),C=this._cameraForBounds(this.transform,v,E,o,P,s);return this._fitInternal(C,s,l)}_fitInternal(e,t,r){return e?(t=Object.assign(e,t)).linear?this.easeTo(t,r):this.flyTo(t,r):this}jumpTo(t,r){this.stop();const o=t.preloadOnly?this.transform.clone():this.transform;let s=!1,l=!1,c=!1;"zoom"in t&&o.zoom!==+t.zoom&&(s=!0,o.zoom=+t.zoom),void 0!==t.center&&(o.center=e.aT.convert(t.center)),"bearing"in t&&o.bearing!==+t.bearing&&(l=!0,o.bearing=+t.bearing),"pitch"in t&&o.pitch!==+t.pitch&&(c=!0,o.pitch=+t.pitch);const h="number"==typeof t.padding?this._extendPadding(t.padding):t.padding;if(null!=t.padding&&!o.isPaddingEqual(h))if(!1===t.retainPadding){const e=o.clone();e.padding=h,o.setLocationAtPoint(o.center,e.centerPoint)}else o.padding=h;return t.preloadOnly?(this._preloadTiles(o),this):(this.fire(new e.z("movestart",r)).fire(new e.z("move",r)),s&&this.fire(new e.z("zoomstart",r)).fire(new e.z("zoom",r)).fire(new e.z("zoomend",r)),l&&this.fire(new e.z("rotatestart",r)).fire(new e.z("rotate",r)).fire(new e.z("rotateend",r)),c&&this.fire(new e.z("pitchstart",r)).fire(new e.z("pitch",r)).fire(new e.z("pitchend",r)),this.fire(new e.z("moveend",r)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||e.w(Kh),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,r){const o=this.transform;if(!o.projection.supportsFreeCamera)return e.w(Kh),this;this.stop();const s=o.zoom,l=o.pitch,c=o.bearing;o.setFreeCameraOptions(t);const h=s!==o.zoom,u=l!==o.pitch,d=c!==o.bearing;return this.fire(new e.z("movestart",r)).fire(new e.z("move",r)),h&&this.fire(new e.z("zoomstart",r)).fire(new e.z("zoom",r)).fire(new e.z("zoomend",r)),d&&this.fire(new e.z("rotatestart",r)).fire(new e.z("rotate",r)).fire(new e.z("rotateend",r)),u&&this.fire(new e.z("pitchstart",r)).fire(new e.z("pitch",r)).fire(new e.z("pitchend",r)),this.fire(new e.z("moveend",r)),this}easeTo(t,r){this._stop(!1,t.easeId),(!1===(t=Object.assign({offset:[0,0],duration:500,easing:e.eV},t)).animate||this._prefersReducedMotion(t))&&(t.duration=0);const o=this.transform,s=this.getZoom(),l=this.getBearing(),c=this.getPitch(),h=this.getPadding(),u="zoom"in t?+t.zoom:s,d="bearing"in t?this._normalizeBearing(t.bearing,l):l,p="pitch"in t?+t.pitch:c,f=this._extendPadding(t.padding),m=e.P.convert(t.offset);let _,v,E;if("globe"===o.projection.name){const r=e.ae.fromLngLat(o.center),s=m.rotate(-o.angle);r.x+=s.x/o.worldSize,r.y+=s.y/o.worldSize;const l=r.toLngLat(),c=e.aT.convert(t.center||l);this._normalizeCenter(c),_=o.centerPoint.add(s),v=new e.P(r.x,r.y).mult(o.worldSize),E=new e.P(e.aF(c.lng),e.aJ(c.lat)).mult(o.worldSize).sub(v)}else{_=o.centerPoint.add(m);const r=o.pointLocation(_),s=e.aT.convert(t.center||r);this._normalizeCenter(s),v=o.project(r),E=o.project(s).sub(v)}const P=o.zoomScale(u-s);let C,R;t.around&&(C=e.aT.convert(t.around),R=o.locationPoint(C));const z=this._zooming||u!==s,D=this._rotating||l!==d,O=this._pitching||p!==c,F=!o.isPaddingEqual(f),B=!1===t.retainPadding?o.clone():o,k=o=>k=>{if(z&&(o.zoom=e.ak(s,u,k)),D&&(o.bearing=e.ak(l,d,k)),O&&(o.pitch=e.ak(c,p,k)),F&&(B.interpolatePadding(h,f,k),_=B.centerPoint.add(m)),C)o.setLocationAtPoint(C,R);else{const e=o.zoomScale(o.zoom-s),t=u>s?Math.min(2,P):Math.max(.5,P),r=Math.pow(t,1-k),l=o.unproject(v.add(E.mult(k*r)).mult(e));o.setLocationAtPoint(o.renderWorldCopies?l.wrap():l,_)}return t.preloadOnly||this._fireMoveEvents(r),o};if(t.preloadOnly){const e=this._emulate(k,t.duration,o);return this._preloadTiles(e),this}const V={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=z,this._rotating=D,this._pitching=O,this._padding=F,this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,V),this._ease(k(o),(e=>{"sea"===o.cameraElevationReference&&o.recenterOnTerrain(),this._afterEase(r,e)}),t),this}_prepareEase(t,r,o={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),r||o.moving||this.fire(new e.z("movestart",t)),this._zooming&&!o.zooming&&this.fire(new e.z("zoomstart",t)),this._rotating&&!o.rotating&&this.fire(new e.z("rotatestart",t)),this._pitching&&!o.pitching&&this.fire(new e.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new e.z("move",t)),this._zooming&&this.fire(new e.z("zoom",t)),this._rotating&&this.fire(new e.z("rotate",t)),this._pitching&&this.fire(new e.z("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const o=this._zooming,s=this._rotating,l=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,o&&this.fire(new e.z("zoomend",t)),s&&this.fire(new e.z("rotateend",t)),l&&this.fire(new e.z("pitchend",t)),this.fire(new e.z("moveend",t))}flyTo(t,r){if(this._prefersReducedMotion(t)){const o=e.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(o,r)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:e.eV},t);const o=this.transform,s=this.getZoom(),l=this.getBearing(),c=this.getPitch(),h=this.getPadding(),u="zoom"in t?e.aA(+t.zoom,o.minZoom,o.maxZoom):s,d="bearing"in t?this._normalizeBearing(t.bearing,l):l,p="pitch"in t?+t.pitch:c,f=this._extendPadding(t.padding),m=o.zoomScale(u-s),_=e.P.convert(t.offset);let v=o.centerPoint.add(_);const E=o.pointLocation(v),P=e.aT.convert(t.center||E);this._normalizeCenter(P);const C=o.project(E),R=o.project(P).sub(C);let z=t.curve;const D=Math.max(o.width,o.height),O=D/m,F=R.mag();if("minZoom"in t){const r=e.aA(Math.min(t.minZoom,s,u),o.minZoom,o.maxZoom),l=D/o.zoomScale(r-s);z=Math.sqrt(l/F*2)}const B=z*z;function k(e){const t=(O*O-D*D+(e?-1:1)*B*B*F*F)/(2*(e?O:D)*B*F);return Math.log(Math.sqrt(t*t+1)-t)}function V(e){return(Math.exp(e)-Math.exp(-e))/2}function N(e){return(Math.exp(e)+Math.exp(-e))/2}const U=k(0);let j=function(e){return N(U)/N(U+z*e)},$=function(e){return D*((N(U)*(V(t=U+z*e)/N(t))-V(U))/B)/F;var t},q=(k(1)-U)/z;if(Math.abs(F)<1e-6||!isFinite(q)){if(Math.abs(D-O)<1e-6)return this.easeTo(t,r);const e=O<D?-1:1;q=Math.abs(Math.log(O/D))/z,$=function(){return 0},j=function(t){return Math.exp(e*z*t)}}t.duration="duration"in t?+t.duration:1e3*q/("screenSpeed"in t?+t.screenSpeed/z:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const H=l!==d,Z=p!==c,Y=!o.isPaddingEqual(f),J=!1===t.retainPadding?o.clone():o,Q=o=>m=>{const E=m*q,z=1/j(E);o.zoom=1===m?u:s+o.scaleZoom(z),H&&(o.bearing=e.ak(l,d,m)),Z&&(o.pitch=e.ak(c,p,m)),Y&&(J.interpolatePadding(h,f,m),v=J.centerPoint.add(_));const D=1===m?P:o.unproject(C.add(R.mult($(E))).mult(z));return o.setLocationAtPoint(o.renderWorldCopies?D.wrap():D,v),o._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(r),o};if(t.preloadOnly){const e=this._emulate(Q,t.duration,o);return this._preloadTiles(e),this}return this._zooming=!0,this._rotating=H,this._pitching=Z,this._padding=Y,this._prepareEase(r,!1),this._ease(Q(o),(()=>this._afterEase(r)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(e){}_cancelRenderFrame(e){}_stop(e,t){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const e=this._onEaseEnd;this._onEaseEnd=void 0,e.call(this,t)}if(!e){const e=this.handlers;e&&e.stop(!1)}return this}_ease(t,r,o){!1===o.animate||0===o.duration?(t(1),r()):(this._easeStart=e.o.now(),this._easeOptions=o,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((e.o.now()-this._easeStart)/this._easeOptions.duration,1),r=this._onEaseFrame;r&&r(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=e.bT(t,-180,180);const o=Math.abs(t-r);return Math.abs(t-360-r)<o&&(t-=360),Math.abs(t+360-r)<o&&(t+=360),t}_normalizeCenter(e){const t=this.transform;if(t.maxBounds)return;if("globe"!==t.projection.name&&!t.renderWorldCopies)return;const r=e.lng-t.center.lng;e.lng+=r>180?-360:r<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&e.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(e,t,r){const o=Math.ceil(15*t/1e3),s=[],l=e(r.clone());for(let e=0;e<=o;e++){const t=l(e/o);s.push(t.clone())}return s}_preloadTiles(e,t){}}class Fl{constructor(t={}){this.options=t,e.aY(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){const t=this.options&&this.options.compact,r=e._getUIString("AttributionControl.ToggleAttribution");this._map=e,this._container=u("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=u("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",r);const o=u("span","mapboxgl-ctrl-icon",this._compactButton);return o.setAttribute("aria-hidden","true"),o.setAttribute("title",r),this._innerContainer=u("div","mapboxgl-ctrl-attrib-inner",this._container),t&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===t&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const r=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||e.e.ACCESS_TOKEN}];if(t){const o=r.reduce(((e,t,o)=>(t.value&&(e+=`${t.key}=${t.value}${o<r.length-1?"&":""}`),e)),"?");t.href=`${e.e.FEEDBACK_URL}/${o}#${Eh(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(e){!e||("source"!==e.dataType||"metadata"!==e.sourceDataType&&"visibility"!==e.sourceDataType)&&"style"!==e.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){const e=this._map.style.stylesheet;this.styleOwner=e.owner,this.styleId=e.id}const t=this._map.style._mergedSourceCaches;for(const r in t){const o=t[r];if(o.used){const t=o.getSource();t.attribution&&e.indexOf(t.attribution)<0&&e.push(t.attribution)}}e.sort(((e,t)=>e.length-t.length)),e=e.filter(((t,r)=>{for(let o=r+1;o<e.length;o++)if(e[o].indexOf(t)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));const r=e.map((e=>function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.querySelectorAll("*")).reverse().forEach((e=>{const r=e.textContent||"";if("A"!==e.tagName)return void e.replaceWith(...e.childNodes);const o=e.getAttribute("href");if(!o||!/^(https?:|mailto:)/i.test(o))return void e.replaceWith(t.createTextNode(r));const s=t.createElement("a");s.href=o,s.textContent=r,s.rel="noopener nofollow";const l=e.getAttribute("class");l&&(s.className=l),e.replaceWith(s)})),t.body.innerHTML}(e))).join(" | ");r!==this._attribHTML&&(this._attribHTML=r,e.length?(this._innerContainer.innerHTML=r,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Bl{constructor(){e.aY(["_updateLogo","_updateCompact"],this)}onAdd(e){this._map=e,this._container=u("div","mapboxgl-ctrl");const t=u("a","mapboxgl-ctrl-logo");return t.target="_blank",t.rel="noopener nofollow",t.href="https://www.mapbox.com/",t.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),t.setAttribute("rel","noopener nofollow"),this._container.appendChild(t),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(e){e&&"metadata"!==e.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const e=this._map.style._sourceCaches;if(0===Object.entries(e).length)return!0;for(const t in e){const r=e[t].getSource();if(r.hasOwnProperty("mapbox_logo")&&!r.mapbox_logo)return!1}return!0}_updateCompact(){const e=this._container.children;if(e.length){const t=e[0];this._map.getCanvasContainer().offsetWidth<250?t.classList.add("mapboxgl-compact"):t.classList.remove("mapboxgl-compact")}}}class kl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const t=++this._id;return this._queue.push({callback:e,id:t,cancelled:!1}),t}remove(e){const t=this._currentlyRunning,r=t?this._queue.concat(t):this._queue;for(const t of r)if(t.id===e)return void(t.cancelled=!0)}run(e=0){const t=this._currentlyRunning=this._queue;this._queue=[];for(const r of t)if(!r.cancelled&&(r.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Nl{constructor(e){this.jumpTo(e)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const r=e.dD((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-r)+this._end*r}isEasing(e){return e>=this._startTime&&e<=this._endTime}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e}easeTo(e,t,r){this._start=this.getValue(t),this._end=e,this._startTime=t,this._endTime=t+r}}const eu={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class jl extends e.z{constructor(e,t,r,o){const{point:s,lngLat:l,originalEvent:c,target:h}=e;super(e.type,{point:s,lngLat:l,originalEvent:c,target:h}),this.preventDefault=()=>{e.preventDefault()},this.id=t,this.interaction=r,this.feature=o}}class Vl{constructor(e){this.map=e,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,r){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const o=r.filter;let s=r.type;o&&this.filters.set(t,e.b6(o)),"mouseover"===s&&(s="mouseenter"),"mouseout"===s&&(s="mouseleave");const l=this.interactionsByType.get(s)||new Map;"mouseenter"===s||"mouseleave"===s?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,r)):0===l.size&&this.map.on(s,this.handleType),0===l.size&&this.interactionsByType.set(s,l),l.set(t,r),this.typeById.set(t,s)}get(e){const t=this.typeById.get(e);if(!t)return;const r=this.interactionsByType.get(t);return r?r.get(e):void 0}remove(e){const t=this.typeById.get(e);if(!t)return;this.typeById.delete(e),this.filters.delete(e);const r=this.interactionsByType.get(t);r&&(r.delete(e),"mouseenter"===t||"mouseleave"===t?(this.delegatedInteractions.delete(e),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===r.size&&this.map.off(t,this.handleType))}queryTargets(e,t){const r=[];for(const[e,o]of t)o.target&&r.push({targetId:e,target:o.target,filter:this.filters.get(e)});return this.map.style.queryRenderedTargets(e,r,this.map.transform)}handleMove(e){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const t=this.queryTargets(e.point,Array.from(this.delegatedInteractions).reverse());t.length&&(e.type="mouseenter",this.handleType(e,t));const r=new Map;for(const[e,{feature:t}]of this.prevHoveredFeatures)this.hoveredFeatures.has(e)||r.set(t.id,t);r.size&&(e.type="mouseleave",this.handleType(e,Array.from(r.values())))}handleOut(e){const t=Array.from(this.hoveredFeatures.values()).map((({feature:e})=>e));t.length&&(e.type="mouseleave",this.handleType(e,t)),this.hoveredFeatures.clear()}handleType(t,r){const o="mouseenter"===t.type;if(o&&!this.interactionsByType.has(t.type))return void e.w("mouseenter interaction required for mouseleave to work.");const s=Array.from(this.interactionsByType.get(t.type)).reverse(),l=!!r;r=r||this.queryTargets(t.point,s);let c=!1;const h=new Set;for(const u of r){for(const[r,d]of s){if(!d.target)continue;const s=u.variants?u.variants[r]:null;if(s){for(const p of s){if(jt(p,u,h,r))continue;const s=new e.dx(u,p),f=Nt(p,u,r);l&&void 0!==s.id&&(s.state=this.map.getFeatureState(s));const m=o?this.prevHoveredFeatures.get(f):null,_=new jl(t,r,d,s),v=m?m.stop:d.handler(_);if(o&&this.hoveredFeatures.set(f,{feature:u,stop:v}),!1!==v){c=!0;break}}if(c)break}}if(c)break}if(!c)for(const[e,r]of s){const{handler:o,target:s}=r;if(!s&&!1!==o(new jl(t,e,r,null)))break}}}function iu(t,r){if(Array.isArray(t)&&Array.isArray(r)){const e=new Set(t),o=new Set(r);return e.size===o.size&&t.every((e=>o.has(e)))}return e.by(t,r)}const nu={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},ou={showCompass:!0,showZoom:!0,visualizePitch:!1};class Zl{constructor(t,r,o=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new nl({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,o&&(this.mousePitch=new al({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),e.aY(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),r.addEventListener("mousedown",this.mousedown),r.addEventListener("touchstart",this.touchstart,{passive:!1}),r.addEventListener("touchmove",this.touchmove),r.addEventListener("touchend",this.touchend),r.addEventListener("touchcancel",this.reset)}down(e,t){this.mouseRotate.mousedown(e,t),this.mousePitch&&this.mousePitch.mousedown(e,t),_()}move(e,t){const r=this.map,o=this.mouseRotate.mousemoveWindow(e,t),s=o&&o.bearingDelta;if(s&&r.setBearing(r.getBearing()+s),this.mousePitch){const o=this.mousePitch.mousemoveWindow(e,t),s=o&&o.pitchDelta;s&&r.setPitch(r.getPitch()+s)}}off(){const e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){v(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(Object.assign({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),C(this.element,e)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(e){this.move(e,C(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){1!==e.targetTouches.length?this.reset():(this._startPos=this._lastPos=R(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){1!==e.targetTouches.length?this.reset():(this._lastPos=R(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){0===e.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function au(t,r,o){if(t=new e.aT(t.lng,t.lat),r){const s=new e.aT(t.lng-360,t.lat),l=new e.aT(t.lng+360,t.lat),c=360*Math.ceil(Math.abs(t.lng-o.center.lng)/360),h=o.locationPoint3D(t).distSqr(r),u=r.x<0||r.y<0||r.x>o.width||r.y>o.height;o.locationPoint3D(s).distSqr(r)<h&&(u||Math.abs(s.lng-o.center.lng)<c)?t=s:o.locationPoint3D(l).distSqr(r)<h&&(u||Math.abs(l.lng-o.center.lng)<c)&&(t=l)}for(;Math.abs(t.lng-o.center.lng)>180;){const e=o.locationPoint3D(t);if(e.x>=0&&e.y>=0&&e.x<=o.width&&e.y<=o.height)break;t.lng>o.center.lng?t.lng-=360:t.lng+=360}return t}const mu={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},_u={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Yl extends e.E{constructor(t,r){super(),(t instanceof HTMLElement||r)&&(t=Object.assign({element:t},r)),e.aY(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:o="center",color:s="#3FB1CE",scale:l=1,draggable:c=!1,clickTolerance:h=0,rotation:u=_u.rotation,rotationAlignment:d=_u.rotationAlignment,pitchAlignment:p=_u.pitchAlignment,occludedOpacity:f=_u.occludedOpacity,altitude:m=_u.altitude}=t||{};this._anchor=o,this._color=s,this._scale=l,this._draggable=c,this._clickTolerance=h,this._rotation=u,this._rotationAlignment=d,this._pitchAlignment=p,this._occludedOpacity=f,this._altitude=m,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=e.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=e.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(e=>{e.preventDefault()})),this._element.addEventListener("mousedown",(e=>{e.preventDefault()}));const _=this._element.classList;for(const e in mu)_.remove(`mapboxgl-marker-anchor-${e}`);_.add(`mapboxgl-marker-anchor-${this._anchor}`);const v=t&&t.className?t.className.trim().split(/\s+/):[];_.add(...v),this._popup=null}_createDefaultMarker(){const e=u("div"),t=d("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},e);if(0===this._altitude){const e=d("radialGradient",{id:"shadowGradient"},d("defs",{},t));d("stop",{offset:"10%","stop-opacity":.4},e),d("stop",{offset:"100%","stop-opacity":.05},e),d("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},t)}return d("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},t),d("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},t),d("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},t),e}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),e.on("click",this._onMapClick)),this}remove(){const e=this._map;return e&&(e.off("click",this._onMapClick),e.off("move",this._updateMoving),e.off("moveend",this._update),e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler),e.off("mouseup",this._onUp),e.off("touchend",this._onUp),e.off("mousemove",this._onMove),e.off("touchmove",this._onMove),e.off("remove",this._clearFadeTimer),e._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=e.aT.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(e){return e===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==e||0!==this._altitude&&0===e)&&(this._element=this._createDefaultMarker()),this._altitude=e||_u.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const t=38.1,r=13.5,o=Math.sqrt(Math.pow(r,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-t],"bottom-left":[o,-1*(t-r+o)],"bottom-right":[-o,-1*(t-r+o)],left:[r,-1*(t-r)],right:[-r,-1*(t-r)]}:this._offset}this._popup=e,e._marker=this,e._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(e){const t=e.code,r=e.charCode||e.keyCode;"Space"!==t&&"Enter"!==t&&32!==r&&13!==r||this.togglePopup()}_onMapClick(e){const t=e.originalEvent.target,r=this._element;this._popup&&(t===r||r.contains(t))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const e=this._map,t=this._pos;if(!e||!t)return!1;const r=e.unproject(t,this._altitude),o=e.getFreeCameraOptions();if(!o.position)return!1;const s=o.position.toLngLat();return s.distanceTo(r)<.9*s.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const r=this._pos;if(!r||r.x<0||r.x>t.transform.width||r.y<0||r.y>t.transform.height)return void this._clearFadeTimer();const o=t.unproject(r,this._altitude);let s;t._showingGlobe()&&e.f5(t.transform,this._lngLat)?s=0:(s=1-t._queryFogOpacity(o),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(s*=this._occludedOpacity)),this._element.style.opacity=`${s}`,this._element.style.pointerEvents=s>0?"auto":"none",this._popup&&this._popup._setOpacity(s),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const e=this._pos;if(!e||!this._map)return;const t=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${e.x}px,${e.y}px)\n            ${mu[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${t.x}px,${t.y}px)\n        `}_calculateXYTransform(){const t=this._pos,r=this._map,o=this.getPitchAlignment();if(!r||!t||"map"!==o)return"";if(!r._showingGlobe()){const e=r.getPitch();return e?`rotateX(${e}deg)`:""}const s=e.cX(e.f6(r.transform,this._lngLat)),l=t.sub(e.f7(r.transform)),c=Math.abs(l.x)+Math.abs(l.y);if(0===c)return"";const h=s/c;return`rotateX(${-l.y*h}deg) rotateY(${l.x*h}deg)`}_calculateZTransform(){const t=this._pos,r=this._map;if(!r||!t)return"";let o=0;const s=this.getRotationAlignment();if("map"===s)if(r._showingGlobe()){const t=r.project(new e.aT(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),s=r.project(new e.aT(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(t);o=e.cX(Math.atan2(s.y,s.x))-90}else o=-r.getBearing();else if("horizon"===s){const s=e.ah(4,6,r.getZoom()),l=e.f7(r.transform);l.y+=s*r.transform.height;const c=t.sub(l),h=e.cX(Math.atan2(c.y,c.x));o=(h>90?h-270:h+90)*(1-s)}return o+=this._rotation,o?`rotateZ(${o}deg)`:""}_update(e){cancelAnimationFrame(this._updateFrameId);const t=this._map;t&&(t.transform.renderWorldCopies&&(this._lngLat=au(this._lngLat,this._pos,t.transform)),this._pos=t.project(this._lngLat,this._altitude),!0===e?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),t._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(t._showingGlobe()||t.getTerrain()||t.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=e.P.convert(t),this._update(),this}addClassName(e){return this._element.classList.add(e),this}removeClassName(e){return this._element.classList.remove(e),this}toggleClassName(e){return this._element.classList.toggle(e)}_onMove(t){const r=this._map;if(!r)return;const o=this._pointerdownPos,s=this._positionDelta;if(o&&s){if(!this._isDragging){const e=this._clickTolerance||r._clickTolerance;if(t.point.dist(o)<e)return;this._isDragging=!0}this._pos=t.point.sub(s),this._lngLat=r.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new e.z("dragstart"))),this.fire(new e.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new e.z("dragend")),this._state="inactive"}_addDragHandler(e){const t=this._map,r=this._pos;t&&r&&this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(r),this._pointerdownPos=e.point,this._state="pending",t.on("mousemove",this._onMove),t.on("touchmove",this._onMove),t.once("mouseup",this._onUp),t.once("touchend",this._onUp))}setDraggable(e){this._draggable=!!e;const t=this._map;return t&&(e?(t.on("mousedown",this._addDragHandler),t.on("touchstart",this._addDragHandler)):(t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||_u.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||_u.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e||_u.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(e){return this._occludedOpacity=e||_u.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const gu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1,showButton:!0,followUserLocation:!0},yu={maxWidth:100,unit:"metric"},xu={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},vu={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},bu=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function wu(t=new e.P(0,0),r="bottom"){if("number"==typeof t){const o=Math.round(Math.sqrt(.5*Math.pow(t,2)));switch(r){case"top":return new e.P(0,t);case"top-left":return new e.P(o,o);case"top-right":return new e.P(-o,o);case"bottom":return new e.P(0,-t);case"bottom-left":return new e.P(o,-o);case"bottom-right":return new e.P(-o,-o);case"left":return new e.P(t,0);case"right":return new e.P(-t,0)}return new e.P(0,0)}return t instanceof e.P||Array.isArray(t)?e.P.convert(t):e.P.convert(t[r]||[0,0])}const Tu={version:t,supported:h.supported,setRTLTextPlugin:e.fb,getRTLTextPluginStatus:e.fa,Map:class extends Ml{constructor(t){o.mark(r.create);const s=t;if(null!=(t=Object.assign({},nu,t)).minZoom&&null!=t.maxZoom&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=t.minPitch&&null!=t.maxPitch&&t.minPitch>t.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=t.minPitch&&t.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=t.maxPitch&&t.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(t.antialias&&e.f3(window)&&(t.antialias=!1,e.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new lo(t.minZoom,t.maxZoom,t.minPitch,t.maxPitch,t.renderWorldCopies,null,null),t),this._repaint=!!t.repaint,this._interactive=t.interactive,this._minTileCacheSize=t.minTileCacheSize,this._maxTileCacheSize=t.maxTileCacheSize,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=t.preserveDrawingBuffer,this._antialias=t.antialias,this._trackResize=t.trackResize,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles,this._fadeDuration=t.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=t.crossSourceCollisions,this._collectResourceTiming=t.collectResourceTiming,this._language=this._parseLanguage(t.language),this._worldview=t.worldview,this._renderTaskQueue=new kl,this._domRenderTaskQueue=new kl,this._controls=[],this._markers=[],this._popups=[],this._mapId=e.b2(),this._locale=Object.assign({},eu,t.locale),this._clickTolerance=t.clickTolerance,this._cooperativeGestures=t.cooperativeGestures,this._performanceMetricsCollection=t.performanceMetricsCollection,this._tessellationStep=t.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=t.precompilePrograms,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Nl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=t.scaleFactor,this._requestManager=new T(t.transformRequest,t.accessToken,t.testMode),this._silenceAuthErrors=!!t.testMode,this._contextCreateOptions=t.contextCreateOptions?Object.assign({},t.contextCreateOptions):{},"string"==typeof t.container){const e=document.getElementById(t.container);if(!e)throw new Error(`Container '${t.container.toString()}' not found.`);this._container=e}else{if(!(t.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container}if(this._container.childNodes.length>0&&e.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),t.maxBounds&&this.setMaxBounds(t.maxBounds),this._spriteFormat=t.spriteFormat,e.aY(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Ol(this,t),this._localFontFamily=t.localFontFamily,this._localIdeographFontFamily=t.localIdeographFontFamily,(t.style||!t.testMode)&&this.setStyle(t.style||e.e.DEFAULT_STYLE,{config:t.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),t.projection&&this.setProjection(t.projection),t.hash&&(this._hash=new za("string"==typeof t.hash&&t.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==s.center&&null==s.zoom||(this.transform._unmodified=!1),this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch});const e=t.bounds;e&&(this.resize(),this.fitBounds(e,Object.assign({},t.fitBoundsOptions,{duration:0})))}this.resize(),t.attributionControl&&this.addControl(new Fl({customAttribution:t.customAttribution})),this._logoControl=new Bl,this.addControl(this._logoControl,t.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent()})),this.on("data",(t=>{this._update("style"===t.dataType),this.fire(new e.z(`${t.dataType}data`,t))})),this.on("dataloading",(t=>{this.fire(new e.z(`${t.dataType}dataloading`,t))})),this._interactions=new Vl(this)}_getMapId(){return this._mapId}addControl(t,r){if(void 0===r&&(r=t.getDefaultPosition?t.getDefaultPosition():"top-right"),!t||!t.onAdd)return this.fire(new e.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const o=t.onAdd(this);this._controls.push(t);const s=this._controlPositions[r];return-1!==r.indexOf("bottom")?s.insertBefore(o,s.firstChild):s.appendChild(o),this}removeControl(t){if(!t||!t.onRemove)return this.fire(new e.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const r=this._controls.indexOf(t);return r>-1&&this._controls.splice(r,1),t.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(t){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const r=!this._moving;return r&&this.fire(new e.z("movestart",t)).fire(new e.z("move",t)),this.fire(new e.z("resize",t)),r&&this.fire(new e.z("moveend",t)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(t){return this.transform.setMaxBounds(e.aI.convert(t)),this._update()}setMinZoom(t){if((t=t??-2)>=-2&&t<=this.transform.maxZoom)return this.transform.minZoom=t,this._update(),this.getZoom()<t?this.setZoom(t):this.fire(new e.z("zoomstart")).fire(new e.z("zoom")).fire(new e.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(t){if((t=t??22)>=this.transform.minZoom)return this.transform.maxZoom=t,this._update(),this.getZoom()>t?this.setZoom(t):this.fire(new e.z("zoomstart")).fire(new e.z("zoom")).fire(new e.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(t){if((t=t??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(t>=0&&t<=this.transform.maxPitch)return this.transform.minPitch=t,this._update(),this.getPitch()<t?this.setPitch(t):this.fire(new e.z("pitchstart")).fire(new e.z("pitch")).fire(new e.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(t){if((t=t??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(t>=this.transform.minPitch)return this.transform.maxPitch=t,this._update(),this.getPitch()>t?this.setPitch(t):this.fire(new e.z("pitchstart")).fire(new e.z("pitch")).fire(new e.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(e){return this._scaleFactor=e,this.painter.scaleFactor=e,this.style&&this.style._setLabelPlacementStale(),this.style._updateFilteredLayers((e=>"symbol"===e.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return"auto"===e?navigator.language:Array.isArray(e)?0===e.length?void 0:e.map((e=>"auto"===e?navigator.language:e)):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const e of this._controls)e._setLanguage&&e._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(e){return this._lazyInitEmptyStyle(),e?"string"==typeof e&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const t=this.transform,r=t.projection.name;let o;"globe"===r&&t.zoom>=e.cL?(t.setMercatorFromTransition(),o=!0):"mercator"===r&&t.zoom<e.cL&&(t.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(t){let r;const o=this.transform.mercatorFromTransition;r="globe"===t.name&&this.transform.zoom>=e.cL?this.transform.setMercatorFromTransition():this.transform.setProjection(t),this.style.applyProjectionUpdate();const s="mercator"===this.transform.getProjection().name&&o!==this.transform.mercatorFromTransition;return(r||s)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(t,r){return this.transform.locationPoint3D(e.aT.convert(t),r)}unproject(t,r){return this.transform.pointLocation3D(e.P.convert(t),r)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,r){const o=e=>{let r=[];if(Array.isArray(t)){const o=t.filter((e=>this.getLayer(e)));r=o.length?this.queryRenderedFeatures(e,{layers:o}):[]}else r=this.queryRenderedFeatures(e,{target:t});return r};if("mouseenter"===e||"mouseover"===e){let s=!1;const l=t=>{const l=o(t.point);l.length?s||(s=!0,r.call(this,new Ha(e,this,t.originalEvent,{features:l}))):s=!1};return{listener:r,targets:t,delegates:{mousemove:l,mouseout:()=>{s=!1}}}}if("mouseleave"===e||"mouseout"===e){let s=!1;const l=t=>{o(t.point).length?s=!0:s&&(s=!1,r.call(this,new Ha(e,this,t.originalEvent)))},c=t=>{s&&(s=!1,r.call(this,new Ha(e,this,t.originalEvent)))};return{listener:r,targets:t,delegates:{mousemove:l,mouseout:c}}}{const s=e=>{const t=o(e.point);t.length&&(e.features=t,r.call(this,e),delete e.features)};return{listener:r,targets:t,delegates:{[e]:s}}}}on(e,t,r){if("function"==typeof t||void 0===r)return super.on(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const o=this._createDelegatedListener(e,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(o);for(const e in o.delegates)this.on(e,o.delegates[e]);return this}once(e,t,r){if("function"==typeof t||void 0===r)return super.once(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const o=this._createDelegatedListener(e,t,r);for(const e in o.delegates)this.once(e,o.delegates[e]);return this}off(e,t,r){if("function"==typeof t||void 0===r)return super.off(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const o=this._delegatedListeners?this._delegatedListeners[e]:void 0;return o&&(e=>{for(let o=0;o<e.length;o++){const s=e[o];if(s.listener===r&&iu(s.targets,t)){for(const e in s.delegates)this.off(e,s.delegates[e]);return e.splice(o,1),this}}})(o),this}queryRenderedFeatures(t,r){if(!this.style)return[];if(void 0===t||t instanceof e.P||Array.isArray(t)||void 0!==r||(r=t,t=void 0),t=t||[[0,0],[this.transform.width,this.transform.height]],!r){const e=this.style.queryRenderedFeatures(t,void 0,this.transform),r=this.style.queryRenderedFeatureset(t,void 0,this.transform);return e.concat(r)}let o=!0;if(r.target&&(o=this._isTargetValid(r.target),o&&!r.layers))return this.style.queryRenderedFeatureset(t,r,this.transform);let s=!0;if(r.layers&&Array.isArray(r.layers)){for(const e of r.layers)if(!this._isValidId(e)){s=!1;break}if(s&&!r.target)return this.style.queryRenderedFeatures(t,r,this.transform)}let l=[];return s&&(l=l.concat(this.style.queryRenderedFeatures(t,r,this.transform))),o&&(l=l.concat(this.style.queryRenderedFeatureset(t,r,this.transform))),l}querySourceFeatures(e,t){return!e||"string"==typeof e&&!this._isValidId(e)?[]:this.style.querySourceFeatures(e,t)}queryRasterValue(e,t,r){return this._isValidId(e)?this.style.queryRasterValue(e,t,r):Promise.resolve(null)}isPointOnSurface(t){const{name:r}=this.transform.projection;return"globe"!==r&&"mercator"!==r&&e.w(`${r} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(e.P.convert(t))}addInteraction(e,t){return this._interactions.add(e,t),this}removeInteraction(e){return this._interactions.remove(e),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(e){return this._cooperativeGestures=e,this}setStyle(t,r){return r=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},r),this.style&&t&&!1!==r.diff&&r.localFontFamily===this._localFontFamily&&r.localIdeographFontFamily===this._localIdeographFontFamily&&!r.config?(this.style._diffStyle(t,((o,s)=>{if(o){const s="string"==typeof o?o:o instanceof Error?o.message:o.error;e.w(`Unable to perform style diff: ${s}. Rebuilding the style from scratch.`),this._updateStyle(t,r)}else s&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._localFontFamily=r.localFontFamily,this._updateStyle(t,r))}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e){const r=Object.assign({},t);t&&t.config&&(r.initialConfig=t.config,delete r.config),this.style=new Oo(this,r).load(e),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Oo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(e.w("There is no style added to the map."),!1)}_isValidId(t){return null==t?(this.fire(new e.y(new Error("IDs can't be empty."))),!1):!e.dr(t)||(this.fire(new e.y(new Error(`IDs can't contain special symbols: "${t}".`))),!1)}_isTargetValid(e){return"featuresetId"in e?this._isValidId("importId"in e?e.importId:e.featuresetId):"layerId"in e&&this._isValidId(e.layerId)}_areTargetsValid(e){if(Array.isArray(e)){for(const t of e)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(e)}addSource(e,t){return this._isValidId(e)?(this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)):this}isSourceLoaded(e){return!!this._isValidId(e)&&!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(e,t,r){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,r)}removeSource(e){return this._isValidId(e)?(this.style.removeSource(e),this._updateTerrain(),this._update(!0)):this}getSource(e){return this._isValidId(e)?this.style.getOwnSource(e):null}addImage(t,r,{pixelRatio:o=1,sdf:s=!1,stretchX:l,stretchY:c,content:h}={}){this._lazyInitEmptyStyle();const u=e.I.from(t);if(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap){const{width:t,height:d,data:p}=e.o.getImageData(r);this.style.addImage(u,{data:new e.q({width:t,height:d},p),pixelRatio:o,stretchX:l,stretchY:c,content:h,sdf:s,version:0,usvg:!1})}else if(void 0===r.width||void 0===r.height)this.fire(new e.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:d,height:p}=r,f=r;this.style.addImage(u,{data:new e.q({width:d,height:p},new Uint8Array(f.data)),pixelRatio:o,stretchX:l,stretchY:c,content:h,sdf:s,usvg:!1,version:0,userImage:f}),f.onAdd&&f.onAdd(this,t)}}updateImage(t,r){this._lazyInitEmptyStyle();const o=e.I.from(t),s=this.style.getImage(o);if(!s)return void this.fire(new e.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const l=r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap?e.o.getImageData(r):r,{width:c,height:h,data:u}=l;if(void 0===c||void 0===h)return void this.fire(new e.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(c!==(s.usvg?s.icon.usvg_tree.width:s.data.width)||h!==(s.usvg?s.icon.usvg_tree.height:s.data.height))return void this.fire(new e.y(new Error(`The width and height of the updated image (${c}, ${h})\n                must be that same as the previous version of the image\n                (${s.data.width}, ${s.data.height})`)));const d=!(r instanceof HTMLImageElement||ImageBitmap&&r instanceof ImageBitmap);let p=!1;s.usvg?(s.data=new e.q({width:c,height:h},new Uint8Array(u)),s.usvg=!1,s.icon=void 0,p=!0):s.data.replace(u,d),this.style.updateImage(o,s,p)}hasImage(t){return t?!!this.style&&!!this.style.getImage(e.I.from(t)):(this.fire(new e.y(new Error("Missing required image id"))),!1)}removeImage(t){this.style.removeImage(e.I.from(t))}loadImage(t,r){e.n(this._requestManager.transformRequest(t,e.R.Image),((t,o)=>{r(t,o instanceof HTMLImageElement?e.o.getImageData(o):o)}))}listImages(){return this.style.listImages().map((e=>e.name))}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(t){return t?this.style.hasModel(t):(this.fire(new e.y(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._isValidId(e.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)):this}getSlot(e){const t=this.getLayer(e);return t&&t.slot||null}setSlot(e,t){return this.style.setSlot(e,t),this.style.mergeLayers(),this._update(!0)}addImport(t,r){return this.style.addImport(t,r).catch((t=>this.fire(new e.y(new Error("Failed to add import",t))))),this}updateImport(e,t){return"string"!=typeof t&&t.id!==e?(this.removeImport(e),this.addImport(t)):(this.style.updateImport(e,t),this._update(!0))}removeImport(e){return this.style.removeImport(e),this}moveImport(e,t){return this.style.moveImport(e,t),this._update(!0)}moveLayer(e,t){return this._isValidId(e)?(this.style.moveLayer(e,t),this._update(!0)):this}removeLayer(e){return this._isValidId(e)?(this.style.removeLayer(e),this._update(!0)):this}getLayer(e){if(!this._isValidId(e))return null;const t=this.style.getOwnLayer(e);return t?"custom"===t.type?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(e,t,r){return this._isValidId(e)?(this.style.setLayerZoomRange(e,t,r),this._update(!0)):this}setFilter(e,t,r={}){return this._isValidId(e)?(this.style.setFilter(e,t,r),this._update(!0)):this}getFilter(e){return this._isValidId(e)?this.style.getFilter(e):null}setPaintProperty(e,t,r,o={}){return this._isValidId(e)?(this.style.setPaintProperty(e,t,r,o),this._update(!0)):this}getPaintProperty(e,t){return this._isValidId(e)?this.style.getPaintProperty(e,t):null}setLayoutProperty(e,t,r,o={}){return this._isValidId(e)?(this.style.setLayoutProperty(e,t,r,o),this._update(!0)):this}getLayoutProperty(e,t){return this._isValidId(e)?this.style.getLayoutProperty(e,t):null}setLayerProperty(e,t,r,o={}){return this._isValidId(e)?("appearances"===t&&this._postAddingAppearancesToStyleEvent(),this.style.setLayerProperty(e,t,r,o),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(e){return this.style.setGlyphsUrl(e),this._update(!0)}getSchema(e){return this.style.getSchema(e)}setSchema(e,t){return this.style.setSchema(e,t),this._update(!0)}getConfig(e){return this.style.getConfig(e)}setConfig(e,t){return this.style.setConfig(e,t),this._update(!0)}getConfigProperty(e,t){return this.style.getConfigProperty(e,t)}setConfigProperty(e,t,r){return this.style.setConfigProperty(e,t,r),this._update(!0)}getFeaturesetDescriptors(e){return this.style.getFeaturesetDescriptors(e)}setLights(e){if(this._lazyInitEmptyStyle(),e&&1===e.length&&"flat"===e[0].type){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return 0===e.length&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}setLight(e,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(e){return this._lazyInitEmptyStyle(),this.style.setSnow(e),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(e){return this._lazyInitEmptyStyle(),this.style.setRain(e),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(e){return this._lazyInitEmptyStyle(),this.style.setColorTheme(e),this._update(!0)}setImportColorTheme(e,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(e,t),this._update(!0)}setCamera(e){return this.style.setCamera(e),this._triggerCameraUpdate(e)}_triggerCameraUpdate(e){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===e["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(t){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(e.aT.convert(t),this.transform):0}setFeatureState(e,t){return e.source&&!this._isValidId(e.source)?this:(this.style.setFeatureState(e,t),this._update())}removeFeatureState(e,t){return e.source&&!this._isValidId(e.source)?this:(this.style.removeFeatureState(e,t),this._update())}getFeatureState(e){return e.source&&!this._isValidId(e.source)?null:this.style.getFeatureState(e)}_selectIndoorFloor(e){this.style.indoorManager.selectFloor(e)}_setIndoorActiveFloorsVisibility(e){this.style.indoorManager.setActiveFloorsVisibility(e)}getIndoorTileOptions(e,t){return this.style.isIndoorEnabled()?this.style.indoorManager.getIndoorTileOptions(e,t):null}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let r,o,s,l=this._container;for(;l&&(!o||!s);){const e=window.getComputedStyle(l).transform;e&&"none"!==e&&(r=e.match(/matrix.*\((.+)\)/)[1].split(", "),r[0]&&"0"!==r[0]&&"1"!==r[0]&&(o=r[0]),r[3]&&"0"!==r[3]&&"1"!==r[3]&&(s=r[3])),l=l.parentElement}this._containerWidth=o?Math.abs(e/o):e,this._containerHeight=s?Math.abs(t/s):t}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&e.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=u("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=u("div","mapboxgl-canvas-container",e);this._canvas=u("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const r=this._controlContainer=u("div","mapboxgl-control-container",e),o=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((e=>{o[e]=u("div",`mapboxgl-ctrl-${e}`,r)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(t,r){const o=e.o.devicePixelRatio||1;this._canvas.width=o*Math.ceil(t),this._canvas.height=o*Math.ceil(r),this._canvas.style.width=`${t}px`,this._canvas.style.height=`${r}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);-1!==t&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);-1!==t&&this._popups.splice(t,1)}_setupPainter(){const t=Object.assign({},h.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),r=this._canvas.getContext("webgl2",t);r?(se(r,!0),this.painter=new Pa(r,this._contextCreateOptions,this.transform,this._scaleFactor,this._worldview),this.on("data",(e=>{if("source"===e.dataType){const t=this.transform.elevation?this.transform.elevation._source():null;t&&e.sourceCacheId===t.id&&this.style&&this.style._setLabelPlacementStale(),this.painter.setTileLoadedFlag(!0)}})),e.k.testSupport(r)):this.fire(new e.y(new Error("Failed to initialize WebGL")))}_contextLost(t){t.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new e.z("webglcontextlost",{originalEvent:t}))}_contextRestored(t){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new e.z("webglcontextrestored",{originalEvent:t}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(t){let s;this.fire(new e.z("renderstart")),++this._frameId;const l=this.painter.context.extTimerQuery,c=e.o.now(),h=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(s=h.createQuery(),h.beginQuery(l.TIME_ELAPSED_EXT,s)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(t),this._domRenderTaskQueue.run(t),this._removed)return;this._updateProjectionTransition();const u=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const t=this.transform.zoom,r=this.transform.pitch,o=e.o.now(),s=new e.ac(t,{now:o,fadeDuration:u,pitch:r,transition:this.style.transition,worldview:this._worldview});this.style.update(s)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let d=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),d=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):d=this._updateAverageElevation(c),this.style&&(this._placementDirty=this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,u,this._crossSourceCollisions,this.painter.replacementSource)),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:u,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new e.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,o.mark(r.load),this.fire(new e.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),s){const t=e.o.now()-c;h.endQuery(l.TIME_ELAPSED_EXT),setTimeout((()=>{const r=h.getQueryParameter(s,h.QUERY_RESULT)/1e6;h.deleteQuery(s),this.fire(new e.z("gpu-timing-frame",{cpuTime:t,gpuTime:r}))}),50)}if(this.listens("gpu-timing-layer")){const t=this.painter.collectGpuTimers();setTimeout((()=>{const r=this.painter.queryGpuTimers(t);this.fire(new e.z("gpu-timing-layer",{layerTimes:r}))}),50)}if(this.listens("gpu-timing-deferred-render")){const t=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const r=this.painter.queryGpuTimeDeferredRender(t);this.fire(new e.z("gpu-timing-deferred-render",{gpuTime:r}))}),50)}const p=this._sourcesDirty||this._styleDirty||this._placementDirty||d;if(p||this._repaint)this.triggerRepaint();else{const t=this.idle();if(t&&(d=this._updateAverageElevation(c,!0)),d)this.triggerRepaint();else if(this._triggerFrame(!1),t&&(this.fire(new e.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const t=this._calculateSpeedIndex();this.fire(new e.z("speedindexcompleted",{speedIndex:t})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||p||(this._fullyLoaded=!0,o.mark(r.fullLoad),this._performanceMetricsCollection&&ie(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const r=e=>(this.transform.averageElevation=e,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&r(0);const o=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(o||(t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const t=this.transform.averageElevation;let s=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(s)?s=0:this._averageElevationLastSampledAt=e;const l=Math.abs(t-s);if(l>1){if(this._isInitialLoad||o)return this._averageElevation.jumpTo(s),r(s);this._averageElevation.easeTo(s,e,300)}else if(l>1e-4)return this._averageElevation.jumpTo(s),r(s)}return!!this._averageElevation.isEasing(e)&&r(this._averageElevation.getValue(e))}_authenticate(){ne(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(t=>{if(t&&(t.message===F||401===t.status)){const t=this.painter.context.gl;se(t,!1),this._logoControl instanceof Bl&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new e.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),H(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&Y(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&Q(this._requestManager._customAccessToken)}_postAddingAppearancesToStyleEvent(){ee(this._requestManager._customAccessToken)}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const r=this.painter.context.gl,o=r.createFramebuffer();function s(e){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0);const t=new Uint8Array(r.drawingBufferWidth*r.drawingBufferHeight*4);return r.readPixels(0,0,r.drawingBufferWidth,r.drawingBufferHeight,r.RGBA,r.UNSIGNED_BYTE,t),t}return r.bindFramebuffer(r.FRAMEBUFFER,o),this._canvasPixelComparison(s(e),t.canvasCopies.map(s),t.timeStamps)}_canvasPixelComparison(e,t,r){let o=r[1]-r[0];const s=e.length/4;for(let l=0;l<t.length;l++){const c=t[l];let h=0;for(let t=0;t<c.length;t+=4)c[t]===e[t]&&c[t+1]===e[t+1]&&c[t+2]===e[t+2]&&c[t+3]===e[t+3]&&(h+=1);o+=(r[l+2]-r[l+1])*(1-h/s)}return o}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),oe.delete(this.painter.context.gl),re.remove(),q.remove(),this._removed=!0,this.fire(new e.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(t){this._renderNextFrame=this._renderNextFrame||t,this.style&&!this._frame&&(this._frame=e.o.frame((e=>{const t=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,t&&this._render(e)})))}_preloadTiles(t){const r=this.style?this.style.getSourceCaches():[];return e.bw(r,((e,r)=>e._preloadTiles(t,r)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(e){this._showParseStatus!==e&&(this._showParseStatus=e,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,this.style&&e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,e&&this._update())}_setCacheLimits(t,r){e.f4(t,r)}get version(){return t}},NavigationControl:class{constructor(t={}){this.options=Object.assign({},ou,t),this._container=u("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this.options.showZoom&&(e.aY(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(e=>{this._map&&this._map.zoomIn({},{originalEvent:e})})),u("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(e=>{this._map&&this._map.zoomOut({},{originalEvent:e})})),u("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(e.aY(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(e=>{const t=this._map;t&&(this.options.visualizePitch?t.resetNorthPitch({},{originalEvent:e}):t.resetNorth({},{originalEvent:e}))})),this._compassIcon=u("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),r=t===e.getMaxZoom(),o=t===e.getMinZoom();this._zoomInButton.disabled=r,this._zoomOutButton.disabled=o,this._zoomInButton.setAttribute("aria-disabled",r.toString()),this._zoomOutButton.setAttribute("aria-disabled",o.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Zl(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const r=u("button",e,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(e,t){if(!this._map)return;const r=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",r),e.firstElementChild&&e.firstElementChild.setAttribute("title",r)}},GeolocateControl:class extends e.E{constructor(t={}){super();const r=navigator.geolocation;this.options=Object.assign({geolocation:r},gu,t),e.aY(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ih(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=u("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._clearRequestTimeout(),void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(t=!!this.options.geolocation)=>{this._supportsGeolocation=t,e(t)};void 0!==this._supportsGeolocation?e(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((e=>t("denied"!==e.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),r=e.coords;return!!t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(t){if(this._map){if(this._clearRequestTimeout(),this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new e.z("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this.options.followUserLocation?(this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active")):(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"));break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(t),this.options.followUserLocation&&(!this.options.trackUserLocation||"ACTIVE_LOCK"===this._watchState)&&this._updateCamera(t),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new e.z("geolocate",Object.assign({coords:t.coords,timestamp:t.timestamp},t.toJSON?{toJSON:t.toJSON.bind(t)}:{}))),this._finish()}}_updateCamera(t){const r=new e.aT(t.coords.longitude,t.coords.latitude),o=t.coords.accuracy,s=this._map.getBearing(),l=Object.assign({bearing:s},this.options.fitBoundsOptions);this._map.fitBounds(r.toBounds(o),l,{geolocateSource:!0})}_updateMarker(t){if(t){const r=new e.aT(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(r).addTo(this._map),this._userLocationDotMarker.setLngLat(r).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const t=this._map.transform,r=e.cf(1,t._center.lat)*t.worldSize,o=Math.ceil(2*this._accuracy*r);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(t){if(this._map){if(this._clearRequestTimeout(),this.options.trackUserLocation)if(1===t.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===t.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new e.z("error",{code:t.code,message:t.message,PERMISSION_DENIED:t.PERMISSION_DENIED,POSITION_UNAVAILABLE:t.POSITION_UNAVAILABLE,TIMEOUT:t.TIMEOUT})),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_startRequestTimeout(){this._clearRequestTimeout();const e=this.options.positionOptions.timeout;e&&(this._requestTimeoutId=window.setTimeout((()=>{this._onError({code:3,message:"Geolocation request timed out"})}),e))}_clearRequestTimeout(){void 0!==this._requestTimeoutId&&(clearTimeout(this._requestTimeoutId),this._requestTimeoutId=void 0)}_setupUI(t){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this._geolocateButton=u("button","mapboxgl-ctrl-geolocate",this._container),u("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===t){e.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=u("div","mapboxgl-user-location"),this._dotElement.appendChild(u("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(u("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Yl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=u("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Yl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.showButton||(this._container.style.display="none"),this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new e.z("trackuserlocationend")))}))}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:!0===e.absolute&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return e.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new e.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new e.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this._startRequestTimeout(),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._startRequestTimeout(),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}setFollowUserLocation(t){return this.options.followUserLocation=null!=t?t:gu.followUserLocation,this.options.trackUserLocation&&"OFF"!==this._watchState&&(this.options.followUserLocation?"BACKGROUND"!==this._watchState&&"BACKGROUND_ERROR"!==this._watchState||(this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.z("trackuserlocationstart"))):"ACTIVE_LOCK"!==this._watchState&&"ACTIVE_ERROR"!==this._watchState||(this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this.fire(new e.z("trackuserlocationend")))),this}_addDeviceOrientationListener(){const e=()=>{const e="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation";window.addEventListener(e,this._onDeviceOrientation)};"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t&&e()})).catch(console.error):e()}_clearWatch(){this._clearRequestTimeout(),this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Fl,ScaleControl:class{constructor(t={}){this.options=Object.assign({},yu,t),e.aY(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,r=t._containerHeight/2,o=t._containerWidth/2-e/2,s=t.unproject([o,r]),l=t.unproject([o+e,r]),c=s.distanceTo(l);if("imperial"===this.options.unit){const t=3.2808*c;t>5280?this._setScale(e,t/5280,"mile"):this._setScale(e,t,"foot")}else"nautical"===this.options.unit?this._setScale(e,c/1852,"nautical-mile"):c>=1e3?this._setScale(e,c/1e3,"kilometer"):this._setScale(e,c,"meter")}_setScale(e,t,r){this._map._requestDomTask((()=>{const o=function(e){const t=Math.pow(10,`${Math.floor(e)}`.length-1);let r=e/t;return r=r>=10?10:r>=5?5:r>=3?3:r>=2?2:r>=1?1:function(e){const t=Math.pow(10,Math.ceil(-Math.log(e)/Math.LN10));return Math.round(e*t)/t}(r),t*r}(t),s=o/t;this._container.innerHTML="nautical-mile"!==r?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:r}).format(o):`${o}&nbsp;${xu[r]}`,this._container.style.width=e*s+"px"}))}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=u("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(t={}){this._fullscreen=!1,t&&t.container&&(t.container instanceof HTMLElement?this._container=t.container:e.w("Full screen control 'container' must be a DOM element.")),e.aY(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(t){return this._map=t,this._container||(this._container=this._map.getContainer()),this._controlContainer=u("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",e.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=u("button","mapboxgl-ctrl-fullscreen",this._controlContainer);u("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:So,Popup:class extends e.E{constructor(t){super(),this.options=Object.assign(Object.create(vu),t),this._altitude=this.options.altitude,e.aY(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(t&&t.className?t.className.trim().split(/\s+/):[])}addTo(t){return this._map&&this.remove(),this._map=t,this.options.closeOnClick&&t.on("preclick",this._onClose),this.options.closeOnMove&&t.on("move",this._onClose),t.on("remove",this.remove),this._update(),t._addPopup(this),this._focusFirstElement(),this._trackPointer?(t.on("mousemove",this._onMouseEvent),t.on("mouseup",this._onMouseEvent),t._canvasContainer.classList.add("mapboxgl-track-pointer")):t.on("move",this._update),this.fire(new e.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const t=this._map;return t&&(t.off("move",this._update),t.off("move",this._onClose),t.off("preclick",this._onClose),t.off("click",this._onClose),t.off("remove",this.remove),t.off("mousemove",this._onMouseEvent),t.off("mouseup",this._onMouseEvent),t.off("drag",this._onMouseEvent),t._canvasContainer&&t._canvasContainer.classList.remove("mapboxgl-track-pointer"),t._removePopup(this),this._map=void 0),this.fire(new e.z("close")),this}getLngLat(){return this._lngLat}setLngLat(t){this._lngLat=e.aT.convert(t),this._pos=null,this._trackPointer=!1,this._update();const r=this._map;return r&&(r.on("move",this._update),r.off("mousemove",this._onMouseEvent),r._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(e){return this._altitude=e,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(document.createTextNode(e))}setHTML(e){const t=document.createDocumentFragment(),r=document.createElement("body");let o;for(r.innerHTML=e;o=r.firstChild,o;)t.appendChild(o);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=u("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const e=this._closeButton=u("button","mapboxgl-popup-close-button",t);e.type="button",e.setAttribute("aria-label","Close popup"),e.innerHTML='<span aria-hidden="true">&#215;</span>',e.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,r=this._container,o=this._pos;if(!t||!r||!o)return"bottom";const s=r.offsetWidth,l=r.offsetHeight,c=o.x<s/2,h=o.x>t.transform.width-s/2;if(o.y+e<l)return c?"top-left":h?"top-right":"top";if(o.y>t.transform.height-l){if(c)return"bottom-left";if(h)return"bottom-right"}return c?"left":h?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(t){const r=this._map,o=this._content;if(!r||!this._lngLat&&!this._trackPointer||!o)return;let s=this._container;if(s||(s=this._container=u("div","mapboxgl-popup",r.getContainer()),this._tip=u("div","mapboxgl-popup-tip",s),s.appendChild(o)),this.options.maxWidth&&s.style.maxWidth!==this.options.maxWidth&&(s.style.maxWidth=this.options.maxWidth),r.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=au(this._lngLat,this._pos,r.transform)),!this._trackPointer||t){const o=this._pos=this._trackPointer&&t instanceof e.P?t:r.project(this._lngLat,this._altitude),s=wu(this.options.offset),l=this._anchor=this._getAnchor(s.y),c=wu(this.options.offset,l),h=o.add(c).round();r._requestDomTask((()=>{this._container&&l&&(this._container.style.transform=`${mu[l]} translate(${h.x}px,${h.y}px)`)}))}if(!this._marker&&r._showingGlobe()){const t=e.f5(r.transform,this._lngLat)?0:1;this._setOpacity(t)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(bu);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:Yl,Style:Oo,LngLat:e.aT,LngLatBounds:e.aI,Point:e.P,MercatorCoordinate:e.ae,FreeCameraOptions:oo,Evented:e.E,config:e.e,prewarm:e.f9,clearPrewarmedResources:e.f8,get accessToken(){return e.e.ACCESS_TOKEN},set accessToken(t){e.e.ACCESS_TOKEN=t},get baseApiUrl(){return e.e.API_URL},set baseApiUrl(t){e.e.API_URL=t},get workerCount(){return e.fi.workerCount},set workerCount(t){e.fi.workerCount=t},get maxParallelImageRequests(){return e.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(t){e.e.MAX_PARALLEL_IMAGE_REQUESTS=t},clearStorage(t){e.fh(t)},get workerUrl(){return e.fg.workerUrl},set workerUrl(t){e.fg.workerUrl=t},get workerClass(){return e.fg.workerClass},set workerClass(t){e.fg.workerClass=t},get workerParams(){return e.fg.workerParams},set workerParams(t){e.fg.workerParams=t},get dracoUrl(){return e.ff()},set dracoUrl(t){e.fe(t)},get meshoptUrl(){return e.fd()},set meshoptUrl(t){e.fc(t)},setNow:e.o.setNow,restoreNow:e.o.restoreNow};return Tu}));var l=o;return l}));var r=t;export{r as default};

