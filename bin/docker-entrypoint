#!/bin/bash -e

# If running the rails server (either directly or via Thruster)
if [ "${1}" == "./bin/thrust" ] || ([ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]); then
  
  # Safety check to prove the URL is making it to the server
  if [ -z "$DATABASE_URL" ]; then
    echo "âŒ FATAL: DATABASE_URL is missing from Render Environment tab!"
  else
    echo "âœ… DATABASE_URL is detected."
  fi

  echo "âš™ï¸ Compiling assets for production..."
  ./bin/rails assets:precompile
  
  echo "ğŸ—„ï¸ Running database migrations..."
  # CHANGED: Use migrate instead of prepare to bypass Render permission bugs
  ./bin/rails db:migrate

fi

exec "${@}"