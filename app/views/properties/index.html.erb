<div class="w-full h-full absolute inset-0"
     data-controller="map"
     data-map-api-key-value="<%= Rails.application.credentials.dig(:mapbox, :public_key) %>"
     data-map-properties-value='<%= {
       type: "FeatureCollection",
       features: @properties.map { |p| 
         {
           type: "Feature",
           properties: {
             id: p.id,
             address: p.address,
             usage_type: p.usage_type,
             notes: p.notes,
             
             # --- NEW PHASE 2 DATA ---
             owner: p.owner || "Unknown Owner",
             year_built: p.year_built || "Unknown",
             sale_price: p.sale_price ? number_to_currency(p.sale_price, precision: 0) : "N/A",
             sale_date: p.sale_date ? p.sale_date.strftime("%b %d, %Y") : "Unknown",
             
             # Safely grab the photo URL if it exists
             photo_url: p.photo.attached? ? rails_blob_path(p.photo, only_path: true) : nil,
             
             # Bundle up the tickets into a lightweight array
             tickets: p.tickets.map do |ticket|
               {
                 id: ticket.id,
                 title: ticket.title,
                 status: ticket.status,
                 date: ticket.created_at.strftime("%b %d")
               }
             end
           },
           geometry: RGeo::GeoJSON.encode(p.boundary)
         }
       }
     }.to_json %>'></div>

<div id="property_editor_card" class="fixed bottom-0 left-0 right-0 z-[100] bg-white p-5 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transition-transform duration-300 transform translate-y-full w-full max-h-[85dvh] flex flex-col">

  <div class="flex justify-between items-center mb-4 border-b pb-3 shrink-0">
    <h2 id="form_address" class="text-xl font-bold text-gray-800 truncate">Property Address</h2>
    <button type="button" onclick="closePropertyCard()" class="bg-gray-200 text-gray-600 rounded-full p-2 hover:bg-gray-300 shrink-0 ml-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
  </div>

  <div class="overflow-y-auto flex-1 pb-4">
    
    <div id="view_main" class="space-y-5">
      
      <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100 shadow-inner text-sm">
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Owner</span><span id="stat_owner" class="font-medium text-gray-800 truncate block"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Sale Price</span><span id="stat_price" class="font-medium text-gray-800"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Sale Date</span><span id="stat_date" class="font-medium text-gray-800"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Year Built</span><span id="stat_year" class="font-medium text-gray-800"></span></div>
      </div>

      <div id="photo_container" class="hidden">
        <img id="display_photo" src="" class="w-full h-48 object-cover rounded-xl shadow-sm border border-gray-200">
      </div>

  <%= form_with(url: "", id: "property_form", method: :patch, html: { multipart: true }, class: "space-y-4 border-b border-gray-200 pb-5", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Usage Type</label>
            <select name="property[usage_type]" id="form_usage_type" class="w-full rounded-lg border-gray-300 bg-gray-50 p-2.5 text-sm shadow-sm">
              <option value="Residential">Residential</option>
              <option value="Commercial">Commercial</option>
              <option value="Mixed-Use">Mixed-Use</option>
              <option value="Vacant">Vacant</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Replace Photo</label>
            <input type="file" name="property[photo]" id="form_photo" accept="image/*" capture="environment" class="w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700" />
          </div>
        </div>
        
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Field Notes</label>
          <textarea name="property[notes]" id="form_notes" rows="2" class="w-full rounded-lg border-gray-300 bg-gray-50 p-2.5 text-sm shadow-sm" placeholder="Enter notes here..."></textarea>
        </div>
        
        <button type="submit" class="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold shadow-sm hover:bg-gray-900 text-sm">
          Update Property Info
        </button>
      <% end %>

      <div>
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-bold text-gray-800">Active Tickets</h3>
          <button type="button" onclick="toggleViews('view_ticket')" class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-100 transition-colors">+ New Ticket</button>
        </div>
        <ul id="tickets_list" class="space-y-2">
          </ul>
      </div>
    </div>

    <div id="view_ticket" class="hidden space-y-4">
      <button type="button" onclick="toggleViews('view_main')" class="text-blue-600 text-sm font-semibold flex items-center mb-2">
        &larr; Back to Property
      </button>
      <h3 class="font-bold text-lg text-gray-800">Report an Issue</h3>
      
      <%= form_with(url: "", id: "ticket_form", method: :post, class: "space-y-4") do |f| %>
        <input type="hidden" name="ticket[property_id]" id="ticket_property_id">
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Issue Title</label>
          <input type="text" name="ticket[title]" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Broken Window, High Grass" required>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Initial Note</label>
          <textarea name="ticket_note[body]" rows="3" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Provide details..."></textarea>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Evidence Photos (Multiple)</label>
          <input type="file" name="ticket[photos][]" multiple accept="image/*" capture="environment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700" />
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all">
          Create Ticket
        </button>
      <% end %>
    </div>

  </div>
</div>

<script>
  function closePropertyCard() {
    document.getElementById('property_editor_card').classList.add('translate-y-full');
  }
  function toggleViews(viewId) {
    document.getElementById('view_main').classList.add('hidden');
    document.getElementById('view_ticket').classList.add('hidden');
    document.getElementById(viewId).classList.remove('hidden');
  }
</script>