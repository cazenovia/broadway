<div class="w-full h-full absolute inset-0"
     data-controller="map"
     data-map-api-key-value="<%= Rails.application.credentials.dig(:mapbox, :public_key) %>"
     data-map-properties-value='<%= {
       type: "FeatureCollection",
       features: @properties.map { |p| 
         {
           type: "Feature",
           properties: {
             id: p.id,
             address: p.address,
             usage_type: p.usage_type,
             notes: p.notes,
             
             # --- NEW PHASE 2 DATA ---
             owner: p.owner || "Unknown Owner",
             year_built: p.year_built || "Unknown",
             sale_price: p.sale_price ? number_to_currency(p.sale_price, precision: 0) : "N/A",
             sale_date: p.sale_date ? p.sale_date.strftime("%b %d, %Y") : "Unknown",
             
             # Safely grab the photo URL if it exists
             photo_url: p.photo.attached? ? rails_storage_proxy_path(p.photo, only_path: true) : nil,
             
             # Bundle up the tickets into a lightweight array WITH notes and photos!
             tickets: p.tickets.map do |ticket|
               {
                 id: ticket.id,
                 author: ticket.user&.email&.split('@')&.first&.capitalize || "Unknown",
                 title: ticket.title,
                 status: ticket.status,
                 date: ticket.created_at.strftime("%b %d"),
                 photos: ticket.photos.attached? ? ticket.photos.map { |photo| rails_storage_proxy_path(photo, only_path: true) } : [],
                 notes: ticket.ticket_notes.order(created_at: :asc).map do |note|
                   {
                     body: note.body,
                     date: note.created_at.strftime("%b %d, %I:%M %p")
                   }
                 end
               }
             end,

             # Bundle up the contacts for the new tab!
             contacts: p.contacts.order(contact_date: :desc).map do |contact|
               {
                 id: contact.id,
                 display_date: contact.contact_date&.strftime("%b %d, %Y") || "Unknown Date",
                 person: contact.contact_person,
                 role: contact.contact_person_role,
                 method: contact.contact_method,
                 summary: contact.contact_summary,
                 author: contact.user&.email&.split('@')&.first&.capitalize || "Unknown"
               }
             end
           },
           geometry: RGeo::GeoJSON.encode(p.boundary)
         }
       }
     }.to_json %>'></div>

<div id="property_editor_card" class="fixed bottom-0 left-0 right-0 md:left-1/2 md:right-auto md:-translate-x-1/2 w-full md:max-w-4xl z-[100] bg-white p-5 md:p-7 rounded-t-3xl md:rounded-t-[2rem] shadow-[0_-20px_60px_rgba(0,0,0,0.15)] transition-transform duration-300 transform translate-y-full h-[85dvh] flex flex-col">

  <div class="flex justify-between items-center mb-2 shrink-0">
    <h2 id="form_address" class="text-2xl font-black text-gray-800 truncate tracking-tight">Property Address</h2>
    <button type="button" onclick="closePropertyCard()" class="bg-gray-100 text-gray-600 rounded-full p-2 hover:bg-gray-200 shrink-0 ml-2 transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
  </div>

  <div class="flex space-x-6 mb-5 border-b border-gray-200 shrink-0">
    <button id="tab_info" onclick="switchTab('info')" class="pb-3 border-b-2 border-blue-600 text-blue-600 font-bold text-sm transition-colors">Property Info</button>
    <button id="tab_tickets" onclick="switchTab('tickets')" class="pb-3 border-b-2 border-transparent text-gray-500 font-medium text-sm transition-colors hover:text-gray-800">Tickets (<span id="ticket_count">0</span>)</button>
    <button id="tab_contacts" onclick="switchTab('contacts')" class="pb-3 border-b-2 border-transparent text-gray-500 font-medium text-sm transition-colors hover:text-gray-800">Contacts (<span id="contact_count">0</span>)</button>
  </div>

  <div class="overflow-y-auto flex-1 pb-6 pr-2 custom-scrollbar">
    
    <div id="view_info" class="space-y-6">
      <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm text-sm">
        <div><span class="text-slate-400 text-[10px] uppercase font-bold tracking-wider block mb-0.5">Owner</span><span id="stat_owner" class="font-semibold text-slate-800 truncate block"></span></div>
        <div><span class="text-slate-400 text-[10px] uppercase font-bold tracking-wider block mb-0.5">Sale Price</span><span id="stat_price" class="font-semibold text-slate-800"></span></div>
        <div><span class="text-slate-400 text-[10px] uppercase font-bold tracking-wider block mb-0.5">Sale Date</span><span id="stat_date" class="font-semibold text-slate-800"></span></div>
        <div><span class="text-slate-400 text-[10px] uppercase font-bold tracking-wider block mb-0.5">Year Built</span><span id="stat_year" class="font-semibold text-slate-800"></span></div>
      </div>

      <div id="photo_container" class="hidden">
        <img id="display_photo" src="" class="w-full h-64 md:h-80 object-contain md:w[50] bg-slate-100 rounded-2xl border border-slate-200">
      </div>

      <%= form_with(url: "", id: "property_form", method: :patch, html: { multipart: true }, class: "space-y-5", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Usage Type</label>
            <select name="property[usage_type]" id="form_usage_type" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500 font-medium">
              <option value="Residential">Residential</option>
              <option value="Commercial">Commercial</option>
              <option value="Mixed-Use">Mixed-Use</option>
              <option value="Vacant">Vacant</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Replace Photo</label>
            <input type="file" name="property[photo]" id="form_photo" accept="image/*" class="w-full text-sm text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors" />
          </div>
        </div>
        
        <div>
          <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Field Notes</label>
          <textarea name="property[notes]" id="form_notes" rows="3" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter notes here..."></textarea>
        </div>
        
        <div class="flex md:justify-end pt-2">
          <button type="submit" class="w-full md:w-auto md:px-10 bg-slate-800 text-white py-3 rounded-xl font-bold shadow-md hover:bg-slate-900 text-sm transition-transform active:scale-95">
            Update Property Info
          </button>
        </div>
      <% end %>
    </div>

    <div id="view_tickets_list" class="hidden space-y-4">
      <button type="button" onclick="showNewTicketForm()" class="w-full border-2 border-dashed border-blue-300 text-blue-600 bg-blue-50 py-4 rounded-2xl font-bold hover:bg-blue-100 transition-colors flex items-center justify-center">
        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
        Create New Ticket
      </button>
      <ul id="tickets_list" class="space-y-3 mt-4">
      </ul>
    </div>

    <div id="view_ticket_new" class="hidden space-y-5">
      <button type="button" onclick="switchTab('tickets')" class="text-slate-500 hover:text-slate-800 text-sm font-bold flex items-center mb-1 transition-colors">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Back to Tickets
      </button>
      <h3 class="font-black text-2xl text-slate-800 tracking-tight">Report an Issue</h3>
      
      <%= form_with(url: "", id: "ticket_form", method: :post, class: "space-y-5", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
        <input type="hidden" name="ticket[property_id]" id="ticket_property_id">
        <div>
          <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Issue Title</label>
          <input type="text" name="ticket[title]" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500 font-medium" placeholder="e.g., Broken Window, High Grass" required>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Initial Note</label>
          <textarea name="ticket_note[body]" rows="3" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Provide details..."></textarea>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Evidence Photos</label>
          <input type="file" name="ticket[photos][]" multiple accept="image/*" class="w-full text-sm text-slate-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
        </div>
        <div class="flex md:justify-end pt-2">
          <button type="submit" class="w-full md:w-auto md:px-10 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">
            Save Ticket
          </button>
        </div>
      <% end %>
    </div>

    <div id="view_ticket_detail" class="hidden space-y-6">
      <button type="button" onclick="switchTab('tickets')" class="text-slate-500 hover:text-slate-800 text-sm font-bold flex items-center mb-1 transition-colors">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Back to Tickets
      </button>
      
      <div class="bg-blue-50 rounded-2xl p-5 border border-blue-100">
        <div class="flex justify-between items-start mb-2">
          <h3 id="detail_ticket_title" class="font-black text-2xl text-slate-800 leading-tight">Ticket Title</h3>
          <span id="detail_ticket_status" class="px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-white shadow-sm ml-3 shrink-0">STATUS</span>
        </div>
        <p id="detail_ticket_date" class="text-xs text-blue-600 font-bold uppercase tracking-wider mb-1">Opened: Date</p>
        <p id="detail_ticket_author" class="text-xs text-slate-500 font-semibold">By: Author</p>
      </div>

      <div id="detail_ticket_photos" class="flex overflow-x-auto space-x-3 pb-2 hidden custom-scrollbar">
      </div>

      <div>
        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Activity Timeline</h4>
        <div id="detail_ticket_notes" class="ml-2 border-l-2 border-slate-100 space-y-6">
        </div>
      </div>

      <div class="mt-8 pt-6 border-t border-slate-200">
        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Add Update</h4>
        
        <%= form_with(url: "", id: "ticket_update_form", method: :patch, class: "space-y-4", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <textarea name="ticket_note[body]" rows="2" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Add a new note..."></textarea>
            </div>
            <div>
              <select name="ticket[status]" id="form_ticket_status" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500 font-medium text-sm">
                <option value="open">Open</option>
                <option value="resolved">Resolved (please add a note)</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end pt-1">
            <button type="submit" class="w-full md:w-auto md:px-8 bg-slate-800 text-white py-2.5 rounded-xl font-bold shadow-md hover:bg-slate-900 transition-transform active:scale-95 text-sm">
              Save Update
            </button>
          </div>
        <% end %>
      </div>
    </div>

    <div id="view_contacts_list" class="hidden space-y-4">
      <button type="button" onclick="showNewContactForm()" class="w-full border-2 border-dashed border-emerald-300 text-emerald-600 bg-emerald-50 py-4 rounded-2xl font-bold hover:bg-emerald-100 transition-colors flex items-center justify-center">
        <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        Log New Contact
      </button>
      <ul id="contacts_list" class="space-y-3 mt-4">
      </ul>
    </div>

    <div id="view_contact_new" class="hidden space-y-5">
      <button type="button" onclick="switchTab('contacts')" class="text-slate-500 hover:text-slate-800 text-sm font-bold flex items-center mb-1 transition-colors">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Back to Contacts
      </button>
      <h3 class="font-black text-2xl text-slate-800 tracking-tight">Log a Contact</h3>
      
      <%= form_with(url: "", id: "contact_form", method: :post, class: "space-y-5", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
        <input type="hidden" name="contact[property_id]" id="contact_property_id">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Contact Date</label>
            <input type="date" name="contact[contact_date]" value="<%= Date.today %>" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-medium text-sm" required>
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Contact Person</label>
            <input type="text" name="contact[contact_person]" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-medium text-sm" placeholder="Name of person..." required>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Role</label>
            <select name="contact[contact_person_role]" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-medium text-sm">
              <option value="Owner">Owner</option>
              <option value="Renter - Resident">Renter - Resident</option>
              <option value="Renter - Business">Renter - Business</option>
              <option value="Concerned Neighbor">Concerned Neighbor</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Method</label>
            <select name="contact[contact_method]" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-medium text-sm">
              <option value="Face to Face">Face to Face</option>
              <option value="Phone">Phone</option>
              <option value="Email">Email</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-xs font-bold text-slate-700 mb-1.5 uppercase tracking-wide">Summary</label>
          <textarea name="contact[contact_summary]" rows="4" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm" placeholder="Provide details of the conversation..." required></textarea>
        </div>

        <div class="flex md:justify-end pt-2">
          <button type="submit" class="w-full md:w-auto md:px-10 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-emerald-700 transition-transform active:scale-95">
            Save Contact
          </button>
        </div>
      <% end %>
    </div>

    <div id="view_contact_detail" class="hidden space-y-6">
      <button type="button" onclick="switchTab('contacts')" class="text-slate-500 hover:text-slate-800 text-sm font-bold flex items-center mb-1 transition-colors">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Back to Contacts
      </button>
      
      <div class="bg-emerald-50 rounded-2xl p-5 border border-emerald-100">
        <div class="flex justify-between items-start mb-2">
          <h3 id="detail_contact_person" class="font-black text-2xl text-slate-800 leading-tight">Person Name</h3>
          <span id="detail_contact_role" class="px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-white shadow-sm ml-3 shrink-0 text-emerald-800 border border-emerald-200">ROLE</span>
        </div>
        <p id="detail_contact_meta" class="text-xs text-emerald-700 font-bold uppercase tracking-wider mb-1">Date • Method</p>
        <p id="detail_contact_author" class="text-xs text-slate-500 font-semibold">Logged By: Author</p>
      </div>

      <div>
        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Conversation Summary</h4>
        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
          <p id="detail_contact_summary" class="text-sm text-slate-700 whitespace-pre-wrap font-medium leading-relaxed"></p>
        </div>
      </div>
      
      <div class="mt-8 pt-6 border-t border-slate-200">
        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Append to Summary</h4>
        <%= form_with(url: "", id: "contact_update_form", method: :patch, class: "space-y-4", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
          <textarea name="contact[contact_summary]" id="detail_contact_summary_input" rows="3" class="w-full rounded-xl border-slate-300 bg-slate-50 p-3 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm" placeholder="Add more notes..." required></textarea>
          <div class="flex justify-end pt-1">
            <button type="submit" class="w-full md:w-auto md:px-8 bg-slate-800 text-white py-2.5 rounded-xl font-bold shadow-md hover:bg-slate-900 transition-transform active:scale-95 text-sm">
              Save Update
            </button>
          </div>
        <% end %>
      </div>
    </div>

  </div>
</div>

<script>
  function closePropertyCard() {
    document.getElementById('property_editor_card').classList.add('translate-y-full');
  }

  function switchTab(tab) {
    const inactiveClass = "pb-3 border-b-2 border-transparent text-gray-500 font-medium text-sm transition-colors hover:text-gray-800";
    const activeClass = "pb-3 border-b-2 border-blue-600 text-blue-600 font-bold text-sm transition-colors";
    
    document.getElementById('tab_info').className = inactiveClass;
    document.getElementById('tab_tickets').className = inactiveClass;
    document.getElementById('tab_contacts').className = inactiveClass;
    
    // Hide ALL views aggressively
    const allViews = ['view_info', 'view_tickets_list', 'view_ticket_new', 'view_ticket_detail', 'view_contacts_list', 'view_contact_new', 'view_contact_detail'];
    allViews.forEach(v => {
      const el = document.getElementById(v);
      if(el) el.classList.add('hidden');
    });

    if (tab === 'info') {
      document.getElementById('tab_info').className = activeClass;
      document.getElementById('view_info').classList.remove('hidden');
    } else if (tab === 'tickets') {
      document.getElementById('tab_tickets').className = activeClass;
      document.getElementById('view_tickets_list').classList.remove('hidden');
    } else if (tab === 'contacts') {
      document.getElementById('tab_contacts').className = activeClass;
      document.getElementById('view_contacts_list').classList.remove('hidden');
    }
    document.getElementById('property_editor_card').scrollTop = 0;
  }

  function showNewTicketForm() {
    document.getElementById('view_tickets_list').classList.add('hidden');
    document.getElementById('view_ticket_new').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }

  function showNewContactForm() {
    document.getElementById('view_contacts_list').classList.add('hidden');
    document.getElementById('view_contact_new').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }

  function openTicketDetail(ticketId) {
    if (!window.currentPropertyTickets) return;
    const ticket = window.currentPropertyTickets.find(t => t.id === ticketId);
    if (!ticket) return;

    // 1. Populate Header
    document.getElementById('detail_ticket_title').textContent = ticket.title;
    document.getElementById('detail_ticket_date').textContent = "Opened: " + ticket.date;
    document.getElementById('detail_ticket_author').textContent = "By: " + (ticket.author || "Unknown");
    document.getElementById('form_ticket_status').value = ticket.status.toLowerCase();
    const propertyId = document.getElementById('ticket_property_id').value; 
    document.getElementById('ticket_update_form').action = `/properties/${propertyId}/tickets/${ticket.id}`;

    const statusBadge = document.getElementById('detail_ticket_status');
    statusBadge.textContent = ticket.status;
    statusBadge.className = ticket.status.toLowerCase() === 'open' 
      ? 'px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-white shadow-sm ml-3 shrink-0' 
      : 'px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-green-100 text-green-800 ml-3 shrink-0';

    // 2. Populate Photos
    const photosContainer = document.getElementById('detail_ticket_photos');
    photosContainer.innerHTML = '';
    if (ticket.photos && ticket.photos.length > 0) {
      ticket.photos.forEach(photoUrl => {
        photosContainer.innerHTML += `<img src="${photoUrl}" class="h-24 w-24 object-cover rounded-lg shadow-sm border border-slate-200 shrink-0">`;
      });
      photosContainer.classList.remove('hidden');
    } else {
      photosContainer.classList.add('hidden');
    }

    // 3. Populate Notes (With Timeline UI!)
    const notesContainer = document.getElementById('detail_ticket_notes');
    notesContainer.innerHTML = '';
    if (ticket.notes && ticket.notes.length > 0) {
      ticket.notes.forEach(note => {
        notesContainer.innerHTML += `
          <div class="relative pl-6">
            <div class="absolute -left-[5px] top-1.5 w-2.5 h-2.5 bg-blue-500 rounded-full ring-4 ring-white"></div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
              <p class="text-sm text-slate-700 whitespace-pre-wrap font-medium">${note.body}</p>
              <p class="text-[10px] text-slate-400 mt-2.5 font-bold uppercase tracking-wider">${note.date}</p>
            </div>
          </div>
        `;
      });
    } else {
      notesContainer.innerHTML = '<p class="text-sm text-slate-400 italic pl-6">No notes on this ticket.</p>';
    }

    // 4. Swap Views
    document.getElementById('view_tickets_list').classList.add('hidden');
    document.getElementById('view_ticket_new').classList.add('hidden');
    document.getElementById('view_ticket_detail').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }

  function openContactDetail(contactId) {
    if (!window.currentPropertyContacts) return;
    const contact = window.currentPropertyContacts.find(c => c.id === contactId);
    if (!contact) return;

    document.getElementById('detail_contact_person').textContent = contact.person;
    document.getElementById('detail_contact_role').textContent = contact.role;
    document.getElementById('detail_contact_meta').textContent = `${contact.display_date} • ${contact.method}`;
    document.getElementById('detail_contact_author').textContent = "Logged By: " + (contact.author || "Unknown");
    
    // Set the summary, but also plug it into the update textarea so they can just append to it!
    document.getElementById('detail_contact_summary').textContent = contact.summary;
    document.getElementById('detail_contact_summary_input').value = contact.summary + "\n\n-- Update: --\n";

    const propertyId = document.getElementById('contact_property_id').value; 
    document.getElementById('contact_update_form').action = `/properties/${propertyId}/contacts/${contact.id}`;

    const allViews = ['view_info', 'view_tickets_list', 'view_ticket_new', 'view_ticket_detail', 'view_contacts_list', 'view_contact_new', 'view_contact_detail'];
    allViews.forEach(v => {
      const el = document.getElementById(v);
      if(el) el.classList.add('hidden');
    });
    
    document.getElementById('view_contact_detail').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }
</script>