<div class="w-full h-full absolute inset-0"
     data-controller="map"
     data-map-api-key-value="<%= Rails.application.credentials.dig(:mapbox, :public_key) %>"
     data-map-properties-value='<%= {
       type: "FeatureCollection",
       features: @properties.map { |p| 
         {
           type: "Feature",
           properties: {
             id: p.id,
             address: p.address,
             usage_type: p.usage_type,
             notes: p.notes,
             
             # --- NEW PHASE 2 DATA ---
             owner: p.owner || "Unknown Owner",
             year_built: p.year_built || "Unknown",
             sale_price: p.sale_price ? number_to_currency(p.sale_price, precision: 0) : "N/A",
             sale_date: p.sale_date ? p.sale_date.strftime("%b %d, %Y") : "Unknown",
             
             # Safely grab the photo URL if it exists
             photo_url: p.photo.attached? ? rails_storage_proxy_path(p.photo, only_path: true) : nil,
             
             # Bundle up the tickets into a lightweight array
# Bundle up the tickets into a lightweight array WITH notes and photos!
             tickets: p.tickets.map do |ticket|
               {
                 id: ticket.id,
                 title: ticket.title,
                 status: ticket.status,
                 date: ticket.created_at.strftime("%b %d"),
                 # Loop through and safely proxy any attached evidence photos
                 photos: ticket.photos.attached? ? ticket.photos.map { |photo| rails_storage_proxy_path(photo, only_path: true) } : [],
                 # Grab the timeline of notes
                 notes: ticket.ticket_notes.order(created_at: :asc).map do |note|
                   {
                     body: note.body,
                     date: note.created_at.strftime("%b %d, %I:%M %p")
                   }
                 end
               }
             end
           },
           geometry: RGeo::GeoJSON.encode(p.boundary)
         }
       }
     }.to_json %>'></div>

<div id="property_editor_card" class="fixed bottom-0 left-0 right-0 z-[100] bg-white p-5 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transition-transform duration-300 transform translate-y-full w-full max-h-[85dvh] flex flex-col">

  <div class="flex justify-between items-center mb-2 shrink-0">
    <h2 id="form_address" class="text-xl font-bold text-gray-800 truncate">Property Address</h2>
    <button type="button" onclick="closePropertyCard()" class="bg-gray-100 text-gray-600 rounded-full p-2 hover:bg-gray-200 shrink-0 ml-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
  </div>

  <div class="flex space-x-6 mb-4 border-b border-gray-200 shrink-0">
    <button id="tab_info" onclick="switchTab('info')" class="pb-2 border-b-2 border-blue-600 text-blue-600 font-bold text-sm transition-colors">Property Info</button>
    <button id="tab_tickets" onclick="switchTab('tickets')" class="pb-2 border-b-2 border-transparent text-gray-500 font-medium text-sm transition-colors hover:text-gray-700">Tickets (<span id="ticket_count">0</span>)</button>
  </div>

  <div class="overflow-y-auto flex-1 pb-4">
    
    <div id="view_info" class="space-y-5">
      <div class="grid grid-cols-2 gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100 shadow-inner text-sm">
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Owner</span><span id="stat_owner" class="font-medium text-gray-800 truncate block"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Sale Price</span><span id="stat_price" class="font-medium text-gray-800"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Sale Date</span><span id="stat_date" class="font-medium text-gray-800"></span></div>
        <div><span class="text-gray-400 text-[10px] uppercase font-bold tracking-wider block">Year Built</span><span id="stat_year" class="font-medium text-gray-800"></span></div>
      </div>

      <div id="photo_container" class="hidden">
        <img id="display_photo" src="" class="w-full h-48 object-cover rounded-xl shadow-sm border border-gray-200">
      </div>

      <%= form_with(url: "", id: "property_form", method: :patch, html: { multipart: true }, class: "space-y-4", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Usage Type</label>
          <select name="property[usage_type]" id="form_usage_type" class="w-full rounded-lg border-gray-300 bg-gray-50 p-2.5 text-sm shadow-sm">
            <option value="Residential">Residential</option>
            <option value="Commercial">Commercial</option>
            <option value="Mixed-Use">Mixed-Use</option>
            <option value="Vacant">Vacant</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Replace Photo</label>
          <input type="file" name="property[photo]" id="form_photo" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Field Notes</label>
          <textarea name="property[notes]" id="form_notes" rows="2" class="w-full rounded-lg border-gray-300 bg-gray-50 p-2.5 text-sm shadow-sm" placeholder="Enter notes here..."></textarea>
        </div>
        <button type="submit" class="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold shadow-sm hover:bg-gray-900 text-sm">
          Update Property Info
        </button>
      <% end %>
    </div>

    <div id="view_tickets_list" class="hidden space-y-4">
      <button type="button" onclick="showNewTicketForm()" class="w-full border-2 border-dashed border-blue-300 text-blue-600 bg-blue-50 py-3 rounded-xl font-bold hover:bg-blue-100 transition-colors flex items-center justify-center">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
        Create New Ticket
      </button>
      
      <ul id="tickets_list" class="space-y-2 mt-2">
        </ul>
    </div>

    <div id="view_ticket_new" class="hidden space-y-4">
      <button type="button" onclick="switchTab('tickets')" class="text-blue-600 text-sm font-semibold flex items-center mb-2">
        &larr; Back to Ticket List
      </button>
      <h3 class="font-bold text-lg text-gray-800 border-b pb-2">Report an Issue</h3>
      
      <%= form_with(url: "", id: "ticket_form", method: :post, class: "space-y-4", data: { turbo: false, action: "submit->connection#handleSubmit" }) do |f| %>
        <input type="hidden" name="ticket[property_id]" id="ticket_property_id">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Issue Title</label>
          <input type="text" name="ticket[title]" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Broken Window, High Grass" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Initial Note</label>
          <textarea name="ticket_note[body]" rows="3" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Provide details..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Evidence Photos (Multiple)</label>
          <input type="file" name="ticket[photos][]" multiple accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700" />
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all">
          Save Ticket
        </button>
      <% end %>
    </div>

    <div id="view_ticket_detail" class="hidden space-y-4">
      <button type="button" onclick="switchTab('tickets')" class="text-blue-600 text-sm font-semibold flex items-center mb-2">
        &larr; Back to Ticket List
      </button>
      
      <div class="border-b border-gray-200 pb-3">
        <div class="flex justify-between items-start mb-2">
          <h3 id="detail_ticket_title" class="font-bold text-lg text-gray-800 leading-tight">Ticket Title</h3>
          <span id="detail_ticket_status" class="px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide bg-gray-100 ml-2 shrink-0">STATUS</span>
        </div>
        <p id="detail_ticket_date" class="text-xs text-gray-500 font-medium">Opened: Date</p>
      </div>

      <div id="detail_ticket_photos" class="flex overflow-x-auto space-x-3 pb-2 hidden">
      </div>

      <div>
        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Timeline</h4>
        <div id="detail_ticket_notes" class="space-y-3">
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  function closePropertyCard() {
    document.getElementById('property_editor_card').classList.add('translate-y-full');
  }

  function switchTab(tab) {
    // 1. Reset Tab Styles
    const inactiveClass = "pb-2 border-b-2 border-transparent text-gray-500 font-medium text-sm transition-colors hover:text-gray-700";
    const activeClass = "pb-2 border-b-2 border-blue-600 text-blue-600 font-bold text-sm transition-colors";
    
    document.getElementById('tab_info').className = inactiveClass;
    document.getElementById('tab_tickets').className = inactiveClass;
    
    // 2. Hide all views
    document.getElementById('view_info').classList.add('hidden');
    document.getElementById('view_tickets_list').classList.add('hidden');
    document.getElementById('view_ticket_new').classList.add('hidden');

    // 3. Activate selected tab & view
    if (tab === 'info') {
      document.getElementById('tab_info').className = activeClass;
      document.getElementById('view_info').classList.remove('hidden');
    } else if (tab === 'tickets') {
      document.getElementById('tab_tickets').className = activeClass;
      document.getElementById('view_tickets_list').classList.remove('hidden');
    }
    
    // 4. Scroll to top
    document.getElementById('property_editor_card').scrollTop = 0;

    // Manage full ticket view
    document.getElementById('view_ticket_new').classList.add('hidden');
    document.getElementById('view_ticket_detail').classList.add('hidden'); // Add this line!
  }

  function showNewTicketForm() {
    document.getElementById('view_tickets_list').classList.add('hidden');
    document.getElementById('view_ticket_new').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }

  function openTicketDetail(ticketId) {
    if (!window.currentPropertyTickets) return;
    const ticket = window.currentPropertyTickets.find(t => t.id === ticketId);
    if (!ticket) return;

    // 1. Populate Header
    document.getElementById('detail_ticket_title').textContent = ticket.title;
    document.getElementById('detail_ticket_date').textContent = "Opened: " + ticket.date;
    
    const statusBadge = document.getElementById('detail_ticket_status');
    statusBadge.textContent = ticket.status;
    statusBadge.className = ticket.status === 'open' 
      ? 'px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide bg-yellow-100 text-yellow-800 ml-2 shrink-0' 
      : 'px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide bg-green-100 text-green-800 ml-2 shrink-0';

    // 2. Populate Photos
    const photosContainer = document.getElementById('detail_ticket_photos');
    photosContainer.innerHTML = '';
    if (ticket.photos && ticket.photos.length > 0) {
      ticket.photos.forEach(photoUrl => {
        photosContainer.innerHTML += `<img src="${photoUrl}" class="h-24 w-24 object-cover rounded-lg shadow-sm border border-gray-200 shrink-0">`;
      });
      photosContainer.classList.remove('hidden');
    } else {
      photosContainer.classList.add('hidden');
    }

    // 3. Populate Notes
    const notesContainer = document.getElementById('detail_ticket_notes');
    notesContainer.innerHTML = '';
    if (ticket.notes && ticket.notes.length > 0) {
      ticket.notes.forEach(note => {
        notesContainer.innerHTML += `
          <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${note.body}</p>
            <p class="text-[10px] text-gray-400 mt-2 font-medium">${note.date}</p>
          </div>
        `;
      });
    } else {
      notesContainer.innerHTML = '<p class="text-sm text-gray-500 italic">No notes on this ticket.</p>';
    }

    // 4. Swap Views
    document.getElementById('view_tickets_list').classList.add('hidden');
    document.getElementById('view_ticket_new').classList.add('hidden');
    document.getElementById('view_ticket_detail').classList.remove('hidden');
    document.getElementById('property_editor_card').scrollTop = 0;
  }
</script>